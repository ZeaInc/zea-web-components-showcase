'use strict';

Object.defineProperty(exports, '__esModule', { value: true });

const index$1 = require('./index-f5b25f1f.js');
const _commonjsHelpers = require('./_commonjsHelpers-31ac858e.js');

var zeaEngine_cjs = _commonjsHelpers.createCommonjsModule(function (module, exports) {
function e(t,a){if(!e.watchedElementData){e.watchedElementData=[];const t=function(){e.watchedElementData.forEach((function(e){e.element.offsetWidth===e.offsetWidth&&e.element.offsetHeight===e.offsetHeight||(e.offsetWidth=e.element.offsetWidth,e.offsetHeight=e.element.offsetHeight,e.callback());}));};window.addEventListener("resize",t),new MutationObserver(t).observe(document.body,{attributes:!0,childList:!0,characterData:!0,subtree:!0});}e.watchedElementData.push({element:t,offsetWidth:t.offsetWidth,offsetHeight:t.offsetHeight,callback:a});}Object.defineProperty(exports,"__esModule",{value:!0});const t=function(){const e=null!=(navigator.userAgent.match(/Android/i)||navigator.userAgent.match(/webOS/i)||navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/BlackBerry/i)||navigator.userAgent.match(/Pixel/i)||navigator.userAgent.match(/Windows Phone/i)),t=function(){const e=navigator.userAgent;let t,a,i,s=navigator.appName,n=""+parseFloat(navigator.appVersion),l=parseInt(navigator.appVersion,10);return -1!=(a=e.indexOf("Opera"))?(s="Opera",n=e.substring(a+6),-1!=(a=e.indexOf("Version"))&&(n=e.substring(a+8))):-1!=(a=e.indexOf("MSIE"))?(s="Microsoft Internet Explorer",n=e.substring(a+5)):-1!=(a=e.indexOf("Edge"))?(s="Edge",n=e.substring(a+4)):-1!=(a=e.indexOf("Chrome"))?(s="Chrome",n=e.substring(a+7)):-1!=(a=e.indexOf("Safari"))?(s="Safari",n=e.substring(a+7),-1!=(a=e.indexOf("Version"))&&(n=e.substring(a+8))):-1!=(a=e.indexOf("Firefox"))?(s="Firefox",n=e.substring(a+8)):(t=e.lastIndexOf(" ")+1)<(a=e.lastIndexOf("/"))&&(s=e.substring(t,a),n=e.substring(a+1),s.toLowerCase()==s.toUpperCase()&&(s=navigator.appName)),-1!=(i=n.indexOf(";"))&&(n=n.substring(0,i)),-1!=(i=n.indexOf(" "))&&(n=n.substring(0,i)),l=parseInt(""+n,10),isNaN(l)&&(n=""+parseFloat(navigator.appVersion),l=parseInt(navigator.appVersion,10)),{browserName:s,fullVersion:n,majorVersion:l,appName:navigator.appName,userAgent:navigator.userAgent}}(),a=function(){let e,t;try{e=document.createElement("canvas").getContext("webgl");}catch(e){}if(!e)return;try{t=document.createElement("canvas").getContext("webgl2");}catch(e){}const a=e.getExtension("WEBGL_debug_renderer_info"),i=e.getParameter(a.UNMASKED_VENDOR_WEBGL),s=e.getParameter(a.UNMASKED_RENDERER_WEBGL),n=e.getParameter(e.MAX_TEXTURE_SIZE);let l;return s.match(/NVIDIA/i)?l="NVidia":s.match(/AMD/i)||s.match(/Radeon/i)?l="AMD":s.match(/Intel/i)?l="Intel":s.match(/Mali/i)?l="ARM":s.match(/Adreno/i)?l="Adreno":console.warn("Unable to determine GPU vendor:",s),{vendor:i,renderer:s,gpuVendor:l,maxTextureSize:n,supportsWebGL2:null!=t}}();let i="Low";if(a)if(e)i="Low";else {const e=a.renderer.replace(/[()]/g,"").split(" ");if("NVidia"==a.gpuVendor){const t=e.indexOf("GTX");if(-1!=t){const a=e[t+1];if(a.endsWith("M")){i=parseInt(a.substring(0,a.length-2))>=900?"Medium":"Low";}else {i=parseInt(a)>=1030?"High":"Medium";}}else i=-1!=e.indexOf("TITAN")||-1!=e.indexOf("Quadro")?"High":"Low";}else if("AMD"==a.gpuVendor){const t=e.indexOf("Radeon");if(-1!=t){const a=e.indexOf("RX");if(-1!=a)if("Vega"==e[a+1])i="High";else {const t=e[a+1];let s;t.endsWith("X")?(s=parseInt(t.substring(0,t.length-2)),i="High"):s=parseInt(t),i=s>=480?"High":"Medium";}else if("Pro"==e[t+1]){i=parseInt(e[a+1])>=450?"Medium":"Low";}else if("Sky"==e[t+1]){i=parseInt(e[a+1])>=700?"Medium":"Low";}else i="Low";}else i=-1!=e.indexOf("FirePro")||-1!=e.indexOf("Quadro")?"High":"Low";}else ("Adreno"==a.gpuVendor||"Intel"==a.gpuVendor)&&(i="Low");}return {isMobileDevice:e,isIOSDevice:null!=(navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPod/i)),browserName:t.browserName,fullVersion:t.fullVersion,majorVersion:t.majorVersion,appName:t.appName,userAgent:t.userAgent,webGLSupported:null!=a,gpuDesc:a,deviceCategory:i}}();var a=Object.freeze({__proto__:null,SystemDesc:t});const i=Math.PI/180;Math.HALF_PI=.5*Math.PI,Math.TWO_PI=2*Math.PI;Math.radToDeg=function(e){return e/i},Math.degToRad=function(e){return e*i},Number.isNumeric=e=>!isNaN(parseFloat(e))&&isFinite(e),String.prototype.replaceAll=function(e,t){return this.replace(new RegExp(e,"g"),t)};const s=function(e){let t,a,i,s=0;if(0===e.length)return s;for(t=0,i=e.length;t<i;t++)a=e.charCodeAt(t),s=(s<<5)-s+a,s|=0;return Math.abs(s)};function n(e,t=0,a=5){return JSON.stringify(e,(function(e,t){return t&&t.toFixed?Number(t.toFixed(a)):t}),t)}String.prototype.hash=function(){return s(this)},String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")},String.prototype.ltrim=function(){return this.replace(/^\s+/,"")},String.prototype.rtrim=function(){return this.replace(/\s+$/,"")},String.prototype.lpad=function(e,t){let a=this;for(;a.length<t;)a=e+a;return a},String.prototype.rpad=function(e,t){let a=this;for(;a.length<t;)a+=e;return a},Math.randomInt=function(e,t){return e=Math.ceil(e),t=Math.floor(t),Math.floor(Math.random()*(t-e))+e},Math.lerp=(e,t,a)=>e+a*(t-e),Math.clamp=function(e,t,a){return Math.min(Math.max(e,t),a)},Math.nearestPow2=function(e){return Math.pow(2,Math.round(Math.log(e)/Math.log(2)))},Math.nearestPow10=function(e){return Math.pow(10,Math.round(Math.log10(e)/Math.log10(10)))},Math.nextPow2=function(e){let t=0;for(;e>0;)t++,e>>=1;return 1<<t},Math.fract=function(e){return 0==e?0:e<0?e>-1?-e:-e%Math.floor(-e):e<1?e:e%Math.floor(e)},Math.remap=function(e,t,a,i,s){return i+(e-t)/(a-t)*(s-i)},Math.convertFloat32ArrayToUInt16Array=function(e){const t=new Uint16Array(e.length),a=new Int32Array(e.buffer),i=e=>{let t=e>>16&32768,a=e>>12&2047;const i=e>>23&255;return i<103?t:i>142?(t|=31744,t|=(255==i?0:1)&&8388607&e,t):i<113?(a|=2048,t|=(a>>114-i)+(a>>113-i&1),t):(t|=i-112<<10|a>>1,t+=1&a,t)};for(let s=0;s<e.length;s++)t[s]=i(a[s]);return t},Math.decode16BitFloatFrom2xUInt8=e=>{const t=e[0],a=(120&t)>>3;let i=0==a?0:2048;const s=i+((7&t)<<8)+e[1];return i=0==a?1:0,(128&t?1:-1)*s*Math.pow(2,a+i-16)},Math.encode16BitFloatInto2xUInt8=e=>{c||(c=new Uint8Array(2));const t=e>=0?128:0;e=Math.abs(e);let a,i=15,s=1024;for(let t=15;t>0;t--)e<s&&(s/=2,i--);a=0==i?e/s/2:(e-s)/s;const n=Math.round(2048*a),l=n/256,r=n-256*l;return c[0]=t+8*i+l,c[1]=r,e>=2048&&(c[0]=255),c},Math.encode16BitFloat=e=>{const t=new Float32Array(1);t[0]=e;return (e=>{let t=e>>16&32768,a=e>>12&2047;const i=e>>23&255;return i<103?t:i>142?(t|=31744,t|=(255==i?0:1)&&8388607&e,t):i<113?(a|=2048,t|=(a>>114-i)+(a>>113-i&1),t):(t|=i-112<<10|a>>1,t+=1&a,t)})(new Int32Array(t.buffer)[0])},Math.decode16BitFloat=e=>{const t=(32768&e)>>15,a=(31744&e)>>10,i=1023&e;return 0==a?(t?-1:1)*Math.pow(2,-14)*(i/Math.pow(2,10)):31==a?i?NaN:1/0*(t?-1:1):(t?-1:1)*Math.pow(2,a-15)*(1+i/Math.pow(2,10))},Math.smoothStep=(e,t,a)=>{const i=Math.clamp((a-e)/(t-e),0,1);return i*i*(3-2*i)},Math.linStep=(e,t,a)=>Math.clamp((a-e)/(t-e),0,1);class l{isValid(){for(const e of this.__data)if(e==1/0||isNaN(e))return !1;return !0}static createFromFloat32Buffer(e,t){throw new Error("Not yet implemented for this type:"+this.constructor.name)}static numElements(){throw new Error("Not yet implemented for this type:"+this.constructor.name)}asArray(){return this.__data}toString(){return n(this.toJSON())}}const r=new class{constructor(){this.__types={},this.__names={},this.registerType("SInt32",5),this.registerType("UInt32",4),this.registerType("Float32",6);}registerType(e,t){this.__types[e]=t,t.name?this.__names[t.name]=e:this.__names[t]=e;}getType(e){return this.__types[e]}getTypeName(e){if(this.__names[e])return this.__names[e];if(this.__names[e.name])return this.__names[e.name];throw e}};class o extends l{constructor(e=0,t=0){if(super(),e instanceof Float32Array||e instanceof Uint32Array||e instanceof Int32Array)this.__data=e;else if(e instanceof ArrayBuffer){const a=e,i=t;this.__data=new Float32Array(a,i,2);}else null!=e&&"object"==typeof e?(this.__data=new Float32Array(2),this.fromJSON(e)):(this.__data=new Float32Array(2),this.__data[0]=e,this.__data[1]=t);}get x(){return this.__data[0]}set x(e){this.__data[0]=e;}get y(){return this.__data[1]}set y(e){this.__data[1]=e;}set(e,t){this.__data[0]=e,this.__data[1]=t;}setFromOther(e){this.x=e.x,this.y=e.y;}equal(e){return this.x==e.x&&this.y==e.y}notEquals(e){return this.x!=e.x&&this.y!=e.y}approxEqual(e,t=Number.EPSILON){return Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t}add(e){return new o(this.x+e.x,this.y+e.y)}addInPlace(e){this.x+=e.x,this.y+=e.y;}subtract(e){return new o(this.x-e.x,this.y-e.y)}subtractInPlace(e){return this.x-=e.x,this.y-=e.y,this}scale(e){return new o(this.x*e,this.y*e)}scaleInPlace(e){this.x*=e,this.y*=e;}invert(){return new o(1/this.x,1/this.y)}invertInPlace(){return this.x=1/this.x,this.y=1/this.y,this}multiply(e){return new o(this.x*e.x,this.y*e.y)}multiplyInPlace(e){this.x*=e.x,this.y*=e.y;}lengthSquared(){const e=this.__data[0],t=this.__data[1];return e*e+t*t}length(){return Math.sqrt(this.lengthSquared())}distanceTo(e){const t=this.__data[0]-e.x,a=this.__data[1]-e.y;return Math.sqrt(t*t+a*a)}normalize(){const e=this.__data[0],t=this.__data[1];let a=e*e+t*t;return a<Number.EPSILON?new o:(a=1/Math.sqrt(a),new o(e*a,t*a))}normalizeInPlace(){const e=this.__data[0],t=this.__data[1];let a=e*e+t*t;a<Number.EPSILON||(a=1/Math.sqrt(a),this.set(e*a,t*a));}dot(e){return this.x*e.x+this.y*e.y}cross(e){return this.x*e.y-this.y*e.x}angleTo(e){const t=this.normalize().dot(e.normalize());return t>1?0:t<-1?Math.PI:Math.acos(t)}signedAngleTo(e){const t=this.angleTo(e);return this.cross(e)<0?-t:t}rotate(e){const t=Math.cos(e),a=Math.sin(e);return new o(this.x*t-this.y*a,this.x*a+this.y*t)}lerp(e,t){const a=this.x,i=this.y;return new o(a+t*(e.x-a),i+t*(e.y-i))}setRandomDir(e=1){const t=2*Math.random()*Math.PI;return this.__data[0]=Math.cos(t)*zScale,this.__data[1]=Math.sin(t)*zScale,this}setRandom(e=1){return this.__data[0]=Math.random()*e,this.__data[1]=Math.random()*e,this}clone(){return new o(this.__data[0],this.__data[1])}asArray(){return this.__data}static create(...e){return new o(...e)}static createFromFloat32Buffer(e,t=0){return new o(e,4*t)}static createFromFloat32Array(e){return new o(e)}static numElements(){return 2}toJSON(){return {x:this.x,y:this.y}}fromJSON(e){this.x=e.x,this.y=e.y;}}r.registerType("Vec2",o);class d extends l{constructor(e=0,t=0,a=0){if(super(),e instanceof Float32Array||e instanceof Uint32Array)this.__data=e;else if(e instanceof ArrayBuffer){const a=e,i=t;this.__data=new Float32Array(a,i,3);}else null!=e&&"object"==typeof e?(this.__data=new Float32Array(3),this.fromJSON(e)):(this.__data=new Float32Array(3),this.__data[0]=e,this.__data[1]=t,this.__data[2]=a);}get x(){return this.__data[0]}set x(e){this.__data[0]=e;}get y(){return this.__data[1]}set y(e){this.__data[1]=e;}get z(){return this.__data[2]}set z(e){this.__data[2]=e;}get xy(){return new o(this.__data[0],this.__data[1])}get yz(){return new o(this.__data[1],this.__data[2])}set(e,t,a){this.x=e,this.y=void 0!==t?t:e,this.z=void 0!==a?a:e;}setDataArray(e){this.__data=e;}setFromOther(e){this.x=e.x,this.y=e.y,this.z=e.z;}isNull(){return Math.abs(this.x)<Number.EPSILON&&Math.abs(this.y)<Number.EPSILON&&Math.abs(this.z)<Number.EPSILON}is111(){return Math.abs(1-this.x)<Number.EPSILON&&Math.abs(1-this.y)<Number.EPSILON&&Math.abs(1-this.z)<Number.EPSILON}equal(e){return this.x==e.x&&this.y==e.y&&this.z==e.z}notEquals(e){return this.x!=e.x&&this.y!=e.y&&this.z!=e.z}approxEqual(e,t=Number.EPSILON){return Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t&&Math.abs(this.z-e.z)<t}add(e){return new d(this.x+e.x,this.y+e.y,this.z+e.z)}addInPlace(e){this.x+=e.x,this.y+=e.y,this.z+=e.z;}subtract(e){return new d(this.x-e.x,this.y-e.y,this.z-e.z)}subtractInPlace(e){this.x-=e.x,this.y-=e.y,this.z-=e.z;}multiply(e){return new d(this.x*e.x,this.y*e.y,this.z*e.z)}multiplyInPlace(e){this.x*=e.x,this.y*=e.y,this.z*=e.z;}divide(e){return new d(this.x/e.x,this.y/e.y,this.z/e.z)}divideInPlace(e){this.x/=e.x,this.y/=e.y,this.z/=e.z;}scale(e){return new d(this.x*e,this.y*e,this.z*e)}scaleInPlace(e){this.x*=e,this.y*=e,this.z*=e;}negate(){return new d(-this.x,-this.y,-this.z)}inverse(){return new d(1/this.x,1/this.y,1/this.z)}lengthSquared(){const e=this.__data[0],t=this.__data[1],a=this.__data[2];return e*e+t*t+a*a}length(){return Math.sqrt(this.lengthSquared())}distanceTo(e){const t=this.__data[0]-e.x,a=this.__data[1]-e.y,i=this.__data[2]-e.z;return Math.sqrt(t*t+a*a+i*i)}normalize(){let e=this.__data[0]*this.__data[0]+this.__data[1]*this.__data[1]+this.__data[2]*this.__data[2];return e<Number.EPSILON?new d:(e=1/Math.sqrt(e),new d(this.__data[0]*e,this.__data[1]*e,this.__data[2]*e))}normalizeInPlace(){let e=this.__data[0]*this.__data[0]+this.__data[1]*this.__data[1]+this.__data[2]*this.__data[2];if(e<Number.EPSILON)return;e=Math.sqrt(e);const t=1/e;return this.__data[0]*=t,this.__data[1]*=t,this.__data[2]*=t,e}resize(e){const t=this.__data[0]*this.__data[0]+this.__data[1]*this.__data[1]+this.__data[2]*this.__data[2];if(t<Number.EPSILON)return;const a=e/Math.sqrt(t);return new d(this.__data[0]*a,this.__data[1]*a,this.__data[2]*a)}resizeInPlace(e){const t=this.__data[0]*this.__data[0]+this.__data[1]*this.__data[1]+this.__data[2]*this.__data[2];if(t<Number.EPSILON)return;const a=e/Math.sqrt(t);this.__data[0]*=a,this.__data[1]*=a,this.__data[2]*=a;}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}cross(e){const t=this.x,a=this.y,i=this.z,s=e.x,n=e.y,l=e.z;return new d(a*l-i*n,i*s-t*l,t*n-a*s)}angleTo(e){const t=this.dot(e);return t>1?0:Math.acos(t)}lerp(e,t){const a=this.x,i=this.y,s=this.z;return new d(a+t*(e.x-a),i+t*(e.y-i),s+t*(e.z-s))}abs(){return new d(Math.abs(this.x),Math.abs(this.y),Math.abs(this.z))}setRandomDir(e=1){const t=2*Math.random()*Math.PI,a=2*Math.random()-1,i=Math.sqrt(1-a*a)*e;return this.__data[0]=Math.cos(t)*i,this.__data[1]=Math.sin(t)*i,this.__data[2]=a*e,this}setRandom(e=1){return this.__data[0]=(Math.random()-.5)*e,this.__data[1]=(Math.random()-.5)*e,this.__data[2]=(Math.random()-.5)*e,this}clone(){return new d(this.__data[0],this.__data[1],this.__data[2])}asArray(){return this.__data}static create(...e){return new d(...e)}static createFromJSON(e){const t=new d;return t.fromJSON(e),t}static createFromFloat32Buffer(e,t=0){return new d(e,4*t)}static createFromFloat32Array(e){return new d(e)}static numElements(){return 3}toJSON(){return {x:this.x,y:this.y,z:this.z}}fromJSON(e){this.x=e.x,this.y=e.y,this.z=e.z;}}r.registerType("Vec3",d);class h extends l{constructor(e=0,t=0,a=0,i=0){if(super(),e instanceof ArrayBuffer){const a=e,i=t;this.__data=new Float32Array(a,i,4);}else null!=e&&"object"==typeof e?(this.__data=new Float32Array(4),this.fromJSON(e)):(this.__data=new Float32Array(4),this.__data[0]=e,this.__data[1]=t,this.__data[2]=a,this.__data[3]=i);}get x(){return this.__data[0]}set x(e){this.__data[0]=e;}get y(){return this.__data[1]}set y(e){this.__data[1]=e;}get z(){return this.__data[2]}set z(e){this.__data[2]=e;}get t(){return this.__data[3]}set t(e){this.__data[3]=e;}get xyz(){return new d(this.__data[0],this.__data[1],this.__data[2])}set(e,t,a,i){this.x=e,this.y=t,this.z=a,this.t=i;}setFromOther(e){this.x=e.x,this.y=e.y,this.z=e.z,this.t=e.t;}equal(e){return this.x==e.x&&this.y==e.y&&this.z==e.z&&this.t==e.t}notEquals(e){return this.x!=e.x&&this.y!=e.y&&this.z!=e.z&&this.t!=e.t}approxEqual(e,t=Number.EPSILON){return Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t&&Math.abs(this.z-e.z)<t&&Math.abs(this.t-e.t)<t}add(e){return new h(this.x+e.x,this.y+e.y,this.z+e.z,this.t+e.t)}addInPlace(e){this.x+=e.x,this.y+=e.y,this.z+=e.z,this.t+=e.t;}subtract(e){return new h(this.x-e.x,this.y-e.y,this.z-e.z,this.t-e.t)}subtractInPlace(e){this.x-=e.x,this.y-=e.y,this.z-=e.z,this.t-=e.t;}multiply(e){return new h(this.x*e.x,this.y*e.y,this.z*e.z,this.t*e.t)}multiplyInPlace(e){this.x*=e.x,this.y*=e.y,this.z*=e.z,this.t*=e.t;}divide(e){return new h(this.x/e.x,this.y/e.y,this.z/e.z,this.t/e.t)}divideInPlace(e){this.x/=e.x,this.y/=e.y,this.z/=e.z,this.t/=e.t;}scale(e){return new h(this.x*e,this.y*e,this.z*e,this.t*e)}scaleInPlace(e){this.set(this.x*e,this.y*e,this.z*e,this.t*e);}length(){const e=this.__data[0],t=this.__data[1],a=this.__data[2],i=this.__data[2];return Math.sqrt(e*e+t*t+a*a+i*i)}lengthSquared(){const e=this.__data[0],t=this.__data[1],a=this.__data[2],i=this.__data[3];return e*e+t*t+a*a+i*i}normalize(){const e=this.__data[0],t=this.__data[1],a=this.__data[2],i=this.__data[3];let s=e*e+t*t+a*a+i*i;return s<Number.EPSILON?new h:(s=1/Math.sqrt(s),new h(e*s,t*s,a*s))}normalizeInPlace(){const e=this.__data[0],t=this.__data[1],a=this.__data[2],i=this.__data[3];let s=e*e+t*t+a*a+i*i;s<Number.EPSILON||(s=1/Math.sqrt(s),this.set(e*s,t*s,a*s,i*s));}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.t*b.t}cross(e){const t=this.x,a=this.y,i=this.z,s=this.t,n=e.x,l=e.y,r=e.z,o=e.t;return new h(a*r-i*l,i*o-s*r,s*n-t*o,t*l-a*n)}angleTo(e){const t=this.normalize(),a=e.normalize(),i=t.dot(a);return i>1?0:Math.acos(i)}lerp(e,t){const a=this.x,i=this.y,s=this.z;return at=this.t,new h(a+t*(e.x-a),i+t*(e.y-i),s+t*(e.z-s),at+t*(e.t-at))}random(e=1){const t=2*glMatrix.RANDOM()*Math.PI,a=2*glMatrix.RANDOM()-1,i=Math.sqrt(1-a*a)*e;return out[0]=Math.cos(t)*i,out[1]=Math.sin(t)*i,out[2]=a*e,out}clone(){return new h(this.__data[0],this.__data[1],this.__data[2],this.__data[3])}toVec3(){return new d(this.__data[0],this.__data[1],this.__data[2])}asArray(){return this.__data}static create(...e){return new d(...e)}static createFromFloat32Buffer(e,t=0){return new h(e,4*t)}static numElements(){return 4}toJSON(){return {x:this.x,y:this.y,z:this.z,t:this.t}}}r.registerType("Vec4",h);class m extends l{constructor(e=0,t=0,a=0,i=255){if(super(),e instanceof Uint8Array)this.__data=e;else if(e instanceof ArrayBuffer){const a=e,i=t;this.__data=new Uint8Array(a,i,4);}else this.__data=new Uint8Array(4),"string"==typeof e?e.startsWith("#")?this.setFromHex(e):this.setFromCSSColorName(e):(this.__data[0]=e,this.__data[1]=t,this.__data[2]=a,this.__data[3]=i);}get r(){return this.__data[0]}set r(e){this.__data[0]=e;}get g(){return this.__data[1]}set g(e){this.__data[1]=e;}get b(){return this.__data[2]}set b(e){this.__data[2]=e;}get a(){return this.__data[3]}set a(e){this.__data[3]=e;}set(e,t,a,i=255){this.r=e,this.g=t,this.b=a,this.a=i;}setFromOther(e){this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a;}setFromArray(e){this.r=e[0],this.g=e[1],this.b=e[2],this.a=4==e.length?e[3]:1;}setFromHex(e){const t=function(e){const t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:null}(e);t?this.set(t.r,t.g,t.b):console.warn("Invalid hex code:"+e);}setFromCSSColorName(e){e.startsWith("#")?this.setFromHex(e):this.setFromHex((e=>{const t={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",honeydew:"#f0fff0",hotpink:"#ff69b4","indianred ":"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgrey:"#d3d3d3",lightgreen:"#90ee90",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370d8",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#d87093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",rebeccapurple:"#663399",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"};return void 0!==t[e.toLowerCase()]&&t[e.toLowerCase()]})(e));}toHex(){function e(e){const t=e.toString(16);return 1==t.length?"0"+t:t}return "#"+e(this.r)+e(this.g)+e(this.b)}equal(e){return this.r==e.r&&this.g==e.g&&this.b==e.b&&this.a==e.a}notequals(e){return this.r!=e.r&&this.g!=e.g&&this.b!=e.b&&this.a!=e.a}approxEqual(e,t=Number.EPSILON){return Math.abs(this.r-e.r)<t&&Math.abs(this.g-e.g)<t&&Math.abs(this.b-e.b)<t&&Math.abs(this.a-e.a)<t}add(e){return new m(this.r+e.r,this.g+e.g,this.b+e.b,this.a+e.a)}subtract(e){return new m(this.r-e.r,this.g-e.g,this.b-e.b,this.a-e.a)}scale(e){return new m(this.r*e,this.g*e,this.b*e,this.a*e)}scaleInPlace(e){this.r*=e,this.g*=e,this.b*=e,this.a*=e;}applyGamma(e){this.set(Math.pow(this.r,e),Math.pow(this.g,e),Math.pow(this.b,e),this.a);}toLinear(e=2.2){return new m(Math.pow(this.r,e),Math.pow(this.g,e),Math.pow(this.b,e),this.a)}toGamma(e=2.2){return new m(Math.pow(this.r,1/e),Math.pow(this.g,1/e),Math.pow(this.b,1/e),this.a)}luminance(){return .2126*this.r+.7152*this.g+.0722*this.b}lerp(e,t){const a=this.r,i=this.g,s=this.b,n=this.a;return new m(a+t*(e.r-a),i+t*(e.g-i),s+t*(e.b-s),n+t*(e.a-n))}static random(e=0,t=!1){return e>0?new m(e+Math.random()*(1-e),e+Math.random()*(1-e),e+Math.random()*(1-e),t?e+Math.random()*(1-e):1):e<0?new m(Math.random()*(1+e),Math.random()*(1+e),Math.random()*(1+e),t?Math.random()*(1+e):1):new m(Math.random(),Math.random(),Math.random(),t?Math.random():1)}clone(){return new m(this.__data[0],this.__data[1],this.__data[2],this.__data[3])}asArray(){return this.__data}as3ComponentArray(){return [this.__data[0],this.__data[1],this.__data[2]]}static create(...e){return new m(...e)}static createFromFloat32Buffer(e,t=0){return new m(e,4*t)}static numElements(){return 4}toJSON(){return {r:this.r,g:this.g,b:this.b,a:this.a}}fromJSON(e){this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a;}toCSSString(){return "rgba("+Math.round(255*this.r)+", "+Math.round(255*this.g)+", "+Math.round(255*this.b)+", "+this.a+")"}}r.registerType("RGBA",m);class u extends l{constructor(e=0,t=0,a=0,i=1){if(super(),e instanceof Float32Array)this.__data=e;else if(e instanceof ArrayBuffer){const a=e,i=t;this.__data=new Float32Array(a,i,4);}else this.__data=new Float32Array(4),"string"==typeof e?e.startsWith("#")?this.setFromHex(e):this.setFromCSSColorName(e):(this.__data[0]=e,this.__data[1]=t,this.__data[2]=a,this.__data[3]=i);}get r(){return this.__data[0]}set r(e){this.__data[0]=e;}get g(){return this.__data[1]}set g(e){this.__data[1]=e;}get b(){return this.__data[2]}set b(e){this.__data[2]=e;}get a(){return this.__data[3]}set a(e){this.__data[3]=e;}set(e,t,a,i=1){this.r=e,this.g=t,this.b=a,this.a=i;}setFromOther(e){this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a;}setFromScalarArray(e){this.r=e[0],this.g=e[1],this.b=e[2],this.a=4==e.length?e[3]:1;}getAsRGBArray(){return [255*this.r,255*this.g,255*this.b]}getAsRGBDict(){return {r:255*this.r,g:255*this.g,b:255*this.b}}setFromRGB(e,t,a,i){this.r=e/255,this.g=t/255,this.b=a/255,this.a=i?i/255:1;}setFromRGBArray(e){this.r=e[0]/255,this.g=e[1]/255,this.b=e[2]/255,this.a=4==e.length?e[3]/255:1;}setFromRGBDict(e){this.r=e.r/255,this.g=e.g/255,this.b=e.b/255,this.a=4==e.a?e.a/255:1;}setFromHex(e){const t=function(e){const t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:null}(e);t?this.setFromRGB(t.r,t.g,t.b):console.warn("Invalid hex code:"+e);}setFromCSSColorName(e){e.startsWith("#")?this.setFromHex(e):this.setFromHex((e=>{const t={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",honeydew:"#f0fff0",hotpink:"#ff69b4","indianred ":"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgrey:"#d3d3d3",lightgreen:"#90ee90",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370d8",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#d87093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",rebeccapurple:"#663399",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"};return void 0!==t[e.toLowerCase()]&&t[e.toLowerCase()]})(e));}toHex(){function e(e){const t=Math.round(255*e).toString(16);return 1==t.length?"0"+t:t}return "#"+e(this.r)+e(this.g)+e(this.b)}equal(e){return this.r==e.r&&this.g==e.g&&this.b==e.b&&this.a==e.a}notequals(e){return this.r!=e.r&&this.g!=e.g&&this.b!=e.b&&this.a!=e.a}approxEqual(e,t=Number.EPSILON){return Math.abs(this.r-e.r)<t&&Math.abs(this.g-e.g)<t&&Math.abs(this.b-e.b)<t&&Math.abs(this.a-e.a)<t}add(e){return new u(this.r+e.r,this.g+e.g,this.b+e.b,this.a+e.a)}subtract(e){return new u(this.r-e.r,this.g-e.g,this.b-e.b,this.a-e.a)}scale(e){return new u(this.r*e,this.g*e,this.b*e,this.a*e)}scaleInPlace(e){this.r*=e,this.g*=e,this.b*=e,this.a*=e;}applyGamma(e){this.set(Math.pow(this.r,e),Math.pow(this.g,e),Math.pow(this.b,e),this.a);}toLinear(e=2.2){return new u(Math.pow(this.r,e),Math.pow(this.g,e),Math.pow(this.b,e),this.a)}toGamma(e=2.2){return new u(Math.pow(this.r,1/e),Math.pow(this.g,1/e),Math.pow(this.b,1/e),this.a)}luminance(){return .2126*this.r+.7152*this.g+.0722*this.b}lerp(e,t){const a=this.r,i=this.g,s=this.b,n=this.a;return new u(a+t*(e.r-a),i+t*(e.g-i),s+t*(e.b-s),n+t*(e.a-n))}static random(e=0,t=!1){return e>0?new u(e+Math.random()*(1-e),e+Math.random()*(1-e),e+Math.random()*(1-e),t?e+Math.random()*(1-e):1):e<0?new u(Math.random()*(1+e),Math.random()*(1+e),Math.random()*(1+e),t?Math.random()*(1+e):1):new u(Math.random(),Math.random(),Math.random(),t?Math.random():1)}clone(){return new u(this.__data[0],this.__data[1],this.__data[2],this.__data[3])}asArray(){return this.__data}as3ComponentArray(){return [this.__data[0],this.__data[1],this.__data[2]]}static create(...e){return new u(...e)}static createFromFloat32Buffer(e,t=0){return new u(e,4*t)}static numElements(){return 4}toJSON(){return {r:this.r,g:this.g,b:this.b,a:this.a}}fromJSON(e){this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a;}toCSSString(){return "rgba("+Math.round(255*this.r)+", "+Math.round(255*this.g)+", "+Math.round(255*this.b)+", "+this.a+")"}}r.registerType("Color",u);class p extends l{constructor(e=0,t=0,a=0,i=0){if(super(),isNaN(i))switch(i){case"XYZ":this.order=0;break;case"YZX":this.order=1;break;case"ZXY":this.order=2;break;case"XZY":this.order=3;break;case"ZYX":this.order=4;break;case"YXZ":this.order=5;break;default:throw new Error("Invalid Euler Angles Order:"+i)}else this.order=i;if(e instanceof ArrayBuffer){const a=e,i=t;this.__data=new Float32Array(a,i,4);}else this.__data=new Float32Array(3),this.__data[0]=e,this.__data[1]=t,this.__data[2]=a;}get x(){return this.__data[0]}set x(e){this.__data[0]=e;}get y(){return this.__data[1]}set y(e){this.__data[1]=e;}get z(){return this.__data[2]}set z(e){this.__data[2]=e;}set(e,t,a){this.__data[0]=e,this.__data[1]=t,this.__data[2]=a;}}r.registerType("EulerAngles",p);class g extends l{constructor(e=1,t=0,a=0,i=0,s=1,n=0,l=0,r=0,o=1){if(super(),e instanceof ArrayBuffer){const a=e,i=t;this.__data=new Float32Array(a,i,9);}else this.__data=new Float32Array(9),this.set(e,t,a,i,s,n,l,r,o);}get m00(){return this.__data[0]}set m00(e){this.__data[0]=e;}get m01(){return this.__data[1]}set m01(e){this.__data[1]=e;}get m02(){return this.__data[2]}set m02(e){this.__data[2]=e;}get m10(){return this.__data[3]}set m10(e){this.__data[3]=e;}get m11(){return this.__data[4]}set m11(e){this.__data[4]=e;}get m12(){return this.__data[5]}set m12(e){this.__data[5]=e;}get m20(){return this.__data[6]}set m20(e){this.__data[6]=e;}get m21(){return this.__data[7]}set m21(e){this.__data[7]=e;}get m22(){return this.__data[8]}set m22(e){this.__data[8]=e;}get xAxis(){return d.createFromFloat32Buffer(this.__data.buffer,0)}set xAxis(e){this.xAxis.set(e.x,e.y,e.z);}get yAxis(){return d.createFromFloat32Buffer(this.__data.buffer,3)}set yAxis(e){this.yAxis.set(e.x,e.y,e.z);}get zAxis(){return d.createFromFloat32Buffer(this.__data.buffer,6)}set zAxis(e){this.zAxis.set(e.x,e.y,e.z);}set(e=1,t=0,a=0,i=0,s=1,n=0,l=0,r=0,o=1){this.__data[0]=e,this.__data[1]=t,this.__data[2]=a,this.__data[3]=i,this.__data[4]=s,this.__data[5]=n,this.__data[6]=l,this.__data[7]=r,this.__data[8]=o;}setIdentity(){this.set();}setFromMat(e){this.__data[0]=e.m00,this.__data[1]=e.m01,this.__data[2]=e.m02,this.__data[3]=e.m10,this.__data[4]=e.m11,this.__data[5]=e.m12,this.__data[6]=e.m20,this.__data[7]=e.m21,this.__data[8]=e.m22;}setFromDirectionAndUpvector(e,t){const a=e,i=a.length();if(i<Number.EPSILON)return void this.setIdentity();a.scaleInPlace(1/i);const s=t.cross(a),n=s.length();n>Number.EPSILON&&s.scaleInPlace(1/n);const l=a.cross(s),r=l.length();r>Number.EPSILON&&l.scaleInPlace(1/r),this.set(s.x,s.y,s.z,l.x,l.y,l.z,a.x,a.y,a.z);}inverse(){const e=this.__data[0],t=this.__data[1],a=this.__data[2],i=this.__data[3],s=this.__data[4],n=this.__data[5],l=this.__data[6],r=this.__data[7],o=this.__data[8],d=o*s-n*r,h=-o*i+n*l,c=r*i-s*l,m=e*d+t*h+a*c;return m?(m=1/m,new g(d*m,(-o*t+a*r)*m,(n*t-a*s)*m,h*m,(o*e-a*l)*m,(-n*e+a*i)*m,c*m,(-r*e+t*l)*m,(s*e-t*i)*m)):(console.warn("Unable to invert Mat3"),null)}invertInPlace(){const e=this.__data[0],t=this.__data[1],a=this.__data[2],i=this.__data[3],s=this.__data[4],n=this.__data[5],l=this.__data[6],r=this.__data[7],o=this.__data[8],d=o*s-n*r,h=-o*i+n*l,c=r*i-s*l,m=e*d+t*h+a*c;return m?(m=1/m,this.set(d*m,(-o*t+a*r)*m,(n*t-a*s)*m,h*m,(o*e-a*l)*m,(-n*e+a*i)*m,c*m,(-r*e+t*l)*m,(s*e-t*i)*m),!0):(console.warn("Unable to invert Mat3"),!1)}transpose(){return g(this.__data[0],this.__data[3],this.__data[6],this.__data[1],this.__data[4],this.__data[7],this.__data[2],this.__data[5],this.__data[8])}transposeInPlace(){const e=this.__data[1],t=this.__data[2],a=this.__data[5];this.__data[1]=this.__data[3],this.__data[2]=this.__data[6],this.__data[3]=e,this.__data[5]=this.__data[7],this.__data[6]=t,this.__data[7]=a;}transformVec3(e){return new d(this.__data[0]*e.x+this.__data[1]*e.y+this.__data[2]*e.z,this.__data[3]*e.x+this.__data[4]*e.y+this.__data[5]*e.z,this.__data[6]*e.x+this.__data[7]*e.y+this.__data[8]*e.z)}clone(){return new g(this.__data[0],this.__data[1],this.__data[2],this.__data[3],this.__data[4],this.__data[5],this.__data[6],this.__data[7],this.__data[8],this.__data[9])}static create(...e){return new g(...e)}static createFromFloat32Buffer(e,t=0){return new g(e,4*t)}toJSON(){return this.__data}fromJSON(e){this.__data=new Float32Array(e);}toString(){return this.toJSON().toString()}}r.registerType("Mat3",g);class _ extends l{constructor(e=1,t=0,a=0,i=0,s=0,n=1,l=0,r=0,o=0,d=0,h=1,c=0,m=0,u=0,b=0,p=1){if(super(),e instanceof Float32Array)this.__data=e;else if(e instanceof ArrayBuffer){const a=e,i=t;this.__data=new Float32Array(a,i,16);}else this.__data=new Float32Array(16),this.set(e,t,a,i,s,n,l,r,o,d,h,c,m,u,b,p);}get m00(){return this.__data[0]}set m00(e){this.__data[0]=e;}get m01(){return this.__data[1]}set m01(e){this.__data[1]=e;}get m02(){return this.__data[2]}set m02(e){this.__data[2]=e;}get m03(){return this.__data[3]}set m03(e){this.__data[3]=e;}get m10(){return this.__data[4]}set m10(e){this.__data[4]=e;}get m11(){return this.__data[5]}set m11(e){this.__data[5]=e;}get m12(){return this.__data[6]}set m12(e){this.__data[6]=e;}get m13(){return this.__data[7]}set m13(e){this.__data[7]=e;}get m20(){return this.__data[8]}set m20(e){this.__data[8]=e;}get m21(){return this.__data[9]}set m21(e){this.__data[9]=e;}get m22(){return this.__data[10]}set m22(e){this.__data[10]=e;}get m23(){return this.__data[11]}set m23(e){this.__data[11]=e;}get m30(){return this.__data[12]}set m30(e){this.__data[12]=e;}get m31(){return this.__data[13]}set m31(e){this.__data[13]=e;}get m32(){return this.__data[14]}set m32(e){this.__data[14]=e;}get m33(){return this.__data[15]}set m33(e){this.__data[15]=e;}get xAxis(){return d.createFromFloat32Buffer(this.__data.buffer,0)}set xAxis(e){this.xAxis.set(e.x,e.y,e.z);}get yAxis(){return d.createFromFloat32Buffer(this.__data.buffer,4)}set yAxis(e){this.yAxis.set(e.x,e.y,e.z);}get zAxis(){return d.createFromFloat32Buffer(this.__data.buffer,8)}set zAxis(e){this.zAxis.set(e.x,e.y,e.z);}get translation(){return d.createFromFloat32Buffer(this.__data.buffer,12)}set translation(e){this.translation.set(e.x,e.y,e.z);}set(e=1,t=0,a=0,i=0,s=0,n=1,l=0,r=0,o=0,d=0,h=1,c=0,m=0,u=0,b=0,p=1){this.__data[0]=e,this.__data[1]=t,this.__data[2]=a,this.__data[3]=i,this.__data[4]=s,this.__data[5]=n,this.__data[6]=l,this.__data[7]=r,this.__data[8]=o,this.__data[9]=d,this.__data[10]=h,this.__data[11]=c,this.__data[12]=m,this.__data[13]=u,this.__data[14]=b,this.__data[15]=p;}setIdentity(){this.set();}setDataArray(e){this.__data=e;}setFromMat4(e){this.__data[0]=e.m00,this.__data[1]=e.m01,this.__data[2]=e.m02,this.__data[3]=e.m03,this.__data[4]=e.m10,this.__data[5]=e.m11,this.__data[6]=e.m12,this.__data[7]=e.m13,this.__data[8]=e.m20,this.__data[9]=e.m21,this.__data[10]=e.m22,this.__data[11]=e.m23,this.__data[12]=e.m30,this.__data[13]=e.m31,this.__data[14]=e.m32,this.__data[15]=e.m33;}toMat3(e){return new g(this.__data[0],this.__data[1],this.__data[2],this.__data[4],this.__data[5],this.__data[6],this.__data[8],this.__data[9],this.__data[10])}transposeInPlace(){const e=this.__data[1],t=this.__data[2],a=this.__data[3],i=this.__data[6],s=this.__data[7],n=this.__data[11];this.__data[1]=this.__data[4],this.__data[2]=this.__data[8],this.__data[3]=this.__data[12],this.__data[4]=e,this.__data[6]=this.__data[9],this.__data[7]=this.__data[13],this.__data[8]=t,this.__data[9]=i,this.__data[11]=this.__data[14],this.__data[12]=a,this.__data[13]=s,this.__data[14]=n;}transpose(){return new _(this.__data[0],this.__data[4],this.__data[8],this.__data[12],this.__data[1],this.__data[5],this.__data[9],this.__data[13],this.__data[2],this.__data[6],this.__data[10],this.__data[14],this.__data[3],this.__data[7],this.__data[11],this.__data[15])}inverse(){const e=this.__data[0],t=this.__data[1],a=this.__data[2],i=this.__data[3],s=this.__data[4],n=this.__data[5],l=this.__data[6],r=this.__data[7],o=this.__data[8],d=this.__data[9],h=this.__data[10],c=this.__data[11],m=this.__data[12],u=this.__data[13],b=this.__data[14],p=this.__data[15],g=e*n-t*s,Z=e*l-a*s,G=e*r-i*s,X=t*l-a*n,y=t*r-i*n,f=a*r-i*l,V=o*u-d*m,x=o*b-h*m,I=o*p-c*m,R=d*b-h*u,S=d*p-c*u,W=h*p-c*b;let L=g*W-Z*S+G*R+X*I-y*x+f*V;return L?(L=1/L,new _((n*W-l*S+r*R)*L,(a*S-t*W-i*R)*L,(u*f-b*y+p*X)*L,(h*y-d*f-c*X)*L,(l*I-s*W-r*x)*L,(e*W-a*I+i*x)*L,(b*G-m*f-p*Z)*L,(o*f-h*G+c*Z)*L,(s*S-n*I+r*V)*L,(t*I-e*S-i*V)*L,(m*y-u*G+p*g)*L,(d*G-o*y-c*g)*L,(n*x-s*R-l*V)*L,(e*R-t*x+a*V)*L,(u*Z-m*X-b*g)*L,(o*X-d*Z+h*g)*L)):(console.warn("Unable to invert Mat4"),null)}invertInPlace(){const e=this.__data[0],t=this.__data[1],a=this.__data[2],i=this.__data[3],s=this.__data[4],n=this.__data[5],l=this.__data[6],r=this.__data[7],o=this.__data[8],d=this.__data[9],h=this.__data[10],c=this.__data[11],m=this.__data[12],u=this.__data[13],b=this.__data[14],p=this.__data[15],g=e*n-t*s,_=e*l-a*s,Z=e*r-i*s,G=t*l-a*n,X=t*r-i*n,y=a*r-i*l,f=o*u-d*m,V=o*b-h*m,x=o*p-c*m,I=d*b-h*u,R=d*p-c*u,S=h*p-c*b;let W=g*S-_*R+Z*I+G*x-X*V+y*f;return W?(W=1/W,this.set((n*S-l*R+r*I)*W,(a*R-t*S-i*I)*W,(u*y-b*X+p*G)*W,(h*X-d*y-c*G)*W,(l*x-s*S-r*V)*W,(e*S-a*x+i*V)*W,(b*Z-m*y-p*_)*W,(o*y-h*Z+c*_)*W,(s*R-n*x+r*f)*W,(t*x-e*R-i*f)*W,(m*X-u*Z+p*g)*W,(d*Z-o*X-c*g)*W,(n*V-s*I-l*f)*W,(e*I-t*V+a*f)*W,(u*_-m*G-b*g)*W,(o*G-d*_+h*g)*W),!0):(console.warn("Unable to invert Mat4"),!1)}setInverse(e){const t=e.__data[0],a=e.__data[1],i=e.__data[2],s=e.__data[3],n=e.__data[4],l=e.__data[5],r=e.__data[6],o=e.__data[7],d=e.__data[8],h=e.__data[9],c=e.__data[10],m=e.__data[11],u=e.__data[12],b=e.__data[13],p=e.__data[14],g=e.__data[15],_=t*l-a*n,Z=t*r-i*n,G=t*o-s*n,X=a*r-i*l,y=a*o-s*l,f=i*o-s*r,V=d*b-h*u,x=d*p-c*u,I=d*g-m*u,R=h*p-c*b,S=h*g-m*b,W=c*g-m*p;let L=_*W-Z*S+G*R+X*I-y*x+f*V;if(!L)throw new Error("Unable to invert Mat4");L=1/L,this.set((l*W-r*S+o*R)*L,(i*S-a*W-s*R)*L,(b*f-p*y+g*X)*L,(c*y-h*f-m*X)*L,(r*I-n*W-o*x)*L,(t*W-i*I+s*x)*L,(p*G-u*f-g*Z)*L,(d*f-c*G+m*Z)*L,(n*S-l*I+o*V)*L,(a*I-t*S-s*V)*L,(u*y-b*G+g*_)*L,(h*G-d*y-m*_)*L,(l*x-n*R-r*V)*L,(t*R-a*x+i*V)*L,(b*Z-u*X-p*_)*L,(d*X-h*Z+c*_)*L);}multiply(e){const t=this.__data[0],a=this.__data[1],i=this.__data[2],s=this.__data[3],n=this.__data[4],l=this.__data[5],r=this.__data[6],o=this.__data[7],d=this.__data[8],h=this.__data[9],c=this.__data[10],m=this.__data[11],u=this.__data[12],b=this.__data[13],p=this.__data[14],g=this.__data[15],Z=e.asArray();let G=Z[0],X=Z[1],y=Z[2],f=Z[3];const V=new _;return V.m00=G*t+X*n+y*d+f*u,V.m01=G*a+X*l+y*h+f*b,V.m02=G*i+X*r+y*c+f*p,V.m03=G*s+X*o+y*m+f*g,G=Z[4],X=Z[5],y=Z[6],f=Z[7],V.m10=G*t+X*n+y*d+f*u,V.m11=G*a+X*l+y*h+f*b,V.m12=G*i+X*r+y*c+f*p,V.m13=G*s+X*o+y*m+f*g,G=Z[8],X=Z[9],y=Z[10],f=Z[11],V.m20=G*t+X*n+y*d+f*u,V.m21=G*a+X*l+y*h+f*b,V.m22=G*i+X*r+y*c+f*p,V.m23=G*s+X*o+y*m+f*g,G=Z[12],X=Z[13],y=Z[14],f=Z[15],V.m30=G*t+X*n+y*d+f*u,V.m31=G*a+X*l+y*h+f*b,V.m32=G*i+X*r+y*c+f*p,V.m33=G*s+X*o+y*m+f*g,V}multiplyInPlace(e){const t=this.asArray(),a=t[0],i=t[1],s=t[2],n=t[3],l=t[4],r=t[5],o=t[6],d=t[7],h=t[8],c=t[9],m=t[10],u=t[11],b=t[12],p=t[13],g=t[14],_=t[15],Z=e.asArray();let G=Z[0],X=Z[1],y=Z[2],f=Z[3];return this.m00=G*a+X*l+y*h+f*b,this.m01=G*i+X*r+y*c+f*p,this.m02=G*s+X*o+y*m+f*g,this.m03=G*n+X*d+y*u+f*_,G=Z[4],X=Z[5],y=Z[6],f=Z[7],this.m10=G*a+X*l+y*h+f*b,this.m11=G*i+X*r+y*c+f*p,this.m12=G*s+X*o+y*m+f*g,this.m13=G*n+X*d+y*u+f*_,G=Z[8],X=Z[9],y=Z[10],f=Z[11],this.m20=G*a+X*l+y*h+f*b,this.m21=G*i+X*r+y*c+f*p,this.m22=G*s+X*o+y*m+f*g,this.m23=G*n+X*d+y*u+f*_,G=Z[12],X=Z[13],y=Z[14],f=Z[15],this.m30=G*a+X*l+y*h+f*b,this.m31=G*i+X*r+y*c+f*p,this.m32=G*s+X*o+y*m+f*g,this.m33=G*n+X*d+y*u+f*_,this}postmultiplyInPlace(e){const t=e.asArray(),a=t[0],i=t[1],s=t[2],n=t[3],l=t[4],r=t[5],o=t[6],d=t[7],h=t[8],c=t[9],m=t[10],u=t[11],b=t[12],p=t[13],g=t[14],_=t[15],Z=this.asArray();let G=Z[0],X=Z[1],y=Z[2],f=Z[3];return this.m00=G*a+X*l+y*h+f*b,this.m01=G*i+X*r+y*c+f*p,this.m02=G*s+X*o+y*m+f*g,this.m03=G*n+X*d+y*u+f*_,G=Z[4],X=Z[5],y=Z[6],f=Z[7],this.m10=G*a+X*l+y*h+f*b,this.m11=G*i+X*r+y*c+f*p,this.m12=G*s+X*o+y*m+f*g,this.m13=G*n+X*d+y*u+f*_,G=Z[8],X=Z[9],y=Z[10],f=Z[11],this.m20=G*a+X*l+y*h+f*b,this.m21=G*i+X*r+y*c+f*p,this.m22=G*s+X*o+y*m+f*g,this.m23=G*n+X*d+y*u+f*_,G=Z[12],X=Z[13],y=Z[14],f=Z[15],this.m30=G*a+X*l+y*h+f*b,this.m31=G*i+X*r+y*c+f*p,this.m32=G*s+X*o+y*m+f*g,this.m33=G*n+X*d+y*u+f*_,this}translateInPlace(e){const t=this.__data,a=e.x,i=e.y,s=e.z;return t[12]=t[0]*a+t[4]*i+t[8]*s+t[12],t[13]=t[1]*a+t[5]*i+t[9]*s+t[13],t[14]=t[2]*a+t[6]*i+t[10]*s+t[14],t[15]=t[3]*a+t[7]*i+t[11]*s+t[15],this}setLookAt(e,t,a){const i=e.subtract(t),s=i.length();if(s<Number.EPSILON)return void this.setIdentity();i.scaleInPlace(1/s);const n=a.cross(i),l=n.length();l>Number.EPSILON&&n.scaleInPlace(1/l);const r=i.cross(n),o=r.length();o>Number.EPSILON&&r.scaleInPlace(1/o),this.set(n.x,n.y,n.z,0,r.x,r.y,r.z,0,i.x,i.y,i.z,0,e.x,e.y,e.z,1);}setRotation(e,t){const a=e.length();if(Math.abs(a)<Number.EPSILON)return null;const i=e.x/a,s=e.y/a,n=e.z/a,l=Math.sin(t),r=Math.cos(t),o=1-r,d=this.__data;return d[0]=i*i*o+r,d[1]=s*i*o+n*l,d[2]=n*i*o-s*l,d[3]=0,d[4]=i*s*o-n*l,d[5]=s*s*o+r,d[6]=n*s*o+i*l,d[7]=0,d[8]=i*n*o+s*l,d[9]=s*n*o-i*l,d[10]=n*n*o+r,d[11]=0,d[12]=0,d[13]=0,d[14]=0,d[15]=1,this}setXRotation(e){const t=Math.sin(e),a=Math.cos(e),i=this.__data;return i[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=a,i[6]=t,i[7]=0,i[8]=0,i[9]=-t,i[10]=a,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,this}setYRotation(e){const t=Math.sin(e),a=Math.cos(e),i=this.__data;return i[0]=a,i[1]=0,i[2]=-t,i[3]=0,i[4]=0,i[5]=1,i[6]=0,i[7]=0,i[8]=t,i[9]=0,i[10]=a,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,this}setZRotation(e){const t=Math.sin(e),a=Math.cos(e),i=this.__data;return i[0]=a,i[1]=t,i[2]=0,i[3]=0,i[4]=-t,i[5]=a,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,this}transformVec4(e){const t=this.__data,a=e.x,i=e.y,s=e.z,n=e.t;return new Vec4(t[0]*a+t[4]*i+t[8]*s+t[12]*n,t[1]*a+t[5]*i+t[9]*s+t[13]*n,t[2]*a+t[6]*i+t[10]*s+t[14]*n,t[3]*a+t[7]*i+t[11]*s+t[15]*n)}transformVec3(e){const t=this.__data,a=e.x,i=e.y,s=e.z;return new d(t[0]*a+t[4]*i+t[8]*s+t[12],t[1]*a+t[5]*i+t[9]*s+t[13],t[2]*a+t[6]*i+t[10]*s+t[14])}rotateVec3(e){const t=this.__data,a=e.x,i=e.y,s=e.z;return new d(t[0]*a+t[4]*i+t[8]*s,t[1]*a+t[5]*i+t[9]*s,t[2]*a+t[6]*i+t[10]*s)}setPerspectiveMatrix(e,t,a,i){const s=Math.tan(.5*Math.PI-.5*e),n=1/(a-i);this.set(s/t,0,0,0,0,s,0,0,0,0,(a+i)*n,-1,0,0,a*i*n*2,0);}setOrthographicMatrix(e,t,a,i,s,n){const l=1/(e-t),r=1/(a-i),o=1/(s-n);this.set(-2*l,0,0,0,0,-2*r,0,0,0,0,2*o,0,(e+t)*l,(i+a)*r,(n+s)*o,1);}setScale(e,t,a){e instanceof d?this.set(e.x,0,0,0,0,e.y,0,0,0,0,e.z,0,0,0,0,1):this.set(e,0,0,0,0,t,0,0,0,0,a,0,0,0,0,1);}setFromMat3x4Array(e){this.set(e[0],e[1],e[2],0,e[3],e[4],e[5],0,e[6],e[7],e[8],0,e[9],e[10],e[11],1);}static createFromFloat32Buffer(e,t=0){return new _(e,4*t)}clone(){return new _(this.__data[0],this.__data[1],this.__data[2],this.__data[3],this.__data[4],this.__data[5],this.__data[6],this.__data[7],this.__data[8],this.__data[9],this.__data[10],this.__data[11],this.__data[12],this.__data[13],this.__data[14],this.__data[15])}static create(...e){return new _(...e)}toJSON(){return this.__data}fromJSON(e){this.__data=new Float32Array(e);}}r.registerType("Mat4",_);class Z extends l{constructor(e=0,t=0,a=0,i=1){if(super(),e instanceof ArrayBuffer){const a=e,i=t;this.__data=new Float32Array(a,i,4);}else if(this.__data=new Float32Array(4),"object"==typeof e){this.__data[0]=0,this.__data[1]=0,this.__data[2]=0,this.__data[3]=1;for(const t in e)Array.isArray(e[t])?this[t].call(this,...e[t]):this[t].call(this,e[t]);}else this.__data[0]=e,this.__data[1]=t,this.__data[2]=a,this.__data[3]=i;}get x(){return this.__data[0]}set x(e){this.__data[0]=e;}get y(){return this.__data[1]}set y(e){this.__data[1]=e;}get z(){return this.__data[2]}set z(e){this.__data[2]=e;}get w(){return this.__data[3]}set w(e){this.__data[3]=e;}set(e,t,a,i){this.__data[0]=e,this.__data[1]=t,this.__data[2]=a,this.__data[3]=i;}setDataArray(e){this.__data=e;}setFromOther(e){this.__data[0]=e.x,this.__data[1]=e.y,this.__data[2]=e.z,this.__data[3]=e.w;}setFromEulerAngles(e){const t=new d;switch(e.order){case 0:t.set(e.x,-e.y,e.z);break;case 1:t.set(e.y,-e.z,e.x);break;case 2:t.set(e.z,-e.x,e.y);break;case 3:t.set(e.x,e.z,e.y);break;case 4:t.set(e.z,e.y,e.x);break;case 5:t.set(e.y,e.x,e.z);break;default:throw new Error("sdrty")}const a=.5*t.x,i=.5*t.y,s=.5*t.z,n=Math.cos(a),l=Math.cos(i),r=Math.cos(s),o=Math.sin(a),h=Math.sin(i),c=Math.sin(s),m=n*r,u=n*c,b=o*r,p=o*c,g=l*b-h*u,_=l*p+h*m,Z=l*u-h*b;switch(this.w=l*m+h*p,e.order){case 0:this.x=g,this.y=-_,this.z=Z;break;case 1:this.x=Z,this.y=g,this.z=-_;break;case 2:this.x=-_,this.y=Z,this.z=g;break;case 3:this.x=g,this.y=Z,this.z=_;break;case 4:this.x=Z,this.y=_,this.z=g;break;case 5:this.x=_,this.y=g,this.z=Z;break;default:throw new Error("sdrty")}}toEulerAngles(e){const t=new d;switch(e){case 0:t.set(this.z,this.x,this.y);break;case 1:t.set(this.x,this.y,this.z);break;case 2:t.set(this.y,this.z,this.x);break;case 3:t.set(this.y,-this.x,this.z);break;case 4:t.set(this.x,-this.z,this.y);break;case 5:t.set(this.z,-this.y,this.x);break;default:throw new Error("Invalid rotation order:"+e)}const a=new d,i=t.x*t.y+t.z*this.w;if(i>.49999)a.y=2*Math.atan2(t.x,this.w),a.z=.5*Math.PI,a.x=0;else if(i<-.49999)a.y=-2*Math.atan2(t.x,this.w),a.z=-.5*Math.PI,a.x=0;else {const e=t.x*t.x,s=t.y*t.y,n=t.z*t.z;a.y=Math.atan2(2*t.y*this.w-2*t.x*t.z,1-2*s-2*n),a.z=Math.asin(2*i),a.x=Math.atan2(2*t.x*this.w-2*t.y*t.z,1-2*e-2*n);}switch(e){case 0:return new p(a.y,a.z,a.x,e);case 1:return new p(a.x,a.y,a.z,e);case 2:return new p(a.z,a.x,a.y,e);case 3:return new p(-a.y,a.x,a.z,e);case 4:return new p(a.x,a.z,-a.y,e);case 5:return new p(a.z,-a.y,a.x,e)}}setFromAxisAndAngle(e,t){const a=t/2,i=e.normalize().scale(Math.sin(a));this.set(i.x,i.y,i.z,Math.cos(a));}setFromDirectionAndUpvector(e,t){const a=new g;a.setFromDirectionAndUpvector(e,t),this.setFromMat3(a);}setFrom2Vectors(e,t){e.normalize(),t.normalize();const a=e.cross(t),i=e.dot(t),s=Math.sqrt(2*(1+i));this.set(a.x/s,a.y/s,a.z/s,s/2),this.normalizeInPlace();}setFromMat3(e){const t=e.__data[0]+e.__data[4]+e.__data[8];let a;if(t>0)a=Math.sqrt(t+1),this.__data[3]=.5*a,a=.5/a,this.__data[0]=(e.__data[5]-e.__data[7])*a,this.__data[1]=(e.__data[6]-e.__data[2])*a,this.__data[2]=(e.__data[1]-e.__data[3])*a;else {let t=0;e.__data[4]>e.__data[0]&&(t=1),e.__data[8]>e.__data[3*t+t]&&(t=2);const i=(t+1)%3,s=(t+2)%3;a=Math.sqrt(e.__data[3*t+t]-e.__data[3*i+i]-e.__data[3*s+s]+1),this.__data[t]=.5*a,a=.5/a,this.__data[3]=(e.__data[3*i+s]-e.__data[3*s+i])*a,this.__data[i]=(e.__data[3*i+t]+e.__data[3*t+i])*a,this.__data[s]=(e.__data[3*s+t]+e.__data[3*t+s])*a;}this.normalizeInPlace();}setFromMat4(e){const t=e.__data[0]+e.__data[5]+e.__data[10];let a;if(t>0)a=Math.sqrt(t+1),this.__data[3]=.5*a,a=.5/a,this.__data[0]=(e.__data[6]-e.__data[9])*a,this.__data[1]=(e.__data[8]-e.__data[2])*a,this.__data[2]=(e.__data[1]-e.__data[4])*a;else {let t=0;e.__data[5]>e.__data[0]&&(t=1),e.__data[10]>e.__data[4*t+t]&&(t=2);const i=(t+1)%3,s=(t+2)%3;a=Math.sqrt(e.__data[4*t+t]-e.__data[4*i+i]-e.__data[4*s+s]+1),this.__data[t]=.5*a,a=.5/a,this.__data[3]=(e.__data[4*i+s]-e.__data[4*s+i])*a,this.__data[i]=(e.__data[4*i+t]+e.__data[4*t+i])*a,this.__data[s]=(e.__data[4*s+t]+e.__data[4*t+s])*a;}this.normalizeInPlace();}isIdentity(){return this.getAngle()<Number.EPSILON}getAngle(){return 2*Math.acos(this.w)}equal(e){return this.x==e.x&&this.y==e.y&&this.z==e.z&&this.w==e.w}notequals(e){return this.x!=e.x&&this.y!=e.y&&this.z!=e.z&&this.w!=e.w}approxEqual(e,t=Number.EPSILON){return Math.abs(this.x-e.x)<t&&Math.abs(this.y-e.y)<t&&Math.abs(this.z-e.z)<t&&Math.abs(this.w-e.w)<t}add(e){return new Z(this.x+e.x,this.y+e.y,this.z+e.z,this.w+e.w)}addInPlace(e){this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w;}subtract(e){return new Z(this.x-e.x,this.y-e.y,this.z-e.z,this.w-e.w)}scale(e){return new Z(this.x*e,this.y*e,this.z*e,this.w*e)}scaleInPlace(e){this.x*=e,this.y*=e,this.z*=e,this.w*=e;}length(){const e=this.__data[0],t=this.__data[1],a=this.__data[2],i=this.__data[3];return Math.sqrt(e*e+t*t+a*a+i*i)}lengthSquared(){const e=this.__data[0],t=this.__data[1],a=this.__data[2],i=this.__data[3];return e*e+t*t+a*a+i*i}normalize(){const e=this.__data[0],t=this.__data[1],a=this.__data[2],i=this.__data[3];let s=e*e+t*t+a*a+i*i;return s<Number.EPSILON?new Z:(s=1/Math.sqrt(s),new Z(e*s,t*s,a*s))}normalizeInPlace(){const e=this.__data[0],t=this.__data[1],a=this.__data[2],i=this.__data[3];let s=e*e+t*t+a*a+i*i;s<Number.EPSILON||(s=1/Math.sqrt(s),this.set(e*s,t*s,a*s,i*s));}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}cross(e){const t=this.x,a=this.y,i=this.z,s=this.w,n=e.x,l=e.y,r=e.z,o=e.w;return new Z(a*r-i*l,i*o-s*r,s*n-t*o,t*l-a*n)}conjugate(){return new Z(-this.x,-this.y,-this.z,this.w)}inverse(){return this.conjugate()}alignWith(e){this.dot(e)<0&&this.set(-this.x,-this.y,-this.z,-this.w);}multiply(e){const t=this.__data[0],a=this.__data[1],i=this.__data[2],s=this.__data[3],n=e.__data[0],l=e.__data[1],r=e.__data[2],o=e.__data[3];return new Z(t*o+s*n+a*r-i*l,a*o+s*l+i*n-t*r,i*o+s*r+t*l-a*n,s*o-t*n-a*l-i*r)}multiplyInPlace(e){const t=this.__data[0],a=this.__data[1],i=this.__data[2],s=this.__data[3],n=e.__data[0],l=e.__data[1],r=e.__data[2],o=e.__data[3];this.set(t*o+s*n+a*r-i*l,a*o+s*l+i*n-t*r,i*o+s*r+t*l-a*n,s*o-t*n-a*l-i*r);}rotateVec3(e){const t=new Z(e.x,e.y,e.z,0),a=this.multiply(t).multiply(this.conjugate());return new d(a.x,a.y,a.z)}rotateX(e){e*=.5;const t=this.x,a=this.y,i=this.z,s=this.w,n=Math.sin(e),l=Math.cos(e);this.x=t*l+s*n,this.y=a*l+i*n,this.z=i*l-a*n,this.w=s*l-t*n;}rotateY(e){e*=.5;const t=this.x,a=this.y,i=this.z,s=this.w,n=Math.sin(e),l=Math.cos(e);this.x=t*l-i*n,this.y=a*l+s*n,this.z=i*l+t*n,this.w=s*l-a*n;}rotateZ(e){e*=.5;const t=this.x,a=this.y,i=this.z,s=this.w,n=Math.sin(e),l=Math.cos(e);this.x=t*l+a*n,this.y=a*l-t*n,this.z=i*l+s*n,this.w=s*l-i*n;}toMat3(){const e=this.x,t=this.y,a=this.z,i=this.w,s=e+e,n=t+t,l=a+a,r=e*s,o=t*s,d=t*n,h=a*s,c=a*n,m=a*l,u=i*s,b=i*n,p=i*l,_=new g;return _.__data[0]=1-d-m,_.__data[3]=o-p,_.__data[6]=h+b,_.__data[1]=o+p,_.__data[4]=1-r-m,_.__data[7]=c-u,_.__data[2]=h-b,_.__data[5]=c+u,_.__data[8]=1-r-d,_}getXaxis(){const e=this.x*this.y,t=this.x*this.z,a=this.y*this.y,i=this.y*this.w,s=this.z*this.z,n=this.z*this.w;return new d(1-2*(s+a),2*(e+n),2*(t-i))}getYaxis(){const e=this.x*this.x,t=this.x*this.y,a=this.x*this.w,i=this.y*this.z,s=this.z*this.z,n=this.z*this.w;return new d(2*(t-n),1-2*(s+e),2*(i+a))}getZaxis(){const e=this.x*this.x,t=this.x*this.z,a=this.x*this.w,i=this.y*this.y,s=this.y*this.z,n=this.y*this.w;new d;return new d(2*(n+t),2*(s-a),1-2*(i+e))}mirror(e){switch(e){case 0:return new Z(this.z,this.w,this.x,this.y);case 1:return new Z(-this.w,this.z,this.y,-this.x);case 2:return new Z(this.x,this.y,this.z,-this.w)}}toMat4(){const e=this.x,t=this.y,a=this.z,i=this.w,s=e+e,n=t+t,l=a+a,r=e*s,o=t*s,d=t*n,h=a*s,c=a*n,m=a*l,u=i*s,b=i*n,p=i*l,g=new _;return g.__data[0]=1-d-m,g.__data[4]=o-p,g.__data[8]=h+b,g.__data[1]=o+p,g.__data[5]=1-r-m,g.__data[9]=c-u,g.__data[2]=h-b,g.__data[6]=c+u,g.__data[10]=1-r-d,g}lerp(e,t){const a=new Z(this.x+t*(e.x-this.x),this.y+t*(e.y-this.y),this.z+t*(e.z-this.z),this.w+t*(e.w-this.w));return a.normalizeInPlace(),a}static create(...e){return new Z(...e)}static createFromFloat32Buffer(e,t=0){return new Z(e,4*t)}static numElements(){return 4}clone(){return new Z(this.__data[0],this.__data[1],this.__data[2],this.__data[3])}toJSON(){return {x:this.x,y:this.y,z:this.z,w:this.w}}fromJSON(e){this.__data[0]=e.x,this.__data[1]=e.y,this.__data[2]=e.z,this.__data[3]=e.w,this.normalizeInPlace();}}r.registerType("Quat",Z);class G{constructor(e,t){this.start=e instanceof d?e:new d,this.dir=t instanceof d?t:new d;}closestPoint(e){const t=e.subtract(this.start).dot(this.dir);if(t<Number.EPSILON)return this.start;const a=t/this.dir.dot(this.dir);return this.start.add(this.dir.scale(a))}pointAtDist(e){return this.start.add(this.dir.scale(e))}intersectRayVector(e){const t=this.dir,a=e.dir,i=this.start.subtract(e.start),s=t.dot(t),n=t.dot(a),l=a.dot(a),r=t.dot(i),o=a.dot(i);if(0==s&&0==l)return this.start.distanceTo(e.start);if(0==s)return e.closestPoint(this.start);if(0==l)return this.closestPoint(e.start);const d=s*l-n*n;let h,c;return d<.001?(h=0,c=n>l?r/n:o/l):(h=(n*o-l*r)/d,c=(s*o-n*r)/d),[h,c]}intersectRayPlane(e){const t=this.start.subtract(e.start),a=e.dir.dot(this.dir),i=-e.dir.dot(t);if(Math.abs(a)<Number.PRECISION)return -1;const s=i/a;return s<-Number.PRECISION?-1:s}clone(){return new G(this.start.clone(),this.dir.clone())}static create(...e){return new G(...e)}toJSON(){return {start:this.start,dir:this.dir}}fromJSON(e){this.start.fromJSON(e.start),this.dir.fromJSON(e.dir);}toString(){return n(this.toJSON())}}r.registerType("Ray",G);new d(1,1,1);class X{constructor(e,t,a){if(e instanceof Float32Array)this.setFromFloat32Array(e);else {if(e instanceof d)this.tr=e;else {if(e instanceof Z&&null==t&&null==a)return this.tr=new d,this.ori=e,void(this.sc=new d(1,1,1));this.tr=new d;}this.ori=t instanceof Z?t:new Z,this.sc=a instanceof d?a:new d(1,1,1);}}set(e,t,a){this.tr=e,this.ori=t,a instanceof d&&(this.sc=a);}setFromOther(e){this.tr=e.tr,this.ori=e.ori,this.sc=e.sc;}isIdentity(){return this.tr.isNull()&&this.ori.isIdentity()&&this.sc.is111()}setLookAt(e,t,a){const i=e.subtract(t);if(i.length()<Number.EPSILON)throw new Error("Invalid dir");this.ori.setFromDirectionAndUpvector(i,a),this.tr=e;}multiply(e){let t=this.sc;return this.sc.x==this.sc.y&&this.sc.x==this.sc.z||(t=e.ori.rotateVec3(this.sc),Math.sign(t.x)!=Math.sign(this.sc.x)&&(t.x=-t.x),Math.sign(t.y)!=Math.sign(this.sc.y)&&(t.y=-t.y),Math.sign(t.z)!=Math.sign(this.sc.z)&&(t.z=-t.z)),new X(this.tr.add(this.ori.rotateVec3(t.multiply(e.tr))),this.ori.multiply(e.ori),t.multiply(e.sc))}inverse(){const e=new X;return e.ori=this.ori.inverse(),this.sc.x!=this.sc.y||this.sc.x!=this.sc.z?(e.sc=e.ori.rotateVec3(this.sc),Math.sign(e.sc.x)!=Math.sign(this.sc.x)&&(e.sc.x=-e.sc.x),Math.sign(e.sc.y)!=Math.sign(this.sc.y)&&(e.sc.y=-e.sc.y),Math.sign(e.sc.z)!=Math.sign(this.sc.z)&&(e.sc.z=-e.sc.z)):e.sc=this.sc.inverse(),e.tr=e.ori.rotateVec3(this.tr.negate().multiply(e.sc)),e}transformVec3(e){return this.tr.add(this.ori.rotateVec3(this.sc.multiply(e)))}toMat4(){const e=new _(this.sc.x,0,0,0,0,this.sc.y,0,0,0,0,this.sc.z,0,0,0,0,1),t=this.ori.toMat4(),a=new _;return a.translation=this.tr,a.multiply(t).multiply(e)}fromMat4(e){this.tr=e.translation,this.ori.setFromMat4(e);}setFromFloat32Array(e){if(7==e.length)return this.tr=new d(e.buffer,e.byteOffset),this.ori=new Z(e.buffer,e.byteOffset+12),void(this.sc=new d(1,1,1));if(8!=e.length)return 10==e.length?(this.tr=new d(e.buffer,e.byteOffset),this.ori=new Z(e.buffer,e.byteOffset+12),void(this.sc=new d(e.buffer,e.byteOffset+21))):void 0;{this.tr=new d(e.buffer,e.byteOffset),this.ori=new Z(e.buffer,e.byteOffset+12);const t=e[7];this.sc=new d(t,t,t);}}clone(){return new X(this.tr.clone(),this.ori.clone(),this.sc.clone())}static create(...e){return new X(...e)}toJSON(){const e={tr:this.tr.toJSON(),ori:this.ori.toJSON()};return this.sc.is111()||(e.sc=this.sc.toJSON()),e}fromJSON(e){this.tr.fromJSON(e.tr),this.ori.fromJSON(e.ori),e.sc&&this.sc.fromJSON(e.sc);}toString(){return n(this.toJSON())}}r.registerType("Xfo",X);class y{constructor(e,t){this.p0=e instanceof o?e:new o(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),this.p1=t instanceof o?t:new o(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);}set(e,t){this.p0=e,this.p1=t;}reset(){this.p0.x=Number.POSITIVE_INFINITY,this.p1.x=Number.NEGATIVE_INFINITY,this.p0.y=Number.POSITIVE_INFINITY,this.p1.y=Number.NEGATIVE_INFINITY;}isValid(){return this.p0.x!=Number.POSITIVE_INFINITY&&this.p1.x!=Number.NEGATIVE_INFINITY&&this.p0.y!=Number.POSITIVE_INFINITY&&this.p1.y!=Number.NEGATIVE_INFINITY}addPoint(e){(this.p0.x==Number.POSITIVE_INFINITY||e.x<this.p0.x)&&(this.p0.x=e.x),(this.p0.y==Number.POSITIVE_INFINITY||e.y<this.p0.y)&&(this.p0.y=e.y),(this.p1.y==Number.NEGATIVE_INFINITY||e.x>this.p1.x)&&(this.p1.x=e.x),(this.p1.y==Number.NEGATIVE_INFINITY||e.y>this.p1.y)&&(this.p1.y=e.y);}size(){return this.p1.subtract(this.p0)}diagonal(){return this.p1.subtract(this.p0)}center(){const e=this.p1.subtract(this.p0);return e.scaleInPlace(.5),e.addInPlace(this.p0),e}static create(...e){return new y(...e)}toJSON(){return {p0:this.p0.toJSON(),p1:this.p1.toJSON()}}toString(){return n(this.toJSON())}}r.registerType("Box2",y);class f extends l{constructor(e,t=0){super(),this.pos=e instanceof d?e:new d,this.radius=t;}clone(){return new Sphere(this.pos.clone(),this.radius)}intersectsBox(e){return e.intersectsSphere(this)}static create(...e){return new Sphere(...e)}toJSON(){return {pos:this.pos.toJSON(),radius:this.radius}}toString(){return n(this.toJSON())}}r.registerType("SphereType",f);class V{constructor(e,t){e instanceof Float32Array?this.setFromFloat32Array(e):(this.p0=e instanceof d?e:new d(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),this.p1=t instanceof d?t:new d(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY));}get min(){return this.p0}get max(){return this.p1}set(e,t){this.p0=e,this.p1=t;}reset(){this.p0.x=Number.POSITIVE_INFINITY,this.p1.x=Number.NEGATIVE_INFINITY,this.p0.y=Number.POSITIVE_INFINITY,this.p1.y=Number.NEGATIVE_INFINITY,this.p0.z=Number.POSITIVE_INFINITY,this.p1.z=Number.NEGATIVE_INFINITY;}isValid(){return this.p0.x!=Number.POSITIVE_INFINITY&&this.p1.x!=Number.NEGATIVE_INFINITY&&this.p0.y!=Number.POSITIVE_INFINITY&&this.p1.y!=Number.NEGATIVE_INFINITY&&this.p0.z!=Number.POSITIVE_INFINITY&&this.p1.z!=Number.NEGATIVE_INFINITY}addPoint(e){e.x!=Number.POSITIVE_INFINITY&&e.x!=Number.NEGATIVE_INFINITY&&(e.x<this.p0.x&&(this.p0.x=e.x),e.x>this.p1.x&&(this.p1.x=e.x)),e.y!=Number.POSITIVE_INFINITY&&e.y!=Number.NEGATIVE_INFINITY&&(e.y<this.p0.y&&(this.p0.y=e.y),e.y>this.p1.y&&(this.p1.y=e.y)),e.z!=Number.POSITIVE_INFINITY&&e.z!=Number.NEGATIVE_INFINITY&&(e.z<this.p0.z&&(this.p0.z=e.z),e.z>this.p1.z&&(this.p1.z=e.z));}addBox3(e,t){t?(this.addPoint(t.transformVec3(e.p0)),this.addPoint(t.transformVec3(new d(e.p0.x,e.p0.y,e.p1.z))),this.addPoint(t.transformVec3(new d(e.p0.x,e.p1.y,e.p0.z))),this.addPoint(t.transformVec3(new d(e.p1.x,e.p0.y,e.p0.z))),this.addPoint(t.transformVec3(new d(e.p0.x,e.p1.y,e.p1.z))),this.addPoint(t.transformVec3(new d(e.p1.x,e.p0.y,e.p1.z))),this.addPoint(t.transformVec3(new d(e.p1.x,e.p1.y,e.p0.z))),this.addPoint(t.transformVec3(e.p1))):(this.addPoint(e.p0),this.addPoint(e.p1));}size(){return this.p1.subtract(this.p0)}diagonal(){return this.p1.subtract(this.p0)}center(){const e=this.p1.subtract(this.p0);return e.scaleInPlace(.5),e.addInPlace(this.p0),e}toMat4(){const e=this.p1.x-this.p0.x,t=this.p1.y-this.p0.y,a=this.p1.z-this.p0.z;return new _(e,0,0,0,0,t,0,0,0,0,a,0,this.p0.x,this.p0.y,this.p0.z,1)}getBoundingSphere(){return new f(this.center(),.5*this.diagonal().length())}intersectsBox(e){return !(e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y||e.max.z<this.min.z||e.min.z>this.max.z)}intersectsSphere(e){return closestPoint.distanceToSquared(e.center)<=e.radius*e.radius}intersectsPlane(e){let t,a;return e.normal.x>0?(t=e.normal.x*this.min.x,a=e.normal.x*this.max.x):(t=e.normal.x*this.max.x,a=e.normal.x*this.min.x),e.normal.y>0?(t+=e.normal.y*this.min.y,a+=e.normal.y*this.max.y):(t+=e.normal.y*this.max.y,a+=e.normal.y*this.min.y),e.normal.z>0?(t+=e.normal.z*this.min.z,a+=e.normal.z*this.max.z):(t+=e.normal.z*this.max.z,a+=e.normal.z*this.min.z),t<=-e.constant&&a>=-e.constant}clone(){return new V(this.p0.clone(),this.p1.clone())}static create(...e){return new V(...e)}static sizeInBytes(){return 24}toJSON(){return {p0:this.p0.toJSON(),p1:this.p1.toJSON()}}fromJSON(e){this.p0.fromJSON(e.p0),this.p1.fromJSON(e.p1);}loadBin(e,t){this.p0.loadBin(e,t),this.p0.loadBin(e,t+12);}setFromFloat32Array(e){this.p0=new d(e.buffer,e.byteOffset),this.p1=new d(e.buffer,e.byteOffset+12);}toString(){return n(this.toJSON())}}r.registerType("Box3",V);class x extends l{constructor(e,t=0){super(),this.normal=e instanceof d?e:new d,this.w=t;}set(e,t,a,i){this.normal.set(e,t,a),this.w=i;}divideScalar(e){this.normal.scaleInPlace(1/e),this.w/=e;}distanceToPoint(e){return e.dot(this.normal)+this.w}normalizeInPlace(){const e=1/this.normal.length();this.normal.scaleInPlace(e),this.w*=e;}clone(){return new Plane(this.normal.clone(),this.w)}static create(...e){return new Plane(...e)}toJSON(){return {normal:this.normal.toJSON(),w:this.w}}toString(){return n(this.toJSON())}}r.registerType("PlaneType",x);class I{constructor(e,t,a,i,s,n){this.planes=[e||new x,t||new x,a||new x,i||new x,s||new x,n||new x];}setFromMatrix(e){const t=e,a=this.planes;a[0].set(t.m03-t.m00,t.m13-t.m10,t.m23-t.m20,t.m33-t.m30),a[1].set(t.m03+t.m00,t.m13+t.m10,t.m23+t.m20,t.m33+t.m30),a[2].set(t.m03+t.m01,t.m13+t.m11,t.m23+t.m21,t.m33+t.m31),a[3].set(t.m03-t.m01,t.m13-t.m11,t.m23-t.m21,t.m33-t.m31),a[4].set(t.m03-t.m02,t.m13-t.m12,t.m23-t.m22,t.m33-t.m32),a[5].set(t.m03+t.m02,t.m13+t.m12,t.m23+t.m22,t.m33+t.m32),a.forEach(e=>e.normalizeInPlace());}intersectsBox(e){const t=new d,a=this.planes,{min:i,max:s}=e;for(let e=0;e<6;e++){const n=a[e];if(t.x=n.normal.x>0?s.x:i.x,t.y=n.normal.y>0?s.y:i.y,t.z=n.normal.z>0?s.z:i.z,n.distanceToPoint(t)<0)return !1}return !0}toJSON(){return {p0:this.p0.toJSON(),p1:this.p1.toJSON(),p2:this.p2.toJSON(),p3:this.p3.toJSON(),p4:this.p4.toJSON(),p5:this.p5.toJSON()}}fromJSON(e){this.p0.fromJSON(e.p0),this.p1.fromJSON(e.p1),this.p2.fromJSON(e.p2),this.p3.fromJSON(e.p3),this.p4.fromJSON(e.p4),this.p5.fromJSON(e.p5);}toString(){return n(this.toJSON())}}r.registerType("Frustum",I);var R=Object.freeze({__proto__:null,UInt8:0,SInt8:1,SInt16:3,UInt16:2,SInt32:5,UInt32:4,Float32:6,hashStr:s,JSON_stringify_fixedPrecision:n,AttrValue:l,Vec2:o,Vec3:d,Vec4:h,RGBA:m,Color:u,EulerAngles:p,Quat:Z,Ray:G,Mat3:g,Mat4:_,Xfo:X,Box2:y,Box3:V,Frustum:I,PlaneType:x,SphereType:f,typeRegistry:r});class S{constructor(e=!1){this.__slots=[],this.__toggledSignal=e,this.__toggled=!1,this.__data=null,this.connect=this.connect.bind(this),this.disconnect=this.disconnect.bind(this),this.emit=this.emit.bind(this);}connect(e){if(null==e)throw new Error("a function callback must be passed to Signal.connect");if(-1!=this.__slots.indexOf(e))return void console.warn("fn '"+e.name+"' already connected to Signal.");const t=this.__slots.length;return this.__slots[t]=e,this.__toggledSignal&&this.__toggled&&(this.__data?e(...this.__data):e()),t}disconnect(e){if(null==e)throw new Error("a function callback must be passed to Signal.disconnect");const t=[];if(this.__slots.forEach((function(a,i){a===e&&t.push(i);})),0!=t.length)for(const e of t)this.__slots[e]=void 0;else console.warn("callback :"+e.name+" was not connected to this signal:"+this.__name);}disconnectId(e){if(!this.__slots[e])throw new Error("Invalid ID");this.__slots[e]=void 0;}emit(...e){this.__toggledSignal&&(this.__toggled?console.warn("Toggled signals should only be fired once, or untoggled before re-firing.."):(this.__toggled=!0,this.__data=e));const t=this.__slots.length;for(let a=0;a<t;a++){const t=this.__slots[a];t&&t(...e);}}isToggled(){return this.__toggled}setToggled(e){this.__toggled=e,this.__data=void 0;}getNumConnections(){return this.__slots.length}untoggle(){this.__toggled=!1,this.__data=void 0;}}class W{constructor(e=0,t=0){this.root={x:0,y:0,w:e,h:t},this.resized=new S;}fit(e){if(0==e.length)return;let t=!1;this.root.w<e[0].w&&(this.root.w=e[0].w,t=!0),this.root.h<e[0].h&&(this.root.h=e[0].h,t=!0),t&&this.resized.emit(this.root.w,this.root.h);e.forEach(e=>{e.fit=this.__addBlock(e);});}__addBlock(e){const t=this.findNode(this.root,e.w,e.h);return t?this.splitNode(t,e.w,e.h):this.growNode(e.w,e.h)}addBlock(e){let t=!1;this.root.w<e.w&&(this.root.w=e.w,t=!0),this.root.h<e.h&&(this.root.h=e.h,t=!0),t&&this.resized.emit(this.root.w,this.root.h);const a=this.findNode(this.root,e.w,e.h);return a?this.splitNode(a,e.w,e.h):this.growNode(e.w,e.h)}findNode(e,t,a){return e.used?this.findNode(e.right,t,a)||this.findNode(e.down,t,a):t<=e.w&&a<=e.h?e:null}splitNode(e,t,a){return e.used=!0,e.down={x:e.x,y:e.y+a,w:e.w,h:e.h-a},e.right={x:e.x+t,y:e.y,w:e.w-t,h:a},e}growNode(e,t){const a=e<=this.root.w,i=t<=this.root.h,s=i&&this.root.h>=this.root.w+e,n=a&&this.root.w>=this.root.h+t;return s?this.growRight(e,t):n?this.growDown(e,t):i?this.growRight(e,t):a?this.growDown(e,t):null}growRight(e,t){this.root={used:!0,x:0,y:0,w:this.root.w+e,h:this.root.h,down:this.root,right:{x:this.root.w,y:0,w:e,h:this.root.h}};const a=this.findNode(this.root,e,t);let i;return a&&(i=this.splitNode(a,e,t)),this.resized.emit(this.root.w,this.root.h),i}growDown(e,t){this.root={used:!0,x:0,y:0,w:this.root.w,h:this.root.h+t,down:{x:0,y:this.root.h,w:this.root.w,h:t},right:this.root};const a=this.findNode(this.root,e,t);let i;return a&&(i=this.splitNode(a,e,t)),this.resized.emit(this.root.w,this.root.h),i}}class L{constructor(e=0){this.__asyncCount=e,this.ready=new S(!0),this.incAsyncCount=function(e=1){this.__asyncCount+=e,this.ready.setToggled(!1);}.bind(this),this.decAsyncCount=function(){this.__asyncCount>0&&(this.__asyncCount--,0==this.__asyncCount&&this.__asyncsCompleted());}.bind(this),this.__asyncsCompleted=function(){this.ready.emit();}.bind(this);}get count(){return this.__asyncCount}}const v=e=>{if(window.TextDecoder)return new TextDecoder("utf-8").decode(e);{let t="";for(let a=0;a<e.length;a++)t+=String.fromCharCode(e[a]);return t}};var M=Object.freeze({__proto__:null,GrowingPacker:W,Async:L,Signal:S,decodeText:v});let F=0;class T{constructor(){if("RefCounted"==this.constructor.name)throw new Error("RefCounted should not be instantiated directly.");this.__id=++F,this.__refs=[],this.destructing=new S,this.__destroyed=!1;}getId(){return this.__id}numRefs(){return this.__refs.length}addRef(e){if(!e)throw new Error("Error in RefCounted.addRef: Must provide a referer");return this.__refs.push(e),!0}removeRef(e){if(!e)throw new Error("Error in RefCounted.removeRef: Must provide a referer");const t=this.__refs.indexOf(e);if(-1==t)throw new Error("Error in RefCounted.removeRef: referer not found in refs list.");this.__refs.splice(t,1),0==this.__refs.length&&this.destroy();}getRefer(e){return this.__refs[e]}getRefIndex(e){return this.__refs.indexOf(e)}isDestroyed(){return this.__destroyed}destroy(){this.__destroyed=!0,this.destructing.emit(this);}}const C=new class{constructor(){this.__registeredClasses={},this.__classNames={};}registerClass(e,t){this.__registeredClasses[e]={cls:t,callbacks:[]},this.__classNames[t.name]=e;}registerCallback(e,t){const a=this.__registeredClasses[e];a?a.callbacks.push(t):console.warn("Factory not registered:"+e);}getClass(e){if(this.__registeredClasses[e])return this.__registeredClasses[e].cls}getClassName(e){return this.__classNames[e.constructor.name]?this.__classNames[e.constructor.name]:e.constructor.name}isConstructing(){return this.__constructing}constructClass(e){const t=this.__registeredClasses[e];if(!t)return console.warn("Factory not registered:"+e),null;this.__constructing=!0;const a=Array.prototype.slice.call(arguments,1),i=new t.cls(...a);return this.__constructing=!1,this.invokeCallbacks(i),i}invokeCallbacks(e){if(this.__classNames[e.constructor.name]){const t=this.__registeredClasses[this.__classNames[e.constructor.name]];for(const a of t.callbacks)a(e);}}},Y={NORMAL:0,OPERATOR_GETVALUE:1},N={USER_SETVALUE:0,REMOTEUSER_SETVALUE:1,USER_SETVALUE_DONE:2,OPERATOR_SETVALUE:3,OPERATOR_DIRTIED:4,COMPUTED_VALUE:4,GENERATED_VALUE:4,DATA_LOAD:4},K={USER_EDITED:2,DISABLED:4},w=0,z=1,U=2;class J{constructor(e){this.__name=e,this.__cleanerFns=[],this.__boundOps=[],this.__state=w,this.__flags=0,this.valueChanged=new S,this.nameChanged=new S,this.getName=this.getName.bind(this),this.setName=this.setName.bind(this),this.getValue=this.getValue.bind(this),this.setValue=this.setValue.bind(this);}getName(){return this.__name}setName(e){if(e!=this.__name){const t=this.__name;this.__name=e,this.nameChanged.emit(this.__name,t);}}getOwner(){return this.ownerItem}addOwner(e){this.ownerItem=e;}getPath(){const e=this.getOwner();if(e&&e.getName){if(e.getPath){const t=e.getPath().slice();return t.push(this.__name),t}return [e.getName(),this.__name]}return [this.__name]}setFlag(e){this.__flags|=e;}clearFlag(e){this.__flags&=~e;}testFlag(e){return 0!=(this.__flags&e)}getValue(){}setValue(e){}setEnabled(e){console.warn("Deprecated Method: This method will be removed soon."),e?this.setFlag(K.DISABLED):this.clearFlag(K.DISABLED);}isEnabled(){console.warn("Deprecated Method: This method will be removed soon."),this.testFlag(K.DISABLED);}bindOperator(e){this.__boundOps.push(e),this.__state=z,this.valueChanged.emit(N.OPERATOR_DIRTIED);}unbindOperator(e){const t=this.__boundOps.indexOf(e);if(-1==t)return !1;this.__boundOps.splice(t,1),this.__state=z,this.valueChanged.emit(N.OPERATOR_DIRTIED);}setDirty(e){return -1==this.__cleanerFns.indexOf(e)&&(this.__cleanerFns.push(e),this.__state=z,this.valueChanged.emit(N.OPERATOR_DIRTIED),!0)}setDirtyFromOp(){return this.__state==w&&(this.__state=z,this.valueChanged.emit(N.OPERATOR_DIRTIED)),!0}isDirty(){return this.__state==z}_clean(){this.__state=U;const e=this.__cleanerFns;this.__cleanerFns=[];for(const t of e){const e=t(this.__value);null!=e&&(this.__value=e);}for(const e of this.__boundOps)e.evaluate();this.__state=w;}removeCleanerFn(e){const t=this.__cleanerFns.indexOf(e);if(-1==t)return 0;this.__cleanerFns.splice(t,1);}clone(e){console.error("TOOD: implment me");}destroy(){}}class P extends J{constructor(e,t,a){super(e),this.__value=t,this.__dataType=a||t.constructor.name;}getDataType(){return this.__dataType}getValue(e=Y.NORMAL){return this.__state==z&&this._clean(),this.__value}setClean(e){this.__value=e;}setValue(e,t=N.USER_SETVALUE){this.__cleanerFns.length>0&&(this.__cleanerFns=[]),(e.fromJSON||this.__value!=e)&&(this.__value=e,t!=N.USER_SETVALUE&&t!=N.REMOTEUSER_SETVALUE||this.setFlag(K.USER_EDITED),t!=N.OPERATOR_SETVALUE&&this.valueChanged.emit(t));}setValueDone(){this.valueChanged.emit(N.USER_SETVALUE_DONE);}toJSON(e,t){return this.__value.toJSON?{value:this.__value.toJSON(e,t)}:{value:this.__value}}fromJSON(e,t,a){null!=e.value?(this.setFlag(K.USER_EDITED),e.value.type&&null==this.__value&&(this.__value=C.constructClass(e.value.type)),null!=this.__value&&this.__value.fromJSON?(this.__value.fromJSON(e.value,t),this.valueChanged.emit(N.DATA_LOAD)):this.setValue(e.value,N.DATA_LOAD)):console.warn("Invalid Parameter JSON");}readBinary(e,t){console.error("TODO");}clone(e){const t=this.__value;return t.clone&&(t=t.clone()),new P(this.__name,t,this.__dataType)}}let E=0;class H{constructor(){this.__id=++E,this.__params=[],this.__paramMapping={},this.__paramSignalIds={},this.parameterAdded=new S,this.parameterRemoved=new S,this.parameterValueChanged=new S;}getId(){return this.__id}numParameters(){return this.__params.length}getParameters(){return this.__params}getParameterIndex(e){return this.__paramMapping[e]}getParameterByIndex(e){return this.__params[e]}hasParameter(e){return e in this.__paramMapping}getParameter(e){const t=this.__paramMapping[e];return -1==t?null:this.__params[t]}__parameterValueChanged(e,t){this.parameterValueChanged.emit(e,t);}addParameter(e){const t=e.getName();return null!=this.__paramMapping[t]&&(console.warn("Replacing Parameter:"+t),this.removeParameter(t)),this.__paramSignalIds[t]=e.valueChanged.connect(t=>this.__parameterValueChanged(e,t)),this.__params.push(e),this.__paramMapping[t]=this.__params.length-1,this.parameterAdded.emit(t),e}insertParameter(e,t){const a=e.getName();null!=this.__paramMapping[a]&&(console.warn("Replacing Parameter:"+a),this.removeParameter(a)),this.__paramSignalIds[a]=e.valueChanged.connect(t=>this.__parameterValueChanged(e,t)),this.__params.splice(t,0,e);const i={};for(let e=0;e<this.__params.length;e++)i[this.__params[e].getName()]=e;return this.__paramMapping=i,this.parameterAdded.emit(a),e}removeParameter(e){null==this.__paramMapping[e]&&console.throw("Unable to Remove Parameter:"+e);const t=this.__paramMapping[e];this.__params[this.__paramMapping[e]].valueChanged.disconnectId(this.__paramSignalIds[e]),this.__params.splice(t,1);const a={};for(let e=0;e<this.__params.length;e++)a[this.__params[e].getName()]=e;this.__paramMapping=a,this.parameterRemoved.emit(e);}replaceParameter(e){const t=e.getName(),a=this.__paramMapping[t];return this.__params[this.__paramMapping[t]].valueChanged.disconnectId(this.__paramSignalIds[t]),this.__paramSignalIds[t]=e.valueChanged.connect(t=>this.__parameterValueChanged(e,t)),this.__params[a]=e,e}toJSON(e,t){const a={};let i=0;for(const s of this.__params)if(s.testFlag(K.USER_EDITED))if(s.numRefs()>1&&0!=s.getRefIndex(this))a[s.getName()]={paramPath:e.makeRelative(s.getPath())},i++;else {const n=s.toJSON(e,t);n&&(a[s.getName()]=n,i++);}if(i>0)return {params:a}}fromJSON(e,t,a){if(e.params)for(const a in e.params){const i=e.params[a],s=this.getParameter(a);s?i.paramPath?t.resolvePath(i.paramPath,e=>{this.replaceParameter(e);},e=>{console.warn("Unable to resolve shared parameter:"+i.paramPath);}):s.fromJSON(i,t):console.warn("Param not found:"+a);}}readBinary(e,t){if(t.versions["zea-engine"].greaterOrEqualThan([0,0,3])){const a=e.loadUInt32();for(let i=0;i<a;i++){const a=e.loadStr(),i=e.loadStr();let s=this.getParameter(i);if(!s){if(s=C.constructClass(a,i),!s){console.error("Unable to construct prop:"+i+" of type:"+a);continue}this.addParameter(s);}s.readBinary(e,t);}}}toString(){return JSON.stringify(this.toJSON(),null,2)}copyFrom(e,t){let a=e.numParameters();for(;a--;){const t=e.getParameterByIndex(a),i=this.getParameter(t.getName());i?i.setValue(t.getValue(),N.OPERATOR_SETVALUE):this.addParameter(t.clone());}}destroy(){for(const e of this.__params)e.destroy();super.destroy();}}const k={USER_EDITED:2,IGNORE_BBOX:4,BIN_NODE:8,INVISIBLE:16};let B=0;class D extends H{constructor(e){super(),null==e&&(e=C.getClassName(this)),this.__name=e,this.__path=[e],this.__ownerItem=void 0,this.__flags=0,this.__selectable=!0,this.__selected=!1,this.selectedChanged=new S,this.__metaData={},this.nameChanged=new S,B++;}static getNumBaseItems(){return B}__parameterValueChanged(e,t){super.__parameterValueChanged(e,t),t!=N.USER_SETVALUE&&t!=N.REMOTEUSER_SETVALUE||this.setFlag(k.USER_EDITED);}getName(){return this.__name}setName(e,t=N.USER_SETVALUE){if(this.__name!=e){const a=this.__name;this.__name=e,this.__updatePath(),this.nameChanged.emit(e,a,t);}}__updatePath(){null==this.__ownerItem?this.__path=[this.__name]:(this.__path=this.__ownerItem.getPath().slice(),this.__path.push(this.__name));}getPath(){return this.__path}setFlag(e){this.__flags|=e;}clearFlag(e){this.__flags&=~e;}testFlag(e){return 0!=(this.__flags&e)}resolvePath(e,t){if(t==e.length)return this;if(">"==e[t]&&t==e.length-1)return this.getParameter(e[t+1]);const a=this.getParameter(e[t]);if(a)return a;throw new Error("Invalid path:"+e+" member not found")}getOwner(){return this.__ownerItem}setOwner(e){this.__ownerItem!==e&&(this.__ownerItem=e,this.__updatePath());}getSelectable(){return this.__selectable}setSelectable(e){return this.__selectable!=e&&(this.__selectable=e,!0)}isSelected(){return this.__selected}getSelected(){return this.__selected}setSelected(e){this.__selected=e,this.selectedChanged.emit(this.__selected);}getMetadata(e){return this.__metaData[e]}hasMetadata(e){return e in this.__metaData}setMetadata(e,t){this.__metaData[e]=t;}deleteMetadata(e){delete this.__metaData[e];}toJSON(e,t){let a=super.toJSON(e,t);return !a&&this.testFlag(k.USER_EDITED)&&(a={}),a&&(a.name=this.__name,this.testFlag(k.BIN_NODE)||(a.type=C.getClassName(this))),a}fromJSON(e,t,a){e.name&&(this.__name=e.name),super.fromJSON(e,t,a),this.__flags|=k.USER_EDITED;}readBinary(e,t){e.loadStr();this.setName(e.loadStr()),super.readBinary(e,t);}clone(e){throw new Error(this.constructor.name+" does not implment its clone method")}copyFrom(e,t){super.copyFrom(e,t),this.setName(e.getName());}destroy(){super.destroy();}}const O=function(e){return e.substring(0,e.lastIndexOf("/"))+"/"},Q=function(e,t,a,i,s){const n=new XMLHttpRequest;n.responseType=t;try{n.addEventListener("timeout",(function(t){throw new Error("The request for "+e+" timed out.")})),n.addEventListener("error",(function(t){throw new Error("The request for "+e+": xhr.readyState:"+n.readyState)})),n.addEventListener("abort",(function(t){throw new Error("The request for "+e+": xhr.readyState:"+n.readyState)})),n.addEventListener("loadend",(function(e){200==n.status?a(n):i(n.statusText);})),n.open("GET",e,!0),n.send();}catch(e){i(e);}},A=function(e,t,a,i){Q(e,"text",e=>{t(e.responseText);},t=>{if(null==a)throw new Error("Unable to XHR File:"+e);a(t);});},q=function(e,t,a,i){Q(e,"json",e=>{t(e.response,e);},t=>{if(null==a)throw new Error("Unable to XHR File:"+e);a(t);});},$=function(e,t,a,i){Q(e,"document",e=>{t(e.responseXML);},t=>{if(null==a)throw new Error("Unable to XHR File:"+e);a(t);});},ee=function(e,t,a,i){Q(e,"arraybuffer",e=>{t(e.response);},t=>{if(null==a)throw new Error("Unable to XHR File:"+e);a(t);});},te="[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0),ae=te&&"function"==typeof module.require?module.require:null;function ie(e,t=null,a=!1){const i=te?function(e,t){return Buffer.from(e,"base64").toString(t?"utf16":"utf8")}(e,a):function(e,t){const a=atob(e);if(t){const e=new Uint8Array(a.length);return Array.prototype.forEach.call(e,(e,t,i)=>{i[t]=a.charCodeAt(t);}),String.fromCharCode.apply(null,new Uint16Array(e.buffer))}return a}(e,a),s=i.indexOf("\n",10)+1,n=i.substring(s)+(t?`//# sourceMappingURL=${t}`:"");if(ae){const e=ae("worker_threads").Worker;return function(t){return new e(n,Object.assign({},t,{eval:!0}))}}const l=new Blob([n],{type:"application/javascript"}),r=URL.createObjectURL(l);return function(e){return new Worker(r,e)}}const se=ie("Lyogcm9sbHVwLXBsdWdpbi13ZWItd29ya2VyLWxvYWRlciAqLwpNb2R1bGU9e0VOVklST05NRU5UOiJXT1JLRVIifTtjb25zdCBlPXt9O3ZhciB0Oyh0PWUpLnVucGFja0JyaWRnZT1mdW5jdGlvbihlKXtyZXR1cm4gZnVuY3Rpb24oZSl7dmFyIHQ9e307ZnVuY3Rpb24gcihuKXtpZih0W25dKXJldHVybiB0W25dLmV4cG9ydHM7dmFyIG89dFtuXT17aTpuLGw6ITEsZXhwb3J0czp7fX07cmV0dXJuIGVbbl0uY2FsbChvLmV4cG9ydHMsbyxvLmV4cG9ydHMsciksby5sPSEwLG8uZXhwb3J0c31yZXR1cm4gci5tPWUsci5jPXQsci5kPWZ1bmN0aW9uKGUsdCxuKXtyLm8oZSx0KXx8T2JqZWN0LmRlZmluZVByb3BlcnR5KGUsdCx7ZW51bWVyYWJsZTohMCxnZXQ6bn0pfSxyLnI9ZnVuY3Rpb24oZSl7InVuZGVmaW5lZCIhPXR5cGVvZiBTeW1ib2wmJlN5bWJvbC50b1N0cmluZ1RhZyYmT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsU3ltYm9sLnRvU3RyaW5nVGFnLHt2YWx1ZToiTW9kdWxlIn0pLE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCJfX2VzTW9kdWxlIix7dmFsdWU6ITB9KX0sci50PWZ1bmN0aW9uKGUsdCl7aWYoMSZ0JiYoZT1yKGUpKSw4JnQpcmV0dXJuIGU7aWYoNCZ0JiYib2JqZWN0Ij09dHlwZW9mIGUmJmUmJmUuX19lc01vZHVsZSlyZXR1cm4gZTt2YXIgbj1PYmplY3QuY3JlYXRlKG51bGwpO2lmKHIucihuKSxPYmplY3QuZGVmaW5lUHJvcGVydHkobiwiZGVmYXVsdCIse2VudW1lcmFibGU6ITAsdmFsdWU6ZX0pLDImdCYmInN0cmluZyIhPXR5cGVvZiBlKWZvcih2YXIgbyBpbiBlKXIuZChuLG8sZnVuY3Rpb24odCl7cmV0dXJuIGVbdF19LmJpbmQobnVsbCxvKSk7cmV0dXJuIG59LHIubj1mdW5jdGlvbihlKXt2YXIgdD1lJiZlLl9fZXNNb2R1bGU/ZnVuY3Rpb24oKXtyZXR1cm4gZS5kZWZhdWx0fTpmdW5jdGlvbigpe3JldHVybiBlfTtyZXR1cm4gci5kKHQsImEiLHQpLHR9LHIubz1mdW5jdGlvbihlLHQpe3JldHVybiBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoZSx0KX0sci5wPSIiLHIoci5zPTIpfShbZnVuY3Rpb24oZSx0LHIpe09iamVjdC5kZWZpbmVQcm9wZXJ0eSh0LCJfX2VzTW9kdWxlIix7dmFsdWU6ITB9KTtjb25zdCBvPXIoMSksaT17MDoiRVJBUl9TVUNDRVNTIiwxMDoiRVJBUl9FTkRfQVJDSElWRSIsMTE6IkVSQVJfTk9fTUVNT1JZIiwxMjoiRVJBUl9CQURfREFUQSIsMTM6IkVSQVJfQkFEX0FSQ0hJVkUiLDE0OiJFUkFSX1VOS05PV05fRk9STUFUIiwxNToiRVJBUl9FT1BFTiIsMTY6IkVSQVJfRUNSRUFURSIsMTc6IkVSQVJfRUNMT1NFIiwxODoiRVJBUl9FUkVBRCIsMTk6IkVSQVJfRVdSSVRFIiwyMDoiRVJBUl9TTUFMTF9CVUYiLDIxOiJFUkFSX1VOS05PV04iLDIyOiJFUkFSX01JU1NJTkdfUEFTU1dPUkQiLDIzOiJFUkFSX0VSRUZFUkVOQ0UiLDI0OiJFUkFSX0JBRF9QQVNTV09SRCJ9LGE9ezA6IlN1Y2Nlc3MiLDExOiJOb3QgZW5vdWdoIG1lbW9yeSIsMTI6IkFyY2hpdmUgaGVhZGVyIG9yIGRhdGEgYXJlIGRhbWFnZWQiLDEzOiJGaWxlIGlzIG5vdCBSQVIgYXJjaGl2ZSIsMTQ6IlVua25vd24gYXJjaGl2ZSBmb3JtYXQiLDE1OiJGaWxlIG9wZW4gZXJyb3IiLDE2OiJGaWxlIGNyZWF0ZSBlcnJvciIsMTc6IkZpbGUgY2xvc2UgZXJyb3IiLDE4OiJGaWxlIHJlYWQgZXJyb3IiLDE5OiJGaWxlIHdyaXRlIGVycm9yIiwyMDoiQnVmZmVyIGZvciBhcmNoaXZlIGNvbW1lbnQgaXMgdG9vIHNtYWxsLCBjb21tZW50IHRydW5jYXRlZCIsMjE6IlVua25vd24gZXJyb3IiLDIyOiJQYXNzd29yZCBmb3IgZW5jcnlwdGVkIGZpbGUgb3IgaGVhZGVyIGlzIG5vdCBzcGVjaWZpZWQiLDIzOiJDYW5ub3Qgb3BlbiBmaWxlIHNvdXJjZSBmb3IgcmVmZXJlbmNlIHJlY29yZCIsMjQ6Ildyb25nIHBhc3N3b3JkIGlzIHNwZWNpZmllZCJ9O2NsYXNzIHN7Y29uc3RydWN0b3IoZT0iIil7dGhpcy5fcGFzc3dvcmQ9ZSx0aGlzLl9hcmNoaXZlPW51bGx9Z2V0RmlsZUxpc3QoKXtsZXQgZSxbdCxyXT10aGlzLm9wZW5BcmMoITApO2lmKCJTVUNDRVNTIiE9PXQuc3RhdGUpZT1bdCxudWxsXTtlbHNle2xldCB0LG4sbz1bXTtmb3IoO1t0LG5dPXRoaXMucHJvY2Vzc05leHRGaWxlKCgpPT4hMCksIlNVQ0NFU1MiPT09dC5zdGF0ZTspby5wdXNoKG4uZmlsZUhlYWRlcik7ZT0iRVJBUl9FTkRfQVJDSElWRSIhPT10LnJlYXNvbj9bdCxudWxsXTpbe3N0YXRlOiJTVUNDRVNTIn0se2FyY0hlYWRlcjpyLGZpbGVIZWFkZXJzOm99XX1yZXR1cm4gdGhpcy5jbG9zZUFyYygpLGV9ZXh0cmFjdEFsbCgpe2xldCBlLFt0LHJdPXRoaXMub3BlbkFyYyghMSk7aWYoIlNVQ0NFU1MiIT09dC5zdGF0ZSllPVt0LG51bGxdO2Vsc2V7bGV0IHQsbixvPVtdO2Zvcig7W3Qsbl09dGhpcy5wcm9jZXNzTmV4dEZpbGUoKCk9PiExKSwiU1VDQ0VTUyI9PT10LnN0YXRlOylvLnB1c2gobik7ZT0iRVJBUl9FTkRfQVJDSElWRSIhPT10LnJlYXNvbj9bdCxudWxsXTpbe3N0YXRlOiJTVUNDRVNTIn0se2FyY0hlYWRlcjpyLGZpbGVzOm99XX1yZXR1cm4gdGhpcy5jbG9zZUFyYygpLGV9ZXh0cmFjdEZpbGVzKGUsdCl7bGV0IHIsW24sb109dGhpcy5vcGVuQXJjKCExLHQpLGk9e307Zm9yKGxldCB0PTA7dDxlLmxlbmd0aDsrK3QpaVtlW3RdXT10O2lmKCJTVUNDRVNTIiE9PW4uc3RhdGUpcj1bbixudWxsXTtlbHNle2xldCB0LG4sYT1BcnJheShlLmxlbmd0aCkuZmlsbChudWxsKSxzPTA7Zm9yKDs7KXtsZXQgcj0hMSxvPW51bGw7aWYoW3Qsbl09dGhpcy5wcm9jZXNzTmV4dEZpbGUoZT0+ZSBpbiBpPyhvPWlbZV0sITEpOihyPSEwLCEwKSksIlNVQ0NFU1MiIT09dC5zdGF0ZSlicmVhaztpZighciYmKGFbb109biwrK3M9PT1lLmxlbmd0aCkpe3QucmVhc29uPSJFUkFSX0VORF9BUkNISVZFIjticmVha319cj0iRVJBUl9FTkRfQVJDSElWRSIhPT10LnJlYXNvbj9bdCxudWxsXTpbe3N0YXRlOiJTVUNDRVNTIn0se2FyY0hlYWRlcjpvLGZpbGVzOmF9XX1yZXR1cm4gdGhpcy5jbG9zZUFyYygpLHJ9ZmlsZUNyZWF0ZWQoZSl7fWNsb3NlKGUpe3RoaXMuX2xhc3RGaWxlQ29udGVudD10aGlzLmNsb3NlRmlsZShlKX1vcGVuQXJjKGUsdCl7by5FeHQuY3VycmVudD10aGlzLHRoaXMuX2FyY2hpdmU9bmV3IG4uUmFyQXJjaGl2ZTtsZXQgcixpPXRoaXMuX2FyY2hpdmUub3Blbih0aGlzLl9maWxlUGF0aCx0fHx0aGlzLl9wYXNzd29yZCxlKTtyZXR1cm4gcj0wIT09aS5zdGF0ZS5lcnJDb2RlP1t0aGlzLmdldEZhaWxJbmZvKGkuc3RhdGUuZXJyQ29kZSxpLnN0YXRlLmVyclR5cGUpLG51bGxdOlt7c3RhdGU6IlNVQ0NFU1MifSx7Y29tbWVudDppLmNvbW1lbnQsZmxhZ3M6e3ZvbHVtZTowIT0oMSZpLmZsYWdzKSxsb2NrOjAhPSg0JmkuZmxhZ3MpLHNvbGlkOjAhPSg4JmkuZmxhZ3MpLGF1dGhJbmZvOjAhPSgzMiZpLmZsYWdzKSxyZWNvdmVyeVJlY29yZDowIT0oNjQmaS5mbGFncyksaGVhZGVyRW5jcnlwdGVkOjAhPSgxMjgmaS5mbGFncyl9fV0sby5FeHQuY3VycmVudD1udWxsLHJ9cHJvY2Vzc05leHRGaWxlKGUpe2xldCB0O28uRXh0LmN1cnJlbnQ9dGhpcztsZXQgcj10aGlzLl9hcmNoaXZlLmdldEZpbGVIZWFkZXIoKSxuPVt7c3RhdGU6IlNVQ0NFU1MifSxudWxsXTtpZigwPT09ci5zdGF0ZS5lcnJDb2RlKXtsZXQgdD1lKHIubmFtZSk7dGhpcy5fbGFzdEZpbGVDb250ZW50PW51bGw7bGV0IG89dGhpcy5fYXJjaGl2ZS5yZWFkRmlsZSh0KTswPT09by5lcnJDb2RlfHx0fHwoblswXT10aGlzLmdldEZhaWxJbmZvKG8uZXJyQ29kZSxvLmVyclR5cGUpLDIyPT09by5lcnJDb2RlP289dGhpcy5fYXJjaGl2ZS5yZWFkRmlsZSghMCk6by5lcnJDb2RlPTApLDA9PT1vLmVyckNvZGU/blsxXT10aGlzLl9sYXN0RmlsZUNvbnRlbnQ6KHIuc3RhdGUuZXJyQ29kZT1vLmVyckNvZGUsci5zdGF0ZS5lcnJUeXBlPW8uZXJyVHlwZSksdGhpcy5fbGFzdEZpbGVDb250ZW50PW51bGx9cmV0dXJuIHQ9MCE9PXIuc3RhdGUuZXJyQ29kZT9bdGhpcy5nZXRGYWlsSW5mbyhyLnN0YXRlLmVyckNvZGUsci5zdGF0ZS5lcnJUeXBlKSxudWxsXTpbe3N0YXRlOiJTVUNDRVNTIn0se2ZpbGVIZWFkZXI6e25hbWU6ci5uYW1lLGZsYWdzOntlbmNyeXB0ZWQ6MCE9KDQmci5mbGFncyksc29saWQ6MCE9KDE2JnIuZmxhZ3MpLGRpcmVjdG9yeTowIT0oMzImci5mbGFncyl9LHBhY2tTaXplOnIucGFja1NpemUsdW5wU2l6ZTpyLnVucFNpemUsY3JjOnIuY3JjLHRpbWU6ZnVuY3Rpb24oZSl7Y29uc3QgdD1bNSw2LDUsNSw0LDddO2xldCByPVtdO2ZvcihsZXQgbiBvZiB0KXIucHVzaChlJigxPDxuKS0xKSxlPj49bjtsZXQgbj1lPT5lPDEwPyIwIitlOiIiK2U7cmV0dXJuYCR7MTk4MCsocj1yLnJldmVyc2UoKSlbMF19LSR7bihyWzFdKX0tJHtuKHJbMl0pfWArYFQke24oclszXSl9OiR7bihyWzRdKX06JHtuKDIqcls1XSl9LjAwMGB9KHIudGltZSksdW5wVmVyOmAke01hdGguZmxvb3Ioci51bnBWZXIvMTApfS4ke3IudW5wVmVyJTEwfWAsbWV0aG9kOmZ1bmN0aW9uKGUpe3JldHVybns0ODoiU3RvcmluZyIsNDk6IkZhc3Rlc3QiLDUwOiJGYXN0Iiw1MToiTm9ybWFsIiw1MjoiR29vZCIsNTM6IkJlc3QifVtlXXx8IlVua25vd24ifShyLm1ldGhvZCl9LGV4dHJhY3Q6bn1dLG8uRXh0LmN1cnJlbnQ9bnVsbCx0fWNsb3NlQXJjKCl7by5FeHQuY3VycmVudD10aGlzLHRoaXMuX2FyY2hpdmUuZGVsZXRlKCksby5FeHQuY3VycmVudD1udWxsLHRoaXMuX2FyY2hpdmU9bnVsbH1nZXRGYWlsSW5mbyhlLHQpe3JldHVybntzdGF0ZToiRkFJTCIscmVhc29uOmlbZV0sbXNnOmFbZV19fX1zLl9jdXJyZW50PW51bGwsdC5FeHRyYWN0b3I9c30sZnVuY3Rpb24oZSx0LHIpe09iamVjdC5kZWZpbmVQcm9wZXJ0eSh0LCJfX2VzTW9kdWxlIix7dmFsdWU6ITB9KSx0LkV4dD17Y3VycmVudDpudWxsfX0sZnVuY3Rpb24oZSx0LHIpe09iamVjdC5kZWZpbmVQcm9wZXJ0eSh0LCJfX2VzTW9kdWxlIix7dmFsdWU6ITB9KSxmdW5jdGlvbihlKXtmb3IodmFyIHIgaW4gZSl0Lmhhc093blByb3BlcnR5KHIpfHwodFtyXT1lW3JdKX0ocigzKSk7dmFyIG49cigxKTt0LkV4dD1uLkV4dH0sZnVuY3Rpb24oZSx0LHIpe09iamVjdC5kZWZpbmVQcm9wZXJ0eSh0LCJfX2VzTW9kdWxlIix7dmFsdWU6ITB9KTtjb25zdCBuPXIoNCksbz1yKDYpO3QuY3JlYXRlRXh0cmFjdG9yRnJvbURhdGE9ZnVuY3Rpb24oZSx0PSIiKXtyZXR1cm4gbmV3IG4uRGF0YUV4dHJhY3RvcihlLHQpfSx0LmNyZWF0ZUV4dHJhY3RvckZyb21GaWxlPWZ1bmN0aW9uKGUsdD0iIixyPSIiKXtyZXR1cm4gbmV3IG8uRmlsZUV4dHJhY3RvcihlLHQscil9fSxmdW5jdGlvbihlLHQscil7T2JqZWN0LmRlZmluZVByb3BlcnR5KHQsIl9fZXNNb2R1bGUiLHt2YWx1ZTohMH0pO2NvbnN0IG89cig1KSxpPXIoMCk7dC5EYXRhRXh0cmFjdG9yPWNsYXNzIGV4dGVuZHMgaS5FeHRyYWN0b3J7Y29uc3RydWN0b3IoZSx0KXtzdXBlcih0KSx0aGlzLmRhdGFGaWxlcz17fSx0aGlzLmRhdGFGaWxlTWFwPXt9LHRoaXMuY3VycmVudEZkPTE7bGV0IHI9e2ZpbGU6bmV3IG8uRGF0YUZpbGUobmV3IFVpbnQ4QXJyYXkoZSkpLGZkOnRoaXMuY3VycmVudEZkKyt9O3RoaXMuX2ZpbGVQYXRoPSJfZGVmYXVsdFVucmFySlNfLnJhciIsdGhpcy5kYXRhRmlsZXNbdGhpcy5fZmlsZVBhdGhdPXIsdGhpcy5kYXRhRmlsZU1hcFtyLmZkXT10aGlzLl9maWxlUGF0aH1vcGVuKGUpe2xldCB0PXRoaXMuZGF0YUZpbGVzW2VdO3JldHVybiB0P3QuZmQ6MH1jcmVhdGUoZSl7bGV0IHQ9dGhpcy5jdXJyZW50RmQrKztyZXR1cm4gdGhpcy5kYXRhRmlsZXNbZV09e2ZpbGU6bmV3IG8uRGF0YUZpbGUsZmQ6dGhpcy5jdXJyZW50RmQrK30sdGhpcy5kYXRhRmlsZU1hcFt0XT1lLHR9Y2xvc2VGaWxlKGUpe2xldCB0PXRoaXMuZGF0YUZpbGVzW3RoaXMuZGF0YUZpbGVNYXBbZV1dO2lmKCF0KXJldHVybiBudWxsO2xldCByPXQuZmlsZS5yZWFkQWxsKCk7cmV0dXJuIDEhPT1lPyhkZWxldGUgdGhpcy5kYXRhRmlsZXNbdGhpcy5kYXRhRmlsZU1hcFtlXV0sZGVsZXRlIHRoaXMuZGF0YUZpbGVNYXBbZV0pOnQuZmlsZS5zZWVrKDAsIlNFVCIpLHJ9cmVhZChlLHQscil7bGV0IG89dGhpcy5kYXRhRmlsZXNbdGhpcy5kYXRhRmlsZU1hcFtlXV07aWYoIW8pcmV0dXJuLTE7bGV0IGk9by5maWxlLnJlYWQocik7cmV0dXJuIG51bGw9PT1pPy0xOihuLkhFQVBVOC5zZXQoaSx0KSxpLmJ5dGVMZW5ndGgpfXdyaXRlKGUsdCxyKXtsZXQgbz10aGlzLmRhdGFGaWxlc1t0aGlzLmRhdGFGaWxlTWFwW2VdXTtyZXR1cm4hIW8mJihvLmZpbGUud3JpdGUobi5IRUFQVTguc2xpY2UodCx0K3IpKSwhMCl9dGVsbChlKXtsZXQgdD10aGlzLmRhdGFGaWxlc1t0aGlzLmRhdGFGaWxlTWFwW2VdXTtyZXR1cm4gdD90LmZpbGUudGVsbCgpOi0xfXNlZWsoZSx0LHIpe2xldCBuPXRoaXMuZGF0YUZpbGVzW3RoaXMuZGF0YUZpbGVNYXBbZV1dO3JldHVybiEhbiYmbi5maWxlLnNlZWsodCxyKX19fSxmdW5jdGlvbihlLHQscil7T2JqZWN0LmRlZmluZVByb3BlcnR5KHQsIl9fZXNNb2R1bGUiLHt2YWx1ZTohMH0pLHQuRGF0YUZpbGU9Y2xhc3N7Y29uc3RydWN0b3IoZSl7dGhpcy5idWZmZXJzPVtdLHRoaXMucG9zPTAsdGhpcy5zaXplPTAsZSYmKHRoaXMuYnVmZmVycy5wdXNoKGUpLHRoaXMuc2l6ZT1lLmJ5dGVMZW5ndGgsdGhpcy5wb3M9MCl9cmVhZChlKXtpZih0aGlzLmZsYXR0ZW4oKSxlK3RoaXMucG9zPnRoaXMuc2l6ZSlyZXR1cm4gbnVsbDtsZXQgdD10aGlzLnBvcztyZXR1cm4gdGhpcy5wb3MrPWUsdGhpcy5idWZmZXJzWzBdLnNsaWNlKHQsdGhpcy5wb3MpfXJlYWRBbGwoKXtyZXR1cm4gdGhpcy5mbGF0dGVuKCksdGhpcy5idWZmZXJzWzBdfXdyaXRlKGUpe3JldHVybiB0aGlzLmJ1ZmZlcnMucHVzaChlKSx0aGlzLnNpemUrPWUuYnl0ZUxlbmd0aCx0aGlzLnBvcys9ZS5ieXRlTGVuZ3RoLCEwfXRlbGwoKXtyZXR1cm4gdGhpcy5wb3N9c2VlayhlLHQpe2xldCByPXRoaXMucG9zO3JldHVybiJTRVQiPT09dD9yPWU6IkNVUiI9PT10P3IrPWU6cj10aGlzLnNpemUtZSwhKHI8MHx8cj50aGlzLnNpemV8fCh0aGlzLnBvcz1yLDApKX1mbGF0dGVuKCl7aWYodGhpcy5idWZmZXJzLmxlbmd0aDw9MSlyZXR1cm47bGV0IGU9bmV3IFVpbnQ4QXJyYXkodGhpcy5zaXplKSx0PTA7Zm9yKGxldCByIG9mIHRoaXMuYnVmZmVycyllLnNldChyLHQpLHQrPXIuYnl0ZUxlbmd0aDt0aGlzLmJ1ZmZlcnM9W2VdfX19LGZ1bmN0aW9uKGUsdCxyKXsoZnVuY3Rpb24oZSl7T2JqZWN0LmRlZmluZVByb3BlcnR5KHQsIl9fZXNNb2R1bGUiLHt2YWx1ZTohMH0pO2NvbnN0IG89cigxMiksaT1yKDEzKSxhPXIoMCk7dC5GaWxlRXh0cmFjdG9yPWNsYXNzIGV4dGVuZHMgYS5FeHRyYWN0b3J7Y29uc3RydWN0b3IoZSx0LHIpe3N1cGVyKHIpLHRoaXMuX2ZpbGVQYXRoPWUsdGhpcy5maWxlTWFwPXt9LHRoaXMuX3RhcmdldD10fW9wZW4oZSl7bGV0IHQ9by5vcGVuU3luYyhlLCJyIik7cmV0dXJuIHRoaXMuZmlsZU1hcFt0XT17c2l6ZTpvLmZzdGF0U3luYyh0KS5zaXplLHBvczowLG5hbWU6ZX0sdH1jcmVhdGUoZSl7bGV0IHQ9aS5qb2luKHRoaXMuX3RhcmdldCxlKTtpLnBhcnNlKHQpLmRpci5zcGxpdCgiLyIpLnJlZHVjZSgoZSx0KT0+KGUrPXQrIi8iLG8uZXhpc3RzU3luYyhlKXx8by5ta2RpclN5bmMoZSksZSksIiIpO2xldCByPW8ub3BlblN5bmModCwidyIpO3JldHVybiB0aGlzLmZpbGVNYXBbcl09e3NpemU6MCxwb3M6MCxuYW1lOmV9LHJ9Y2xvc2VGaWxlKGUpe3JldHVybiBkZWxldGUgdGhpcy5maWxlTWFwW2VdLG8uY2xvc2VTeW5jKGUpLG51bGx9cmVhZCh0LHIsaSl7bGV0IGE9dGhpcy5maWxlTWFwW3RdLHM9bmV3IGUoaSksdT1vLnJlYWRTeW5jKHQscywwLGksYS5wb3MpO3JldHVybiBuLkhFQVBVOC5zZXQocyxyKSxhLnBvcys9dSx1fXdyaXRlKHQscixpKXtsZXQgYT10aGlzLmZpbGVNYXBbdF0scz1vLndyaXRlU3luYyh0LG5ldyBlKG4uSEVBUFU4LnN1YmFycmF5KHIscitpKSksMCxpKTtyZXR1cm4gYS5wb3MrPXMsYS5zaXplKz1zLHM9PT1pfXRlbGwoZSl7cmV0dXJuIHRoaXMuZmlsZU1hcFtlXS5wb3N9c2VlayhlLHQscil7bGV0IG49dGhpcy5maWxlTWFwW2VdLG89bi5wb3M7cmV0dXJuIlNFVCI9PT1yP289MDoiRU5EIj09PXImJihvPW4uc2l6ZSksISgobys9dCk8MHx8bz5uLnNpemV8fChuLnBvcz1vLDApKX19fSkuY2FsbCh0aGlzLHIoNykuQnVmZmVyKX0sZnVuY3Rpb24oZSx0LHIpeyhmdW5jdGlvbihlKXsKLyohCiAqIFRoZSBidWZmZXIgbW9kdWxlIGZyb20gbm9kZS5qcywgZm9yIHRoZSBicm93c2VyLgogKgogKiBAYXV0aG9yICAgRmVyb3NzIEFib3VraGFkaWplaCA8ZmVyb3NzQGZlcm9zcy5vcmc+IDxodHRwOi8vZmVyb3NzLm9yZz4KICogQGxpY2Vuc2UgIE1JVAogKi8KdmFyIG49cig5KSxvPXIoMTApLGk9cigxMSk7ZnVuY3Rpb24gYSgpe3JldHVybiB1LlRZUEVEX0FSUkFZX1NVUFBPUlQ/MjE0NzQ4MzY0NzoxMDczNzQxODIzfWZ1bmN0aW9uIHMoZSx0KXtpZihhKCk8dCl0aHJvdyBuZXcgUmFuZ2VFcnJvcigiSW52YWxpZCB0eXBlZCBhcnJheSBsZW5ndGgiKTtyZXR1cm4gdS5UWVBFRF9BUlJBWV9TVVBQT1JUPyhlPW5ldyBVaW50OEFycmF5KHQpKS5fX3Byb3RvX189dS5wcm90b3R5cGU6KG51bGw9PT1lJiYoZT1uZXcgdSh0KSksZS5sZW5ndGg9dCksZX1mdW5jdGlvbiB1KGUsdCxyKXtpZighKHUuVFlQRURfQVJSQVlfU1VQUE9SVHx8dGhpcyBpbnN0YW5jZW9mIHUpKXJldHVybiBuZXcgdShlLHQscik7aWYoIm51bWJlciI9PXR5cGVvZiBlKXtpZigic3RyaW5nIj09dHlwZW9mIHQpdGhyb3cgbmV3IEVycm9yKCJJZiBlbmNvZGluZyBpcyBzcGVjaWZpZWQgdGhlbiB0aGUgZmlyc3QgYXJndW1lbnQgbXVzdCBiZSBhIHN0cmluZyIpO3JldHVybiBmKHRoaXMsZSl9cmV0dXJuIGModGhpcyxlLHQscil9ZnVuY3Rpb24gYyhlLHQscixuKXtpZigibnVtYmVyIj09dHlwZW9mIHQpdGhyb3cgbmV3IFR5cGVFcnJvcignInZhbHVlIiBhcmd1bWVudCBtdXN0IG5vdCBiZSBhIG51bWJlcicpO3JldHVybiJ1bmRlZmluZWQiIT10eXBlb2YgQXJyYXlCdWZmZXImJnQgaW5zdGFuY2VvZiBBcnJheUJ1ZmZlcj9mdW5jdGlvbihlLHQscixuKXtpZih0LmJ5dGVMZW5ndGgscjwwfHx0LmJ5dGVMZW5ndGg8cil0aHJvdyBuZXcgUmFuZ2VFcnJvcigiJ29mZnNldCcgaXMgb3V0IG9mIGJvdW5kcyIpO2lmKHQuYnl0ZUxlbmd0aDxyKyhufHwwKSl0aHJvdyBuZXcgUmFuZ2VFcnJvcigiJ2xlbmd0aCcgaXMgb3V0IG9mIGJvdW5kcyIpO3JldHVybiB0PXZvaWQgMD09PXImJnZvaWQgMD09PW4/bmV3IFVpbnQ4QXJyYXkodCk6dm9pZCAwPT09bj9uZXcgVWludDhBcnJheSh0LHIpOm5ldyBVaW50OEFycmF5KHQscixuKSx1LlRZUEVEX0FSUkFZX1NVUFBPUlQ/KGU9dCkuX19wcm90b19fPXUucHJvdG90eXBlOmU9ZChlLHQpLGV9KGUsdCxyLG4pOiJzdHJpbmciPT10eXBlb2YgdD9mdW5jdGlvbihlLHQscil7aWYoInN0cmluZyI9PXR5cGVvZiByJiYiIiE9PXJ8fChyPSJ1dGY4IiksIXUuaXNFbmNvZGluZyhyKSl0aHJvdyBuZXcgVHlwZUVycm9yKCciZW5jb2RpbmciIG11c3QgYmUgYSB2YWxpZCBzdHJpbmcgZW5jb2RpbmcnKTt2YXIgbj0wfHAodCxyKSxvPShlPXMoZSxuKSkud3JpdGUodCxyKTtyZXR1cm4gbyE9PW4mJihlPWUuc2xpY2UoMCxvKSksZX0oZSx0LHIpOmZ1bmN0aW9uKGUsdCl7aWYodS5pc0J1ZmZlcih0KSl7dmFyIHI9MHxoKHQubGVuZ3RoKTtyZXR1cm4gMD09PShlPXMoZSxyKSkubGVuZ3RofHx0LmNvcHkoZSwwLDAsciksZX1pZih0KXtpZigidW5kZWZpbmVkIiE9dHlwZW9mIEFycmF5QnVmZmVyJiZ0LmJ1ZmZlciBpbnN0YW5jZW9mIEFycmF5QnVmZmVyfHwibGVuZ3RoImluIHQpcmV0dXJuIm51bWJlciIhPXR5cGVvZiB0Lmxlbmd0aHx8ZnVuY3Rpb24oZSl7cmV0dXJuIGUhPWV9KHQubGVuZ3RoKT9zKGUsMCk6ZChlLHQpO2lmKCJCdWZmZXIiPT09dC50eXBlJiZpKHQuZGF0YSkpcmV0dXJuIGQoZSx0LmRhdGEpfXRocm93IG5ldyBUeXBlRXJyb3IoIkZpcnN0IGFyZ3VtZW50IG11c3QgYmUgYSBzdHJpbmcsIEJ1ZmZlciwgQXJyYXlCdWZmZXIsIEFycmF5LCBvciBhcnJheS1saWtlIG9iamVjdC4iKX0oZSx0KX1mdW5jdGlvbiBsKGUpe2lmKCJudW1iZXIiIT10eXBlb2YgZSl0aHJvdyBuZXcgVHlwZUVycm9yKCcic2l6ZSIgYXJndW1lbnQgbXVzdCBiZSBhIG51bWJlcicpO2lmKGU8MCl0aHJvdyBuZXcgUmFuZ2VFcnJvcignInNpemUiIGFyZ3VtZW50IG11c3Qgbm90IGJlIG5lZ2F0aXZlJyl9ZnVuY3Rpb24gZihlLHQpe2lmKGwodCksZT1zKGUsdDwwPzA6MHxoKHQpKSwhdS5UWVBFRF9BUlJBWV9TVVBQT1JUKWZvcih2YXIgcj0wO3I8dDsrK3IpZVtyXT0wO3JldHVybiBlfWZ1bmN0aW9uIGQoZSx0KXt2YXIgcj10Lmxlbmd0aDwwPzA6MHxoKHQubGVuZ3RoKTtlPXMoZSxyKTtmb3IodmFyIG49MDtuPHI7bis9MSllW25dPTI1NSZ0W25dO3JldHVybiBlfWZ1bmN0aW9uIGgoZSl7aWYoZT49YSgpKXRocm93IG5ldyBSYW5nZUVycm9yKCJBdHRlbXB0IHRvIGFsbG9jYXRlIEJ1ZmZlciBsYXJnZXIgdGhhbiBtYXhpbXVtIHNpemU6IDB4IithKCkudG9TdHJpbmcoMTYpKyIgYnl0ZXMiKTtyZXR1cm4gMHxlfWZ1bmN0aW9uIHAoZSx0KXtpZih1LmlzQnVmZmVyKGUpKXJldHVybiBlLmxlbmd0aDtpZigidW5kZWZpbmVkIiE9dHlwZW9mIEFycmF5QnVmZmVyJiYiZnVuY3Rpb24iPT10eXBlb2YgQXJyYXlCdWZmZXIuaXNWaWV3JiYoQXJyYXlCdWZmZXIuaXNWaWV3KGUpfHxlIGluc3RhbmNlb2YgQXJyYXlCdWZmZXIpKXJldHVybiBlLmJ5dGVMZW5ndGg7InN0cmluZyIhPXR5cGVvZiBlJiYoZT0iIitlKTt2YXIgcj1lLmxlbmd0aDtpZigwPT09cilyZXR1cm4gMDtmb3IodmFyIG49ITE7Oylzd2l0Y2godCl7Y2FzZSJhc2NpaSI6Y2FzZSJsYXRpbjEiOmNhc2UiYmluYXJ5IjpyZXR1cm4gcjtjYXNlInV0ZjgiOmNhc2UidXRmLTgiOmNhc2Ugdm9pZCAwOnJldHVybiBVKGUpLmxlbmd0aDtjYXNlInVjczIiOmNhc2UidWNzLTIiOmNhc2UidXRmMTZsZSI6Y2FzZSJ1dGYtMTZsZSI6cmV0dXJuIDIqcjtjYXNlImhleCI6cmV0dXJuIHI+Pj4xO2Nhc2UiYmFzZTY0IjpyZXR1cm4geihlKS5sZW5ndGg7ZGVmYXVsdDppZihuKXJldHVybiBVKGUpLmxlbmd0aDt0PSgiIit0KS50b0xvd2VyQ2FzZSgpLG49ITB9fWZ1bmN0aW9uIG0oZSx0LHIpe3ZhciBuPWVbdF07ZVt0XT1lW3JdLGVbcl09bn1mdW5jdGlvbiB5KGUsdCxyLG4sbyl7aWYoMD09PWUubGVuZ3RoKXJldHVybi0xO2lmKCJzdHJpbmciPT10eXBlb2Ygcj8obj1yLHI9MCk6cj4yMTQ3NDgzNjQ3P3I9MjE0NzQ4MzY0NzpyPC0yMTQ3NDgzNjQ4JiYocj0tMjE0NzQ4MzY0OCkscj0rcixpc05hTihyKSYmKHI9bz8wOmUubGVuZ3RoLTEpLHI8MCYmKHI9ZS5sZW5ndGgrcikscj49ZS5sZW5ndGgpe2lmKG8pcmV0dXJuLTE7cj1lLmxlbmd0aC0xfWVsc2UgaWYocjwwKXtpZighbylyZXR1cm4tMTtyPTB9aWYoInN0cmluZyI9PXR5cGVvZiB0JiYodD11LmZyb20odCxuKSksdS5pc0J1ZmZlcih0KSlyZXR1cm4gMD09PXQubGVuZ3RoPy0xOkUoZSx0LHIsbixvKTtpZigibnVtYmVyIj09dHlwZW9mIHQpcmV0dXJuIHQmPTI1NSx1LlRZUEVEX0FSUkFZX1NVUFBPUlQmJiJmdW5jdGlvbiI9PXR5cGVvZiBVaW50OEFycmF5LnByb3RvdHlwZS5pbmRleE9mP28/VWludDhBcnJheS5wcm90b3R5cGUuaW5kZXhPZi5jYWxsKGUsdCxyKTpVaW50OEFycmF5LnByb3RvdHlwZS5sYXN0SW5kZXhPZi5jYWxsKGUsdCxyKTpFKGUsW3RdLHIsbixvKTt0aHJvdyBuZXcgVHlwZUVycm9yKCJ2YWwgbXVzdCBiZSBzdHJpbmcsIG51bWJlciBvciBCdWZmZXIiKX1mdW5jdGlvbiBFKGUsdCxyLG4sbyl7dmFyIGksYT0xLHM9ZS5sZW5ndGgsdT10Lmxlbmd0aDtpZih2b2lkIDAhPT1uJiYoInVjczIiPT09KG49U3RyaW5nKG4pLnRvTG93ZXJDYXNlKCkpfHwidWNzLTIiPT09bnx8InV0ZjE2bGUiPT09bnx8InV0Zi0xNmxlIj09PW4pKXtpZihlLmxlbmd0aDwyfHx0Lmxlbmd0aDwyKXJldHVybi0xO2E9MixzLz0yLHUvPTIsci89Mn1mdW5jdGlvbiBjKGUsdCl7cmV0dXJuIDE9PT1hP2VbdF06ZS5yZWFkVUludDE2QkUodCphKX1pZihvKXt2YXIgbD0tMTtmb3IoaT1yO2k8cztpKyspaWYoYyhlLGkpPT09Yyh0LC0xPT09bD8wOmktbCkpe2lmKC0xPT09bCYmKGw9aSksaS1sKzE9PT11KXJldHVybiBsKmF9ZWxzZS0xIT09bCYmKGktPWktbCksbD0tMX1lbHNlIGZvcihyK3U+cyYmKHI9cy11KSxpPXI7aT49MDtpLS0pe2Zvcih2YXIgZj0hMCxkPTA7ZDx1O2QrKylpZihjKGUsaStkKSE9PWModCxkKSl7Zj0hMTticmVha31pZihmKXJldHVybiBpfXJldHVybi0xfWZ1bmN0aW9uIGcoZSx0LHIsbil7cj1OdW1iZXIocil8fDA7dmFyIG89ZS5sZW5ndGgtcjtuPyhuPU51bWJlcihuKSk+byYmKG49byk6bj1vO3ZhciBpPXQubGVuZ3RoO2lmKGklMiE9MCl0aHJvdyBuZXcgVHlwZUVycm9yKCJJbnZhbGlkIGhleCBzdHJpbmciKTtuPmkvMiYmKG49aS8yKTtmb3IodmFyIGE9MDthPG47KythKXt2YXIgcz1wYXJzZUludCh0LnN1YnN0cigyKmEsMiksMTYpO2lmKGlzTmFOKHMpKXJldHVybiBhO2VbcithXT1zfXJldHVybiBhfWZ1bmN0aW9uIHYoZSx0LHIsbil7cmV0dXJuICQoVSh0LGUubGVuZ3RoLXIpLGUscixuKX1mdW5jdGlvbiB3KGUsdCxyLG4pe3JldHVybiAkKGZ1bmN0aW9uKGUpe2Zvcih2YXIgdD1bXSxyPTA7cjxlLmxlbmd0aDsrK3IpdC5wdXNoKDI1NSZlLmNoYXJDb2RlQXQocikpO3JldHVybiB0fSh0KSxlLHIsbil9ZnVuY3Rpb24gXyhlLHQscixuKXtyZXR1cm4gdyhlLHQscixuKX1mdW5jdGlvbiBiKGUsdCxyLG4pe3JldHVybiAkKHoodCksZSxyLG4pfWZ1bmN0aW9uIEEoZSx0LHIsbil7cmV0dXJuICQoZnVuY3Rpb24oZSx0KXtmb3IodmFyIHIsbixvLGk9W10sYT0wO2E8ZS5sZW5ndGgmJiEoKHQtPTIpPDApOysrYSluPShyPWUuY2hhckNvZGVBdChhKSk+Pjgsbz1yJTI1NixpLnB1c2gobyksaS5wdXNoKG4pO3JldHVybiBpfSh0LGUubGVuZ3RoLXIpLGUscixuKX1mdW5jdGlvbiBUKGUsdCxyKXtyZXR1cm4gMD09PXQmJnI9PT1lLmxlbmd0aD9uLmZyb21CeXRlQXJyYXkoZSk6bi5mcm9tQnl0ZUFycmF5KGUuc2xpY2UodCxyKSl9ZnVuY3Rpb24gUyhlLHQscil7cj1NYXRoLm1pbihlLmxlbmd0aCxyKTtmb3IodmFyIG49W10sbz10O288cjspe3ZhciBpLGEscyx1LGM9ZVtvXSxsPW51bGwsZj1jPjIzOT80OmM+MjIzPzM6Yz4xOTE/MjoxO2lmKG8rZjw9cilzd2l0Y2goZil7Y2FzZSAxOmM8MTI4JiYobD1jKTticmVhaztjYXNlIDI6MTI4PT0oMTkyJihpPWVbbysxXSkpJiYodT0oMzEmYyk8PDZ8NjMmaSk+MTI3JiYobD11KTticmVhaztjYXNlIDM6aT1lW28rMV0sYT1lW28rMl0sMTI4PT0oMTkyJmkpJiYxMjg9PSgxOTImYSkmJih1PSgxNSZjKTw8MTJ8KDYzJmkpPDw2fDYzJmEpPjIwNDcmJih1PDU1Mjk2fHx1PjU3MzQzKSYmKGw9dSk7YnJlYWs7Y2FzZSA0Omk9ZVtvKzFdLGE9ZVtvKzJdLHM9ZVtvKzNdLDEyOD09KDE5MiZpKSYmMTI4PT0oMTkyJmEpJiYxMjg9PSgxOTImcykmJih1PSgxNSZjKTw8MTh8KDYzJmkpPDwxMnwoNjMmYSk8PDZ8NjMmcyk+NjU1MzUmJnU8MTExNDExMiYmKGw9dSl9bnVsbD09PWw/KGw9NjU1MzMsZj0xKTpsPjY1NTM1JiYobC09NjU1MzYsbi5wdXNoKGw+Pj4xMCYxMDIzfDU1Mjk2KSxsPTU2MzIwfDEwMjMmbCksbi5wdXNoKGwpLG8rPWZ9cmV0dXJuIGZ1bmN0aW9uKGUpe3ZhciB0PWUubGVuZ3RoO2lmKHQ8PWspcmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUuYXBwbHkoU3RyaW5nLGUpO2Zvcih2YXIgcj0iIixuPTA7bjx0OylyKz1TdHJpbmcuZnJvbUNoYXJDb2RlLmFwcGx5KFN0cmluZyxlLnNsaWNlKG4sbis9aykpO3JldHVybiByfShuKX10LkJ1ZmZlcj11LHQuU2xvd0J1ZmZlcj1mdW5jdGlvbihlKXtyZXR1cm4rZSE9ZSYmKGU9MCksdS5hbGxvYygrZSl9LHQuSU5TUEVDVF9NQVhfQllURVM9NTAsdS5UWVBFRF9BUlJBWV9TVVBQT1JUPXZvaWQgMCE9PWUuVFlQRURfQVJSQVlfU1VQUE9SVD9lLlRZUEVEX0FSUkFZX1NVUFBPUlQ6ZnVuY3Rpb24oKXt0cnl7dmFyIGU9bmV3IFVpbnQ4QXJyYXkoMSk7cmV0dXJuIGUuX19wcm90b19fPXtfX3Byb3RvX186VWludDhBcnJheS5wcm90b3R5cGUsZm9vOmZ1bmN0aW9uKCl7cmV0dXJuIDQyfX0sNDI9PT1lLmZvbygpJiYiZnVuY3Rpb24iPT10eXBlb2YgZS5zdWJhcnJheSYmMD09PWUuc3ViYXJyYXkoMSwxKS5ieXRlTGVuZ3RofWNhdGNoKGUpe3JldHVybiExfX0oKSx0LmtNYXhMZW5ndGg9YSgpLHUucG9vbFNpemU9ODE5Mix1Ll9hdWdtZW50PWZ1bmN0aW9uKGUpe3JldHVybiBlLl9fcHJvdG9fXz11LnByb3RvdHlwZSxlfSx1LmZyb209ZnVuY3Rpb24oZSx0LHIpe3JldHVybiBjKG51bGwsZSx0LHIpfSx1LlRZUEVEX0FSUkFZX1NVUFBPUlQmJih1LnByb3RvdHlwZS5fX3Byb3RvX189VWludDhBcnJheS5wcm90b3R5cGUsdS5fX3Byb3RvX189VWludDhBcnJheSwidW5kZWZpbmVkIiE9dHlwZW9mIFN5bWJvbCYmU3ltYm9sLnNwZWNpZXMmJnVbU3ltYm9sLnNwZWNpZXNdPT09dSYmT2JqZWN0LmRlZmluZVByb3BlcnR5KHUsU3ltYm9sLnNwZWNpZXMse3ZhbHVlOm51bGwsY29uZmlndXJhYmxlOiEwfSkpLHUuYWxsb2M9ZnVuY3Rpb24oZSx0LHIpe3JldHVybiBmdW5jdGlvbihlLHQscixuKXtyZXR1cm4gbCh0KSx0PD0wP3MoZSx0KTp2b2lkIDAhPT1yPyJzdHJpbmciPT10eXBlb2Ygbj9zKGUsdCkuZmlsbChyLG4pOnMoZSx0KS5maWxsKHIpOnMoZSx0KX0obnVsbCxlLHQscil9LHUuYWxsb2NVbnNhZmU9ZnVuY3Rpb24oZSl7cmV0dXJuIGYobnVsbCxlKX0sdS5hbGxvY1Vuc2FmZVNsb3c9ZnVuY3Rpb24oZSl7cmV0dXJuIGYobnVsbCxlKX0sdS5pc0J1ZmZlcj1mdW5jdGlvbihlKXtyZXR1cm4hKG51bGw9PWV8fCFlLl9pc0J1ZmZlcil9LHUuY29tcGFyZT1mdW5jdGlvbihlLHQpe2lmKCF1LmlzQnVmZmVyKGUpfHwhdS5pc0J1ZmZlcih0KSl0aHJvdyBuZXcgVHlwZUVycm9yKCJBcmd1bWVudHMgbXVzdCBiZSBCdWZmZXJzIik7aWYoZT09PXQpcmV0dXJuIDA7Zm9yKHZhciByPWUubGVuZ3RoLG49dC5sZW5ndGgsbz0wLGk9TWF0aC5taW4ocixuKTtvPGk7KytvKWlmKGVbb10hPT10W29dKXtyPWVbb10sbj10W29dO2JyZWFrfXJldHVybiByPG4/LTE6bjxyPzE6MH0sdS5pc0VuY29kaW5nPWZ1bmN0aW9uKGUpe3N3aXRjaChTdHJpbmcoZSkudG9Mb3dlckNhc2UoKSl7Y2FzZSJoZXgiOmNhc2UidXRmOCI6Y2FzZSJ1dGYtOCI6Y2FzZSJhc2NpaSI6Y2FzZSJsYXRpbjEiOmNhc2UiYmluYXJ5IjpjYXNlImJhc2U2NCI6Y2FzZSJ1Y3MyIjpjYXNlInVjcy0yIjpjYXNlInV0ZjE2bGUiOmNhc2UidXRmLTE2bGUiOnJldHVybiEwO2RlZmF1bHQ6cmV0dXJuITF9fSx1LmNvbmNhdD1mdW5jdGlvbihlLHQpe2lmKCFpKGUpKXRocm93IG5ldyBUeXBlRXJyb3IoJyJsaXN0IiBhcmd1bWVudCBtdXN0IGJlIGFuIEFycmF5IG9mIEJ1ZmZlcnMnKTtpZigwPT09ZS5sZW5ndGgpcmV0dXJuIHUuYWxsb2MoMCk7dmFyIHI7aWYodm9pZCAwPT09dClmb3IodD0wLHI9MDtyPGUubGVuZ3RoOysrcil0Kz1lW3JdLmxlbmd0aDt2YXIgbj11LmFsbG9jVW5zYWZlKHQpLG89MDtmb3Iocj0wO3I8ZS5sZW5ndGg7KytyKXt2YXIgYT1lW3JdO2lmKCF1LmlzQnVmZmVyKGEpKXRocm93IG5ldyBUeXBlRXJyb3IoJyJsaXN0IiBhcmd1bWVudCBtdXN0IGJlIGFuIEFycmF5IG9mIEJ1ZmZlcnMnKTthLmNvcHkobixvKSxvKz1hLmxlbmd0aH1yZXR1cm4gbn0sdS5ieXRlTGVuZ3RoPXAsdS5wcm90b3R5cGUuX2lzQnVmZmVyPSEwLHUucHJvdG90eXBlLnN3YXAxNj1mdW5jdGlvbigpe3ZhciBlPXRoaXMubGVuZ3RoO2lmKGUlMiE9MCl0aHJvdyBuZXcgUmFuZ2VFcnJvcigiQnVmZmVyIHNpemUgbXVzdCBiZSBhIG11bHRpcGxlIG9mIDE2LWJpdHMiKTtmb3IodmFyIHQ9MDt0PGU7dCs9MiltKHRoaXMsdCx0KzEpO3JldHVybiB0aGlzfSx1LnByb3RvdHlwZS5zd2FwMzI9ZnVuY3Rpb24oKXt2YXIgZT10aGlzLmxlbmd0aDtpZihlJTQhPTApdGhyb3cgbmV3IFJhbmdlRXJyb3IoIkJ1ZmZlciBzaXplIG11c3QgYmUgYSBtdWx0aXBsZSBvZiAzMi1iaXRzIik7Zm9yKHZhciB0PTA7dDxlO3QrPTQpbSh0aGlzLHQsdCszKSxtKHRoaXMsdCsxLHQrMik7cmV0dXJuIHRoaXN9LHUucHJvdG90eXBlLnN3YXA2ND1mdW5jdGlvbigpe3ZhciBlPXRoaXMubGVuZ3RoO2lmKGUlOCE9MCl0aHJvdyBuZXcgUmFuZ2VFcnJvcigiQnVmZmVyIHNpemUgbXVzdCBiZSBhIG11bHRpcGxlIG9mIDY0LWJpdHMiKTtmb3IodmFyIHQ9MDt0PGU7dCs9OCltKHRoaXMsdCx0KzcpLG0odGhpcyx0KzEsdCs2KSxtKHRoaXMsdCsyLHQrNSksbSh0aGlzLHQrMyx0KzQpO3JldHVybiB0aGlzfSx1LnByb3RvdHlwZS50b1N0cmluZz1mdW5jdGlvbigpe3ZhciBlPTB8dGhpcy5sZW5ndGg7cmV0dXJuIDA9PT1lPyIiOjA9PT1hcmd1bWVudHMubGVuZ3RoP1ModGhpcywwLGUpOmZ1bmN0aW9uKGUsdCxyKXt2YXIgbj0hMTtpZigodm9pZCAwPT09dHx8dDwwKSYmKHQ9MCksdD50aGlzLmxlbmd0aClyZXR1cm4iIjtpZigodm9pZCAwPT09cnx8cj50aGlzLmxlbmd0aCkmJihyPXRoaXMubGVuZ3RoKSxyPD0wKXJldHVybiIiO2lmKChyPj4+PTApPD0odD4+Pj0wKSlyZXR1cm4iIjtmb3IoZXx8KGU9InV0ZjgiKTs7KXN3aXRjaChlKXtjYXNlImhleCI6cmV0dXJuIFIodGhpcyx0LHIpO2Nhc2UidXRmOCI6Y2FzZSJ1dGYtOCI6cmV0dXJuIFModGhpcyx0LHIpO2Nhc2UiYXNjaWkiOnJldHVybiBQKHRoaXMsdCxyKTtjYXNlImxhdGluMSI6Y2FzZSJiaW5hcnkiOnJldHVybiBEKHRoaXMsdCxyKTtjYXNlImJhc2U2NCI6cmV0dXJuIFQodGhpcyx0LHIpO2Nhc2UidWNzMiI6Y2FzZSJ1Y3MtMiI6Y2FzZSJ1dGYxNmxlIjpjYXNlInV0Zi0xNmxlIjpyZXR1cm4gTyh0aGlzLHQscik7ZGVmYXVsdDppZihuKXRocm93IG5ldyBUeXBlRXJyb3IoIlVua25vd24gZW5jb2Rpbmc6ICIrZSk7ZT0oZSsiIikudG9Mb3dlckNhc2UoKSxuPSEwfX0uYXBwbHkodGhpcyxhcmd1bWVudHMpfSx1LnByb3RvdHlwZS5lcXVhbHM9ZnVuY3Rpb24oZSl7aWYoIXUuaXNCdWZmZXIoZSkpdGhyb3cgbmV3IFR5cGVFcnJvcigiQXJndW1lbnQgbXVzdCBiZSBhIEJ1ZmZlciIpO3JldHVybiB0aGlzPT09ZXx8MD09PXUuY29tcGFyZSh0aGlzLGUpfSx1LnByb3RvdHlwZS5pbnNwZWN0PWZ1bmN0aW9uKCl7dmFyIGU9IiIscj10LklOU1BFQ1RfTUFYX0JZVEVTO3JldHVybiB0aGlzLmxlbmd0aD4wJiYoZT10aGlzLnRvU3RyaW5nKCJoZXgiLDAscikubWF0Y2goLy57Mn0vZykuam9pbigiICIpLHRoaXMubGVuZ3RoPnImJihlKz0iIC4uLiAiKSksIjxCdWZmZXIgIitlKyI+In0sdS5wcm90b3R5cGUuY29tcGFyZT1mdW5jdGlvbihlLHQscixuLG8pe2lmKCF1LmlzQnVmZmVyKGUpKXRocm93IG5ldyBUeXBlRXJyb3IoIkFyZ3VtZW50IG11c3QgYmUgYSBCdWZmZXIiKTtpZih2b2lkIDA9PT10JiYodD0wKSx2b2lkIDA9PT1yJiYocj1lP2UubGVuZ3RoOjApLHZvaWQgMD09PW4mJihuPTApLHZvaWQgMD09PW8mJihvPXRoaXMubGVuZ3RoKSx0PDB8fHI+ZS5sZW5ndGh8fG48MHx8bz50aGlzLmxlbmd0aCl0aHJvdyBuZXcgUmFuZ2VFcnJvcigib3V0IG9mIHJhbmdlIGluZGV4Iik7aWYobj49byYmdD49cilyZXR1cm4gMDtpZihuPj1vKXJldHVybi0xO2lmKHQ+PXIpcmV0dXJuIDE7aWYodGhpcz09PWUpcmV0dXJuIDA7Zm9yKHZhciBpPShvPj4+PTApLShuPj4+PTApLGE9KHI+Pj49MCktKHQ+Pj49MCkscz1NYXRoLm1pbihpLGEpLGM9dGhpcy5zbGljZShuLG8pLGw9ZS5zbGljZSh0LHIpLGY9MDtmPHM7KytmKWlmKGNbZl0hPT1sW2ZdKXtpPWNbZl0sYT1sW2ZdO2JyZWFrfXJldHVybiBpPGE/LTE6YTxpPzE6MH0sdS5wcm90b3R5cGUuaW5jbHVkZXM9ZnVuY3Rpb24oZSx0LHIpe3JldHVybi0xIT09dGhpcy5pbmRleE9mKGUsdCxyKX0sdS5wcm90b3R5cGUuaW5kZXhPZj1mdW5jdGlvbihlLHQscil7cmV0dXJuIHkodGhpcyxlLHQsciwhMCl9LHUucHJvdG90eXBlLmxhc3RJbmRleE9mPWZ1bmN0aW9uKGUsdCxyKXtyZXR1cm4geSh0aGlzLGUsdCxyLCExKX0sdS5wcm90b3R5cGUud3JpdGU9ZnVuY3Rpb24oZSx0LHIsbil7aWYodm9pZCAwPT09dCluPSJ1dGY4IixyPXRoaXMubGVuZ3RoLHQ9MDtlbHNlIGlmKHZvaWQgMD09PXImJiJzdHJpbmciPT10eXBlb2YgdCluPXQscj10aGlzLmxlbmd0aCx0PTA7ZWxzZXtpZighaXNGaW5pdGUodCkpdGhyb3cgbmV3IEVycm9yKCJCdWZmZXIud3JpdGUoc3RyaW5nLCBlbmNvZGluZywgb2Zmc2V0WywgbGVuZ3RoXSkgaXMgbm8gbG9uZ2VyIHN1cHBvcnRlZCIpO3R8PTAsaXNGaW5pdGUocik/KHJ8PTAsdm9pZCAwPT09biYmKG49InV0ZjgiKSk6KG49cixyPXZvaWQgMCl9dmFyIG89dGhpcy5sZW5ndGgtdDtpZigodm9pZCAwPT09cnx8cj5vKSYmKHI9byksZS5sZW5ndGg+MCYmKHI8MHx8dDwwKXx8dD50aGlzLmxlbmd0aCl0aHJvdyBuZXcgUmFuZ2VFcnJvcigiQXR0ZW1wdCB0byB3cml0ZSBvdXRzaWRlIGJ1ZmZlciBib3VuZHMiKTtufHwobj0idXRmOCIpO2Zvcih2YXIgaT0hMTs7KXN3aXRjaChuKXtjYXNlImhleCI6cmV0dXJuIGcodGhpcyxlLHQscik7Y2FzZSJ1dGY4IjpjYXNlInV0Zi04IjpyZXR1cm4gdih0aGlzLGUsdCxyKTtjYXNlImFzY2lpIjpyZXR1cm4gdyh0aGlzLGUsdCxyKTtjYXNlImxhdGluMSI6Y2FzZSJiaW5hcnkiOnJldHVybiBfKHRoaXMsZSx0LHIpO2Nhc2UiYmFzZTY0IjpyZXR1cm4gYih0aGlzLGUsdCxyKTtjYXNlInVjczIiOmNhc2UidWNzLTIiOmNhc2UidXRmMTZsZSI6Y2FzZSJ1dGYtMTZsZSI6cmV0dXJuIEEodGhpcyxlLHQscik7ZGVmYXVsdDppZihpKXRocm93IG5ldyBUeXBlRXJyb3IoIlVua25vd24gZW5jb2Rpbmc6ICIrbik7bj0oIiIrbikudG9Mb3dlckNhc2UoKSxpPSEwfX0sdS5wcm90b3R5cGUudG9KU09OPWZ1bmN0aW9uKCl7cmV0dXJue3R5cGU6IkJ1ZmZlciIsZGF0YTpBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbCh0aGlzLl9hcnJ8fHRoaXMsMCl9fTt2YXIgaz00MDk2O2Z1bmN0aW9uIFAoZSx0LHIpe3ZhciBuPSIiO3I9TWF0aC5taW4oZS5sZW5ndGgscik7Zm9yKHZhciBvPXQ7bzxyOysrbyluKz1TdHJpbmcuZnJvbUNoYXJDb2RlKDEyNyZlW29dKTtyZXR1cm4gbn1mdW5jdGlvbiBEKGUsdCxyKXt2YXIgbj0iIjtyPU1hdGgubWluKGUubGVuZ3RoLHIpO2Zvcih2YXIgbz10O288cjsrK28pbis9U3RyaW5nLmZyb21DaGFyQ29kZShlW29dKTtyZXR1cm4gbn1mdW5jdGlvbiBSKGUsdCxyKXt2YXIgbj1lLmxlbmd0aDsoIXR8fHQ8MCkmJih0PTApLCghcnx8cjwwfHxyPm4pJiYocj1uKTtmb3IodmFyIG89IiIsaT10O2k8cjsrK2kpbys9aihlW2ldKTtyZXR1cm4gb31mdW5jdGlvbiBPKGUsdCxyKXtmb3IodmFyIG49ZS5zbGljZSh0LHIpLG89IiIsaT0wO2k8bi5sZW5ndGg7aSs9MilvKz1TdHJpbmcuZnJvbUNoYXJDb2RlKG5baV0rMjU2Km5baSsxXSk7cmV0dXJuIG99ZnVuY3Rpb24gQyhlLHQscil7aWYoZSUxIT0wfHxlPDApdGhyb3cgbmV3IFJhbmdlRXJyb3IoIm9mZnNldCBpcyBub3QgdWludCIpO2lmKGUrdD5yKXRocm93IG5ldyBSYW5nZUVycm9yKCJUcnlpbmcgdG8gYWNjZXNzIGJleW9uZCBidWZmZXIgbGVuZ3RoIil9ZnVuY3Rpb24gTihlLHQscixuLG8saSl7aWYoIXUuaXNCdWZmZXIoZSkpdGhyb3cgbmV3IFR5cGVFcnJvcignImJ1ZmZlciIgYXJndW1lbnQgbXVzdCBiZSBhIEJ1ZmZlciBpbnN0YW5jZScpO2lmKHQ+b3x8dDxpKXRocm93IG5ldyBSYW5nZUVycm9yKCcidmFsdWUiIGFyZ3VtZW50IGlzIG91dCBvZiBib3VuZHMnKTtpZihyK24+ZS5sZW5ndGgpdGhyb3cgbmV3IFJhbmdlRXJyb3IoIkluZGV4IG91dCBvZiByYW5nZSIpfWZ1bmN0aW9uIEYoZSx0LHIsbil7dDwwJiYodD02NTUzNSt0KzEpO2Zvcih2YXIgbz0wLGk9TWF0aC5taW4oZS5sZW5ndGgtciwyKTtvPGk7KytvKWVbcitvXT0odCYyNTU8PDgqKG4/bzoxLW8pKT4+PjgqKG4/bzoxLW8pfWZ1bmN0aW9uIE0oZSx0LHIsbil7dDwwJiYodD00Mjk0OTY3Mjk1K3QrMSk7Zm9yKHZhciBvPTAsaT1NYXRoLm1pbihlLmxlbmd0aC1yLDQpO288aTsrK28pZVtyK29dPXQ+Pj44KihuP286My1vKSYyNTV9ZnVuY3Rpb24gSShlLHQscixuLG8saSl7aWYocituPmUubGVuZ3RoKXRocm93IG5ldyBSYW5nZUVycm9yKCJJbmRleCBvdXQgb2YgcmFuZ2UiKTtpZihyPDApdGhyb3cgbmV3IFJhbmdlRXJyb3IoIkluZGV4IG91dCBvZiByYW5nZSIpfWZ1bmN0aW9uIEIoZSx0LHIsbixpKXtyZXR1cm4gaXx8SShlLDAsciw0KSxvLndyaXRlKGUsdCxyLG4sMjMsNCkscis0fWZ1bmN0aW9uIEwoZSx0LHIsbixpKXtyZXR1cm4gaXx8SShlLDAsciw4KSxvLndyaXRlKGUsdCxyLG4sNTIsOCkscis4fXUucHJvdG90eXBlLnNsaWNlPWZ1bmN0aW9uKGUsdCl7dmFyIHIsbj10aGlzLmxlbmd0aDtpZigoZT1+fmUpPDA/KGUrPW4pPDAmJihlPTApOmU+biYmKGU9biksKHQ9dm9pZCAwPT09dD9uOn5+dCk8MD8odCs9bik8MCYmKHQ9MCk6dD5uJiYodD1uKSx0PGUmJih0PWUpLHUuVFlQRURfQVJSQVlfU1VQUE9SVCkocj10aGlzLnN1YmFycmF5KGUsdCkpLl9fcHJvdG9fXz11LnByb3RvdHlwZTtlbHNle3ZhciBvPXQtZTtyPW5ldyB1KG8sdm9pZCAwKTtmb3IodmFyIGk9MDtpPG87KytpKXJbaV09dGhpc1tpK2VdfXJldHVybiByfSx1LnByb3RvdHlwZS5yZWFkVUludExFPWZ1bmN0aW9uKGUsdCxyKXtlfD0wLHR8PTAscnx8QyhlLHQsdGhpcy5sZW5ndGgpO2Zvcih2YXIgbj10aGlzW2VdLG89MSxpPTA7KytpPHQmJihvKj0yNTYpOyluKz10aGlzW2UraV0qbztyZXR1cm4gbn0sdS5wcm90b3R5cGUucmVhZFVJbnRCRT1mdW5jdGlvbihlLHQscil7ZXw9MCx0fD0wLHJ8fEMoZSx0LHRoaXMubGVuZ3RoKTtmb3IodmFyIG49dGhpc1tlKy0tdF0sbz0xO3Q+MCYmKG8qPTI1Nik7KW4rPXRoaXNbZSstLXRdKm87cmV0dXJuIG59LHUucHJvdG90eXBlLnJlYWRVSW50OD1mdW5jdGlvbihlLHQpe3JldHVybiB0fHxDKGUsMSx0aGlzLmxlbmd0aCksdGhpc1tlXX0sdS5wcm90b3R5cGUucmVhZFVJbnQxNkxFPWZ1bmN0aW9uKGUsdCl7cmV0dXJuIHR8fEMoZSwyLHRoaXMubGVuZ3RoKSx0aGlzW2VdfHRoaXNbZSsxXTw8OH0sdS5wcm90b3R5cGUucmVhZFVJbnQxNkJFPWZ1bmN0aW9uKGUsdCl7cmV0dXJuIHR8fEMoZSwyLHRoaXMubGVuZ3RoKSx0aGlzW2VdPDw4fHRoaXNbZSsxXX0sdS5wcm90b3R5cGUucmVhZFVJbnQzMkxFPWZ1bmN0aW9uKGUsdCl7cmV0dXJuIHR8fEMoZSw0LHRoaXMubGVuZ3RoKSwodGhpc1tlXXx0aGlzW2UrMV08PDh8dGhpc1tlKzJdPDwxNikrMTY3NzcyMTYqdGhpc1tlKzNdfSx1LnByb3RvdHlwZS5yZWFkVUludDMyQkU9ZnVuY3Rpb24oZSx0KXtyZXR1cm4gdHx8QyhlLDQsdGhpcy5sZW5ndGgpLDE2Nzc3MjE2KnRoaXNbZV0rKHRoaXNbZSsxXTw8MTZ8dGhpc1tlKzJdPDw4fHRoaXNbZSszXSl9LHUucHJvdG90eXBlLnJlYWRJbnRMRT1mdW5jdGlvbihlLHQscil7ZXw9MCx0fD0wLHJ8fEMoZSx0LHRoaXMubGVuZ3RoKTtmb3IodmFyIG49dGhpc1tlXSxvPTEsaT0wOysraTx0JiYobyo9MjU2KTspbis9dGhpc1tlK2ldKm87cmV0dXJuIG4+PShvKj0xMjgpJiYobi09TWF0aC5wb3coMiw4KnQpKSxufSx1LnByb3RvdHlwZS5yZWFkSW50QkU9ZnVuY3Rpb24oZSx0LHIpe2V8PTAsdHw9MCxyfHxDKGUsdCx0aGlzLmxlbmd0aCk7Zm9yKHZhciBuPXQsbz0xLGk9dGhpc1tlKy0tbl07bj4wJiYobyo9MjU2KTspaSs9dGhpc1tlKy0tbl0qbztyZXR1cm4gaT49KG8qPTEyOCkmJihpLT1NYXRoLnBvdygyLDgqdCkpLGl9LHUucHJvdG90eXBlLnJlYWRJbnQ4PWZ1bmN0aW9uKGUsdCl7cmV0dXJuIHR8fEMoZSwxLHRoaXMubGVuZ3RoKSwxMjgmdGhpc1tlXT8tMSooMjU1LXRoaXNbZV0rMSk6dGhpc1tlXX0sdS5wcm90b3R5cGUucmVhZEludDE2TEU9ZnVuY3Rpb24oZSx0KXt0fHxDKGUsMix0aGlzLmxlbmd0aCk7dmFyIHI9dGhpc1tlXXx0aGlzW2UrMV08PDg7cmV0dXJuIDMyNzY4JnI/NDI5NDkwMTc2MHxyOnJ9LHUucHJvdG90eXBlLnJlYWRJbnQxNkJFPWZ1bmN0aW9uKGUsdCl7dHx8QyhlLDIsdGhpcy5sZW5ndGgpO3ZhciByPXRoaXNbZSsxXXx0aGlzW2VdPDw4O3JldHVybiAzMjc2OCZyPzQyOTQ5MDE3NjB8cjpyfSx1LnByb3RvdHlwZS5yZWFkSW50MzJMRT1mdW5jdGlvbihlLHQpe3JldHVybiB0fHxDKGUsNCx0aGlzLmxlbmd0aCksdGhpc1tlXXx0aGlzW2UrMV08PDh8dGhpc1tlKzJdPDwxNnx0aGlzW2UrM108PDI0fSx1LnByb3RvdHlwZS5yZWFkSW50MzJCRT1mdW5jdGlvbihlLHQpe3JldHVybiB0fHxDKGUsNCx0aGlzLmxlbmd0aCksdGhpc1tlXTw8MjR8dGhpc1tlKzFdPDwxNnx0aGlzW2UrMl08PDh8dGhpc1tlKzNdfSx1LnByb3RvdHlwZS5yZWFkRmxvYXRMRT1mdW5jdGlvbihlLHQpe3JldHVybiB0fHxDKGUsNCx0aGlzLmxlbmd0aCksby5yZWFkKHRoaXMsZSwhMCwyMyw0KX0sdS5wcm90b3R5cGUucmVhZEZsb2F0QkU9ZnVuY3Rpb24oZSx0KXtyZXR1cm4gdHx8QyhlLDQsdGhpcy5sZW5ndGgpLG8ucmVhZCh0aGlzLGUsITEsMjMsNCl9LHUucHJvdG90eXBlLnJlYWREb3VibGVMRT1mdW5jdGlvbihlLHQpe3JldHVybiB0fHxDKGUsOCx0aGlzLmxlbmd0aCksby5yZWFkKHRoaXMsZSwhMCw1Miw4KX0sdS5wcm90b3R5cGUucmVhZERvdWJsZUJFPWZ1bmN0aW9uKGUsdCl7cmV0dXJuIHR8fEMoZSw4LHRoaXMubGVuZ3RoKSxvLnJlYWQodGhpcyxlLCExLDUyLDgpfSx1LnByb3RvdHlwZS53cml0ZVVJbnRMRT1mdW5jdGlvbihlLHQscixuKXtlPStlLHR8PTAscnw9MCxufHxOKHRoaXMsZSx0LHIsTWF0aC5wb3coMiw4KnIpLTEsMCk7dmFyIG89MSxpPTA7Zm9yKHRoaXNbdF09MjU1JmU7KytpPHImJihvKj0yNTYpOyl0aGlzW3QraV09ZS9vJjI1NTtyZXR1cm4gdCtyfSx1LnByb3RvdHlwZS53cml0ZVVJbnRCRT1mdW5jdGlvbihlLHQscixuKXtlPStlLHR8PTAscnw9MCxufHxOKHRoaXMsZSx0LHIsTWF0aC5wb3coMiw4KnIpLTEsMCk7dmFyIG89ci0xLGk9MTtmb3IodGhpc1t0K29dPTI1NSZlOy0tbz49MCYmKGkqPTI1Nik7KXRoaXNbdCtvXT1lL2kmMjU1O3JldHVybiB0K3J9LHUucHJvdG90eXBlLndyaXRlVUludDg9ZnVuY3Rpb24oZSx0LHIpe3JldHVybiBlPStlLHR8PTAscnx8Tih0aGlzLGUsdCwxLDI1NSwwKSx1LlRZUEVEX0FSUkFZX1NVUFBPUlR8fChlPU1hdGguZmxvb3IoZSkpLHRoaXNbdF09MjU1JmUsdCsxfSx1LnByb3RvdHlwZS53cml0ZVVJbnQxNkxFPWZ1bmN0aW9uKGUsdCxyKXtyZXR1cm4gZT0rZSx0fD0wLHJ8fE4odGhpcyxlLHQsMiw2NTUzNSwwKSx1LlRZUEVEX0FSUkFZX1NVUFBPUlQ/KHRoaXNbdF09MjU1JmUsdGhpc1t0KzFdPWU+Pj44KTpGKHRoaXMsZSx0LCEwKSx0KzJ9LHUucHJvdG90eXBlLndyaXRlVUludDE2QkU9ZnVuY3Rpb24oZSx0LHIpe3JldHVybiBlPStlLHR8PTAscnx8Tih0aGlzLGUsdCwyLDY1NTM1LDApLHUuVFlQRURfQVJSQVlfU1VQUE9SVD8odGhpc1t0XT1lPj4+OCx0aGlzW3QrMV09MjU1JmUpOkYodGhpcyxlLHQsITEpLHQrMn0sdS5wcm90b3R5cGUud3JpdGVVSW50MzJMRT1mdW5jdGlvbihlLHQscil7cmV0dXJuIGU9K2UsdHw9MCxyfHxOKHRoaXMsZSx0LDQsNDI5NDk2NzI5NSwwKSx1LlRZUEVEX0FSUkFZX1NVUFBPUlQ/KHRoaXNbdCszXT1lPj4+MjQsdGhpc1t0KzJdPWU+Pj4xNix0aGlzW3QrMV09ZT4+PjgsdGhpc1t0XT0yNTUmZSk6TSh0aGlzLGUsdCwhMCksdCs0fSx1LnByb3RvdHlwZS53cml0ZVVJbnQzMkJFPWZ1bmN0aW9uKGUsdCxyKXtyZXR1cm4gZT0rZSx0fD0wLHJ8fE4odGhpcyxlLHQsNCw0Mjk0OTY3Mjk1LDApLHUuVFlQRURfQVJSQVlfU1VQUE9SVD8odGhpc1t0XT1lPj4+MjQsdGhpc1t0KzFdPWU+Pj4xNix0aGlzW3QrMl09ZT4+PjgsdGhpc1t0KzNdPTI1NSZlKTpNKHRoaXMsZSx0LCExKSx0KzR9LHUucHJvdG90eXBlLndyaXRlSW50TEU9ZnVuY3Rpb24oZSx0LHIsbil7aWYoZT0rZSx0fD0wLCFuKXt2YXIgbz1NYXRoLnBvdygyLDgqci0xKTtOKHRoaXMsZSx0LHIsby0xLC1vKX12YXIgaT0wLGE9MSxzPTA7Zm9yKHRoaXNbdF09MjU1JmU7KytpPHImJihhKj0yNTYpOyllPDAmJjA9PT1zJiYwIT09dGhpc1t0K2ktMV0mJihzPTEpLHRoaXNbdCtpXT0oZS9hPj4wKS1zJjI1NTtyZXR1cm4gdCtyfSx1LnByb3RvdHlwZS53cml0ZUludEJFPWZ1bmN0aW9uKGUsdCxyLG4pe2lmKGU9K2UsdHw9MCwhbil7dmFyIG89TWF0aC5wb3coMiw4KnItMSk7Tih0aGlzLGUsdCxyLG8tMSwtbyl9dmFyIGk9ci0xLGE9MSxzPTA7Zm9yKHRoaXNbdCtpXT0yNTUmZTstLWk+PTAmJihhKj0yNTYpOyllPDAmJjA9PT1zJiYwIT09dGhpc1t0K2krMV0mJihzPTEpLHRoaXNbdCtpXT0oZS9hPj4wKS1zJjI1NTtyZXR1cm4gdCtyfSx1LnByb3RvdHlwZS53cml0ZUludDg9ZnVuY3Rpb24oZSx0LHIpe3JldHVybiBlPStlLHR8PTAscnx8Tih0aGlzLGUsdCwxLDEyNywtMTI4KSx1LlRZUEVEX0FSUkFZX1NVUFBPUlR8fChlPU1hdGguZmxvb3IoZSkpLGU8MCYmKGU9MjU1K2UrMSksdGhpc1t0XT0yNTUmZSx0KzF9LHUucHJvdG90eXBlLndyaXRlSW50MTZMRT1mdW5jdGlvbihlLHQscil7cmV0dXJuIGU9K2UsdHw9MCxyfHxOKHRoaXMsZSx0LDIsMzI3NjcsLTMyNzY4KSx1LlRZUEVEX0FSUkFZX1NVUFBPUlQ/KHRoaXNbdF09MjU1JmUsdGhpc1t0KzFdPWU+Pj44KTpGKHRoaXMsZSx0LCEwKSx0KzJ9LHUucHJvdG90eXBlLndyaXRlSW50MTZCRT1mdW5jdGlvbihlLHQscil7cmV0dXJuIGU9K2UsdHw9MCxyfHxOKHRoaXMsZSx0LDIsMzI3NjcsLTMyNzY4KSx1LlRZUEVEX0FSUkFZX1NVUFBPUlQ/KHRoaXNbdF09ZT4+PjgsdGhpc1t0KzFdPTI1NSZlKTpGKHRoaXMsZSx0LCExKSx0KzJ9LHUucHJvdG90eXBlLndyaXRlSW50MzJMRT1mdW5jdGlvbihlLHQscil7cmV0dXJuIGU9K2UsdHw9MCxyfHxOKHRoaXMsZSx0LDQsMjE0NzQ4MzY0NywtMjE0NzQ4MzY0OCksdS5UWVBFRF9BUlJBWV9TVVBQT1JUPyh0aGlzW3RdPTI1NSZlLHRoaXNbdCsxXT1lPj4+OCx0aGlzW3QrMl09ZT4+PjE2LHRoaXNbdCszXT1lPj4+MjQpOk0odGhpcyxlLHQsITApLHQrNH0sdS5wcm90b3R5cGUud3JpdGVJbnQzMkJFPWZ1bmN0aW9uKGUsdCxyKXtyZXR1cm4gZT0rZSx0fD0wLHJ8fE4odGhpcyxlLHQsNCwyMTQ3NDgzNjQ3LC0yMTQ3NDgzNjQ4KSxlPDAmJihlPTQyOTQ5NjcyOTUrZSsxKSx1LlRZUEVEX0FSUkFZX1NVUFBPUlQ/KHRoaXNbdF09ZT4+PjI0LHRoaXNbdCsxXT1lPj4+MTYsdGhpc1t0KzJdPWU+Pj44LHRoaXNbdCszXT0yNTUmZSk6TSh0aGlzLGUsdCwhMSksdCs0fSx1LnByb3RvdHlwZS53cml0ZUZsb2F0TEU9ZnVuY3Rpb24oZSx0LHIpe3JldHVybiBCKHRoaXMsZSx0LCEwLHIpfSx1LnByb3RvdHlwZS53cml0ZUZsb2F0QkU9ZnVuY3Rpb24oZSx0LHIpe3JldHVybiBCKHRoaXMsZSx0LCExLHIpfSx1LnByb3RvdHlwZS53cml0ZURvdWJsZUxFPWZ1bmN0aW9uKGUsdCxyKXtyZXR1cm4gTCh0aGlzLGUsdCwhMCxyKX0sdS5wcm90b3R5cGUud3JpdGVEb3VibGVCRT1mdW5jdGlvbihlLHQscil7cmV0dXJuIEwodGhpcyxlLHQsITEscil9LHUucHJvdG90eXBlLmNvcHk9ZnVuY3Rpb24oZSx0LHIsbil7aWYocnx8KHI9MCksbnx8MD09PW58fChuPXRoaXMubGVuZ3RoKSx0Pj1lLmxlbmd0aCYmKHQ9ZS5sZW5ndGgpLHR8fCh0PTApLG4+MCYmbjxyJiYobj1yKSxuPT09cilyZXR1cm4gMDtpZigwPT09ZS5sZW5ndGh8fDA9PT10aGlzLmxlbmd0aClyZXR1cm4gMDtpZih0PDApdGhyb3cgbmV3IFJhbmdlRXJyb3IoInRhcmdldFN0YXJ0IG91dCBvZiBib3VuZHMiKTtpZihyPDB8fHI+PXRoaXMubGVuZ3RoKXRocm93IG5ldyBSYW5nZUVycm9yKCJzb3VyY2VTdGFydCBvdXQgb2YgYm91bmRzIik7aWYobjwwKXRocm93IG5ldyBSYW5nZUVycm9yKCJzb3VyY2VFbmQgb3V0IG9mIGJvdW5kcyIpO24+dGhpcy5sZW5ndGgmJihuPXRoaXMubGVuZ3RoKSxlLmxlbmd0aC10PG4tciYmKG49ZS5sZW5ndGgtdCtyKTt2YXIgbyxpPW4tcjtpZih0aGlzPT09ZSYmcjx0JiZ0PG4pZm9yKG89aS0xO28+PTA7LS1vKWVbbyt0XT10aGlzW28rcl07ZWxzZSBpZihpPDFlM3x8IXUuVFlQRURfQVJSQVlfU1VQUE9SVClmb3Iobz0wO288aTsrK28pZVtvK3RdPXRoaXNbbytyXTtlbHNlIFVpbnQ4QXJyYXkucHJvdG90eXBlLnNldC5jYWxsKGUsdGhpcy5zdWJhcnJheShyLHIraSksdCk7cmV0dXJuIGl9LHUucHJvdG90eXBlLmZpbGw9ZnVuY3Rpb24oZSx0LHIsbil7aWYoInN0cmluZyI9PXR5cGVvZiBlKXtpZigic3RyaW5nIj09dHlwZW9mIHQ/KG49dCx0PTAscj10aGlzLmxlbmd0aCk6InN0cmluZyI9PXR5cGVvZiByJiYobj1yLHI9dGhpcy5sZW5ndGgpLDE9PT1lLmxlbmd0aCl7dmFyIG89ZS5jaGFyQ29kZUF0KDApO288MjU2JiYoZT1vKX1pZih2b2lkIDAhPT1uJiYic3RyaW5nIiE9dHlwZW9mIG4pdGhyb3cgbmV3IFR5cGVFcnJvcigiZW5jb2RpbmcgbXVzdCBiZSBhIHN0cmluZyIpO2lmKCJzdHJpbmciPT10eXBlb2YgbiYmIXUuaXNFbmNvZGluZyhuKSl0aHJvdyBuZXcgVHlwZUVycm9yKCJVbmtub3duIGVuY29kaW5nOiAiK24pfWVsc2UibnVtYmVyIj09dHlwZW9mIGUmJihlJj0yNTUpO2lmKHQ8MHx8dGhpcy5sZW5ndGg8dHx8dGhpcy5sZW5ndGg8cil0aHJvdyBuZXcgUmFuZ2VFcnJvcigiT3V0IG9mIHJhbmdlIGluZGV4Iik7aWYocjw9dClyZXR1cm4gdGhpczt2YXIgaTtpZih0Pj4+PTAscj12b2lkIDA9PT1yP3RoaXMubGVuZ3RoOnI+Pj4wLGV8fChlPTApLCJudW1iZXIiPT10eXBlb2YgZSlmb3IoaT10O2k8cjsrK2kpdGhpc1tpXT1lO2Vsc2V7dmFyIGE9dS5pc0J1ZmZlcihlKT9lOlUobmV3IHUoZSxuKS50b1N0cmluZygpKSxzPWEubGVuZ3RoO2ZvcihpPTA7aTxyLXQ7KytpKXRoaXNbaSt0XT1hW2klc119cmV0dXJuIHRoaXN9O3ZhciB4PS9bXitcLzAtOUEtWmEtei1fXS9nO2Z1bmN0aW9uIGooZSl7cmV0dXJuIGU8MTY/IjAiK2UudG9TdHJpbmcoMTYpOmUudG9TdHJpbmcoMTYpfWZ1bmN0aW9uIFUoZSx0KXt2YXIgcjt0PXR8fDEvMDtmb3IodmFyIG49ZS5sZW5ndGgsbz1udWxsLGk9W10sYT0wO2E8bjsrK2Epe2lmKChyPWUuY2hhckNvZGVBdChhKSk+NTUyOTUmJnI8NTczNDQpe2lmKCFvKXtpZihyPjU2MzE5KXsodC09Myk+LTEmJmkucHVzaCgyMzksMTkxLDE4OSk7Y29udGludWV9aWYoYSsxPT09bil7KHQtPTMpPi0xJiZpLnB1c2goMjM5LDE5MSwxODkpO2NvbnRpbnVlfW89cjtjb250aW51ZX1pZihyPDU2MzIwKXsodC09Myk+LTEmJmkucHVzaCgyMzksMTkxLDE4OSksbz1yO2NvbnRpbnVlfXI9NjU1MzYrKG8tNTUyOTY8PDEwfHItNTYzMjApfWVsc2UgbyYmKHQtPTMpPi0xJiZpLnB1c2goMjM5LDE5MSwxODkpO2lmKG89bnVsbCxyPDEyOCl7aWYoKHQtPTEpPDApYnJlYWs7aS5wdXNoKHIpfWVsc2UgaWYocjwyMDQ4KXtpZigodC09Mik8MClicmVhaztpLnB1c2gocj4+NnwxOTIsNjMmcnwxMjgpfWVsc2UgaWYocjw2NTUzNil7aWYoKHQtPTMpPDApYnJlYWs7aS5wdXNoKHI+PjEyfDIyNCxyPj42JjYzfDEyOCw2MyZyfDEyOCl9ZWxzZXtpZighKHI8MTExNDExMikpdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIGNvZGUgcG9pbnQiKTtpZigodC09NCk8MClicmVhaztpLnB1c2gocj4+MTh8MjQwLHI+PjEyJjYzfDEyOCxyPj42JjYzfDEyOCw2MyZyfDEyOCl9fXJldHVybiBpfWZ1bmN0aW9uIHooZSl7cmV0dXJuIG4udG9CeXRlQXJyYXkoZnVuY3Rpb24oZSl7aWYoKGU9ZnVuY3Rpb24oZSl7cmV0dXJuIGUudHJpbT9lLnRyaW0oKTplLnJlcGxhY2UoL15ccyt8XHMrJC9nLCIiKX0oZSkucmVwbGFjZSh4LCIiKSkubGVuZ3RoPDIpcmV0dXJuIiI7Zm9yKDtlLmxlbmd0aCU0IT0wOyllKz0iPSI7cmV0dXJuIGV9KGUpKX1mdW5jdGlvbiAkKGUsdCxyLG4pe2Zvcih2YXIgbz0wO288biYmIShvK3I+PXQubGVuZ3RofHxvPj1lLmxlbmd0aCk7KytvKXRbbytyXT1lW29dO3JldHVybiBvfX0pLmNhbGwodGhpcyxyKDgpKX0sZnVuY3Rpb24oZSx0KXt2YXIgcjtyPWZ1bmN0aW9uKCl7cmV0dXJuIHRoaXN9KCk7dHJ5e3I9cnx8RnVuY3Rpb24oInJldHVybiB0aGlzIikoKXx8KDAsZXZhbCkoInRoaXMiKX1jYXRjaChlKXsib2JqZWN0Ij09dHlwZW9mIHdpbmRvdyYmKHI9d2luZG93KX1lLmV4cG9ydHM9cn0sZnVuY3Rpb24oZSx0LHIpe3QuYnl0ZUxlbmd0aD1mdW5jdGlvbihlKXt2YXIgdD1jKGUpLHI9dFswXSxuPXRbMV07cmV0dXJuIDMqKHIrbikvNC1ufSx0LnRvQnl0ZUFycmF5PWZ1bmN0aW9uKGUpe2Zvcih2YXIgdCxyPWMoZSksbj1yWzBdLGE9clsxXSxzPW5ldyBpKGZ1bmN0aW9uKGUsdCxyKXtyZXR1cm4gMyoodCtyKS80LXJ9KDAsbixhKSksdT0wLGw9YT4wP24tNDpuLGY9MDtmPGw7Zis9NCl0PW9bZS5jaGFyQ29kZUF0KGYpXTw8MTh8b1tlLmNoYXJDb2RlQXQoZisxKV08PDEyfG9bZS5jaGFyQ29kZUF0KGYrMildPDw2fG9bZS5jaGFyQ29kZUF0KGYrMyldLHNbdSsrXT10Pj4xNiYyNTUsc1t1KytdPXQ+PjgmMjU1LHNbdSsrXT0yNTUmdDtyZXR1cm4gMj09PWEmJih0PW9bZS5jaGFyQ29kZUF0KGYpXTw8MnxvW2UuY2hhckNvZGVBdChmKzEpXT4+NCxzW3UrK109MjU1JnQpLDE9PT1hJiYodD1vW2UuY2hhckNvZGVBdChmKV08PDEwfG9bZS5jaGFyQ29kZUF0KGYrMSldPDw0fG9bZS5jaGFyQ29kZUF0KGYrMildPj4yLHNbdSsrXT10Pj44JjI1NSxzW3UrK109MjU1JnQpLHN9LHQuZnJvbUJ5dGVBcnJheT1mdW5jdGlvbihlKXtmb3IodmFyIHQscj1lLmxlbmd0aCxvPXIlMyxpPVtdLGE9MCxzPXItbzthPHM7YSs9MTYzODMpaS5wdXNoKGYoZSxhLGErMTYzODM+cz9zOmErMTYzODMpKTtyZXR1cm4gMT09PW8/KHQ9ZVtyLTFdLGkucHVzaChuW3Q+PjJdK25bdDw8NCY2M10rIj09IikpOjI9PT1vJiYodD0oZVtyLTJdPDw4KStlW3ItMV0saS5wdXNoKG5bdD4+MTBdK25bdD4+NCY2M10rblt0PDwyJjYzXSsiPSIpKSxpLmpvaW4oIiIpfTtmb3IodmFyIG49W10sbz1bXSxpPSJ1bmRlZmluZWQiIT10eXBlb2YgVWludDhBcnJheT9VaW50OEFycmF5OkFycmF5LGE9IkFCQ0RFRkdISUpLTE1OT1BRUlNUVVZXWFlaYWJjZGVmZ2hpamtsbW5vcHFyc3R1dnd4eXowMTIzNDU2Nzg5Ky8iLHM9MCx1PWEubGVuZ3RoO3M8dTsrK3MpbltzXT1hW3NdLG9bYS5jaGFyQ29kZUF0KHMpXT1zO2Z1bmN0aW9uIGMoZSl7dmFyIHQ9ZS5sZW5ndGg7aWYodCU0PjApdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIHN0cmluZy4gTGVuZ3RoIG11c3QgYmUgYSBtdWx0aXBsZSBvZiA0Iik7dmFyIHI9ZS5pbmRleE9mKCI9Iik7cmV0dXJuLTE9PT1yJiYocj10KSxbcixyPT09dD8wOjQtciU0XX1mdW5jdGlvbiBsKGUpe3JldHVybiBuW2U+PjE4JjYzXStuW2U+PjEyJjYzXStuW2U+PjYmNjNdK25bNjMmZV19ZnVuY3Rpb24gZihlLHQscil7Zm9yKHZhciBuLG89W10saT10O2k8cjtpKz0zKW49KGVbaV08PDE2JjE2NzExNjgwKSsoZVtpKzFdPDw4JjY1MjgwKSsoMjU1JmVbaSsyXSksby5wdXNoKGwobikpO3JldHVybiBvLmpvaW4oIiIpfW9bIi0iLmNoYXJDb2RlQXQoMCldPTYyLG9bIl8iLmNoYXJDb2RlQXQoMCldPTYzfSxmdW5jdGlvbihlLHQpe3QucmVhZD1mdW5jdGlvbihlLHQscixuLG8pe3ZhciBpLGEscz04Km8tbi0xLHU9KDE8PHMpLTEsYz11Pj4xLGw9LTcsZj1yP28tMTowLGQ9cj8tMToxLGg9ZVt0K2ZdO2ZvcihmKz1kLGk9aCYoMTw8LWwpLTEsaD4+PS1sLGwrPXM7bD4wO2k9MjU2KmkrZVt0K2ZdLGYrPWQsbC09OCk7Zm9yKGE9aSYoMTw8LWwpLTEsaT4+PS1sLGwrPW47bD4wO2E9MjU2KmErZVt0K2ZdLGYrPWQsbC09OCk7aWYoMD09PWkpaT0xLWM7ZWxzZXtpZihpPT09dSlyZXR1cm4gYT9OYU46MS8wKihoPy0xOjEpO2ErPU1hdGgucG93KDIsbiksaS09Y31yZXR1cm4oaD8tMToxKSphKk1hdGgucG93KDIsaS1uKX0sdC53cml0ZT1mdW5jdGlvbihlLHQscixuLG8saSl7dmFyIGEscyx1LGM9OCppLW8tMSxsPSgxPDxjKS0xLGY9bD4+MSxkPTIzPT09bz9NYXRoLnBvdygyLC0yNCktTWF0aC5wb3coMiwtNzcpOjAsaD1uPzA6aS0xLHA9bj8xOi0xLG09dDwwfHwwPT09dCYmMS90PDA/MTowO2Zvcih0PU1hdGguYWJzKHQpLGlzTmFOKHQpfHx0PT09MS8wPyhzPWlzTmFOKHQpPzE6MCxhPWwpOihhPU1hdGguZmxvb3IoTWF0aC5sb2codCkvTWF0aC5MTjIpLHQqKHU9TWF0aC5wb3coMiwtYSkpPDEmJihhLS0sdSo9MiksKHQrPWErZj49MT9kL3U6ZCpNYXRoLnBvdygyLDEtZikpKnU+PTImJihhKyssdS89MiksYStmPj1sPyhzPTAsYT1sKTphK2Y+PTE/KHM9KHQqdS0xKSpNYXRoLnBvdygyLG8pLGErPWYpOihzPXQqTWF0aC5wb3coMixmLTEpKk1hdGgucG93KDIsbyksYT0wKSk7bz49ODtlW3IraF09MjU1JnMsaCs9cCxzLz0yNTYsby09OCk7Zm9yKGE9YTw8b3xzLGMrPW87Yz4wO2VbcitoXT0yNTUmYSxoKz1wLGEvPTI1NixjLT04KTtlW3IraC1wXXw9MTI4Km19fSxmdW5jdGlvbihlLHQpe3ZhciByPXt9LnRvU3RyaW5nO2UuZXhwb3J0cz1BcnJheS5pc0FycmF5fHxmdW5jdGlvbihlKXtyZXR1cm4iW29iamVjdCBBcnJheV0iPT1yLmNhbGwoZSl9fSxmdW5jdGlvbih0LHIpe3QuZXhwb3J0cz1lfSxmdW5jdGlvbihlLHQscil7KGZ1bmN0aW9uKGUpe2Z1bmN0aW9uIHIoZSx0KXtmb3IodmFyIHI9MCxuPWUubGVuZ3RoLTE7bj49MDtuLS0pe3ZhciBvPWVbbl07Ii4iPT09bz9lLnNwbGljZShuLDEpOiIuLiI9PT1vPyhlLnNwbGljZShuLDEpLHIrKyk6ciYmKGUuc3BsaWNlKG4sMSksci0tKX1pZih0KWZvcig7ci0tO3IpZS51bnNoaWZ0KCIuLiIpO3JldHVybiBlfXZhciBuPS9eKFwvP3wpKFtcc1xTXSo/KSgoPzpcLnsxLDJ9fFteXC9dKz98KShcLlteLlwvXSp8KSkoPzpbXC9dKikkLyxvPWZ1bmN0aW9uKGUpe3JldHVybiBuLmV4ZWMoZSkuc2xpY2UoMSl9O2Z1bmN0aW9uIGkoZSx0KXtpZihlLmZpbHRlcilyZXR1cm4gZS5maWx0ZXIodCk7Zm9yKHZhciByPVtdLG49MDtuPGUubGVuZ3RoO24rKyl0KGVbbl0sbixlKSYmci5wdXNoKGVbbl0pO3JldHVybiByfXQucmVzb2x2ZT1mdW5jdGlvbigpe2Zvcih2YXIgdD0iIixuPSExLG89YXJndW1lbnRzLmxlbmd0aC0xO28+PS0xJiYhbjtvLS0pe3ZhciBhPW8+PTA/YXJndW1lbnRzW29dOmUuY3dkKCk7aWYoInN0cmluZyIhPXR5cGVvZiBhKXRocm93IG5ldyBUeXBlRXJyb3IoIkFyZ3VtZW50cyB0byBwYXRoLnJlc29sdmUgbXVzdCBiZSBzdHJpbmdzIik7YSYmKHQ9YSsiLyIrdCxuPSIvIj09PWEuY2hhckF0KDApKX1yZXR1cm4obj8iLyI6IiIpKyh0PXIoaSh0LnNwbGl0KCIvIiksKGZ1bmN0aW9uKGUpe3JldHVybiEhZX0pKSwhbikuam9pbigiLyIpKXx8Ii4ifSx0Lm5vcm1hbGl6ZT1mdW5jdGlvbihlKXt2YXIgbj10LmlzQWJzb2x1dGUoZSksbz0iLyI9PT1hKGUsLTEpO3JldHVybihlPXIoaShlLnNwbGl0KCIvIiksKGZ1bmN0aW9uKGUpe3JldHVybiEhZX0pKSwhbikuam9pbigiLyIpKXx8bnx8KGU9Ii4iKSxlJiZvJiYoZSs9Ii8iKSwobj8iLyI6IiIpK2V9LHQuaXNBYnNvbHV0ZT1mdW5jdGlvbihlKXtyZXR1cm4iLyI9PT1lLmNoYXJBdCgwKX0sdC5qb2luPWZ1bmN0aW9uKCl7dmFyIGU9QXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLDApO3JldHVybiB0Lm5vcm1hbGl6ZShpKGUsKGZ1bmN0aW9uKGUsdCl7aWYoInN0cmluZyIhPXR5cGVvZiBlKXRocm93IG5ldyBUeXBlRXJyb3IoIkFyZ3VtZW50cyB0byBwYXRoLmpvaW4gbXVzdCBiZSBzdHJpbmdzIik7cmV0dXJuIGV9KSkuam9pbigiLyIpKX0sdC5yZWxhdGl2ZT1mdW5jdGlvbihlLHIpe2Z1bmN0aW9uIG4oZSl7Zm9yKHZhciB0PTA7dDxlLmxlbmd0aCYmIiI9PT1lW3RdO3QrKyk7Zm9yKHZhciByPWUubGVuZ3RoLTE7cj49MCYmIiI9PT1lW3JdO3ItLSk7cmV0dXJuIHQ+cj9bXTplLnNsaWNlKHQsci10KzEpfWU9dC5yZXNvbHZlKGUpLnN1YnN0cigxKSxyPXQucmVzb2x2ZShyKS5zdWJzdHIoMSk7Zm9yKHZhciBvPW4oZS5zcGxpdCgiLyIpKSxpPW4oci5zcGxpdCgiLyIpKSxhPU1hdGgubWluKG8ubGVuZ3RoLGkubGVuZ3RoKSxzPWEsdT0wO3U8YTt1KyspaWYob1t1XSE9PWlbdV0pe3M9dTticmVha312YXIgYz1bXTtmb3IodT1zO3U8by5sZW5ndGg7dSsrKWMucHVzaCgiLi4iKTtyZXR1cm4oYz1jLmNvbmNhdChpLnNsaWNlKHMpKSkuam9pbigiLyIpfSx0LnNlcD0iLyIsdC5kZWxpbWl0ZXI9IjoiLHQuZGlybmFtZT1mdW5jdGlvbihlKXt2YXIgdD1vKGUpLHI9dFswXSxuPXRbMV07cmV0dXJuIHJ8fG4/KG4mJihuPW4uc3Vic3RyKDAsbi5sZW5ndGgtMSkpLHIrbik6Ii4ifSx0LmJhc2VuYW1lPWZ1bmN0aW9uKGUsdCl7dmFyIHI9byhlKVsyXTtyZXR1cm4gdCYmci5zdWJzdHIoLTEqdC5sZW5ndGgpPT09dCYmKHI9ci5zdWJzdHIoMCxyLmxlbmd0aC10Lmxlbmd0aCkpLHJ9LHQuZXh0bmFtZT1mdW5jdGlvbihlKXtyZXR1cm4gbyhlKVszXX07dmFyIGE9ImIiPT09ImFiIi5zdWJzdHIoLTEpP2Z1bmN0aW9uKGUsdCxyKXtyZXR1cm4gZS5zdWJzdHIodCxyKX06ZnVuY3Rpb24oZSx0LHIpe3JldHVybiB0PDAmJih0PWUubGVuZ3RoK3QpLGUuc3Vic3RyKHQscil9fSkuY2FsbCh0aGlzLHIoMTQpKX0sZnVuY3Rpb24oZSx0KXt2YXIgcixuLG89ZS5leHBvcnRzPXt9O2Z1bmN0aW9uIGkoKXt0aHJvdyBuZXcgRXJyb3IoInNldFRpbWVvdXQgaGFzIG5vdCBiZWVuIGRlZmluZWQiKX1mdW5jdGlvbiBhKCl7dGhyb3cgbmV3IEVycm9yKCJjbGVhclRpbWVvdXQgaGFzIG5vdCBiZWVuIGRlZmluZWQiKX1mdW5jdGlvbiBzKGUpe2lmKHI9PT1zZXRUaW1lb3V0KXJldHVybiBzZXRUaW1lb3V0KGUsMCk7aWYoKHI9PT1pfHwhcikmJnNldFRpbWVvdXQpcmV0dXJuIHI9c2V0VGltZW91dCxzZXRUaW1lb3V0KGUsMCk7dHJ5e3JldHVybiByKGUsMCl9Y2F0Y2godCl7dHJ5e3JldHVybiByLmNhbGwobnVsbCxlLDApfWNhdGNoKHQpe3JldHVybiByLmNhbGwodGhpcyxlLDApfX19IWZ1bmN0aW9uKCl7dHJ5e3I9ImZ1bmN0aW9uIj09dHlwZW9mIHNldFRpbWVvdXQ/c2V0VGltZW91dDppfWNhdGNoKGUpe3I9aX10cnl7bj0iZnVuY3Rpb24iPT10eXBlb2YgY2xlYXJUaW1lb3V0P2NsZWFyVGltZW91dDphfWNhdGNoKGUpe249YX19KCk7dmFyIHUsYz1bXSxsPSExLGY9LTE7ZnVuY3Rpb24gZCgpe2wmJnUmJihsPSExLHUubGVuZ3RoP2M9dS5jb25jYXQoYyk6Zj0tMSxjLmxlbmd0aCYmaCgpKX1mdW5jdGlvbiBoKCl7aWYoIWwpe3ZhciBlPXMoZCk7bD0hMDtmb3IodmFyIHQ9Yy5sZW5ndGg7dDspe2Zvcih1PWMsYz1bXTsrK2Y8dDspdSYmdVtmXS5ydW4oKTtmPS0xLHQ9Yy5sZW5ndGh9dT1udWxsLGw9ITEsZnVuY3Rpb24oZSl7aWYobj09PWNsZWFyVGltZW91dClyZXR1cm4gY2xlYXJUaW1lb3V0KGUpO2lmKChuPT09YXx8IW4pJiZjbGVhclRpbWVvdXQpcmV0dXJuIG49Y2xlYXJUaW1lb3V0LGNsZWFyVGltZW91dChlKTt0cnl7bihlKX1jYXRjaCh0KXt0cnl7cmV0dXJuIG4uY2FsbChudWxsLGUpfWNhdGNoKHQpe3JldHVybiBuLmNhbGwodGhpcyxlKX19fShlKX19ZnVuY3Rpb24gcChlLHQpe3RoaXMuZnVuPWUsdGhpcy5hcnJheT10fWZ1bmN0aW9uIG0oKXt9by5uZXh0VGljaz1mdW5jdGlvbihlKXt2YXIgdD1uZXcgQXJyYXkoYXJndW1lbnRzLmxlbmd0aC0xKTtpZihhcmd1bWVudHMubGVuZ3RoPjEpZm9yKHZhciByPTE7cjxhcmd1bWVudHMubGVuZ3RoO3IrKyl0W3ItMV09YXJndW1lbnRzW3JdO2MucHVzaChuZXcgcChlLHQpKSwxIT09Yy5sZW5ndGh8fGx8fHMoaCl9LHAucHJvdG90eXBlLnJ1bj1mdW5jdGlvbigpe3RoaXMuZnVuLmFwcGx5KG51bGwsdGhpcy5hcnJheSl9LG8udGl0bGU9ImJyb3dzZXIiLG8uYnJvd3Nlcj0hMCxvLmVudj17fSxvLmFyZ3Y9W10sby52ZXJzaW9uPSIiLG8udmVyc2lvbnM9e30sby5vbj1tLG8uYWRkTGlzdGVuZXI9bSxvLm9uY2U9bSxvLm9mZj1tLG8ucmVtb3ZlTGlzdGVuZXI9bSxvLnJlbW92ZUFsbExpc3RlbmVycz1tLG8uZW1pdD1tLG8ucHJlcGVuZExpc3RlbmVyPW0sby5wcmVwZW5kT25jZUxpc3RlbmVyPW0sby5saXN0ZW5lcnM9ZnVuY3Rpb24oZSl7cmV0dXJuW119LG8uYmluZGluZz1mdW5jdGlvbihlKXt0aHJvdyBuZXcgRXJyb3IoInByb2Nlc3MuYmluZGluZyBpcyBub3Qgc3VwcG9ydGVkIil9LG8uY3dkPWZ1bmN0aW9uKCl7cmV0dXJuIi8ifSxvLmNoZGlyPWZ1bmN0aW9uKGUpe3Rocm93IG5ldyBFcnJvcigicHJvY2Vzcy5jaGRpciBpcyBub3Qgc3VwcG9ydGVkIil9LG8udW1hc2s9ZnVuY3Rpb24oKXtyZXR1cm4gMH19XSl9KHQuZnMpO2NvbnN0IHI9ZS51bnBhY2tCcmlkZ2U7bGV0IG47dmFyIG89ZnVuY3Rpb24oZSl7Y29uc3QgdD17fTtjcmVkZW50aWFscz0ib21pdCI7dmFyIG4sbz12b2lkIDAhPT10P3Q6e30saT1yLkV4dCxhPXtvcGVuOmZ1bmN0aW9uKCl7cmV0dXJuIGkuY3VycmVudC5vcGVuLmFwcGx5KGkuY3VycmVudCxhcmd1bWVudHMpfSxjbG9zZTpmdW5jdGlvbigpe3JldHVybiBpLmN1cnJlbnQuY2xvc2UuYXBwbHkoaS5jdXJyZW50LGFyZ3VtZW50cyl9LHJlYWQ6ZnVuY3Rpb24oKXtyZXR1cm4gaS5jdXJyZW50LnJlYWQuYXBwbHkoaS5jdXJyZW50LGFyZ3VtZW50cyl9LHdyaXRlOmZ1bmN0aW9uKCl7cmV0dXJuIGkuY3VycmVudC53cml0ZS5hcHBseShpLmN1cnJlbnQsYXJndW1lbnRzKX0sdGVsbDpmdW5jdGlvbigpe3JldHVybiBpLmN1cnJlbnQudGVsbC5hcHBseShpLmN1cnJlbnQsYXJndW1lbnRzKX0sc2VlazpmdW5jdGlvbigpe3JldHVybiBpLmN1cnJlbnQuc2Vlay5hcHBseShpLmN1cnJlbnQsYXJndW1lbnRzKX0sY3JlYXRlOmZ1bmN0aW9uKCl7cmV0dXJuIGkuY3VycmVudC5jcmVhdGUuYXBwbHkoaS5jdXJyZW50LGFyZ3VtZW50cyl9fSxzPXt9O2ZvcihuIGluIG8pby5oYXNPd25Qcm9wZXJ0eShuKSYmKHNbbl09b1tuXSk7by5hcmd1bWVudHM9W10sby50aGlzUHJvZ3JhbT0iLi90aGlzLnByb2dyYW0iLG8ucXVpdD1mdW5jdGlvbihlLHQpe3Rocm93IHR9LG8ucHJlUnVuPVtdLG8ucG9zdFJ1bj1bXTt2YXIgdT0hMSxjPSExLGw9ITE7aWYoby5FTlZJUk9OTUVOVCl7aWYoIldFQiI9PT1vLkVOVklST05NRU5UKXU9ITA7ZWxzZSBpZigiV09SS0VSIj09PW8uRU5WSVJPTk1FTlQpYz0hMDtlbHNlIGlmKCJOT0RFIj09PW8uRU5WSVJPTk1FTlQpbD0hMDtlbHNlIGlmKCJTSEVMTCIhPT1vLkVOVklST05NRU5UKXRocm93IG5ldyBFcnJvcigiTW9kdWxlWydFTlZJUk9OTUVOVCddIHZhbHVlIGlzIG5vdCB2YWxpZC4gbXVzdCBiZSBvbmUgb2Y6IFdFQnxXT1JLRVJ8Tk9ERXxTSEVMTC4iKX1lbHNlIHU9Im9iamVjdCI9PXR5cGVvZiB3aW5kb3csYz0iZnVuY3Rpb24iPT10eXBlb2YgaW1wb3J0U2NyaXB0cyxsPSJvYmplY3QiPT10eXBlb2YgcHJvY2VzcyYmImZ1bmN0aW9uIj09dHlwZW9mIHJlcXVpcmUmJiF1JiYhYztmb3IobiBpbih1fHxjKSYmKG8ucmVhZD1mdW5jdGlvbihlKXt2YXIgdD1uZXcgWE1MSHR0cFJlcXVlc3Q7cmV0dXJuIHQub3BlbigiR0VUIixlLCExKSx0LnNlbmQobnVsbCksdC5yZXNwb25zZVRleHR9LGMmJihvLnJlYWRCaW5hcnk9ZnVuY3Rpb24oZSl7dmFyIHQ9bmV3IFhNTEh0dHBSZXF1ZXN0O3JldHVybiB0Lm9wZW4oIkdFVCIsZSwhMSksdC5yZXNwb25zZVR5cGU9ImFycmF5YnVmZmVyIix0LnNlbmQobnVsbCksbmV3IFVpbnQ4QXJyYXkodC5yZXNwb25zZSl9KSxvLnJlYWRBc3luYz1mdW5jdGlvbihlLHQscil7dmFyIG49bmV3IFhNTEh0dHBSZXF1ZXN0O24ub3BlbigiR0VUIixlLCEwKSxuLnJlc3BvbnNlVHlwZT0iYXJyYXlidWZmZXIiLG4ub25sb2FkPWZ1bmN0aW9uKCl7MjAwPT1uLnN0YXR1c3x8MD09bi5zdGF0dXMmJm4ucmVzcG9uc2U/dChuLnJlc3BvbnNlKTpyKCl9LG4ub25lcnJvcj1yLG4uc2VuZChudWxsKX0sby5zZXRXaW5kb3dUaXRsZT1mdW5jdGlvbihlKXtkb2N1bWVudC50aXRsZT1lfSksby5wcmludD0idW5kZWZpbmVkIiE9dHlwZW9mIGNvbnNvbGU/Y29uc29sZS5sb2cuYmluZChjb25zb2xlKToidW5kZWZpbmVkIiE9dHlwZW9mIHByaW50P3ByaW50Om51bGwsby5wcmludEVycj0idW5kZWZpbmVkIiE9dHlwZW9mIHByaW50RXJyP3ByaW50RXJyOiJ1bmRlZmluZWQiIT10eXBlb2YgY29uc29sZSYmY29uc29sZS53YXJuLmJpbmQoY29uc29sZSl8fG8ucHJpbnQsby5wcmludD1vLnByaW50LG8ucHJpbnRFcnI9by5wcmludEVycixzKXMuaGFzT3duUHJvcGVydHkobikmJihvW25dPXNbbl0pO3M9dm9pZCAwO2Z1bmN0aW9uIGYoZSl7eSgheCk7dmFyIHQ9TDtyZXR1cm4gTD1MK2UrMTUmLTE2LHR9ZnVuY3Rpb24gZChlKXt5KCQpO3ZhciB0PUZbJD4+Ml0scj10K2UrMTUmLTE2O2lmKChGWyQ+PjJdPXIscj49cSkmJiFIKCkpcmV0dXJuIEZbJD4+Ml09dCwwO3JldHVybiB0fWZ1bmN0aW9uIGgoZSx0KXtyZXR1cm4gdHx8KHQ9MTYpLGU9TWF0aC5jZWlsKGUvdCkqdH1mdW5jdGlvbiBwKGUpe3N3aXRjaChlKXtjYXNlImkxIjpjYXNlImk4IjpyZXR1cm4gMTtjYXNlImkxNiI6cmV0dXJuIDI7Y2FzZSJpMzIiOnJldHVybiA0O2Nhc2UiaTY0IjpyZXR1cm4gODtjYXNlImZsb2F0IjpyZXR1cm4gNDtjYXNlImRvdWJsZSI6cmV0dXJuIDg7ZGVmYXVsdDppZigiKiI9PT1lW2UubGVuZ3RoLTFdKXJldHVybiA0O2lmKCJpIj09PWVbMF0pe3ZhciB0PXBhcnNlSW50KGUuc3Vic3RyKDEpKTtyZXR1cm4geSh0JTg9PTApLHQvOH1yZXR1cm4gMH19bmV3IEFycmF5KDApO3ZhciBtPTA7ZnVuY3Rpb24geShlLHQpe2V8fHJyKCJBc3NlcnRpb24gZmFpbGVkOiAiK3QpfWZ1bmN0aW9uIEUoZSx0LHIsbil7c3dpdGNoKCIqIj09PShyPXJ8fCJpOCIpLmNoYXJBdChyLmxlbmd0aC0xKSYmKHI9ImkzMiIpLHIpe2Nhc2UiaTEiOmNhc2UiaTgiOlJbZT4+MF09dDticmVhaztjYXNlImkxNiI6Q1tlPj4xXT10O2JyZWFrO2Nhc2UiaTMyIjpGW2U+PjJdPXQ7YnJlYWs7Y2FzZSJpNjQiOnRlbXBJNjQ9W3Q+Pj4wLCh0ZW1wRG91YmxlPXQsK25lKHRlbXBEb3VibGUpPj0xP3RlbXBEb3VibGU+MD8oMHxhZSgraWUodGVtcERvdWJsZS80Mjk0OTY3Mjk2KSw0Mjk0OTY3Mjk1KSk+Pj4wOn5+K29lKCh0ZW1wRG91YmxlLSsofn50ZW1wRG91YmxlPj4+MCkpLzQyOTQ5NjcyOTYpPj4+MDowKV0sRltlPj4yXT10ZW1wSTY0WzBdLEZbZSs0Pj4yXT10ZW1wSTY0WzFdO2JyZWFrO2Nhc2UiZmxvYXQiOklbZT4+Ml09dDticmVhaztjYXNlImRvdWJsZSI6QltlPj4zXT10O2JyZWFrO2RlZmF1bHQ6cnIoImludmFsaWQgdHlwZSBmb3Igc2V0VmFsdWU6ICIrcil9fWZ1bmN0aW9uIGcoZSx0LHIsbil7dmFyIG8saTsibnVtYmVyIj09dHlwZW9mIGU/KG89ITAsaT1lKToobz0hMSxpPWUubGVuZ3RoKTt2YXIgYSxzPSJzdHJpbmciPT10eXBlb2YgdD90Om51bGw7aWYoYT00PT1yP246WyJmdW5jdGlvbiI9PXR5cGVvZiBKdD9KdDpmLFF0LGYsZF1bdm9pZCAwPT09cj8yOnJdKE1hdGgubWF4KGkscz8xOnQubGVuZ3RoKSksbyl7dmFyIHU7Zm9yKG49YSx5KDA9PSgzJmEpKSx1PWErKC00JmkpO248dTtuKz00KUZbbj4+Ml09MDtmb3IodT1hK2k7bjx1OylSW24rKz4+MF09MDtyZXR1cm4gYX1pZigiaTgiPT09cylyZXR1cm4gZS5zdWJhcnJheXx8ZS5zbGljZT9PLnNldChlLGEpOk8uc2V0KG5ldyBVaW50OEFycmF5KGUpLGEpLGE7Zm9yKHZhciBjLGwsaCxtPTA7bTxpOyl7dmFyIGc9ZVttXTswIT09KGM9c3x8dFttXSk/KCJpNjQiPT1jJiYoYz0iaTMyIiksRShhK20sZyxjKSxoIT09YyYmKGw9cChjKSxoPWMpLG0rPWwpOm0rK31yZXR1cm4gYX1mdW5jdGlvbiB2KGUsdCl7aWYoMD09PXR8fCFlKXJldHVybiIiO2Zvcih2YXIgcixuPTAsbz0wO258PXI9T1tlK28+PjBdLCgwIT1yfHx0KSYmKG8rKywhdHx8byE9dCk7KTt0fHwodD1vKTt2YXIgaT0iIjtpZihuPDEyOCl7Zm9yKHZhciBhO3Q+MDspYT1TdHJpbmcuZnJvbUNoYXJDb2RlLmFwcGx5KFN0cmluZyxPLnN1YmFycmF5KGUsZStNYXRoLm1pbih0LDEwMjQpKSksaT1pP2krYTphLGUrPTEwMjQsdC09MTAyNDtyZXR1cm4gaX1yZXR1cm4gYihlKX12YXIgdz0idW5kZWZpbmVkIiE9dHlwZW9mIFRleHREZWNvZGVyP25ldyBUZXh0RGVjb2RlcigidXRmOCIpOnZvaWQgMDtmdW5jdGlvbiBfKGUsdCl7Zm9yKHZhciByPXQ7ZVtyXTspKytyO2lmKHItdD4xNiYmZS5zdWJhcnJheSYmdylyZXR1cm4gdy5kZWNvZGUoZS5zdWJhcnJheSh0LHIpKTtmb3IodmFyIG4sbyxpLGEscyx1PSIiOzspe2lmKCEobj1lW3QrK10pKXJldHVybiB1O2lmKDEyOCZuKWlmKG89NjMmZVt0KytdLDE5MiE9KDIyNCZuKSlpZihpPTYzJmVbdCsrXSwyMjQ9PSgyNDAmbik/bj0oMTUmbik8PDEyfG88PDZ8aTooYT02MyZlW3QrK10sMjQwPT0oMjQ4Jm4pP249KDcmbik8PDE4fG88PDEyfGk8PDZ8YToocz02MyZlW3QrK10sbj0yNDg9PSgyNTImbik/KDMmbik8PDI0fG88PDE4fGk8PDEyfGE8PDZ8czooMSZuKTw8MzB8bzw8MjR8aTw8MTh8YTw8MTJ8czw8Nnw2MyZlW3QrK10pKSxuPDY1NTM2KXUrPVN0cmluZy5mcm9tQ2hhckNvZGUobik7ZWxzZXt2YXIgYz1uLTY1NTM2O3UrPVN0cmluZy5mcm9tQ2hhckNvZGUoNTUyOTZ8Yz4+MTAsNTYzMjB8MTAyMyZjKX1lbHNlIHUrPVN0cmluZy5mcm9tQ2hhckNvZGUoKDMxJm4pPDw2fG8pO2Vsc2UgdSs9U3RyaW5nLmZyb21DaGFyQ29kZShuKX19ZnVuY3Rpb24gYihlKXtyZXR1cm4gXyhPLGUpfWZ1bmN0aW9uIEEoZSx0LHIsbil7aWYoIShuPjApKXJldHVybiAwO2Zvcih2YXIgbz1yLGk9cituLTEsYT0wO2E8ZS5sZW5ndGg7KythKXt2YXIgcz1lLmNoYXJDb2RlQXQoYSk7aWYocz49NTUyOTYmJnM8PTU3MzQzJiYocz02NTUzNisoKDEwMjMmcyk8PDEwKXwxMDIzJmUuY2hhckNvZGVBdCgrK2EpKSxzPD0xMjcpe2lmKHI+PWkpYnJlYWs7dFtyKytdPXN9ZWxzZSBpZihzPD0yMDQ3KXtpZihyKzE+PWkpYnJlYWs7dFtyKytdPTE5MnxzPj42LHRbcisrXT0xMjh8NjMmc31lbHNlIGlmKHM8PTY1NTM1KXtpZihyKzI+PWkpYnJlYWs7dFtyKytdPTIyNHxzPj4xMix0W3IrK109MTI4fHM+PjYmNjMsdFtyKytdPTEyOHw2MyZzfWVsc2UgaWYoczw9MjA5NzE1MSl7aWYociszPj1pKWJyZWFrO3RbcisrXT0yNDB8cz4+MTgsdFtyKytdPTEyOHxzPj4xMiY2Myx0W3IrK109MTI4fHM+PjYmNjMsdFtyKytdPTEyOHw2MyZzfWVsc2UgaWYoczw9NjcxMDg4NjMpe2lmKHIrND49aSlicmVhazt0W3IrK109MjQ4fHM+PjI0LHRbcisrXT0xMjh8cz4+MTgmNjMsdFtyKytdPTEyOHxzPj4xMiY2Myx0W3IrK109MTI4fHM+PjYmNjMsdFtyKytdPTEyOHw2MyZzfWVsc2V7aWYocis1Pj1pKWJyZWFrO3RbcisrXT0yNTJ8cz4+MzAsdFtyKytdPTEyOHxzPj4yNCY2Myx0W3IrK109MTI4fHM+PjE4JjYzLHRbcisrXT0xMjh8cz4+MTImNjMsdFtyKytdPTEyOHxzPj42JjYzLHRbcisrXT0xMjh8NjMmc319cmV0dXJuIHRbcl09MCxyLW99ZnVuY3Rpb24gVChlLHQscil7cmV0dXJuIEEoZSxPLHQscil9ZnVuY3Rpb24gUyhlKXtmb3IodmFyIHQ9MCxyPTA7cjxlLmxlbmd0aDsrK3Ipe3ZhciBuPWUuY2hhckNvZGVBdChyKTtuPj01NTI5NiYmbjw9NTczNDMmJihuPTY1NTM2KygoMTAyMyZuKTw8MTApfDEwMjMmZS5jaGFyQ29kZUF0KCsrcikpLG48PTEyNz8rK3Q6dCs9bjw9MjA0Nz8yOm48PTY1NTM1PzM6bjw9MjA5NzE1MT80Om48PTY3MTA4ODYzPzU6Nn1yZXR1cm4gdH0idW5kZWZpbmVkIiE9dHlwZW9mIFRleHREZWNvZGVyJiZuZXcgVGV4dERlY29kZXIoInV0Zi0xNmxlIik7ZnVuY3Rpb24gayhlKXtmb3IodmFyIHQ9MCxyPSIiOzspe3ZhciBuPUZbZSs0KnQ+PjJdO2lmKDA9PW4pcmV0dXJuIHI7aWYoKyt0LG4+PTY1NTM2KXt2YXIgbz1uLTY1NTM2O3IrPVN0cmluZy5mcm9tQ2hhckNvZGUoNTUyOTZ8bz4+MTAsNTYzMjB8MTAyMyZvKX1lbHNlIHIrPVN0cmluZy5mcm9tQ2hhckNvZGUobil9fWZ1bmN0aW9uIFAoKXt2YXIgZT1mdW5jdGlvbigpe3ZhciBlPW5ldyBFcnJvcjtpZighZS5zdGFjayl7dHJ5e3Rocm93IG5ldyBFcnJvcigwKX1jYXRjaCh0KXtlPXR9aWYoIWUuc3RhY2spcmV0dXJuIihubyBzdGFjayB0cmFjZSBhdmFpbGFibGUpIn1yZXR1cm4gZS5zdGFjay50b1N0cmluZygpfSgpO3JldHVybiBvLmV4dHJhU3RhY2tUcmFjZSYmKGUrPSJcbiIrby5leHRyYVN0YWNrVHJhY2UoKSksZS5yZXBsYWNlKC9fX1pbXHdcZF9dKy9nLChmdW5jdGlvbihlKXtyZXR1cm4gZT09ZT9lOmUrIiBbIitlKyJdIn0pKX12YXIgRCxSLE8sQyxOLEYsTSxJLEIsTCx4LGosVSx6LCQ7ZnVuY3Rpb24gVyhlLHQpe3JldHVybiBlJXQ+MCYmKGUrPXQtZSV0KSxlfWZ1bmN0aW9uIFkoZSl7by5idWZmZXI9RD1lfWZ1bmN0aW9uIFYoKXtvLkhFQVA4PVI9bmV3IEludDhBcnJheShEKSxvLkhFQVAxNj1DPW5ldyBJbnQxNkFycmF5KEQpLG8uSEVBUDMyPUY9bmV3IEludDMyQXJyYXkoRCksby5IRUFQVTg9Tz1uZXcgVWludDhBcnJheShEKSxvLkhFQVBVMTY9Tj1uZXcgVWludDE2QXJyYXkoRCksby5IRUFQVTMyPU09bmV3IFVpbnQzMkFycmF5KEQpLG8uSEVBUEYzMj1JPW5ldyBGbG9hdDMyQXJyYXkoRCksby5IRUFQRjY0PUI9bmV3IEZsb2F0NjRBcnJheShEKX1mdW5jdGlvbiBIKCl7dmFyIGU9by51c2luZ1dhc20/NjU1MzY6MTY3NzcyMTYsdD0yMTQ3NDgzNjQ4LWU7aWYoRlskPj4yXT50KXJldHVybiExO3ZhciByPXE7Zm9yKHE9TWF0aC5tYXgocSwxNjc3NzIxNik7cTxGWyQ+PjJdOylxPXE8PTUzNjg3MDkxMj9XKDIqcSxlKTpNYXRoLm1pbihXKCgzKnErMjE0NzQ4MzY0OCkvNCxlKSx0KTt2YXIgbj1vLnJlYWxsb2NCdWZmZXIocSk7cmV0dXJuIG4mJm4uYnl0ZUxlbmd0aD09cT8oWShuKSxWKCksITApOihxPXIsITEpfUw9VT0kPTAseD0hMSxvLnJlYWxsb2NCdWZmZXJ8fChvLnJlYWxsb2NCdWZmZXI9ZnVuY3Rpb24oZSl7dmFyIHQ7dHJ5e2lmKEFycmF5QnVmZmVyLnRyYW5zZmVyKXQ9QXJyYXlCdWZmZXIudHJhbnNmZXIoRCxlKTtlbHNle3ZhciByPVI7dD1uZXcgQXJyYXlCdWZmZXIoZSksbmV3IEludDhBcnJheSh0KS5zZXQocil9fWNhdGNoKGUpe3JldHVybiExfXJldHVybiEhWHQodCkmJnR9KTt0cnl7RnVuY3Rpb24ucHJvdG90eXBlLmNhbGwuYmluZChPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKEFycmF5QnVmZmVyLnByb3RvdHlwZSwiYnl0ZUxlbmd0aCIpLmdldCkobmV3IEFycmF5QnVmZmVyKDQpKX1jYXRjaChlKXsoZnVuY3Rpb24oZSl7cmV0dXJuIGUuYnl0ZUxlbmd0aH0pfXZhciBHPW8uVE9UQUxfU1RBQ0t8fDUyNDI4ODAscT1vLlRPVEFMX01FTU9SWXx8MTY3NzcyMTY7aWYocTxHJiZvLnByaW50RXJyKCJUT1RBTF9NRU1PUlkgc2hvdWxkIGJlIGxhcmdlciB0aGFuIFRPVEFMX1NUQUNLLCB3YXMgIitxKyIhIChUT1RBTF9TVEFDSz0iK0crIikiKSxvLmJ1ZmZlcj9EPW8uYnVmZmVyOigib2JqZWN0Ij09dHlwZW9mIFdlYkFzc2VtYmx5JiYiZnVuY3Rpb24iPT10eXBlb2YgV2ViQXNzZW1ibHkuTWVtb3J5PyhvLndhc21NZW1vcnk9bmV3IFdlYkFzc2VtYmx5Lk1lbW9yeSh7aW5pdGlhbDpxLzY1NTM2fSksRD1vLndhc21NZW1vcnkuYnVmZmVyKTpEPW5ldyBBcnJheUJ1ZmZlcihxKSxvLmJ1ZmZlcj1EKSxWKCksRlswXT0xNjY4NTA5MDI5LENbMV09MjU0NTksMTE1IT09T1syXXx8OTkhPT1PWzNdKXRocm93IlJ1bnRpbWUgZXJyb3I6IGV4cGVjdGVkIHRoZSBzeXN0ZW0gdG8gYmUgbGl0dGxlLWVuZGlhbiEiO2Z1bmN0aW9uIFgoZSl7Zm9yKDtlLmxlbmd0aD4wOyl7dmFyIHQ9ZS5zaGlmdCgpO2lmKCJmdW5jdGlvbiIhPXR5cGVvZiB0KXt2YXIgcj10LmZ1bmM7Im51bWJlciI9PXR5cGVvZiByP3ZvaWQgMD09PXQuYXJnP28uZHluQ2FsbF92KHIpOm8uZHluQ2FsbF92aShyLHQuYXJnKTpyKHZvaWQgMD09PXQuYXJnP251bGw6dC5hcmcpfWVsc2UgdCgpfX12YXIgSz1bXSxKPVtdLFo9W10sUT1bXSxlZT1bXSx0ZT0hMTtmdW5jdGlvbiByZShlLHQscil7Zm9yKHZhciBuPTA7bjxlLmxlbmd0aDsrK24pUlt0Kys+PjBdPWUuY2hhckNvZGVBdChuKTtyfHwoUlt0Pj4wXT0wKX12YXIgbmU9TWF0aC5hYnMsb2U9TWF0aC5jZWlsLGllPU1hdGguZmxvb3IsYWU9TWF0aC5taW4sc2U9MCx1ZT1udWxsO2Z1bmN0aW9uIGNlKGUpe3NlKyssby5tb25pdG9yUnVuRGVwZW5kZW5jaWVzJiZvLm1vbml0b3JSdW5EZXBlbmRlbmNpZXMoc2UpfWZ1bmN0aW9uIGxlKGUpe2lmKHNlLS0sby5tb25pdG9yUnVuRGVwZW5kZW5jaWVzJiZvLm1vbml0b3JSdW5EZXBlbmRlbmNpZXMoc2UpLDA9PXNlJiZ1ZSl7dmFyIHQ9dWU7dWU9bnVsbCx0KCl9fW8ucHJlbG9hZGVkSW1hZ2VzPXt9LG8ucHJlbG9hZGVkQXVkaW9zPXt9O2Z1bmN0aW9uIGZlKGUpe3JldHVybiBTdHJpbmcucHJvdG90eXBlLnN0YXJ0c1dpdGg/ZS5zdGFydHNXaXRoKCJkYXRhOmFwcGxpY2F0aW9uL29jdGV0LXN0cmVhbTtiYXNlNjQsIik6MD09PWUuaW5kZXhPZigiZGF0YTphcHBsaWNhdGlvbi9vY3RldC1zdHJlYW07YmFzZTY0LCIpfSFmdW5jdGlvbigpe3ZhciB0PSJ1bnBhY2sud2FzdCIscj0idW5wYWNrLnRlbXAuYXNtLmpzIjsiZnVuY3Rpb24iPT10eXBlb2Ygby5sb2NhdGVGaWxlJiYoZmUodCl8fCh0PW8ubG9jYXRlRmlsZSh0KSksZmUoZSl8fChlPW8ubG9jYXRlRmlsZShlKSksZmUocil8fChyPW8ubG9jYXRlRmlsZShyKSkpO3ZhciBuPXtnbG9iYWw6bnVsbCxlbnY6bnVsbCxhc20yd2FzbTp7ImY2NC1yZW0iOmZ1bmN0aW9uKGUsdCl7cmV0dXJuIGUldH0sZGVidWdnZXI6ZnVuY3Rpb24oKXt9fSxwYXJlbnQ6b30saT1udWxsO2Z1bmN0aW9uIGEoKXt0cnl7aWYoby53YXNtQmluYXJ5KXJldHVybiBuZXcgVWludDhBcnJheShvLndhc21CaW5hcnkpO2lmKG8ucmVhZEJpbmFyeSlyZXR1cm4gby5yZWFkQmluYXJ5KGUpO3Rocm93Im9uIHRoZSB3ZWIsIHdlIG5lZWQgdGhlIHdhc20gYmluYXJ5IHRvIGJlIHByZWxvYWRlZCBhbmQgc2V0IG9uIE1vZHVsZVsnd2FzbUJpbmFyeSddLiBlbWNjLnB5IHdpbGwgZG8gdGhhdCBmb3IgeW91IHdoZW4gZ2VuZXJhdGluZyBIVE1MIChidXQgbm90IEpTKSJ9Y2F0Y2goZSl7cnIoZSl9fWZ1bmN0aW9uIHModCxyLHMpe2lmKCJvYmplY3QiIT10eXBlb2YgV2ViQXNzZW1ibHkpcmV0dXJuIG8ucHJpbnRFcnIoIm5vIG5hdGl2ZSB3YXNtIHN1cHBvcnQgZGV0ZWN0ZWQiKSwhMTtpZighKG8ud2FzbU1lbW9yeSBpbnN0YW5jZW9mIFdlYkFzc2VtYmx5Lk1lbW9yeSkpcmV0dXJuIG8ucHJpbnRFcnIoIm5vIG5hdGl2ZSB3YXNtIE1lbW9yeSBpbiB1c2UiKSwhMTtmdW5jdGlvbiBsKGUsdCl7KGk9ZS5leHBvcnRzKS5tZW1vcnkmJmZ1bmN0aW9uKGUpe3ZhciB0PW8uYnVmZmVyO2UuYnl0ZUxlbmd0aDx0LmJ5dGVMZW5ndGgmJm8ucHJpbnRFcnIoInRoZSBuZXcgYnVmZmVyIGluIG1lcmdlTWVtb3J5IGlzIHNtYWxsZXIgdGhhbiB0aGUgcHJldmlvdXMgb25lLiBpbiBuYXRpdmUgd2FzbSwgd2Ugc2hvdWxkIGdyb3cgbWVtb3J5IGhlcmUiKTt2YXIgcj1uZXcgSW50OEFycmF5KHQpO25ldyBJbnQ4QXJyYXkoZSkuc2V0KHIpLFkoZSksVigpfShpLm1lbW9yeSksby5hc209aSxvLnVzaW5nV2FzbT0hMCxsZSgpfWlmKHIubWVtb3J5PW8ud2FzbU1lbW9yeSxuLmdsb2JhbD17TmFOOk5hTixJbmZpbml0eToxLzB9LG5bImdsb2JhbC5NYXRoIl09TWF0aCxuLmVudj1yLGNlKCksby5pbnN0YW50aWF0ZVdhc20pdHJ5e3JldHVybiBvLmluc3RhbnRpYXRlV2FzbShuLGwpfWNhdGNoKGUpe3JldHVybiBvLnByaW50RXJyKCJNb2R1bGUuaW5zdGFudGlhdGVXYXNtIGNhbGxiYWNrIGZhaWxlZCB3aXRoIGVycm9yOiAiK2UpLCExfWZ1bmN0aW9uIGYoZSl7bChlLmluc3RhbmNlLGUubW9kdWxlKX1mdW5jdGlvbiBkKHQpeyhvLndhc21CaW5hcnl8fCF1JiYhY3x8ImZ1bmN0aW9uIiE9dHlwZW9mIGZldGNoP25ldyBQcm9taXNlKChmdW5jdGlvbihlLHQpe2UoYSgpKX0pKTpmZXRjaChlLHtjcmVkZW50aWFsczoib21pdCJ9KS50aGVuKChmdW5jdGlvbih0KXtpZighdC5vayl0aHJvdyJmYWlsZWQgdG8gbG9hZCB3YXNtIGJpbmFyeSBmaWxlIGF0ICciK2UrIiciO3JldHVybiB0LmFycmF5QnVmZmVyKCl9KSkuY2F0Y2goKGZ1bmN0aW9uKCl7cmV0dXJuIGEoKX0pKSkudGhlbigoZnVuY3Rpb24oZSl7cmV0dXJuIFdlYkFzc2VtYmx5Lmluc3RhbnRpYXRlKGUsbil9KSkudGhlbih0KS5jYXRjaCgoZnVuY3Rpb24oZSl7by5wcmludEVycigiZmFpbGVkIHRvIGFzeW5jaHJvbm91c2x5IHByZXBhcmUgd2FzbTogIitlKSxycihlKX0pKX1yZXR1cm4gby53YXNtQmluYXJ5fHwiZnVuY3Rpb24iIT10eXBlb2YgV2ViQXNzZW1ibHkuaW5zdGFudGlhdGVTdHJlYW1pbmd8fGZlKGUpfHwiZnVuY3Rpb24iIT10eXBlb2YgZmV0Y2g/ZChmKTpXZWJBc3NlbWJseS5pbnN0YW50aWF0ZVN0cmVhbWluZyhmZXRjaChlLHtjcmVkZW50aWFsczoib21pdCJ9KSxuKS50aGVuKGYpLmNhdGNoKChmdW5jdGlvbihlKXtvLnByaW50RXJyKCJ3YXNtIHN0cmVhbWluZyBjb21waWxlIGZhaWxlZDogIitlKSxvLnByaW50RXJyKCJmYWxsaW5nIGJhY2sgdG8gQXJyYXlCdWZmZXIgaW5zdGFudGlhdGlvbiIpLGQoZil9KSkse319by5hc21QcmVsb2FkPW8uYXNtLG8ucmVhbGxvY0J1ZmZlcj1mdW5jdGlvbihlKXtyZXR1cm4gZnVuY3Rpb24oZSl7ZT1XKGUsby51c2luZ1dhc20/NjU1MzY6MTY3NzcyMTYpO3ZhciB0PW8uYnVmZmVyLmJ5dGVMZW5ndGg7aWYoby51c2luZ1dhc20pdHJ5e3JldHVybi0xIT09by53YXNtTWVtb3J5Lmdyb3coKGUtdCkvNjU1MzYpP28uYnVmZmVyPW8ud2FzbU1lbW9yeS5idWZmZXI6bnVsbH1jYXRjaChlKXtyZXR1cm4gbnVsbH19KGUpfSxvLmFzbT1mdW5jdGlvbihlLHQscil7aWYoISh0PXQpLnRhYmxlKXt2YXIgbj1vLndhc21UYWJsZVNpemU7dm9pZCAwPT09biYmKG49MTAyNCk7dmFyIGk9by53YXNtTWF4VGFibGVTaXplOyJvYmplY3QiPT10eXBlb2YgV2ViQXNzZW1ibHkmJiJmdW5jdGlvbiI9PXR5cGVvZiBXZWJBc3NlbWJseS5UYWJsZT90LnRhYmxlPXZvaWQgMCE9PWk/bmV3IFdlYkFzc2VtYmx5LlRhYmxlKHtpbml0aWFsOm4sbWF4aW11bTppLGVsZW1lbnQ6ImFueWZ1bmMifSk6bmV3IFdlYkFzc2VtYmx5LlRhYmxlKHtpbml0aWFsOm4sZWxlbWVudDoiYW55ZnVuYyJ9KTp0LnRhYmxlPW5ldyBBcnJheShuKSxvLndhc21UYWJsZT10LnRhYmxlfXZhciBhO3JldHVybiB0Lm1lbW9yeUJhc2V8fCh0Lm1lbW9yeUJhc2U9by5TVEFUSUNfQkFTRSksdC50YWJsZUJhc2V8fCh0LnRhYmxlQmFzZT0wKSwoYT1zKDAsdCkpfHxycigibm8gYmluYXJ5ZW4gbWV0aG9kIHN1Y2NlZWRlZC4gY29uc2lkZXIgZW5hYmxpbmcgbW9yZSBvcHRpb25zLCBsaWtlIGludGVycHJldGluZywgaWYgeW91IHdhbnQgdGhhdDogaHR0cHM6Ly9naXRodWIuY29tL2tyaXBrZW4vZW1zY3JpcHRlbi93aWtpL1dlYkFzc2VtYmx5I2JpbmFyeWVuLW1ldGhvZHMiKSxhfX0oKSxMPTY3OTg0LEoucHVzaCh7ZnVuYzpmdW5jdGlvbigpe0d0KCl9fSx7ZnVuYzpmdW5jdGlvbigpe0h0KCl9fSx7ZnVuYzpmdW5jdGlvbigpe1Z0KCl9fSx7ZnVuYzpmdW5jdGlvbigpe1l0KCl9fSk7by5TVEFUSUNfQkFTRT0xMDI0LG8uU1RBVElDX0JVTVA9NjY5NjAsTCs9MTY7dmFyIGRlPXtsYXN0OjAsY2F1Z2h0OltdLGluZm9zOnt9LGRlQWRqdXN0OmZ1bmN0aW9uKGUpe2lmKCFlfHxkZS5pbmZvc1tlXSlyZXR1cm4gZTtmb3IodmFyIHQgaW4gZGUuaW5mb3Mpe3ZhciByPSt0O2lmKGRlLmluZm9zW3JdLmFkanVzdGVkPT09ZSlyZXR1cm4gcn1yZXR1cm4gZX0sYWRkUmVmOmZ1bmN0aW9uKGUpe2UmJmRlLmluZm9zW2VdLnJlZmNvdW50Kyt9LGRlY1JlZjpmdW5jdGlvbihlKXtpZihlKXt2YXIgdD1kZS5pbmZvc1tlXTt5KHQucmVmY291bnQ+MCksdC5yZWZjb3VudC0tLDAhPT10LnJlZmNvdW50fHx0LnJldGhyb3dufHwodC5kZXN0cnVjdG9yJiZvLmR5bkNhbGxfdmkodC5kZXN0cnVjdG9yLGUpLGRlbGV0ZSBkZS5pbmZvc1tlXSxoZShlKSl9fSxjbGVhclJlZjpmdW5jdGlvbihlKXtlJiYoZGUuaW5mb3NbZV0ucmVmY291bnQ9MCl9fTtmdW5jdGlvbiBoZShlKXt0cnl7cmV0dXJuIEt0KGUpfWNhdGNoKGUpe319ZnVuY3Rpb24gcGUoKXt2YXIgZT1kZS5sYXN0O2lmKCFlKXJldHVybiAwfChadCgwKSwwKTt2YXIgdD1kZS5pbmZvc1tlXSxyPXQudHlwZTtpZighcilyZXR1cm4gMHwoWnQoMCksZSk7dmFyIG49QXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKTtvLl9fX2N4YV9pc19wb2ludGVyX3R5cGUocik7cGUuYnVmZmVyfHwocGUuYnVmZmVyPUp0KDQpKSxGW3BlLmJ1ZmZlcj4+Ml09ZSxlPXBlLmJ1ZmZlcjtmb3IodmFyIGk9MDtpPG4ubGVuZ3RoO2krKylpZihuW2ldJiZvLl9fX2N4YV9jYW5fY2F0Y2gobltpXSxyLGUpKXJldHVybiBlPUZbZT4+Ml0sdC5hZGp1c3RlZD1lLDB8KFp0KG5baV0pLGUpO3JldHVybiBlPUZbZT4+Ml0sMHwoWnQociksZSl9dmFyIG1lPXtFUEVSTToxLEVOT0VOVDoyLEVTUkNIOjMsRUlOVFI6NCxFSU86NSxFTlhJTzo2LEUyQklHOjcsRU5PRVhFQzo4LEVCQURGOjksRUNISUxEOjEwLEVBR0FJTjoxMSxFV09VTERCTE9DSzoxMSxFTk9NRU06MTIsRUFDQ0VTOjEzLEVGQVVMVDoxNCxFTk9UQkxLOjE1LEVCVVNZOjE2LEVFWElTVDoxNyxFWERFVjoxOCxFTk9ERVY6MTksRU5PVERJUjoyMCxFSVNESVI6MjEsRUlOVkFMOjIyLEVORklMRToyMyxFTUZJTEU6MjQsRU5PVFRZOjI1LEVUWFRCU1k6MjYsRUZCSUc6MjcsRU5PU1BDOjI4LEVTUElQRToyOSxFUk9GUzozMCxFTUxJTks6MzEsRVBJUEU6MzIsRURPTTozMyxFUkFOR0U6MzQsRU5PTVNHOjQyLEVJRFJNOjQzLEVDSFJORzo0NCxFTDJOU1lOQzo0NSxFTDNITFQ6NDYsRUwzUlNUOjQ3LEVMTlJORzo0OCxFVU5BVENIOjQ5LEVOT0NTSTo1MCxFTDJITFQ6NTEsRURFQURMSzozNSxFTk9MQ0s6MzcsRUJBREU6NTIsRUJBRFI6NTMsRVhGVUxMOjU0LEVOT0FOTzo1NSxFQkFEUlFDOjU2LEVCQURTTFQ6NTcsRURFQURMT0NLOjM1LEVCRk9OVDo1OSxFTk9TVFI6NjAsRU5PREFUQTo2MSxFVElNRTo2MixFTk9TUjo2MyxFTk9ORVQ6NjQsRU5PUEtHOjY1LEVSRU1PVEU6NjYsRU5PTElOSzo2NyxFQURWOjY4LEVTUk1OVDo2OSxFQ09NTTo3MCxFUFJPVE86NzEsRU1VTFRJSE9QOjcyLEVET1RET1Q6NzMsRUJBRE1TRzo3NCxFTk9UVU5JUTo3NixFQkFERkQ6NzcsRVJFTUNIRzo3OCxFTElCQUNDOjc5LEVMSUJCQUQ6ODAsRUxJQlNDTjo4MSxFTElCTUFYOjgyLEVMSUJFWEVDOjgzLEVOT1NZUzozOCxFTk9URU1QVFk6MzksRU5BTUVUT09MT05HOjM2LEVMT09QOjQwLEVPUE5PVFNVUFA6OTUsRVBGTk9TVVBQT1JUOjk2LEVDT05OUkVTRVQ6MTA0LEVOT0JVRlM6MTA1LEVBRk5PU1VQUE9SVDo5NyxFUFJPVE9UWVBFOjkxLEVOT1RTT0NLOjg4LEVOT1BST1RPT1BUOjkyLEVTSFVURE9XTjoxMDgsRUNPTk5SRUZVU0VEOjExMSxFQUREUklOVVNFOjk4LEVDT05OQUJPUlRFRDoxMDMsRU5FVFVOUkVBQ0g6MTAxLEVORVRET1dOOjEwMCxFVElNRURPVVQ6MTEwLEVIT1NURE9XTjoxMTIsRUhPU1RVTlJFQUNIOjExMyxFSU5QUk9HUkVTUzoxMTUsRUFMUkVBRFk6MTE0LEVERVNUQUREUlJFUTo4OSxFTVNHU0laRTo5MCxFUFJPVE9OT1NVUFBPUlQ6OTMsRVNPQ0tUTk9TVVBQT1JUOjk0LEVBRERSTk9UQVZBSUw6OTksRU5FVFJFU0VUOjEwMixFSVNDT05OOjEwNixFTk9UQ09OTjoxMDcsRVRPT01BTllSRUZTOjEwOSxFVVNFUlM6ODcsRURRVU9UOjEyMixFU1RBTEU6MTE2LEVOT1RTVVA6OTUsRU5PTUVESVVNOjEyMyxFSUxTRVE6ODQsRU9WRVJGTE9XOjc1LEVDQU5DRUxFRDoxMjUsRU5PVFJFQ09WRVJBQkxFOjEzMSxFT1dORVJERUFEOjEzMCxFU1RSUElQRTo4Nn07ZnVuY3Rpb24geWUoZSl7cmV0dXJuIG8uX19fZXJybm9fbG9jYXRpb24mJihGW28uX19fZXJybm9fbG9jYXRpb24oKT4+Ml09ZSksZX12YXIgRWU9ezA6IlN1Y2Nlc3MiLDE6Ik5vdCBzdXBlci11c2VyIiwyOiJObyBzdWNoIGZpbGUgb3IgZGlyZWN0b3J5IiwzOiJObyBzdWNoIHByb2Nlc3MiLDQ6IkludGVycnVwdGVkIHN5c3RlbSBjYWxsIiw1OiJJL08gZXJyb3IiLDY6Ik5vIHN1Y2ggZGV2aWNlIG9yIGFkZHJlc3MiLDc6IkFyZyBsaXN0IHRvbyBsb25nIiw4OiJFeGVjIGZvcm1hdCBlcnJvciIsOToiQmFkIGZpbGUgbnVtYmVyIiwxMDoiTm8gY2hpbGRyZW4iLDExOiJObyBtb3JlIHByb2Nlc3NlcyIsMTI6Ik5vdCBlbm91Z2ggY29yZSIsMTM6IlBlcm1pc3Npb24gZGVuaWVkIiwxNDoiQmFkIGFkZHJlc3MiLDE1OiJCbG9jayBkZXZpY2UgcmVxdWlyZWQiLDE2OiJNb3VudCBkZXZpY2UgYnVzeSIsMTc6IkZpbGUgZXhpc3RzIiwxODoiQ3Jvc3MtZGV2aWNlIGxpbmsiLDE5OiJObyBzdWNoIGRldmljZSIsMjA6Ik5vdCBhIGRpcmVjdG9yeSIsMjE6IklzIGEgZGlyZWN0b3J5IiwyMjoiSW52YWxpZCBhcmd1bWVudCIsMjM6IlRvbyBtYW55IG9wZW4gZmlsZXMgaW4gc3lzdGVtIiwyNDoiVG9vIG1hbnkgb3BlbiBmaWxlcyIsMjU6Ik5vdCBhIHR5cGV3cml0ZXIiLDI2OiJUZXh0IGZpbGUgYnVzeSIsMjc6IkZpbGUgdG9vIGxhcmdlIiwyODoiTm8gc3BhY2UgbGVmdCBvbiBkZXZpY2UiLDI5OiJJbGxlZ2FsIHNlZWsiLDMwOiJSZWFkIG9ubHkgZmlsZSBzeXN0ZW0iLDMxOiJUb28gbWFueSBsaW5rcyIsMzI6IkJyb2tlbiBwaXBlIiwzMzoiTWF0aCBhcmcgb3V0IG9mIGRvbWFpbiBvZiBmdW5jIiwzNDoiTWF0aCByZXN1bHQgbm90IHJlcHJlc2VudGFibGUiLDM1OiJGaWxlIGxvY2tpbmcgZGVhZGxvY2sgZXJyb3IiLDM2OiJGaWxlIG9yIHBhdGggbmFtZSB0b28gbG9uZyIsMzc6Ik5vIHJlY29yZCBsb2NrcyBhdmFpbGFibGUiLDM4OiJGdW5jdGlvbiBub3QgaW1wbGVtZW50ZWQiLDM5OiJEaXJlY3Rvcnkgbm90IGVtcHR5Iiw0MDoiVG9vIG1hbnkgc3ltYm9saWMgbGlua3MiLDQyOiJObyBtZXNzYWdlIG9mIGRlc2lyZWQgdHlwZSIsNDM6IklkZW50aWZpZXIgcmVtb3ZlZCIsNDQ6IkNoYW5uZWwgbnVtYmVyIG91dCBvZiByYW5nZSIsNDU6IkxldmVsIDIgbm90IHN5bmNocm9uaXplZCIsNDY6IkxldmVsIDMgaGFsdGVkIiw0NzoiTGV2ZWwgMyByZXNldCIsNDg6IkxpbmsgbnVtYmVyIG91dCBvZiByYW5nZSIsNDk6IlByb3RvY29sIGRyaXZlciBub3QgYXR0YWNoZWQiLDUwOiJObyBDU0kgc3RydWN0dXJlIGF2YWlsYWJsZSIsNTE6IkxldmVsIDIgaGFsdGVkIiw1MjoiSW52YWxpZCBleGNoYW5nZSIsNTM6IkludmFsaWQgcmVxdWVzdCBkZXNjcmlwdG9yIiw1NDoiRXhjaGFuZ2UgZnVsbCIsNTU6Ik5vIGFub2RlIiw1NjoiSW52YWxpZCByZXF1ZXN0IGNvZGUiLDU3OiJJbnZhbGlkIHNsb3QiLDU5OiJCYWQgZm9udCBmaWxlIGZtdCIsNjA6IkRldmljZSBub3QgYSBzdHJlYW0iLDYxOiJObyBkYXRhIChmb3Igbm8gZGVsYXkgaW8pIiw2MjoiVGltZXIgZXhwaXJlZCIsNjM6Ik91dCBvZiBzdHJlYW1zIHJlc291cmNlcyIsNjQ6Ik1hY2hpbmUgaXMgbm90IG9uIHRoZSBuZXR3b3JrIiw2NToiUGFja2FnZSBub3QgaW5zdGFsbGVkIiw2NjoiVGhlIG9iamVjdCBpcyByZW1vdGUiLDY3OiJUaGUgbGluayBoYXMgYmVlbiBzZXZlcmVkIiw2ODoiQWR2ZXJ0aXNlIGVycm9yIiw2OToiU3Jtb3VudCBlcnJvciIsNzA6IkNvbW11bmljYXRpb24gZXJyb3Igb24gc2VuZCIsNzE6IlByb3RvY29sIGVycm9yIiw3MjoiTXVsdGlob3AgYXR0ZW1wdGVkIiw3MzoiQ3Jvc3MgbW91bnQgcG9pbnQgKG5vdCByZWFsbHkgZXJyb3IpIiw3NDoiVHJ5aW5nIHRvIHJlYWQgdW5yZWFkYWJsZSBtZXNzYWdlIiw3NToiVmFsdWUgdG9vIGxhcmdlIGZvciBkZWZpbmVkIGRhdGEgdHlwZSIsNzY6IkdpdmVuIGxvZy4gbmFtZSBub3QgdW5pcXVlIiw3NzoiZi5kLiBpbnZhbGlkIGZvciB0aGlzIG9wZXJhdGlvbiIsNzg6IlJlbW90ZSBhZGRyZXNzIGNoYW5nZWQiLDc5OiJDYW4gICBhY2Nlc3MgYSBuZWVkZWQgc2hhcmVkIGxpYiIsODA6IkFjY2Vzc2luZyBhIGNvcnJ1cHRlZCBzaGFyZWQgbGliIiw4MToiLmxpYiBzZWN0aW9uIGluIGEub3V0IGNvcnJ1cHRlZCIsODI6IkF0dGVtcHRpbmcgdG8gbGluayBpbiB0b28gbWFueSBsaWJzIiw4MzoiQXR0ZW1wdGluZyB0byBleGVjIGEgc2hhcmVkIGxpYnJhcnkiLDg0OiJJbGxlZ2FsIGJ5dGUgc2VxdWVuY2UiLDg2OiJTdHJlYW1zIHBpcGUgZXJyb3IiLDg3OiJUb28gbWFueSB1c2VycyIsODg6IlNvY2tldCBvcGVyYXRpb24gb24gbm9uLXNvY2tldCIsODk6IkRlc3RpbmF0aW9uIGFkZHJlc3MgcmVxdWlyZWQiLDkwOiJNZXNzYWdlIHRvbyBsb25nIiw5MToiUHJvdG9jb2wgd3JvbmcgdHlwZSBmb3Igc29ja2V0Iiw5MjoiUHJvdG9jb2wgbm90IGF2YWlsYWJsZSIsOTM6IlVua25vd24gcHJvdG9jb2wiLDk0OiJTb2NrZXQgdHlwZSBub3Qgc3VwcG9ydGVkIiw5NToiTm90IHN1cHBvcnRlZCIsOTY6IlByb3RvY29sIGZhbWlseSBub3Qgc3VwcG9ydGVkIiw5NzoiQWRkcmVzcyBmYW1pbHkgbm90IHN1cHBvcnRlZCBieSBwcm90b2NvbCBmYW1pbHkiLDk4OiJBZGRyZXNzIGFscmVhZHkgaW4gdXNlIiw5OToiQWRkcmVzcyBub3QgYXZhaWxhYmxlIiwxMDA6Ik5ldHdvcmsgaW50ZXJmYWNlIGlzIG5vdCBjb25maWd1cmVkIiwxMDE6Ik5ldHdvcmsgaXMgdW5yZWFjaGFibGUiLDEwMjoiQ29ubmVjdGlvbiByZXNldCBieSBuZXR3b3JrIiwxMDM6IkNvbm5lY3Rpb24gYWJvcnRlZCIsMTA0OiJDb25uZWN0aW9uIHJlc2V0IGJ5IHBlZXIiLDEwNToiTm8gYnVmZmVyIHNwYWNlIGF2YWlsYWJsZSIsMTA2OiJTb2NrZXQgaXMgYWxyZWFkeSBjb25uZWN0ZWQiLDEwNzoiU29ja2V0IGlzIG5vdCBjb25uZWN0ZWQiLDEwODoiQ2FuJ3Qgc2VuZCBhZnRlciBzb2NrZXQgc2h1dGRvd24iLDEwOToiVG9vIG1hbnkgcmVmZXJlbmNlcyIsMTEwOiJDb25uZWN0aW9uIHRpbWVkIG91dCIsMTExOiJDb25uZWN0aW9uIHJlZnVzZWQiLDExMjoiSG9zdCBpcyBkb3duIiwxMTM6Ikhvc3QgaXMgdW5yZWFjaGFibGUiLDExNDoiU29ja2V0IGFscmVhZHkgY29ubmVjdGVkIiwxMTU6IkNvbm5lY3Rpb24gYWxyZWFkeSBpbiBwcm9ncmVzcyIsMTE2OiJTdGFsZSBmaWxlIGhhbmRsZSIsMTIyOiJRdW90YSBleGNlZWRlZCIsMTIzOiJObyBtZWRpdW0gKGluIHRhcGUgZHJpdmUpIiwxMjU6Ik9wZXJhdGlvbiBjYW5jZWxlZCIsMTMwOiJQcmV2aW91cyBvd25lciBkaWVkIiwxMzE6IlN0YXRlIG5vdCByZWNvdmVyYWJsZSJ9LGdlPXtzcGxpdFBhdGg6ZnVuY3Rpb24oZSl7cmV0dXJuL14oXC8/fCkoW1xzXFNdKj8pKCg/OlwuezEsMn18W15cL10rP3wpKFwuW14uXC9dKnwpKSg/OltcL10qKSQvLmV4ZWMoZSkuc2xpY2UoMSl9LG5vcm1hbGl6ZUFycmF5OmZ1bmN0aW9uKGUsdCl7Zm9yKHZhciByPTAsbj1lLmxlbmd0aC0xO24+PTA7bi0tKXt2YXIgbz1lW25dOyIuIj09PW8/ZS5zcGxpY2UobiwxKToiLi4iPT09bz8oZS5zcGxpY2UobiwxKSxyKyspOnImJihlLnNwbGljZShuLDEpLHItLSl9aWYodClmb3IoO3I7ci0tKWUudW5zaGlmdCgiLi4iKTtyZXR1cm4gZX0sbm9ybWFsaXplOmZ1bmN0aW9uKGUpe3ZhciB0PSIvIj09PWUuY2hhckF0KDApLHI9Ii8iPT09ZS5zdWJzdHIoLTEpO3JldHVybihlPWdlLm5vcm1hbGl6ZUFycmF5KGUuc3BsaXQoIi8iKS5maWx0ZXIoKGZ1bmN0aW9uKGUpe3JldHVybiEhZX0pKSwhdCkuam9pbigiLyIpKXx8dHx8KGU9Ii4iKSxlJiZyJiYoZSs9Ii8iKSwodD8iLyI6IiIpK2V9LGRpcm5hbWU6ZnVuY3Rpb24oZSl7dmFyIHQ9Z2Uuc3BsaXRQYXRoKGUpLHI9dFswXSxuPXRbMV07cmV0dXJuIHJ8fG4/KG4mJihuPW4uc3Vic3RyKDAsbi5sZW5ndGgtMSkpLHIrbik6Ii4ifSxiYXNlbmFtZTpmdW5jdGlvbihlKXtpZigiLyI9PT1lKXJldHVybiIvIjt2YXIgdD1lLmxhc3RJbmRleE9mKCIvIik7cmV0dXJuLTE9PT10P2U6ZS5zdWJzdHIodCsxKX0sZXh0bmFtZTpmdW5jdGlvbihlKXtyZXR1cm4gZ2Uuc3BsaXRQYXRoKGUpWzNdfSxqb2luOmZ1bmN0aW9uKCl7dmFyIGU9QXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLDApO3JldHVybiBnZS5ub3JtYWxpemUoZS5qb2luKCIvIikpfSxqb2luMjpmdW5jdGlvbihlLHQpe3JldHVybiBnZS5ub3JtYWxpemUoZSsiLyIrdCl9LHJlc29sdmU6ZnVuY3Rpb24oKXtmb3IodmFyIGU9IiIsdD0hMSxyPWFyZ3VtZW50cy5sZW5ndGgtMTtyPj0tMSYmIXQ7ci0tKXt2YXIgbj1yPj0wP2FyZ3VtZW50c1tyXTpUZS5jd2QoKTtpZigic3RyaW5nIiE9dHlwZW9mIG4pdGhyb3cgbmV3IFR5cGVFcnJvcigiQXJndW1lbnRzIHRvIHBhdGgucmVzb2x2ZSBtdXN0IGJlIHN0cmluZ3MiKTtpZighbilyZXR1cm4iIjtlPW4rIi8iK2UsdD0iLyI9PT1uLmNoYXJBdCgwKX1yZXR1cm4odD8iLyI6IiIpKyhlPWdlLm5vcm1hbGl6ZUFycmF5KGUuc3BsaXQoIi8iKS5maWx0ZXIoKGZ1bmN0aW9uKGUpe3JldHVybiEhZX0pKSwhdCkuam9pbigiLyIpKXx8Ii4ifSxyZWxhdGl2ZTpmdW5jdGlvbihlLHQpe2Z1bmN0aW9uIHIoZSl7Zm9yKHZhciB0PTA7dDxlLmxlbmd0aCYmIiI9PT1lW3RdO3QrKyk7Zm9yKHZhciByPWUubGVuZ3RoLTE7cj49MCYmIiI9PT1lW3JdO3ItLSk7cmV0dXJuIHQ+cj9bXTplLnNsaWNlKHQsci10KzEpfWU9Z2UucmVzb2x2ZShlKS5zdWJzdHIoMSksdD1nZS5yZXNvbHZlKHQpLnN1YnN0cigxKTtmb3IodmFyIG49cihlLnNwbGl0KCIvIikpLG89cih0LnNwbGl0KCIvIikpLGk9TWF0aC5taW4obi5sZW5ndGgsby5sZW5ndGgpLGE9aSxzPTA7czxpO3MrKylpZihuW3NdIT09b1tzXSl7YT1zO2JyZWFrfXZhciB1PVtdO2ZvcihzPWE7czxuLmxlbmd0aDtzKyspdS5wdXNoKCIuLiIpO3JldHVybih1PXUuY29uY2F0KG8uc2xpY2UoYSkpKS5qb2luKCIvIil9fSx2ZT17dHR5czpbXSxpbml0OmZ1bmN0aW9uKCl7fSxzaHV0ZG93bjpmdW5jdGlvbigpe30scmVnaXN0ZXI6ZnVuY3Rpb24oZSx0KXt2ZS50dHlzW2VdPXtpbnB1dDpbXSxvdXRwdXQ6W10sb3BzOnR9LFRlLnJlZ2lzdGVyRGV2aWNlKGUsdmUuc3RyZWFtX29wcyl9LHN0cmVhbV9vcHM6e29wZW46ZnVuY3Rpb24oZSl7dmFyIHQ9dmUudHR5c1tlLm5vZGUucmRldl07aWYoIXQpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRU5PREVWKTtlLnR0eT10LGUuc2Vla2FibGU9ITF9LGNsb3NlOmZ1bmN0aW9uKGUpe2UudHR5Lm9wcy5mbHVzaChlLnR0eSl9LGZsdXNoOmZ1bmN0aW9uKGUpe2UudHR5Lm9wcy5mbHVzaChlLnR0eSl9LHJlYWQ6ZnVuY3Rpb24oZSx0LHIsbixvKXtpZighZS50dHl8fCFlLnR0eS5vcHMuZ2V0X2NoYXIpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRU5YSU8pO2Zvcih2YXIgaT0wLGE9MDthPG47YSsrKXt2YXIgczt0cnl7cz1lLnR0eS5vcHMuZ2V0X2NoYXIoZS50dHkpfWNhdGNoKGUpe3Rocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVJTyl9aWYodm9pZCAwPT09cyYmMD09PWkpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRUFHQUlOKTtpZihudWxsPT1zKWJyZWFrO2krKyx0W3IrYV09c31yZXR1cm4gaSYmKGUubm9kZS50aW1lc3RhbXA9RGF0ZS5ub3coKSksaX0sd3JpdGU6ZnVuY3Rpb24oZSx0LHIsbixvKXtpZighZS50dHl8fCFlLnR0eS5vcHMucHV0X2NoYXIpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRU5YSU8pO2Zvcih2YXIgaT0wO2k8bjtpKyspdHJ5e2UudHR5Lm9wcy5wdXRfY2hhcihlLnR0eSx0W3IraV0pfWNhdGNoKGUpe3Rocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVJTyl9cmV0dXJuIG4mJihlLm5vZGUudGltZXN0YW1wPURhdGUubm93KCkpLGl9fSxkZWZhdWx0X3R0eV9vcHM6e2dldF9jaGFyOmZ1bmN0aW9uKGUpe2lmKCFlLmlucHV0Lmxlbmd0aCl7dmFyIHQ9bnVsbDtpZihsKXt2YXIgcj1uZXcgQnVmZmVyKDI1Niksbj0wLG89IndpbjMyIiE9cHJvY2Vzcy5wbGF0Zm9ybSxpPXByb2Nlc3Muc3RkaW4uZmQ7aWYobyl7dmFyIGE9ITE7dHJ5e2k9ZnMub3BlblN5bmMoIi9kZXYvc3RkaW4iLCJyIiksYT0hMH1jYXRjaChlKXt9fXRyeXtuPWZzLnJlYWRTeW5jKGksciwwLDI1NixudWxsKX1jYXRjaChlKXtpZigtMT09ZS50b1N0cmluZygpLmluZGV4T2YoIkVPRiIpKXRocm93IGU7bj0wfWEmJmZzLmNsb3NlU3luYyhpKSx0PW4+MD9yLnNsaWNlKDAsbikudG9TdHJpbmcoInV0Zi04Iik6bnVsbH1lbHNlInVuZGVmaW5lZCIhPXR5cGVvZiB3aW5kb3cmJiJmdW5jdGlvbiI9PXR5cGVvZiB3aW5kb3cucHJvbXB0P251bGwhPT0odD13aW5kb3cucHJvbXB0KCJJbnB1dDogIikpJiYodCs9IlxuIik6ImZ1bmN0aW9uIj09dHlwZW9mIHJlYWRsaW5lJiZudWxsIT09KHQ9cmVhZGxpbmUoKSkmJih0Kz0iXG4iKTtpZighdClyZXR1cm4gbnVsbDtlLmlucHV0PSR0KHQsITApfXJldHVybiBlLmlucHV0LnNoaWZ0KCl9LHB1dF9jaGFyOmZ1bmN0aW9uKGUsdCl7bnVsbD09PXR8fDEwPT09dD8oby5wcmludChfKGUub3V0cHV0LDApKSxlLm91dHB1dD1bXSk6MCE9dCYmZS5vdXRwdXQucHVzaCh0KX0sZmx1c2g6ZnVuY3Rpb24oZSl7ZS5vdXRwdXQmJmUub3V0cHV0Lmxlbmd0aD4wJiYoby5wcmludChfKGUub3V0cHV0LDApKSxlLm91dHB1dD1bXSl9fSxkZWZhdWx0X3R0eTFfb3BzOntwdXRfY2hhcjpmdW5jdGlvbihlLHQpe251bGw9PT10fHwxMD09PXQ/KG8ucHJpbnRFcnIoXyhlLm91dHB1dCwwKSksZS5vdXRwdXQ9W10pOjAhPXQmJmUub3V0cHV0LnB1c2godCl9LGZsdXNoOmZ1bmN0aW9uKGUpe2Uub3V0cHV0JiZlLm91dHB1dC5sZW5ndGg+MCYmKG8ucHJpbnRFcnIoXyhlLm91dHB1dCwwKSksZS5vdXRwdXQ9W10pfX19LHdlPXtvcHNfdGFibGU6bnVsbCxtb3VudDpmdW5jdGlvbihlKXtyZXR1cm4gd2UuY3JlYXRlTm9kZShudWxsLCIvIiwxNjg5NSwwKX0sY3JlYXRlTm9kZTpmdW5jdGlvbihlLHQscixuKXtpZihUZS5pc0Jsa2RldihyKXx8VGUuaXNGSUZPKHIpKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVQRVJNKTt3ZS5vcHNfdGFibGV8fCh3ZS5vcHNfdGFibGU9e2Rpcjp7bm9kZTp7Z2V0YXR0cjp3ZS5ub2RlX29wcy5nZXRhdHRyLHNldGF0dHI6d2Uubm9kZV9vcHMuc2V0YXR0cixsb29rdXA6d2Uubm9kZV9vcHMubG9va3VwLG1rbm9kOndlLm5vZGVfb3BzLm1rbm9kLHJlbmFtZTp3ZS5ub2RlX29wcy5yZW5hbWUsdW5saW5rOndlLm5vZGVfb3BzLnVubGluayxybWRpcjp3ZS5ub2RlX29wcy5ybWRpcixyZWFkZGlyOndlLm5vZGVfb3BzLnJlYWRkaXIsc3ltbGluazp3ZS5ub2RlX29wcy5zeW1saW5rfSxzdHJlYW06e2xsc2Vlazp3ZS5zdHJlYW1fb3BzLmxsc2Vla319LGZpbGU6e25vZGU6e2dldGF0dHI6d2Uubm9kZV9vcHMuZ2V0YXR0cixzZXRhdHRyOndlLm5vZGVfb3BzLnNldGF0dHJ9LHN0cmVhbTp7bGxzZWVrOndlLnN0cmVhbV9vcHMubGxzZWVrLHJlYWQ6d2Uuc3RyZWFtX29wcy5yZWFkLHdyaXRlOndlLnN0cmVhbV9vcHMud3JpdGUsYWxsb2NhdGU6d2Uuc3RyZWFtX29wcy5hbGxvY2F0ZSxtbWFwOndlLnN0cmVhbV9vcHMubW1hcCxtc3luYzp3ZS5zdHJlYW1fb3BzLm1zeW5jfX0sbGluazp7bm9kZTp7Z2V0YXR0cjp3ZS5ub2RlX29wcy5nZXRhdHRyLHNldGF0dHI6d2Uubm9kZV9vcHMuc2V0YXR0cixyZWFkbGluazp3ZS5ub2RlX29wcy5yZWFkbGlua30sc3RyZWFtOnt9fSxjaHJkZXY6e25vZGU6e2dldGF0dHI6d2Uubm9kZV9vcHMuZ2V0YXR0cixzZXRhdHRyOndlLm5vZGVfb3BzLnNldGF0dHJ9LHN0cmVhbTpUZS5jaHJkZXZfc3RyZWFtX29wc319KTt2YXIgbz1UZS5jcmVhdGVOb2RlKGUsdCxyLG4pO3JldHVybiBUZS5pc0RpcihvLm1vZGUpPyhvLm5vZGVfb3BzPXdlLm9wc190YWJsZS5kaXIubm9kZSxvLnN0cmVhbV9vcHM9d2Uub3BzX3RhYmxlLmRpci5zdHJlYW0sby5jb250ZW50cz17fSk6VGUuaXNGaWxlKG8ubW9kZSk/KG8ubm9kZV9vcHM9d2Uub3BzX3RhYmxlLmZpbGUubm9kZSxvLnN0cmVhbV9vcHM9d2Uub3BzX3RhYmxlLmZpbGUuc3RyZWFtLG8udXNlZEJ5dGVzPTAsby5jb250ZW50cz1udWxsKTpUZS5pc0xpbmsoby5tb2RlKT8oby5ub2RlX29wcz13ZS5vcHNfdGFibGUubGluay5ub2RlLG8uc3RyZWFtX29wcz13ZS5vcHNfdGFibGUubGluay5zdHJlYW0pOlRlLmlzQ2hyZGV2KG8ubW9kZSkmJihvLm5vZGVfb3BzPXdlLm9wc190YWJsZS5jaHJkZXYubm9kZSxvLnN0cmVhbV9vcHM9d2Uub3BzX3RhYmxlLmNocmRldi5zdHJlYW0pLG8udGltZXN0YW1wPURhdGUubm93KCksZSYmKGUuY29udGVudHNbdF09byksb30sZ2V0RmlsZURhdGFBc1JlZ3VsYXJBcnJheTpmdW5jdGlvbihlKXtpZihlLmNvbnRlbnRzJiZlLmNvbnRlbnRzLnN1YmFycmF5KXtmb3IodmFyIHQ9W10scj0wO3I8ZS51c2VkQnl0ZXM7KytyKXQucHVzaChlLmNvbnRlbnRzW3JdKTtyZXR1cm4gdH1yZXR1cm4gZS5jb250ZW50c30sZ2V0RmlsZURhdGFBc1R5cGVkQXJyYXk6ZnVuY3Rpb24oZSl7cmV0dXJuIGUuY29udGVudHM/ZS5jb250ZW50cy5zdWJhcnJheT9lLmNvbnRlbnRzLnN1YmFycmF5KDAsZS51c2VkQnl0ZXMpOm5ldyBVaW50OEFycmF5KGUuY29udGVudHMpOm5ldyBVaW50OEFycmF5fSxleHBhbmRGaWxlU3RvcmFnZTpmdW5jdGlvbihlLHQpe2lmKGUuY29udGVudHMmJmUuY29udGVudHMuc3ViYXJyYXkmJnQ+ZS5jb250ZW50cy5sZW5ndGgmJihlLmNvbnRlbnRzPXdlLmdldEZpbGVEYXRhQXNSZWd1bGFyQXJyYXkoZSksZS51c2VkQnl0ZXM9ZS5jb250ZW50cy5sZW5ndGgpLCFlLmNvbnRlbnRzfHxlLmNvbnRlbnRzLnN1YmFycmF5KXt2YXIgcj1lLmNvbnRlbnRzP2UuY29udGVudHMubGVuZ3RoOjA7aWYocj49dClyZXR1cm47dD1NYXRoLm1heCh0LHIqKHI8MTA0ODU3Nj8yOjEuMTI1KXwwKSwwIT1yJiYodD1NYXRoLm1heCh0LDI1NikpO3ZhciBuPWUuY29udGVudHM7cmV0dXJuIGUuY29udGVudHM9bmV3IFVpbnQ4QXJyYXkodCksdm9pZChlLnVzZWRCeXRlcz4wJiZlLmNvbnRlbnRzLnNldChuLnN1YmFycmF5KDAsZS51c2VkQnl0ZXMpLDApKX1mb3IoIWUuY29udGVudHMmJnQ+MCYmKGUuY29udGVudHM9W10pO2UuY29udGVudHMubGVuZ3RoPHQ7KWUuY29udGVudHMucHVzaCgwKX0scmVzaXplRmlsZVN0b3JhZ2U6ZnVuY3Rpb24oZSx0KXtpZihlLnVzZWRCeXRlcyE9dCl7aWYoMD09dClyZXR1cm4gZS5jb250ZW50cz1udWxsLHZvaWQoZS51c2VkQnl0ZXM9MCk7aWYoIWUuY29udGVudHN8fGUuY29udGVudHMuc3ViYXJyYXkpe3ZhciByPWUuY29udGVudHM7cmV0dXJuIGUuY29udGVudHM9bmV3IFVpbnQ4QXJyYXkobmV3IEFycmF5QnVmZmVyKHQpKSxyJiZlLmNvbnRlbnRzLnNldChyLnN1YmFycmF5KDAsTWF0aC5taW4odCxlLnVzZWRCeXRlcykpKSx2b2lkKGUudXNlZEJ5dGVzPXQpfWlmKGUuY29udGVudHN8fChlLmNvbnRlbnRzPVtdKSxlLmNvbnRlbnRzLmxlbmd0aD50KWUuY29udGVudHMubGVuZ3RoPXQ7ZWxzZSBmb3IoO2UuY29udGVudHMubGVuZ3RoPHQ7KWUuY29udGVudHMucHVzaCgwKTtlLnVzZWRCeXRlcz10fX0sbm9kZV9vcHM6e2dldGF0dHI6ZnVuY3Rpb24oZSl7dmFyIHQ9e307cmV0dXJuIHQuZGV2PVRlLmlzQ2hyZGV2KGUubW9kZSk/ZS5pZDoxLHQuaW5vPWUuaWQsdC5tb2RlPWUubW9kZSx0Lm5saW5rPTEsdC51aWQ9MCx0LmdpZD0wLHQucmRldj1lLnJkZXYsVGUuaXNEaXIoZS5tb2RlKT90LnNpemU9NDA5NjpUZS5pc0ZpbGUoZS5tb2RlKT90LnNpemU9ZS51c2VkQnl0ZXM6VGUuaXNMaW5rKGUubW9kZSk/dC5zaXplPWUubGluay5sZW5ndGg6dC5zaXplPTAsdC5hdGltZT1uZXcgRGF0ZShlLnRpbWVzdGFtcCksdC5tdGltZT1uZXcgRGF0ZShlLnRpbWVzdGFtcCksdC5jdGltZT1uZXcgRGF0ZShlLnRpbWVzdGFtcCksdC5ibGtzaXplPTQwOTYsdC5ibG9ja3M9TWF0aC5jZWlsKHQuc2l6ZS90LmJsa3NpemUpLHR9LHNldGF0dHI6ZnVuY3Rpb24oZSx0KXt2b2lkIDAhPT10Lm1vZGUmJihlLm1vZGU9dC5tb2RlKSx2b2lkIDAhPT10LnRpbWVzdGFtcCYmKGUudGltZXN0YW1wPXQudGltZXN0YW1wKSx2b2lkIDAhPT10LnNpemUmJndlLnJlc2l6ZUZpbGVTdG9yYWdlKGUsdC5zaXplKX0sbG9va3VwOmZ1bmN0aW9uKGUsdCl7dGhyb3cgVGUuZ2VuZXJpY0Vycm9yc1ttZS5FTk9FTlRdfSxta25vZDpmdW5jdGlvbihlLHQscixuKXtyZXR1cm4gd2UuY3JlYXRlTm9kZShlLHQscixuKX0scmVuYW1lOmZ1bmN0aW9uKGUsdCxyKXtpZihUZS5pc0RpcihlLm1vZGUpKXt2YXIgbjt0cnl7bj1UZS5sb29rdXBOb2RlKHQscil9Y2F0Y2goZSl7fWlmKG4pZm9yKHZhciBvIGluIG4uY29udGVudHMpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRU5PVEVNUFRZKX1kZWxldGUgZS5wYXJlbnQuY29udGVudHNbZS5uYW1lXSxlLm5hbWU9cix0LmNvbnRlbnRzW3JdPWUsZS5wYXJlbnQ9dH0sdW5saW5rOmZ1bmN0aW9uKGUsdCl7ZGVsZXRlIGUuY29udGVudHNbdF19LHJtZGlyOmZ1bmN0aW9uKGUsdCl7dmFyIHI9VGUubG9va3VwTm9kZShlLHQpO2Zvcih2YXIgbiBpbiByLmNvbnRlbnRzKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVOT1RFTVBUWSk7ZGVsZXRlIGUuY29udGVudHNbdF19LHJlYWRkaXI6ZnVuY3Rpb24oZSl7dmFyIHQ9WyIuIiwiLi4iXTtmb3IodmFyIHIgaW4gZS5jb250ZW50cyllLmNvbnRlbnRzLmhhc093blByb3BlcnR5KHIpJiZ0LnB1c2gocik7cmV0dXJuIHR9LHN5bWxpbms6ZnVuY3Rpb24oZSx0LHIpe3ZhciBuPXdlLmNyZWF0ZU5vZGUoZSx0LDQxNDcxLDApO3JldHVybiBuLmxpbms9cixufSxyZWFkbGluazpmdW5jdGlvbihlKXtpZighVGUuaXNMaW5rKGUubW9kZSkpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRUlOVkFMKTtyZXR1cm4gZS5saW5rfX0sc3RyZWFtX29wczp7cmVhZDpmdW5jdGlvbihlLHQscixuLG8pe3ZhciBpPWUubm9kZS5jb250ZW50cztpZihvPj1lLm5vZGUudXNlZEJ5dGVzKXJldHVybiAwO3ZhciBhPU1hdGgubWluKGUubm9kZS51c2VkQnl0ZXMtbyxuKTtpZih5KGE+PTApLGE+OCYmaS5zdWJhcnJheSl0LnNldChpLnN1YmFycmF5KG8sbythKSxyKTtlbHNlIGZvcih2YXIgcz0wO3M8YTtzKyspdFtyK3NdPWlbbytzXTtyZXR1cm4gYX0sd3JpdGU6ZnVuY3Rpb24oZSx0LHIsbixvLGkpe2lmKCFuKXJldHVybiAwO3ZhciBhPWUubm9kZTtpZihhLnRpbWVzdGFtcD1EYXRlLm5vdygpLHQuc3ViYXJyYXkmJighYS5jb250ZW50c3x8YS5jb250ZW50cy5zdWJhcnJheSkpe2lmKGkpcmV0dXJuIGEuY29udGVudHM9dC5zdWJhcnJheShyLHIrbiksYS51c2VkQnl0ZXM9bixuO2lmKDA9PT1hLnVzZWRCeXRlcyYmMD09PW8pcmV0dXJuIGEuY29udGVudHM9bmV3IFVpbnQ4QXJyYXkodC5zdWJhcnJheShyLHIrbikpLGEudXNlZEJ5dGVzPW4sbjtpZihvK248PWEudXNlZEJ5dGVzKXJldHVybiBhLmNvbnRlbnRzLnNldCh0LnN1YmFycmF5KHIscituKSxvKSxufWlmKHdlLmV4cGFuZEZpbGVTdG9yYWdlKGEsbytuKSxhLmNvbnRlbnRzLnN1YmFycmF5JiZ0LnN1YmFycmF5KWEuY29udGVudHMuc2V0KHQuc3ViYXJyYXkocixyK24pLG8pO2Vsc2UgZm9yKHZhciBzPTA7czxuO3MrKylhLmNvbnRlbnRzW28rc109dFtyK3NdO3JldHVybiBhLnVzZWRCeXRlcz1NYXRoLm1heChhLnVzZWRCeXRlcyxvK24pLG59LGxsc2VlazpmdW5jdGlvbihlLHQscil7dmFyIG49dDtpZigxPT09cj9uKz1lLnBvc2l0aW9uOjI9PT1yJiZUZS5pc0ZpbGUoZS5ub2RlLm1vZGUpJiYobis9ZS5ub2RlLnVzZWRCeXRlcyksbjwwKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVJTlZBTCk7cmV0dXJuIG59LGFsbG9jYXRlOmZ1bmN0aW9uKGUsdCxyKXt3ZS5leHBhbmRGaWxlU3RvcmFnZShlLm5vZGUsdCtyKSxlLm5vZGUudXNlZEJ5dGVzPU1hdGgubWF4KGUubm9kZS51c2VkQnl0ZXMsdCtyKX0sbW1hcDpmdW5jdGlvbihlLHQscixuLG8saSxhKXtpZighVGUuaXNGaWxlKGUubm9kZS5tb2RlKSl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FTk9ERVYpO3ZhciBzLHUsYz1lLm5vZGUuY29udGVudHM7aWYoMiZhfHxjLmJ1ZmZlciE9PXQmJmMuYnVmZmVyIT09dC5idWZmZXIpe2lmKChvPjB8fG8rbjxlLm5vZGUudXNlZEJ5dGVzKSYmKGM9Yy5zdWJhcnJheT9jLnN1YmFycmF5KG8sbytuKTpBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChjLG8sbytuKSksdT0hMCwhKHM9SnQobikpKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVOT01FTSk7dC5zZXQoYyxzKX1lbHNlIHU9ITEscz1jLmJ5dGVPZmZzZXQ7cmV0dXJue3B0cjpzLGFsbG9jYXRlZDp1fX0sbXN5bmM6ZnVuY3Rpb24oZSx0LHIsbixvKXtpZighVGUuaXNGaWxlKGUubm9kZS5tb2RlKSl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FTk9ERVYpO2lmKDImbylyZXR1cm4gMDt3ZS5zdHJlYW1fb3BzLndyaXRlKGUsdCwwLG4sciwhMSk7cmV0dXJuIDB9fX0sX2U9e2Riczp7fSxpbmRleGVkREI6ZnVuY3Rpb24oKXtpZigidW5kZWZpbmVkIiE9dHlwZW9mIGluZGV4ZWREQilyZXR1cm4gaW5kZXhlZERCO3ZhciBlPW51bGw7cmV0dXJuIm9iamVjdCI9PXR5cGVvZiB3aW5kb3cmJihlPXdpbmRvdy5pbmRleGVkREJ8fHdpbmRvdy5tb3pJbmRleGVkREJ8fHdpbmRvdy53ZWJraXRJbmRleGVkREJ8fHdpbmRvdy5tc0luZGV4ZWREQikseShlLCJJREJGUyB1c2VkLCBidXQgaW5kZXhlZERCIG5vdCBzdXBwb3J0ZWQiKSxlfSxEQl9WRVJTSU9OOjIxLERCX1NUT1JFX05BTUU6IkZJTEVfREFUQSIsbW91bnQ6ZnVuY3Rpb24oZSl7cmV0dXJuIHdlLm1vdW50LmFwcGx5KG51bGwsYXJndW1lbnRzKX0sc3luY2ZzOmZ1bmN0aW9uKGUsdCxyKXtfZS5nZXRMb2NhbFNldChlLChmdW5jdGlvbihuLG8pe2lmKG4pcmV0dXJuIHIobik7X2UuZ2V0UmVtb3RlU2V0KGUsKGZ1bmN0aW9uKGUsbil7aWYoZSlyZXR1cm4gcihlKTt2YXIgaT10P246byxhPXQ/bzpuO19lLnJlY29uY2lsZShpLGEscil9KSl9KSl9LGdldERCOmZ1bmN0aW9uKGUsdCl7dmFyIHIsbj1fZS5kYnNbZV07aWYobilyZXR1cm4gdChudWxsLG4pO3RyeXtyPV9lLmluZGV4ZWREQigpLm9wZW4oZSxfZS5EQl9WRVJTSU9OKX1jYXRjaChlKXtyZXR1cm4gdChlKX1pZighcilyZXR1cm4gdCgiVW5hYmxlIHRvIGNvbm5lY3QgdG8gSW5kZXhlZERCIik7ci5vbnVwZ3JhZGVuZWVkZWQ9ZnVuY3Rpb24oZSl7dmFyIHQscj1lLnRhcmdldC5yZXN1bHQsbj1lLnRhcmdldC50cmFuc2FjdGlvbjsodD1yLm9iamVjdFN0b3JlTmFtZXMuY29udGFpbnMoX2UuREJfU1RPUkVfTkFNRSk/bi5vYmplY3RTdG9yZShfZS5EQl9TVE9SRV9OQU1FKTpyLmNyZWF0ZU9iamVjdFN0b3JlKF9lLkRCX1NUT1JFX05BTUUpKS5pbmRleE5hbWVzLmNvbnRhaW5zKCJ0aW1lc3RhbXAiKXx8dC5jcmVhdGVJbmRleCgidGltZXN0YW1wIiwidGltZXN0YW1wIix7dW5pcXVlOiExfSl9LHIub25zdWNjZXNzPWZ1bmN0aW9uKCl7bj1yLnJlc3VsdCxfZS5kYnNbZV09bix0KG51bGwsbil9LHIub25lcnJvcj1mdW5jdGlvbihlKXt0KHRoaXMuZXJyb3IpLGUucHJldmVudERlZmF1bHQoKX19LGdldExvY2FsU2V0OmZ1bmN0aW9uKGUsdCl7dmFyIHI9e307ZnVuY3Rpb24gbihlKXtyZXR1cm4iLiIhPT1lJiYiLi4iIT09ZX1mdW5jdGlvbiBvKGUpe3JldHVybiBmdW5jdGlvbih0KXtyZXR1cm4gZ2Uuam9pbjIoZSx0KX19Zm9yKHZhciBpPVRlLnJlYWRkaXIoZS5tb3VudHBvaW50KS5maWx0ZXIobikubWFwKG8oZS5tb3VudHBvaW50KSk7aS5sZW5ndGg7KXt2YXIgYSxzPWkucG9wKCk7dHJ5e2E9VGUuc3RhdChzKX1jYXRjaChlKXtyZXR1cm4gdChlKX1UZS5pc0RpcihhLm1vZGUpJiZpLnB1c2guYXBwbHkoaSxUZS5yZWFkZGlyKHMpLmZpbHRlcihuKS5tYXAobyhzKSkpLHJbc109e3RpbWVzdGFtcDphLm10aW1lfX1yZXR1cm4gdChudWxsLHt0eXBlOiJsb2NhbCIsZW50cmllczpyfSl9LGdldFJlbW90ZVNldDpmdW5jdGlvbihlLHQpe3ZhciByPXt9O19lLmdldERCKGUubW91bnRwb2ludCwoZnVuY3Rpb24oZSxuKXtpZihlKXJldHVybiB0KGUpO3RyeXt2YXIgbz1uLnRyYW5zYWN0aW9uKFtfZS5EQl9TVE9SRV9OQU1FXSwicmVhZG9ubHkiKTtvLm9uZXJyb3I9ZnVuY3Rpb24oZSl7dCh0aGlzLmVycm9yKSxlLnByZXZlbnREZWZhdWx0KCl9LG8ub2JqZWN0U3RvcmUoX2UuREJfU1RPUkVfTkFNRSkuaW5kZXgoInRpbWVzdGFtcCIpLm9wZW5LZXlDdXJzb3IoKS5vbnN1Y2Nlc3M9ZnVuY3Rpb24oZSl7dmFyIG89ZS50YXJnZXQucmVzdWx0O2lmKCFvKXJldHVybiB0KG51bGwse3R5cGU6InJlbW90ZSIsZGI6bixlbnRyaWVzOnJ9KTtyW28ucHJpbWFyeUtleV09e3RpbWVzdGFtcDpvLmtleX0sby5jb250aW51ZSgpfX1jYXRjaChlKXtyZXR1cm4gdChlKX19KSl9LGxvYWRMb2NhbEVudHJ5OmZ1bmN0aW9uKGUsdCl7dmFyIHIsbjt0cnl7bj1UZS5sb29rdXBQYXRoKGUpLm5vZGUscj1UZS5zdGF0KGUpfWNhdGNoKGUpe3JldHVybiB0KGUpfXJldHVybiBUZS5pc0RpcihyLm1vZGUpP3QobnVsbCx7dGltZXN0YW1wOnIubXRpbWUsbW9kZTpyLm1vZGV9KTpUZS5pc0ZpbGUoci5tb2RlKT8obi5jb250ZW50cz13ZS5nZXRGaWxlRGF0YUFzVHlwZWRBcnJheShuKSx0KG51bGwse3RpbWVzdGFtcDpyLm10aW1lLG1vZGU6ci5tb2RlLGNvbnRlbnRzOm4uY29udGVudHN9KSk6dChuZXcgRXJyb3IoIm5vZGUgdHlwZSBub3Qgc3VwcG9ydGVkIikpfSxzdG9yZUxvY2FsRW50cnk6ZnVuY3Rpb24oZSx0LHIpe3RyeXtpZihUZS5pc0Rpcih0Lm1vZGUpKVRlLm1rZGlyKGUsdC5tb2RlKTtlbHNle2lmKCFUZS5pc0ZpbGUodC5tb2RlKSlyZXR1cm4gcihuZXcgRXJyb3IoIm5vZGUgdHlwZSBub3Qgc3VwcG9ydGVkIikpO1RlLndyaXRlRmlsZShlLHQuY29udGVudHMse2Nhbk93bjohMH0pfVRlLmNobW9kKGUsdC5tb2RlKSxUZS51dGltZShlLHQudGltZXN0YW1wLHQudGltZXN0YW1wKX1jYXRjaChlKXtyZXR1cm4gcihlKX1yKG51bGwpfSxyZW1vdmVMb2NhbEVudHJ5OmZ1bmN0aW9uKGUsdCl7dHJ5e1RlLmxvb2t1cFBhdGgoZSk7dmFyIHI9VGUuc3RhdChlKTtUZS5pc0RpcihyLm1vZGUpP1RlLnJtZGlyKGUpOlRlLmlzRmlsZShyLm1vZGUpJiZUZS51bmxpbmsoZSl9Y2F0Y2goZSl7cmV0dXJuIHQoZSl9dChudWxsKX0sbG9hZFJlbW90ZUVudHJ5OmZ1bmN0aW9uKGUsdCxyKXt2YXIgbj1lLmdldCh0KTtuLm9uc3VjY2Vzcz1mdW5jdGlvbihlKXtyKG51bGwsZS50YXJnZXQucmVzdWx0KX0sbi5vbmVycm9yPWZ1bmN0aW9uKGUpe3IodGhpcy5lcnJvciksZS5wcmV2ZW50RGVmYXVsdCgpfX0sc3RvcmVSZW1vdGVFbnRyeTpmdW5jdGlvbihlLHQscixuKXt2YXIgbz1lLnB1dChyLHQpO28ub25zdWNjZXNzPWZ1bmN0aW9uKCl7bihudWxsKX0sby5vbmVycm9yPWZ1bmN0aW9uKGUpe24odGhpcy5lcnJvciksZS5wcmV2ZW50RGVmYXVsdCgpfX0scmVtb3ZlUmVtb3RlRW50cnk6ZnVuY3Rpb24oZSx0LHIpe3ZhciBuPWUuZGVsZXRlKHQpO24ub25zdWNjZXNzPWZ1bmN0aW9uKCl7cihudWxsKX0sbi5vbmVycm9yPWZ1bmN0aW9uKGUpe3IodGhpcy5lcnJvciksZS5wcmV2ZW50RGVmYXVsdCgpfX0scmVjb25jaWxlOmZ1bmN0aW9uKGUsdCxyKXt2YXIgbj0wLG89W107T2JqZWN0LmtleXMoZS5lbnRyaWVzKS5mb3JFYWNoKChmdW5jdGlvbihyKXt2YXIgaT1lLmVudHJpZXNbcl0sYT10LmVudHJpZXNbcl07KCFhfHxpLnRpbWVzdGFtcD5hLnRpbWVzdGFtcCkmJihvLnB1c2gociksbisrKX0pKTt2YXIgaT1bXTtpZihPYmplY3Qua2V5cyh0LmVudHJpZXMpLmZvckVhY2goKGZ1bmN0aW9uKHIpe3QuZW50cmllc1tyXTtlLmVudHJpZXNbcl18fChpLnB1c2gociksbisrKX0pKSwhbilyZXR1cm4gcihudWxsKTt2YXIgYT0wLHM9KCJyZW1vdGUiPT09ZS50eXBlP2UuZGI6dC5kYikudHJhbnNhY3Rpb24oW19lLkRCX1NUT1JFX05BTUVdLCJyZWFkd3JpdGUiKSx1PXMub2JqZWN0U3RvcmUoX2UuREJfU1RPUkVfTkFNRSk7ZnVuY3Rpb24gYyhlKXtyZXR1cm4gZT9jLmVycm9yZWQ/dm9pZCAwOihjLmVycm9yZWQ9ITAscihlKSk6KythPj1uP3IobnVsbCk6dm9pZCAwfXMub25lcnJvcj1mdW5jdGlvbihlKXtjKHRoaXMuZXJyb3IpLGUucHJldmVudERlZmF1bHQoKX0sby5zb3J0KCkuZm9yRWFjaCgoZnVuY3Rpb24oZSl7ImxvY2FsIj09PXQudHlwZT9fZS5sb2FkUmVtb3RlRW50cnkodSxlLChmdW5jdGlvbih0LHIpe2lmKHQpcmV0dXJuIGModCk7X2Uuc3RvcmVMb2NhbEVudHJ5KGUscixjKX0pKTpfZS5sb2FkTG9jYWxFbnRyeShlLChmdW5jdGlvbih0LHIpe2lmKHQpcmV0dXJuIGModCk7X2Uuc3RvcmVSZW1vdGVFbnRyeSh1LGUscixjKX0pKX0pKSxpLnNvcnQoKS5yZXZlcnNlKCkuZm9yRWFjaCgoZnVuY3Rpb24oZSl7ImxvY2FsIj09PXQudHlwZT9fZS5yZW1vdmVMb2NhbEVudHJ5KGUsYyk6X2UucmVtb3ZlUmVtb3RlRW50cnkodSxlLGMpfSkpfX0sYmU9e2lzV2luZG93czohMSxzdGF0aWNJbml0OmZ1bmN0aW9uKCl7YmUuaXNXaW5kb3dzPSEhcHJvY2Vzcy5wbGF0Zm9ybS5tYXRjaCgvXndpbi8pO3ZhciBlPXByb2Nlc3MuYmluZGluZygiY29uc3RhbnRzIik7ZS5mcyYmKGU9ZS5mcyksYmUuZmxhZ3NGb3JOb2RlTWFwPXsxMDI0OmUuT19BUFBFTkQsNjQ6ZS5PX0NSRUFULDEyODplLk9fRVhDTCwwOmUuT19SRE9OTFksMjplLk9fUkRXUiw0MDk2OmUuT19TWU5DLDUxMjplLk9fVFJVTkMsMTplLk9fV1JPTkxZfX0sYnVmZmVyRnJvbTpmdW5jdGlvbihlKXtyZXR1cm4gQnVmZmVyLmFsbG9jP0J1ZmZlci5mcm9tKGUpOm5ldyBCdWZmZXIoZSl9LG1vdW50OmZ1bmN0aW9uKGUpe3JldHVybiB5KGwpLGJlLmNyZWF0ZU5vZGUobnVsbCwiLyIsYmUuZ2V0TW9kZShlLm9wdHMucm9vdCksMCl9LGNyZWF0ZU5vZGU6ZnVuY3Rpb24oZSx0LHIsbil7aWYoIVRlLmlzRGlyKHIpJiYhVGUuaXNGaWxlKHIpJiYhVGUuaXNMaW5rKHIpKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVJTlZBTCk7dmFyIG89VGUuY3JlYXRlTm9kZShlLHQscik7cmV0dXJuIG8ubm9kZV9vcHM9YmUubm9kZV9vcHMsby5zdHJlYW1fb3BzPWJlLnN0cmVhbV9vcHMsb30sZ2V0TW9kZTpmdW5jdGlvbihlKXt2YXIgdDt0cnl7dD1mcy5sc3RhdFN5bmMoZSksYmUuaXNXaW5kb3dzJiYodC5tb2RlPXQubW9kZXwoMjkyJnQubW9kZSk+PjIpfWNhdGNoKGUpe2lmKCFlLmNvZGUpdGhyb3cgZTt0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZVtlLmNvZGVdKX1yZXR1cm4gdC5tb2RlfSxyZWFsUGF0aDpmdW5jdGlvbihlKXtmb3IodmFyIHQ9W107ZS5wYXJlbnQhPT1lOyl0LnB1c2goZS5uYW1lKSxlPWUucGFyZW50O3JldHVybiB0LnB1c2goZS5tb3VudC5vcHRzLnJvb3QpLHQucmV2ZXJzZSgpLGdlLmpvaW4uYXBwbHkobnVsbCx0KX0sZmxhZ3NGb3JOb2RlOmZ1bmN0aW9uKGUpe2UmPS0yMDk3MTUzLGUmPS0yMDQ5LGUmPS0zMjc2OSxlJj0tNTI0Mjg5O3ZhciB0PTA7Zm9yKHZhciByIGluIGJlLmZsYWdzRm9yTm9kZU1hcCllJnImJih0fD1iZS5mbGFnc0Zvck5vZGVNYXBbcl0sZV49cik7aWYoZSl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FSU5WQUwpO3JldHVybiB0fSxub2RlX29wczp7Z2V0YXR0cjpmdW5jdGlvbihlKXt2YXIgdCxyPWJlLnJlYWxQYXRoKGUpO3RyeXt0PWZzLmxzdGF0U3luYyhyKX1jYXRjaChlKXtpZighZS5jb2RlKXRocm93IGU7dGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWVbZS5jb2RlXSl9cmV0dXJuIGJlLmlzV2luZG93cyYmIXQuYmxrc2l6ZSYmKHQuYmxrc2l6ZT00MDk2KSxiZS5pc1dpbmRvd3MmJiF0LmJsb2NrcyYmKHQuYmxvY2tzPSh0LnNpemUrdC5ibGtzaXplLTEpL3QuYmxrc2l6ZXwwKSx7ZGV2OnQuZGV2LGlubzp0Lmlubyxtb2RlOnQubW9kZSxubGluazp0Lm5saW5rLHVpZDp0LnVpZCxnaWQ6dC5naWQscmRldjp0LnJkZXYsc2l6ZTp0LnNpemUsYXRpbWU6dC5hdGltZSxtdGltZTp0Lm10aW1lLGN0aW1lOnQuY3RpbWUsYmxrc2l6ZTp0LmJsa3NpemUsYmxvY2tzOnQuYmxvY2tzfX0sc2V0YXR0cjpmdW5jdGlvbihlLHQpe3ZhciByPWJlLnJlYWxQYXRoKGUpO3RyeXtpZih2b2lkIDAhPT10Lm1vZGUmJihmcy5jaG1vZFN5bmMocix0Lm1vZGUpLGUubW9kZT10Lm1vZGUpLHZvaWQgMCE9PXQudGltZXN0YW1wKXt2YXIgbj1uZXcgRGF0ZSh0LnRpbWVzdGFtcCk7ZnMudXRpbWVzU3luYyhyLG4sbil9dm9pZCAwIT09dC5zaXplJiZmcy50cnVuY2F0ZVN5bmMocix0LnNpemUpfWNhdGNoKGUpe2lmKCFlLmNvZGUpdGhyb3cgZTt0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZVtlLmNvZGVdKX19LGxvb2t1cDpmdW5jdGlvbihlLHQpe3ZhciByPWdlLmpvaW4yKGJlLnJlYWxQYXRoKGUpLHQpLG49YmUuZ2V0TW9kZShyKTtyZXR1cm4gYmUuY3JlYXRlTm9kZShlLHQsbil9LG1rbm9kOmZ1bmN0aW9uKGUsdCxyLG4pe3ZhciBvPWJlLmNyZWF0ZU5vZGUoZSx0LHIsbiksaT1iZS5yZWFsUGF0aChvKTt0cnl7VGUuaXNEaXIoby5tb2RlKT9mcy5ta2RpclN5bmMoaSxvLm1vZGUpOmZzLndyaXRlRmlsZVN5bmMoaSwiIix7bW9kZTpvLm1vZGV9KX1jYXRjaChlKXtpZighZS5jb2RlKXRocm93IGU7dGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWVbZS5jb2RlXSl9cmV0dXJuIG99LHJlbmFtZTpmdW5jdGlvbihlLHQscil7dmFyIG49YmUucmVhbFBhdGgoZSksbz1nZS5qb2luMihiZS5yZWFsUGF0aCh0KSxyKTt0cnl7ZnMucmVuYW1lU3luYyhuLG8pfWNhdGNoKGUpe2lmKCFlLmNvZGUpdGhyb3cgZTt0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZVtlLmNvZGVdKX19LHVubGluazpmdW5jdGlvbihlLHQpe3ZhciByPWdlLmpvaW4yKGJlLnJlYWxQYXRoKGUpLHQpO3RyeXtmcy51bmxpbmtTeW5jKHIpfWNhdGNoKGUpe2lmKCFlLmNvZGUpdGhyb3cgZTt0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZVtlLmNvZGVdKX19LHJtZGlyOmZ1bmN0aW9uKGUsdCl7dmFyIHI9Z2Uuam9pbjIoYmUucmVhbFBhdGgoZSksdCk7dHJ5e2ZzLnJtZGlyU3luYyhyKX1jYXRjaChlKXtpZighZS5jb2RlKXRocm93IGU7dGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWVbZS5jb2RlXSl9fSxyZWFkZGlyOmZ1bmN0aW9uKGUpe3ZhciB0PWJlLnJlYWxQYXRoKGUpO3RyeXtyZXR1cm4gZnMucmVhZGRpclN5bmModCl9Y2F0Y2goZSl7aWYoIWUuY29kZSl0aHJvdyBlO3Rocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lW2UuY29kZV0pfX0sc3ltbGluazpmdW5jdGlvbihlLHQscil7dmFyIG49Z2Uuam9pbjIoYmUucmVhbFBhdGgoZSksdCk7dHJ5e2ZzLnN5bWxpbmtTeW5jKHIsbil9Y2F0Y2goZSl7aWYoIWUuY29kZSl0aHJvdyBlO3Rocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lW2UuY29kZV0pfX0scmVhZGxpbms6ZnVuY3Rpb24oZSl7dmFyIHQ9YmUucmVhbFBhdGgoZSk7dHJ5e3JldHVybiB0PWZzLnJlYWRsaW5rU3luYyh0KSx0PU5PREVKU19QQVRILnJlbGF0aXZlKE5PREVKU19QQVRILnJlc29sdmUoZS5tb3VudC5vcHRzLnJvb3QpLHQpfWNhdGNoKGUpe2lmKCFlLmNvZGUpdGhyb3cgZTt0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZVtlLmNvZGVdKX19fSxzdHJlYW1fb3BzOntvcGVuOmZ1bmN0aW9uKGUpe3ZhciB0PWJlLnJlYWxQYXRoKGUubm9kZSk7dHJ5e1RlLmlzRmlsZShlLm5vZGUubW9kZSkmJihlLm5mZD1mcy5vcGVuU3luYyh0LGJlLmZsYWdzRm9yTm9kZShlLmZsYWdzKSkpfWNhdGNoKGUpe2lmKCFlLmNvZGUpdGhyb3cgZTt0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZVtlLmNvZGVdKX19LGNsb3NlOmZ1bmN0aW9uKGUpe3RyeXtUZS5pc0ZpbGUoZS5ub2RlLm1vZGUpJiZlLm5mZCYmZnMuY2xvc2VTeW5jKGUubmZkKX1jYXRjaChlKXtpZighZS5jb2RlKXRocm93IGU7dGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWVbZS5jb2RlXSl9fSxyZWFkOmZ1bmN0aW9uKGUsdCxyLG4sbyl7aWYoMD09PW4pcmV0dXJuIDA7dHJ5e3JldHVybiBmcy5yZWFkU3luYyhlLm5mZCxiZS5idWZmZXJGcm9tKHQuYnVmZmVyKSxyLG4sbyl9Y2F0Y2goZSl7dGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWVbZS5jb2RlXSl9fSx3cml0ZTpmdW5jdGlvbihlLHQscixuLG8pe3RyeXtyZXR1cm4gZnMud3JpdGVTeW5jKGUubmZkLGJlLmJ1ZmZlckZyb20odC5idWZmZXIpLHIsbixvKX1jYXRjaChlKXt0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZVtlLmNvZGVdKX19LGxsc2VlazpmdW5jdGlvbihlLHQscil7dmFyIG49dDtpZigxPT09ciluKz1lLnBvc2l0aW9uO2Vsc2UgaWYoMj09PXImJlRlLmlzRmlsZShlLm5vZGUubW9kZSkpdHJ5e24rPWZzLmZzdGF0U3luYyhlLm5mZCkuc2l6ZX1jYXRjaChlKXt0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZVtlLmNvZGVdKX1pZihuPDApdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRUlOVkFMKTtyZXR1cm4gbn19fSxBZT17RElSX01PREU6MTY4OTUsRklMRV9NT0RFOjMzMjc5LHJlYWRlcjpudWxsLG1vdW50OmZ1bmN0aW9uKGUpe3koYyksQWUucmVhZGVyfHwoQWUucmVhZGVyPW5ldyBGaWxlUmVhZGVyU3luYyk7dmFyIHQ9QWUuY3JlYXRlTm9kZShudWxsLCIvIixBZS5ESVJfTU9ERSwwKSxyPXt9O2Z1bmN0aW9uIG4oZSl7Zm9yKHZhciBuPWUuc3BsaXQoIi8iKSxvPXQsaT0wO2k8bi5sZW5ndGgtMTtpKyspe3ZhciBhPW4uc2xpY2UoMCxpKzEpLmpvaW4oIi8iKTtyW2FdfHwoclthXT1BZS5jcmVhdGVOb2RlKG8sbltpXSxBZS5ESVJfTU9ERSwwKSksbz1yW2FdfXJldHVybiBvfWZ1bmN0aW9uIG8oZSl7dmFyIHQ9ZS5zcGxpdCgiLyIpO3JldHVybiB0W3QubGVuZ3RoLTFdfXJldHVybiBBcnJheS5wcm90b3R5cGUuZm9yRWFjaC5jYWxsKGUub3B0cy5maWxlc3x8W10sKGZ1bmN0aW9uKGUpe0FlLmNyZWF0ZU5vZGUobihlLm5hbWUpLG8oZS5uYW1lKSxBZS5GSUxFX01PREUsMCxlLGUubGFzdE1vZGlmaWVkRGF0ZSl9KSksKGUub3B0cy5ibG9ic3x8W10pLmZvckVhY2goKGZ1bmN0aW9uKGUpe0FlLmNyZWF0ZU5vZGUobihlLm5hbWUpLG8oZS5uYW1lKSxBZS5GSUxFX01PREUsMCxlLmRhdGEpfSkpLChlLm9wdHMucGFja2FnZXN8fFtdKS5mb3JFYWNoKChmdW5jdGlvbihlKXtlLm1ldGFkYXRhLmZpbGVzLmZvckVhY2goKGZ1bmN0aW9uKHQpe3ZhciByPXQuZmlsZW5hbWUuc3Vic3RyKDEpO0FlLmNyZWF0ZU5vZGUobihyKSxvKHIpLEFlLkZJTEVfTU9ERSwwLGUuYmxvYi5zbGljZSh0LnN0YXJ0LHQuZW5kKSl9KSl9KSksdH0sY3JlYXRlTm9kZTpmdW5jdGlvbihlLHQscixuLG8saSl7dmFyIGE9VGUuY3JlYXRlTm9kZShlLHQscik7cmV0dXJuIGEubW9kZT1yLGEubm9kZV9vcHM9QWUubm9kZV9vcHMsYS5zdHJlYW1fb3BzPUFlLnN0cmVhbV9vcHMsYS50aW1lc3RhbXA9KGl8fG5ldyBEYXRlKS5nZXRUaW1lKCkseShBZS5GSUxFX01PREUhPT1BZS5ESVJfTU9ERSkscj09PUFlLkZJTEVfTU9ERT8oYS5zaXplPW8uc2l6ZSxhLmNvbnRlbnRzPW8pOihhLnNpemU9NDA5NixhLmNvbnRlbnRzPXt9KSxlJiYoZS5jb250ZW50c1t0XT1hKSxhfSxub2RlX29wczp7Z2V0YXR0cjpmdW5jdGlvbihlKXtyZXR1cm57ZGV2OjEsaW5vOnZvaWQgMCxtb2RlOmUubW9kZSxubGluazoxLHVpZDowLGdpZDowLHJkZXY6dm9pZCAwLHNpemU6ZS5zaXplLGF0aW1lOm5ldyBEYXRlKGUudGltZXN0YW1wKSxtdGltZTpuZXcgRGF0ZShlLnRpbWVzdGFtcCksY3RpbWU6bmV3IERhdGUoZS50aW1lc3RhbXApLGJsa3NpemU6NDA5NixibG9ja3M6TWF0aC5jZWlsKGUuc2l6ZS80MDk2KX19LHNldGF0dHI6ZnVuY3Rpb24oZSx0KXt2b2lkIDAhPT10Lm1vZGUmJihlLm1vZGU9dC5tb2RlKSx2b2lkIDAhPT10LnRpbWVzdGFtcCYmKGUudGltZXN0YW1wPXQudGltZXN0YW1wKX0sbG9va3VwOmZ1bmN0aW9uKGUsdCl7dGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRU5PRU5UKX0sbWtub2Q6ZnVuY3Rpb24oZSx0LHIsbil7dGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRVBFUk0pfSxyZW5hbWU6ZnVuY3Rpb24oZSx0LHIpe3Rocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVQRVJNKX0sdW5saW5rOmZ1bmN0aW9uKGUsdCl7dGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRVBFUk0pfSxybWRpcjpmdW5jdGlvbihlLHQpe3Rocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVQRVJNKX0scmVhZGRpcjpmdW5jdGlvbihlKXt2YXIgdD1bIi4iLCIuLiJdO2Zvcih2YXIgciBpbiBlLmNvbnRlbnRzKWUuY29udGVudHMuaGFzT3duUHJvcGVydHkocikmJnQucHVzaChyKTtyZXR1cm4gdH0sc3ltbGluazpmdW5jdGlvbihlLHQscil7dGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRVBFUk0pfSxyZWFkbGluazpmdW5jdGlvbihlKXt0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FUEVSTSl9fSxzdHJlYW1fb3BzOntyZWFkOmZ1bmN0aW9uKGUsdCxyLG4sbyl7aWYobz49ZS5ub2RlLnNpemUpcmV0dXJuIDA7dmFyIGk9ZS5ub2RlLmNvbnRlbnRzLnNsaWNlKG8sbytuKSxhPUFlLnJlYWRlci5yZWFkQXNBcnJheUJ1ZmZlcihpKTtyZXR1cm4gdC5zZXQobmV3IFVpbnQ4QXJyYXkoYSksciksaS5zaXplfSx3cml0ZTpmdW5jdGlvbihlLHQscixuLG8pe3Rocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVJTyl9LGxsc2VlazpmdW5jdGlvbihlLHQscil7dmFyIG49dDtpZigxPT09cj9uKz1lLnBvc2l0aW9uOjI9PT1yJiZUZS5pc0ZpbGUoZS5ub2RlLm1vZGUpJiYobis9ZS5ub2RlLnNpemUpLG48MCl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FSU5WQUwpO3JldHVybiBufX19O0wrPTE2LEwrPTE2O3ZhciBUZT17cm9vdDpudWxsLG1vdW50czpbXSxkZXZpY2VzOnt9LHN0cmVhbXM6W10sbmV4dElub2RlOjEsbmFtZVRhYmxlOm51bGwsY3VycmVudFBhdGg6Ii8iLGluaXRpYWxpemVkOiExLGlnbm9yZVBlcm1pc3Npb25zOiEwLHRyYWNraW5nRGVsZWdhdGU6e30sdHJhY2tpbmc6e29wZW5GbGFnczp7UkVBRDoxLFdSSVRFOjJ9fSxFcnJub0Vycm9yOm51bGwsZ2VuZXJpY0Vycm9yczp7fSxmaWxlc3lzdGVtczpudWxsLHN5bmNGU1JlcXVlc3RzOjAsaGFuZGxlRlNFcnJvcjpmdW5jdGlvbihlKXtpZighKGUgaW5zdGFuY2VvZiBUZS5FcnJub0Vycm9yKSl0aHJvdyBlKyIgOiAiK1AoKTtyZXR1cm4geWUoZS5lcnJubyl9LGxvb2t1cFBhdGg6ZnVuY3Rpb24oZSx0KXtpZih0PXR8fHt9LCEoZT1nZS5yZXNvbHZlKFRlLmN3ZCgpLGUpKSlyZXR1cm57cGF0aDoiIixub2RlOm51bGx9O3ZhciByPXtmb2xsb3dfbW91bnQ6ITAscmVjdXJzZV9jb3VudDowfTtmb3IodmFyIG4gaW4gcil2b2lkIDA9PT10W25dJiYodFtuXT1yW25dKTtpZih0LnJlY3Vyc2VfY291bnQ+OCl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FTE9PUCk7Zm9yKHZhciBvPWdlLm5vcm1hbGl6ZUFycmF5KGUuc3BsaXQoIi8iKS5maWx0ZXIoKGZ1bmN0aW9uKGUpe3JldHVybiEhZX0pKSwhMSksaT1UZS5yb290LGE9Ii8iLHM9MDtzPG8ubGVuZ3RoO3MrKyl7dmFyIHU9cz09PW8ubGVuZ3RoLTE7aWYodSYmdC5wYXJlbnQpYnJlYWs7aWYoaT1UZS5sb29rdXBOb2RlKGksb1tzXSksYT1nZS5qb2luMihhLG9bc10pLFRlLmlzTW91bnRwb2ludChpKSYmKCF1fHx1JiZ0LmZvbGxvd19tb3VudCkmJihpPWkubW91bnRlZC5yb290KSwhdXx8dC5mb2xsb3cpZm9yKHZhciBjPTA7VGUuaXNMaW5rKGkubW9kZSk7KXt2YXIgbD1UZS5yZWFkbGluayhhKTtpZihhPWdlLnJlc29sdmUoZ2UuZGlybmFtZShhKSxsKSxpPVRlLmxvb2t1cFBhdGgoYSx7cmVjdXJzZV9jb3VudDp0LnJlY3Vyc2VfY291bnR9KS5ub2RlLGMrKz40MCl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FTE9PUCl9fXJldHVybntwYXRoOmEsbm9kZTppfX0sZ2V0UGF0aDpmdW5jdGlvbihlKXtmb3IodmFyIHQ7Oyl7aWYoVGUuaXNSb290KGUpKXt2YXIgcj1lLm1vdW50Lm1vdW50cG9pbnQ7cmV0dXJuIHQ/Ii8iIT09cltyLmxlbmd0aC0xXT9yKyIvIit0OnIrdDpyfXQ9dD9lLm5hbWUrIi8iK3Q6ZS5uYW1lLGU9ZS5wYXJlbnR9fSxoYXNoTmFtZTpmdW5jdGlvbihlLHQpe2Zvcih2YXIgcj0wLG49MDtuPHQubGVuZ3RoO24rKylyPShyPDw1KS1yK3QuY2hhckNvZGVBdChuKXwwO3JldHVybihlK3I+Pj4wKSVUZS5uYW1lVGFibGUubGVuZ3RofSxoYXNoQWRkTm9kZTpmdW5jdGlvbihlKXt2YXIgdD1UZS5oYXNoTmFtZShlLnBhcmVudC5pZCxlLm5hbWUpO2UubmFtZV9uZXh0PVRlLm5hbWVUYWJsZVt0XSxUZS5uYW1lVGFibGVbdF09ZX0saGFzaFJlbW92ZU5vZGU6ZnVuY3Rpb24oZSl7dmFyIHQ9VGUuaGFzaE5hbWUoZS5wYXJlbnQuaWQsZS5uYW1lKTtpZihUZS5uYW1lVGFibGVbdF09PT1lKVRlLm5hbWVUYWJsZVt0XT1lLm5hbWVfbmV4dDtlbHNlIGZvcih2YXIgcj1UZS5uYW1lVGFibGVbdF07cjspe2lmKHIubmFtZV9uZXh0PT09ZSl7ci5uYW1lX25leHQ9ZS5uYW1lX25leHQ7YnJlYWt9cj1yLm5hbWVfbmV4dH19LGxvb2t1cE5vZGU6ZnVuY3Rpb24oZSx0KXt2YXIgcj1UZS5tYXlMb29rdXAoZSk7aWYocil0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihyLGUpO2Zvcih2YXIgbj1UZS5oYXNoTmFtZShlLmlkLHQpLG89VGUubmFtZVRhYmxlW25dO287bz1vLm5hbWVfbmV4dCl7dmFyIGk9by5uYW1lO2lmKG8ucGFyZW50LmlkPT09ZS5pZCYmaT09PXQpcmV0dXJuIG99cmV0dXJuIFRlLmxvb2t1cChlLHQpfSxjcmVhdGVOb2RlOmZ1bmN0aW9uKGUsdCxyLG4pe2lmKCFUZS5GU05vZGUpe1RlLkZTTm9kZT1mdW5jdGlvbihlLHQscixuKXtlfHwoZT10aGlzKSx0aGlzLnBhcmVudD1lLHRoaXMubW91bnQ9ZS5tb3VudCx0aGlzLm1vdW50ZWQ9bnVsbCx0aGlzLmlkPVRlLm5leHRJbm9kZSsrLHRoaXMubmFtZT10LHRoaXMubW9kZT1yLHRoaXMubm9kZV9vcHM9e30sdGhpcy5zdHJlYW1fb3BzPXt9LHRoaXMucmRldj1ufSxUZS5GU05vZGUucHJvdG90eXBlPXt9O09iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKFRlLkZTTm9kZS5wcm90b3R5cGUse3JlYWQ6e2dldDpmdW5jdGlvbigpe3JldHVybiAzNjU9PSgzNjUmdGhpcy5tb2RlKX0sc2V0OmZ1bmN0aW9uKGUpe2U/dGhpcy5tb2RlfD0zNjU6dGhpcy5tb2RlJj0tMzY2fX0sd3JpdGU6e2dldDpmdW5jdGlvbigpe3JldHVybiAxNDY9PSgxNDYmdGhpcy5tb2RlKX0sc2V0OmZ1bmN0aW9uKGUpe2U/dGhpcy5tb2RlfD0xNDY6dGhpcy5tb2RlJj0tMTQ3fX0saXNGb2xkZXI6e2dldDpmdW5jdGlvbigpe3JldHVybiBUZS5pc0Rpcih0aGlzLm1vZGUpfX0saXNEZXZpY2U6e2dldDpmdW5jdGlvbigpe3JldHVybiBUZS5pc0NocmRldih0aGlzLm1vZGUpfX19KX12YXIgbz1uZXcgVGUuRlNOb2RlKGUsdCxyLG4pO3JldHVybiBUZS5oYXNoQWRkTm9kZShvKSxvfSxkZXN0cm95Tm9kZTpmdW5jdGlvbihlKXtUZS5oYXNoUmVtb3ZlTm9kZShlKX0saXNSb290OmZ1bmN0aW9uKGUpe3JldHVybiBlPT09ZS5wYXJlbnR9LGlzTW91bnRwb2ludDpmdW5jdGlvbihlKXtyZXR1cm4hIWUubW91bnRlZH0saXNGaWxlOmZ1bmN0aW9uKGUpe3JldHVybiAzMjc2OD09KDYxNDQwJmUpfSxpc0RpcjpmdW5jdGlvbihlKXtyZXR1cm4gMTYzODQ9PSg2MTQ0MCZlKX0saXNMaW5rOmZ1bmN0aW9uKGUpe3JldHVybiA0MDk2MD09KDYxNDQwJmUpfSxpc0NocmRldjpmdW5jdGlvbihlKXtyZXR1cm4gODE5Mj09KDYxNDQwJmUpfSxpc0Jsa2RldjpmdW5jdGlvbihlKXtyZXR1cm4gMjQ1NzY9PSg2MTQ0MCZlKX0saXNGSUZPOmZ1bmN0aW9uKGUpe3JldHVybiA0MDk2PT0oNjE0NDAmZSl9LGlzU29ja2V0OmZ1bmN0aW9uKGUpe3JldHVybiA0OTE1Mj09KDQ5MTUyJmUpfSxmbGFnTW9kZXM6e3I6MCxyczoxMDUyNjcyLCJyKyI6Mix3OjU3Nyx3eDo3MDUseHc6NzA1LCJ3KyI6NTc4LCJ3eCsiOjcwNiwieHcrIjo3MDYsYToxMDg5LGF4OjEyMTcseGE6MTIxNywiYSsiOjEwOTAsImF4KyI6MTIxOCwieGErIjoxMjE4fSxtb2RlU3RyaW5nVG9GbGFnczpmdW5jdGlvbihlKXt2YXIgdD1UZS5mbGFnTW9kZXNbZV07aWYodm9pZCAwPT09dCl0aHJvdyBuZXcgRXJyb3IoIlVua25vd24gZmlsZSBvcGVuIG1vZGU6ICIrZSk7cmV0dXJuIHR9LGZsYWdzVG9QZXJtaXNzaW9uU3RyaW5nOmZ1bmN0aW9uKGUpe3ZhciB0PVsiciIsInciLCJydyJdWzMmZV07cmV0dXJuIDUxMiZlJiYodCs9InciKSx0fSxub2RlUGVybWlzc2lvbnM6ZnVuY3Rpb24oZSx0KXtyZXR1cm4gVGUuaWdub3JlUGVybWlzc2lvbnN8fCgtMT09PXQuaW5kZXhPZigiciIpfHwyOTImZS5tb2RlKSYmKC0xPT09dC5pbmRleE9mKCJ3Iil8fDE0NiZlLm1vZGUpJiYoLTE9PT10LmluZGV4T2YoIngiKXx8NzMmZS5tb2RlKT8wOm1lLkVBQ0NFU30sbWF5TG9va3VwOmZ1bmN0aW9uKGUpe3ZhciB0PVRlLm5vZGVQZXJtaXNzaW9ucyhlLCJ4Iik7cmV0dXJuIHR8fChlLm5vZGVfb3BzLmxvb2t1cD8wOm1lLkVBQ0NFUyl9LG1heUNyZWF0ZTpmdW5jdGlvbihlLHQpe3RyeXtUZS5sb29rdXBOb2RlKGUsdCk7cmV0dXJuIG1lLkVFWElTVH1jYXRjaChlKXt9cmV0dXJuIFRlLm5vZGVQZXJtaXNzaW9ucyhlLCJ3eCIpfSxtYXlEZWxldGU6ZnVuY3Rpb24oZSx0LHIpe3ZhciBuO3RyeXtuPVRlLmxvb2t1cE5vZGUoZSx0KX1jYXRjaChlKXtyZXR1cm4gZS5lcnJub312YXIgbz1UZS5ub2RlUGVybWlzc2lvbnMoZSwid3giKTtpZihvKXJldHVybiBvO2lmKHIpe2lmKCFUZS5pc0RpcihuLm1vZGUpKXJldHVybiBtZS5FTk9URElSO2lmKFRlLmlzUm9vdChuKXx8VGUuZ2V0UGF0aChuKT09PVRlLmN3ZCgpKXJldHVybiBtZS5FQlVTWX1lbHNlIGlmKFRlLmlzRGlyKG4ubW9kZSkpcmV0dXJuIG1lLkVJU0RJUjtyZXR1cm4gMH0sbWF5T3BlbjpmdW5jdGlvbihlLHQpe3JldHVybiBlP1RlLmlzTGluayhlLm1vZGUpP21lLkVMT09QOlRlLmlzRGlyKGUubW9kZSkmJigiciIhPT1UZS5mbGFnc1RvUGVybWlzc2lvblN0cmluZyh0KXx8NTEyJnQpP21lLkVJU0RJUjpUZS5ub2RlUGVybWlzc2lvbnMoZSxUZS5mbGFnc1RvUGVybWlzc2lvblN0cmluZyh0KSk6bWUuRU5PRU5UfSxNQVhfT1BFTl9GRFM6NDA5NixuZXh0ZmQ6ZnVuY3Rpb24oZSx0KXtlPWV8fDAsdD10fHxUZS5NQVhfT1BFTl9GRFM7Zm9yKHZhciByPWU7cjw9dDtyKyspaWYoIVRlLnN0cmVhbXNbcl0pcmV0dXJuIHI7dGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRU1GSUxFKX0sZ2V0U3RyZWFtOmZ1bmN0aW9uKGUpe3JldHVybiBUZS5zdHJlYW1zW2VdfSxjcmVhdGVTdHJlYW06ZnVuY3Rpb24oZSx0LHIpe1RlLkZTU3RyZWFtfHwoVGUuRlNTdHJlYW09ZnVuY3Rpb24oKXt9LFRlLkZTU3RyZWFtLnByb3RvdHlwZT17fSxPYmplY3QuZGVmaW5lUHJvcGVydGllcyhUZS5GU1N0cmVhbS5wcm90b3R5cGUse29iamVjdDp7Z2V0OmZ1bmN0aW9uKCl7cmV0dXJuIHRoaXMubm9kZX0sc2V0OmZ1bmN0aW9uKGUpe3RoaXMubm9kZT1lfX0saXNSZWFkOntnZXQ6ZnVuY3Rpb24oKXtyZXR1cm4gMSE9KDIwOTcxNTUmdGhpcy5mbGFncyl9fSxpc1dyaXRlOntnZXQ6ZnVuY3Rpb24oKXtyZXR1cm4gMCE9KDIwOTcxNTUmdGhpcy5mbGFncyl9fSxpc0FwcGVuZDp7Z2V0OmZ1bmN0aW9uKCl7cmV0dXJuIDEwMjQmdGhpcy5mbGFnc319fSkpO3ZhciBuPW5ldyBUZS5GU1N0cmVhbTtmb3IodmFyIG8gaW4gZSluW29dPWVbb107ZT1uO3ZhciBpPVRlLm5leHRmZCh0LHIpO3JldHVybiBlLmZkPWksVGUuc3RyZWFtc1tpXT1lLGV9LGNsb3NlU3RyZWFtOmZ1bmN0aW9uKGUpe1RlLnN0cmVhbXNbZV09bnVsbH0sY2hyZGV2X3N0cmVhbV9vcHM6e29wZW46ZnVuY3Rpb24oZSl7dmFyIHQ9VGUuZ2V0RGV2aWNlKGUubm9kZS5yZGV2KTtlLnN0cmVhbV9vcHM9dC5zdHJlYW1fb3BzLGUuc3RyZWFtX29wcy5vcGVuJiZlLnN0cmVhbV9vcHMub3BlbihlKX0sbGxzZWVrOmZ1bmN0aW9uKCl7dGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRVNQSVBFKX19LG1ham9yOmZ1bmN0aW9uKGUpe3JldHVybiBlPj44fSxtaW5vcjpmdW5jdGlvbihlKXtyZXR1cm4gMjU1JmV9LG1ha2VkZXY6ZnVuY3Rpb24oZSx0KXtyZXR1cm4gZTw8OHx0fSxyZWdpc3RlckRldmljZTpmdW5jdGlvbihlLHQpe1RlLmRldmljZXNbZV09e3N0cmVhbV9vcHM6dH19LGdldERldmljZTpmdW5jdGlvbihlKXtyZXR1cm4gVGUuZGV2aWNlc1tlXX0sZ2V0TW91bnRzOmZ1bmN0aW9uKGUpe2Zvcih2YXIgdD1bXSxyPVtlXTtyLmxlbmd0aDspe3ZhciBuPXIucG9wKCk7dC5wdXNoKG4pLHIucHVzaC5hcHBseShyLG4ubW91bnRzKX1yZXR1cm4gdH0sc3luY2ZzOmZ1bmN0aW9uKGUsdCl7ImZ1bmN0aW9uIj09dHlwZW9mIGUmJih0PWUsZT0hMSksVGUuc3luY0ZTUmVxdWVzdHMrKyxUZS5zeW5jRlNSZXF1ZXN0cz4xJiZjb25zb2xlLmxvZygid2FybmluZzogIitUZS5zeW5jRlNSZXF1ZXN0cysiIEZTLnN5bmNmcyBvcGVyYXRpb25zIGluIGZsaWdodCBhdCBvbmNlLCBwcm9iYWJseSBqdXN0IGRvaW5nIGV4dHJhIHdvcmsiKTt2YXIgcj1UZS5nZXRNb3VudHMoVGUucm9vdC5tb3VudCksbj0wO2Z1bmN0aW9uIG8oZSl7cmV0dXJuIHkoVGUuc3luY0ZTUmVxdWVzdHM+MCksVGUuc3luY0ZTUmVxdWVzdHMtLSx0KGUpfWZ1bmN0aW9uIGkoZSl7aWYoZSlyZXR1cm4gaS5lcnJvcmVkP3ZvaWQgMDooaS5lcnJvcmVkPSEwLG8oZSkpOysrbj49ci5sZW5ndGgmJm8obnVsbCl9ci5mb3JFYWNoKChmdW5jdGlvbih0KXtpZighdC50eXBlLnN5bmNmcylyZXR1cm4gaShudWxsKTt0LnR5cGUuc3luY2ZzKHQsZSxpKX0pKX0sbW91bnQ6ZnVuY3Rpb24oZSx0LHIpe3ZhciBuLG89Ii8iPT09cixpPSFyO2lmKG8mJlRlLnJvb3QpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRUJVU1kpO2lmKCFvJiYhaSl7dmFyIGE9VGUubG9va3VwUGF0aChyLHtmb2xsb3dfbW91bnQ6ITF9KTtpZihyPWEucGF0aCxuPWEubm9kZSxUZS5pc01vdW50cG9pbnQobikpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRUJVU1kpO2lmKCFUZS5pc0RpcihuLm1vZGUpKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVOT1RESVIpfXZhciBzPXt0eXBlOmUsb3B0czp0LG1vdW50cG9pbnQ6cixtb3VudHM6W119LHU9ZS5tb3VudChzKTtyZXR1cm4gdS5tb3VudD1zLHMucm9vdD11LG8/VGUucm9vdD11Om4mJihuLm1vdW50ZWQ9cyxuLm1vdW50JiZuLm1vdW50Lm1vdW50cy5wdXNoKHMpKSx1fSx1bm1vdW50OmZ1bmN0aW9uKGUpe3ZhciB0PVRlLmxvb2t1cFBhdGgoZSx7Zm9sbG93X21vdW50OiExfSk7aWYoIVRlLmlzTW91bnRwb2ludCh0Lm5vZGUpKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVJTlZBTCk7dmFyIHI9dC5ub2RlLG49ci5tb3VudGVkLG89VGUuZ2V0TW91bnRzKG4pO09iamVjdC5rZXlzKFRlLm5hbWVUYWJsZSkuZm9yRWFjaCgoZnVuY3Rpb24oZSl7Zm9yKHZhciB0PVRlLm5hbWVUYWJsZVtlXTt0Oyl7dmFyIHI9dC5uYW1lX25leHQ7LTEhPT1vLmluZGV4T2YodC5tb3VudCkmJlRlLmRlc3Ryb3lOb2RlKHQpLHQ9cn19KSksci5tb3VudGVkPW51bGw7dmFyIGk9ci5tb3VudC5tb3VudHMuaW5kZXhPZihuKTt5KC0xIT09aSksci5tb3VudC5tb3VudHMuc3BsaWNlKGksMSl9LGxvb2t1cDpmdW5jdGlvbihlLHQpe3JldHVybiBlLm5vZGVfb3BzLmxvb2t1cChlLHQpfSxta25vZDpmdW5jdGlvbihlLHQscil7dmFyIG49VGUubG9va3VwUGF0aChlLHtwYXJlbnQ6ITB9KS5ub2RlLG89Z2UuYmFzZW5hbWUoZSk7aWYoIW98fCIuIj09PW98fCIuLiI9PT1vKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVJTlZBTCk7dmFyIGk9VGUubWF5Q3JlYXRlKG4sbyk7aWYoaSl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihpKTtpZighbi5ub2RlX29wcy5ta25vZCl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FUEVSTSk7cmV0dXJuIG4ubm9kZV9vcHMubWtub2QobixvLHQscil9LGNyZWF0ZTpmdW5jdGlvbihlLHQpe3JldHVybiB0PXZvaWQgMCE9PXQ/dDo0MzgsdCY9NDA5NSx0fD0zMjc2OCxUZS5ta25vZChlLHQsMCl9LG1rZGlyOmZ1bmN0aW9uKGUsdCl7cmV0dXJuIHQ9dm9pZCAwIT09dD90OjUxMSx0Jj0xMDIzLHR8PTE2Mzg0LFRlLm1rbm9kKGUsdCwwKX0sbWtkaXJUcmVlOmZ1bmN0aW9uKGUsdCl7Zm9yKHZhciByPWUuc3BsaXQoIi8iKSxuPSIiLG89MDtvPHIubGVuZ3RoOysrbylpZihyW29dKXtuKz0iLyIrcltvXTt0cnl7VGUubWtkaXIobix0KX1jYXRjaChlKXtpZihlLmVycm5vIT1tZS5FRVhJU1QpdGhyb3cgZX19fSxta2RldjpmdW5jdGlvbihlLHQscil7cmV0dXJuIHZvaWQgMD09PXImJihyPXQsdD00MzgpLHR8PTgxOTIsVGUubWtub2QoZSx0LHIpfSxzeW1saW5rOmZ1bmN0aW9uKGUsdCl7aWYoIWdlLnJlc29sdmUoZSkpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRU5PRU5UKTt2YXIgcj1UZS5sb29rdXBQYXRoKHQse3BhcmVudDohMH0pLm5vZGU7aWYoIXIpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRU5PRU5UKTt2YXIgbj1nZS5iYXNlbmFtZSh0KSxvPVRlLm1heUNyZWF0ZShyLG4pO2lmKG8pdGhyb3cgbmV3IFRlLkVycm5vRXJyb3Iobyk7aWYoIXIubm9kZV9vcHMuc3ltbGluayl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FUEVSTSk7cmV0dXJuIHIubm9kZV9vcHMuc3ltbGluayhyLG4sZSl9LHJlbmFtZTpmdW5jdGlvbihlLHQpe3ZhciByLG4sbz1nZS5kaXJuYW1lKGUpLGk9Z2UuZGlybmFtZSh0KSxhPWdlLmJhc2VuYW1lKGUpLHM9Z2UuYmFzZW5hbWUodCk7dHJ5e3I9VGUubG9va3VwUGF0aChlLHtwYXJlbnQ6ITB9KS5ub2RlLG49VGUubG9va3VwUGF0aCh0LHtwYXJlbnQ6ITB9KS5ub2RlfWNhdGNoKGUpe3Rocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVCVVNZKX1pZighcnx8IW4pdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRU5PRU5UKTtpZihyLm1vdW50IT09bi5tb3VudCl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FWERFVik7dmFyIHUsYz1UZS5sb29rdXBOb2RlKHIsYSksbD1nZS5yZWxhdGl2ZShlLGkpO2lmKCIuIiE9PWwuY2hhckF0KDApKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVJTlZBTCk7aWYoIi4iIT09KGw9Z2UucmVsYXRpdmUodCxvKSkuY2hhckF0KDApKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVOT1RFTVBUWSk7dHJ5e3U9VGUubG9va3VwTm9kZShuLHMpfWNhdGNoKGUpe31pZihjIT09dSl7dmFyIGY9VGUuaXNEaXIoYy5tb2RlKSxkPVRlLm1heURlbGV0ZShyLGEsZik7aWYoZCl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihkKTtpZihkPXU/VGUubWF5RGVsZXRlKG4scyxmKTpUZS5tYXlDcmVhdGUobixzKSl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihkKTtpZighci5ub2RlX29wcy5yZW5hbWUpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRVBFUk0pO2lmKFRlLmlzTW91bnRwb2ludChjKXx8dSYmVGUuaXNNb3VudHBvaW50KHUpKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVCVVNZKTtpZihuIT09ciYmKGQ9VGUubm9kZVBlcm1pc3Npb25zKHIsInciKSkpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IoZCk7dHJ5e1RlLnRyYWNraW5nRGVsZWdhdGUud2lsbE1vdmVQYXRoJiZUZS50cmFja2luZ0RlbGVnYXRlLndpbGxNb3ZlUGF0aChlLHQpfWNhdGNoKHIpe2NvbnNvbGUubG9nKCJGUy50cmFja2luZ0RlbGVnYXRlWyd3aWxsTW92ZVBhdGgnXSgnIitlKyInLCAnIit0KyInKSB0aHJldyBhbiBleGNlcHRpb246ICIrci5tZXNzYWdlKX1UZS5oYXNoUmVtb3ZlTm9kZShjKTt0cnl7ci5ub2RlX29wcy5yZW5hbWUoYyxuLHMpfWNhdGNoKGUpe3Rocm93IGV9ZmluYWxseXtUZS5oYXNoQWRkTm9kZShjKX10cnl7VGUudHJhY2tpbmdEZWxlZ2F0ZS5vbk1vdmVQYXRoJiZUZS50cmFja2luZ0RlbGVnYXRlLm9uTW92ZVBhdGgoZSx0KX1jYXRjaChyKXtjb25zb2xlLmxvZygiRlMudHJhY2tpbmdEZWxlZ2F0ZVsnb25Nb3ZlUGF0aCddKCciK2UrIicsICciK3QrIicpIHRocmV3IGFuIGV4Y2VwdGlvbjogIityLm1lc3NhZ2UpfX19LHJtZGlyOmZ1bmN0aW9uKGUpe3ZhciB0PVRlLmxvb2t1cFBhdGgoZSx7cGFyZW50OiEwfSkubm9kZSxyPWdlLmJhc2VuYW1lKGUpLG49VGUubG9va3VwTm9kZSh0LHIpLG89VGUubWF5RGVsZXRlKHQsciwhMCk7aWYobyl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihvKTtpZighdC5ub2RlX29wcy5ybWRpcil0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FUEVSTSk7aWYoVGUuaXNNb3VudHBvaW50KG4pKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVCVVNZKTt0cnl7VGUudHJhY2tpbmdEZWxlZ2F0ZS53aWxsRGVsZXRlUGF0aCYmVGUudHJhY2tpbmdEZWxlZ2F0ZS53aWxsRGVsZXRlUGF0aChlKX1jYXRjaCh0KXtjb25zb2xlLmxvZygiRlMudHJhY2tpbmdEZWxlZ2F0ZVsnd2lsbERlbGV0ZVBhdGgnXSgnIitlKyInKSB0aHJldyBhbiBleGNlcHRpb246ICIrdC5tZXNzYWdlKX10Lm5vZGVfb3BzLnJtZGlyKHQsciksVGUuZGVzdHJveU5vZGUobik7dHJ5e1RlLnRyYWNraW5nRGVsZWdhdGUub25EZWxldGVQYXRoJiZUZS50cmFja2luZ0RlbGVnYXRlLm9uRGVsZXRlUGF0aChlKX1jYXRjaCh0KXtjb25zb2xlLmxvZygiRlMudHJhY2tpbmdEZWxlZ2F0ZVsnb25EZWxldGVQYXRoJ10oJyIrZSsiJykgdGhyZXcgYW4gZXhjZXB0aW9uOiAiK3QubWVzc2FnZSl9fSxyZWFkZGlyOmZ1bmN0aW9uKGUpe3ZhciB0PVRlLmxvb2t1cFBhdGgoZSx7Zm9sbG93OiEwfSkubm9kZTtpZighdC5ub2RlX29wcy5yZWFkZGlyKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVOT1RESVIpO3JldHVybiB0Lm5vZGVfb3BzLnJlYWRkaXIodCl9LHVubGluazpmdW5jdGlvbihlKXt2YXIgdD1UZS5sb29rdXBQYXRoKGUse3BhcmVudDohMH0pLm5vZGUscj1nZS5iYXNlbmFtZShlKSxuPVRlLmxvb2t1cE5vZGUodCxyKSxvPVRlLm1heURlbGV0ZSh0LHIsITEpO2lmKG8pdGhyb3cgbmV3IFRlLkVycm5vRXJyb3Iobyk7aWYoIXQubm9kZV9vcHMudW5saW5rKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVQRVJNKTtpZihUZS5pc01vdW50cG9pbnQobikpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRUJVU1kpO3RyeXtUZS50cmFja2luZ0RlbGVnYXRlLndpbGxEZWxldGVQYXRoJiZUZS50cmFja2luZ0RlbGVnYXRlLndpbGxEZWxldGVQYXRoKGUpfWNhdGNoKHQpe2NvbnNvbGUubG9nKCJGUy50cmFja2luZ0RlbGVnYXRlWyd3aWxsRGVsZXRlUGF0aCddKCciK2UrIicpIHRocmV3IGFuIGV4Y2VwdGlvbjogIit0Lm1lc3NhZ2UpfXQubm9kZV9vcHMudW5saW5rKHQsciksVGUuZGVzdHJveU5vZGUobik7dHJ5e1RlLnRyYWNraW5nRGVsZWdhdGUub25EZWxldGVQYXRoJiZUZS50cmFja2luZ0RlbGVnYXRlLm9uRGVsZXRlUGF0aChlKX1jYXRjaCh0KXtjb25zb2xlLmxvZygiRlMudHJhY2tpbmdEZWxlZ2F0ZVsnb25EZWxldGVQYXRoJ10oJyIrZSsiJykgdGhyZXcgYW4gZXhjZXB0aW9uOiAiK3QubWVzc2FnZSl9fSxyZWFkbGluazpmdW5jdGlvbihlKXt2YXIgdD1UZS5sb29rdXBQYXRoKGUpLm5vZGU7aWYoIXQpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRU5PRU5UKTtpZighdC5ub2RlX29wcy5yZWFkbGluayl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FSU5WQUwpO3JldHVybiBnZS5yZXNvbHZlKFRlLmdldFBhdGgodC5wYXJlbnQpLHQubm9kZV9vcHMucmVhZGxpbmsodCkpfSxzdGF0OmZ1bmN0aW9uKGUsdCl7dmFyIHI9VGUubG9va3VwUGF0aChlLHtmb2xsb3c6IXR9KS5ub2RlO2lmKCFyKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVOT0VOVCk7aWYoIXIubm9kZV9vcHMuZ2V0YXR0cil0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FUEVSTSk7cmV0dXJuIHIubm9kZV9vcHMuZ2V0YXR0cihyKX0sbHN0YXQ6ZnVuY3Rpb24oZSl7cmV0dXJuIFRlLnN0YXQoZSwhMCl9LGNobW9kOmZ1bmN0aW9uKGUsdCxyKXt2YXIgbjsic3RyaW5nIj09dHlwZW9mIGU/bj1UZS5sb29rdXBQYXRoKGUse2ZvbGxvdzohcn0pLm5vZGU6bj1lO2lmKCFuLm5vZGVfb3BzLnNldGF0dHIpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRVBFUk0pO24ubm9kZV9vcHMuc2V0YXR0cihuLHttb2RlOjQwOTUmdHwtNDA5NiZuLm1vZGUsdGltZXN0YW1wOkRhdGUubm93KCl9KX0sbGNobW9kOmZ1bmN0aW9uKGUsdCl7VGUuY2htb2QoZSx0LCEwKX0sZmNobW9kOmZ1bmN0aW9uKGUsdCl7dmFyIHI9VGUuZ2V0U3RyZWFtKGUpO2lmKCFyKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVCQURGKTtUZS5jaG1vZChyLm5vZGUsdCl9LGNob3duOmZ1bmN0aW9uKGUsdCxyLG4pe3ZhciBvOyJzdHJpbmciPT10eXBlb2YgZT9vPVRlLmxvb2t1cFBhdGgoZSx7Zm9sbG93OiFufSkubm9kZTpvPWU7aWYoIW8ubm9kZV9vcHMuc2V0YXR0cil0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FUEVSTSk7by5ub2RlX29wcy5zZXRhdHRyKG8se3RpbWVzdGFtcDpEYXRlLm5vdygpfSl9LGxjaG93bjpmdW5jdGlvbihlLHQscil7VGUuY2hvd24oZSx0LHIsITApfSxmY2hvd246ZnVuY3Rpb24oZSx0LHIpe3ZhciBuPVRlLmdldFN0cmVhbShlKTtpZighbil0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FQkFERik7VGUuY2hvd24obi5ub2RlLHQscil9LHRydW5jYXRlOmZ1bmN0aW9uKGUsdCl7aWYodDwwKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVJTlZBTCk7dmFyIHI7InN0cmluZyI9PXR5cGVvZiBlP3I9VGUubG9va3VwUGF0aChlLHtmb2xsb3c6ITB9KS5ub2RlOnI9ZTtpZighci5ub2RlX29wcy5zZXRhdHRyKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVQRVJNKTtpZihUZS5pc0RpcihyLm1vZGUpKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVJU0RJUik7aWYoIVRlLmlzRmlsZShyLm1vZGUpKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVJTlZBTCk7dmFyIG49VGUubm9kZVBlcm1pc3Npb25zKHIsInciKTtpZihuKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG4pO3Iubm9kZV9vcHMuc2V0YXR0cihyLHtzaXplOnQsdGltZXN0YW1wOkRhdGUubm93KCl9KX0sZnRydW5jYXRlOmZ1bmN0aW9uKGUsdCl7dmFyIHI9VGUuZ2V0U3RyZWFtKGUpO2lmKCFyKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVCQURGKTtpZigwPT0oMjA5NzE1NSZyLmZsYWdzKSl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FSU5WQUwpO1RlLnRydW5jYXRlKHIubm9kZSx0KX0sdXRpbWU6ZnVuY3Rpb24oZSx0LHIpe3ZhciBuPVRlLmxvb2t1cFBhdGgoZSx7Zm9sbG93OiEwfSkubm9kZTtuLm5vZGVfb3BzLnNldGF0dHIobix7dGltZXN0YW1wOk1hdGgubWF4KHQscil9KX0sb3BlbjpmdW5jdGlvbihlLHQscixuLGkpe2lmKCIiPT09ZSl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FTk9FTlQpO3ZhciBhO2lmKHI9dm9pZCAwPT09cj80Mzg6cixyPTY0Jih0PSJzdHJpbmciPT10eXBlb2YgdD9UZS5tb2RlU3RyaW5nVG9GbGFncyh0KTp0KT80MDk1JnJ8MzI3Njg6MCwib2JqZWN0Ij09dHlwZW9mIGUpYT1lO2Vsc2V7ZT1nZS5ub3JtYWxpemUoZSk7dHJ5e2E9VGUubG9va3VwUGF0aChlLHtmb2xsb3c6ISgxMzEwNzImdCl9KS5ub2RlfWNhdGNoKGUpe319dmFyIHM9ITE7aWYoNjQmdClpZihhKXtpZigxMjgmdCl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FRVhJU1QpfWVsc2UgYT1UZS5ta25vZChlLHIsMCkscz0hMDtpZighYSl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FTk9FTlQpO2lmKFRlLmlzQ2hyZGV2KGEubW9kZSkmJih0Jj0tNTEzKSw2NTUzNiZ0JiYhVGUuaXNEaXIoYS5tb2RlKSl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FTk9URElSKTtpZighcyl7dmFyIHU9VGUubWF5T3BlbihhLHQpO2lmKHUpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IodSl9NTEyJnQmJlRlLnRydW5jYXRlKGEsMCksdCY9LTY0MTt2YXIgYz1UZS5jcmVhdGVTdHJlYW0oe25vZGU6YSxwYXRoOlRlLmdldFBhdGgoYSksZmxhZ3M6dCxzZWVrYWJsZTohMCxwb3NpdGlvbjowLHN0cmVhbV9vcHM6YS5zdHJlYW1fb3BzLHVuZ290dGVuOltdLGVycm9yOiExfSxuLGkpO2Muc3RyZWFtX29wcy5vcGVuJiZjLnN0cmVhbV9vcHMub3BlbihjKSwhby5sb2dSZWFkRmlsZXN8fDEmdHx8KFRlLnJlYWRGaWxlc3x8KFRlLnJlYWRGaWxlcz17fSksZSBpbiBUZS5yZWFkRmlsZXN8fChUZS5yZWFkRmlsZXNbZV09MSxvLnByaW50RXJyKCJyZWFkIGZpbGU6ICIrZSkpKTt0cnl7aWYoVGUudHJhY2tpbmdEZWxlZ2F0ZS5vbk9wZW5GaWxlKXt2YXIgbD0wOzEhPSgyMDk3MTU1JnQpJiYobHw9VGUudHJhY2tpbmcub3BlbkZsYWdzLlJFQUQpLDAhPSgyMDk3MTU1JnQpJiYobHw9VGUudHJhY2tpbmcub3BlbkZsYWdzLldSSVRFKSxUZS50cmFja2luZ0RlbGVnYXRlLm9uT3BlbkZpbGUoZSxsKX19Y2F0Y2godCl7Y29uc29sZS5sb2coIkZTLnRyYWNraW5nRGVsZWdhdGVbJ29uT3BlbkZpbGUnXSgnIitlKyInLCBmbGFncykgdGhyZXcgYW4gZXhjZXB0aW9uOiAiK3QubWVzc2FnZSl9cmV0dXJuIGN9LGNsb3NlOmZ1bmN0aW9uKGUpe2lmKFRlLmlzQ2xvc2VkKGUpKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVCQURGKTtlLmdldGRlbnRzJiYoZS5nZXRkZW50cz1udWxsKTt0cnl7ZS5zdHJlYW1fb3BzLmNsb3NlJiZlLnN0cmVhbV9vcHMuY2xvc2UoZSl9Y2F0Y2goZSl7dGhyb3cgZX1maW5hbGx5e1RlLmNsb3NlU3RyZWFtKGUuZmQpfWUuZmQ9bnVsbH0saXNDbG9zZWQ6ZnVuY3Rpb24oZSl7cmV0dXJuIG51bGw9PT1lLmZkfSxsbHNlZWs6ZnVuY3Rpb24oZSx0LHIpe2lmKFRlLmlzQ2xvc2VkKGUpKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVCQURGKTtpZighZS5zZWVrYWJsZXx8IWUuc3RyZWFtX29wcy5sbHNlZWspdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRVNQSVBFKTtyZXR1cm4gZS5wb3NpdGlvbj1lLnN0cmVhbV9vcHMubGxzZWVrKGUsdCxyKSxlLnVuZ290dGVuPVtdLGUucG9zaXRpb259LHJlYWQ6ZnVuY3Rpb24oZSx0LHIsbixvKXtpZihuPDB8fG88MCl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FSU5WQUwpO2lmKFRlLmlzQ2xvc2VkKGUpKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVCQURGKTtpZigxPT0oMjA5NzE1NSZlLmZsYWdzKSl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FQkFERik7aWYoVGUuaXNEaXIoZS5ub2RlLm1vZGUpKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVJU0RJUik7aWYoIWUuc3RyZWFtX29wcy5yZWFkKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVJTlZBTCk7dmFyIGk9dm9pZCAwIT09bztpZihpKXtpZighZS5zZWVrYWJsZSl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FU1BJUEUpfWVsc2Ugbz1lLnBvc2l0aW9uO3ZhciBhPWUuc3RyZWFtX29wcy5yZWFkKGUsdCxyLG4sbyk7cmV0dXJuIGl8fChlLnBvc2l0aW9uKz1hKSxhfSx3cml0ZTpmdW5jdGlvbihlLHQscixuLG8saSl7aWYobjwwfHxvPDApdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRUlOVkFMKTtpZihUZS5pc0Nsb3NlZChlKSl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FQkFERik7aWYoMD09KDIwOTcxNTUmZS5mbGFncykpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRUJBREYpO2lmKFRlLmlzRGlyKGUubm9kZS5tb2RlKSl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FSVNESVIpO2lmKCFlLnN0cmVhbV9vcHMud3JpdGUpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRUlOVkFMKTsxMDI0JmUuZmxhZ3MmJlRlLmxsc2VlayhlLDAsMik7dmFyIGE9dm9pZCAwIT09bztpZihhKXtpZighZS5zZWVrYWJsZSl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FU1BJUEUpfWVsc2Ugbz1lLnBvc2l0aW9uO3ZhciBzPWUuc3RyZWFtX29wcy53cml0ZShlLHQscixuLG8saSk7YXx8KGUucG9zaXRpb24rPXMpO3RyeXtlLnBhdGgmJlRlLnRyYWNraW5nRGVsZWdhdGUub25Xcml0ZVRvRmlsZSYmVGUudHJhY2tpbmdEZWxlZ2F0ZS5vbldyaXRlVG9GaWxlKGUucGF0aCl9Y2F0Y2goZSl7Y29uc29sZS5sb2coIkZTLnRyYWNraW5nRGVsZWdhdGVbJ29uV3JpdGVUb0ZpbGUnXSgnIitwYXRoKyInKSB0aHJldyBhbiBleGNlcHRpb246ICIrZS5tZXNzYWdlKX1yZXR1cm4gc30sYWxsb2NhdGU6ZnVuY3Rpb24oZSx0LHIpe2lmKFRlLmlzQ2xvc2VkKGUpKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVCQURGKTtpZih0PDB8fHI8PTApdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRUlOVkFMKTtpZigwPT0oMjA5NzE1NSZlLmZsYWdzKSl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FQkFERik7aWYoIVRlLmlzRmlsZShlLm5vZGUubW9kZSkmJiFUZS5pc0RpcihlLm5vZGUubW9kZSkpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRU5PREVWKTtpZighZS5zdHJlYW1fb3BzLmFsbG9jYXRlKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVPUE5PVFNVUFApO2Uuc3RyZWFtX29wcy5hbGxvY2F0ZShlLHQscil9LG1tYXA6ZnVuY3Rpb24oZSx0LHIsbixvLGksYSl7aWYoMT09KDIwOTcxNTUmZS5mbGFncykpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRUFDQ0VTKTtpZighZS5zdHJlYW1fb3BzLm1tYXApdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRU5PREVWKTtyZXR1cm4gZS5zdHJlYW1fb3BzLm1tYXAoZSx0LHIsbixvLGksYSl9LG1zeW5jOmZ1bmN0aW9uKGUsdCxyLG4sbyl7cmV0dXJuIGUmJmUuc3RyZWFtX29wcy5tc3luYz9lLnN0cmVhbV9vcHMubXN5bmMoZSx0LHIsbixvKTowfSxtdW5tYXA6ZnVuY3Rpb24oZSl7cmV0dXJuIDB9LGlvY3RsOmZ1bmN0aW9uKGUsdCxyKXtpZighZS5zdHJlYW1fb3BzLmlvY3RsKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVOT1RUWSk7cmV0dXJuIGUuc3RyZWFtX29wcy5pb2N0bChlLHQscil9LHJlYWRGaWxlOmZ1bmN0aW9uKGUsdCl7aWYoKHQ9dHx8e30pLmZsYWdzPXQuZmxhZ3N8fCJyIix0LmVuY29kaW5nPXQuZW5jb2Rpbmd8fCJiaW5hcnkiLCJ1dGY4IiE9PXQuZW5jb2RpbmcmJiJiaW5hcnkiIT09dC5lbmNvZGluZyl0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgZW5jb2RpbmcgdHlwZSAiJyt0LmVuY29kaW5nKyciJyk7dmFyIHIsbj1UZS5vcGVuKGUsdC5mbGFncyksbz1UZS5zdGF0KGUpLnNpemUsaT1uZXcgVWludDhBcnJheShvKTtyZXR1cm4gVGUucmVhZChuLGksMCxvLDApLCJ1dGY4Ij09PXQuZW5jb2Rpbmc/cj1fKGksMCk6ImJpbmFyeSI9PT10LmVuY29kaW5nJiYocj1pKSxUZS5jbG9zZShuKSxyfSx3cml0ZUZpbGU6ZnVuY3Rpb24oZSx0LHIpeyhyPXJ8fHt9KS5mbGFncz1yLmZsYWdzfHwidyI7dmFyIG49VGUub3BlbihlLHIuZmxhZ3Msci5tb2RlKTtpZigic3RyaW5nIj09dHlwZW9mIHQpe3ZhciBvPW5ldyBVaW50OEFycmF5KFModCkrMSksaT1BKHQsbywwLG8ubGVuZ3RoKTtUZS53cml0ZShuLG8sMCxpLHZvaWQgMCxyLmNhbk93bil9ZWxzZXtpZighQXJyYXlCdWZmZXIuaXNWaWV3KHQpKXRocm93IG5ldyBFcnJvcigiVW5zdXBwb3J0ZWQgZGF0YSB0eXBlIik7VGUud3JpdGUobix0LDAsdC5ieXRlTGVuZ3RoLHZvaWQgMCxyLmNhbk93bil9VGUuY2xvc2Uobil9LGN3ZDpmdW5jdGlvbigpe3JldHVybiBUZS5jdXJyZW50UGF0aH0sY2hkaXI6ZnVuY3Rpb24oZSl7dmFyIHQ9VGUubG9va3VwUGF0aChlLHtmb2xsb3c6ITB9KTtpZihudWxsPT09dC5ub2RlKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVOT0VOVCk7aWYoIVRlLmlzRGlyKHQubm9kZS5tb2RlKSl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FTk9URElSKTt2YXIgcj1UZS5ub2RlUGVybWlzc2lvbnModC5ub2RlLCJ4Iik7aWYocil0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihyKTtUZS5jdXJyZW50UGF0aD10LnBhdGh9LGNyZWF0ZURlZmF1bHREaXJlY3RvcmllczpmdW5jdGlvbigpe1RlLm1rZGlyKCIvdG1wIiksVGUubWtkaXIoIi9ob21lIiksVGUubWtkaXIoIi9ob21lL3dlYl91c2VyIil9LGNyZWF0ZURlZmF1bHREZXZpY2VzOmZ1bmN0aW9uKCl7dmFyIGU7aWYoVGUubWtkaXIoIi9kZXYiKSxUZS5yZWdpc3RlckRldmljZShUZS5tYWtlZGV2KDEsMykse3JlYWQ6ZnVuY3Rpb24oKXtyZXR1cm4gMH0sd3JpdGU6ZnVuY3Rpb24oZSx0LHIsbixvKXtyZXR1cm4gbn19KSxUZS5ta2RldigiL2Rldi9udWxsIixUZS5tYWtlZGV2KDEsMykpLHZlLnJlZ2lzdGVyKFRlLm1ha2VkZXYoNSwwKSx2ZS5kZWZhdWx0X3R0eV9vcHMpLHZlLnJlZ2lzdGVyKFRlLm1ha2VkZXYoNiwwKSx2ZS5kZWZhdWx0X3R0eTFfb3BzKSxUZS5ta2RldigiL2Rldi90dHkiLFRlLm1ha2VkZXYoNSwwKSksVGUubWtkZXYoIi9kZXYvdHR5MSIsVGUubWFrZWRldig2LDApKSwidW5kZWZpbmVkIiE9dHlwZW9mIGNyeXB0byl7dmFyIHQ9bmV3IFVpbnQ4QXJyYXkoMSk7ZT1mdW5jdGlvbigpe3JldHVybiBjcnlwdG8uZ2V0UmFuZG9tVmFsdWVzKHQpLHRbMF19fWVsc2UgZT1sP2Z1bmN0aW9uKCl7cmV0dXJuIHJlcXVpcmUoImNyeXB0byIpLnJhbmRvbUJ5dGVzKDEpWzBdfTpmdW5jdGlvbigpe3JldHVybiAyNTYqTWF0aC5yYW5kb20oKXwwfTtUZS5jcmVhdGVEZXZpY2UoIi9kZXYiLCJyYW5kb20iLGUpLFRlLmNyZWF0ZURldmljZSgiL2RldiIsInVyYW5kb20iLGUpLFRlLm1rZGlyKCIvZGV2L3NobSIpLFRlLm1rZGlyKCIvZGV2L3NobS90bXAiKX0sY3JlYXRlU3BlY2lhbERpcmVjdG9yaWVzOmZ1bmN0aW9uKCl7VGUubWtkaXIoIi9wcm9jIiksVGUubWtkaXIoIi9wcm9jL3NlbGYiKSxUZS5ta2RpcigiL3Byb2Mvc2VsZi9mZCIpLFRlLm1vdW50KHttb3VudDpmdW5jdGlvbigpe3ZhciBlPVRlLmNyZWF0ZU5vZGUoIi9wcm9jL3NlbGYiLCJmZCIsMTY4OTUsNzMpO3JldHVybiBlLm5vZGVfb3BzPXtsb29rdXA6ZnVuY3Rpb24oZSx0KXt2YXIgcj0rdCxuPVRlLmdldFN0cmVhbShyKTtpZighbil0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FQkFERik7dmFyIG89e3BhcmVudDpudWxsLG1vdW50Onttb3VudHBvaW50OiJmYWtlIn0sbm9kZV9vcHM6e3JlYWRsaW5rOmZ1bmN0aW9uKCl7cmV0dXJuIG4ucGF0aH19fTtyZXR1cm4gby5wYXJlbnQ9byxvfX0sZX19LHt9LCIvcHJvYy9zZWxmL2ZkIil9LGNyZWF0ZVN0YW5kYXJkU3RyZWFtczpmdW5jdGlvbigpe28uc3RkaW4/VGUuY3JlYXRlRGV2aWNlKCIvZGV2Iiwic3RkaW4iLG8uc3RkaW4pOlRlLnN5bWxpbmsoIi9kZXYvdHR5IiwiL2Rldi9zdGRpbiIpLG8uc3Rkb3V0P1RlLmNyZWF0ZURldmljZSgiL2RldiIsInN0ZG91dCIsbnVsbCxvLnN0ZG91dCk6VGUuc3ltbGluaygiL2Rldi90dHkiLCIvZGV2L3N0ZG91dCIpLG8uc3RkZXJyP1RlLmNyZWF0ZURldmljZSgiL2RldiIsInN0ZGVyciIsbnVsbCxvLnN0ZGVycik6VGUuc3ltbGluaygiL2Rldi90dHkxIiwiL2Rldi9zdGRlcnIiKTt2YXIgZT1UZS5vcGVuKCIvZGV2L3N0ZGluIiwiciIpO3koMD09PWUuZmQsImludmFsaWQgaGFuZGxlIGZvciBzdGRpbiAoIitlLmZkKyIpIik7dmFyIHQ9VGUub3BlbigiL2Rldi9zdGRvdXQiLCJ3Iik7eSgxPT09dC5mZCwiaW52YWxpZCBoYW5kbGUgZm9yIHN0ZG91dCAoIit0LmZkKyIpIik7dmFyIHI9VGUub3BlbigiL2Rldi9zdGRlcnIiLCJ3Iik7eSgyPT09ci5mZCwiaW52YWxpZCBoYW5kbGUgZm9yIHN0ZGVyciAoIityLmZkKyIpIil9LGVuc3VyZUVycm5vRXJyb3I6ZnVuY3Rpb24oKXtUZS5FcnJub0Vycm9yfHwoVGUuRXJybm9FcnJvcj1mdW5jdGlvbihlLHQpe3RoaXMubm9kZT10LHRoaXMuc2V0RXJybm89ZnVuY3Rpb24oZSl7Zm9yKHZhciB0IGluIHRoaXMuZXJybm89ZSxtZSlpZihtZVt0XT09PWUpe3RoaXMuY29kZT10O2JyZWFrfX0sdGhpcy5zZXRFcnJubyhlKSx0aGlzLm1lc3NhZ2U9RWVbZV0sdGhpcy5zdGFjayYmT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsInN0YWNrIix7dmFsdWU6KG5ldyBFcnJvcikuc3RhY2ssd3JpdGFibGU6ITB9KX0sVGUuRXJybm9FcnJvci5wcm90b3R5cGU9bmV3IEVycm9yLFRlLkVycm5vRXJyb3IucHJvdG90eXBlLmNvbnN0cnVjdG9yPVRlLkVycm5vRXJyb3IsW21lLkVOT0VOVF0uZm9yRWFjaCgoZnVuY3Rpb24oZSl7VGUuZ2VuZXJpY0Vycm9yc1tlXT1uZXcgVGUuRXJybm9FcnJvcihlKSxUZS5nZW5lcmljRXJyb3JzW2VdLnN0YWNrPSI8Z2VuZXJpYyBlcnJvciwgbm8gc3RhY2s+In0pKSl9LHN0YXRpY0luaXQ6ZnVuY3Rpb24oKXtUZS5lbnN1cmVFcnJub0Vycm9yKCksVGUubmFtZVRhYmxlPW5ldyBBcnJheSg0MDk2KSxUZS5tb3VudCh3ZSx7fSwiLyIpLFRlLmNyZWF0ZURlZmF1bHREaXJlY3RvcmllcygpLFRlLmNyZWF0ZURlZmF1bHREZXZpY2VzKCksVGUuY3JlYXRlU3BlY2lhbERpcmVjdG9yaWVzKCksVGUuZmlsZXN5c3RlbXM9e01FTUZTOndlLElEQkZTOl9lLE5PREVGUzpiZSxXT1JLRVJGUzpBZX19LGluaXQ6ZnVuY3Rpb24oZSx0LHIpe3koIVRlLmluaXQuaW5pdGlhbGl6ZWQsIkZTLmluaXQgd2FzIHByZXZpb3VzbHkgY2FsbGVkLiBJZiB5b3Ugd2FudCB0byBpbml0aWFsaXplIGxhdGVyIHdpdGggY3VzdG9tIHBhcmFtZXRlcnMsIHJlbW92ZSBhbnkgZWFybGllciBjYWxscyAobm90ZSB0aGF0IG9uZSBpcyBhdXRvbWF0aWNhbGx5IGFkZGVkIHRvIHRoZSBnZW5lcmF0ZWQgY29kZSkiKSxUZS5pbml0LmluaXRpYWxpemVkPSEwLFRlLmVuc3VyZUVycm5vRXJyb3IoKSxvLnN0ZGluPWV8fG8uc3RkaW4sby5zdGRvdXQ9dHx8by5zdGRvdXQsby5zdGRlcnI9cnx8by5zdGRlcnIsVGUuY3JlYXRlU3RhbmRhcmRTdHJlYW1zKCl9LHF1aXQ6ZnVuY3Rpb24oKXtUZS5pbml0LmluaXRpYWxpemVkPSExO3ZhciBlPW8uX2ZmbHVzaDtlJiZlKDApO2Zvcih2YXIgdD0wO3Q8VGUuc3RyZWFtcy5sZW5ndGg7dCsrKXt2YXIgcj1UZS5zdHJlYW1zW3RdO3ImJlRlLmNsb3NlKHIpfX0sZ2V0TW9kZTpmdW5jdGlvbihlLHQpe3ZhciByPTA7cmV0dXJuIGUmJihyfD0zNjUpLHQmJihyfD0xNDYpLHJ9LGpvaW5QYXRoOmZ1bmN0aW9uKGUsdCl7dmFyIHI9Z2Uuam9pbi5hcHBseShudWxsLGUpO3JldHVybiB0JiYiLyI9PXJbMF0mJihyPXIuc3Vic3RyKDEpKSxyfSxhYnNvbHV0ZVBhdGg6ZnVuY3Rpb24oZSx0KXtyZXR1cm4gZ2UucmVzb2x2ZSh0LGUpfSxzdGFuZGFyZGl6ZVBhdGg6ZnVuY3Rpb24oZSl7cmV0dXJuIGdlLm5vcm1hbGl6ZShlKX0sZmluZE9iamVjdDpmdW5jdGlvbihlLHQpe3ZhciByPVRlLmFuYWx5emVQYXRoKGUsdCk7cmV0dXJuIHIuZXhpc3RzP3Iub2JqZWN0Oih5ZShyLmVycm9yKSxudWxsKX0sYW5hbHl6ZVBhdGg6ZnVuY3Rpb24oZSx0KXt0cnl7ZT0obj1UZS5sb29rdXBQYXRoKGUse2ZvbGxvdzohdH0pKS5wYXRofWNhdGNoKGUpe312YXIgcj17aXNSb290OiExLGV4aXN0czohMSxlcnJvcjowLG5hbWU6bnVsbCxwYXRoOm51bGwsb2JqZWN0Om51bGwscGFyZW50RXhpc3RzOiExLHBhcmVudFBhdGg6bnVsbCxwYXJlbnRPYmplY3Q6bnVsbH07dHJ5e3ZhciBuPVRlLmxvb2t1cFBhdGgoZSx7cGFyZW50OiEwfSk7ci5wYXJlbnRFeGlzdHM9ITAsci5wYXJlbnRQYXRoPW4ucGF0aCxyLnBhcmVudE9iamVjdD1uLm5vZGUsci5uYW1lPWdlLmJhc2VuYW1lKGUpLG49VGUubG9va3VwUGF0aChlLHtmb2xsb3c6IXR9KSxyLmV4aXN0cz0hMCxyLnBhdGg9bi5wYXRoLHIub2JqZWN0PW4ubm9kZSxyLm5hbWU9bi5ub2RlLm5hbWUsci5pc1Jvb3Q9Ii8iPT09bi5wYXRofWNhdGNoKGUpe3IuZXJyb3I9ZS5lcnJub31yZXR1cm4gcn0sY3JlYXRlRm9sZGVyOmZ1bmN0aW9uKGUsdCxyLG4pe3ZhciBvPWdlLmpvaW4yKCJzdHJpbmciPT10eXBlb2YgZT9lOlRlLmdldFBhdGgoZSksdCksaT1UZS5nZXRNb2RlKHIsbik7cmV0dXJuIFRlLm1rZGlyKG8saSl9LGNyZWF0ZVBhdGg6ZnVuY3Rpb24oZSx0LHIsbil7ZT0ic3RyaW5nIj09dHlwZW9mIGU/ZTpUZS5nZXRQYXRoKGUpO2Zvcih2YXIgbz10LnNwbGl0KCIvIikucmV2ZXJzZSgpO28ubGVuZ3RoOyl7dmFyIGk9by5wb3AoKTtpZihpKXt2YXIgYT1nZS5qb2luMihlLGkpO3RyeXtUZS5ta2RpcihhKX1jYXRjaChlKXt9ZT1hfX1yZXR1cm4gYX0sY3JlYXRlRmlsZTpmdW5jdGlvbihlLHQscixuLG8pe3ZhciBpPWdlLmpvaW4yKCJzdHJpbmciPT10eXBlb2YgZT9lOlRlLmdldFBhdGgoZSksdCksYT1UZS5nZXRNb2RlKG4sbyk7cmV0dXJuIFRlLmNyZWF0ZShpLGEpfSxjcmVhdGVEYXRhRmlsZTpmdW5jdGlvbihlLHQscixuLG8saSl7dmFyIGE9dD9nZS5qb2luMigic3RyaW5nIj09dHlwZW9mIGU/ZTpUZS5nZXRQYXRoKGUpLHQpOmUscz1UZS5nZXRNb2RlKG4sbyksdT1UZS5jcmVhdGUoYSxzKTtpZihyKXtpZigic3RyaW5nIj09dHlwZW9mIHIpe2Zvcih2YXIgYz1uZXcgQXJyYXkoci5sZW5ndGgpLGw9MCxmPXIubGVuZ3RoO2w8ZjsrK2wpY1tsXT1yLmNoYXJDb2RlQXQobCk7cj1jfVRlLmNobW9kKHUsMTQ2fHMpO3ZhciBkPVRlLm9wZW4odSwidyIpO1RlLndyaXRlKGQsciwwLHIubGVuZ3RoLDAsaSksVGUuY2xvc2UoZCksVGUuY2htb2QodSxzKX1yZXR1cm4gdX0sY3JlYXRlRGV2aWNlOmZ1bmN0aW9uKGUsdCxyLG4pe3ZhciBvPWdlLmpvaW4yKCJzdHJpbmciPT10eXBlb2YgZT9lOlRlLmdldFBhdGgoZSksdCksaT1UZS5nZXRNb2RlKCEhciwhIW4pO1RlLmNyZWF0ZURldmljZS5tYWpvcnx8KFRlLmNyZWF0ZURldmljZS5tYWpvcj02NCk7dmFyIGE9VGUubWFrZWRldihUZS5jcmVhdGVEZXZpY2UubWFqb3IrKywwKTtyZXR1cm4gVGUucmVnaXN0ZXJEZXZpY2UoYSx7b3BlbjpmdW5jdGlvbihlKXtlLnNlZWthYmxlPSExfSxjbG9zZTpmdW5jdGlvbihlKXtuJiZuLmJ1ZmZlciYmbi5idWZmZXIubGVuZ3RoJiZuKDEwKX0scmVhZDpmdW5jdGlvbihlLHQsbixvLGkpe2Zvcih2YXIgYT0wLHM9MDtzPG87cysrKXt2YXIgdTt0cnl7dT1yKCl9Y2F0Y2goZSl7dGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRUlPKX1pZih2b2lkIDA9PT11JiYwPT09YSl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FQUdBSU4pO2lmKG51bGw9PXUpYnJlYWs7YSsrLHRbbitzXT11fXJldHVybiBhJiYoZS5ub2RlLnRpbWVzdGFtcD1EYXRlLm5vdygpKSxhfSx3cml0ZTpmdW5jdGlvbihlLHQscixvLGkpe2Zvcih2YXIgYT0wO2E8bzthKyspdHJ5e24odFtyK2FdKX1jYXRjaChlKXt0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FSU8pfXJldHVybiBvJiYoZS5ub2RlLnRpbWVzdGFtcD1EYXRlLm5vdygpKSxhfX0pLFRlLm1rZGV2KG8saSxhKX0sY3JlYXRlTGluazpmdW5jdGlvbihlLHQscixuLG8pe3ZhciBpPWdlLmpvaW4yKCJzdHJpbmciPT10eXBlb2YgZT9lOlRlLmdldFBhdGgoZSksdCk7cmV0dXJuIFRlLnN5bWxpbmsocixpKX0sZm9yY2VMb2FkRmlsZTpmdW5jdGlvbihlKXtpZihlLmlzRGV2aWNlfHxlLmlzRm9sZGVyfHxlLmxpbmt8fGUuY29udGVudHMpcmV0dXJuITA7dmFyIHQ9ITA7aWYoInVuZGVmaW5lZCIhPXR5cGVvZiBYTUxIdHRwUmVxdWVzdCl0aHJvdyBuZXcgRXJyb3IoIkxhenkgbG9hZGluZyBzaG91bGQgaGF2ZSBiZWVuIHBlcmZvcm1lZCAoY29udGVudHMgc2V0KSBpbiBjcmVhdGVMYXp5RmlsZSwgYnV0IGl0IHdhcyBub3QuIExhenkgbG9hZGluZyBvbmx5IHdvcmtzIGluIHdlYiB3b3JrZXJzLiBVc2UgLS1lbWJlZC1maWxlIG9yIC0tcHJlbG9hZC1maWxlIGluIGVtY2Mgb24gdGhlIG1haW4gdGhyZWFkLiIpO2lmKCFvLnJlYWQpdGhyb3cgbmV3IEVycm9yKCJDYW5ub3QgbG9hZCB3aXRob3V0IHJlYWQoKSBvciBYTUxIdHRwUmVxdWVzdC4iKTt0cnl7ZS5jb250ZW50cz0kdChvLnJlYWQoZS51cmwpLCEwKSxlLnVzZWRCeXRlcz1lLmNvbnRlbnRzLmxlbmd0aH1jYXRjaChlKXt0PSExfXJldHVybiB0fHx5ZShtZS5FSU8pLHR9LGNyZWF0ZUxhenlGaWxlOmZ1bmN0aW9uKGUsdCxyLG4sbyl7ZnVuY3Rpb24gaSgpe3RoaXMubGVuZ3RoS25vd249ITEsdGhpcy5jaHVua3M9W119aWYoaS5wcm90b3R5cGUuZ2V0PWZ1bmN0aW9uKGUpe2lmKCEoZT50aGlzLmxlbmd0aC0xfHxlPDApKXt2YXIgdD1lJXRoaXMuY2h1bmtTaXplLHI9ZS90aGlzLmNodW5rU2l6ZXwwO3JldHVybiB0aGlzLmdldHRlcihyKVt0XX19LGkucHJvdG90eXBlLnNldERhdGFHZXR0ZXI9ZnVuY3Rpb24oZSl7dGhpcy5nZXR0ZXI9ZX0saS5wcm90b3R5cGUuY2FjaGVMZW5ndGg9ZnVuY3Rpb24oKXt2YXIgZT1uZXcgWE1MSHR0cFJlcXVlc3Q7aWYoZS5vcGVuKCJIRUFEIixyLCExKSxlLnNlbmQobnVsbCksIShlLnN0YXR1cz49MjAwJiZlLnN0YXR1czwzMDB8fDMwND09PWUuc3RhdHVzKSl0aHJvdyBuZXcgRXJyb3IoIkNvdWxkbid0IGxvYWQgIityKyIuIFN0YXR1czogIitlLnN0YXR1cyk7dmFyIHQsbj1OdW1iZXIoZS5nZXRSZXNwb25zZUhlYWRlcigiQ29udGVudC1sZW5ndGgiKSksbz0odD1lLmdldFJlc3BvbnNlSGVhZGVyKCJBY2NlcHQtUmFuZ2VzIikpJiYiYnl0ZXMiPT09dCxpPSh0PWUuZ2V0UmVzcG9uc2VIZWFkZXIoIkNvbnRlbnQtRW5jb2RpbmciKSkmJiJnemlwIj09PXQsYT0xMDQ4NTc2O298fChhPW4pO3ZhciBzPXRoaXM7cy5zZXREYXRhR2V0dGVyKChmdW5jdGlvbihlKXt2YXIgdD1lKmEsbz0oZSsxKSphLTE7aWYobz1NYXRoLm1pbihvLG4tMSksdm9pZCAwPT09cy5jaHVua3NbZV0mJihzLmNodW5rc1tlXT1mdW5jdGlvbihlLHQpe2lmKGU+dCl0aHJvdyBuZXcgRXJyb3IoImludmFsaWQgcmFuZ2UgKCIrZSsiLCAiK3QrIikgb3Igbm8gYnl0ZXMgcmVxdWVzdGVkISIpO2lmKHQ+bi0xKXRocm93IG5ldyBFcnJvcigib25seSAiK24rIiBieXRlcyBhdmFpbGFibGUhIHByb2dyYW1tZXIgZXJyb3IhIik7dmFyIG89bmV3IFhNTEh0dHBSZXF1ZXN0O2lmKG8ub3BlbigiR0VUIixyLCExKSxuIT09YSYmby5zZXRSZXF1ZXN0SGVhZGVyKCJSYW5nZSIsImJ5dGVzPSIrZSsiLSIrdCksInVuZGVmaW5lZCIhPXR5cGVvZiBVaW50OEFycmF5JiYoby5yZXNwb25zZVR5cGU9ImFycmF5YnVmZmVyIiksby5vdmVycmlkZU1pbWVUeXBlJiZvLm92ZXJyaWRlTWltZVR5cGUoInRleHQvcGxhaW47IGNoYXJzZXQ9eC11c2VyLWRlZmluZWQiKSxvLnNlbmQobnVsbCksIShvLnN0YXR1cz49MjAwJiZvLnN0YXR1czwzMDB8fDMwND09PW8uc3RhdHVzKSl0aHJvdyBuZXcgRXJyb3IoIkNvdWxkbid0IGxvYWQgIityKyIuIFN0YXR1czogIitvLnN0YXR1cyk7cmV0dXJuIHZvaWQgMCE9PW8ucmVzcG9uc2U/bmV3IFVpbnQ4QXJyYXkoby5yZXNwb25zZXx8W10pOiR0KG8ucmVzcG9uc2VUZXh0fHwiIiwhMCl9KHQsbykpLHZvaWQgMD09PXMuY2h1bmtzW2VdKXRocm93IG5ldyBFcnJvcigiZG9YSFIgZmFpbGVkISIpO3JldHVybiBzLmNodW5rc1tlXX0pKSwhaSYmbnx8KGE9bj0xLG49dGhpcy5nZXR0ZXIoMCkubGVuZ3RoLGE9bixjb25zb2xlLmxvZygiTGF6eUZpbGVzIG9uIGd6aXAgZm9yY2VzIGRvd25sb2FkIG9mIHRoZSB3aG9sZSBmaWxlIHdoZW4gbGVuZ3RoIGlzIGFjY2Vzc2VkIikpLHRoaXMuX2xlbmd0aD1uLHRoaXMuX2NodW5rU2l6ZT1hLHRoaXMubGVuZ3RoS25vd249ITB9LCJ1bmRlZmluZWQiIT10eXBlb2YgWE1MSHR0cFJlcXVlc3Qpe2lmKCFjKXRocm93IkNhbm5vdCBkbyBzeW5jaHJvbm91cyBiaW5hcnkgWEhScyBvdXRzaWRlIHdlYndvcmtlcnMgaW4gbW9kZXJuIGJyb3dzZXJzLiBVc2UgLS1lbWJlZC1maWxlIG9yIC0tcHJlbG9hZC1maWxlIGluIGVtY2MiO3ZhciBhPW5ldyBpO09iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGEse2xlbmd0aDp7Z2V0OmZ1bmN0aW9uKCl7cmV0dXJuIHRoaXMubGVuZ3RoS25vd258fHRoaXMuY2FjaGVMZW5ndGgoKSx0aGlzLl9sZW5ndGh9fSxjaHVua1NpemU6e2dldDpmdW5jdGlvbigpe3JldHVybiB0aGlzLmxlbmd0aEtub3dufHx0aGlzLmNhY2hlTGVuZ3RoKCksdGhpcy5fY2h1bmtTaXplfX19KTt2YXIgcz17aXNEZXZpY2U6ITEsY29udGVudHM6YX19ZWxzZSBzPXtpc0RldmljZTohMSx1cmw6cn07dmFyIHU9VGUuY3JlYXRlRmlsZShlLHQscyxuLG8pO3MuY29udGVudHM/dS5jb250ZW50cz1zLmNvbnRlbnRzOnMudXJsJiYodS5jb250ZW50cz1udWxsLHUudXJsPXMudXJsKSxPYmplY3QuZGVmaW5lUHJvcGVydGllcyh1LHt1c2VkQnl0ZXM6e2dldDpmdW5jdGlvbigpe3JldHVybiB0aGlzLmNvbnRlbnRzLmxlbmd0aH19fSk7dmFyIGw9e307cmV0dXJuIE9iamVjdC5rZXlzKHUuc3RyZWFtX29wcykuZm9yRWFjaCgoZnVuY3Rpb24oZSl7dmFyIHQ9dS5zdHJlYW1fb3BzW2VdO2xbZV09ZnVuY3Rpb24oKXtpZighVGUuZm9yY2VMb2FkRmlsZSh1KSl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FSU8pO3JldHVybiB0LmFwcGx5KG51bGwsYXJndW1lbnRzKX19KSksbC5yZWFkPWZ1bmN0aW9uKGUsdCxyLG4sbyl7aWYoIVRlLmZvcmNlTG9hZEZpbGUodSkpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRUlPKTt2YXIgaT1lLm5vZGUuY29udGVudHM7aWYobz49aS5sZW5ndGgpcmV0dXJuIDA7dmFyIGE9TWF0aC5taW4oaS5sZW5ndGgtbyxuKTtpZih5KGE+PTApLGkuc2xpY2UpZm9yKHZhciBzPTA7czxhO3MrKyl0W3Irc109aVtvK3NdO2Vsc2UgZm9yKHM9MDtzPGE7cysrKXRbcitzXT1pLmdldChvK3MpO3JldHVybiBhfSx1LnN0cmVhbV9vcHM9bCx1fSxjcmVhdGVQcmVsb2FkZWRGaWxlOmZ1bmN0aW9uKGUsdCxyLG4saSxhLHMsdSxjLGwpe0Jyb3dzZXIuaW5pdCgpO3ZhciBmPXQ/Z2UucmVzb2x2ZShnZS5qb2luMihlLHQpKTplO2Z1bmN0aW9uIGQocil7ZnVuY3Rpb24gZChyKXtsJiZsKCksdXx8VGUuY3JlYXRlRGF0YUZpbGUoZSx0LHIsbixpLGMpLGEmJmEoKSxsZSgpfXZhciBoPSExO28ucHJlbG9hZFBsdWdpbnMuZm9yRWFjaCgoZnVuY3Rpb24oZSl7aHx8ZS5jYW5IYW5kbGUoZikmJihlLmhhbmRsZShyLGYsZCwoZnVuY3Rpb24oKXtzJiZzKCksbGUoKX0pKSxoPSEwKX0pKSxofHxkKHIpfWNlKCksInN0cmluZyI9PXR5cGVvZiByP0Jyb3dzZXIuYXN5bmNMb2FkKHIsKGZ1bmN0aW9uKGUpe2QoZSl9KSxzKTpkKHIpfSxpbmRleGVkREI6ZnVuY3Rpb24oKXtyZXR1cm4gd2luZG93LmluZGV4ZWREQnx8d2luZG93Lm1vekluZGV4ZWREQnx8d2luZG93LndlYmtpdEluZGV4ZWREQnx8d2luZG93Lm1zSW5kZXhlZERCfSxEQl9OQU1FOmZ1bmN0aW9uKCl7cmV0dXJuIkVNX0ZTXyIrd2luZG93LmxvY2F0aW9uLnBhdGhuYW1lfSxEQl9WRVJTSU9OOjIwLERCX1NUT1JFX05BTUU6IkZJTEVfREFUQSIsc2F2ZUZpbGVzVG9EQjpmdW5jdGlvbihlLHQscil7dD10fHxmdW5jdGlvbigpe30scj1yfHxmdW5jdGlvbigpe307dmFyIG49VGUuaW5kZXhlZERCKCk7dHJ5e3ZhciBvPW4ub3BlbihUZS5EQl9OQU1FKCksVGUuREJfVkVSU0lPTil9Y2F0Y2goZSl7cmV0dXJuIHIoZSl9by5vbnVwZ3JhZGVuZWVkZWQ9ZnVuY3Rpb24oKXtjb25zb2xlLmxvZygiY3JlYXRpbmcgZGIiKSxvLnJlc3VsdC5jcmVhdGVPYmplY3RTdG9yZShUZS5EQl9TVE9SRV9OQU1FKX0sby5vbnN1Y2Nlc3M9ZnVuY3Rpb24oKXt2YXIgbj1vLnJlc3VsdC50cmFuc2FjdGlvbihbVGUuREJfU1RPUkVfTkFNRV0sInJlYWR3cml0ZSIpLGk9bi5vYmplY3RTdG9yZShUZS5EQl9TVE9SRV9OQU1FKSxhPTAscz0wLHU9ZS5sZW5ndGg7ZnVuY3Rpb24gYygpezA9PXM/dCgpOnIoKX1lLmZvckVhY2goKGZ1bmN0aW9uKGUpe3ZhciB0PWkucHV0KFRlLmFuYWx5emVQYXRoKGUpLm9iamVjdC5jb250ZW50cyxlKTt0Lm9uc3VjY2Vzcz1mdW5jdGlvbigpeysrYStzPT11JiZjKCl9LHQub25lcnJvcj1mdW5jdGlvbigpe3MrKyxhK3M9PXUmJmMoKX19KSksbi5vbmVycm9yPXJ9LG8ub25lcnJvcj1yfSxsb2FkRmlsZXNGcm9tREI6ZnVuY3Rpb24oZSx0LHIpe3Q9dHx8ZnVuY3Rpb24oKXt9LHI9cnx8ZnVuY3Rpb24oKXt9O3ZhciBuPVRlLmluZGV4ZWREQigpO3RyeXt2YXIgbz1uLm9wZW4oVGUuREJfTkFNRSgpLFRlLkRCX1ZFUlNJT04pfWNhdGNoKGUpe3JldHVybiByKGUpfW8ub251cGdyYWRlbmVlZGVkPXIsby5vbnN1Y2Nlc3M9ZnVuY3Rpb24oKXt2YXIgbj1vLnJlc3VsdDt0cnl7dmFyIGk9bi50cmFuc2FjdGlvbihbVGUuREJfU1RPUkVfTkFNRV0sInJlYWRvbmx5Iil9Y2F0Y2goZSl7cmV0dXJuIHZvaWQgcihlKX12YXIgYT1pLm9iamVjdFN0b3JlKFRlLkRCX1NUT1JFX05BTUUpLHM9MCx1PTAsYz1lLmxlbmd0aDtmdW5jdGlvbiBsKCl7MD09dT90KCk6cigpfWUuZm9yRWFjaCgoZnVuY3Rpb24oZSl7dmFyIHQ9YS5nZXQoZSk7dC5vbnN1Y2Nlc3M9ZnVuY3Rpb24oKXtUZS5hbmFseXplUGF0aChlKS5leGlzdHMmJlRlLnVubGluayhlKSxUZS5jcmVhdGVEYXRhRmlsZShnZS5kaXJuYW1lKGUpLGdlLmJhc2VuYW1lKGUpLHQucmVzdWx0LCEwLCEwLCEwKSwrK3MrdT09YyYmbCgpfSx0Lm9uZXJyb3I9ZnVuY3Rpb24oKXt1Kysscyt1PT1jJiZsKCl9fSkpLGkub25lcnJvcj1yfSxvLm9uZXJyb3I9cn19LFNlPXtERUZBVUxUX1BPTExNQVNLOjUsbWFwcGluZ3M6e30sdW1hc2s6NTExLGNhbGN1bGF0ZUF0OmZ1bmN0aW9uKGUsdCl7aWYoIi8iIT09dFswXSl7dmFyIHI7aWYoLTEwMD09PWUpcj1UZS5jd2QoKTtlbHNle3ZhciBuPVRlLmdldFN0cmVhbShlKTtpZighbil0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FQkFERik7cj1uLnBhdGh9dD1nZS5qb2luMihyLHQpfXJldHVybiB0fSxkb1N0YXQ6ZnVuY3Rpb24oZSx0LHIpe3RyeXt2YXIgbj1lKHQpfWNhdGNoKGUpe2lmKGUmJmUubm9kZSYmZ2Uubm9ybWFsaXplKHQpIT09Z2Uubm9ybWFsaXplKFRlLmdldFBhdGgoZS5ub2RlKSkpcmV0dXJuLW1lLkVOT1RESVI7dGhyb3cgZX1yZXR1cm4gRltyPj4yXT1uLmRldixGW3IrND4+Ml09MCxGW3IrOD4+Ml09bi5pbm8sRltyKzEyPj4yXT1uLm1vZGUsRltyKzE2Pj4yXT1uLm5saW5rLEZbcisyMD4+Ml09bi51aWQsRltyKzI0Pj4yXT1uLmdpZCxGW3IrMjg+PjJdPW4ucmRldixGW3IrMzI+PjJdPTAsRltyKzM2Pj4yXT1uLnNpemUsRltyKzQwPj4yXT00MDk2LEZbcis0ND4+Ml09bi5ibG9ja3MsRltyKzQ4Pj4yXT1uLmF0aW1lLmdldFRpbWUoKS8xZTN8MCxGW3IrNTI+PjJdPTAsRltyKzU2Pj4yXT1uLm10aW1lLmdldFRpbWUoKS8xZTN8MCxGW3IrNjA+PjJdPTAsRltyKzY0Pj4yXT1uLmN0aW1lLmdldFRpbWUoKS8xZTN8MCxGW3IrNjg+PjJdPTAsRltyKzcyPj4yXT1uLmlubywwfSxkb01zeW5jOmZ1bmN0aW9uKGUsdCxyLG4pe3ZhciBvPW5ldyBVaW50OEFycmF5KE8uc3ViYXJyYXkoZSxlK3IpKTtUZS5tc3luYyh0LG8sMCxyLG4pfSxkb01rZGlyOmZ1bmN0aW9uKGUsdCl7cmV0dXJuIi8iPT09KGU9Z2Uubm9ybWFsaXplKGUpKVtlLmxlbmd0aC0xXSYmKGU9ZS5zdWJzdHIoMCxlLmxlbmd0aC0xKSksVGUubWtkaXIoZSx0LDApLDB9LGRvTWtub2Q6ZnVuY3Rpb24oZSx0LHIpe3N3aXRjaCg2MTQ0MCZ0KXtjYXNlIDMyNzY4OmNhc2UgODE5MjpjYXNlIDI0NTc2OmNhc2UgNDA5NjpjYXNlIDQ5MTUyOmJyZWFrO2RlZmF1bHQ6cmV0dXJuLW1lLkVJTlZBTH1yZXR1cm4gVGUubWtub2QoZSx0LHIpLDB9LGRvUmVhZGxpbms6ZnVuY3Rpb24oZSx0LHIpe2lmKHI8PTApcmV0dXJuLW1lLkVJTlZBTDt2YXIgbj1UZS5yZWFkbGluayhlKSxvPU1hdGgubWluKHIsUyhuKSksaT1SW3Qrb107cmV0dXJuIFQobix0LHIrMSksUlt0K29dPWksb30sZG9BY2Nlc3M6ZnVuY3Rpb24oZSx0KXtpZigtOCZ0KXJldHVybi1tZS5FSU5WQUw7dmFyIHI7cj1UZS5sb29rdXBQYXRoKGUse2ZvbGxvdzohMH0pLm5vZGU7dmFyIG49IiI7cmV0dXJuIDQmdCYmKG4rPSJyIiksMiZ0JiYobis9InciKSwxJnQmJihuKz0ieCIpLG4mJlRlLm5vZGVQZXJtaXNzaW9ucyhyLG4pPy1tZS5FQUNDRVM6MH0sZG9EdXA6ZnVuY3Rpb24oZSx0LHIpe3ZhciBuPVRlLmdldFN0cmVhbShyKTtyZXR1cm4gbiYmVGUuY2xvc2UobiksVGUub3BlbihlLHQsMCxyLHIpLmZkfSxkb1JlYWR2OmZ1bmN0aW9uKGUsdCxyLG4pe2Zvcih2YXIgbz0wLGk9MDtpPHI7aSsrKXt2YXIgYT1GW3QrOCppPj4yXSxzPUZbdCsoOCppKzQpPj4yXSx1PVRlLnJlYWQoZSxSLGEscyxuKTtpZih1PDApcmV0dXJuLTE7aWYobys9dSx1PHMpYnJlYWt9cmV0dXJuIG99LGRvV3JpdGV2OmZ1bmN0aW9uKGUsdCxyLG4pe2Zvcih2YXIgbz0wLGk9MDtpPHI7aSsrKXt2YXIgYT1GW3QrOCppPj4yXSxzPUZbdCsoOCppKzQpPj4yXSx1PVRlLndyaXRlKGUsUixhLHMsbik7aWYodTwwKXJldHVybi0xO28rPXV9cmV0dXJuIG99LHZhcmFyZ3M6MCxnZXQ6ZnVuY3Rpb24oZSl7cmV0dXJuIFNlLnZhcmFyZ3MrPTQsRltTZS52YXJhcmdzLTQ+PjJdfSxnZXRTdHI6ZnVuY3Rpb24oKXtyZXR1cm4gdihTZS5nZXQoKSl9LGdldFN0cmVhbUZyb21GRDpmdW5jdGlvbigpe3ZhciBlPVRlLmdldFN0cmVhbShTZS5nZXQoKSk7aWYoIWUpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRUJBREYpO3JldHVybiBlfSxnZXRTb2NrZXRGcm9tRkQ6ZnVuY3Rpb24oKXt2YXIgZT1TT0NLRlMuZ2V0U29ja2V0KFNlLmdldCgpKTtpZighZSl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FQkFERik7cmV0dXJuIGV9LGdldFNvY2tldEFkZHJlc3M6ZnVuY3Rpb24oZSl7dmFyIHQ9U2UuZ2V0KCkscj1TZS5nZXQoKTtpZihlJiYwPT09dClyZXR1cm4gbnVsbDt2YXIgbj1fX3JlYWRfc29ja2FkZHIodCxyKTtpZihuLmVycm5vKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG4uZXJybm8pO3JldHVybiBuLmFkZHI9RE5TLmxvb2t1cF9hZGRyKG4uYWRkcil8fG4uYWRkcixufSxnZXQ2NDpmdW5jdGlvbigpe3ZhciBlPVNlLmdldCgpLHQ9U2UuZ2V0KCk7cmV0dXJuIHkoZT49MD8wPT09dDotMT09PXQpLGV9LGdldFplcm86ZnVuY3Rpb24oKXt5KDA9PT1TZS5nZXQoKSl9fTt2YXIga2U9NDI7dmFyIFBlPXt9O2Z1bmN0aW9uIERlKGUpe2Zvcig7ZS5sZW5ndGg7KXt2YXIgdD1lLnBvcCgpO2UucG9wKCkodCl9fWZ1bmN0aW9uIFJlKGUpe3JldHVybiB0aGlzLmZyb21XaXJlVHlwZShNW2U+PjJdKX12YXIgT2U9e30sQ2U9e30sTmU9e307ZnVuY3Rpb24gRmUoZSl7aWYodm9pZCAwPT09ZSlyZXR1cm4iX3Vua25vd24iO3ZhciB0PShlPWUucmVwbGFjZSgvW15hLXpBLVowLTlfXS9nLCIkIikpLmNoYXJDb2RlQXQoMCk7cmV0dXJuIHQ+PTQ4JiZ0PD01Nz8iXyIrZTplfWZ1bmN0aW9uIE1lKGUsdCl7cmV0dXJuIGU9RmUoZSksbmV3IEZ1bmN0aW9uKCJib2R5IiwicmV0dXJuIGZ1bmN0aW9uICIrZSsnKCkge1xuICAgICJ1c2Ugc3RyaWN0IjsgICAgcmV0dXJuIGJvZHkuYXBwbHkodGhpcywgYXJndW1lbnRzKTtcbn07XG4nKSh0KX1mdW5jdGlvbiBJZShlLHQpe3ZhciByPU1lKHQsKGZ1bmN0aW9uKGUpe3RoaXMubmFtZT10LHRoaXMubWVzc2FnZT1lO3ZhciByPW5ldyBFcnJvcihlKS5zdGFjazt2b2lkIDAhPT1yJiYodGhpcy5zdGFjaz10aGlzLnRvU3RyaW5nKCkrIlxuIityLnJlcGxhY2UoL15FcnJvcig6W15cbl0qKT9cbi8sIiIpKX0pKTtyZXR1cm4gci5wcm90b3R5cGU9T2JqZWN0LmNyZWF0ZShlLnByb3RvdHlwZSksci5wcm90b3R5cGUuY29uc3RydWN0b3I9cixyLnByb3RvdHlwZS50b1N0cmluZz1mdW5jdGlvbigpe3JldHVybiB2b2lkIDA9PT10aGlzLm1lc3NhZ2U/dGhpcy5uYW1lOnRoaXMubmFtZSsiOiAiK3RoaXMubWVzc2FnZX0scn12YXIgQmU9dm9pZCAwO2Z1bmN0aW9uIExlKGUpe3Rocm93IG5ldyBCZShlKX1mdW5jdGlvbiB4ZShlLHQscil7ZnVuY3Rpb24gbih0KXt2YXIgbj1yKHQpO24ubGVuZ3RoIT09ZS5sZW5ndGgmJkxlKCJNaXNtYXRjaGVkIHR5cGUgY29udmVydGVyIGNvdW50Iik7Zm9yKHZhciBvPTA7bzxlLmxlbmd0aDsrK28pWWUoZVtvXSxuW29dKX1lLmZvckVhY2goKGZ1bmN0aW9uKGUpe05lW2VdPXR9KSk7dmFyIG89bmV3IEFycmF5KHQubGVuZ3RoKSxpPVtdLGE9MDt0LmZvckVhY2goKGZ1bmN0aW9uKGUsdCl7Q2UuaGFzT3duUHJvcGVydHkoZSk/b1t0XT1DZVtlXTooaS5wdXNoKGUpLE9lLmhhc093blByb3BlcnR5KGUpfHwoT2VbZV09W10pLE9lW2VdLnB1c2goKGZ1bmN0aW9uKCl7b1t0XT1DZVtlXSwrK2E9PT1pLmxlbmd0aCYmbihvKX0pKSl9KSksMD09PWkubGVuZ3RoJiZuKG8pfWZ1bmN0aW9uIGplKGUpe3N3aXRjaChlKXtjYXNlIDE6cmV0dXJuIDA7Y2FzZSAyOnJldHVybiAxO2Nhc2UgNDpyZXR1cm4gMjtjYXNlIDg6cmV0dXJuIDM7ZGVmYXVsdDp0aHJvdyBuZXcgVHlwZUVycm9yKCJVbmtub3duIHR5cGUgc2l6ZTogIitlKX19dmFyIFVlPXZvaWQgMDtmdW5jdGlvbiB6ZShlKXtmb3IodmFyIHQ9IiIscj1lO09bcl07KXQrPVVlW09bcisrXV07cmV0dXJuIHR9dmFyICRlPXZvaWQgMDtmdW5jdGlvbiBXZShlKXt0aHJvdyBuZXcgJGUoZSl9ZnVuY3Rpb24gWWUoZSx0LHIpe2lmKHI9cnx8e30sISgiYXJnUGFja0FkdmFuY2UiaW4gdCkpdGhyb3cgbmV3IFR5cGVFcnJvcigicmVnaXN0ZXJUeXBlIHJlZ2lzdGVyZWRJbnN0YW5jZSByZXF1aXJlcyBhcmdQYWNrQWR2YW5jZSIpO3ZhciBuPXQubmFtZTtpZihlfHxXZSgndHlwZSAiJytuKyciIG11c3QgaGF2ZSBhIHBvc2l0aXZlIGludGVnZXIgdHlwZWlkIHBvaW50ZXInKSxDZS5oYXNPd25Qcm9wZXJ0eShlKSl7aWYoci5pZ25vcmVEdXBsaWNhdGVSZWdpc3RyYXRpb25zKXJldHVybjtXZSgiQ2Fubm90IHJlZ2lzdGVyIHR5cGUgJyIrbisiJyB0d2ljZSIpfWlmKENlW2VdPXQsZGVsZXRlIE5lW2VdLE9lLmhhc093blByb3BlcnR5KGUpKXt2YXIgbz1PZVtlXTtkZWxldGUgT2VbZV0sby5mb3JFYWNoKChmdW5jdGlvbihlKXtlKCl9KSl9fWZ1bmN0aW9uIFZlKGUpe2lmKCEodGhpcyBpbnN0YW5jZW9mIGV0KSlyZXR1cm4hMTtpZighKGUgaW5zdGFuY2VvZiBldCkpcmV0dXJuITE7Zm9yKHZhciB0PXRoaXMuJCQucHRyVHlwZS5yZWdpc3RlcmVkQ2xhc3Mscj10aGlzLiQkLnB0cixuPWUuJCQucHRyVHlwZS5yZWdpc3RlcmVkQ2xhc3Msbz1lLiQkLnB0cjt0LmJhc2VDbGFzczspcj10LnVwY2FzdChyKSx0PXQuYmFzZUNsYXNzO2Zvcig7bi5iYXNlQ2xhc3M7KW89bi51cGNhc3Qobyksbj1uLmJhc2VDbGFzcztyZXR1cm4gdD09PW4mJnI9PT1vfWZ1bmN0aW9uIEhlKGUpe1dlKGUuJCQucHRyVHlwZS5yZWdpc3RlcmVkQ2xhc3MubmFtZSsiIGluc3RhbmNlIGFscmVhZHkgZGVsZXRlZCIpfWZ1bmN0aW9uIEdlKCl7aWYodGhpcy4kJC5wdHJ8fEhlKHRoaXMpLHRoaXMuJCQucHJlc2VydmVQb2ludGVyT25EZWxldGUpcmV0dXJuIHRoaXMuJCQuY291bnQudmFsdWUrPTEsdGhpczt2YXIgZSx0PU9iamVjdC5jcmVhdGUoT2JqZWN0LmdldFByb3RvdHlwZU9mKHRoaXMpLHskJDp7dmFsdWU6KGU9dGhpcy4kJCx7Y291bnQ6ZS5jb3VudCxkZWxldGVTY2hlZHVsZWQ6ZS5kZWxldGVTY2hlZHVsZWQscHJlc2VydmVQb2ludGVyT25EZWxldGU6ZS5wcmVzZXJ2ZVBvaW50ZXJPbkRlbGV0ZSxwdHI6ZS5wdHIscHRyVHlwZTplLnB0clR5cGUsc21hcnRQdHI6ZS5zbWFydFB0cixzbWFydFB0clR5cGU6ZS5zbWFydFB0clR5cGV9KX19KTtyZXR1cm4gdC4kJC5jb3VudC52YWx1ZSs9MSx0LiQkLmRlbGV0ZVNjaGVkdWxlZD0hMSx0fWZ1bmN0aW9uIHFlKCl7dmFyIGU7dGhpcy4kJC5wdHJ8fEhlKHRoaXMpLHRoaXMuJCQuZGVsZXRlU2NoZWR1bGVkJiYhdGhpcy4kJC5wcmVzZXJ2ZVBvaW50ZXJPbkRlbGV0ZSYmV2UoIk9iamVjdCBhbHJlYWR5IHNjaGVkdWxlZCBmb3IgZGVsZXRpb24iKSx0aGlzLiQkLmNvdW50LnZhbHVlLT0xLDA9PT10aGlzLiQkLmNvdW50LnZhbHVlJiYoKGU9dGhpcy4kJCkuc21hcnRQdHI/ZS5zbWFydFB0clR5cGUucmF3RGVzdHJ1Y3RvcihlLnNtYXJ0UHRyKTplLnB0clR5cGUucmVnaXN0ZXJlZENsYXNzLnJhd0Rlc3RydWN0b3IoZS5wdHIpKSx0aGlzLiQkLnByZXNlcnZlUG9pbnRlck9uRGVsZXRlfHwodGhpcy4kJC5zbWFydFB0cj12b2lkIDAsdGhpcy4kJC5wdHI9dm9pZCAwKX1mdW5jdGlvbiBYZSgpe3JldHVybiF0aGlzLiQkLnB0cn12YXIgS2U9dm9pZCAwLEplPVtdO2Z1bmN0aW9uIFplKCl7Zm9yKDtKZS5sZW5ndGg7KXt2YXIgZT1KZS5wb3AoKTtlLiQkLmRlbGV0ZVNjaGVkdWxlZD0hMSxlLmRlbGV0ZSgpfX1mdW5jdGlvbiBRZSgpe3JldHVybiB0aGlzLiQkLnB0cnx8SGUodGhpcyksdGhpcy4kJC5kZWxldGVTY2hlZHVsZWQmJiF0aGlzLiQkLnByZXNlcnZlUG9pbnRlck9uRGVsZXRlJiZXZSgiT2JqZWN0IGFscmVhZHkgc2NoZWR1bGVkIGZvciBkZWxldGlvbiIpLEplLnB1c2godGhpcyksMT09PUplLmxlbmd0aCYmS2UmJktlKFplKSx0aGlzLiQkLmRlbGV0ZVNjaGVkdWxlZD0hMCx0aGlzfWZ1bmN0aW9uIGV0KCl7fXZhciB0dD17fTtmdW5jdGlvbiBydChlLHQscil7aWYodm9pZCAwPT09ZVt0XS5vdmVybG9hZFRhYmxlKXt2YXIgbj1lW3RdO2VbdF09ZnVuY3Rpb24oKXtyZXR1cm4gZVt0XS5vdmVybG9hZFRhYmxlLmhhc093blByb3BlcnR5KGFyZ3VtZW50cy5sZW5ndGgpfHxXZSgiRnVuY3Rpb24gJyIrcisiJyBjYWxsZWQgd2l0aCBhbiBpbnZhbGlkIG51bWJlciBvZiBhcmd1bWVudHMgKCIrYXJndW1lbnRzLmxlbmd0aCsiKSAtIGV4cGVjdHMgb25lIG9mICgiK2VbdF0ub3ZlcmxvYWRUYWJsZSsiKSEiKSxlW3RdLm92ZXJsb2FkVGFibGVbYXJndW1lbnRzLmxlbmd0aF0uYXBwbHkodGhpcyxhcmd1bWVudHMpfSxlW3RdLm92ZXJsb2FkVGFibGU9W10sZVt0XS5vdmVybG9hZFRhYmxlW24uYXJnQ291bnRdPW59fWZ1bmN0aW9uIG50KGUsdCxyLG4sbyxpLGEscyl7dGhpcy5uYW1lPWUsdGhpcy5jb25zdHJ1Y3Rvcj10LHRoaXMuaW5zdGFuY2VQcm90b3R5cGU9cix0aGlzLnJhd0Rlc3RydWN0b3I9bix0aGlzLmJhc2VDbGFzcz1vLHRoaXMuZ2V0QWN0dWFsVHlwZT1pLHRoaXMudXBjYXN0PWEsdGhpcy5kb3duY2FzdD1zLHRoaXMucHVyZVZpcnR1YWxGdW5jdGlvbnM9W119ZnVuY3Rpb24gb3QoZSx0LHIpe2Zvcig7dCE9PXI7KXQudXBjYXN0fHxXZSgiRXhwZWN0ZWQgbnVsbCBvciBpbnN0YW5jZSBvZiAiK3IubmFtZSsiLCBnb3QgYW4gaW5zdGFuY2Ugb2YgIit0Lm5hbWUpLGU9dC51cGNhc3QoZSksdD10LmJhc2VDbGFzcztyZXR1cm4gZX1mdW5jdGlvbiBpdChlLHQpe2lmKG51bGw9PT10KXJldHVybiB0aGlzLmlzUmVmZXJlbmNlJiZXZSgibnVsbCBpcyBub3QgYSB2YWxpZCAiK3RoaXMubmFtZSksMDt0LiQkfHxXZSgnQ2Fubm90IHBhc3MgIicrT3QodCkrJyIgYXMgYSAnK3RoaXMubmFtZSksdC4kJC5wdHJ8fFdlKCJDYW5ub3QgcGFzcyBkZWxldGVkIG9iamVjdCBhcyBhIHBvaW50ZXIgb2YgdHlwZSAiK3RoaXMubmFtZSk7dmFyIHI9dC4kJC5wdHJUeXBlLnJlZ2lzdGVyZWRDbGFzcztyZXR1cm4gb3QodC4kJC5wdHIscix0aGlzLnJlZ2lzdGVyZWRDbGFzcyl9ZnVuY3Rpb24gYXQoZSx0KXt2YXIgcjtpZihudWxsPT09dClyZXR1cm4gdGhpcy5pc1JlZmVyZW5jZSYmV2UoIm51bGwgaXMgbm90IGEgdmFsaWQgIit0aGlzLm5hbWUpLHRoaXMuaXNTbWFydFBvaW50ZXI/KHI9dGhpcy5yYXdDb25zdHJ1Y3RvcigpLG51bGwhPT1lJiZlLnB1c2godGhpcy5yYXdEZXN0cnVjdG9yLHIpLHIpOjA7dC4kJHx8V2UoJ0Nhbm5vdCBwYXNzICInK090KHQpKyciIGFzIGEgJyt0aGlzLm5hbWUpLHQuJCQucHRyfHxXZSgiQ2Fubm90IHBhc3MgZGVsZXRlZCBvYmplY3QgYXMgYSBwb2ludGVyIG9mIHR5cGUgIit0aGlzLm5hbWUpLCF0aGlzLmlzQ29uc3QmJnQuJCQucHRyVHlwZS5pc0NvbnN0JiZXZSgiQ2Fubm90IGNvbnZlcnQgYXJndW1lbnQgb2YgdHlwZSAiKyh0LiQkLnNtYXJ0UHRyVHlwZT90LiQkLnNtYXJ0UHRyVHlwZS5uYW1lOnQuJCQucHRyVHlwZS5uYW1lKSsiIHRvIHBhcmFtZXRlciB0eXBlICIrdGhpcy5uYW1lKTt2YXIgbj10LiQkLnB0clR5cGUucmVnaXN0ZXJlZENsYXNzO2lmKHI9b3QodC4kJC5wdHIsbix0aGlzLnJlZ2lzdGVyZWRDbGFzcyksdGhpcy5pc1NtYXJ0UG9pbnRlcilzd2l0Y2godm9pZCAwPT09dC4kJC5zbWFydFB0ciYmV2UoIlBhc3NpbmcgcmF3IHBvaW50ZXIgdG8gc21hcnQgcG9pbnRlciBpcyBpbGxlZ2FsIiksdGhpcy5zaGFyaW5nUG9saWN5KXtjYXNlIDA6dC4kJC5zbWFydFB0clR5cGU9PT10aGlzP3I9dC4kJC5zbWFydFB0cjpXZSgiQ2Fubm90IGNvbnZlcnQgYXJndW1lbnQgb2YgdHlwZSAiKyh0LiQkLnNtYXJ0UHRyVHlwZT90LiQkLnNtYXJ0UHRyVHlwZS5uYW1lOnQuJCQucHRyVHlwZS5uYW1lKSsiIHRvIHBhcmFtZXRlciB0eXBlICIrdGhpcy5uYW1lKTticmVhaztjYXNlIDE6cj10LiQkLnNtYXJ0UHRyO2JyZWFrO2Nhc2UgMjppZih0LiQkLnNtYXJ0UHRyVHlwZT09PXRoaXMpcj10LiQkLnNtYXJ0UHRyO2Vsc2V7dmFyIG89dC5jbG9uZSgpO3I9dGhpcy5yYXdTaGFyZShyLFJ0KChmdW5jdGlvbigpe28uZGVsZXRlKCl9KSkpLG51bGwhPT1lJiZlLnB1c2godGhpcy5yYXdEZXN0cnVjdG9yLHIpfWJyZWFrO2RlZmF1bHQ6V2UoIlVuc3VwcG9ydGluZyBzaGFyaW5nIHBvbGljeSIpfXJldHVybiByfWZ1bmN0aW9uIHN0KGUsdCl7aWYobnVsbD09PXQpcmV0dXJuIHRoaXMuaXNSZWZlcmVuY2UmJldlKCJudWxsIGlzIG5vdCBhIHZhbGlkICIrdGhpcy5uYW1lKSwwO3QuJCR8fFdlKCdDYW5ub3QgcGFzcyAiJytPdCh0KSsnIiBhcyBhICcrdGhpcy5uYW1lKSx0LiQkLnB0cnx8V2UoIkNhbm5vdCBwYXNzIGRlbGV0ZWQgb2JqZWN0IGFzIGEgcG9pbnRlciBvZiB0eXBlICIrdGhpcy5uYW1lKSx0LiQkLnB0clR5cGUuaXNDb25zdCYmV2UoIkNhbm5vdCBjb252ZXJ0IGFyZ3VtZW50IG9mIHR5cGUgIit0LiQkLnB0clR5cGUubmFtZSsiIHRvIHBhcmFtZXRlciB0eXBlICIrdGhpcy5uYW1lKTt2YXIgcj10LiQkLnB0clR5cGUucmVnaXN0ZXJlZENsYXNzO3JldHVybiBvdCh0LiQkLnB0cixyLHRoaXMucmVnaXN0ZXJlZENsYXNzKX1mdW5jdGlvbiB1dChlKXtyZXR1cm4gdGhpcy5yYXdHZXRQb2ludGVlJiYoZT10aGlzLnJhd0dldFBvaW50ZWUoZSkpLGV9ZnVuY3Rpb24gY3QoZSl7dGhpcy5yYXdEZXN0cnVjdG9yJiZ0aGlzLnJhd0Rlc3RydWN0b3IoZSl9ZnVuY3Rpb24gbHQoZSl7bnVsbCE9PWUmJmUuZGVsZXRlKCl9ZnVuY3Rpb24gZnQoKXtyZXR1cm4gT2JqZWN0LmtleXMocHQpLmxlbmd0aH1mdW5jdGlvbiBkdCgpe3ZhciBlPVtdO2Zvcih2YXIgdCBpbiBwdClwdC5oYXNPd25Qcm9wZXJ0eSh0KSYmZS5wdXNoKHB0W3RdKTtyZXR1cm4gZX1mdW5jdGlvbiBodChlKXtLZT1lLEplLmxlbmd0aCYmS2UmJktlKFplKX12YXIgcHQ9e307ZnVuY3Rpb24gbXQoZSx0KXtyZXR1cm4gdD1mdW5jdGlvbihlLHQpe2Zvcih2b2lkIDA9PT10JiZXZSgicHRyIHNob3VsZCBub3QgYmUgdW5kZWZpbmVkIik7ZS5iYXNlQ2xhc3M7KXQ9ZS51cGNhc3QodCksZT1lLmJhc2VDbGFzcztyZXR1cm4gdH0oZSx0KSxwdFt0XX1mdW5jdGlvbiB5dChlLHQpe3JldHVybiB0LnB0clR5cGUmJnQucHRyfHxMZSgibWFrZUNsYXNzSGFuZGxlIHJlcXVpcmVzIHB0ciBhbmQgcHRyVHlwZSIpLCEhdC5zbWFydFB0clR5cGUhPT0hIXQuc21hcnRQdHImJkxlKCJCb3RoIHNtYXJ0UHRyVHlwZSBhbmQgc21hcnRQdHIgbXVzdCBiZSBzcGVjaWZpZWQiKSx0LmNvdW50PXt2YWx1ZToxfSxPYmplY3QuY3JlYXRlKGUseyQkOnt2YWx1ZTp0fX0pfWZ1bmN0aW9uIEV0KGUpe3ZhciB0PXRoaXMuZ2V0UG9pbnRlZShlKTtpZighdClyZXR1cm4gdGhpcy5kZXN0cnVjdG9yKGUpLG51bGw7dmFyIHI9bXQodGhpcy5yZWdpc3RlcmVkQ2xhc3MsdCk7aWYodm9pZCAwIT09cil7aWYoMD09PXIuJCQuY291bnQudmFsdWUpcmV0dXJuIHIuJCQucHRyPXQsci4kJC5zbWFydFB0cj1lLHIuY2xvbmUoKTt2YXIgbj1yLmNsb25lKCk7cmV0dXJuIHRoaXMuZGVzdHJ1Y3RvcihlKSxufWZ1bmN0aW9uIG8oKXtyZXR1cm4gdGhpcy5pc1NtYXJ0UG9pbnRlcj95dCh0aGlzLnJlZ2lzdGVyZWRDbGFzcy5pbnN0YW5jZVByb3RvdHlwZSx7cHRyVHlwZTp0aGlzLnBvaW50ZWVUeXBlLHB0cjp0LHNtYXJ0UHRyVHlwZTp0aGlzLHNtYXJ0UHRyOmV9KTp5dCh0aGlzLnJlZ2lzdGVyZWRDbGFzcy5pbnN0YW5jZVByb3RvdHlwZSx7cHRyVHlwZTp0aGlzLHB0cjplfSl9dmFyIGksYT10aGlzLnJlZ2lzdGVyZWRDbGFzcy5nZXRBY3R1YWxUeXBlKHQpLHM9dHRbYV07aWYoIXMpcmV0dXJuIG8uY2FsbCh0aGlzKTtpPXRoaXMuaXNDb25zdD9zLmNvbnN0UG9pbnRlclR5cGU6cy5wb2ludGVyVHlwZTt2YXIgdT1mdW5jdGlvbiBlKHQscixuKXtpZihyPT09bilyZXR1cm4gdDtpZih2b2lkIDA9PT1uLmJhc2VDbGFzcylyZXR1cm4gbnVsbDt2YXIgbz1lKHQscixuLmJhc2VDbGFzcyk7cmV0dXJuIG51bGw9PT1vP251bGw6bi5kb3duY2FzdChvKX0odCx0aGlzLnJlZ2lzdGVyZWRDbGFzcyxpLnJlZ2lzdGVyZWRDbGFzcyk7cmV0dXJuIG51bGw9PT11P28uY2FsbCh0aGlzKTp0aGlzLmlzU21hcnRQb2ludGVyP3l0KGkucmVnaXN0ZXJlZENsYXNzLmluc3RhbmNlUHJvdG90eXBlLHtwdHJUeXBlOmkscHRyOnUsc21hcnRQdHJUeXBlOnRoaXMsc21hcnRQdHI6ZX0pOnl0KGkucmVnaXN0ZXJlZENsYXNzLmluc3RhbmNlUHJvdG90eXBlLHtwdHJUeXBlOmkscHRyOnV9KX1mdW5jdGlvbiBndChlLHQscixuLG8saSxhLHMsdSxjLGwpe3RoaXMubmFtZT1lLHRoaXMucmVnaXN0ZXJlZENsYXNzPXQsdGhpcy5pc1JlZmVyZW5jZT1yLHRoaXMuaXNDb25zdD1uLHRoaXMuaXNTbWFydFBvaW50ZXI9byx0aGlzLnBvaW50ZWVUeXBlPWksdGhpcy5zaGFyaW5nUG9saWN5PWEsdGhpcy5yYXdHZXRQb2ludGVlPXMsdGhpcy5yYXdDb25zdHJ1Y3Rvcj11LHRoaXMucmF3U2hhcmU9Yyx0aGlzLnJhd0Rlc3RydWN0b3I9bCxvfHx2b2lkIDAhPT10LmJhc2VDbGFzcz90aGlzLnRvV2lyZVR5cGU9YXQ6bj8odGhpcy50b1dpcmVUeXBlPWl0LHRoaXMuZGVzdHJ1Y3RvckZ1bmN0aW9uPW51bGwpOih0aGlzLnRvV2lyZVR5cGU9c3QsdGhpcy5kZXN0cnVjdG9yRnVuY3Rpb249bnVsbCl9ZnVuY3Rpb24gdnQoZSx0KXt2YXIgcjtpZihlPXplKGUpLHZvaWQgMCE9PW9bIkZVTkNUSU9OX1RBQkxFXyIrZV0pcj1vWyJGVU5DVElPTl9UQUJMRV8iK2VdW3RdO2Vsc2UgaWYoInVuZGVmaW5lZCIhPXR5cGVvZiBGVU5DVElPTl9UQUJMRSlyPUZVTkNUSU9OX1RBQkxFW3RdO2Vsc2V7dmFyIG49by5hc21bImR5bkNhbGxfIitlXTt2b2lkIDA9PT1uJiZ2b2lkIDA9PT0obj1vLmFzbVsiZHluQ2FsbF8iK2UucmVwbGFjZSgvZi9nLCJkIildKSYmV2UoIk5vIGR5bkNhbGwgaW52b2tlciBmb3Igc2lnbmF0dXJlOiAiK2UpLHI9ZnVuY3Rpb24ocil7Zm9yKHZhciBuPVtdLG89MTtvPGUubGVuZ3RoOysrbyluLnB1c2goImEiK28pO3ZhciBpPSJyZXR1cm4gZnVuY3Rpb24gIisoImR5bkNhbGxfIitlKyJfIit0KSsiKCIrbi5qb2luKCIsICIpKyIpIHtcbiI7cmV0dXJuIGkrPSIgICAgcmV0dXJuIGR5bkNhbGwocmF3RnVuY3Rpb24iKyhuLmxlbmd0aD8iLCAiOiIiKStuLmpvaW4oIiwgIikrIik7XG4iLGkrPSJ9O1xuIixuZXcgRnVuY3Rpb24oImR5bkNhbGwiLCJyYXdGdW5jdGlvbiIsaSkocix0KX0obil9cmV0dXJuImZ1bmN0aW9uIiE9dHlwZW9mIHImJldlKCJ1bmtub3duIGZ1bmN0aW9uIHBvaW50ZXIgd2l0aCBzaWduYXR1cmUgIitlKyI6ICIrdCkscn12YXIgd3Q9dm9pZCAwO2Z1bmN0aW9uIF90KGUpe3ZhciB0PXF0KGUpLHI9emUodCk7cmV0dXJuIEt0KHQpLHJ9ZnVuY3Rpb24gYnQoZSx0KXt2YXIgcj1bXSxuPXt9O3Rocm93IHQuZm9yRWFjaCgoZnVuY3Rpb24gZSh0KXtuW3RdfHxDZVt0XXx8KE5lW3RdP05lW3RdLmZvckVhY2goZSk6KHIucHVzaCh0KSxuW3RdPSEwKSl9KSksbmV3IHd0KGUrIjogIityLm1hcChfdCkuam9pbihbIiwgIl0pKX1mdW5jdGlvbiBBdChlLHQpe2Zvcih2YXIgcj1bXSxuPTA7bjxlO24rKylyLnB1c2goRlsodD4+Mikrbl0pO3JldHVybiByfWZ1bmN0aW9uIFR0KGUsdCxyLG4sbyl7dmFyIGk9dC5sZW5ndGg7aTwyJiZXZSgiYXJnVHlwZXMgYXJyYXkgc2l6ZSBtaXNtYXRjaCEgTXVzdCBhdCBsZWFzdCBnZXQgcmV0dXJuIHZhbHVlIGFuZCAndGhpcycgdHlwZXMhIik7Zm9yKHZhciBhPW51bGwhPT10WzFdJiZudWxsIT09cixzPSExLHU9MTt1PHQubGVuZ3RoOysrdSlpZihudWxsIT09dFt1XSYmdm9pZCAwPT09dFt1XS5kZXN0cnVjdG9yRnVuY3Rpb24pe3M9ITA7YnJlYWt9dmFyIGM9InZvaWQiIT09dFswXS5uYW1lLGw9IiIsZj0iIjtmb3IodT0wO3U8aS0yOysrdSlsKz0oMCE9PXU/IiwgIjoiIikrImFyZyIrdSxmKz0oMCE9PXU/IiwgIjoiIikrImFyZyIrdSsiV2lyZWQiO3ZhciBkPSJyZXR1cm4gZnVuY3Rpb24gIitGZShlKSsiKCIrbCsiKSB7XG5pZiAoYXJndW1lbnRzLmxlbmd0aCAhPT0gIisoaS0yKSsiKSB7XG50aHJvd0JpbmRpbmdFcnJvcignZnVuY3Rpb24gIitlKyIgY2FsbGVkIHdpdGggJyArIGFyZ3VtZW50cy5sZW5ndGggKyAnIGFyZ3VtZW50cywgZXhwZWN0ZWQgIisoaS0yKSsiIGFyZ3MhJyk7XG59XG4iO3MmJihkKz0idmFyIGRlc3RydWN0b3JzID0gW107XG4iKTt2YXIgaD1zPyJkZXN0cnVjdG9ycyI6Im51bGwiLHA9WyJ0aHJvd0JpbmRpbmdFcnJvciIsImludm9rZXIiLCJmbiIsInJ1bkRlc3RydWN0b3JzIiwicmV0VHlwZSIsImNsYXNzUGFyYW0iXSxtPVtXZSxuLG8sRGUsdFswXSx0WzFdXTthJiYoZCs9InZhciB0aGlzV2lyZWQgPSBjbGFzc1BhcmFtLnRvV2lyZVR5cGUoIitoKyIsIHRoaXMpO1xuIik7Zm9yKHU9MDt1PGktMjsrK3UpZCs9InZhciBhcmciK3UrIldpcmVkID0gYXJnVHlwZSIrdSsiLnRvV2lyZVR5cGUoIitoKyIsIGFyZyIrdSsiKTsgLy8gIit0W3UrMl0ubmFtZSsiXG4iLHAucHVzaCgiYXJnVHlwZSIrdSksbS5wdXNoKHRbdSsyXSk7aWYoYSYmKGY9InRoaXNXaXJlZCIrKGYubGVuZ3RoPjA/IiwgIjoiIikrZiksZCs9KGM/InZhciBydiA9ICI6IiIpKyJpbnZva2VyKGZuIisoZi5sZW5ndGg+MD8iLCAiOiIiKStmKyIpO1xuIixzKWQrPSJydW5EZXN0cnVjdG9ycyhkZXN0cnVjdG9ycyk7XG4iO2Vsc2UgZm9yKHU9YT8xOjI7dTx0Lmxlbmd0aDsrK3Upe3ZhciB5PTE9PT11PyJ0aGlzV2lyZWQiOiJhcmciKyh1LTIpKyJXaXJlZCI7bnVsbCE9PXRbdV0uZGVzdHJ1Y3RvckZ1bmN0aW9uJiYoZCs9eSsiX2R0b3IoIit5KyIpOyAvLyAiK3RbdV0ubmFtZSsiXG4iLHAucHVzaCh5KyJfZHRvciIpLG0ucHVzaCh0W3VdLmRlc3RydWN0b3JGdW5jdGlvbikpfXJldHVybiBjJiYoZCs9InZhciByZXQgPSByZXRUeXBlLmZyb21XaXJlVHlwZShydik7XG5yZXR1cm4gcmV0O1xuIiksZCs9In1cbiIscC5wdXNoKGQpLGZ1bmN0aW9uKGUsdCl7aWYoIShlIGluc3RhbmNlb2YgRnVuY3Rpb24pKXRocm93IG5ldyBUeXBlRXJyb3IoIm5ld18gY2FsbGVkIHdpdGggY29uc3RydWN0b3IgdHlwZSAiK3R5cGVvZiBlKyIgd2hpY2ggaXMgbm90IGEgZnVuY3Rpb24iKTt2YXIgcj1NZShlLm5hbWV8fCJ1bmtub3duRnVuY3Rpb25OYW1lIiwoZnVuY3Rpb24oKXt9KSk7ci5wcm90b3R5cGU9ZS5wcm90b3R5cGU7dmFyIG49bmV3IHIsbz1lLmFwcGx5KG4sdCk7cmV0dXJuIG8gaW5zdGFuY2VvZiBPYmplY3Q/bzpufShGdW5jdGlvbixwKS5hcHBseShudWxsLG0pfXZhciBTdD1bXSxrdD1be30se3ZhbHVlOnZvaWQgMH0se3ZhbHVlOm51bGx9LHt2YWx1ZTohMH0se3ZhbHVlOiExfV07ZnVuY3Rpb24gUHQoKXtmb3IodmFyIGU9MCx0PTU7dDxrdC5sZW5ndGg7Kyt0KXZvaWQgMCE9PWt0W3RdJiYrK2U7cmV0dXJuIGV9ZnVuY3Rpb24gRHQoKXtmb3IodmFyIGU9NTtlPGt0Lmxlbmd0aDsrK2UpaWYodm9pZCAwIT09a3RbZV0pcmV0dXJuIGt0W2VdO3JldHVybiBudWxsfWZ1bmN0aW9uIFJ0KGUpe3N3aXRjaChlKXtjYXNlIHZvaWQgMDpyZXR1cm4gMTtjYXNlIG51bGw6cmV0dXJuIDI7Y2FzZSEwOnJldHVybiAzO2Nhc2UhMTpyZXR1cm4gNDtkZWZhdWx0OnZhciB0PVN0Lmxlbmd0aD9TdC5wb3AoKTprdC5sZW5ndGg7cmV0dXJuIGt0W3RdPXtyZWZjb3VudDoxLHZhbHVlOmV9LHR9fWZ1bmN0aW9uIE90KGUpe2lmKG51bGw9PT1lKXJldHVybiJudWxsIjt2YXIgdD10eXBlb2YgZTtyZXR1cm4ib2JqZWN0Ij09PXR8fCJhcnJheSI9PT10fHwiZnVuY3Rpb24iPT09dD9lLnRvU3RyaW5nKCk6IiIrZX1mdW5jdGlvbiBDdChlLHQpe3N3aXRjaCh0KXtjYXNlIDI6cmV0dXJuIGZ1bmN0aW9uKGUpe3JldHVybiB0aGlzLmZyb21XaXJlVHlwZShJW2U+PjJdKX07Y2FzZSAzOnJldHVybiBmdW5jdGlvbihlKXtyZXR1cm4gdGhpcy5mcm9tV2lyZVR5cGUoQltlPj4zXSl9O2RlZmF1bHQ6dGhyb3cgbmV3IFR5cGVFcnJvcigiVW5rbm93biBmbG9hdCB0eXBlOiAiK2UpfX1mdW5jdGlvbiBOdChlLHQscil7c3dpdGNoKHQpe2Nhc2UgMDpyZXR1cm4gcj9mdW5jdGlvbihlKXtyZXR1cm4gUltlXX06ZnVuY3Rpb24oZSl7cmV0dXJuIE9bZV19O2Nhc2UgMTpyZXR1cm4gcj9mdW5jdGlvbihlKXtyZXR1cm4gQ1tlPj4xXX06ZnVuY3Rpb24oZSl7cmV0dXJuIE5bZT4+MV19O2Nhc2UgMjpyZXR1cm4gcj9mdW5jdGlvbihlKXtyZXR1cm4gRltlPj4yXX06ZnVuY3Rpb24oZSl7cmV0dXJuIE1bZT4+Ml19O2RlZmF1bHQ6dGhyb3cgbmV3IFR5cGVFcnJvcigiVW5rbm93biBpbnRlZ2VyIHR5cGU6ICIrZSl9fXZhciBGdD1MKz0xNjt2YXIgTXQ9e307dmFyIEl0PUwrPTE2O0wrPTQ4O2coJHQoIkdNVCIpLCJpOCIsMik7dmFyIEJ0PUwsTHQ9TCs9MTYseHQ9TCs9MTY7ZnVuY3Rpb24ganQoKXtpZighanQuY2FsbGVkKXtqdC5jYWxsZWQ9ITAsRlt4dD4+Ml09NjAqKG5ldyBEYXRlKS5nZXRUaW1lem9uZU9mZnNldCgpO3ZhciBlPW5ldyBEYXRlKDJlMywwLDEpLHQ9bmV3IERhdGUoMmUzLDYsMSk7RltMdD4+Ml09TnVtYmVyKGUuZ2V0VGltZXpvbmVPZmZzZXQoKSE9dC5nZXRUaW1lem9uZU9mZnNldCgpKTt2YXIgcj1hKGUpLG49YSh0KSxvPWcoJHQociksImk4IiwwKSxpPWcoJHQobiksImk4IiwwKTt0LmdldFRpbWV6b25lT2Zmc2V0KCk8ZS5nZXRUaW1lem9uZU9mZnNldCgpPyhGW0J0Pj4yXT1vLEZbQnQrND4+Ml09aSk6KEZbQnQ+PjJdPWksRltCdCs0Pj4yXT1vKX1mdW5jdGlvbiBhKGUpe3ZhciB0PWUudG9UaW1lU3RyaW5nKCkubWF0Y2goL1woKFtBLVphLXogXSspXCkkLyk7cmV0dXJuIHQ/dFsxXToiR01UIn19TCs9MTY7dmFyIFV0PXt9O3ZhciB6dD0xO2Z1bmN0aW9uICR0KGUsdCxyKXt2YXIgbj1yPjA/cjpTKGUpKzEsbz1uZXcgQXJyYXkobiksaT1BKGUsbywwLG8ubGVuZ3RoKTtyZXR1cm4gdCYmKG8ubGVuZ3RoPWkpLG99VGUuc3RhdGljSW5pdCgpLEoudW5zaGlmdCgoZnVuY3Rpb24oKXtvLm5vRlNJbml0fHxUZS5pbml0LmluaXRpYWxpemVkfHxUZS5pbml0KCl9KSksWi5wdXNoKChmdW5jdGlvbigpe1RlLmlnbm9yZVBlcm1pc3Npb25zPSExfSkpLFEucHVzaCgoZnVuY3Rpb24oKXtUZS5xdWl0KCl9KSksSi51bnNoaWZ0KChmdW5jdGlvbigpe3ZlLmluaXQoKX0pKSxRLnB1c2goKGZ1bmN0aW9uKCl7dmUuc2h1dGRvd24oKX0pKSxCZT1vLkludGVybmFsRXJyb3I9SWUoRXJyb3IsIkludGVybmFsRXJyb3IiKSxmdW5jdGlvbigpe2Zvcih2YXIgZT1uZXcgQXJyYXkoMjU2KSx0PTA7dDwyNTY7Kyt0KWVbdF09U3RyaW5nLmZyb21DaGFyQ29kZSh0KTtVZT1lfSgpLCRlPW8uQmluZGluZ0Vycm9yPUllKEVycm9yLCJCaW5kaW5nRXJyb3IiKSxldC5wcm90b3R5cGUuaXNBbGlhc09mPVZlLGV0LnByb3RvdHlwZS5jbG9uZT1HZSxldC5wcm90b3R5cGUuZGVsZXRlPXFlLGV0LnByb3RvdHlwZS5pc0RlbGV0ZWQ9WGUsZXQucHJvdG90eXBlLmRlbGV0ZUxhdGVyPVFlLGd0LnByb3RvdHlwZS5nZXRQb2ludGVlPXV0LGd0LnByb3RvdHlwZS5kZXN0cnVjdG9yPWN0LGd0LnByb3RvdHlwZS5hcmdQYWNrQWR2YW5jZT04LGd0LnByb3RvdHlwZS5yZWFkVmFsdWVGcm9tUG9pbnRlcj1SZSxndC5wcm90b3R5cGUuZGVsZXRlT2JqZWN0PWx0LGd0LnByb3RvdHlwZS5mcm9tV2lyZVR5cGU9RXQsby5nZXRJbmhlcml0ZWRJbnN0YW5jZUNvdW50PWZ0LG8uZ2V0TGl2ZUluaGVyaXRlZEluc3RhbmNlcz1kdCxvLmZsdXNoUGVuZGluZ0RlbGV0ZXM9WmUsby5zZXREZWxheUZ1bmN0aW9uPWh0LHd0PW8uVW5ib3VuZFR5cGVFcnJvcj1JZShFcnJvciwiVW5ib3VuZFR5cGVFcnJvciIpLG8uY291bnRfZW12YWxfaGFuZGxlcz1QdCxvLmdldF9maXJzdF9lbXZhbD1EdCxmdW5jdGlvbiBlKHQpe3ZhciByLG47ZS5jYWxsZWQ/KG49RltGdD4+Ml0scj1GW24+PjJdKTooZS5jYWxsZWQ9ITAsTXQuVVNFUj1NdC5MT0dOQU1FPSJ3ZWJfdXNlciIsTXQuUEFUSD0iLyIsTXQuUFdEPSIvIixNdC5IT01FPSIvaG9tZS93ZWJfdXNlciIsTXQuTEFORz0iQy5VVEYtOCIsTXQuXz1vLnRoaXNQcm9ncmFtLHI9ZigxMDI0KSxuPWYoMjU2KSxGW24+PjJdPXIsRltGdD4+Ml09bik7dmFyIGk9W10sYT0wO2Zvcih2YXIgcyBpbiB0KWlmKCJzdHJpbmciPT10eXBlb2YgdFtzXSl7dmFyIHU9cysiPSIrdFtzXTtpLnB1c2godSksYSs9dS5sZW5ndGh9aWYoYT4xMDI0KXRocm93IG5ldyBFcnJvcigiRW52aXJvbm1lbnQgc2l6ZSBleGNlZWRlZCBUT1RBTF9FTlZfU0laRSEiKTtmb3IodmFyIGM9MDtjPGkubGVuZ3RoO2MrKyl7cmUodT1pW2NdLHIpLEZbbis0KmM+PjJdPXIscis9dS5sZW5ndGgrMX1GW24rNCppLmxlbmd0aD4+Ml09MH0oTXQpLCQ9Zig0KSxqPVU9aChMKSx6PWgoaitHKSxGWyQ+PjJdPXoseD0hMCxvLndhc21UYWJsZVNpemU9MzE2LG8ud2FzbU1heFRhYmxlU2l6ZT0zMTYsby5hc21HbG9iYWxBcmc9e30sby5hc21MaWJyYXJ5QXJnPXthYm9ydDpycixlbmxhcmdlTWVtb3J5OkgsZ2V0VG90YWxNZW1vcnk6ZnVuY3Rpb24oKXtyZXR1cm4gcX0sYWJvcnRPbkNhbm5vdEdyb3dNZW1vcnk6ZnVuY3Rpb24oKXtycigiQ2Fubm90IGVubGFyZ2UgbWVtb3J5IGFycmF5cy4gRWl0aGVyICgxKSBjb21waWxlIHdpdGggIC1zIFRPVEFMX01FTU9SWT1YICB3aXRoIFggaGlnaGVyIHRoYW4gdGhlIGN1cnJlbnQgdmFsdWUgIitxKyIsICgyKSBjb21waWxlIHdpdGggIC1zIEFMTE9XX01FTU9SWV9HUk9XVEg9MSAgd2hpY2ggYWxsb3dzIGluY3JlYXNpbmcgdGhlIHNpemUgYXQgcnVudGltZSwgb3IgKDMpIGlmIHlvdSB3YW50IG1hbGxvYyB0byByZXR1cm4gTlVMTCAoMCkgaW5zdGVhZCBvZiB0aGlzIGFib3J0LCBjb21waWxlIHdpdGggIC1zIEFCT1JUSU5HX01BTExPQz0wICIpfSxpbnZva2VfaTpmdW5jdGlvbihlKXt0cnl7cmV0dXJuIG8uZHluQ2FsbF9pKGUpfWNhdGNoKGUpe2lmKCJudW1iZXIiIT10eXBlb2YgZSYmImxvbmdqbXAiIT09ZSl0aHJvdyBlO28uc2V0VGhyZXcoMSwwKX19LGludm9rZV9paTpmdW5jdGlvbihlLHQpe3RyeXtyZXR1cm4gby5keW5DYWxsX2lpKGUsdCl9Y2F0Y2goZSl7aWYoIm51bWJlciIhPXR5cGVvZiBlJiYibG9uZ2ptcCIhPT1lKXRocm93IGU7by5zZXRUaHJldygxLDApfX0saW52b2tlX2lpaTpmdW5jdGlvbihlLHQscil7dHJ5e3JldHVybiBvLmR5bkNhbGxfaWlpKGUsdCxyKX1jYXRjaChlKXtpZigibnVtYmVyIiE9dHlwZW9mIGUmJiJsb25nam1wIiE9PWUpdGhyb3cgZTtvLnNldFRocmV3KDEsMCl9fSxpbnZva2VfaWlpaTpmdW5jdGlvbihlLHQscixuKXt0cnl7cmV0dXJuIG8uZHluQ2FsbF9paWlpKGUsdCxyLG4pfWNhdGNoKGUpe2lmKCJudW1iZXIiIT10eXBlb2YgZSYmImxvbmdqbXAiIT09ZSl0aHJvdyBlO28uc2V0VGhyZXcoMSwwKX19LGludm9rZV9paWlpaTpmdW5jdGlvbihlLHQscixuLGkpe3RyeXtyZXR1cm4gby5keW5DYWxsX2lpaWlpKGUsdCxyLG4saSl9Y2F0Y2goZSl7aWYoIm51bWJlciIhPXR5cGVvZiBlJiYibG9uZ2ptcCIhPT1lKXRocm93IGU7by5zZXRUaHJldygxLDApfX0saW52b2tlX2lpaWlpaWk6ZnVuY3Rpb24oZSx0LHIsbixpLGEscyl7dHJ5e3JldHVybiBvLmR5bkNhbGxfaWlpaWlpaShlLHQscixuLGksYSxzKX1jYXRjaChlKXtpZigibnVtYmVyIiE9dHlwZW9mIGUmJiJsb25nam1wIiE9PWUpdGhyb3cgZTtvLnNldFRocmV3KDEsMCl9fSxpbnZva2VfaWlpaWlpaWlpaTpmdW5jdGlvbihlLHQscixuLGksYSxzLHUsYyxsKXt0cnl7cmV0dXJuIG8uZHluQ2FsbF9paWlpaWlpaWlpKGUsdCxyLG4saSxhLHMsdSxjLGwpfWNhdGNoKGUpe2lmKCJudW1iZXIiIT10eXBlb2YgZSYmImxvbmdqbXAiIT09ZSl0aHJvdyBlO28uc2V0VGhyZXcoMSwwKX19LGludm9rZV9paWlpaWlqaWk6ZnVuY3Rpb24oZSx0LHIsbixpLGEscyx1LGMsbCl7dHJ5e3JldHVybiBvLmR5bkNhbGxfaWlpaWlpamlpKGUsdCxyLG4saSxhLHMsdSxjLGwpfWNhdGNoKGUpe2lmKCJudW1iZXIiIT10eXBlb2YgZSYmImxvbmdqbXAiIT09ZSl0aHJvdyBlO28uc2V0VGhyZXcoMSwwKX19LGludm9rZV9pamo6ZnVuY3Rpb24oZSx0LHIsbixpKXt0cnl7cmV0dXJuIG8uZHluQ2FsbF9pamooZSx0LHIsbixpKX1jYXRjaChlKXtpZigibnVtYmVyIiE9dHlwZW9mIGUmJiJsb25nam1wIiE9PWUpdGhyb3cgZTtvLnNldFRocmV3KDEsMCl9fSxpbnZva2Vfamk6ZnVuY3Rpb24oZSx0KXt0cnl7cmV0dXJuIG8uZHluQ2FsbF9qaShlLHQpfWNhdGNoKGUpe2lmKCJudW1iZXIiIT10eXBlb2YgZSYmImxvbmdqbXAiIT09ZSl0aHJvdyBlO28uc2V0VGhyZXcoMSwwKX19LGludm9rZV92OmZ1bmN0aW9uKGUpe3RyeXtvLmR5bkNhbGxfdihlKX1jYXRjaChlKXtpZigibnVtYmVyIiE9dHlwZW9mIGUmJiJsb25nam1wIiE9PWUpdGhyb3cgZTtvLnNldFRocmV3KDEsMCl9fSxpbnZva2Vfdmk6ZnVuY3Rpb24oZSx0KXt0cnl7by5keW5DYWxsX3ZpKGUsdCl9Y2F0Y2goZSl7aWYoIm51bWJlciIhPXR5cGVvZiBlJiYibG9uZ2ptcCIhPT1lKXRocm93IGU7by5zZXRUaHJldygxLDApfX0saW52b2tlX3ZpaTpmdW5jdGlvbihlLHQscil7dHJ5e28uZHluQ2FsbF92aWkoZSx0LHIpfWNhdGNoKGUpe2lmKCJudW1iZXIiIT10eXBlb2YgZSYmImxvbmdqbXAiIT09ZSl0aHJvdyBlO28uc2V0VGhyZXcoMSwwKX19LGludm9rZV92aWlpOmZ1bmN0aW9uKGUsdCxyLG4pe3RyeXtvLmR5bkNhbGxfdmlpaShlLHQscixuKX1jYXRjaChlKXtpZigibnVtYmVyIiE9dHlwZW9mIGUmJiJsb25nam1wIiE9PWUpdGhyb3cgZTtvLnNldFRocmV3KDEsMCl9fSxpbnZva2VfdmlpaWk6ZnVuY3Rpb24oZSx0LHIsbixpKXt0cnl7by5keW5DYWxsX3ZpaWlpKGUsdCxyLG4saSl9Y2F0Y2goZSl7aWYoIm51bWJlciIhPXR5cGVvZiBlJiYibG9uZ2ptcCIhPT1lKXRocm93IGU7by5zZXRUaHJldygxLDApfX0saW52b2tlX3ZpaWlpaTpmdW5jdGlvbihlLHQscixuLGksYSl7dHJ5e28uZHluQ2FsbF92aWlpaWkoZSx0LHIsbixpLGEpfWNhdGNoKGUpe2lmKCJudW1iZXIiIT10eXBlb2YgZSYmImxvbmdqbXAiIT09ZSl0aHJvdyBlO28uc2V0VGhyZXcoMSwwKX19LGludm9rZV92aWlpaWlpOmZ1bmN0aW9uKGUsdCxyLG4saSxhLHMpe3RyeXtvLmR5bkNhbGxfdmlpaWlpaShlLHQscixuLGksYSxzKX1jYXRjaChlKXtpZigibnVtYmVyIiE9dHlwZW9mIGUmJiJsb25nam1wIiE9PWUpdGhyb3cgZTtvLnNldFRocmV3KDEsMCl9fSxpbnZva2VfdmlpaWlpaWlpaTpmdW5jdGlvbihlLHQscixuLGksYSxzLHUsYyxsKXt0cnl7by5keW5DYWxsX3ZpaWlpaWlpaWkoZSx0LHIsbixpLGEscyx1LGMsbCl9Y2F0Y2goZSl7aWYoIm51bWJlciIhPXR5cGVvZiBlJiYibG9uZ2ptcCIhPT1lKXRocm93IGU7by5zZXRUaHJldygxLDApfX0saW52b2tlX3ZpaWlpaWlpaWlpOmZ1bmN0aW9uKGUsdCxyLG4saSxhLHMsdSxjLGwsZil7dHJ5e28uZHluQ2FsbF92aWlpaWlpaWlpaShlLHQscixuLGksYSxzLHUsYyxsLGYpfWNhdGNoKGUpe2lmKCJudW1iZXIiIT10eXBlb2YgZSYmImxvbmdqbXAiIT09ZSl0aHJvdyBlO28uc2V0VGhyZXcoMSwwKX19LGludm9rZV92aWo6ZnVuY3Rpb24oZSx0LHIsbil7dHJ5e28uZHluQ2FsbF92aWooZSx0LHIsbil9Y2F0Y2goZSl7aWYoIm51bWJlciIhPXR5cGVvZiBlJiYibG9uZ2ptcCIhPT1lKXRocm93IGU7by5zZXRUaHJldygxLDApfX0saW52b2tlX3Zpamk6ZnVuY3Rpb24oZSx0LHIsbixpKXt0cnl7by5keW5DYWxsX3ZpamkoZSx0LHIsbixpKX1jYXRjaChlKXtpZigibnVtYmVyIiE9dHlwZW9mIGUmJiJsb25nam1wIiE9PWUpdGhyb3cgZTtvLnNldFRocmV3KDEsMCl9fSxfX19jeGFfYWxsb2NhdGVfZXhjZXB0aW9uOmZ1bmN0aW9uKGUpe3JldHVybiBKdChlKX0sX19fY3hhX2JlZ2luX2NhdGNoOmZ1bmN0aW9uKGUpe3ZhciB0PWRlLmluZm9zW2VdO3JldHVybiB0JiYhdC5jYXVnaHQmJih0LmNhdWdodD0hMCksdCYmKHQucmV0aHJvd249ITEpLGRlLmNhdWdodC5wdXNoKGUpLGRlLmFkZFJlZihkZS5kZUFkanVzdChlKSksZX0sX19fY3hhX2VuZF9jYXRjaDpmdW5jdGlvbigpe28uc2V0VGhyZXcoMCk7dmFyIGU9ZGUuY2F1Z2h0LnBvcCgpO2UmJihkZS5kZWNSZWYoZGUuZGVBZGp1c3QoZSkpLGRlLmxhc3Q9MCl9LF9fX2N4YV9maW5kX21hdGNoaW5nX2NhdGNoXzI6ZnVuY3Rpb24oKXtyZXR1cm4gcGUuYXBwbHkobnVsbCxhcmd1bWVudHMpfSxfX19jeGFfZmluZF9tYXRjaGluZ19jYXRjaF8zOmZ1bmN0aW9uKCl7cmV0dXJuIHBlLmFwcGx5KG51bGwsYXJndW1lbnRzKX0sX19fY3hhX2ZpbmRfbWF0Y2hpbmdfY2F0Y2hfNDpmdW5jdGlvbigpe3JldHVybiBwZS5hcHBseShudWxsLGFyZ3VtZW50cyl9LF9fX2N4YV9mcmVlX2V4Y2VwdGlvbjpoZSxfX19jeGFfdGhyb3c6ZnVuY3Rpb24oZSx0LHIpe3Rocm93IGRlLmluZm9zW2VdPXtwdHI6ZSxhZGp1c3RlZDplLHR5cGU6dCxkZXN0cnVjdG9yOnIscmVmY291bnQ6MCxjYXVnaHQ6ITEscmV0aHJvd246ITF9LGRlLmxhc3Q9ZSxlfSxfX19sb2NrOmZ1bmN0aW9uKCl7fSxfX19tYXBfZmlsZTpmdW5jdGlvbihlLHQpe3JldHVybiB5ZShtZS5FUEVSTSksLTF9LF9fX3Jlc3VtZUV4Y2VwdGlvbjpmdW5jdGlvbihlKXt0aHJvdyBkZS5sYXN0fHwoZGUubGFzdD1lKSxlfSxfX19zZXRFcnJObzp5ZSxfX19zeXNjYWxsMTQwOmZ1bmN0aW9uKGUsdCl7U2UudmFyYXJncz10O3RyeXt2YXIgcj1TZS5nZXRTdHJlYW1Gcm9tRkQoKSxuPShTZS5nZXQoKSxTZS5nZXQoKSksbz1TZS5nZXQoKSxpPVNlLmdldCgpLGE9bjtyZXR1cm4gVGUubGxzZWVrKHIsYSxpKSxGW28+PjJdPXIucG9zaXRpb24sci5nZXRkZW50cyYmMD09PWEmJjA9PT1pJiYoci5nZXRkZW50cz1udWxsKSwwfWNhdGNoKGUpe3JldHVybiB2b2lkIDAhPT1UZSYmZSBpbnN0YW5jZW9mIFRlLkVycm5vRXJyb3J8fHJyKGUpLC1lLmVycm5vfX0sX19fc3lzY2FsbDE0NTpmdW5jdGlvbihlLHQpe1NlLnZhcmFyZ3M9dDt0cnl7dmFyIHI9U2UuZ2V0U3RyZWFtRnJvbUZEKCksbj1TZS5nZXQoKSxvPVNlLmdldCgpO3JldHVybiBTZS5kb1JlYWR2KHIsbixvKX1jYXRjaChlKXtyZXR1cm4gdm9pZCAwIT09VGUmJmUgaW5zdGFuY2VvZiBUZS5FcnJub0Vycm9yfHxycihlKSwtZS5lcnJub319LF9fX3N5c2NhbGwxNDY6ZnVuY3Rpb24oZSx0KXtTZS52YXJhcmdzPXQ7dHJ5e3ZhciByPVNlLmdldFN0cmVhbUZyb21GRCgpLG49U2UuZ2V0KCksbz1TZS5nZXQoKTtyZXR1cm4gU2UuZG9Xcml0ZXYocixuLG8pfWNhdGNoKGUpe3JldHVybiB2b2lkIDAhPT1UZSYmZSBpbnN0YW5jZW9mIFRlLkVycm5vRXJyb3J8fHJyKGUpLC1lLmVycm5vfX0sX19fc3lzY2FsbDE4MzpmdW5jdGlvbihlLHQpe1NlLnZhcmFyZ3M9dDt0cnl7dmFyIHI9U2UuZ2V0KCksbj1TZS5nZXQoKTtpZigwPT09bilyZXR1cm4tbWUuRUlOVkFMO3ZhciBvPVRlLmN3ZCgpO3JldHVybiBuPFMobykrMT8tbWUuRVJBTkdFOihUKG8scixuKSxyKX1jYXRjaChlKXtyZXR1cm4gdm9pZCAwIT09VGUmJmUgaW5zdGFuY2VvZiBUZS5FcnJub0Vycm9yfHxycihlKSwtZS5lcnJub319LF9fX3N5c2NhbGwxOTg6ZnVuY3Rpb24oZSx0KXtTZS52YXJhcmdzPXQ7dHJ5e3ZhciByPVNlLmdldFN0cigpLG49U2UuZ2V0KCksbz1TZS5nZXQoKTtyZXR1cm4gVGUuY2hvd24ocixuLG8pLDB9Y2F0Y2goZSl7cmV0dXJuIHZvaWQgMCE9PVRlJiZlIGluc3RhbmNlb2YgVGUuRXJybm9FcnJvcnx8cnIoZSksLWUuZXJybm99fSxfX19zeXNjYWxsMjA6ZnVuY3Rpb24oZSx0KXtTZS52YXJhcmdzPXQ7dHJ5e3JldHVybiBrZX1jYXRjaChlKXtyZXR1cm4gdm9pZCAwIT09VGUmJmUgaW5zdGFuY2VvZiBUZS5FcnJub0Vycm9yfHxycihlKSwtZS5lcnJub319LF9fX3N5c2NhbGw2OmZ1bmN0aW9uKGUsdCl7U2UudmFyYXJncz10O3RyeXt2YXIgcj1TZS5nZXRTdHJlYW1Gcm9tRkQoKTtyZXR1cm4gVGUuY2xvc2UociksMH1jYXRjaChlKXtyZXR1cm4gdm9pZCAwIT09VGUmJmUgaW5zdGFuY2VvZiBUZS5FcnJub0Vycm9yfHxycihlKSwtZS5lcnJub319LF9fX3N5c2NhbGw2MDpmdW5jdGlvbihlLHQpe1NlLnZhcmFyZ3M9dDt0cnl7dmFyIHI9U2UuZ2V0KCksbj1TZS51bWFzaztyZXR1cm4gU2UudW1hc2s9cixufWNhdGNoKGUpe3JldHVybiB2b2lkIDAhPT1UZSYmZSBpbnN0YW5jZW9mIFRlLkVycm5vRXJyb3J8fHJyKGUpLC1lLmVycm5vfX0sX19fc3lzY2FsbDgzOmZ1bmN0aW9uKGUsdCl7U2UudmFyYXJncz10O3RyeXt2YXIgcj1TZS5nZXRTdHIoKSxuPVNlLmdldFN0cigpO3JldHVybiBUZS5zeW1saW5rKHIsbiksMH1jYXRjaChlKXtyZXR1cm4gdm9pZCAwIT09VGUmJmUgaW5zdGFuY2VvZiBUZS5FcnJub0Vycm9yfHxycihlKSwtZS5lcnJub319LF9fX3N5c2NhbGw5MTpmdW5jdGlvbihlLHQpe1NlLnZhcmFyZ3M9dDt0cnl7dmFyIHI9U2UuZ2V0KCksbj1TZS5nZXQoKSxvPVNlLm1hcHBpbmdzW3JdO2lmKCFvKXJldHVybiAwO2lmKG49PT1vLmxlbil7dmFyIGk9VGUuZ2V0U3RyZWFtKG8uZmQpO1NlLmRvTXN5bmMocixpLG4sby5mbGFncyksVGUubXVubWFwKGkpLFNlLm1hcHBpbmdzW3JdPW51bGwsby5hbGxvY2F0ZWQmJkt0KG8ubWFsbG9jKX1yZXR1cm4gMH1jYXRjaChlKXtyZXR1cm4gdm9pZCAwIT09VGUmJmUgaW5zdGFuY2VvZiBUZS5FcnJub0Vycm9yfHxycihlKSwtZS5lcnJub319LF9fX3VubG9jazpmdW5jdGlvbigpe30sX19lbWJpbmRfZmluYWxpemVfdmFsdWVfb2JqZWN0OmZ1bmN0aW9uKGUpe3ZhciB0PVBlW2VdO2RlbGV0ZSBQZVtlXTt2YXIgcj10LnJhd0NvbnN0cnVjdG9yLG49dC5yYXdEZXN0cnVjdG9yLG89dC5maWVsZHM7eGUoW2VdLG8ubWFwKChmdW5jdGlvbihlKXtyZXR1cm4gZS5nZXR0ZXJSZXR1cm5UeXBlfSkpLmNvbmNhdChvLm1hcCgoZnVuY3Rpb24oZSl7cmV0dXJuIGUuc2V0dGVyQXJndW1lbnRUeXBlfSkpKSwoZnVuY3Rpb24oZSl7dmFyIGk9e307cmV0dXJuIG8uZm9yRWFjaCgoZnVuY3Rpb24odCxyKXt2YXIgbj10LmZpZWxkTmFtZSxhPWVbcl0scz10LmdldHRlcix1PXQuZ2V0dGVyQ29udGV4dCxjPWVbcitvLmxlbmd0aF0sbD10LnNldHRlcixmPXQuc2V0dGVyQ29udGV4dDtpW25dPXtyZWFkOmZ1bmN0aW9uKGUpe3JldHVybiBhLmZyb21XaXJlVHlwZShzKHUsZSkpfSx3cml0ZTpmdW5jdGlvbihlLHQpe3ZhciByPVtdO2woZixlLGMudG9XaXJlVHlwZShyLHQpKSxEZShyKX19fSkpLFt7bmFtZTp0Lm5hbWUsZnJvbVdpcmVUeXBlOmZ1bmN0aW9uKGUpe3ZhciB0PXt9O2Zvcih2YXIgciBpbiBpKXRbcl09aVtyXS5yZWFkKGUpO3JldHVybiBuKGUpLHR9LHRvV2lyZVR5cGU6ZnVuY3Rpb24oZSx0KXtmb3IodmFyIG8gaW4gaSlpZighKG8gaW4gdCkpdGhyb3cgbmV3IFR5cGVFcnJvcigiTWlzc2luZyBmaWVsZCIpO3ZhciBhPXIoKTtmb3IobyBpbiBpKWlbb10ud3JpdGUoYSx0W29dKTtyZXR1cm4gbnVsbCE9PWUmJmUucHVzaChuLGEpLGF9LGFyZ1BhY2tBZHZhbmNlOjgscmVhZFZhbHVlRnJvbVBvaW50ZXI6UmUsZGVzdHJ1Y3RvckZ1bmN0aW9uOm59XX0pKX0sX19lbWJpbmRfcmVnaXN0ZXJfYm9vbDpmdW5jdGlvbihlLHQscixuLG8pe3ZhciBpPWplKHIpO1llKGUse25hbWU6dD16ZSh0KSxmcm9tV2lyZVR5cGU6ZnVuY3Rpb24oZSl7cmV0dXJuISFlfSx0b1dpcmVUeXBlOmZ1bmN0aW9uKGUsdCl7cmV0dXJuIHQ/bjpvfSxhcmdQYWNrQWR2YW5jZTo4LHJlYWRWYWx1ZUZyb21Qb2ludGVyOmZ1bmN0aW9uKGUpe3ZhciBuO2lmKDE9PT1yKW49UjtlbHNlIGlmKDI9PT1yKW49QztlbHNle2lmKDQhPT1yKXRocm93IG5ldyBUeXBlRXJyb3IoIlVua25vd24gYm9vbGVhbiB0eXBlIHNpemU6ICIrdCk7bj1GfXJldHVybiB0aGlzLmZyb21XaXJlVHlwZShuW2U+PmldKX0sZGVzdHJ1Y3RvckZ1bmN0aW9uOm51bGx9KX0sX19lbWJpbmRfcmVnaXN0ZXJfY2xhc3M6ZnVuY3Rpb24oZSx0LHIsbixpLGEscyx1LGMsbCxmLGQsaCl7Zj16ZShmKSxhPXZ0KGksYSksdSYmKHU9dnQocyx1KSksbCYmKGw9dnQoYyxsKSksaD12dChkLGgpO3ZhciBwPUZlKGYpOyFmdW5jdGlvbihlLHQscil7by5oYXNPd25Qcm9wZXJ0eShlKT8oKHZvaWQgMD09PXJ8fHZvaWQgMCE9PW9bZV0ub3ZlcmxvYWRUYWJsZSYmdm9pZCAwIT09b1tlXS5vdmVybG9hZFRhYmxlW3JdKSYmV2UoIkNhbm5vdCByZWdpc3RlciBwdWJsaWMgbmFtZSAnIitlKyInIHR3aWNlIikscnQobyxlLGUpLG8uaGFzT3duUHJvcGVydHkocikmJldlKCJDYW5ub3QgcmVnaXN0ZXIgbXVsdGlwbGUgb3ZlcmxvYWRzIG9mIGEgZnVuY3Rpb24gd2l0aCB0aGUgc2FtZSBudW1iZXIgb2YgYXJndW1lbnRzICgiK3IrIikhIiksb1tlXS5vdmVybG9hZFRhYmxlW3JdPXQpOihvW2VdPXQsdm9pZCAwIT09ciYmKG9bZV0ubnVtQXJndW1lbnRzPXIpKX0ocCwoZnVuY3Rpb24oKXtidCgiQ2Fubm90IGNvbnN0cnVjdCAiK2YrIiBkdWUgdG8gdW5ib3VuZCB0eXBlcyIsW25dKX0pKSx4ZShbZSx0LHJdLG4/W25dOltdLChmdW5jdGlvbih0KXt2YXIgcixpO3Q9dFswXSxpPW4/KHI9dC5yZWdpc3RlcmVkQ2xhc3MpLmluc3RhbmNlUHJvdG90eXBlOmV0LnByb3RvdHlwZTt2YXIgcz1NZShwLChmdW5jdGlvbigpe2lmKE9iamVjdC5nZXRQcm90b3R5cGVPZih0aGlzKSE9PWMpdGhyb3cgbmV3ICRlKCJVc2UgJ25ldycgdG8gY29uc3RydWN0ICIrZik7aWYodm9pZCAwPT09ZC5jb25zdHJ1Y3Rvcl9ib2R5KXRocm93IG5ldyAkZShmKyIgaGFzIG5vIGFjY2Vzc2libGUgY29uc3RydWN0b3IiKTt2YXIgZT1kLmNvbnN0cnVjdG9yX2JvZHlbYXJndW1lbnRzLmxlbmd0aF07aWYodm9pZCAwPT09ZSl0aHJvdyBuZXcgJGUoIlRyaWVkIHRvIGludm9rZSBjdG9yIG9mICIrZisiIHdpdGggaW52YWxpZCBudW1iZXIgb2YgcGFyYW1ldGVycyAoIithcmd1bWVudHMubGVuZ3RoKyIpIC0gZXhwZWN0ZWQgKCIrT2JqZWN0LmtleXMoZC5jb25zdHJ1Y3Rvcl9ib2R5KS50b1N0cmluZygpKyIpIHBhcmFtZXRlcnMgaW5zdGVhZCEiKTtyZXR1cm4gZS5hcHBseSh0aGlzLGFyZ3VtZW50cyl9KSksYz1PYmplY3QuY3JlYXRlKGkse2NvbnN0cnVjdG9yOnt2YWx1ZTpzfX0pO3MucHJvdG90eXBlPWM7dmFyIGQ9bmV3IG50KGYscyxjLGgscixhLHUsbCksbT1uZXcgZ3QoZixkLCEwLCExLCExKSx5PW5ldyBndChmKyIqIixkLCExLCExLCExKSxFPW5ldyBndChmKyIgY29uc3QqIixkLCExLCEwLCExKTtyZXR1cm4gdHRbZV09e3BvaW50ZXJUeXBlOnksY29uc3RQb2ludGVyVHlwZTpFfSxmdW5jdGlvbihlLHQscil7by5oYXNPd25Qcm9wZXJ0eShlKXx8TGUoIlJlcGxhY2luZyBub25leGlzdGFudCBwdWJsaWMgc3ltYm9sIiksdm9pZCAwIT09b1tlXS5vdmVybG9hZFRhYmxlJiZ2b2lkIDAhPT1yP29bZV0ub3ZlcmxvYWRUYWJsZVtyXT10OihvW2VdPXQsb1tlXS5hcmdDb3VudD1yKX0ocCxzKSxbbSx5LEVdfSkpfSxfX2VtYmluZF9yZWdpc3Rlcl9jbGFzc19jb25zdHJ1Y3RvcjpmdW5jdGlvbihlLHQscixuLG8saSl7dmFyIGE9QXQodCxyKTtvPXZ0KG4sbykseGUoW10sW2VdLChmdW5jdGlvbihlKXt2YXIgcj0iY29uc3RydWN0b3IgIisoZT1lWzBdKS5uYW1lO2lmKHZvaWQgMD09PWUucmVnaXN0ZXJlZENsYXNzLmNvbnN0cnVjdG9yX2JvZHkmJihlLnJlZ2lzdGVyZWRDbGFzcy5jb25zdHJ1Y3Rvcl9ib2R5PVtdKSx2b2lkIDAhPT1lLnJlZ2lzdGVyZWRDbGFzcy5jb25zdHJ1Y3Rvcl9ib2R5W3QtMV0pdGhyb3cgbmV3ICRlKCJDYW5ub3QgcmVnaXN0ZXIgbXVsdGlwbGUgY29uc3RydWN0b3JzIHdpdGggaWRlbnRpY2FsIG51bWJlciBvZiBwYXJhbWV0ZXJzICgiKyh0LTEpKyIpIGZvciBjbGFzcyAnIitlLm5hbWUrIichIE92ZXJsb2FkIHJlc29sdXRpb24gaXMgY3VycmVudGx5IG9ubHkgcGVyZm9ybWVkIHVzaW5nIHRoZSBwYXJhbWV0ZXIgY291bnQsIG5vdCBhY3R1YWwgdHlwZSBpbmZvISIpO3JldHVybiBlLnJlZ2lzdGVyZWRDbGFzcy5jb25zdHJ1Y3Rvcl9ib2R5W3QtMV09ZnVuY3Rpb24oKXtidCgiQ2Fubm90IGNvbnN0cnVjdCAiK2UubmFtZSsiIGR1ZSB0byB1bmJvdW5kIHR5cGVzIixhKX0seGUoW10sYSwoZnVuY3Rpb24obil7cmV0dXJuIGUucmVnaXN0ZXJlZENsYXNzLmNvbnN0cnVjdG9yX2JvZHlbdC0xXT1mdW5jdGlvbigpe2FyZ3VtZW50cy5sZW5ndGghPT10LTEmJldlKHIrIiBjYWxsZWQgd2l0aCAiK2FyZ3VtZW50cy5sZW5ndGgrIiBhcmd1bWVudHMsIGV4cGVjdGVkICIrKHQtMSkpO3ZhciBlPVtdLGE9bmV3IEFycmF5KHQpO2FbMF09aTtmb3IodmFyIHM9MTtzPHQ7KytzKWFbc109bltzXS50b1dpcmVUeXBlKGUsYXJndW1lbnRzW3MtMV0pO3ZhciB1PW8uYXBwbHkobnVsbCxhKTtyZXR1cm4gRGUoZSksblswXS5mcm9tV2lyZVR5cGUodSl9LFtdfSkpLFtdfSkpfSxfX2VtYmluZF9yZWdpc3Rlcl9jbGFzc19mdW5jdGlvbjpmdW5jdGlvbihlLHQscixuLG8saSxhLHMpe3ZhciB1PUF0KHIsbik7dD16ZSh0KSxpPXZ0KG8saSkseGUoW10sW2VdLChmdW5jdGlvbihlKXt2YXIgbj0oZT1lWzBdKS5uYW1lKyIuIit0O2Z1bmN0aW9uIG8oKXtidCgiQ2Fubm90IGNhbGwgIituKyIgZHVlIHRvIHVuYm91bmQgdHlwZXMiLHUpfXMmJmUucmVnaXN0ZXJlZENsYXNzLnB1cmVWaXJ0dWFsRnVuY3Rpb25zLnB1c2godCk7dmFyIGM9ZS5yZWdpc3RlcmVkQ2xhc3MuaW5zdGFuY2VQcm90b3R5cGUsbD1jW3RdO3JldHVybiB2b2lkIDA9PT1sfHx2b2lkIDA9PT1sLm92ZXJsb2FkVGFibGUmJmwuY2xhc3NOYW1lIT09ZS5uYW1lJiZsLmFyZ0NvdW50PT09ci0yPyhvLmFyZ0NvdW50PXItMixvLmNsYXNzTmFtZT1lLm5hbWUsY1t0XT1vKToocnQoYyx0LG4pLGNbdF0ub3ZlcmxvYWRUYWJsZVtyLTJdPW8pLHhlKFtdLHUsKGZ1bmN0aW9uKG8pe3ZhciBzPVR0KG4sbyxlLGksYSk7cmV0dXJuIHZvaWQgMD09PWNbdF0ub3ZlcmxvYWRUYWJsZT8ocy5hcmdDb3VudD1yLTIsY1t0XT1zKTpjW3RdLm92ZXJsb2FkVGFibGVbci0yXT1zLFtdfSkpLFtdfSkpfSxfX2VtYmluZF9yZWdpc3Rlcl9lbXZhbDpmdW5jdGlvbihlLHQpe1llKGUse25hbWU6dD16ZSh0KSxmcm9tV2lyZVR5cGU6ZnVuY3Rpb24oZSl7dmFyIHQ9a3RbZV0udmFsdWU7cmV0dXJuIGZ1bmN0aW9uKGUpe2U+NCYmMD09LS1rdFtlXS5yZWZjb3VudCYmKGt0W2VdPXZvaWQgMCxTdC5wdXNoKGUpKX0oZSksdH0sdG9XaXJlVHlwZTpmdW5jdGlvbihlLHQpe3JldHVybiBSdCh0KX0sYXJnUGFja0FkdmFuY2U6OCxyZWFkVmFsdWVGcm9tUG9pbnRlcjpSZSxkZXN0cnVjdG9yRnVuY3Rpb246bnVsbH0pfSxfX2VtYmluZF9yZWdpc3Rlcl9mbG9hdDpmdW5jdGlvbihlLHQscil7dmFyIG49amUocik7WWUoZSx7bmFtZTp0PXplKHQpLGZyb21XaXJlVHlwZTpmdW5jdGlvbihlKXtyZXR1cm4gZX0sdG9XaXJlVHlwZTpmdW5jdGlvbihlLHQpe2lmKCJudW1iZXIiIT10eXBlb2YgdCYmImJvb2xlYW4iIT10eXBlb2YgdCl0aHJvdyBuZXcgVHlwZUVycm9yKCdDYW5ub3QgY29udmVydCAiJytPdCh0KSsnIiB0byAnK3RoaXMubmFtZSk7cmV0dXJuIHR9LGFyZ1BhY2tBZHZhbmNlOjgscmVhZFZhbHVlRnJvbVBvaW50ZXI6Q3QodCxuKSxkZXN0cnVjdG9yRnVuY3Rpb246bnVsbH0pfSxfX2VtYmluZF9yZWdpc3Rlcl9pbnRlZ2VyOmZ1bmN0aW9uKGUsdCxyLG4sbyl7dD16ZSh0KSwtMT09PW8mJihvPTQyOTQ5NjcyOTUpO3ZhciBpPWplKHIpLGE9ZnVuY3Rpb24oZSl7cmV0dXJuIGV9O2lmKDA9PT1uKXt2YXIgcz0zMi04KnI7YT1mdW5jdGlvbihlKXtyZXR1cm4gZTw8cz4+PnN9fXZhciB1PS0xIT10LmluZGV4T2YoInVuc2lnbmVkIik7WWUoZSx7bmFtZTp0LGZyb21XaXJlVHlwZTphLHRvV2lyZVR5cGU6ZnVuY3Rpb24oZSxyKXtpZigibnVtYmVyIiE9dHlwZW9mIHImJiJib29sZWFuIiE9dHlwZW9mIHIpdGhyb3cgbmV3IFR5cGVFcnJvcignQ2Fubm90IGNvbnZlcnQgIicrT3QocikrJyIgdG8gJyt0aGlzLm5hbWUpO2lmKHI8bnx8cj5vKXRocm93IG5ldyBUeXBlRXJyb3IoJ1Bhc3NpbmcgYSBudW1iZXIgIicrT3QocikrJyIgZnJvbSBKUyBzaWRlIHRvIEMvQysrIHNpZGUgdG8gYW4gYXJndW1lbnQgb2YgdHlwZSAiJyt0KyciLCB3aGljaCBpcyBvdXRzaWRlIHRoZSB2YWxpZCByYW5nZSBbJytuKyIsICIrbysiXSEiKTtyZXR1cm4gdT9yPj4+MDowfHJ9LGFyZ1BhY2tBZHZhbmNlOjgscmVhZFZhbHVlRnJvbVBvaW50ZXI6TnQodCxpLDAhPT1uKSxkZXN0cnVjdG9yRnVuY3Rpb246bnVsbH0pfSxfX2VtYmluZF9yZWdpc3Rlcl9tZW1vcnlfdmlldzpmdW5jdGlvbihlLHQscil7dmFyIG49W0ludDhBcnJheSxVaW50OEFycmF5LEludDE2QXJyYXksVWludDE2QXJyYXksSW50MzJBcnJheSxVaW50MzJBcnJheSxGbG9hdDMyQXJyYXksRmxvYXQ2NEFycmF5XVt0XTtmdW5jdGlvbiBvKGUpe3ZhciB0PU0scj10W2U+Pj0yXSxvPXRbZSsxXTtyZXR1cm4gbmV3IG4odC5idWZmZXIsbyxyKX1ZZShlLHtuYW1lOnI9emUociksZnJvbVdpcmVUeXBlOm8sYXJnUGFja0FkdmFuY2U6OCxyZWFkVmFsdWVGcm9tUG9pbnRlcjpvfSx7aWdub3JlRHVwbGljYXRlUmVnaXN0cmF0aW9uczohMH0pfSxfX2VtYmluZF9yZWdpc3Rlcl9zdGRfc3RyaW5nOmZ1bmN0aW9uKGUsdCl7WWUoZSx7bmFtZTp0PXplKHQpLGZyb21XaXJlVHlwZTpmdW5jdGlvbihlKXtmb3IodmFyIHQ9TVtlPj4yXSxyPW5ldyBBcnJheSh0KSxuPTA7bjx0OysrbilyW25dPVN0cmluZy5mcm9tQ2hhckNvZGUoT1tlKzQrbl0pO3JldHVybiBLdChlKSxyLmpvaW4oIiIpfSx0b1dpcmVUeXBlOmZ1bmN0aW9uKGUsdCl7ZnVuY3Rpb24gcihlLHQpe3JldHVybiBlW3RdfXZhciBuO3QgaW5zdGFuY2VvZiBBcnJheUJ1ZmZlciYmKHQ9bmV3IFVpbnQ4QXJyYXkodCkpLHQgaW5zdGFuY2VvZiBVaW50OEFycmF5fHx0IGluc3RhbmNlb2YgVWludDhDbGFtcGVkQXJyYXl8fHQgaW5zdGFuY2VvZiBJbnQ4QXJyYXk/bj1yOiJzdHJpbmciPT10eXBlb2YgdD9uPWZ1bmN0aW9uKGUsdCl7cmV0dXJuIGUuY2hhckNvZGVBdCh0KX06V2UoIkNhbm5vdCBwYXNzIG5vbi1zdHJpbmcgdG8gc3RkOjpzdHJpbmciKTt2YXIgbz10Lmxlbmd0aCxpPUp0KDQrbyk7TVtpPj4yXT1vO2Zvcih2YXIgYT0wO2E8bzsrK2Epe3ZhciBzPW4odCxhKTtzPjI1NSYmKEt0KGkpLFdlKCJTdHJpbmcgaGFzIFVURi0xNiBjb2RlIHVuaXRzIHRoYXQgZG8gbm90IGZpdCBpbiA4IGJpdHMiKSksT1tpKzQrYV09c31yZXR1cm4gbnVsbCE9PWUmJmUucHVzaChLdCxpKSxpfSxhcmdQYWNrQWR2YW5jZTo4LHJlYWRWYWx1ZUZyb21Qb2ludGVyOlJlLGRlc3RydWN0b3JGdW5jdGlvbjpmdW5jdGlvbihlKXtLdChlKX19KX0sX19lbWJpbmRfcmVnaXN0ZXJfc3RkX3dzdHJpbmc6ZnVuY3Rpb24oZSx0LHIpe3ZhciBuLG87cj16ZShyKSwyPT09dD8obj1mdW5jdGlvbigpe3JldHVybiBOfSxvPTEpOjQ9PT10JiYobj1mdW5jdGlvbigpe3JldHVybiBNfSxvPTIpLFllKGUse25hbWU6cixmcm9tV2lyZVR5cGU6ZnVuY3Rpb24oZSl7Zm9yKHZhciB0PW4oKSxyPU1bZT4+Ml0saT1uZXcgQXJyYXkociksYT1lKzQ+Pm8scz0wO3M8cjsrK3MpaVtzXT1TdHJpbmcuZnJvbUNoYXJDb2RlKHRbYStzXSk7cmV0dXJuIEt0KGUpLGkuam9pbigiIil9LHRvV2lyZVR5cGU6ZnVuY3Rpb24oZSxyKXt2YXIgaT1uKCksYT1yLmxlbmd0aCxzPUp0KDQrYSp0KTtNW3M+PjJdPWE7Zm9yKHZhciB1PXMrND4+byxjPTA7YzxhOysrYylpW3UrY109ci5jaGFyQ29kZUF0KGMpO3JldHVybiBudWxsIT09ZSYmZS5wdXNoKEt0LHMpLHN9LGFyZ1BhY2tBZHZhbmNlOjgscmVhZFZhbHVlRnJvbVBvaW50ZXI6UmUsZGVzdHJ1Y3RvckZ1bmN0aW9uOmZ1bmN0aW9uKGUpe0t0KGUpfX0pfSxfX2VtYmluZF9yZWdpc3Rlcl92YWx1ZV9vYmplY3Q6ZnVuY3Rpb24oZSx0LHIsbixvLGkpe1BlW2VdPXtuYW1lOnplKHQpLHJhd0NvbnN0cnVjdG9yOnZ0KHIsbikscmF3RGVzdHJ1Y3Rvcjp2dChvLGkpLGZpZWxkczpbXX19LF9fZW1iaW5kX3JlZ2lzdGVyX3ZhbHVlX29iamVjdF9maWVsZDpmdW5jdGlvbihlLHQscixuLG8saSxhLHMsdSxjKXtQZVtlXS5maWVsZHMucHVzaCh7ZmllbGROYW1lOnplKHQpLGdldHRlclJldHVyblR5cGU6cixnZXR0ZXI6dnQobixvKSxnZXR0ZXJDb250ZXh0Omksc2V0dGVyQXJndW1lbnRUeXBlOmEsc2V0dGVyOnZ0KHMsdSksc2V0dGVyQ29udGV4dDpjfSl9LF9fZW1iaW5kX3JlZ2lzdGVyX3ZvaWQ6ZnVuY3Rpb24oZSx0KXtZZShlLHtpc1ZvaWQ6ITAsbmFtZTp0PXplKHQpLGFyZ1BhY2tBZHZhbmNlOjAsZnJvbVdpcmVUeXBlOmZ1bmN0aW9uKCl7fSx0b1dpcmVUeXBlOmZ1bmN0aW9uKGUsdCl7fX0pfSxfYWJvcnQ6ZnVuY3Rpb24oKXtvLmFib3J0KCl9LF9lbXNjcmlwdGVuX21lbWNweV9iaWc6ZnVuY3Rpb24oZSx0LHIpe3JldHVybiBPLnNldChPLnN1YmFycmF5KHQsdCtyKSxlKSxlfSxfZ2V0ZW52OmZ1bmN0aW9uIGUodCl7cmV0dXJuIDA9PT10PzA6KHQ9dih0KSxNdC5oYXNPd25Qcm9wZXJ0eSh0KT8oZS5yZXQmJkt0KGUucmV0KSxlLnJldD0ocj1NdFt0XSxuPVMocikrMSwobz1KdChuKSkmJkEocixSLG8sbiksbykpOjApO3ZhciByLG4sb30sX2dldGdybmFtOmZ1bmN0aW9uKCl7by5wcmludEVycigibWlzc2luZyBmdW5jdGlvbjogZ2V0Z3JuYW0iKSxycigtMSl9LF9nZXRwd25hbTpmdW5jdGlvbigpe3Rocm93ImdldHB3bmFtOiBUT0RPIn0sX2pzQ2xvc2U6ZnVuY3Rpb24oKXtyZXR1cm4gYS5jbG9zZS5hcHBseShudWxsLGFyZ3VtZW50cyl9LF9qc0NyZWF0ZTpmdW5jdGlvbihlKXtyZXR1cm4gYS5jcmVhdGUuY2FsbChudWxsLGsoZSkpfSxfanNPcGVuOmZ1bmN0aW9uKGUpe3JldHVybiBhLm9wZW4uY2FsbChudWxsLGsoZSkpfSxfanNSZWFkOmZ1bmN0aW9uKCl7cmV0dXJuIGEucmVhZC5hcHBseShudWxsLGFyZ3VtZW50cyl9LF9qc1NlZWs6ZnVuY3Rpb24oZSx0LHIpe3JldHVybiBhLnNlZWsuY2FsbChudWxsLGUsdCxiKHIpKX0sX2pzVGVsbDpmdW5jdGlvbigpe3JldHVybiBhLnRlbGwuYXBwbHkobnVsbCxhcmd1bWVudHMpfSxfanNXcml0ZTpmdW5jdGlvbigpe3JldHVybiBhLndyaXRlLmFwcGx5KG51bGwsYXJndW1lbnRzKX0sX2xsdm1fZWhfdHlwZWlkX2ZvcjpmdW5jdGlvbihlKXtyZXR1cm4gZX0sX2xvY2FsdGltZTpmdW5jdGlvbihlKXtyZXR1cm4gZnVuY3Rpb24oZSx0KXtqdCgpO3ZhciByPW5ldyBEYXRlKDFlMypGW2U+PjJdKTtGW3Q+PjJdPXIuZ2V0U2Vjb25kcygpLEZbdCs0Pj4yXT1yLmdldE1pbnV0ZXMoKSxGW3QrOD4+Ml09ci5nZXRIb3VycygpLEZbdCsxMj4+Ml09ci5nZXREYXRlKCksRlt0KzE2Pj4yXT1yLmdldE1vbnRoKCksRlt0KzIwPj4yXT1yLmdldEZ1bGxZZWFyKCktMTkwMCxGW3QrMjQ+PjJdPXIuZ2V0RGF5KCk7dmFyIG49bmV3IERhdGUoci5nZXRGdWxsWWVhcigpLDAsMSksbz0oci5nZXRUaW1lKCktbi5nZXRUaW1lKCkpLzg2NGU1fDA7Rlt0KzI4Pj4yXT1vLEZbdCszNj4+Ml09LTYwKnIuZ2V0VGltZXpvbmVPZmZzZXQoKTt2YXIgaT1uZXcgRGF0ZSgyZTMsNiwxKS5nZXRUaW1lem9uZU9mZnNldCgpLGE9bi5nZXRUaW1lem9uZU9mZnNldCgpLHM9MHwoaSE9YSYmci5nZXRUaW1lem9uZU9mZnNldCgpPT1NYXRoLm1pbihhLGkpKTtGW3QrMzI+PjJdPXM7dmFyIHU9RltCdCsocz80OjApPj4yXTtyZXR1cm4gRlt0KzQwPj4yXT11LHR9KGUsSXQpfSxfbWt0aW1lOmZ1bmN0aW9uKGUpe2p0KCk7dmFyIHQ9bmV3IERhdGUoRltlKzIwPj4yXSsxOTAwLEZbZSsxNj4+Ml0sRltlKzEyPj4yXSxGW2UrOD4+Ml0sRltlKzQ+PjJdLEZbZT4+Ml0sMCkscj1GW2UrMzI+PjJdLG49dC5nZXRUaW1lem9uZU9mZnNldCgpLG89bmV3IERhdGUodC5nZXRGdWxsWWVhcigpLDAsMSksaT1uZXcgRGF0ZSgyZTMsNiwxKS5nZXRUaW1lem9uZU9mZnNldCgpLGE9by5nZXRUaW1lem9uZU9mZnNldCgpLHM9TWF0aC5taW4oYSxpKTtpZihyPDApRltlKzMyPj4yXT1OdW1iZXIoaSE9YSYmcz09bik7ZWxzZSBpZihyPjAhPShzPT1uKSl7dmFyIHU9TWF0aC5tYXgoYSxpKSxjPXI+MD9zOnU7dC5zZXRUaW1lKHQuZ2V0VGltZSgpKzZlNCooYy1uKSl9RltlKzI0Pj4yXT10LmdldERheSgpO3ZhciBsPSh0LmdldFRpbWUoKS1vLmdldFRpbWUoKSkvODY0ZTV8MDtyZXR1cm4gRltlKzI4Pj4yXT1sLHQuZ2V0VGltZSgpLzFlM3wwfSxfcHRocmVhZF9nZXRzcGVjaWZpYzpmdW5jdGlvbihlKXtyZXR1cm4gVXRbZV18fDB9LF9wdGhyZWFkX2tleV9jcmVhdGU6ZnVuY3Rpb24oZSx0KXtyZXR1cm4gMD09ZT9tZS5FSU5WQUw6KEZbZT4+Ml09enQsVXRbenRdPTAsenQrKywwKX0sX3B0aHJlYWRfb25jZTpmdW5jdGlvbiBlKHQscil7ZS5zZWVufHwoZS5zZWVuPXt9KSx0IGluIGUuc2Vlbnx8KG8uZHluQ2FsbF92KHIpLGUuc2Vlblt0XT0xKX0sX3B0aHJlYWRfc2V0c3BlY2lmaWM6ZnVuY3Rpb24oZSx0KXtyZXR1cm4gZSBpbiBVdD8oVXRbZV09dCwwKTptZS5FSU5WQUx9LF90aW1lOmZ1bmN0aW9uKGUpe3ZhciB0PURhdGUubm93KCkvMWUzfDA7cmV0dXJuIGUmJihGW2U+PjJdPXQpLHR9LERZTkFNSUNUT1BfUFRSOiQsU1RBQ0tUT1A6VX07dmFyIFd0PW8uYXNtKG8uYXNtR2xvYmFsQXJnLG8uYXNtTGlicmFyeUFyZyxEKTtvLmFzbT1XdDt2YXIgWXQ9by5fX0dMT0JBTF9fc3ViX0lfYmluZF9jcHA9ZnVuY3Rpb24oKXtyZXR1cm4gby5hc20uX19HTE9CQUxfX3N1Yl9JX2JpbmRfY3BwLmFwcGx5KG51bGwsYXJndW1lbnRzKX0sVnQ9by5fX0dMT0JBTF9fc3ViX0lfYnJpZGdlX2NwcD1mdW5jdGlvbigpe3JldHVybiBvLmFzbS5fX0dMT0JBTF9fc3ViX0lfYnJpZGdlX2NwcC5hcHBseShudWxsLGFyZ3VtZW50cyl9LEh0PW8uX19HTE9CQUxfX3N1Yl9JX2NyY19jcHA9ZnVuY3Rpb24oKXtyZXR1cm4gby5hc20uX19HTE9CQUxfX3N1Yl9JX2NyY19jcHAuYXBwbHkobnVsbCxhcmd1bWVudHMpfSxHdD1vLl9fR0xPQkFMX19zdWJfSV9nbG9iYWxfY3BwPWZ1bmN0aW9uKCl7cmV0dXJuIG8uYXNtLl9fR0xPQkFMX19zdWJfSV9nbG9iYWxfY3BwLmFwcGx5KG51bGwsYXJndW1lbnRzKX0scXQ9KG8uX19fY3hhX2Nhbl9jYXRjaD1mdW5jdGlvbigpe3JldHVybiBvLmFzbS5fX19jeGFfY2FuX2NhdGNoLmFwcGx5KG51bGwsYXJndW1lbnRzKX0sby5fX19jeGFfaXNfcG9pbnRlcl90eXBlPWZ1bmN0aW9uKCl7cmV0dXJuIG8uYXNtLl9fX2N4YV9pc19wb2ludGVyX3R5cGUuYXBwbHkobnVsbCxhcmd1bWVudHMpfSxvLl9fX2Vycm5vX2xvY2F0aW9uPWZ1bmN0aW9uKCl7cmV0dXJuIG8uYXNtLl9fX2Vycm5vX2xvY2F0aW9uLmFwcGx5KG51bGwsYXJndW1lbnRzKX0sby5fX19nZXRUeXBlTmFtZT1mdW5jdGlvbigpe3JldHVybiBvLmFzbS5fX19nZXRUeXBlTmFtZS5hcHBseShudWxsLGFyZ3VtZW50cyl9KSxYdD1vLl9lbXNjcmlwdGVuX3JlcGxhY2VfbWVtb3J5PWZ1bmN0aW9uKCl7cmV0dXJuIG8uYXNtLl9lbXNjcmlwdGVuX3JlcGxhY2VfbWVtb3J5LmFwcGx5KG51bGwsYXJndW1lbnRzKX0sS3Q9by5fZnJlZT1mdW5jdGlvbigpe3JldHVybiBvLmFzbS5fZnJlZS5hcHBseShudWxsLGFyZ3VtZW50cyl9LEp0PW8uX21hbGxvYz1mdW5jdGlvbigpe3JldHVybiBvLmFzbS5fbWFsbG9jLmFwcGx5KG51bGwsYXJndW1lbnRzKX0sWnQ9by5zZXRUZW1wUmV0MD1mdW5jdGlvbigpe3JldHVybiBvLmFzbS5zZXRUZW1wUmV0MC5hcHBseShudWxsLGFyZ3VtZW50cyl9LFF0PShvLnNldFRocmV3PWZ1bmN0aW9uKCl7cmV0dXJuIG8uYXNtLnNldFRocmV3LmFwcGx5KG51bGwsYXJndW1lbnRzKX0sby5zdGFja0FsbG9jPWZ1bmN0aW9uKCl7cmV0dXJuIG8uYXNtLnN0YWNrQWxsb2MuYXBwbHkobnVsbCxhcmd1bWVudHMpfSk7by5keW5DYWxsX2RpaT1mdW5jdGlvbigpe3JldHVybiBvLmFzbS5keW5DYWxsX2RpaS5hcHBseShudWxsLGFyZ3VtZW50cyl9LG8uZHluQ2FsbF9pPWZ1bmN0aW9uKCl7cmV0dXJuIG8uYXNtLmR5bkNhbGxfaS5hcHBseShudWxsLGFyZ3VtZW50cyl9LG8uZHluQ2FsbF9paT1mdW5jdGlvbigpe3JldHVybiBvLmFzbS5keW5DYWxsX2lpLmFwcGx5KG51bGwsYXJndW1lbnRzKX0sby5keW5DYWxsX2lpaT1mdW5jdGlvbigpe3JldHVybiBvLmFzbS5keW5DYWxsX2lpaS5hcHBseShudWxsLGFyZ3VtZW50cyl9LG8uZHluQ2FsbF9paWlpPWZ1bmN0aW9uKCl7cmV0dXJuIG8uYXNtLmR5bkNhbGxfaWlpaS5hcHBseShudWxsLGFyZ3VtZW50cyl9LG8uZHluQ2FsbF9paWlpaT1mdW5jdGlvbigpe3JldHVybiBvLmFzbS5keW5DYWxsX2lpaWlpLmFwcGx5KG51bGwsYXJndW1lbnRzKX0sby5keW5DYWxsX2lpaWlpaT1mdW5jdGlvbigpe3JldHVybiBvLmFzbS5keW5DYWxsX2lpaWlpaS5hcHBseShudWxsLGFyZ3VtZW50cyl9LG8uZHluQ2FsbF9paWlpaWlpPWZ1bmN0aW9uKCl7cmV0dXJuIG8uYXNtLmR5bkNhbGxfaWlpaWlpaS5hcHBseShudWxsLGFyZ3VtZW50cyl9LG8uZHluQ2FsbF9paWlpaWlpaWlpPWZ1bmN0aW9uKCl7cmV0dXJuIG8uYXNtLmR5bkNhbGxfaWlpaWlpaWlpaS5hcHBseShudWxsLGFyZ3VtZW50cyl9LG8uZHluQ2FsbF9paWlpaWlqaWk9ZnVuY3Rpb24oKXtyZXR1cm4gby5hc20uZHluQ2FsbF9paWlpaWlqaWkuYXBwbHkobnVsbCxhcmd1bWVudHMpfSxvLmR5bkNhbGxfaWpqPWZ1bmN0aW9uKCl7cmV0dXJuIG8uYXNtLmR5bkNhbGxfaWpqLmFwcGx5KG51bGwsYXJndW1lbnRzKX0sby5keW5DYWxsX2ppPWZ1bmN0aW9uKCl7cmV0dXJuIG8uYXNtLmR5bkNhbGxfamkuYXBwbHkobnVsbCxhcmd1bWVudHMpfSxvLmR5bkNhbGxfdj1mdW5jdGlvbigpe3JldHVybiBvLmFzbS5keW5DYWxsX3YuYXBwbHkobnVsbCxhcmd1bWVudHMpfSxvLmR5bkNhbGxfdmk9ZnVuY3Rpb24oKXtyZXR1cm4gby5hc20uZHluQ2FsbF92aS5hcHBseShudWxsLGFyZ3VtZW50cyl9LG8uZHluQ2FsbF92aWk9ZnVuY3Rpb24oKXtyZXR1cm4gby5hc20uZHluQ2FsbF92aWkuYXBwbHkobnVsbCxhcmd1bWVudHMpfSxvLmR5bkNhbGxfdmlpZD1mdW5jdGlvbigpe3JldHVybiBvLmFzbS5keW5DYWxsX3ZpaWQuYXBwbHkobnVsbCxhcmd1bWVudHMpfSxvLmR5bkNhbGxfdmlpaT1mdW5jdGlvbigpe3JldHVybiBvLmFzbS5keW5DYWxsX3ZpaWkuYXBwbHkobnVsbCxhcmd1bWVudHMpfSxvLmR5bkNhbGxfdmlpaWk9ZnVuY3Rpb24oKXtyZXR1cm4gby5hc20uZHluQ2FsbF92aWlpaS5hcHBseShudWxsLGFyZ3VtZW50cyl9LG8uZHluQ2FsbF92aWlpaWk9ZnVuY3Rpb24oKXtyZXR1cm4gby5hc20uZHluQ2FsbF92aWlpaWkuYXBwbHkobnVsbCxhcmd1bWVudHMpfSxvLmR5bkNhbGxfdmlpaWlpaT1mdW5jdGlvbigpe3JldHVybiBvLmFzbS5keW5DYWxsX3ZpaWlpaWkuYXBwbHkobnVsbCxhcmd1bWVudHMpfSxvLmR5bkNhbGxfdmlpaWlpaWlpaT1mdW5jdGlvbigpe3JldHVybiBvLmFzbS5keW5DYWxsX3ZpaWlpaWlpaWkuYXBwbHkobnVsbCxhcmd1bWVudHMpfSxvLmR5bkNhbGxfdmlpaWlpaWlpaWk9ZnVuY3Rpb24oKXtyZXR1cm4gby5hc20uZHluQ2FsbF92aWlpaWlpaWlpaS5hcHBseShudWxsLGFyZ3VtZW50cyl9LG8uZHluQ2FsbF92aWo9ZnVuY3Rpb24oKXtyZXR1cm4gby5hc20uZHluQ2FsbF92aWouYXBwbHkobnVsbCxhcmd1bWVudHMpfSxvLmR5bkNhbGxfdmlqaT1mdW5jdGlvbigpe3JldHVybiBvLmFzbS5keW5DYWxsX3ZpamkuYXBwbHkobnVsbCxhcmd1bWVudHMpfTtmdW5jdGlvbiBlcihlKXt0aGlzLm5hbWU9IkV4aXRTdGF0dXMiLHRoaXMubWVzc2FnZT0iUHJvZ3JhbSB0ZXJtaW5hdGVkIHdpdGggZXhpdCgiK2UrIikiLHRoaXMuc3RhdHVzPWV9ZnVuY3Rpb24gdHIoZSl7ZnVuY3Rpb24gdCgpe28uY2FsbGVkUnVufHwoby5jYWxsZWRSdW49ITAsbXx8KHRlfHwodGU9ITAsWChKKSksWChaKSxvLm9uUnVudGltZUluaXRpYWxpemVkJiZvLm9uUnVudGltZUluaXRpYWxpemVkKCksZnVuY3Rpb24oKXtpZihvLnBvc3RSdW4pZm9yKCJmdW5jdGlvbiI9PXR5cGVvZiBvLnBvc3RSdW4mJihvLnBvc3RSdW49W28ucG9zdFJ1bl0pO28ucG9zdFJ1bi5sZW5ndGg7KWU9by5wb3N0UnVuLnNoaWZ0KCksZWUudW5zaGlmdChlKTt2YXIgZTtYKGVlKX0oKSkpfXNlPjB8fCghZnVuY3Rpb24oKXtpZihvLnByZVJ1bilmb3IoImZ1bmN0aW9uIj09dHlwZW9mIG8ucHJlUnVuJiYoby5wcmVSdW49W28ucHJlUnVuXSk7by5wcmVSdW4ubGVuZ3RoOyllPW8ucHJlUnVuLnNoaWZ0KCksSy51bnNoaWZ0KGUpO3ZhciBlO1goSyl9KCksc2U+MHx8by5jYWxsZWRSdW58fChvLnNldFN0YXR1cz8oby5zZXRTdGF0dXMoIlJ1bm5pbmcuLi4iKSxzZXRUaW1lb3V0KChmdW5jdGlvbigpe3NldFRpbWVvdXQoKGZ1bmN0aW9uKCl7by5zZXRTdGF0dXMoIiIpfSksMSksdCgpfSksMSkpOnQoKSkpfWZ1bmN0aW9uIHJyKGUpe3Rocm93IG8ub25BYm9ydCYmby5vbkFib3J0KGUpLHZvaWQgMCE9PWU/KG8ucHJpbnQoZSksby5wcmludEVycihlKSxlPUpTT04uc3RyaW5naWZ5KGUpKTplPSIiLG09ITAsImFib3J0KCIrZSsiKS4gQnVpbGQgd2l0aCAtcyBBU1NFUlRJT05TPTEgZm9yIG1vcmUgaW5mby4ifWlmKG8uYXNtPVd0LGVyLnByb3RvdHlwZT1uZXcgRXJyb3IsZXIucHJvdG90eXBlLmNvbnN0cnVjdG9yPWVyLHVlPWZ1bmN0aW9uIGUoKXtvLmNhbGxlZFJ1bnx8dHIoKSxvLmNhbGxlZFJ1bnx8KHVlPWUpfSxvLnJ1bj10cixvLmV4aXQ9ZnVuY3Rpb24oZSx0KXt0JiZvLm5vRXhpdFJ1bnRpbWUmJjA9PT1lfHwoby5ub0V4aXRSdW50aW1lfHwobT0hMCxVPXZvaWQgMCxYKFEpLG8ub25FeGl0JiZvLm9uRXhpdChlKSksbCYmcHJvY2Vzcy5leGl0KGUpLG8ucXVpdChlLG5ldyBlcihlKSkpfSxvLmFib3J0PXJyLG8ucHJlSW5pdClmb3IoImZ1bmN0aW9uIj09dHlwZW9mIG8ucHJlSW5pdCYmKG8ucHJlSW5pdD1bby5wcmVJbml0XSk7by5wcmVJbml0Lmxlbmd0aD4wOylvLnByZUluaXQucG9wKCkoKTtyZXR1cm4gby5ub0V4aXRSdW50aW1lPSEwLHRyKCksdH07ZnVuY3Rpb24gaSh7cmVzb3VyY2VJZDplLHVybDp0fSl7cmV0dXJuIG5ldyBQcm9taXNlKChmdW5jdGlvbihlLG8pe2lmKCFyKXRocm93IG5ldyBFcnJvcigidW5wYWNrQnJpZGdlIG5vdCBkZXRlY3RlZCIpO2lmKCFuKXRocm93IG5ldyBFcnJvcigidW5wYWNrIG5vdCBkZXRlY3RlZCIpOyhmdW5jdGlvbihlKXtyZXR1cm4gZmV0Y2gobmV3IFJlcXVlc3QoZSkpLnRoZW4oZT0+e2lmKGUub2spcmV0dXJuIGUuYXJyYXlCdWZmZXIoKTt0aHJvdyBuZXcgRXJyb3IoIjQwNCBFcnJvcjogRmlsZSBub3QgZm91bmQuIil9KS50aGVuKGU9PnIuY3JlYXRlRXh0cmFjdG9yRnJvbURhdGEoZSkpfSkodCkudGhlbih0PT57ZSh0LmV4dHJhY3RBbGwoKSl9LGU9PntvKGUpfSl9KSl9ZnVuY3Rpb24gYShlLHQpe2NvbnN0W3Isbl09dDtpZigiRkFJTCI9PXIuc3RhdGUpe2NvbnN0IHQ9e3R5cGU6IkVSUk9SIixyZWFzb246ci5yZWFzb24sbXNnOnIubXNnLHJlc291cmNlSWQ6ZS5kYXRhLnJlc291cmNlSWQsdXJsOmUuZGF0YS51cmx9O3JldHVybiB2b2lkIHNlbGYucG9zdE1lc3NhZ2UodCl9Y29uc3Qgbz17dHlwZToiRklOSVNIRUQiLHJlc291cmNlSWQ6ZS5kYXRhLnJlc291cmNlSWQsZW50cmllczp7fX0saT1bXTtpZihuJiZuLmZpbGVzKWZvcihjb25zdCBlIG9mIG4uZmlsZXMpby5lbnRyaWVzW2UuZmlsZUhlYWRlci5uYW1lXT1lLmV4dHJhY3RbMV0saS5wdXNoKGUuZXh0cmFjdFsxXS5idWZmZXIpO3NlbGYucG9zdE1lc3NhZ2UobyxpKX1vbm1lc3NhZ2U9ZnVuY3Rpb24oZSl7aWYoImluaXQiPT1lLmRhdGEudHlwZSluPW8oZS5kYXRhLndhc21VcmwpLG4ub25SdW50aW1lSW5pdGlhbGl6ZWQ9KCk9PnBvc3RNZXNzYWdlKHt0eXBlOiJXQVNNX0xPQURFRCJ9KTtlbHNlIGlmKCJmZXRjaCI9PWUuZGF0YS50eXBlKWkoZS5kYXRhKS50aGVuKHQ9PnthKGUsdCl9LHQ9Pntjb25zdCByPXt0eXBlOiJFUlJPUiIscmVzb3VyY2VJZDplLmRhdGEucmVzb3VyY2VJZCx1cmw6ZS5kYXRhLnVybH07c2VsZi5wb3N0TWVzc2FnZShyKX0pO2Vsc2UgaWYoInVucGFjayI9PWUuZGF0YS50eXBlKXtjb25zdHtidWZmZXI6dH09ZS5kYXRhO2lmKCFyKXRocm93IG5ldyBFcnJvcigidW5wYWNrQnJpZGdlIG5vdCBkZXRlY3RlZCIpO2lmKCFuKXRocm93IG5ldyBFcnJvcigidW5wYWNrIG5vdCBkZXRlY3RlZCIpO2NvbnN0IG89ci5jcmVhdGVFeHRyYWN0b3JGcm9tRGF0YSh0KS5leHRyYWN0QWxsKCk7YShlLG8pfX07Cgo=",null,!1);function ne(e){return e&&"object"==typeof e&&!Array.isArray(e)}function le(e,...t){if(!t.length)return e;const a=t.shift();if(ne(e)&&ne(a))for(const t in a)ne(a[t])?(e[t]||Object.assign(e,{[t]:{}}),le(e[t],a[t])):Object.assign(e,{[t]:a[t]});return le(e,...t)}const re=new class{constructor(){let e;this.loaded=new S,this.progressIncremented=new S,this.allResourcesLoaded=new S,this.fileUpdated=new S,this.__totalWork=0,this.__totalWorkByCategory={},this.__doneWork=0,this.__doneWorkByCategory={},this.__resourceRegisterCallbacks={},this.__callbacks={},this.__resources={},this.__resourcesTreeEntities={},this.__resourcesTree={children:{}},this.__workers=[],this.__nextWorker=0;const t=document.getElementsByTagName("script");for(let a=0;a<t.length;a++){const i=t[a];if(i.src.includes("zea-engine")){const t=i.src.split("/");t.pop(),t.pop(),e=t.join("/");break}}e||(e="https://unpkg.com/@zeainc/zea-engine@0.1.3"),this.wasmUrl=e+"/public-resources/unpack.wasm",this.addResourceURL("ZeaEngine/Vive.vla",e+"/public-resources/Vive.vla"),this.addResourceURL("ZeaEngine/Oculus.vla",e+"/public-resources/Oculus.vla");}getRootFolder(){return this.__resourcesTree}registerResourceCallback(e,t){this.__resourceRegisterCallbacks[e]=t;for(const a in this.__resources){const i=this.__resources[a];i.name.includes(e)&&t(i);}}__applyCallbacks(e){const t=e=>{for(const t in this.__resourceRegisterCallbacks)e.name.includes(t)&&this.__resourceRegisterCallbacks[t](e);};for(const a in e){const i=e[a];i.url&&t(i);}}__buildTree(e){const t=a=>{if(this.__resourcesTreeEntities[a])return;const i=e[a];i.id=a,"folder"!==i.type&&"dependency"!==i.type||(i.children={}),i.parent&&(this.__resourcesTreeEntities[i.parent]||t(i.parent)),(i.parent?this.__resourcesTreeEntities[i.parent]:this.__resourcesTree).children[i.name]=i,this.__resourcesTreeEntities[a]=i;};for(const a in e)t(a);}setResources(e){this.__resources=Object.assign(this.__resources,e),this.__buildTree(e),this.__applyCallbacks(e);}addResourceURL(e,t){const a=e.split("/"),i=a.pop();if(!t){let i=window.location.href.split("#")[0];i=i.split("?")[0],(i.endsWith(".html")||i.endsWith(".html"))&&(i=i.substring(0,i.lastIndexOf("/"))+"/");const s=i;if("."==a[0])a.shift();else if(".."==a[0]){item=item.substring(3);const e=s.split("/");e.pop(),e.pop(),s=e.join("/")+"/";}t=s+e;}let n;const l={};for(const e of a){const t=s(e);t in this.__resources||(this.__resources[t]={name:e,type:"folder",parent:n},l[t]=this.__resources[t]),n=t;}const r=s(i),o={name:i,url:t,parent:n,id:r};this.__resources[r]=o,l[r]=o,this.__buildTree(l),this.__applyCallbacks(l);}updateFile(e){const t=!(e.id in this.__resources);if(this.__resources[e.id]=e,t){console.log("New file added");const t={};t[e.id]=e,this.__buildTree(t);}this.fileUpdated.emit(e.id);}freeData(e){}__getWorker(){return this.__nextWorker=(this.__nextWorker+1)%3,null==this.__workers[this.__nextWorker]&&(this.__workers[this.__nextWorker]=(()=>new Promise(e=>{const t=new se;t.postMessage({type:"init",wasmUrl:this.wasmUrl}),t.onmessage=a=>{if("WASM_LOADED"===a.data.type)e(t);else if("FINISHED"===a.data.type){this.addWorkDone(a.data.resourceId,1),this.__onFinishedReceiveFileData(a.data);}else if("ERROR"===a.data.type){const e=a.data,t=this.__resources[e.resourceId];console.error("Unable to load Resource:",t?t.name:e.resourceId," With url:",e.url);}};}))()),this.__workers[this.__nextWorker]}__terminateWorkers(){for(const e of this.__workers)e.terminate();this.__workers=[];}getFilepath(e){let t=this.__resources[e];const a=[t.name];for(;t.parent;)t=this.__resources[t.parent],a.splice(0,0,t.name);return a.join("/")}resourceAvailable(e){return e.indexOf(".")>0?(console.warn("Deprecation warning for resourceAvailable. Value should be a file id, not a path."),null!=this.resolveFilepath(e)):e in this.__resources}getFile(e){return this.__resources[e]}resolveFilePathToId(e){if(!e)return void console.warn("Invalid file path:",e);const t=this.resolveFilepath(e);return t?t.id:void 0}resolveFilepath(e){const t=e.split("/");"."!=t[0]&&""!=t[0]||t.shift();let a=this.__resourcesTree;for(const i of t){if(!(i in a.children))return console.warn("Unable to resolve key:"+i+" of path:"+e),null;a=a.children[i];}return a}resolveFile(e){return console.warn("Deprecation warning for resolveFile. Use resolveFilepath."),this.resolveFilepath(e)}resolveURL(e){console.warn("Deprecation warning for resolveURL. Use resolveFilepath.");const t=this.resolveFilepath(e);if(t)return t.url}addWork(e,t){this.__totalWork+=t,this.progressIncremented.emit(this.__doneWork/this.__totalWork*100);}addWorkDone(e,t){if(this.__doneWork+=t,this.progressIncremented.emit(this.__doneWork/this.__totalWork*100),this.__doneWork>this.__totalWork)throw new Error("Mismatch between work loaded and work done.");this.__doneWork==this.__totalWork&&this.allResourcesLoaded.emit();}loadResource(e,t,a=!0){const i=this.getFile(e);if(!i)throw new Error("Invalid resource Id:'"+e+"' not found in Resources:"+JSON.stringify(this.__resources,null,2));this.loadUrl(e,i.url,t,a);}loadURL(e,t,a,i=!0){return console.warn("Please call loadUrl instead,"),this.loadUrl(e,t,a,i)}loadUrl(e,t,a,i=!0){i&&this.addWork(e,3),e in this.__callbacks||(this.__callbacks[e]=[]),this.__callbacks[e].push(a),fetch(t).then(e=>function(e){if(!e.ok)throw new Error(`HTTP ${e.status} - ${e.statusText}`);return e}(e)&&e.arrayBuffer()).then(t=>{this.__getWorker().then(a=>{a.postMessage({type:"unpack",resourceId:e,buffer:t});});});}unpackBuffer(e,t,a,i=!0){return new Promise((s,n)=>{i&&this.addWork(e,3),e in this.__callbacks||(this.__callbacks[e]=[]),a&&this.__callbacks[e].push(a),this.__callbacks[e].push(e=>{s(e);}),this.__getWorker().then(a=>{a.postMessage({type:"unpack",resourceId:e,buffer:t},[t]);});})}__onFinishedReceiveFileData(e){const t=e.resourceId;this.addWorkDone(t,1);const a=this.__callbacks[t];if(a){for(const t of a)t(e.entries);delete this.__callbacks[t];}this.loaded.emit(t),this.addWorkDone(t,1);}suspend(){this.__terminateWorkers();}traverse(e){const t=e=>{for(const t in e.children)a(e.children[t]);},a=a=>{if(0==e(a))return !1;a.children&&t(a);};t(this.__resourcesTree);}};class oe{constructor(e){if(e){const t=e.split("-"),a=t[0].split(".");this.major=parseInt(a[0]),this.minor=parseInt(a[1]),this.patch=parseInt(a[2]),2==t.length&&(this.branch=t[1]);}else this.major=0,this.minor=0,this.patch=0;}equals(e){return !(this.patch==e[2]&&this.minor==e[1]&&this.major==e[0])}lessThan(e){return !(this.major>=e[0]||this.minor>=e[1]||this.patch>=e[2])}greaterThan(e){return this.major>e[0]||this.minor>e[1]||this.patch>e[2]}greaterOrEqualThan(e){return !(this.major<e[0])&&(this.major>e[0]||!(this.minor<e[1])&&(this.minor>e[1]||!(this.patch<e[2])))}}class de{constructor(e,t=0,a=!0){this.__data=e,this.__byteOffset=t,this.__dataView=new DataView(this.__data),this.__isMobileDevice=a,this.utf8decoder=new TextDecoder;}get isMobileDevice(){return this.__isMobileDevice}get data(){return this.__data}get byteLength(){return this.__dataView.byteLength}get remainingByteLength(){return this.__dataView.byteLength-this.__byteOffset}pos(){return this.__byteOffset}seek(e){this.__byteOffset=e;}advance(e){this.__byteOffset+=e;}loadUInt8(){const e=this.__dataView.getUint8(this.__byteOffset);return this.__byteOffset+=1,e}loadUInt16(){const e=this.__dataView.getUint16(this.__byteOffset,!0);return this.__byteOffset+=2,e}loadUInt32(){const e=this.__dataView.getUint32(this.__byteOffset,!0);return this.__byteOffset+=4,e}loadSInt32(){const e=this.__dataView.getInt32(this.__byteOffset,!0);return this.__byteOffset+=4,e}loadFloat16(){const e=this.loadUInt16();return Math.decode16BitFloat(e)}loadUFloat16(){const e=this.loadFloat16();return e<0?2048-e:e}loadFloat16From2xUInt8(){const e=this.__dataView.getFloat16(this.__byteOffset,!0);return this.__byteOffset+=2,e}loadUInt32From2xUFloat16(){return this.loadUFloat16()+4096*this.loadUFloat16()}loadSInt32From2xFloat16(){return this.loadFloat16()+2048*this.loadFloat16()}loadFloat32(){const e=this.__dataView.getFloat32(this.__byteOffset,!0);return this.__byteOffset+=4,e}loadUInt8Array(e,t=!1){null==e&&(e=this.loadUInt32());const a=new Uint8Array(this.__data,this.__byteOffset,e);this.__byteOffset+=e;return a}loadUInt16Array(e,t=!1){if(null==e&&(e=this.loadUInt32()),0==e)return new Uint16Array;let a;if(this.readPadd(2),this.__isMobileDevice){a=new Uint16Array(e);for(let t=0;t<e;t++)a[t]=this.__dataView.getUint16(this.__byteOffset,!0),this.__byteOffset+=2;}else a=new Uint16Array(this.__data,this.__byteOffset,e),this.__byteOffset+=2*e;return a}loadUInt32Array(e,t=!1){if(null==e&&(e=this.loadUInt32()),0==e)return new Uint32Array;let a;if(this.readPadd(4),this.__isMobileDevice){a=new Uint32Array(e);for(let t=0;t<e;t++)a[t]=this.__dataView.getUint32(this.__byteOffset,!0),this.__byteOffset+=4;}else a=new Uint32Array(this.__data,this.__byteOffset,e),this.__byteOffset+=4*e;return a}loadFloat32Array(e,t=!1){if(null==e&&(e=this.loadUInt32()),0==e)return new Float32Array;let a;if(this.readPadd(4),this.__isMobileDevice){a=new Float32Array(e);for(let t=0;t<e;t++)a[t]=this.__dataView.getFloat32(this.__byteOffset,!0),this.__byteOffset+=4;}else a=new Float32Array(this.__data,this.__byteOffset,e),this.__byteOffset+=4*e;return a}loadStr(){const e=this.loadUInt32(),t=new Uint8Array(this.__data,this.__byteOffset,e);return this.__byteOffset+=e,this.utf8decoder.decode(t)}loadStrArray(){const e=this.loadUInt32(),t=[];for(let a=0;a<e;a++)t[a]=this.loadStr();return t}loadSInt32Vec2(){const e=this.loadSInt32(),t=this.loadSInt32();return new o(e,t)}loadUInt32Vec2(){const e=this.loadUInt32(),t=this.loadUInt32();return new o(e,t)}loadFloat16Vec2(){const e=this.loadFloat16(),t=this.loadFloat16();return new o(e,t)}loadFloat32Vec2(){const e=this.loadFloat32(),t=this.loadFloat32();return new o(e,t)}loadFloat16Vec3(){const e=this.loadFloat16(),t=this.loadFloat16(),a=this.loadFloat16();return new d(e,t,a)}loadFloat32Vec3(){const e=this.loadFloat32(),t=this.loadFloat32(),a=this.loadFloat32();return new d(e,t,a)}loadFloat16Quat(){const e=this.loadFloat16(),t=this.loadFloat16(),a=this.loadFloat16(),i=this.loadFloat16();return new Z(e,t,a,i)}loadFloat32Quat(){const e=this.loadFloat32(),t=this.loadFloat32(),a=this.loadFloat32(),i=this.loadFloat32();return new Z(e,t,a,i)}loadRGBFloat32Color(){const e=this.loadFloat32(),t=this.loadFloat32(),a=this.loadFloat32();return new u(e,t,a)}loadRGBAFloat32Color(){const e=this.loadFloat32(),t=this.loadFloat32(),a=this.loadFloat32(),i=this.loadFloat32();return new u(e,t,a,i)}loadRGBUInt8Color(){const e=this.loadUInt8(),t=this.loadUInt8(),a=this.loadUInt8();return new u(e/255,t/255,a/255)}loadRGBAUInt8Color(){const e=this.loadUInt8(),t=this.loadUInt8(),a=this.loadUInt8(),i=this.loadUInt8();return new u(e/255,t/255,a/255,i/255)}loadBox2(){return new y(this.loadFloat32Vec2(),this.loadFloat32Vec2())}loadBox3(){return new V(this.loadFloat32Vec3(),this.loadFloat32Vec3())}readPadd(e){const t=this.__byteOffset%e;0!=t&&(this.__byteOffset+=e-t);}}class he{constructor(e=0){this.__data=new ArrayBuffer(e),this.__byteOffset=0,this.__reserved=e,this.__dataView=new DataView(this.__data);}pos(){return this.__byteOffset}seek(e){this.__byteOffset=e;}seekEnd(){this.__byteOffset=this.__reserved;}getBuffer(){if(this.__data.byteLength==this.__byteOffset)return this.__data;return new Uint8Array(this.__data).slice(0,this.__byteOffset).buffer}__grow(){const e=2*(this.__reserved>0?this.__reserved:1),t=new ArrayBuffer(e),a=new Uint8Array(t),i=new Uint8Array(this.__data);a.set(i),this.__data=t,this.__dataView=new DataView(this.__data),this.__reserved=e;}__reserve(e){this.__byteOffset+e>this.__reserved&&this.__grow();}__offset(e){this.__byteOffset+=e,this.__byteOffset>this.__reserved&&this.__grow();}writeUInt8(e){this.__reserve(1),this.__dataView.setUint8(this.__byteOffset,e),this.__offset(1);}writeUInt16(e){this.__reserve(2),this.__dataView.setUint16(this.__byteOffset,e,!0),this.__offset(2);}writeUInt32(e){this.__reserve(4),this.__dataView.setUint32(this.__byteOffset,e,!0),this.__offset(4);}writeSInt32(e){this.__reserve(4),this.__dataView.setInt32(this.__byteOffset,e,!0),this.__offset(4);}writeFloat16(e){const t=Math.encode16BitFloat(e);this.writeUInt16(t);}writeFloat32(e){this.__reserve(4),this.__dataView.setFloat32(this.__byteOffset,e,!0),this.__offset(4);}writeUInt8Array(e,t=!0){const a=e.size?e.size:e.length;this.__reserve(a+(t?4:0)),t&&this.writeUInt32(a);for(let t=0;t<a;t++)this.writeUInt8(e[t]);}writeUInt16Array(e,t=!0){const a=e.size?e.size:e.length;this.__reserve(2*a+(t?4:0)),t&&this.writeUInt32(a);for(let t=0;t<a;t++)this.writeUInt16(e[t]);}writeUInt32Array(e,t=!0){const a=e.size?e.size:e.length;this.__reserve(4*a+(t?4:0)),t&&this.writeUInt32(a);for(let t=0;t<a;t++)this.writeUInt32(e[t]);}writeFloat32Array(e,t=!0){const a=e.size?e.size:e.length;this.__reserve(4*a+(t?4:0)),t&&this.writeUInt32(a);for(let t=0;t<a;t++)this.writeFloat32(e[t]);}writeStr(e,t=!0){const a=value.length;this.__reserve(4*a+(t?4:0)),t&&this.writeUInt32(a);for(let e=0;e<a;e++)this.writeFloat32(value.charCodeAt(e));}writeSInt32Vec2(e){this.writeSInt32(e.x),this.writeSInt32(e.y);}writeUInt32Vec2(e){this.writeUInt32(e.x),this.writeUInt32(e.y);}writeFloat16Vec2(e){this.writeFloat16(e.x),this.writeFloat16(e.y);}writeFloat32Vec2(e){this.writeFloat32(e.x),this.writeFloat32(e.y);}writeFloat16Vec3(e){this.writeFloat16(e.x),this.writeFloat16(e.y),this.writeFloat16(e.z);}writeFloat32Vec3(e){this.writeFloat32(e.x),this.writeFloat32(e.y),this.writeFloat32(e.z);}writeFloat16Quat(e){this.writeFloat16(e.x),this.writeFloat16(e.y),this.writeFloat16(e.z),this.writeFloat16(e.w);}writeFloat32Quat(e){this.writeFloat32(e.x),this.writeFloat32(e.y),this.writeFloat32(e.z),this.writeFloat32(e.w);}writeRGBFloat32Color(e){this.writeFloat32(e.r),this.writeFloat32(e.g),this.writeFloat32(e.b);}writeRGBAFloat32Color(e){this.writeFloat32(e.r),this.writeFloat32(e.g),this.writeFloat32(e.b),this.writeFloat32(e.a);}writeRGBUInt8Color(e){this.writeUInt8(e.r),this.writeUInt8(e.g),this.writeUInt8(e.b);}writeRGBAUInt8Color(e){this.writeUInt8(e.r),this.writeUInt8(e.g),this.writeUInt8(e.b),this.writeUInt8(e.a);}writeBox2(e){this.writeFloat32Vec2(e.p0),this.writeFloat32Vec2(e.p1);}writeBox3(e){this.writeFloat32Vec3(e.p0),this.writeFloat32Vec3(e.p1);}writePadd(e){const t=e-this.__byteOffset;this.__reserve(t),this.__offset(t);}writeAlignment(e){const t=this.__byteOffset%e;0!=t&&(this.__reserve(e-t),this.__offset(e-t));}}const ce=4;class me{constructor(e,t){this.__name=e,this.__cb=t,this.__flags=0;}getName(){return this.__name}getOwner(){return this.__ownerItem}setOwner(e){this.__ownerItem!==e&&(this.__ownerItem=e);}getPath(){if(this.__ownerItem){if(this.__ownerItem.getPath){const e=this.__ownerItem.getPath().slice();return e.push(this.__name),e}return [this.__ownerItem.getName(),this.__name]}return [this.__name]}setEnabled(e){e?this.__flags&=~ce:this.__flags|=~ce;}isEnabled(){}invoke(){this.__cb();}}class ue extends P{constructor(e,t=0,a,i){super(e,t,"Number"),a&&!Array.isArray(a)&&console.error("Range value must be an array of 2 numbers."),this.__range=a,this.__step=i;}setValue(e,t){t==N.USER_SETVALUE&&(this.__range&&(e=Math.clamp(e,this.__range[0],this.__range[1])),this.__step&&(e=Math.round(e/this.__step)*this.__step)),super.setValue(e,t);}getValue(e){return super.getValue(e)}getRange(){return this.__range}setRange(e){return this.__range=e,this}getStep(){return this.__step}setStep(e){return this.__step=e,this}toJSON(e,t){const a=super.toJSON(e,t);return this.__range&&(a.range=this.__range),this.__step&&(a.step=this.__step),a}fromJSON(e,t,a){super.fromJSON(e,t,a),e.range&&(this.__range=e.range),e.step&&(this.__step=e.step);}readBinary(e,t){const a=e.loadFloat32();this.setValue(a,N.DATA_LOAD);}clone(e){const t=new ue(this.__name,this.__value);return t.__range=this.__range,t.__step=this.__step,t}}C.registerClass("NumberParameter",ue),C.registerClass("Property_SInt32",ue),C.registerClass("Property_UInt32",ue),C.registerClass("Property_Float32",ue);class be extends ue{constructor(e,t,a){super(e,t,[0,a.length],1),this.choices=a;}getChoices(){return this.choices}setValue(e,t){"string"==typeof e?super.setValue(this.choices.indexOf(e),t):super.setValue(e,t);}}class pe extends P{constructor(e,t){super(e,t,"Boolean");}clone(e){return new pe(this.__name,this.__value)}}C.registerClass("BooleanParameter",pe);class ge extends P{constructor(e,t,a){super(e,t||new o,"Vec2"),this.__range=a;}getRange(){return this.__range}__setRange(e){this.__range=e,this.rangeChanged.emit();}clone(e){return new ge(this.__name,this.__value.clone())}}class _e extends P{constructor(e,t,a){super(e,t||new d,"Vec3");}clone(e){return new _e(this.__name,this.__value.clone())}}class Ze extends P{constructor(e,t){super(e,t||new h,"Vec4");}clone(e){return new Ze(this.__name,this.__value.clone())}}class Ge extends P{constructor(e,t){super(e,t||new u,"Color");}readBinary(e,t){const a=e.loadRGBAFloat32Color();a.applyGamma(2.2),this.setValue(a,N.DATA_LOAD);}clone(e){return new Ge(this.__name,this.__value.clone())}}C.registerClass("ColorParameter",Ge);class Xe extends P{constructor(e,t){super(e,t||new g,"Mat3");}clone(e){return new Xe(this.__name,this.__value.clone())}}class ye extends P{constructor(e,t){super(e,t||new _,"Mat4");}clone(e){return new ye(this.__name,this.__value.clone())}}class fe extends P{constructor(e,t){super(e,t||new X,"Xfo");}clone(e){return new fe(this.__name,this.__value.clone())}}class Ve extends P{constructor(e,t){super(e,t,"BaseImage"),this.valueParameterValueChanged=new S;}toJSON(e,t){const a=super.toJSON(e,t);return this.__value&&(a.imageType=this.__value.constructor.name),a}fromJSON(e,t,a){return e.imageType&&(this.__value=C.constructClass(e.imageType)),super.fromJSON(e,t,a)}clone(e){return new Ve(this.__name,this.__value)}}class xe extends P{constructor(e,t=""){super(e,t,"String"),this.multiLine=!1;}setMultiLine(e){this.multiLine=e;}getMultiLine(){return this.multiLine}readBinary(e,t){const a=e.loadStr();this.setValue(a,N.DATA_LOAD);}clone(e){return new xe(this.__name,this.__value)}}C.registerClass("StringParameter",xe),C.registerClass("Property_String",xe);class Ie extends xe{constructor(e,t=""){super(e,t,"String"),this.lang="js";}setLanguage(e){this.lang=e;}getLanguage(){return this.lang}clone(e){return new Ie(this.__name,this.__value)}}C.registerClass("CodeParameter",Ie);class Re extends P{constructor(e,t){super(e,"","FilePath"),this.fileUpdated=new S,t&&this.setSupportedExts(t);}setSupportedExts(e){this.__reextensions=new RegExp("\\.("+e+")$","i");}getFilepath(){return this.__file?re.getFilepath(this.__file.id):""}setFilepath(e,t){const a=re.resolveFilePathToId(e);a?this.setValue(a,t):console.warn("Resource unavailable:"+e);}getFilename(){if(this.__file)return this.__file.name}getExt(){const e=this.getFilename(),t=e.lastIndexOf(".");if(-1!=t)return e.substring(t).toLowerCase()}getStem(){const e=this.getFilename();if(e){const t=e.split(".");return 2==t.length?t[0]:e}}getFileFolder(){if(this.__file)return this.__file.parent?re.getFile(this.__file.parent):re.getRootFolder()}getFileFolderPath(){const e=this.getFilepath();if(e)return e.substring(0,e.lastIndexOf("/"))+"/"}getFile(){return this.__file}getFileDesc(){return this.__file}setUrl(e,t,a=N.USER_SETVALUE){const i=e.split("/");t||(t=i[i.length-1]),this.__value=t,this.__file={id:e,name:t,url:e},a!=N.USER_SETVALUE&&a!=N.REMOTEUSER_SETVALUE||(this.__flags|=K.USER_EDITED),this.valueChanged.emit(a);}getUrl(){return this.__file?this.__file.url:void 0}setDirty(e){throw new Error("Cannot drive a filepath param from an oporator")}setValue(e,t=N.USER_SETVALUE){if(null==e)throw new Error("Invalid value for setValue.");if(e.indexOf(".")>0)return console.warn("Deprecation warning for setValue. setValue should now only take a file id, not a path."),this.setFilepath(e,t);if(e==this.__value)return;const a=e;if(!re.resourceAvailable(a))return void console.warn("Resource unavailable:"+a);const i=re.getFile(a);if(this.__reextensions&&!this.__reextensions.test(i.name))return console.warn("Unsupported file type:"+i.name),!1;this.__value=e,this.__file=i,re.fileUpdated.connect(e=>{e==this.__value&&(this.__file=re.getFile(this.__value),this.fileUpdated.emit());}),t==N.USER_SETVALUE&&(this.__flags|=K.USER_EDITED),this.valueChanged.emit(t);}toJSON(e,t){if(0==(this.__flags&K.USER_EDITED))return;const a={};return this.__file&&(a.value=this.__file.id,a.filepath=re.getFilepath(this.__file.id)),a}fromJSON(e,t,a){if(e.value){if(e.value.indexOf(".")>0)return void this.setFilepath(e.value,N.DATA_LOAD);if(re.resourceAvailable(e.value))return this.setValue(e.value,N.DATA_LOAD),void(this.__flags|=K.USER_EDITED)}if(e.filepath){const t=re.resolveFilePathToId(e.filepath);if(t)return void this.setValue(t,N.DATA_LOAD);console.warn("Resource unavailable:"+e.filepath);}}clone(e){const t=new Re(this.__name);return t.__file=this.__file,t}destroy(){super.destroy();}}class Se extends P{constructor(e,t){super(e,[]),this.__dataType=t,this.elementAdded=new S,this.elementRemoved=new S;}__filter(e){return !0}getCount(){return this.__value.length}getElement(e){return this.__value[e]}setElement(e,t){this.__value[e]=t,this.valueChanged.emit(N.USER_SETVALUE);}addElement(e){if(null==e)e=new this.__dataType;else if(!this.__filter(e))return;return this.__value.push(e),this.__flags|=K.USER_EDITED,this.elementAdded.emit(e,this.__value.length-1),this.valueChanged.emit(N.USER_SETVALUE),e}removeElement(e){const t=this.__value[e];this.__value.splice(e,1),this.__flags|=K.USER_EDITED,this.elementRemoved.emit(t,e),this.valueChanged.emit(N.USER_SETVALUE);}insertElement(e,t){this.__filter(t)&&(this.__value.splice(e,0,t),this.__flags|=K.USER_EDITED,this.elementAdded.emit(t,e),this.valueChanged.emit(N.USER_SETVALUE));}toJSON(e,t){if(0==(this.__flags&K.USER_EDITED))return;const a=[];for(const i of this.__value)"string"==typeof this.__dataType?a.push(i):a.push(i.toJSON(e,t));return {items:a}}fromJSON(e,t,a){if(null!=e.items){this.__flags|=K.USER_EDITED,this.__value=[];for(let a=0;a<e.items.length;a++){let i;"string"==typeof this.__dataType?i=e.items[a]:(i=new this.__dataType,i.fromJSON(e.items[a],t)),this.__value.push(i),this.elementAdded.emit(i,this.__value.length-1);}this.valueChanged.emit(N.DATA_LOAD);}else console.warn("Invalid Parameter JSON");}clone(e){const t=this.__value.slice(0),a=new Se(this.__name,this.__dataType);return a.setValue(t),a}destroy(){for(let e=0;e<this.__value.length;e++)this.__value[e]instanceof P&&this.__value[e].destroy(),this.removeElement(e);}}class We extends P{constructor(e){super(e,{},"Struct"),this.__members=[];}_addMember(e){return this.__value[e.getName()]=e.getValue(),e.valueChanged.connect(()=>{this.__value[e.getName()]=e.getValue();}),this.__members.push(e),this.__flags|=K.USER_EDITED,this.valueChanged.emit(),e}getParameter(e){for(const t of this.__members)if(t.getName()==e)return t}getMember(e){return this.getParameter(e)}getMemberNames(){const e=[];for(let t=0;t<this.__members.length;t++){const a=this.__members[t];null!=a&&(e[t]=a.getName());}return e}toJSON(e,t){if(0==(this.__flags&K.USER_EDITED))return;const a=[];for(const i of this.__members)a.push(i.toJSON(e,t));return {members:a}}fromJSON(e,t,a){if(null!=e.members){this.__flags|=K.USER_EDITED;for(let a=0;a<e.members.length;a++)e.members[a]&&this.__members[a].fromJSON(e.members[a],t);}else console.warn("Invalid Parameter JSON");}destroy(){super.destroy();for(const e of this.__members)e.destroy();}}class Le extends P{constructor(e,t){super(e,void 0,"TreeItem"),this.__filterFn=t,this.treeItemGlobalXfoChanged=new S;}setOwner(e){this.__owner=e;}getOwner(){return this.__owner}setFilterFn(){this.__filterFn=filterFn;}getFilterFn(){return this.__filterFn}setValue(e,t=N.USER_SETVALUE){if(this.__filterFn&&!this.__filterFn(e))return !1;this.__value!==e&&(this.__value&&this.__value.globalXfoChanged.disconnect(this.treeItemGlobalXfoChanged.emit),this.__value=e,this.__value&&this.__value.globalXfoChanged.connect(this.treeItemGlobalXfoChanged.emit),t!=N.USER_SETVALUE&&t!=N.REMOTEUSER_SETVALUE||(this.__flags|=K.USER_EDITED),this.valueChanged.emit(t));}toJSON(e,t){if(0!=(this.__flags&K.USER_EDITED))return {value:e.makeRelative(this.__value.getPath())}}fromJSON(e,t,a){null!=e.value?(t.resolvePath(e.value,e=>{this.setValue(e);},()=>{console.warn("Unable to resolve tree item parameter value:"+pj.paramPath);}),this.__flags|=K.USER_EDITED):console.warn("Invalid Parameter JSON");}clone(e){return new Le(this.__name,this.__filterFn)}destroy(){this.__value&&this.__value.parameterValueChanged.disconnect(this.valueParameterValueChanged.emit);}}class ve extends P{constructor(e,t){super(e,void 0,"BaseItem"),this.__items=new Set,this.__filterFn=t,this.itemAdded=new S,this.itemRemoved=new S;}setFilterFn(e){this.__filterFn=e;}getFilterFn(){return this.__filterFn}getItem(e){return Array.from(this.__items)[e]}addItem(e,t=!0){if(this.__filterFn&&!this.__filterFn(e))return console.warn("ItemSet __filterFn rejecting item:",e.getPath()),!1;this.__items.add(e);const a=Array.from(this.__items).indexOf(e);return this.itemAdded.emit(e,a),t&&this.valueChanged.emit(),a}addItems(e,t=!0){e.forEach(e=>this.addItem(e,!1)),t&&this.valueChanged.emit();}removeItem(e,t=!0){const a=Array.from(this.__items)[e];return this.__items.delete(a),this.itemRemoved.emit(a,e),t&&this.valueChanged.emit(),a}setItems(e,t=!0){for(let t=this.__items.length-1;t>=0;t--){const a=this.__items[t];e.has(a)||this.removeItem(a,!1);}for(const t of e)this.__items.has(t)||this.addItem(t,!1);t&&this.valueChanged.emit();}clearItems(e=!0){this.__items.clear(),e&&this.valueChanged.emit();}getNumItems(){return Array.from(this.__items).length}getValue(){return this.__items}toJSON(e,t){return {}}fromJSON(e,t,a){}clone(e){return new ve(this.__name,this.__filterFn)}}class Me extends P{constructor(e,t){super(e,void 0,t.getDataType()),this.setSourceParameter(t);}setSourceParameter(e){this.sourceParameter=e,this.sourceParameter.valueChanged.connect(this.__proxyValueChanged.bind(this));}__proxyValueChanged(e){this.valueChanged.emit(e);}getDataType(){return this.sourceParameter.getDataType()}setValue(e,t){}getValue(e){return this.sourceParameter.getValue(e)}toJSON(e,t){const a=super.toJSON(e,t);return this.sourceParameter&&(a.sourceParameter=this.sourceParameter.getPath()),a}fromJSON(e,t,a){super.fromJSON(e,t,a),e.sourceParameter&&t.resolvePath(e.sourceParameter,e=>{this.setSourceParameter(e);},t=>{console.warn("Error loading Proxy Param: '"+this.getName()+"'. Unable to connect to:"+e.sourceParameter);}),e.range&&(this.sourceParameter=e.range),e.step&&(this.__step=e.step);}clone(e,t){const a=new Me(this.__name,this.__value);return this.sourceParameter&&this.connectToClonedSourceParam(t),a}connectToClonedSourceParam(e){e.resolveClonedItem(this.sourceParameter,e=>{clonedParam.setSourceParameter(e);},e=>{console.warn("Error cloning Proxy Param: '"+this.getName()+"'. Unable to connect to:"+j.sourceParameter);});}}C.registerClass("ProxyParameter",Me);class Fe extends P{constructor(e,t){super(e,void 0,"Geometry"),this.boundingBoxDirtied=new S,this.setValue(t);}setValue(e,t=N.USER_SETVALUE){this.__value!==e&&(this.__value&&this.__value.boundingBoxDirtied.disconnect(this.boundingBoxDirtied.emit),this.__value=e,this.__value&&this.__value.boundingBoxDirtied.connect(this.boundingBoxDirtied.emit),t!=N.USER_SETVALUE&&t!=N.REMOTEUSER_SETVALUE||(this.__flags|=K.USER_EDITED),t!=N.OPERATOR_SETVALUE&&this.valueChanged.emit(t));}toJSON(e,t){return super.toJSON(e,t)}fromJSON(e,t,a){return super.fromJSON(e,t,a)}clone(e){return new Fe(this.__name,this.__value)}destroy(){this.__value&&this.__value.boundingBoxDirtied.disconnect(this.boundingBoxDirtied.emit);}}class Te extends D{constructor(e){super(e),this.width=0,this.height=0,this.format="RGB",this.type="UNSIGNED_BYTE",this.addParameter(new pe("AlphaFromLuminance",!1)),this.addParameter(new pe("Invert",!1)),this.addParameter(new pe("FlipY",!1)),this.updated=this.parameterValueChanged,this.loaded=new S(!0);}isLoaded(){return !0}getMapping(){return this.__mapping}setMapping(e){this.__mapping=e;}isStream(){return !1}isStreamAtlas(){return this.__streamAtlas}getParams(){return {type:this.type,format:this.format,width:this.width,height:this.height,flipY:this.getParameter("FlipY").getValue(),invert:this.getParameter("Invert").getValue(),alphaFromLuminance:this.getParameter("AlphaFromLuminance").getValue()}}}class Ce extends ue{constructor(e,t,a){super(e,t,a),this.textureConnected=new S,this.textureDisconnected=new S;}getImage(){return this.__image}setImage(e,t=0){const a=()=>{this.textureDisconnected.emit();};e?(null!=this.__image&&this.__image!==e&&a(),this.__image=e,this.textureConnected.emit(),this.valueChanged.emit(t)):null!=this.__image&&(a(),this.__image=void 0,this.textureDisconnected.emit());}setValue(e){e instanceof Te?this.setImage(e):(null!=this.__image&&this.setImage(void 0),super.setValue(e));}readBinary(e,t){super.readBinary(e,t);const a=e.loadStr();""!=a&&(console.log("Load Texture"),this.setImage(t.materialLibrary.getImage(a)));}clone(e){return new Ce(this.__name,this.__value.clone())}}C.registerClass("MaterialFloatParam",Ce);class Ye extends Ge{constructor(e,t){super(e,t),this.textureConnected=new S,this.textureDisconnected=new S,this.__imageUpdated=this.__imageUpdated.bind(this);}getImage(){return this.__image}__imageUpdated(){this.valueChanged.emit();}setImage(e,t=0){const a=()=>{this.__image.loaded.disconnect(this.__imageUpdated),this.__image.updated.disconnect(this.__imageUpdated),this.__image=null,this.textureDisconnected.emit();};e?(null!=this.__image&&this.__image!==e&&a(),this.__image=e,this.__image.updated.connect(this.__imageUpdated),this.textureConnected.emit(),this.valueChanged.emit(t)):null!=this.__image&&(a(),this.__image=void 0,this.textureDisconnected.emit());}setValue(e){e instanceof Te?this.setImage(e):(null!=this.__image&&this.setImage(void 0),super.setValue(e));}readBinary(e,t){super.readBinary(e,t);const a=e.loadStr();""!=a&&this.setImage(t.materialLibrary.getImage(a));}clone(e){return new Ye(this.__name,this.__value.clone())}}C.registerClass("MaterialColorParam",Ye);const Ne=(e,t,a,i)=>"boolean"==typeof t||!1===t||!0===t?new P(e,t,"Boolean"):"string"==typeof t?new P(e,t,"String"):Number.isNumeric(t)?i?new Ce(e,t,a):new ue(e,t,a):t instanceof o?new ge(e,t):t instanceof d?new _e(e,t):t instanceof u?i?new Ye(e,t):new Ge(e,t):new P(e,t);class Ke extends D{constructor(e,t){super(e),this.shaderNameChanged=new S,this.visibleInGeomDataBuffer=!0,t&&this.setShaderName(t);}getShaderName(){return this.__shaderName}setShaderName(e){if(this.__shaderName==e)return;const t=C.getClass(e);if(!t)throw new Error("Error setting Shader. Shader not found:"+e);const a=t.getParamDeclarations(),i={};for(const e of a){let t=this.getParameter(e.name);t||(t=this.addParameter(Ne(e.name,e.defaultValue,e.range,0!=e.texturable))),i[e.name]=!0;}for(const e of this.__params)i[e.getName()]||this.removeParameter(e.getName());this.__shaderName=e,this.shaderNameChanged.emit(this.__shaderName);}removeAllTextures(){for(const e of this.__params)e.getImage&&e.getImage()&&e.setImage(void 0);}getParamTextures(){const e={};for(const t of this.__params)t.getImage&&t.getImage()&&(e[t.getName()]=t.getImage());return e}__makeParameterTexturable(e){makeParameterTexturable(e);}isTransparent(){const e=this.getParameter("Opacity");if(e&&(e.getValue()<.99||e.getImage()))return !0;const t=this.getParameter("BaseColor");return !(!t||!t.getImage()||"RGBA"!=t.getImage().format)}getShaderClass(){return C.getClass(this.getShaderName())}modifyParams(e,t){t&&this.setShaderName(t);for(const t in e){const a=this.getParameter(t);a&&(e[t]instanceof P?this.replaceParameter(e[t]):a.setValue(e[t]));}}toJSON(e,t=0){return super.toJSON(e,t)}fromJSON(e,t={},a=0){e.shader?(this.setShaderName(e.shader),super.fromJSON(e,t,a)):console.warn("Invalid Material JSON");}readBinary(e,t){let a=e.loadStr();if("StandardMaterial"==a&&(a="StandardSurfaceShader"),"TransparentMaterial"==a&&(a="TransparentSurfaceShader"),this.setShaderName(a),t.versions["zea-engine"].lessThan([0,0,3])){this.setName(e.loadStr());const a=e.loadUInt32();for(let s=0;s<a;s++){const a=(i=e.loadStr()).charAt(0).toUpperCase()+i.slice(1);let s;"MaterialColorParam"==e.loadStr()?(s=e.loadRGBAFloat32Color(),s.applyGamma(2.2)):s=e.loadFloat32();const n=e.loadStr();let l=this.getParameter(a);l?l.setValue(s):l=this.addParameter(Ne(a,s)),""!=n&&l.setImage&&(t.materialLibrary.hasImage(n)?l.setImage(t.materialLibrary.getImage(n)):console.warn("Missing Texture:"+n));}}else super.readBinary(e,t);var i;}clone(e){const t=new Ke;return t.copyFrom(this,e),t}copyFrom(e,t){super.copyFrom(e,t),this.setShaderName(e.getShaderName());for(const t of e.getParameters()){const a=e.getParameter(t.getName());t.getImage||this.__makeParameterTexturable(a);}}destroy(){this.removeAllTextures(),super.destroy();}}class we extends Te{constructor(e){super(),null==e&&(e=this.constructor.name),this.__name=e,this.format="RGBA",this.type="UNSIGNED_BYTE",this.__loaded=!1,this.width=1,this.height=1;}isLoaded(){return this.__loaded}getName(){return this.__name}isStream(){return !1}setData(e,t,a){this.width=e,this.height=t,this.__data=a,this.__loaded?this.updated.emit():(this.__loaded=!0,this.loaded.emit());}getParams(){const e=super.getParams();return e.data=this.__data,e}}function ze(e){this.data=e,this.pos=0;}function Ue(e){this.stream=new ze(e),this.output={};}C.registerClass("DataImage2D",we),C.registerClass("DataImage",we),ze.prototype.readByte=function(){return this.data[this.pos++]},ze.prototype.peekByte=function(){return this.data[this.pos]},ze.prototype.readBytes=function(e){for(var t=new Array(e),a=0;a<e;a++)t[a]=this.readByte();return t},ze.prototype.peekBytes=function(e){for(var t=new Array(e),a=0;a<e;a++)t[a]=this.data[this.pos+a];return t},ze.prototype.readString=function(e){for(var t="",a=0;a<e;a++)t+=String.fromCharCode(this.readByte());return t},ze.prototype.readBitArray=function(){for(var e=[],t=this.readByte(),a=7;a>=0;a--)e.push(!!(t&1<<a));return e},ze.prototype.readUnsigned=function(e){var t=this.readBytes(2);return e?(t[1]<<8)+t[0]:(t[0]<<8)+t[1]},Ue.prototype.parse=function(e){return this.parseParts(this.output,e),this.output},Ue.prototype.parseParts=function(e,t){for(var a=0;a<t.length;a++){var i=t[a];this.parsePart(e,i);}},Ue.prototype.parsePart=function(e,t){var a,i=t.label;if(!t.requires||t.requires(this.stream,this.output,e))if(t.loop){for(var s=[];t.loop(this.stream);){var n={};this.parseParts(n,t.parts),s.push(n);}e[i]=s;}else t.parts?(a={},this.parseParts(a,t.parts),e[i]=a):t.parser?(a=t.parser(this.stream,this.output,e),t.skip||(e[i]=a)):t.bits&&(e[i]=this.parseBits(t.bits));},Ue.prototype.parseBits=function(e){var t={},a=this.stream.readBitArray();for(var i in e){var s=e[i];s.length?t[i]=a.slice(s.index,s.index+s.length).reduce((function(e,t){return 2*e+t}),0):t[i]=a[s.index];}return t};var Je=function(){return function(e){return e.readByte()}},Pe=function(e){return function(t){return t.readBytes(e)}},Ee=function(e){return function(t){return t.readString(e)}},He=function(e){return function(t){return t.readUnsigned(e)}},ke=function(e,t){return function(a,i,s){for(var n=t(a,i,s),l=new Array(n),r=0;r<n;r++)l[r]=a.readBytes(e);return l}},Be={label:"blocks",parser:function(e){for(var t=[],a=e.readByte();0!==a;a=e.readByte())t=t.concat(e.readBytes(a));return t}},De={label:"gce",requires:function(e){var t=e.peekBytes(2);return 33===t[0]&&249===t[1]},parts:[{label:"codes",parser:Pe(2),skip:!0},{label:"byteSize",parser:Je()},{label:"extras",bits:{future:{index:0,length:3},disposal:{index:3,length:3},userInput:{index:6},transparentColorGiven:{index:7}}},{label:"delay",parser:He(!0)},{label:"transparentColorIndex",parser:Je()},{label:"terminator",parser:Je(),skip:!0}]},Oe={label:"image",requires:function(e){return 44===e.peekByte()},parts:[{label:"code",parser:Je(),skip:!0},{label:"descriptor",parts:[{label:"left",parser:He(!0)},{label:"top",parser:He(!0)},{label:"width",parser:He(!0)},{label:"height",parser:He(!0)},{label:"lct",bits:{exists:{index:0},interlaced:{index:1},sort:{index:2},future:{index:3,length:2},size:{index:5,length:3}}}]},{label:"lct",requires:function(e,t,a){return a.descriptor.lct.exists},parser:ke(3,(function(e,t,a){return Math.pow(2,a.descriptor.lct.size+1)}))},{label:"data",parts:[{label:"minCodeSize",parser:Je()},Be]}]},Qe={label:"text",requires:function(e){var t=e.peekBytes(2);return 33===t[0]&&1===t[1]},parts:[{label:"codes",parser:Pe(2),skip:!0},{label:"blockSize",parser:Je()},{label:"preData",parser:function(e,t,a){return e.readBytes(a.text.blockSize)}},Be]},Ae={label:"frames",parts:[De,{label:"application",requires:function(e,t,a){var i=e.peekBytes(2);return 33===i[0]&&255===i[1]},parts:[{label:"codes",parser:Pe(2),skip:!0},{label:"blockSize",parser:Je()},{label:"id",parser:function(e,t,a){return e.readString(a.blockSize)}},Be]},{label:"comment",requires:function(e,t,a){var i=e.peekBytes(2);return 33===i[0]&&254===i[1]},parts:[{label:"codes",parser:Pe(2),skip:!0},Be]},Oe,Qe],loop:function(e){var t=e.peekByte();return 33===t||44===t}},je=[{label:"header",parts:[{label:"signature",parser:Ee(3)},{label:"version",parser:Ee(3)}]},{label:"lsd",parts:[{label:"width",parser:He(!0)},{label:"height",parser:He(!0)},{label:"gct",bits:{exists:{index:0},resolution:{index:1,length:3},sort:{index:4},size:{index:5,length:3}}},{label:"backgroundColorIndex",parser:Je()},{label:"pixelAspectRatio",parser:Je()}]},{label:"gct",requires:function(e,t){return t.lsd.gct.exists},parser:ke(3,(function(e,t){return Math.pow(2,t.lsd.gct.size+1)}))},Ae];function qe(e){var t=new Ue(new Uint8Array(e));this.raw=t.parse(je),this.raw.hasImages=!1;for(var a=0;a<this.raw.frames.length;a++)if(this.raw.frames[a].image){this.raw.hasImages=!0;break}}qe.prototype.decompressFrame=function(e,t){if(e>=this.raw.frames.length)return null;var a=this.raw.frames[e];if(a.image){var i=a.image.descriptor.width*a.image.descriptor.height,s=function(e,t,a){var i,s,n,l,r,o,d,h,c,m,u,b,p,g,_,Z,G=a,X=new Array(a),y=new Array(4096),f=new Array(4096),V=new Array(4097);for(r=(s=1<<(b=e))+1,i=s+2,d=-1,n=(1<<(l=b+1))-1,c=0;c<s;c++)y[c]=0,f[c]=c;for(u=h=p=g=Z=_=0,m=0;m<G;){if(0===g){if(h<l){u+=t[_]<<h,h+=8,_++;continue}if(c=u&n,u>>=l,h-=l,c>i||c==r)break;if(c==s){n=(1<<(l=b+1))-1,i=s+2,d=-1;continue}if(-1==d){V[g++]=f[c],d=c,p=c;continue}for(o=c,c==i&&(V[g++]=p,c=d);c>s;)V[g++]=f[c],c=y[c];p=255&f[c],V[g++]=p,i<4096&&(y[i]=d,f[i]=p,0==(++i&n)&&i<4096&&(l++,n+=i)),d=o;}g--,X[Z++]=V[g],m++;}for(m=Z;m<G;m++)X[m]=0;return X}(a.image.data.minCodeSize,a.image.data.blocks,i);a.image.descriptor.lct.interlaced&&(s=function(e,t){for(var a=new Array(e.length),i=e.length/t,s=function(i,s){var n=e.slice(s*t,(s+1)*t);a.splice.apply(a,[i*t,t].concat(n));},n=[0,4,2,1],l=[8,8,4,2],r=0,o=0;o<4;o++)for(var d=n[o];d<i;d+=l[o])s(d,r),r++;return a}(s,a.image.descriptor.width));var n={pixels:s,dims:{top:a.image.descriptor.top,left:a.image.descriptor.left,width:a.image.descriptor.width,height:a.image.descriptor.height}};return a.image.descriptor.lct&&a.image.descriptor.lct.exists?n.colorTable=a.image.lct:n.colorTable=this.raw.gct,a.gce&&(n.delay=10*(a.gce.delay||10),n.disposalType=a.gce.extras.disposal,a.gce.extras.transparentColorGiven&&(n.transparentIndex=a.gce.transparentColorIndex)),t&&(n.patch=function(e){for(var t=e.pixels.length,a=new Uint8ClampedArray(4*t),i=0;i<t;i++){var s=4*i,n=e.pixels[i],l=e.colorTable[n];a[s]=l[0],a[s+1]=l[1],a[s+2]=l[2],a[s+3]=n!==e.transparentIndex?255:0;}return a}(n)),n}return null},qe.prototype.decompressFrames=function(e){for(var t=[],a=0;a<this.raw.frames.length;a++){this.raw.frames[a].image&&t.push(this.decompressFrame(a,e));}return t};const $e={},et={},tt=-1!==navigator.userAgent.indexOf("Chrome");class it extends Te{constructor(e,t="",a={}){t.constructor==Object&&(a=t),null!=e&&-1!=e.lastIndexOf(".")&&(console.warn("Deprecated signature. Please provide a name and filepath to the image constructor"),e=e.substring(e.lastIndexOf("/")+1,e.lastIndexOf("."))),super(e,a),this.__loaded=!1;const i=this.addParameter(new Re("FilePath"));i.valueChanged.connect(()=>{if(this.loaded.untoggle(),this.getName()==C.getClassName(this)){const e=i.getStem(),t=e.substring(e.length-1);isNaN(t)?this.setName(e):this.setName(e.substring(0,e.length-1));}const e=i.getFileDesc();e&&this.__loadData(e);}),t&&""!=t&&i.setFilepath(t);}static __imageDataLibrary(){return $e}static registerLoader(e,t){et[e]=t;}static constructLoader(e,t){for(const a of et)if(new RegExp("\\.("+a+")$","i").test(e.name)){const i=new et[a](t);if(i)return i.getParameter("FilePath").setValue(e.id),i}}__loadData(e){const t=this.getParameter("FilePath").getExt();if(".jpg"==t||".png"==t||".webp"==t)this.__loadLDRImage(e,t);else if(".mp4"==t||".ogg"==t)this.__loadLDRVideo(e);else if(".vlh"==t)this.__loadVLH(e);else if(".gif"==t)this.__loadGIF(e);else {if(".svg"!=t)throw new Error("Unsupported file type. Check the ext:"+e);console.warn("SVG Image not yet supported");}}__loadLDRImage(e,a){let i;".jpg"==a?this.format="RGB":".png"==a&&(this.format="RGBA"),this.type="UNSIGNED_BYTE";const s=()=>{this.getDOMElement=()=>i,this.width=i.width,this.height=i.height,this.__data=i,this.__loaded=!0,this.loaded.emit();};if(e.id in $e)i=$e[e.id],i.complete?s():i.addEventListener("load",s);else {re.addWork(e.id,1);const a=this.addParameter(new ue("PreferredSize",-1));let n=e.url;if(e.assets&&Object.keys(e.assets).length>0){const i={maxSize:t.gpuDesc.maxTextureSize},s=a.getValue();-1==s?e.assets.reduce&&(i.prefSize=e.assets.reduce.w):i.prefSize=s;const l=function(e,t){if(t=t.filter(e=>null!==e),tt){const e=t.filter(e=>"webp"===e.format);e.length>1&&(t=e);}else t=t.filter(e=>"webp"!==e.format);if(e.maxSize&&(t=t.filter(t=>t.w<=e.maxSize)),e.filter){const a=t.filter(t=>-1!==t.url.indexOf(e.filter));a.length>1&&(t=a);}if(e.prefSize&&(t=t.map(t=>Object.assign({score:Math.abs(e.prefSize-t.w)},t))).sort((e,t)=>e.score>t.score?1:e.score<t.score?-1:0),t.length>0)return t[0]}(i,Object.values(e.assets));l&&(console.log("Selected image:"+e.name+" format:"+l.format+" :"+l.w+"x"+l.h+" url:"+l.url),n=l.url);}else console.warn("Images not processed for this file:"+e.name);i=new Image,i.crossOrigin="anonymous",i.src=n,i.addEventListener("load",s),i.addEventListener("load",()=>{re.addWorkDone(e.id,1);}),$e[e.id]=i;}}__removeVideoParams(){this.getParameterIndex("spatializeAudio")&&(this.removeParameter(this.getParameterIndex("Loop")),this.removeParameter(this.getParameterIndex("spatializeAudio")),this.removeParameter(this.getParameterIndex("Gain")),this.removeParameter(this.getParameterIndex("refDistance")),this.removeParameter(this.getParameterIndex("maxDistance")),this.removeParameter(this.getParameterIndex("rolloffFactor")),this.removeParameter(this.getParameterIndex("coneInnerAngle")),this.removeParameter(this.getParameterIndex("coneOuterAngle")),this.removeParameter(this.getParameterIndex("coneOuterGain")));}__loadLDRVideo(e){this.format="RGB",this.type="UNSIGNED_BYTE",re.addWork(e.id,1);const t=this.addParameter(new pe("Mute",!0)),a=this.addParameter(new pe("Loop",!0)),i=document.createElement("video");i.style.display="none",i.preload="auto",i.crossOrigin="anonymous",this.getAudioSource=()=>i,document.body.appendChild(i),i.addEventListener("loadedmetadata",()=>{i.muted=t.getValue(),t.valueChanged.connect(()=>{i.muted=t.getValue();}),i.loop=a.getValue(),a.valueChanged.connect(()=>{i.loop=a.getValue();}),this.width=i.videoHeight,this.height=i.videoWidth,this.__data=i,this.__loaded=!0,re.addWorkDone(e.id,1),this.loaded.emit(i),i.play().then(()=>{let e=0;const t=()=>{if(i.paused||i.ended)return;const a=Math.floor(29.97*i.currentTime);e!=a&&(this.updated.emit(),e=a),setTimeout(t,20);};t();},e=>{console.log("Autoplay was prevented.",e,e.message);});},!1),i.src=e.url;}__loadVLH(e){this.type="FLOAT";let t=new u(1,1,1,1);this.setHDRTint=e=>{t=e;},this.getHDRTint=()=>t,re.loadUrl(e.id,e.url,e=>{let t,a;for(const i in e)i.endsWith(".jpg")?t=e[i]:i.endsWith(".bin")&&(a=e[i]);const i=new Blob([t.buffer]),s=new Image;s.onload=()=>{this.width=s.width,this.height=s.height,this.__data={ldr:s,cdm:a},this.__loaded?this.updated.emit():(this.__loaded=!0,this.loaded.emit());},s.src=URL.createObjectURL(i);});}__loadGIF(e){let t,a,i;this.format="RGBA",this.type="UNSIGNED_BYTE",this.__streamAtlas=!0,this.addParameter(new Ze("StreamAtlasDesc",new h)),this.addParameter(new ue("StreamAtlasIndex",0)),this.getParameter("StreamAtlasIndex").setRange([0,1]),this.getFrameDelay=()=>20,this.play=()=>{i.then(()=>{t=!0,a&&a();});},this.stop=()=>{t=!1;},e.id in $e?i=$e[e.id]:(i=new Promise((t,a)=>{if(re.addWork(e.id,1),e.assets&&e.assets.atlas){const a=new Image;return a.crossOrigin="anonymous",a.src=e.assets.atlas.url,void a.addEventListener("load",()=>{t({width:e.assets.atlas.width,height:e.assets.atlas.height,atlasSize:e.assets.atlas.atlasSize,frameDelays:e.assets.atlas.frameDelays,frameRange:[0,e.assets.atlas.frameDelays.length],imageData:a}),re.addWorkDone(e.id,1);})}ee(e.url,a=>{console.warn("Unpacking Gif client side:"+e.name);const i=performance.now(),s=new qe(a).decompressFrames(!0),n=Math.sqrt(s.length),l=[n,n];Math.fract(n)>0&&(l[0]=Math.floor(l[0]+1),Math.fract(n)>.5?l[1]=Math.floor(l[1]+1):l[1]=Math.floor(l[1]));const r=s[0].dims.width,o=s[0].dims.height,d=document.createElement("canvas"),h=d.getContext("2d"),c=document.createElement("canvas"),m=c.getContext("2d");c.width=r,c.height=o;const u=document.createElement("canvas"),b=u.getContext("2d");let p;u.width=l[0]*r,u.height=l[1]*o;const g=[],_=(e,t)=>{const a=e.dims;g.push(e.delay/10),p&&a.width==p.width&&a.height==p.height||(d.width=a.width,d.height=a.height,p=h.createImageData(a.width,a.height)),p.data.set(e.patch),h.putImageData(p,0,0),2==e.disposalType&&m.clearRect(0,0,c.width,c.height),m.drawImage(d,a.left,a.top),b.drawImage(c,t%l[0]*r,Math.floor(t/l[0])*o);};for(let e=0;e<s.length;e++)_(s[e],e);re.addWorkDone(e.id,1);const Z=b.getImageData(0,0,u.width,u.height),G=performance.now()-i;console.log(`Decode GIF '${e.name}' time:`+G),t({width:u.width,height:u.height,atlasSize:l,frameRange:[0,s.length],frameDelays:g,imageData:Z});},t=>{console.warn("Unable to Load URL:"+t+":"+e.url),a();});}),$e[e.id]=i),i.then(e=>{this.width=e.width,this.height=e.height,this.getParameter("StreamAtlasDesc").setValue(new h(e.atlasSize[0],e.atlasSize[1],0,0)),this.getParameter("StreamAtlasIndex").setRange(e.frameRange),this.__data=e.imageData,this.getFrameDelay=t=>10*e.frameDelays[t];const i=this.getParameter("StreamAtlasIndex"),s=i.getRange()[1];let n=0;a=()=>{i.setValue(n),t&&setTimeout(a,this.getFrameDelay(n)),n=(n+1)%s;},t&&a(),this.__loaded=!0,this.loaded.emit();});}getFilepath(){return this.getParameter("FilePath").getValue()}isStream(){return !1}isLoaded(){return this.__loaded}getParams(){const e=super.getParams();return this.__loaded&&(e.data=this.__data),e}toJSON(e,t){}fromJSON(e,t,a){}readBinary(e,t){this.setName(e.loadStr());let a=e.loadStr();if("string"==typeof a&&""!=a){if(t.lod>=0){const e=a.lastIndexOf(".");if(-1!=e){const i=a.substring(0,e)+t.lod+a.substring(e);re.resolveFilepath(i)&&(a=i);}}this.getParameter("FilePath").setFilepath(a);}}}class st extends it{constructor(e,t={}){console.warn("FileImage2D is becoming deprecated in favor of simple FileImage"),super(e,t);}}C.registerClass("FileImage2D",it),C.registerClass("FileImage",it);const nt=-1!==navigator.userAgent.indexOf("Chrome");class lt extends it{constructor(e,t,a){super(e,t,a),this.type="UNSIGNED_BYTE",this.addParameter(new ue("PreferredSize",-1)),this.__crossOrigin="anonymous";}setCrossOrigin(e){this.__crossOrigin=e;}__loadData(e){".png"==this.getParameter("FilePath").getExt()&&(this.format="RGBA");let a=e.url;if(e.assets&&Object.keys(e.assets).length>0){const i={maxSize:t.gpuDesc.maxTextureSize},s=this.getParameter("PreferredSize").getValue();-1==s?e.assets.reduce&&(i.prefSize=e.assets.reduce.w):i.prefSize=s;const n=function(e,t){if(t=t.filter(e=>null!==e),nt){const e=t.filter(e=>"webp"===e.format);e.length>1&&(t=e);}else t=t.filter(e=>"webp"!==e.format);if(e.maxSize&&(t=t.filter(t=>t.w<=e.maxSize)),e.filter){const a=t.filter(t=>-1!==t.url.indexOf(e.filter));a.length>1&&(t=a);}if(e.prefSize&&(t=t.map(t=>Object.assign({score:Math.abs(e.prefSize-t.w)},t))).sort((e,t)=>e.score>t.score?1:e.score<t.score?-1:0),t.length>0)return t[0]}(i,Object.values(e.assets));n&&(console.log("Selected image:"+e.name+" format:"+n.format+" :"+n.w+"x"+n.h+" url:"+n.url),a=n.url);}else console.warn("Images not processed for this file:"+e.name);this.setImageURL(a,"RGB");}setImageURL(e,t="RGB"){if(!t){const a=e.lastIndexOf(".");if(-1!=a){".png"==e.substring(a).toLowerCase()&&(t="RGBA");}}let a;this.format=t,this.__loaded=!1;const i=()=>{this.getDOMElement=()=>a,this.width=a.width,this.height=a.height,this.__data=a,this.__loaded=!0,this.loaded.emit();},s=it.__imageDataLibrary();e in s?(a=s[e],a.complete?i():a.addEventListener("load",i)):(a=new Image,a.crossOrigin=this.__crossOrigin,a.src=e,a.addEventListener("load",i),s[e]=a);}}it.registerLoader("jpg|jpeg|png",lt),C.registerClass("LDRImage",lt);class rt extends it{constructor(e,t,a){super(e,t,a),this.format="RGB",this.type="UNSIGNED_BYTE",this.addParameter(new pe("Mute",!1)),this.addParameter(new pe("Loop",!0)),this.addParameter(new ue("Gain",2)).setRange([0,5]),this.addParameter(new pe("SpatializeAudio",!0)),this.addParameter(new ue("refDistance",2)),this.addParameter(new ue("maxDistance",1e4)),this.addParameter(new ue("rolloffFactor",1)),this.addParameter(new ue("coneInnerAngle",360)),this.addParameter(new ue("coneOuterAngle",0)),this.addParameter(new ue("coneOuterGain",1));}__loadData(e){re.addWork(e.id,1);const t=document.createElement("video");t.style.display="none",t.preload="auto",t.crossOrigin="anonymous",this.getAudioSource=()=>t,document.body.appendChild(t),t.addEventListener("loadedmetadata",()=>{const a=this.getParameter("Mute");t.muted=a.getValue(),a.valueChanged.connect(()=>{t.muted=a.getValue();});const i=this.getParameter("Loop");t.loop=i.getValue(),i.valueChanged.connect(()=>{t.loop=i.getValue();}),this.width=t.videoHeight,this.height=t.videoWidth,this.__data=t,this.__loaded=!0,re.addWorkDone(e.id,1),this.loaded.emit(t);let s=0;const n=()=>{if(t.paused||t.ended)return;const e=Math.floor(29.97*t.currentTime);s!=e&&(this.updated.emit(),s=e),setTimeout(n,20);};n();},!1),t.src=e.url;const a=t.play();void 0!==a&&a.then(e=>{console.log("Autoplay started!");}).catch(()=>{console.log("Autoplay was prevented.");});}}it.registerLoader("mp4|ogg",rt),C.registerClass("LDRVideo",rt);class ot extends it{constructor(e,t="",a={}){super(e,t,a),this.format="RGBA",this.type="UNSIGNED_BYTE",this.__streamAtlas=!0,this.getParameter("FilePath").setSupportedExts("gif"),this.addParameter(new Ze("StreamAtlasDesc")),this.addParameter(new ue("StreamAtlasIndex",0));const i=this.getParameter("StreamAtlasIndex");let s;i.setRange([0,1]);let n=0;const l=e=>{i.setValue(n),s&&setTimeout(()=>l(e),this.getFrameDelay(n)),n=(n+1)%e;};this.play=()=>{this.__resourcePromise.then(()=>{s=!0;const e=i.getRange()[1];l(e);});},this.stop=()=>{s=!1;};}getFrameDelay(e){return 10*this.__unpackedData.frameDelays[e]}__loadData(e){const t=it.__imageDataLibrary();e.id in t?this.__resourcePromise=t[e.id]:(this.__resourcePromise=new Promise((t,a)=>{if(re.addWork(e.id,1),e.assets&&e.assets.atlas){const a=new Image;return a.crossOrigin="anonymous",a.src=e.assets.atlas.url,void a.addEventListener("load",()=>{t({width:e.assets.atlas.width,height:e.assets.atlas.height,atlasSize:e.assets.atlas.atlasSize,frameDelays:e.assets.atlas.frameDelays,frameRange:[0,e.assets.atlas.frameDelays.length],imageData:a}),re.addWorkDone(e.id,1);})}ee(e.url,a=>{console.warn("Unpacking Gif client side:"+e.name);const i=performance.now(),s=new qe(a).decompressFrames(!0),n=Math.sqrt(s.length),l=[n,n];Math.fract(n)>0&&(l[0]=Math.floor(l[0]+1),Math.fract(n)>.5?l[1]=Math.floor(l[1]+1):l[1]=Math.floor(l[1]));const r=s[0].dims.width,o=s[0].dims.height,d=document.createElement("canvas"),h=d.getContext("2d"),c=document.createElement("canvas"),m=c.getContext("2d");c.width=r,c.height=o;const u=document.createElement("canvas"),b=u.getContext("2d");let p;u.width=l[0]*r,u.height=l[1]*o;const g=[],_=(e,t)=>{const a=e.dims;g.push(e.delay/10),p&&a.width==p.width&&a.height==p.height||(d.width=a.width,d.height=a.height,p=h.createImageData(a.width,a.height)),p.data.set(e.patch),h.putImageData(p,0,0),2==e.disposalType&&m.clearRect(0,0,c.width,c.height),m.drawImage(d,a.left,a.top),b.drawImage(c,t%l[0]*r,Math.floor(t/l[0])*o);};for(let e=0;e<s.length;e++)_(s[e],e);re.addWorkDone(e.id,1);const Z=b.getImageData(0,0,u.width,u.height),G=performance.now()-i;console.log(`Decode GIF '${e.name}' time:`+G),t({width:u.width,height:u.height,atlasSize:l,frameRange:[0,s.length],frameDelays:g,imageData:Z});},t=>{console.warn("Unable to Load URL:"+t+":"+e.url),a();});}),t[e.id]=this.__resourcePromise),this.__resourcePromise.then(e=>{this.width=e.width,this.height=e.height,this.getParameter("StreamAtlasDesc").setValue(new h(e.atlasSize[0],e.atlasSize[1],0,0)),this.getParameter("StreamAtlasIndex").setRange(e.frameRange),this.__unpackedData=e,this.__data=e.imageData,this.__loaded=!0,this.loaded.emit();});}}it.registerLoader("gif",ot),C.registerClass("GIFImage",ot);class dt extends Te{constructor(e,t={}){let a;null!=e&&-1!=e.lastIndexOf(".")&&(a=e,e=e.substring(e.lastIndexOf("/")+1,e.lastIndexOf("."))),super(e,t),this.__loaded=!1,this.__exposure=1,this.__ambientLightFactor=0,this.__hdrtint=new u(1,1,1,1),this.__stream="stream"in t&&t.stream,this.type="FLOAT";const i=this.addParameter(new Re("FilePath"));i.valueChanged.connect(()=>{if(this.loaded.untoggle(),this.getName()==C.getClassName(this)){const e=i.getStem(),t=e.substring(e.length-1);isNaN(t)?this.setName(e):this.setName(e.substring(0,e.length-1));}const e=i.getValue(),t=i.getFile();this.__loadVLH(e,t);}),a&&this.getParameter("FilePath").setFilepath(a);}getDOMElement(){return this.__domElement}getResourcePath(){return this.getParameter("FilePath").getValue()}__decodeData(e){const t=e.ldr,a=e.cdm,i=new Blob([t.buffer]),s=new Image;s.onload=()=>{this.width=s.width,this.height=s.height,this.__data={ldr:s,cdm:a},this.__loaded?this.updated.emit():(this.__loaded=!0,this.loaded.emit());},s.src=URL.createObjectURL(i);}__loadVLH(e,t){this.type="FLOAT",re.loadUrl(e,t.url,e=>{if(!e.ldr||!e.cdm)for(const t in e)t.endsWith(".jpg")?(e.ldr=e[t],delete e[t]):t.endsWith(".bin")&&(e.cdm=e[t],delete e[t]);this.__decodeData(e);});}isStream(){return !1}isLoaded(){return this.__loaded}getParams(){const e=super.getParams();return this.__loaded&&(e.data=this.__data,e.exposure=this.__exposure),e}setHDRTint(e){this.__hdrtint=e;}getHDRTint(){return this.__hdrtint}toJSON(e,t){}fromJSON(e,t,a){}readBinary(e,t){this.setName(e.loadStr());const a=e.loadStr();if("string"==typeof a&&""!=a){if(t.lod>=0){const e=a.lastIndexOf(".");if(-1!=e){const i=a.substring(0,e)+t.lod+a.substring(e);re.resourceAvailable(i)&&(a=i);}}this.getParameter("FilePath").setValue(a);}}}C.registerClass("VLHImage",dt);const ht=1,ct=2,mt=(e,t)=>t<e?0:1;function ut(e){return e.dot(new o(1,1))}function bt(e){return new o(Math.abs(e.x),Math.abs(e.y))}function pt(e,t){return new o(Math.max(e.x,t),Math.max(e.y,t))}function gt(e){const t=function(e){return new d(Math.abs(e.x),Math.abs(e.y),Math.abs(e.z))}(e),a=function(e){return new d(2*mt(0,e.x)-1,2*mt(0,e.y)-1,2*mt(0,e.z)-1)}(e),i=new o(t.x,t.y);let s=pt(i,1e-20);const n=Math.atan2(s.x,s.y)/Math.HALF_PI;s=pt(new o(t.z,i.length()),1e-20);const l=Math.atan2(s.y,s.x)/Math.HALF_PI;let r=new o(a.x*n,a.y*(1-n));if(r.scaleInPlace(l),e.z<0){const e=new o(r.y,r.x),t=new o(a.x,a.y);r=t.subtract(bt(e).multiply(t));}return r.scale(.5).add(new o(.5,.5))}function _t(e){const t=function(e){return new o(2*mt(0,e.x)-1,2*mt(0,e.y)-1)}(e=e.scale(2).subtract(new o(1,1))),a=ut(bt(e)),i=a*Math.PI*.5;if(i<=0)return new d(0,0,1);if(Math.abs(i-Math.PI)<1e-6)return new d(0,0,-1);if(a>1){e=bt(o(e.y,e.x)).negate().add(new o(1,1)).multiply(t),a=ut(bt(e));}const s=Math.abs(e.x)/a*Math.HALF_PI,n=Math.sin(s),l=Math.cos(s),r=Math.sin(i),h=Math.cos(i);return new d(n*t.x*r,l*t.y*r,h)}class Zt extends dt{constructor(e,t={}){super(e,t),this.mapping=ct;}__decodeData(e){super.__decodeData(e);const t=e.samples;t&&(window.TextDecoder?this.__sampleSets=JSON.parse(new TextDecoder("utf-8").decode(t)):this.__sampleSets=JSON.parse(v(t)),this.__sampleSets.luminanceThumbnail&&(this.__thumbSize=Math.sqrt(this.__sampleSets.luminanceThumbnail.length)));}getSampleSets(){return this.__sampleSets}uvToDir(e){switch(this.mapping){case ht:return function(e,t){const a=Math.PI*(2*e-1),i=Math.PI*t;return new d(sin(i)*sin(a),-sin(i)*cos(a),cos(i))}(e);case ct:return _t(e)}}dirToUv(e){switch(this.mapping){case ht:return function(e){const t=Math.acos(e.z),a=Math.atan2(e.x,-e.y);return new o((1+a/Math.PI)/2,t/Math.PI)}(e);case ct:return gt(e)}}uvToLuminance(e){const t=Math.floor(e.y*this.__thumbSize)*this.__thumbSize+Math.floor(e.x*this.__thumbSize);return this.__sampleSets.luminanceThumbnail[t]}dirToLuminance(e){return this.uvToLuminance(this.dirToUv(e))}}C.registerClass("EnvMap",Zt);class Gt extends T{constructor(e,t,a,i){super(),this.atlasSize=a,this.image=new dt("Lightmap",{stream:i}),this.image.getParameter("FilePath").setFilepath(e),this.image.setHDRTint(t.getParameter("LightmapTint").getValue()),this.__stream=i;}get width(){return this.atlasSize[0]}get height(){return this.atlasSize[1]}isStream(){return this.__stream}loadResource(e){this.image.loadResource(e);}fromJSON(e){this.__atlasSize=e.atlasSize;}}class Xt extends T{constructor(e){super(),this.atlasSize=e,this.__images=[],this.__weights=[],this.__stream=!1,this.lightmapAdded=new S,this.lightmapResourceChanged=new S,this.lightmapWeightChanged=new S;}get width(){return this.atlasSize[0]}get height(){return this.atlasSize[1]}isStream(){return this.__stream}loadResource(e,t,a,i=!1){this.__images[e]?(this.__images[e].loadResource(t),this.lightmapResourceChanged.emit(e,a),a&&(this.__weights[e]=a,this.lightmapWeightChanged.emit(e,a))):(this.__images[e]=new FileImage(t,{stream:i}),this.__weights[e]=a||1,this.lightmapAdded.emit(e)),this.__stream|=i;}setWeight(e,t){this.__weights[e]=t,this.lightmapWeightChanged.emit(e,t);}numSubImages(){return this.__images.length}getSubImage(e){return this.__images[e]}getSubImageWeight(e){return this.__weights[e]}fromJSON(e){this.__atlasSize=e.atlasSize;}}const yt=new class{constructor(){this.__labelLibraries={},this.labelLibraryLoaded=new S;const e=function(){const e=window.navigator,t=["language","browserLanguage","systemLanguage","userLanguage"];let a,i;if(Array.isArray(e.languages))for(a=0;a<e.languages.length;a++)if(i=e.languages[a],i&&i.length)return i;for(a=0;a<t.length;a++)if(i=e[t[a]],i&&i.length)return i;return null}();e.startsWith("en")?this.__language="En":e.startsWith("es")?this.__language="Es":e.startsWith("fr")?this.__language="Fr":(e.startsWith("gb")||e.startsWith("de"))&&(this.__language="Gb"),this.__foundLabelLibraries={},re.registerResourceCallback(".labels",e=>{const t=e.name.split(".")[0];this.__foundLabelLibraries[t]=e,A(e.url,e=>{this.__labelLibraries[t]=JSON.parse(e),this.labelLibraryLoaded.emit(t);});}),window.XLSX&&re.registerResourceCallback(".xlsx",e=>{const t=e.name.split(".")[0];this.__foundLabelLibraries[t]=e,ee(e.url,e=>{const a=new Uint8Array(e),i=XLSX.read(a,{type:"array"}),s={};i.SheetNames.forEach((function(e){XLSX.utils.sheet_to_row_object_array(i.Sheets[e]).forEach((function(e){const t=e.Identifier;delete e.Identifier,s[t]=e;}));})),this.__labelLibraries[t]=s,this.labelLibraryLoaded.emit(t);});});}isLibraryFound(e){return e in this.__foundLabelLibraries}isLibraryLoaded(e){return e in this.__labelLibraries}getLabelText(e,t){const a=this.__labelLibraries[e];if(!a)throw new Error("LabelLibrary: '"+e+"' not found in LabelManager. Found: ["+Object.keys(this.__labelLibraries)+"]");const i=a[t];if(!i)throw new Error("Label: '"+t+"' not found in LabelLibrary: '"+e+"'. Found: ["+Object.keys(a)+"]");const s=i[this.__language];if(!s){if(i.En)return i.En;throw new Error("labelText: '"+language+"' not found in Label. Found: ["+Object.keys(i)+"]")}return s}setLabelText(e,t,a){let i=this.__labelLibraries[e];i||(i={},this.__labelLibraries[e]=i);let s=i[t];s||(s={},i[t]=s),s[this.__language]=a;}setLanguage(e){this.__language=e;}};class ft extends we{constructor(e,t){super(e),this.__canvasElem=document.createElement("canvas");const a=this.addParameter(new xe("library"));this.addParameter(new xe("text","")),this.addParameter(new Ge("fontColor",new u(0,0,0))),this.addParameter(new ue("margin",11)),this.addParameter(new ue("borderWidth",2)),this.addParameter(new ue("borderRadius",11)),this.addParameter(new pe("outline",!1)),this.addParameter(new pe("outlineColor",new u(0,0,0))),this.addParameter(new pe("background",!0)),this.addParameter(new Ge("backgroundColor",new u("#FBC02D"))),this.addParameter(new pe("fillBackground",!0)),this.addParameter(new pe("strokeBackgroundOutline",!0)),this.addParameter(new ue("fontSize",22)),this.addParameter(new xe("font","Helvetica"));this.nameChanged.connect(()=>{this.loadLabelData();}),t&&a.setValue(t),this.__requestedRerender=!1,this.__needsRender=!1,this.labelRendered=new S,this.loadLabelData();}__parameterValueChanged(e,t){this.__requestedRerender||(this.__requestedRerender=!0,this.loadLabelData());}loadLabelData(){Promise.all([(()=>new Promise(e=>{const t=this.getParameter("library").getValue();if(""==t)return void e();if(!yt.isLibraryFound(t))return console.warn("Label Libary not found:",t),void e();const a=()=>{try{const e=this.getName(),a=yt.getLabelText(t,e);this.getParameter("text").setValue(a);}catch(e){console.warn(e);}e();};yt.isLibraryLoaded(t)?a():yt.labelLibraryLoaded.connect(e=>{e==t&&a();});}))(),(()=>new Promise(e=>{if(null!=document.fonts){const t=this.getParameter("font").getValue(),a=this.getParameter("fontSize").getValue();document.fonts.load(a+'px "'+t+'"').then(()=>{e();});}else e();}))()]).then(()=>{this.__requestedRerender=!1,this.__needsRender=!0,this.__loaded?this.updated.emit():(this.__loaded=!0,this.loaded.emit());});}renderLabelToImage(){const e=this.__canvasElem.getContext("2d",{alpha:!0});let t=this.getParameter("text").getValue();""==t&&(t=this.getName());const a=this.getParameter("font").getValue(),i=this.getParameter("fontColor").getValue(),s=this.getParameter("fontSize").getValue(),n=this.getParameter("margin").getValue(),l=this.getParameter("borderWidth").getValue(),r=this.getParameter("borderRadius").getValue(),o=this.getParameter("outline").getValue(),d=this.getParameter("outlineColor").getValue(),h=this.getParameter("background").getValue(),c=this.getParameter("backgroundColor").getValue(),m=this.getParameter("fillBackground").getValue(),u=this.getParameter("strokeBackgroundOutline").getValue(),b=n+l,p=t.split("\n");e.font=s+'px "'+a+'"';let g=0;p.forEach(t=>{g=Math.max(e.measureText(t).width,g);});const _=s;this.width=Math.ceil(g+2*b),this.height=Math.ceil(_*p.length+2*b),e.canvas.width=this.width,e.canvas.height=this.height,this.__canvasElem.width=this.width,this.__canvasElem.height=this.height,e.fillStyle="rgba(0, 0, 0, 0.0)",e.fillRect(0,0,this.width,this.height),h&&(e.fillStyle=c.toHex(),e.strokeStyle=d.toHex(),function(e,t,a,i,s,n,l,r,o){if(void 0===r&&(r=!0),void 0===n&&(n=5),"number"==typeof n)n={tl:n,tr:n,br:n,bl:n};else {const e={tl:0,tr:0,br:0,bl:0};for(const t in e)n[t]=n[t]||e[t];}e.beginPath(),e.moveTo(t+n.tl,a),e.lineTo(t+i-n.tr,a),e.quadraticCurveTo(t+i,a,t+i,a+n.tr),e.lineTo(t+i,a+s-n.br),e.quadraticCurveTo(t+i,a+s,t+i-n.br,a+s),e.lineTo(t+n.bl,a+s),e.quadraticCurveTo(t,a+s,t,a+s-n.bl),e.lineTo(t,a+n.tl),e.quadraticCurveTo(t,a,t+n.tl,a),e.closePath(),l&&e.fill(),r&&(e.lineWidth=o,e.stroke());}(e,l,l,this.width-2*l,this.height-2*l,r,m,u,l)),e.font=s+'px "'+a+'"',e.textAlign="left",e.fillStyle=i.toHex(),e.textBaseline="hanging",p.forEach((t,a)=>{e.fillText(t,b,b+a*_);}),o&&(e.strokeStyle=d.toHex(),e.lineWidth=1.5,e.strokeText(t,b,b)),this.__data=e.getImageData(0,0,this.width,this.height),this.__needsRender=!1,this.labelRendered.emit({width:this.width,height:this.height,data:this.__data});}getParams(){return this.__needsRender&&this.renderLabelToImage(),super.getParams()}toJSON(e,t){return super.toJSON(e,t)}fromJSON(e,t,a){super.fromJSON(e,t,a),this.__getLabelText();}}C.registerClass("Label",ft);class Vt extends Te{constructor(){super(),this.__loaded=!1;}connectWebcam(e,t,a=!1){const i={width:e,height:t,frameRate:{ideal:60,max:60}};i.facingMode=a?{exact:"environment"}:{facingMode:"user"};const s=document.createElement("video");s.style.display="none",s.preload="auto",s.crossOrigin="anonymous",document.body.appendChild(s),navigator.mediaDevices.getUserMedia({audio:!1,video:i}).then(e=>{s.srcObject=e,s.onloadedmetadata=e=>{s.play(),this.width=s.videoWidth,this.height=s.videoHeight,console.log("Webcam:["+this.width+", "+this.height+"]"),this.__data=s,this.__loaded=!0,this.loaded.emit(s);let t=0;const a=()=>{if(s.paused||s.ended)return;const e=Math.floor(60*s.currentTime);t!=e&&(this.updated.emit(),t=e),setTimeout(a,20);};a();};}).catch((function(e){}));}setVideoStream(e){this.__loaded=!1,this.width=e.videoWidth,this.height=e.videoHeight,this.start(),this.__data=e,this.__loaded=!0,this.loaded.emit(e);}stop(){clearInterval(this.__intervalId);}start(){this.__intervalId=setInterval(()=>{this.updated.emit();},20);}isLoaded(){return this.__loaded}getParams(){return {type:this.type,format:this.format,width:this.width,height:this.height,data:this.__data,flipY:this.getParameter("FlipY").getValue()}}}C.registerClass("VideoStreamImage2D",Vt);class xt{constructor(e="MaterialLibrary"){this.__name=e,this.lod=0,t.isMobileDevice&&(this.lod=1),this.loaded=new S,this.clear();}clear(){this.__images={},this.__materials={Default:new Ke("Default","SimpleSurfaceShader")};}getPath(){return [this.__name]}getNumMaterials(){return Object.keys(this.__materials).length}getMaterials(){return Object.values(this.__materials)}getMaterialNames(){const e=[];for(const t in this.__materials)e.push(t);return e}hasMaterial(e){return e in this.__materials}addMaterial(e){e.setOwner(this),this.__materials[e.getName()]=e;}getMaterial(e,t=!0){const a=this.__materials[e];if(!a&&t)throw new Error("Material:"+e+" not found in library:"+this.getMaterialNames());return a}hasImage(e){return e in this.__images}addImage(e){e.setOwner(this),this.__images[e.getName()]=e;}getImage(e,t=!0){const a=this.__images[e];if(!a&&t)throw new Error("Image:"+e+" not found in library:"+this.getImageNames());return a}getImageNames(){const e=[];for(const t in this.__images)e.push(t);return e}load(e){const t=new XMLHttpRequest;t.open("GET",e,!0),t.ontimeout=()=>{throw new Error("The request for "+e+" timed out.")},t.onload=()=>{4===t.readyState&&(200===t.status?this.fromJSON(JSON.parse(t.responseText)):console.warn(t.statusText));},t.send(null);}toJSON(e={},t=0){return {numMaterials:this.geoms.length()}}fromJSON(e,t={},a=0){t.lod=this.lod;for(const t in e.textures){new it(t).fromJSON(e.textures[t]),this.__images[t]=texture;}for(const t in e.materials){const a=new Ke(t);a.fromJSON(e.materials[t]),this.addMaterial(a);}}readBinary(e,t={}){this.name=e.loadStr(),t.lod=this.lod,t.materialLibrary=this;const a=e.loadUInt32();for(let i=0;i<a;i++){const a=e.loadStr(),i=C.constructClass(a,void 0);i.readBinary(e,t),this.__images[i.getName()]=i;}const i=e.loadUInt32();if(i>0){const a=e.loadUInt32Array(i);for(let s=0;s<i;s++){const i=new Ke("");e.seek(a[s]),i.readBinary(e,t,this.__images),this.addMaterial(i);}}this.loaded.emit();}toString(){return JSON.stringify(this.toJSON(),null,2)}}const It=new class{constructor(){this.__materialLibraries={},this.materialLibraryLoaded=new S,re.registerResourceCallback(".matlib",e=>{A(e.url,t=>{const a=e.name.split(".")[0],i=JSON.parse(t),s=new xt(a);s.fromJSON(i),this.__materialLibraries[a]=s,this.materialLibraryLoaded.emit(s);});});}getMaterialLibraryNames(){const e=[];for(const t in this.__materialLibraries)e.push(t);return e}hasMaterialLibrary(e){return e in this.__materialLibraries}getMaterialLibrary(e){const t=this.__materialLibraries[e];return t||console.warn("MaterialLibrary:"+e+" not found in MaterialLibraryManager. Found: ["+this.getMaterialLibraryNames()+"]"),t}resolveMaterialFromPath(e){const t=this.getMaterialLibrary(e[0]);if(t)return t.getMaterial(e[1])}};class Rt extends P{constructor(e,t){super(e,t,"Material"),this.valueParameterValueChanged=new S;}setValue(e,t=N.USER_SETVALUE){this.__value!==e&&(this.__value&&this.__value.parameterValueChanged.disconnect(this.valueParameterValueChanged.emit),this.__value=e,this.__value&&this.__value.parameterValueChanged.connect(this.valueParameterValueChanged.emit),t!=N.USER_SETVALUE&&t!=N.REMOTEUSER_SETVALUE||(this.__flags|=K.USER_EDITED),t!=N.OPERATOR_SETVALUE&&this.valueChanged.emit(t));}toJSON(e,t){if(0!=(this.__flags&K.USER_EDITED))return {value:this.__value.getPath()}}fromJSON(e,t,a){if(null==e.value)return void console.warn("Invalid Parameter JSON");const i=e.value,s=It.resolveMaterialFromPath(i);s&&this.setValue(s),this.__flags|=K.USER_EDITED;}clone(e){return new Rt(this.__name,this.__value)}destroy(){this.__value&&this.__value.parameterValueChanged.disconnect(this.valueParameterValueChanged.emit);}}class St{constructor(e,t,a){if(this.__dataType=e,this.normalized=!1,null!=e.numElements)this.__dimension=this.__dataType.numElements();else switch(e){case 6:case 4:case 5:this.__dimension=1;break;default:throw new Error("Invalid data type for attribute:"+e)}var i;this.__defaultElementValue=null!=a?a:Number.MAX_VALUE,(i=t)&&void 0!==i.byteLength?this.__data=t:(this.__data=new Float32Array(t*this.__dimension),this.initRange(0));}resize(e){const t=this.__data.length,a=e*this.__dimension,i=new Float32Array(a);for(let e=0;e<Math.min(this.__data.length,a);e++)i[e]=this.__data[e];this.__data.length<a&&(this.__data=i),this.initRange(t);}initRange(e){for(let t=e;t<this.__data.length;t++)this.__data[t]=this.__defaultElementValue;}getCount(){return this.__data.length/this.__dimension}get length(){return this.__data.length/this.__dimension}get dataType(){return this.__dataType}get data(){return this.__data}set data(e){this.__data=e;}get numElements(){return this.__dimension}getFloat32Value(e){return this.__data[e]}setFloat32Value(e,t){this.__data[e]=t;}getValueRef(e){const t=this.__dimension;if(e>=this.__data.length/t)throw new Error("Invalid vertex index:"+e+". Num Vertices:"+this.__data.length/3);return this.__dataType.createFromFloat32Buffer(this.__data.buffer,e*t)}setValue(e,t){const a=this.__dimension;if(e>=this.__data.length/a)throw new Error("Invalid vertex index:"+e+". Num Vertices:"+this.__data.length/3);this.__dataType.createFromFloat32Buffer(this.__data.buffer,e*a).setFromOther(t);}toJSON(e,t){return {data:Array.from(this.__data),dataType:r.getTypeName(this.__dataType),defaultValue:this.__defaultElementValue,length:this.__data.length/this.__dimension}}fromJSON(e){this.__data=Float32Array.from(e.data);}toString(){return JSON.stringify(this.toJSON(),null,2)}}class Wt extends H{constructor(){super(),this.__boundingBox=new V,this.__boundingBoxDirty=!0,this.__vertexAttributes=new Map,this.__metaData=new Map,this.addVertexAttribute("positions",d,0),this.boundingBoxDirtied=new S,this.geomDataChanged=new S,this.geomDataTopologyChanged=new S;}setDebugName(e){this.__name=e;}addVertexAttribute(e,t,a){let i;var s;return i=(s=a)&&void 0!==s.byteLength?new St(t,a):new St(t,null!=this.vertices?this.vertices.length:0,a),this.__vertexAttributes.set(e,i),i}hasVertexAttribute(e){return this.__vertexAttributes.has(e)}getVertexAttribute(e){return this.__vertexAttributes.get(e)}getVertexAttributes(e){const t={};for(const[e,a]of this.__vertexAttributes.entries())t[e]=a;return t}get vertices(){return this.__vertexAttributes.get("positions")}numVertices(){return this.vertices.length}getNumVertices(){return this.vertices.length}setNumVertices(e){this.__vertexAttributes.forEach(t=>t.resize(e));}getVertex(e){return d.createFromFloat32Buffer(this.vertices.data.buffer,3*e)}setVertex(e,t){return d.createFromFloat32Buffer(this.vertices.data.buffer,3*e).setFromOther(t)}moveVertices(e){const t=this.vertices;for(let a=0;a<t.length;a++)t.getValueRef(a).addInPlace(e);this.setBoundingBoxDirty();}transformVertices(e){const t=this.vertices;for(let a=0;a<t.length;a++){const i=t.getValueRef(a),s=e.transformVec3(i);i.set(s.x,s.y,s.z);}this.setBoundingBoxDirty();}get boundingBox(){return this.__boundingBoxDirty&&this.updateBoundingBox(),this.__boundingBox}setBoundingBoxDirty(){this.__boundingBoxDirty=!0,this.boundingBoxDirtied.emit();}updateBoundingBox(){const e=this.vertices,t=new V,a=e.length;for(let i=0;i<a;i++)t.addPoint(e.getValueRef(i));this.__boundingBox=t,this.__boundingBoxDirty=!1;}getMetadata(e){return this.__metaData.get(e)}hasMetadata(e){return this.__metaData.has(e)}setMetadata(e,t){this.__metaData.set(e,t);}deleteMetadata(e){this.__metaData.delete(e);}genBuffers(e){const t={};for(const[e,a]of this.__vertexAttributes)t[e]={values:a.data,count:a.size,dataType:a.dataType,normalized:a.normalized};return {numVertices:this.numVertices(),attrBuffers:t}}freeBuffers(){}loadBaseGeomBinary(e){this.name=e.loadStr();const t=e.loadUInt8();this.debugColor=e.loadRGBFloat32Color();const a=e.loadUInt32();this.__boundingBox.set(e.loadFloat32Vec3(),e.loadFloat32Vec3()),this.setNumVertices(a);const i=this.vertices;let s,n;2&t&&(s=this.getVertexAttribute("normals"),s||(s=this.addVertexAttribute("normals",d,0))),4&t&&(n=this.getVertexAttribute("texCoords"),n||(n=this.addVertexAttribute("texCoords",o,0)));const l=(e,t,a,s)=>{for(let n=e[0];n<e[1];n++){const e=new d(s[3*n+0]/255,s[3*n+1]/255,s[3*n+2]/255);e.multiplyInPlace(a),e.addInPlace(t),i.setValue(n,e);}},r=(e,t,a,i)=>{a.isNull()&&a.set(1,1,1);for(let n=e[0];n<e[1];n++){const e=new d(i[3*n+0]/255,i[3*n+1]/255,i[3*n+2]/255);e.multiplyInPlace(a),e.addInPlace(t),e.normalizeInPlace(),s.setValue(n,e);}},h=(e,t,a,i)=>{for(let s=e[0];s<e[1];s++){const e=new o(i[2*s+0]/255,i[2*s+1]/255);e.multiplyInPlace(a),e.addInPlace(t),n.setValue(s,e);}},c=e.loadUInt32();if(1==c){{const t=this.__boundingBox,i=e.loadUInt8Array(3*a);l([0,a],t.p0,t.diagonal(),i);}if(s){const t=new V(e.loadFloat32Vec3(),e.loadFloat32Vec3()),i=e.loadUInt8Array(3*a);r([0,a],t.p0,t.diagonal(),i),s.loadSplitValues(e);}if(n){const t=new y(e.loadFloat32Vec2(),e.loadFloat32Vec2()),i=e.loadUInt8Array(2*a);h([0,a],t.p0,t.diagonal(),i),n.loadSplitValues(e);}}else {const t=[];let i=0;for(let a=0;a<c;a++){const a=e.loadUInt32(),l={range:[i,i+a],bbox:new V(e.loadFloat32Vec3(),e.loadFloat32Vec3())};s&&(l.normalsRange=new V(e.loadFloat32Vec3(),e.loadFloat32Vec3())),n&&(l.texCoordsRange=new y(e.loadFloat32Vec2(),e.loadFloat32Vec2())),t.push(l),i+=a;}const o=e.loadUInt8Array(3*a);let d,m;s&&(d=e.loadUInt8Array(3*a)),n&&(m=e.loadUInt8Array(2*a));for(let e=0;e<c;e++){{const a=t[e].bbox;l(t[e].range,a.p0,a.diagonal(),o);}if(s){const a=t[e].normalsRange;r(t[e].range,a.p0,a.diagonal(),d);}if(n){const a=t[e].texCoordsRange;h(t[e].range,a.p0,a.diagonal(),m);}}s&&s.loadSplitValues(e),n&&n.loadSplitValues(e);}}toJSON(e,t){let a=super.toJSON(e,t);if(a||(a={}),a.type=C.getClassName(this),!(1024&t)){const i={};for(const[a,s]of this.__vertexAttributes.entries())i[a]=s.toJSON(e,t);a.vertexAttributes=i;}return a}fromJSON(e,t,a){super.fromJSON(e,t,a);for(const t in e.vertexAttributes){let a=this.__vertexAttributes.get(t);const i=e.vertexAttributes[t];if(!a){const e=r.getType(i.dataType);a=new VertexAttribute(this,e,0,i.defaultScalarValue),this.__vertexAttributes.set(t,a);}a.fromJSON(i);}}toString(){return JSON.stringify(this.toJSON(),null,2)}}class Lt extends St{constructor(e,t,a,i){super(t,a,i),this.__geom=e,this.__splits={},this.__splitValues=[];}getFaceVertexValueRef(e,t){const a=this.__geom.getFaceVertexIndex(e,t);return a in this.__splits&&e in this.__splits[a]?this.__splitValues[this.__splits[a][e]]:this.getValueRef(a)}setFaceVertexValue(e,t,a){const i=this.__geom.getFaceVertexIndex(e,t);this.setFaceVertexValue_ByVertexIndex(e,i,a);}setFaceVertexValue_ByVertexIndex(e,t,a){const i=this.getValueRef(t);if(i.isValid())if(i.approxEqual(a));else {if(t in this.__splits){const i=this.__splits[t];for(const t in i){const s=i[t];if(this.__splitValues[s].approxEqual(a))return void(i[e]=s)}if(e in this.__splits[t]){return void this.__splitValues[this.__splits[t][e]].setFromOther(a)}}else this.__splits[t]={};this.__splits[t][e]=this.__splitValues.length,this.__splitValues.push(a);}else i.setFromOther(a);}setSplitVertexValue(e,t,a){if(e in this.__splits||(this.__splits[e]={}),t in this.__splits[e]){if(this.__splitValues[this.__splits[e][t]].approxEqual(a))return;console.warn("Face Vertex Already Split with different value");}this.__splits[e][t]=this.__splitValues.length,this.__splitValues.push(a);}setSplitVertexValues(e,t,a){e in this.__splits||(this.__splits[e]={});const i=this.__splitValues.length;this.__splitValues.push(a);for(const a of t)this.__splits[e][a]=i;}getSplits(){return this.__splits}getSplitCount(){let e=0;for(const t in this.__splits)e+=Object.keys(this.__splits[t]).length;return e}generateSplitValues(e,t){if(0==t)return this.__data;const a=this.length,i=this.length+t,s=this.__dataType.numElements?this.__dataType.numElements():1,n=new Float32Array(i*s);for(let e=0;e<this.__data.length;e++)n[e]=this.__data[e];for(const t in e){const i=e[t];for(const e in i){const l=a+i[e];if(t in this.__splits&&e in this.__splits[t]){const a=this.__splits[t][e];6==this.__dataType?n[l*s]=this.__splitValues[a]:this.__dataType.createFromFloat32Buffer(n.buffer,l*s).setFromOther(this.__splitValues[a]);}else {const e=parseInt(t);for(let t=0;t<s;t++)e*s+t>this.__data.length&&console.log("Error remapping src:"+e*s+t),l*s+t>n.length&&console.log("Error remapping tgt:"+l*s+t),n[l*s+t]=this.__data[e*s+t];}}}return n}toJSON(e,t){const a=super.toJSON(e,t);return a.splits=this.__splits,a.splitValues=this.__splitValues,a}fromJSON(e,t,a){super.fromJSON(e,t,a),this.__splits=e.splits,this.__splitValues=[];for(const t of e.splitValues)this.__splitValues.push(this.__dataType.createFromJSON(t));}loadSplitValues(e){const t=e.loadUInt32Array();if(0==t.length)return;let a=0,i=0;for(;;){const e=t[a++],s=t[a++],n={};for(let e=0;e<s;e++){const e=t[a++],s=t[a++];n[e]=s,s>=i&&(i=s+1);}if(this.__splits[e]=n,a>=t.length)break}const s=this.__numFloat32Elements,n=e.loadFloat32Array(i*s);this.__splitValues=[];for(let e=0;e<i;e++){const t=this.__dataType.createFromFloat32Array(n.slice(e*s,e*s+s));this.__splitValues.push(t);}}}class vt extends Wt{constructor(){super();}loadBin(e){this.name=e.loadStr();const t=e.loadUInt32();this.__boundingBox.set(e.loadFloat32Vec3(),e.loadFloat32Vec3()),this.setNumVertices(t);const a=this.vertices;if(t<256){const i=this.__boundingBox.toMat4(),s=e.loadUInt8Array(3*t);for(let e=0;e<t;e++){const t=new Vec3(s[3*e+0]/255,s[3*e+1]/255,s[3*e+2]/255);a.setValue(e,i.transformVec3(t));}}else {const i=e.loadUInt32(),s=[];for(let t=0;t<i;t++){const t=e.loadUInt32Vec2(),a=e.loadFloat32Vec3(),i=e.loadFloat32Vec3();s.push({range:t,bbox:new Box3(a,i)});}const n=e.loadUInt8Array(3*t);for(let e=0;e<i;e++){const t=s[e].bbox.toMat4();for(let i=s[e].range.x;i<s[e].range.y;i++){const e=new Vec3(n[3*i+0]/255,n[3*i+1]/255,n[3*i+2]/255);a.setValue(i,t.transformVec3(e));}}}}readBinary(e,t){super.loadBaseGeomBinary(e),this.geomDataChanged.emit();}}class Mt extends Wt{constructor(){super(),this.__indices=new Uint32Array,this.__segmentAttributes=new Map,this.lineThickness=0;}getIndices(){return this.__indices}getNumSegments(){return this.__indices.length/2}setNumSegments(e){const t=new Uint32Array(2*e);this.__indices=t;}setSegment(e,t,a){if(e>=this.__indices.length/2)throw new Error("Invalid line index:"+e+". Num Segments:"+this.__indices.length/2);this.__indices[2*e+0]=t,this.__indices[2*e+1]=a;}getSegmentVertexIndex(e,t){if(e<this.numLines)return this.__indices[2*e+t]}addSegmentAttribute(e,t,a){const i=new Attribute(t,null!=a?a:this.polygonCount);return this.__segmentAttributes.set(e,i),i}hasSegmentAttribute(e){return this.__segmentAttributes.has(e)}getSegmentAttribute(e){return this.__segmentAttributes.get(e)}genBuffers(){const e=super.genBuffers();let t;return e.numVertices<Math.pow(2,8)?(t=new Uint8Array(this.__indices.length),this.__indices.forEach((e,a)=>{t[a]=e;})):e.numVertices<Math.pow(2,16)?(t=new Uint16Array(this.__indices.length),this.__indices.forEach((e,a)=>{t[a]=e;})):t=this.__indices,e.indices=t,e}readBinary(e,t){super.loadBaseGeomBinary(e),this.setNumSegments(e.loadUInt32());const a=e.loadUInt8();1==a?this.__indices=e.loadUInt8Array():2==a?this.__indices=e.loadUInt16Array():4==a&&(this.__indices=e.loadUInt32Array()),this.geomDataChanged.emit();}toJSON(e,t){const a=super.toJSON(e,t);return 1024&t||(a.indices=Array.from(this.__indices)),a}fromJSON(e,t,a){super.fromJSON(e,t,a),this.__indices=Uint32Array.from(e.indices);}}class Ft extends Wt{constructor(){super(),this.init();}init(){this.__faceCounts=[],this.__faceVertexCounts=new Uint8Array,this.__faceOffsets=new Uint32Array,this.__faceVertexIndices=new Uint32Array,this.__numPopulatedFaceVertexIndices=0,this.__faceAttributes=new Map,this.__edgeAttributes=new Map,this.__logTopologyWarnings=!1,this.edgeVerts=void 0,this.vertexEdges=void 0,this.numEdges=0,this.edgeFlags=new Uint32Array,this.edgeAngles=new Float32Array;}getFaceVertexIndices(){return this.__faceVertexIndices}getFaceCounts(){return this.__faceCounts}clear(){this.__faceVertexIndices=void 0,this.__faceCounts=[],this.__numPopulatedFaceVertexIndices=0;}setFaceCounts(e){if(this.__numPopulatedFaceVertexIndices)throw new Error("Cannot set face counts on a mesh that is already populated. Please call 'clear' before re-building the mesh.");this.__faceCounts=e;let t=0,a=0,i=3;for(const e of this.__faceCounts)t+=e,a+=e*i,i++;this.__faceVertexCounts=new Uint8Array(t),this.__faceOffsets=new Uint32Array(t),this.__faceVertexIndices=new Uint32Array(a);for(const e of this.__faceAttributes)e.resize(t);}setFaceVertexIndices(e){const t=Array.prototype.slice.call(arguments,1),a=this.__numPopulatedFaceVertexIndices;for(let e=0;e<t.length;e++)this.__faceVertexIndices[a+e]=t[e];this.__faceVertexCounts[e]=t.length-3,this.__faceOffsets[e]=a,this.__numPopulatedFaceVertexIndices+=t.length;}getFaceVertexIndices(e){const t=[],a=this.__faceOffsets[e],i=this.__faceVertexCounts[e]+3;for(let e=0;e<i;e++)t.push(this.__faceVertexIndices[a+e]);return t}getFaceVertexIndex(e,t){const a=this.__faceOffsets[e];return this.__faceVertexIndices[a+t]}getNumFaces(){return this.__faceVertexCounts.length}addVertexAttribute(e,t,a){const i=new Lt(this,t,null!=this.vertices?this.vertices.length:0,a);return this.__vertexAttributes.set(e,i),i}addFaceAttribute(e,t,a){const i=new St(t,null!=a?a:this.getNumFaces());return this.__faceAttributes.set(e,i),i}hasFaceAttribute(e){return this.__faceAttributes.has(e)}getFaceAttribute(e){return this.__faceAttributes.get(e)}addEdgeAttribute(e,t,a){const i=new St(t,null!=a?a:this.getNumEdges());return this.__edgeAttributes.set(e,i),i}hasEdgeAttribute(e){return this.__edgeAttributes.has(e)}getEdgeAttribute(e){return this.__edgeAttributes.get(e)}genTopologyInfo(){const e={};this.vertexEdges=[],this.edgeFaces=[],this.edgeVerts=[],this.faceEdges=[],this.numEdges=0;const t=(t,a)=>{let i=t,s=a;if(s<i){const e=i;i=s,s=e;}const n=i+">"+s;if(n in e)return e[n];const l=this.vertices.getValueRef(i),r=this.vertices.getValueRef(s).subtract(l),o={edgeIndex:this.edgeFaces.length/2,edgeVec:r};return e[n]=o,this.edgeFaces.push(-1),this.edgeFaces.push(-1),this.edgeVerts.push(i),this.edgeVerts.push(s),this.numEdges++,o},a=(e,a,i)=>{const s=t(e,a).edgeIndex;if(a<e){const e=2*s+0;this.__logTopologyWarnings&&-1!=this.edgeFaces[e]&&console.warn("Edge poly 0 already set. Mesh is non-manifold."),this.edgeFaces[e]=i;}else {const e=2*s+1;this.__logTopologyWarnings&&-1!=this.edgeFaces[e]&&console.warn("Edge poly 1 already set. Mesh is non-manifold."),this.edgeFaces[e]=i;}i in this.faceEdges||(this.faceEdges[i]=[]),this.faceEdges[i].push(s),null==this.vertexEdges[e]&&(this.vertexEdges[e]=new Set),null==this.vertexEdges[a]&&(this.vertexEdges[a]=new Set),this.vertexEdges[e].add(s),this.vertexEdges[a].add(s);},i=this.getNumFaces();for(let e=0;e<i;e++){const t=this.getFaceVertexIndices(e);for(let i=0;i<t.length;i++){a(t[i],t[(i+1)%t.length],e);}}}computeFaceNormals(){const e=this.vertices,t=this.addFaceAttribute("normals",d),a=this.getNumFaces();for(let i=0;i<a;i++){const a=this.getFaceVertexIndices(i),s=e.getValueRef(a[0]);let n=e.getValueRef(a[1]);const l=new d;for(let t=2;t<a.length;t++){const i=e.getValueRef(a[t]),r=n.subtract(s),o=i.subtract(s);l.addInPlace(r.cross(o).normalize()),n=i;}l.lengthSquared(),t.setValue(i,l.normalize());}}generateEdgeFlags(){null==this.vertexEdges&&this.genTopologyInfo(),this.hasFaceAttribute("normals")||this.computeFaceNormals();const e=this.vertices,t=this.getFaceAttribute("normals");this.edgeVecs=[],this.edgeAngles=new Float32Array(this.numEdges);for(let a=0;a<this.edgeFaces.length;a+=2){const i=this.edgeVerts[a],s=this.edgeVerts[a+1],n=e.getValueRef(s).subtract(e.getValueRef(i));n.normalizeInPlace(),this.edgeVecs.push(n);const l=this.edgeFaces[a],r=this.edgeFaces[a+1];if(-1==l||-1==r){this.edgeAngles[a/2]=2*Math.PI;continue}const o=t.getValueRef(l),d=t.getValueRef(r);this.edgeAngles[a/2]=o.angleTo(d);}}computeVertexNormals(e=1){this.generateEdgeFlags();const t=this.getFaceAttribute("normals"),a=this.addVertexAttribute("normals",d),i=t.data.buffer,s=e=>new d(i,12*e),n=a.data,l=(e,t)=>{n[3*e+0]=t.x,n[3*e+1]=t.y,n[3*e+2]=t.z;},r=(e,t)=>{let a,i;const s=this.faceEdges[e];for(const e of s)(this.edgeVerts[2*e]==t||this.edgeVerts[2*e+1]==t)&&(a?i=this.edgeVecs[e]:a=this.edgeVecs[e]);return [a,i]};for(let t=0;t<this.vertexEdges.length;t++){if(null==this.vertexEdges[t])continue;const i=this.vertexEdges[t],n=[],o=e=>{let t=!1;for(const a of n)if(t=-1!=a.indexOf(e),t)break;t||n.push([e]);};for(const t of i){const a=this.edgeFaces[2*t],i=this.edgeFaces[2*t+1];if(-1!=a&&-1==i&&this.edgeAngles[t]<e){let e=-1,t=-1;for(let s=0;s<n.length;s++)-1==e&&-1!=n[s].indexOf(a)&&(e=s),-1==t&&-1!=n[s].indexOf(i)&&(t=s);-1==e&&-1==t?n.push([a,i]):-1!=e&&-1!=t?e!=t&&(n[e]=n[e].concat(n[t]),n.splice(t,1)):(-1==e&&n[t].push(a),-1==t&&n[e].push(i));}else -1!=a&&o(a),-1!=i&&o(i);}n.sort((e,t)=>e.length<t.length?1:e.length>t.length?-1:0);let h=!0;for(const e of n){const i=new d;for(const a of e){const e=r(a,t),n=e[0].angleTo(e[1]);i.addInPlace(s(a).scale(n));}i.normalizeInPlace(),h?(l(t,i),h=!1):a.setSplitVertexValues(t,e,i);}}return a}computeNumTriangles(){let e=3,t=0;for(const a of this.__faceCounts)t+=a*(e-2),e++;return t}generateTriangulatedIndices(e,t,a){const i=this.computeNumTriangles();let s;s=e<Math.pow(2,8)?new Uint8Array(3*i):e<Math.pow(2,16)?new Uint16Array(3*i):new Uint32Array(3*i);let n=0;const l=function(e,i){e in a&&i in a[e]&&(e=t+a[e][i]),s[n]=e,n++;},r=this.getNumFaces();for(let e=0;e<r;e++){const t=this.getFaceVertexIndices(e);for(let a=0;a<t.length;a++)a>=3&&(l(t[0],e),l(t[a-1],e)),l(t[a],e);}return s}computeHardEdgesIndices(e=1){const t=[],a=e=>{t.push(this.edgeVerts[e]),t.push(this.edgeVerts[e+1]);};for(let t=0;t<this.edgeFlags.length;t+=2)this.edgeAngles[t/2]>e&&a(t);return t}getWireframeIndices(){return indices}genBuffers(e){const t={};let a=0;for(const[,e]of this.__vertexAttributes){const i=e.getSplits();for(const e in i){e in t||(t[e]={});const s=i[e];for(const i in s){const s=parseInt(i);s in t[e]||(t[e][s]=a,a++);}}}const i=this.vertices.length,s=i+a;let n;e&&0==e.includeIndices||(n=this.generateTriangulatedIndices(s,i,t));const l={};for(const[e,i]of this.__vertexAttributes){let s;s=0==a?i.data:i.generateSplitValues(t,a);const n=i.numElements,r=s.length/n;l[e]={values:s,count:r,dimension:n,normalized:"normals"==e,dataType:i.dataType};}const r={numVertices:this.numVertices(),numRenderVerts:s,indices:n,attrBuffers:l};if(e&&e.includeVertexNeighbors){null==this.vertexEdges&&this.genTopologyInfo();let e=0;for(let t=0;t<this.vertexEdges.length;t++)this.vertexEdges[t]&&(e+=this.vertexEdges[t].size);const t=new Uint32Array(2*this.vertexEdges.length+e),a=e=>{for(let t=0;t<e.length;t++){const a=e[t];for(let i=0;i<t;i++){const s=e[i];if(-1!=a[0]&&a[0]==s[1]){t!=i+1&&(e.splice(t,1),e.splice(i+1,0,a));break}if(-1!=a[1]&&a[1]==s[0]){e.splice(t,1),e.splice(i,0,a);break}}}},i=e=>{if(!(-1!=e[0][0]&&-1!=e[e.length-1][1]||-1==e[0][0]&&-1==e[e.length-1][1]))throw new Error("If fan starts with -1, it must also end with -1");for(let t=0;t<e.length;t++){const a=e[t];if((-1==a[0]||-1==a[1])&&0!=t&&t!=e.length-1)throw new Error("-1 only allowed at the beginning and end of a fan.");if(-1!=a[0]){let i=t-1;if(i<0&&(i+=e.length),a[0]!=e[i][1])throw new Error("Faces are not sequential")}if(-1!=a[1]){const i=(t+1)%e.length;if(a[1]!=e[i][0])throw new Error("Faces are not sequential")}}};let s=2*this.vertexEdges.length;for(let e=0;e<this.vertexEdges.length;e++){if(null==this.vertexEdges[e])continue;const n=this.vertexEdges[e],l=[];for(const t of n){const a=this.edgeVerts[2*t],i=this.edgeVerts[2*t+1];let s,n=this.edgeFaces[2*t],r=this.edgeFaces[2*t+1];if(a==e)s=i;else {if(i!=e)throw new Error("Invalid topology");{s=a;const e=n;n=r,r=e;}}l.push([n,r,s]);}a(l),i(l);let r=0;(-1!=l[0][0]||-1!=l[l.length-1][1])&&(r+=1),t[2*e]=s,t[2*e+1]=n.size+(r<<8);for(const e of l)t[s]=e[2],s++;}r.vertexNeighbors=t;}return r}freeBuffers(){super.freeBuffers(),this.init();}readBinary(e,t){super.loadBaseGeomBinary(e),this.setFaceCounts(e.loadUInt32Array()),this.__faceVertexCounts=e.loadUInt8Array(this.__faceVertexCounts.length);const a=e.loadSInt32Vec2(),i=e.loadUInt8();let s;1==i?s=e.loadUInt8Array():2==i?s=e.loadUInt16Array():4==i&&(s=e.loadUInt32Array());const n=this.getNumFaces();let l=0,r=0;for(let e=0;e<n;e++){const t=this.__faceVertexCounts[e]+3;this.__faceOffsets[e]=l;for(let i=0;i<t;i++){const t=l+i,n=s[t]+a.x;if(0==e)this.__faceVertexIndices[t]=n;else {let a=this.__faceOffsets[e-1];a+=i<r?i:r-1,this.__faceVertexIndices[t]=this.__faceVertexIndices[a]+n;}}l+=t,r=t;}this.__numPopulatedFaceVertexIndices=l;const d=e.loadUInt32();if(d>0){const t=this.vertices,a=this.addVertexAttribute("lightmapCoords",o);for(let i=0;i<d;i++){const i=new X(e.loadFloat32Vec3(),e.loadFloat32Quat()),s=e.loadFloat32(),n=e.loadFloat32Vec2(),l=e.loadSInt32Vec2(),r=e.loadUInt8();let d;d=1==r?e.loadUInt8Array():2==r?e.loadUInt16Array():e.loadUInt32Array();let h=0;for(const e of d){let r=e+l.x;r+=h,h=r;const d=this.getFaceVertexIndices(r);for(const e of d){const l=t.getValueRef(e),d=i.transformVec3(l),h=new o(d.x,d.z);h.scaleInPlace(s),h.addInPlace(n),a.setFaceVertexValue_ByVertexIndex(r,e,h);}}}}this.hasVertexAttribute("normals")||this.computeVertexNormals(),this.geomDataChanged.emit();}toJSON(e,t){const a=super.toJSON(e,t);return 1024&t||(a.faceCounts=Array.from(this.__faceCounts),a.faceVertexIndices=Array.from(this.__faceVertexIndices)),a}fromJSON(e,t,a){super.fromJSON(e,t,a),e.faceCounts&&(this.__faceCounts=Uint32Array.from(e.faceCounts)),e.faceVertexIndices&&(this.__faceVertexIndices=Uint32Array.from(e.faceVertexIndices));}}class Tt extends T{constructor(e){if(super(),this.name=e.name,this.__buffers=e.geomBuffers,this.__buffers.attrBuffers)for(const e in this.__buffers.attrBuffers){const t=this.__buffers.attrBuffers[e],a=r.getType(t.dataType);t.dataType=a;}this.boundingBox=new V,this.boundingBox.p0.__data=e.bbox.p0.__data,this.boundingBox.p1.__data=e.bbox.p1.__data,this.__metaData=new Map,this.boundingBoxDirtied=new S,this.geomDataChanged=new S,this.geomDataTopologyChanged=new S;}genBuffers(){return this.__buffers}freeBuffers(){if(this.__buffers.indices&&(delete this.__buffers.indices),this.__buffers.attrBuffers){for(const a in this.__buffers.attrBuffers){delete this.__buffers.attrBuffers[a];}delete this.__buffers.attrBuffers;}}getMetadata(e){return this.__metaData.get(e)}hasMetadata(e){return this.__metaData.has(e)}setMetadata(e,t){this.__metaData.set(e,t);}}class Ct extends Tt{constructor(e){super(e);}}class Yt extends Tt{constructor(e){super(e);}}class Nt extends Tt{constructor(e){super(e);}}class Kt extends vt{constructor(e=1,t=1,a=1,i=1,s=!1){if(super(),isNaN(e)||isNaN(t)||isNaN(a)||isNaN(i))throw new Error("Invalid geom args");this.__x=e,this.__y=t,this.__xDivisions=a,this.__yDivisions=i,s&&this.addVertexAttribute("texCoords",o),this.__rebuild();}get x(){return console.warn("getter is deprectated. Please use 'getX'"),this.getX()}set x(e){console.warn("getter is deprectated. Please use 'setX'"),this.setX(e);}get y(){return console.warn("getter is deprectated. Please use 'getY'"),this.getY()}set y(e){console.warn("getter is deprectated. Please use 'setY'"),this.setY(e);}getX(){return this.__x}setX(e){this.__x=e,this.__resize();}getY(){return this.__y}setY(e){this.__y=e,this.__resize();}setSize(e,t){this.__x=e,this.__y=t,this.__resize();}__rebuild(){this.setNumVertices(this.__xDivisions*this.__yDivisions);const e=this.getVertexAttribute("texCoords");if(e)for(let t=0;t<this.__yDivisions;t++){const a=t/(this.__yDivisions-1);for(let i=0;i<this.__xDivisions;i++){const s=i/(this.__xDivisions-1);e.getValueRef(t*this.__xDivisions+i).set(s,a);}}this.__resize();}__resize(){for(let e=0;e<this.__yDivisions;e++){const t=(e/(this.__yDivisions-1)-.5)*this.__y;for(let a=0;a<this.__xDivisions;a++){const i=(a/(this.__xDivisions-1)-.5)*this.__x;this.getVertex(e*this.__xDivisions+a).set(i,t,0);}}this.setBoundingBoxDirty();}toJSON(){const e=super.toJSON();return e.x=this.__x,e.y=this.__y,e.xDivisions=this.__xDivisions,e.yDivisions=this.__yDivisions,e}}class wt extends Mt{constructor(e=1,t=1){if(super(),isNaN(e)||isNaN(t))throw new Error("Invalid geom args");this.__x=this.addParameter(new ue("x",e)),this.__x.valueChanged.connect(this.__resize.bind(this)),this.__y=this.addParameter(new ue("y",t)),this.__y.valueChanged.connect(this.__resize.bind(this)),this.__rebuild();}get x(){return this.__x.getValue()}set x(e){this.__x.setValue(e);}get y(){return this.__y.getValue()}set y(e){this.__y.setValue(e);}setSize(e,t){this.__x.setValue(e,-1),this.__y.setValue(t,-1),this.__resize();}__rebuild(){this.setNumVertices(4),this.setNumSegments(4),this.setSegment(0,0,1),this.setSegment(1,1,2),this.setSegment(2,2,3),this.setSegment(3,3,0),this.__resize(-1),this.geomDataTopologyChanged.emit();}__resize(e){const t=this.__x.getValue(),a=this.__y.getValue();this.getVertex(0).set(-.5*t,-.5*a,0),this.getVertex(1).set(.5*t,-.5*a,0),this.getVertex(2).set(.5*t,.5*a,0),this.getVertex(3).set(-.5*t,.5*a,0),this.setBoundingBoxDirty(),-1!=e&&this.geomDataChanged.emit();}toJSON(){const e=super.toJSON();return e.x=this.__x,e.y=this.__y,e}}C.registerClass("Rect",wt);class zt extends Mt{constructor(e=1,t=2*Math.PI,a=32){if(super(),isNaN(e)||isNaN(a))throw new Error("Invalid geom args");this.__radius=this.addParameter(new ue("Radius",e)),this.__angle=this.addParameter(new ue("Angle",t)),this.__numSegments=this.addParameter(new ue("NumSegments",a>=3?a:3,[3,200],1)),this.__radius.valueChanged.connect(this.__resize.bind(this)),this.__angle.valueChanged.connect(this.__rebuild.bind(this)),this.__numSegments.valueChanged.connect(this.__rebuild.bind(this)),this.__rebuild();}__rebuild(){const e=this.__numSegments.getValue();this.setNumVertices(e);const t=this.__angle.getValue()<2*Math.PI;t?this.setNumSegments(e-1):this.setNumSegments(e);for(let a=0;a<(t?e-1:e);a++)this.setSegment(a,a,(a+1)%e);this.__resize(-1),this.geomDataTopologyChanged.emit();}__resize(e){const t=this.__radius.getValue(),a=this.__numSegments.getValue(),i=this.__angle.getValue()/a;for(let e=0;e<a;e++)this.getVertex(e).set(Math.cos(i*e)*t,Math.sin(i*e)*t,0);this.setBoundingBoxDirty(),-1!=e&&this.geomDataChanged.emit();}}C.registerClass("Circle",zt);class Ut extends Mt{constructor(e=1){if(super(),isNaN(e))throw new Error("Invalid geom args");this.__sizeParam=this.addParameter(new ue("size",e)),this.__rebuild();this.__sizeParam.valueChanged.connect(()=>{this.__resize();});}get size(){return this.__size}set size(e){this.__size=e,this.__resize();}__rebuild(){this.setNumVertices(6),this.setNumSegments(3),this.setSegment(0,0,1),this.setSegment(1,2,3),this.setSegment(2,4,5),this.__resize();}__resize(){const e=this.__sizeParam.getValue();this.getVertex(0).set(-.5*e,0,0),this.getVertex(1).set(.5*e,0,0),this.getVertex(2).set(0,.5*e,0),this.getVertex(3).set(0,-.5*e,0),this.getVertex(4).set(0,0,.5*e),this.getVertex(5).set(0,0,-.5*e),this.setBoundingBoxDirty();}}C.registerClass("Cross",Ut);class Jt extends Mt{constructor(e=1,t=1,a=1,i=!1){super(),this.__x=this.addParameter(new ue("x",e)),this.__x.valueChanged.connect(this.__resize.bind(this)),this.__y=this.addParameter(new ue("y",t)),this.__y.valueChanged.connect(this.__resize.bind(this)),this.__z=this.addParameter(new ue("z",a)),this.__z.valueChanged.connect(this.__resize.bind(this)),this.__baseZAtZero=this.addParameter(new ue("BaseZAtZero",i)),this.__baseZAtZero.valueChanged.connect(this.__rebuild.bind(this)),this.__rebuild();}__rebuild(){this.setNumVertices(8),this.setNumSegments(12),this.setSegment(0,0,1),this.setSegment(1,1,2),this.setSegment(2,2,3),this.setSegment(3,3,0),this.setSegment(4,4,5),this.setSegment(5,5,6),this.setSegment(6,6,7),this.setSegment(7,7,4),this.setSegment(8,0,4),this.setSegment(9,1,5),this.setSegment(10,2,6),this.setSegment(11,3,7),this.__resize(-1),this.geomDataTopologyChanged.emit();}__resize(e){const t=this.__x.getValue(),a=this.__y.getValue(),i=this.__z.getValue(),s=this.__baseZAtZero.getValue();let n=.5;s&&(n=1),this.getVertex(0).set(.5*t,-.5*a,n*i),this.getVertex(1).set(.5*t,.5*a,n*i),this.getVertex(2).set(-.5*t,.5*a,n*i),this.getVertex(3).set(-.5*t,-.5*a,n*i),n=-.5,s&&(n=0),this.getVertex(4).set(.5*t,-.5*a,n*i),this.getVertex(5).set(.5*t,.5*a,n*i),this.getVertex(6).set(-.5*t,.5*a,n*i),this.getVertex(7).set(-.5*t,-.5*a,n*i),this.setBoundingBoxDirty(),-1!=e&&this.geomDataChanged.emit();}toJSON(){const e=super.toJSON();return e.size=this.__size,e}}C.registerClass("LinesCuboid",Jt);class Pt extends Mt{constructor(e=1,t=1,a=10,i=10,s=!1){if(super(),isNaN(e)||isNaN(t)||isNaN(a)||isNaN(i))throw new Error("Invalid geom args");this.__xParam=this.addParameter(new ue("x",e)),this.__yParam=this.addParameter(new ue("y",t)),this.__xDivisionsParam=this.addParameter(new ue("xDivisions",a)),this.__yDivisionsParam=this.addParameter(new ue("yDivisions",i)),this.__skipCenterLinesParam=this.addParameter(new pe("skipCenterLines",s)),this.__rebuild();}get sizeX(){return this.__x}set sizeX(e){this.__x=e,this.__resize();}get sizeY(){return this.__y}set sizeY(e){this.__y=e,this.__resize();}get divisionsX(){return this.__xDivisions}set divisionsX(e){this.__xDivisions=e,this.__rebuild();}get divisionsY(){return this.__yDivisions}set divisionsY(e){this.__yDivisions=e,this.__rebuild();}setSize(e,t){this.__x=e,this.__y=t,this.__resize();}__rebuild(){const e=this.__xDivisionsParam.getValue(),t=this.__yDivisionsParam.getValue(),a=this.__skipCenterLinesParam.getValue()&&e%2==0&&t%2==0;this.setNumVertices(2*(e+t+2-(a?1:0))),this.setNumSegments(e+t+2-(a?1:0));let i=0;for(let t=0;t<=e;t++){if(a&&t==e/2)continue;const s=2*i,n=2*i+1;this.setSegment(i,s,n),i++;}for(let s=0;s<=t;s++){if(a&&s==e/2)continue;const t=2*i,n=2*i+1;this.setSegment(i,t,n),i++;}this.__resize();}__resize(){const e=this.__xDivisionsParam.getValue(),t=this.__yDivisionsParam.getValue(),a=this.__xParam.getValue(),i=this.__yParam.getValue(),s=this.__skipCenterLinesParam.getValue()&&e%2==0&&t%2==0;let n=0;for(let t=0;t<=e;t++){if(s&&t==e/2)continue;const l=2*n,r=2*n+1,o=(t/e-.5)*a;this.getVertex(l).set(o,-.5*i,0),this.getVertex(r).set(o,.5*i,0),n++;}for(let l=0;l<=t;l++){if(s&&l==e/2)continue;const r=2*n,o=2*n+1,d=(l/t-.5)*i;this.getVertex(r).set(-.5*a,d,0),this.getVertex(o).set(.5*a,d,0),n++;}this.setBoundingBoxDirty();}toJSON(){const e=super.toJSON();return e.x=this.__x,e.z=this.__y,e.xDivisions=this.__xDivisions,e.yDivisions=this.__yDivisions,e}}C.registerClass("Grid",Pt);class Et extends Ft{constructor(e=.5,t=1,a=32,i=!0){if(super(),isNaN(e)||isNaN(t)||isNaN(a))throw new Error("Invalid geom args");this.__radiusParam=this.addParameter(new ue("radius",e)),this.__heightParam=this.addParameter(new ue("height",t)),this.__detailParam=this.addParameter(new ue("detail",a>=3?a:3,[3,200],1)),this.__capParam=this.addParameter(new pe("cap",i)),this.addVertexAttribute("texCoords",o),this.addVertexAttribute("normals",d),this.__rebuild();const s=()=>{this.__resize();},n=()=>{this.__rebuild();};this.__radiusParam.valueChanged.connect(s),this.__heightParam.valueChanged.connect(s),this.__detailParam.valueChanged.connect(n),this.__capParam.valueChanged.connect(n);}get radius(){return this.__radiusParam.getValue()}set radius(e){this.__radiusParam.setValue(e),this.__resize();}get height(){return this.__heightParam.getValue()}set height(e){this.__heightParam.setValue(e),this.__resize();}get detail(){return this.__detailParam.getValue()}set detail(e){this.__detailParam.setValue(e),this.__rebuild();}get cap(){return this.__capParam.getValue()}set cap(e){this.__capParam.setValue(e),this.__rebuild();}__rebuild(){this.clear();const e=this.__detailParam.getValue(),t=this.__radiusParam.getValue(),a=this.__heightParam.getValue(),i=this.__capParam.getValue();let s=e+1;i&&(s+=1),this.setNumVertices(s);const n=e,l=e+1;this.getVertex(n).set(0,0,a);for(let a=0;a<e;a++){const i=a/e*2*Math.PI;this.getVertex(a).set(t*Math.cos(i),t*Math.sin(i),0);}i&&this.getVertex(l).set(0,0,0),this.setFaceCounts([e+(i?e:0)]);for(let t=0;t<e;t++){const a=(t+1)%e;this.setFaceVertexIndices(t,a,t,n);}if(i)for(let t=0;t<e;t++){const a=(t+1)%e;this.setFaceVertexIndices(e+t,t,a,l);}const r=this.getVertexAttribute("normals");let h;const c=a;Math.abs(a)<1e-12&&(h=a<0?-1e-12:1e-12),h=t/c;let m=0;for(let t=0;t<e;t++){const a=(t+1)/e*2*Math.PI,i=t/e*2*Math.PI,s=.5*(a+i);r.setFaceVertexValue(m,0,new d(Math.cos(a),h,Math.sin(a)).normalize()),r.setFaceVertexValue(m,1,new d(Math.cos(i),h,Math.sin(i)).normalize()),r.setFaceVertexValue(m,2,new d(Math.cos(s),h,Math.sin(s)).normalize()),m++;}if(i){const t=new d(0,-1,0);for(let a=0;a<e;a++)r.setFaceVertexValue(m,0,t),r.setFaceVertexValue(m,1,t),r.setFaceVertexValue(m,2,t),m++;}const u=this.getVertexAttribute("texCoords");m=0;for(let t=0;t<e;t++)u.setFaceVertexValue(m,0,new o((t+1)/e,0)),u.setFaceVertexValue(m,1,new o(t/e,0)),u.setFaceVertexValue(m,2,new o((t+.5)/e,1));if(i)for(let t=0;t<e;t++)u.setFaceVertexValue(m,0,new o(t/e,0)),u.setFaceVertexValue(m,1,new o((t+1)/e,0)),u.setFaceVertexValue(m,2,new o((t+.5)/e,1)),m++;this.setBoundingBoxDirty();}__resize(){const e=this.__detailParam.getValue(),t=this.__radiusParam.getValue(),a=this.__heightParam.getValue(),i=(this.__capParam.getValue(),e),s=e+1;this.getVertex(i).set(0,0,a);for(let a=0;a<e;a++){const i=a/e*2*Math.PI;this.getVertex(a).set(t*Math.cos(i),t*Math.sin(i),0);}this.__cap&&this.getVertex(s).set(0,0,0),this.setBoundingBoxDirty();}}C.registerClass("Cone",Et);class Ht extends Ft{constructor(e=1,t=1,a=1,i=!1){if(super(),isNaN(e)||isNaN(t)||isNaN(a))throw new Error("Invalid geom args");this.__xParam=this.addParameter(new ue("x",e)),this.__yParam=this.addParameter(new ue("y",t)),this.__zParam=this.addParameter(new ue("z",a)),this.__baseZAtZeroParam=this.addParameter(new pe("baseZAtZero",i)),this.setFaceCounts([0,6]),this.setFaceVertexIndices(0,0,1,2,3),this.setFaceVertexIndices(1,7,6,5,4),this.setFaceVertexIndices(2,1,0,4,5),this.setFaceVertexIndices(3,3,2,6,7),this.setFaceVertexIndices(4,0,3,7,4),this.setFaceVertexIndices(5,2,1,5,6),this.setNumVertices(8),this.addVertexAttribute("texCoords",o),this.addVertexAttribute("normals",d),this.__rebuild();const s=()=>{this.__resize();};this.__xParam.valueChanged.connect(s),this.__yParam.valueChanged.connect(s),this.__zParam.valueChanged.connect(s),this.__baseZAtZeroParam.valueChanged.connect(s);}setSize(e,t,a){this.__xParam.setValue(e),this.__yParam.setValue(t),this.__zParam.setValue(a);}setBaseSize(e,t){this.__xParam.setValue(e),this.__yParam.setValue(t);}__rebuild(){const e=this.getVertexAttribute("normals");for(let t=0;t<6;t++){let a;switch(t){case 0:a=new d(0,0,1);break;case 1:a=new d(0,0,-1);break;case 2:a=new d(1,0,0);break;case 3:a=new d(-1,0,0);break;case 4:a=new d(0,1,0);break;case 5:a=new d(0,-1,0);}e.setFaceVertexValue(t,0,a),e.setFaceVertexValue(t,1,a),e.setFaceVertexValue(t,2,a),e.setFaceVertexValue(t,3,a);}const t=this.getVertexAttribute("texCoords");for(let e=0;e<6;e++)t.setFaceVertexValue(e,0,new o(0,0)),t.setFaceVertexValue(e,1,new o(1,0)),t.setFaceVertexValue(e,2,new o(1,1)),t.setFaceVertexValue(e,3,new o(0,1));this.__resize();}__resize(e){const t=this.__xParam.getValue(),a=this.__yParam.getValue(),i=this.__zParam.getValue(),s=this.__baseZAtZeroParam.getValue();let n=.5;s&&(n=1),this.getVertex(0).set(.5*t,-.5*a,n*i),this.getVertex(1).set(.5*t,.5*a,n*i),this.getVertex(2).set(-.5*t,.5*a,n*i),this.getVertex(3).set(-.5*t,-.5*a,n*i),n=-.5,s&&(n=0),this.getVertex(4).set(.5*t,-.5*a,n*i),this.getVertex(5).set(.5*t,.5*a,n*i),this.getVertex(6).set(-.5*t,.5*a,n*i),this.getVertex(7).set(-.5*t,-.5*a,n*i),this.setBoundingBoxDirty(),this.geomDataChanged.emit();}toJSON(){const e=super.toJSON();return e.x=this.__x,e.y=this.__y,e.z=this.__z,e}}C.registerClass("Cuboid",Ht);class kt extends Ft{constructor(e=.5,t=1,a=32,i=2,s=!0,n=!1){if(super(),isNaN(e)||isNaN(t)||isNaN(a)||isNaN(i))throw new Error("Invalid geom args");this.__radiusParam=this.addParameter(new ue("radius",e)),this.__heightParam=this.addParameter(new ue("height",t)),this.__sidesParam=this.addParameter(new ue("sides",a>=3?a:3,[3,200],1)),this.__loopsParam=this.addParameter(new ue("loops",i>=2?i:2,[1,200],1)),this.__capsParam=this.addParameter(new pe("caps",s)),this.__baseZAtZeroParam=this.addParameter(new pe("baseZAtZero",n)),this.addVertexAttribute("texCoords",o),this.addVertexAttribute("normals",d),this.__rebuild();const l=()=>{this.__resize();},r=()=>{this.__rebuild();};this.__radiusParam.valueChanged.connect(l),this.__heightParam.valueChanged.connect(l),this.__sidesParam.valueChanged.connect(r),this.__loopsParam.valueChanged.connect(r),this.__capsParam.valueChanged.connect(r),this.__baseZAtZeroParam.valueChanged.connect(l);}__rebuild(){this.clear();this.__radiusParam.getValue();const e=this.__sidesParam.getValue(),t=this.__loopsParam.getValue(),a=(this.__heightParam.getValue(),this.__capsParam.getValue());this.__baseZAtZeroParam.getValue();let i=e*t;a&&(i+=2),this.setNumVertices(i),a?this.setFaceCounts([2*e,e]):this.setFaceCounts([0,e]);let s=0;for(let a=0;a<t-1;a++)for(let t=0;t<e;t++){const i=e*a+(t+1)%e,n=e*a+t,l=e*(a+1)+t,r=e*(a+1)+(t+1)%e;this.setFaceVertexIndices(s++,i,n,l,r);}if(a){for(let t=0;t<e;t++){const a=i-1,n=t,l=(t+1)%e;this.setFaceVertexIndices(s++,a,n,l);}for(let a=0;a<e;a++){const n=e*(t-1)+a,l=i-2,r=e*(t-1)+(a+1)%e;this.setFaceVertexIndices(s++,n,l,r);}}const n=this.getVertexAttribute("normals");s=0;for(let a=0;a<t-1;a++)for(let t=0;t<e;t++){let a=t/e*2*Math.PI;const i=new d(Math.sin(a),Math.cos(a),0);n.setFaceVertexValue(s,0,i),n.setFaceVertexValue(s,1,i),a=(t+1)/e*2*Math.PI;const l=new d(Math.sin(a),Math.cos(a),0);n.setFaceVertexValue(s,2,l),n.setFaceVertexValue(s,3,l),s++;}if(a){const t=new d(0,0,-1);for(let a=0;a<e;a++)n.setFaceVertexValue(s,0,t),n.setFaceVertexValue(s,1,t),n.setFaceVertexValue(s,2,t),s++;t.set(0,0,1);for(let a=0;a<e;a++)n.setFaceVertexValue(s,0,t),n.setFaceVertexValue(s,1,t),n.setFaceVertexValue(s,2,t),s++;}const l=this.getVertexAttribute("texCoords");s=0;for(let t=0;t<e;t++)l.setFaceVertexValue(s,0,new o((t+1)/e,0)),l.setFaceVertexValue(s,2,new o((t+1)/e,1)),l.setFaceVertexValue(s,1,new o(t/e,0)),l.setFaceVertexValue(s,3,new o(t/e,1)),s++;if(a){for(let t=0;t<e;t++)l.setFaceVertexValue(s,0,new o(t/e,0)),l.setFaceVertexValue(s,1,new o((t+1)/e,0)),l.setFaceVertexValue(s,2,new o((t+.5)/e,1)),s++;for(let t=0;t<e;t++)l.setFaceVertexValue(s,0,new o(t/e,0)),l.setFaceVertexValue(s,1,new o((t+1)/e,0)),l.setFaceVertexValue(s,2,new o((t+.5)/e,1)),s++;}this.geomDataTopologyChanged.emit(),this.__resize();}__resize(){const e=this.__sidesParam.getValue(),t=this.__loopsParam.getValue(),a=this.__radiusParam.getValue(),i=this.__heightParam.getValue(),s=this.__capsParam.getValue(),n=this.__baseZAtZeroParam.getValue();let l=e*t;s&&(l+=2);let r=0,o=.5;n&&(o=0);for(let s=0;s<t;s++){const n=s/(t-1)*i-i*o;for(let t=0;t<e;t++){const i=t/e*2*Math.PI;this.getVertex(r).set(Math.sin(i)*a,Math.cos(i)*a,n),r++;}}s&&(this.getVertex(l-1).set(0,0,i*(n?0:-.5)),this.getVertex(l-2).set(0,0,i*(n?1:.5))),this.setBoundingBoxDirty(),this.geomDataChanged.emit();}}C.registerClass("Cylinder",kt);class Bt extends Ft{constructor(e=.5,t=32){if(super(),isNaN(e)||isNaN(t))throw new Error("Invalid geom args");this.__radiusParam=this.addParameter(new ue("radius",e)),this.__sidesParam=this.addParameter(new ue("sides",t>=3?t:3,[3,200],1)),this.addVertexAttribute("texCoords",o),this.addVertexAttribute("normals",d),this.__rebuild();}get radius(){return this.__radius}set radius(e){this.__radius=e,this.__resize();}set sides(e){this.__sides=e>=3?e:3,this.__rebuild();}__rebuild(){const e=this.__sidesParam.getValue();this.setNumVertices(e+1),this.setFaceCounts([e]),this.getVertex(0).set(0,0,0);for(let t=0;t<e;t++){const a=t%e+1,i=(t+1)%e+1;this.setFaceVertexIndices(t,0,a,i);}const t=this.getVertexAttribute("normals"),a=new d(0,0,1);t.setValue(0,a);for(let i=0;i<e;i++)t.setValue(i+1,a);const i=this.getVertexAttribute("texCoords");i.getValueRef(0).set(.5,.5);for(let t=0;t<e;t++){const a=t/e*2*Math.PI;i.getValueRef(t+1).set(.5*Math.sin(a)+.5,.5*Math.cos(a)+.5);}this.setBoundingBoxDirty(),this.__resize();}__resize(){const e=this.__sidesParam.getValue(),t=this.__radiusParam.getValue();for(let a=0;a<e;a++){const i=a/e*2*Math.PI;this.getVertex(a+1).set(Math.sin(i)*t,Math.cos(i)*t,0);}this.setBoundingBoxDirty();}toJSON(){const e=super.toJSON();return e.radius=this.__radius,e}}C.registerClass("Disc",Bt);class Dt extends Ft{constructor(e=1,t=1,a=1,i=1,s=!0,n=!0){if(super(),isNaN(e)||isNaN(t)||isNaN(a)||isNaN(i))throw new Error("Invalid geom args");this.__sizeXParam=this.addParameter(new ue("SizeX",e)),this.__sizeYParam=this.addParameter(new ue("SizeY",t)),this.__detailXParam=this.addParameter(new ue("DetailX",a)),this.__detailYParam=this.addParameter(new ue("DetailY",i)),s&&this.addVertexAttribute("normals",d),n&&this.addVertexAttribute("texCoords",o),this.__rebuild(),this.__sizeXParam.valueChanged.connect(this.__resize.bind(this)),this.__sizeYParam.valueChanged.connect(this.__resize.bind(this)),this.__detailXParam.valueChanged.connect(this.__rebuild.bind(this)),this.__detailYParam.valueChanged.connect(this.__rebuild.bind(this));}__rebuild(){const e=this.__detailXParam.getValue(),t=this.__detailYParam.getValue();this.setNumVertices((e+1)*(t+1)),this.setFaceCounts([0,e*t]);let a=0;for(let i=0;i<t;i++)for(let t=0;t<e;t++){const s=(e+1)*(i+1)+t,n=(e+1)*(i+1)+(t+1),l=(e+1)*i+(t+1),r=(e+1)*i+t;this.setFaceVertexIndices(a,s,n,l,r),a+=1;}let i=0;const s=this.getVertexAttribute("normals");if(s)for(let a=0;a<=t;a++)for(let t=0;t<=e;t++)s.getValueRef(i).set(0,0,1),i++;i=0;const n=this.getVertexAttribute("texCoords");if(n)for(let a=0;a<=t;a++){const s=a/t;for(let t=0;t<=e;t++){const a=t/e;n.getValueRef(i).set(a,s),i++;}}this.__resize(!1),this.geomDataTopologyChanged.emit();}__resize(e=!0){const t=this.__sizeXParam.getValue(),a=this.__sizeYParam.getValue(),i=this.__detailXParam.getValue(),s=this.__detailYParam.getValue();let n=0;for(let e=0;e<=s;e++){const l=(e/s-.5)*a;for(let e=0;e<=i;e++){const a=(e/i-.5)*t;this.getVertex(n).set(a,l,0),n++;}}this.setBoundingBoxDirty(),e&&this.geomDataChanged.emit();}}class Ot extends Ft{constructor(e=1,t=12,a=12){if(super(),isNaN(e)||isNaN(t)||isNaN(a))throw new Error("Invalid geom args");this.__radiusParam=this.addParameter(new ue("radius",e)),this.__sidesParam=this.addParameter(new ue("sides",t>=3?t:3,[3,200],1)),this.__loopsParam=this.addParameter(new ue("loops",a>=3?a:3,[3,200],1)),this.addVertexAttribute("texCoords",o),this.addVertexAttribute("normals",d),this.__rebuild();const i=()=>{this.__rebuild();};this.__radiusParam.valueChanged.connect(()=>{this.__resize();}),this.__sidesParam.valueChanged.connect(i),this.__loopsParam.valueChanged.connect(i);}__rebuild(){const e=this.__radiusParam.getValue(),t=this.__sidesParam.getValue(),a=this.__loopsParam.getValue(),i=2+t*a,s=2*t,n=t*a;this.setNumVertices(i),this.setFaceCounts([s,n]);const l=this.getVertexAttribute("normals"),r=new d(0,0,1);let h=0;this.getVertex(h).set(0,0,e),l.getValueRef(h).set(0,0,1),h++;for(let i=0;i<a;i++){const s=(i+1)/(a+1)*Math.PI;for(let a=0;a<t;a++){const i=a/t*2*Math.PI;r.set(Math.sin(s)*Math.cos(i),Math.sin(s)*Math.sin(i),Math.cos(s)),this.getVertex(h).setFromOther(r.scale(e)),l.getValueRef(h).setFromOther(r),h++;}}this.getVertex(h).set(0,0,-e),l.getValueRef(h).set(0,0,-1),h++;const c=this.getVertexAttribute("texCoords");let m=0;for(let e=0;e<t;e++){const i=0,s=(e+1)%t+1,n=e+1;this.setFaceVertexIndices(m,i,s,n);const l=new o(.5,0),r=new o(1-(e+1)/t,0),d=new o(1-e/t,1/(a+1));c.setFaceVertexValue(m,0,l),c.setFaceVertexValue(m,1,r),c.setFaceVertexValue(m,2,d),m++;}for(let e=0;e<t;e++){const s=i-1,n=t*(a-1)+e+1,l=t*(a-1)+(e+1)%t+1;this.setFaceVertexIndices(m,s,n,l);const r=new o(1-e/t,a/(a+1)),d=new o(1-(e+1)/t,a/(a+1)),h=new o(.5,1);c.setFaceVertexValue(m,0,r),c.setFaceVertexValue(m,1,d),c.setFaceVertexValue(m,2,h),m++;}for(let e=0;e<a-1;e++)for(let i=0;i<t;i++){const s=t*e+i+1,n=t*e+(i+1)%t+1,l=t*(e+1)+(i+1)%t+1,r=t*(e+1)+i+1;this.setFaceVertexIndices(m,s,n,l,r),c.setFaceVertexValue(m,0,new o(e/a,i/a)),c.setFaceVertexValue(m,1,new o(e/a,(i+1)/a)),c.setFaceVertexValue(m,2,new o((e+1)/a,(i+1)/a)),c.setFaceVertexValue(m,3,new o((e+1)/a,i/a)),m++;}this.setBoundingBoxDirty(),this.geomDataTopologyChanged.emit();}__resize(){const e=this.__radiusParam.getValue(),t=this.__sidesParam.getValue(),a=this.__loopsParam.getValue();let i=0;const s=new d(0,0,1);this.getVertex(i).set(0,0,e),i++;for(let n=0;n<a;n++){const l=(n+1)/(a+1)*Math.PI;for(let a=0;a<t;a++){const n=a/t*2*Math.PI;s.set(Math.sin(l)*Math.cos(n),Math.sin(l)*Math.sin(n),Math.cos(l)),this.getVertex(i).setFromOther(s.scale(e)),i++;}}this.getVertex(i).set(0,0,-e),i++,this.setBoundingBoxDirty(),this.geomDataChanged.emit();}}C.registerClass("Sphere",Ot);class Qt extends Ft{constructor(e=.5,t=1,a=32){if(super(),isNaN(e)||isNaN(t)||isNaN(a))throw new Error("Invalid geom args");this.__innerRadius=e,this.__outerRadius=t,this.__detail=a>=3?a:3,this.addVertexAttribute("texCoords",o),this.addVertexAttribute("normals",d),this.__rebuild();}get innerRadius(){return this.__innerRadius}set innerRadius(e){this.__innerRadius=e,this.__resize();}get outerRadius(){return this.__outerRadius}set outerRadius(e){this.__outerRadius=e,this.__resize();}get detail(){return this.__detail}set detail(e){this.__detail=e>=3?e:3,this.__rebuild();}__rebuild(){const e=this.__detail,t=2*this.__detail,a=e*t;this.setNumVertices(a),this.setFaceCounts([0,e*t]);const i=this.getVertexAttribute("normals");let s=0;for(let a=0;a<t;a++){const n=a/t*2*Math.PI,l=Math.cos(n),r=Math.sin(n);for(let t=0;t<e;t++){const a=t/e*2*Math.PI,n=Math.sin(a),o=Math.cos(a),d=this.__outerRadius+o*this.__innerRadius;this.getVertex(s).set(l*d,r*d,this.__innerRadius*n),i.getValueRef(s).set(l*o,r*o,n),s++;}}const n=this.getVertexAttribute("texCoords");let l=0;for(let a=0;a<t;a++)for(let i=0;i<e;i++){const s=(a+1)%t,r=(i+1)%e,d=e*a+i,h=e*a+r,c=e*s+r,m=e*s+i;this.setFaceVertexIndices(l,d,h,c,m),n.setFaceVertexValue(l,0,new o(a/t,i/t)),n.setFaceVertexValue(l,1,new o(a/t,(i+1)/t)),n.setFaceVertexValue(l,2,new o((a+1)/t,(i+1)/t)),n.setFaceVertexValue(l,3,new o((a+1)/t,i/t)),l++;}this.setBoundingBoxDirty();}__resize(){const e=this.__detail,t=2*this.__detail;for(let a=0;a<t;a++){const i=a/t*2*Math.PI,s=Math.cos(i),n=Math.sin(i);for(let t=0;t<e;t++){const a=t/e*2*Math.PI,i=Math.sin(a),l=Math.cos(a),r=this.__outerRadius+l*this.__innerRadius;this.getVertex(0).set(s*r,n*r,this.__innerRadius*i),index++;}}this.setBoundingBoxDirty();}toJSON(){const e=super.toJSON();return e.x=this.__x,e.y=this.__y,e.z=this.__z,e}}const At={SAVE_FLAG_SKIP_CHILDREN:1},jt={LOAD_FLAG_LOADING_BIN_TREE_VALUES:16},qt={CLONE_FLAG_INSTANCED_TREE:1};class $t extends D{constructor(e){super(e),this.__visibleCounter=1,this.__visible=!0,this.__highlightMapping={},this.__highlights=[],this.__childItems=[],this.__childItemsSignalIds=[],this.__childItemsMapping={},this.__components=[],this.__componentMapping={},this.mouseDown=new S,this.mouseUp=new S,this.mouseMove=new S,this.mouseEnter=new S,this.mouseLeave=new S,this.__visibleParam=this.addParameter(new pe("Visible",!0)),this.__localXfoParam=this.addParameter(new fe("LocalXfo",new X)),this.__globalXfoParam=this.addParameter(new fe("GlobalXfo",new X)),this.__boundingBoxParam=this.addParameter(new P("BoundingBox",new V)),this.parentChanged=this.ownerChanged,this.childAdded=new S,this.childRemoved=new S,this.highlightChanged=new S,this.visibilityChanged=new S,this.localXfoChanged=this.__localXfoParam.valueChanged,this.globalXfoChanged=this.__globalXfoParam.valueChanged,this.boundingChanged=this.__boundingBoxParam.valueChanged,this._cleanGlobalXfo=this._cleanGlobalXfo.bind(this),this._setGlobalXfoDirty=this._setGlobalXfoDirty.bind(this),this._setBoundingBoxDirty=this._setBoundingBoxDirty.bind(this),this._cleanBoundingBox=this._cleanBoundingBox.bind(this),this.__localXfoParam.valueChanged.connect(this._setGlobalXfoDirty);const t=e=>{const t=this.__globalXfoParam.getValue();return void 0!==this.__ownerItem?this.__ownerItem.getGlobalXfo().inverse().multiply(t):t};this.__globalXfoParam.valueChanged.connect(e=>{e!=N.OPERATOR_DIRTIED&&this.__localXfoParam.setDirty(t),this._setBoundingBoxDirty();}),this.__visibleParam.valueChanged.connect(e=>{this.__visibleCounter+=this.__visibleParam.getValue()?1:-1,this.__updateVisiblity();});}static get SaveFlags(){return At}static get LoadFlags(){return jt}static get CloneFlags(){return qt}static getSelectionOutlineColor(){return selectionOutlineColor}static setSelectionOutlineColor(e){selectionOutlineColor=e;}static getBranchSelectionOutlineColor(){return branchSelectionOutlineColor}static setBranchSelectionOutlineColor(e){branchSelectionOutlineColor=e;}_childFlagsChanged(e){0!=(e&K.USER_EDITED)&&this.setFlag(k.USER_EDITED);}setFlag(e){super.setFlag(e),this.__ownerItem&&this.__ownerItem._childFlagsChanged(e);}setOwner(e){if(this.__ownerItem){this.__ownerItem.globalXfoChanged.disconnect(this._setGlobalXfoDirty),this.__ownerItem.getVisible()||this.__visibleCounter++;const e=this.__ownerItem.getChildIndex(this);e>=0&&this.__ownerItem.__unbindChild(e,this);}super.setOwner(e),this._setGlobalXfoDirty(),this.__ownerItem&&(this.setSelectable(this.__ownerItem.getSelectable(),!0),this.__ownerItem.getVisible()||this.__visibleCounter--,this.__ownerItem.globalXfoChanged.connect(this._setGlobalXfoDirty)),this.__updateVisiblity();}__updatePath(){super.__updatePath();for(const e of this.__childItems)e&&e.__updatePath();for(const e of this.__components)e&&e.__updatePath();}getParentItem(){return this.getOwner()}setParentItem(e){this.setOwner(e);}getLocalXfo(){return this.__localXfoParam.getValue()}setLocalXfo(e,t){this.__localXfoParam.setValue(e,t);}getGlobalXfo(e){return this.__globalXfoParam.getValue(e)}setGlobalXfo(e,t){const a=this.getOwner();if(a){const i=a.getGlobalXfo().inverse().multiply(e);this.__localXfoParam.setValue(i,t);}else this.__globalXfoParam.setValue(e,t);}_cleanGlobalXfo(e){const t=this.getParentItem(),a=this.__localXfoParam.getValue();if(void 0!==t){return t.getGlobalXfo().multiply(a)}return a}_setGlobalXfoDirty(){this.__globalXfoParam.setDirty(this._cleanGlobalXfo);}getVisible(){return this.__visibleCounter>0}setVisible(e){this.__visibleParam.setValue(e);}propagateVisiblity(e){this.__visibleCounter+=e,this.__updateVisiblity();}__updateVisiblity(){const e=this.__visibleCounter>0;if(e!=this.__visible){this.__visible=e;for(const e of this.__childItems)e instanceof $t&&e.propagateVisiblity(this.__visible?1:-1);return this.visibilityChanged.emit(e),!0}return !1}addHighlight(e,t,a=!1){if(e in this.__highlightMapping){const t=this.__highlights.indexOf(e);this.__highlights.splice(t,1);}this.__highlights.push(e),this.__highlightMapping[e]=t,this.highlightChanged.emit(),a&&this.__childItems.forEach(i=>{i instanceof $t&&i.addHighlight(e,t,a);});}removeHighlight(e,t=!1){if(e in this.__highlightMapping){const t=this.__highlights.indexOf(e);this.__highlights.splice(t,1),delete this.__highlightMapping[e],this.highlightChanged.emit();}t&&this.__childItems.forEach(a=>{a instanceof $t&&a.removeHighlight(e,t);});}getHighlight(){if(this.__highlights.length>0)return this.__highlightMapping[this.__highlights[this.__highlights.length-1]]}isHighlighted(){return this.__highlights.length>0}get boundingBox(){return console.warn("getter is deprectated. Please use 'getBoundingBox'"),this.getBoundingBox()}getBoundingBox(){return this.__boundingBoxParam.getValue()}_cleanBoundingBox(e){return e.reset(),this.__childItems.forEach(t=>{t instanceof $t&&t.getVisible()&&!t.testFlag(k.IGNORE_BBOX)&&e.addBox3(t.getBoundingBox());}),e}_childBBoxChanged(){this._setBoundingBoxDirty();}_setBoundingBoxDirty(){this.__boundingBoxParam&&this.__boundingBoxParam.setDirty(this._cleanBoundingBox);}getChildren(){return this.__childItems}numChildren(){return console.warn("Deprecated method. Please use getNumChildren"),this.__childItems.length}getNumChildren(){return this.__childItems.length}generateUniqueName(e){if(!(e in this.__childItemsMapping))return e;let t=1;e.length>4&&!Number.isNaN(parseInt(e.substring(e.length-4)))?t=parseInt(e.substr(e.length-4)):e.length>3&&!Number.isNaN(parseInt(e.substring(e.length-3)))?t=parseInt(e.substr(e.length-3)):e.length>2&&!Number.isNaN(parseInt(e.substring(e.length-2)))&&(t=parseInt(e.substr(e.length-2)));const a=[];for(const e of this.__childItems)e&&a.push(e.getName());let i=e;for(;;){let s=""+t;for(;s.length<2;)s="0"+s;if(i=e+s,-1==a.indexOf(i))break;t++;}return i}__updateMapping(e){for(let t=e;t<this.__childItems.length;t++)this.__childItemsMapping[this.__childItems[t].getName()]=t;}insertChild(e,t,a=!1,i=!0){if(e.getName()in this.__childItemsMapping){if(!i)throw new Error("Item '"+e.getName()+"' is already a child of :"+this.getPath());e.setName(this.generateUniqueName(e.getName()));}if(!(e instanceof D))throw new Error("Object is is not a tree item :"+e.constructor.name);const s={};let n;return s.nameChangedId=e.nameChanged.connect((e,t)=>{const a=this.__childItemsMapping[t];delete this.__childItemsMapping[t],this.__childItemsMapping[e]=a;}),e instanceof $t&&(a&&(n=this.getGlobalXfo().inverse().multiply(e.getGlobalXfo())),s.bboxChangedId=e.boundingChanged.connect(()=>{this._setBoundingBoxDirty();}),s.visChangedId=e.visibilityChanged.connect(this._setBoundingBoxDirty)),this.__childItems.splice(t,0,e),this.__childItemsSignalIds.splice(t,0,s),this.__childItemsMapping[e.getName()]=t,this.__updateMapping(t),e.setOwner(this),e instanceof $t&&(a&&e.setLocalXfo(n),this._setBoundingBoxDirty()),e.testFlag(k.USER_EDITED)&&this.setFlag(k.USER_EDITED),this.childAdded.emit(e,t),e}addChild(e,t=!0,a=!0){const i=this.__childItems.length;return this.insertChild(e,i,t,a),i}getChild(e){return this.__childItems[e]}getChildByName(e){const t=this.__childItemsMapping[e];return null!=t?this.__childItems[t]:null}getChildNames(){const e=[];for(let t=0;t<this.__childItems.length;t++){const a=this.__childItems[t];null!=a&&(e[t]=a.getName());}return e}__unbindChild(e,t){const a=this.__childItemsSignalIds[e];t.nameChanged.disconnectId(a.nameChangedId),t instanceof $t&&(t.boundingChanged.disconnectId(a.bboxChangedId),t.visibilityChanged.disconnectId(a.visChangedId)),this.__childItems.splice(e,1),this.__childItemsSignalIds.splice(e,1),delete this.__childItemsMapping[t.getName()],this.__updateMapping(e),t instanceof $t&&this._setBoundingBoxDirty(),this.childRemoved.emit(t,e);}removeChild(e){const t=this.__childItems[e];t&&(this.__unbindChild(e,t),t.setOwner(void 0));}removeChildByName(e){const t=this.__childItemsMapping[e];return null!=t?this.removeChild(t):null}removeChildByHandle(e){console.warn("Deprecated method. Please use removeChild");const t=this.__childItems.indexOf(e);if(-1==t)throw new Error("Error in removeChildByHandle. Child not found:"+e.getName());this.removeChild(t);}removeAllChildren(){let e=this.__childItems.length;for(;e--;)this.removeChild(e);this._setBoundingBoxDirty();}getChildIndex(e){return this.__childItems.indexOf(e)}indexOfChild(e){return console.warn("Deprecated method. Please use getChildIndex"),this.getChildIndex(e)}addComponent(e){this.__components.push(e),this.__componentMapping[e.getName()]=this.__components.length-1,e.setOwner(this);}removeComponent(e){const t=this.__componentMapping[e];if(null==t)throw new Error("Component not found:"+e);const a=this.__components[t];a.setOwner(void 0),this.__components.splice(t,1);const i={};for(let e=0;e<this.__components.length;e++)i[this.__components[e].getName()]=e;return this.__componentMapping=i,a}hasComponent(e){return e in this.__componentMapping}getComponent(e){if(e in this.__componentMapping)return this.__components[this.__componentMapping[e]];console.log("No component named '"+e+"' found.");}resolvePath(e,t=0){if("string"==typeof e&&(e=e.split("/")),0==t)if("."==e[0]||e[0]==this.__name)t++;else if(".."==e[0])return this.__ownerItem.resolvePath(e,t+1);if(t==e.length)return this;if(">"==e[t]&&t==e.length-2&&this.hasComponent(e[t+1])){return this.getComponent(e[t+1]).resolvePath(e,t+2)}const a=e[t],i=this.getChildByName(a);if(null==i){if(this.hasComponent(e[t])){const a=this.getComponent(e[t]);return t==e.length?a:a.resolvePath(e,t+1)}const a=this.getParameter(e[t]);return a||null}return i.resolvePath(e,t+1)}traverse(e,t=!0){const a=(e,t)=>{const a=e.getChildren();for(const e of a)e&&i(e,t+1);},i=(t,i)=>{if(0==e(t,i))return !1;a(t,i);};t?i(this,1):a(this,0);}onMouseDown(e){this.mouseDown.emit(e),e.propagating&&this.__ownerItem&&this.__ownerItem.onMouseDown(e);}onMouseUp(e){this.mouseUp.emit(e),e.propagating&&this.__ownerItem&&this.__ownerItem.onMouseUp(e);}onMouseMove(e){this.mouseMove.emit(e),e.propagating&&this.__ownerItem&&this.__ownerItem.onMouseMove(e);}onMouseEnter(e){this.mouseEnter.emit(e),e.propagating&&this.__ownerItem&&this.__ownerItem.onMouseEnter(e);}onMouseLeave(e){this.mouseLeave.emit(e),e.propagating&&this.__ownerItem&&this.__ownerItem.onMouseLeave(e);}onWheel(e){e.propagating&&this.__ownerItem&&this.__ownerItem.onWheel(e);}toJSON(e,t){if(!this.testFlag(k.USER_EDITED))return;const a=super.toJSON(e,t),i=[];for(const a of this.__components)i.push(a.toJSON(e,t));if(i.length>0&&(a.components=i),!(t&At.SAVE_FLAG_SKIP_CHILDREN)){const i={};for(const a of this.__childItems)if(a){const s=a.toJSON(e,t);s&&(i[a.getName()]=s);}Object.keys(i).length>0&&(a?a.children=i:a={name:this.__name,children:i});}return a}fromJSON(e,t,a){if(super.fromJSON(e,t,a),t.numTreeItems++,this.setFlag(k.USER_EDITED),null!=e.children){const i=e.children;if(Array.isArray(i))for(const e of i){let i=this.getChildByName(e.name);i?i.fromJSON(e,t,a):e.type&&(i=C.constructClass(e.type),i&&(i.fromJSON(e,t,a),this.addChild(i,!1,!1)));}else for(const e in i){const s=i[e];let n=this.getChildByName(e);n?n.fromJSON(s,t,a):s.type&&(n=C.constructClass(s.type),n&&(n.fromJSON(s,t,a),this.addChild(n,!1,!1)));}}if(e.components)for(const a of e.components){const e=C.constructClass(a.type?a.type:a.name);e&&(e.fromJSON(a,t),this.addComponent(e));}}readBinary(e,t){super.readBinary(e,t),t.numTreeItems++;const a=e.loadUInt8();if(4&a){const t=new X;t.tr=e.loadFloat32Vec3(),t.ori=e.loadFloat32Quat(),t.sc.set(e.loadFloat32()),this.__localXfoParam.setValue(t,N.DATA_LOAD);}8&a&&this.__boundingBoxParam.setValue(new V(e.loadFloat32Vec3(),e.loadFloat32Vec3()),N.DATA_LOAD);const i=e.loadUInt32();if(i>0){const a=e.loadUInt32Array(i);for(let s=0;s<i;s++){e.seek(a[s]);let i=e.loadStr();if(i.startsWith("N")&&i.endsWith("E")){const e=i.indexOf("podium");-1!=e&&(i=parseInt(i[e+7])?i.substring(e+8,i.length-1):i.substring(e+7,i.length-1)),-1!=i.indexOf("livenurbs")&&(i=i.substring(i.indexOf("CAD"),i.length-1));}const n=C.constructClass(i);if(n)e.seek(a[s]),n.readBinary(e,t),n.setFlag(k.BIN_NODE),this.addChild(n,!1,!1);else {const t=e.loadStr();console.warn("Unable to construct child:"+t+" of type:"+i);}}}}clone(e){const t=new $t;return t.copyFrom(this,e),t}copyFrom(e,t){super.copyFrom(e,t),e.getChildren().forEach(e=>{e&&this.addChild(e.clone(t),!1,!1);});}destroy(){this.removeAllChildren(),super.destroy();}}C.registerClass("TreeItem",$t);class ea extends $t{constructor(e){super(e);}setSrcTree(e,t){if(this.__srcTree=e,0==this.__srcTree.getNumChildren()){const e=this.__srcTree.clone(t);e.setLocalXfo(new X,N.DATA_LOAD),this.addChild(e,!1);}else {this.__srcTree.getChildren().forEach(e=>{const a=e.clone(t);this.addChild(a,!1);});}}getSrcTree(){return this.__srcTree}readBinary(e,t={}){super.readBinary(e,t);const a=e.loadStrArray();t.resolvePath(a,e=>{this.setSrcTree(e,t);});}toJSON(e={},t=0){return super.toJSON(e,t)}fromJSON(e,t={},a=0,i){}}C.registerClass("InstanceItem",ea);class ta extends $t{constructor(e){super(e),this.__loaded=!1,this.audioSourceCreated=new S;const t=this.addParameter(new Re("FilePath"));let a,i;const s=()=>{a=window.ZeaAudioaudioCtx.createBufferSource(),a.buffer=i,a.loop=o.getValue(),a.muted=r.getValue(),a.start(0),this.audioSourceCreated.emit(a);};t.valueChanged.connect(()=>{const e=new XMLHttpRequest;e.open("GET",t.getURL(),!0),e.responseType="arraybuffer",e.onload=()=>{const t=e.response;window.ZeaAudioaudioCtx.decodeAudioData(t,e=>{i=e,this.__loaded=!0,this.loaded.emit(!0),n.getValue()&&s();},e=>{console.log("Error with decoding audio data"+e.err);});},e.send();});const n=this.addParameter(new pe("Autoplay",!1)),l=this.addParameter(new ue("PlayState",0));l.valueChanged.connect(e=>{if(e!=N.CUSTOM)switch(l.getValue()){case 0:this.__loaded&&a&&(a.stop(0),a=void 0);break;case 1:this.__loaded&&s();}}),this.isPlaying=()=>0!=l.getValue(),this.play=()=>{l.setValue(1,N.CUSTOM);},this.stop=()=>{l.setValue(0,N.CUSTOM);},this.pause=()=>{l.setValue(0,N.CUSTOM);},this.getAudioSource=()=>a;const r=this.addParameter(new pe("Mute",!1));this.addParameter(new ue("Gain",1)).setRange([0,5]);const o=this.addParameter(new pe("Loop",!1));this.addParameter(new pe("SpatializeAudio",!0)),this.addParameter(new ue("refDistance",2)),this.addParameter(new ue("maxDistance",1e4)),this.addParameter(new ue("rolloffFactor",1)),this.addParameter(new ue("coneInnerAngle",360)),this.addParameter(new ue("coneOuterAngle",0)),this.addParameter(new ue("coneOuterGain",1)),r.valueChanged.connect(()=>{a&&(a.muted=r.getValue());}),o.valueChanged.connect(()=>{a&&(a.loop=o.getValue());}),this.mute=e=>{r.setValue(e,N.CUSTOM);},this.loaded=new S(!0),this.loaded.setToggled(!1);}isLoaded(){return this.__loaded}setAudioStream(){this.__loaded=!0,this.loaded.emit(),this.audioSourceCreated.emit(audioSource);}}class aa extends ta{constructor(e){}}class ia extends $t{constructor(e){super(e),this.overlay=!1,this.__cutAway=!1,this.__cutAwayVector=!1,this.__cutAwayDist=!1,this.cutAwayChanged=new S,this.__layers=[];}setOverlay(e){this.overlay=e;}isOverlay(){return this.overlay}addLayer(e){this.__layers.push(e);}getLayers(){return this.__layers}isCutawayEnabled(){return this.__cutAway}setCutawayEnabled(e){this.__cutAway=e,this.cutAwayChanged.emit();}getCutVector(){return this.__cutAwayVector}setCutVector(e){this.__cutAwayVector=e,this.cutAwayChanged.emit();}getCutDist(){return this.__cutAwayDist}setCutDist(e){this.__cutAwayDist=e,this.cutAwayChanged.emit();}readBinary(e,t){if(super.readBinary(e,t),t.versions["zea-engine"].greaterOrEqualThan([0,0,4])){const a=e.loadStr();let i=t.assetItem.getMaterialLibrary().getMaterial(a,!1);if(i||(i=new Ke(a,"SimpleSurfaceShader"),i.getParameter("BaseColor").setValue(u.random(.25),N.DATA_LOAD),t.assetItem.getMaterialLibrary().addMaterial(i)),this.setMaterial(i,N.DATA_LOAD),this.__layers=e.loadStrArray(),this.__layers.length>0)for(const e of this.__layers)t.addGeomToLayer(this,e);}}}class sa extends ia{constructor(e,t,a){super(e),this.__geomParam=this.insertParameter(new Fe("geometry"),0),this.__geomParam.valueChanged.connect(this._setBoundingBoxDirty.bind(this)),this.__geomParam.boundingBoxDirtied.connect(this._setBoundingBoxDirty.bind(this)),this.__materialParam=this.insertParameter(new Rt("Material"),1),this.__paramMapping.material=this.getParameterIndex(this.__materialParam),this.__lightmapCoordOffset=new o,this.__geomOffsetXfoParam=this.addParameter(new fe("GeomOffsetXfo")),this.__geomMatParam=this.addParameter(new ye("GeomMat")),this.__cleanGeomMat=this.__cleanGeomMat.bind(this),this.__globalXfoParam.valueChanged.connect(e=>{this.__geomMatParam.setDirty(this.__cleanGeomMat);}),this.__geomOffsetXfoParam.valueChanged.connect(e=>{this.__geomMatParam.setDirty(this.__cleanGeomMat);}),this.geomXfoChanged=this.__geomMatParam.valueChanged,this.materialAssigned=this.__materialParam.valueChanged,this.geomAssigned=this.__geomParam.valueChanged,t&&this.setGeometry(t,N.DATA_LOAD),a&&this.setMaterial(a,N.DATA_LOAD);}__cleanGeomMat(){const e=this.__globalXfoParam.getValue().toMat4(),t=this.__geomOffsetXfoParam.getValue().toMat4();return e.multiply(t)}getGeometry(){return this.__geomParam.getValue()}setGeometry(e,t){this.__geomParam.setValue(e,t);}getGeom(){return console.warn("getGeom is deprectated. Please use 'getGeometry'"),this.getGeometry()}setGeom(e){return console.warn("setGeom is deprectated. Please use 'setGeometry'"),this.setGeometry(e)}getMaterial(){return this.__materialParam.getValue()}setMaterial(e,t){this.__materialParam.setValue(e,t);}_cleanBoundingBox(e){e=super._cleanBoundingBox(e);const t=this.getGeometry();return t&&e.addBox3(t.boundingBox,this.getGeomMat4()),e}getGeomOffsetXfo(){return this.__geomOffsetXfoParam.getValue()}setGeomOffsetXfo(e){this.__geomOffsetXfoParam.setValue(e);}getGeomMat4(){return this.__geomMatParam.getValue()}getLightmapName(){return this.__lightmapName}getLightmapCoordsOffset(){return this.__lightmapCoordOffset}applyAssetLightmapSettings(e,t){this.__lightmap=e,this.__lightmapCoordOffset.addInPlace(t);}toJSON(e,t){return super.toJSON(e,t)}fromJSON(e,t){super.fromJSON(e,t),t.numGeomItems++;}readBinary(e,t){super.readBinary(e,t),t.numGeomItems++,this.__lightmapName=t.assetItem.getName();const a=e.loadUInt8(),i=e.loadUInt32(),s=t.assetItem.getGeometryLibrary(),n=s.getGeom(i);if(n)this.setGeometry(n,N.DATA_LOAD);else {this.geomIndex=i;const e=e=>{if(i>=e[0]&&i<e[1]){const e=s.getGeom(i);e?this.setGeometry(e,N.DATA_LOAD):console.warn("Geom not loaded:",this.getName()),s.rangeLoaded.disconnectId(t);}},t=s.rangeLoaded.connect(e);}if(4&a&&this.__geomOffsetXfoParam.setValue(new X(e.loadFloat32Vec3(),e.loadFloat32Quat(),e.loadFloat32Vec3())),t.versions["zea-engine"].lessThan([0,0,4])){if(a&8){const a=t.assetItem.getMaterialLibrary(),i=e.loadStr();let s=a.getMaterial(i);s||(console.warn("Geom :'"+this.name+"' Material not found:"+i),s=a.getMaterial("Default")),this.setMaterial(s,N.DATA_LOAD);}else this.setMaterial(t.assetItem.getMaterialLibrary().getMaterial("Default"),N.DATA_LOAD);}this.__lightmapCoordOffset=e.loadFloat32Vec2();}toString(){return JSON.stringify(this.toJSON(),null,2)}clone(e){const t=new sa;return t.copyFrom(this,e),t}copyFrom(e,t){if(super.copyFrom(e,t),this.__lightmapCoordOffset=e.__lightmapCoordOffset,!e.getGeometry()&&-1!=e.geomIndex){const a=t.assetItem.getGeometryLibrary(),i=e.geomIndex,s=e=>{if(i>=e[0]&&i<e[1]){const e=a.getGeom(i);e?this.setGeometry(e,N.DATA_LOAD):console.warn("Geom not loaded:",this.getName()),a.rangeLoaded.disconnectId(n);}},n=a.rangeLoaded.connect(s);}this.__geomMatParam.setDirty(this.__cleanGeomMat);}destroy(){super.destroy();}}C.registerClass("GeomItem",sa);const na={manual:0,first:1,average:2,globalOri:3};class la extends $t{constructor(e){super(e),this.setFlag(k.USER_EDITED),this.calculatingGroupXfo=!1,this.dirty=!1,this.invGroupXfo=void 0,this.__initialXfos=[],this.__signalIndices=[];let t=0;this.__itemsParam=this.insertParameter(new ve("Items",e=>e instanceof $t),t++),this.__itemsParam.itemAdded.connect((e,t)=>{this.__bindItem(e,t);}),this.__itemsParam.itemRemoved.connect((e,t)=>{this.__unbindItem(e,t);}),this.__itemsParam.valueChanged.connect(()=>{this.calcGroupXfo(),this._setBoundingBoxDirty();}),this.__initialXfoModeParam=this.insertParameter(new be("InitialXfoMode",na.average,["manual","first","average","global"]),t++),this.__initialXfoModeParam.valueChanged.connect(()=>{this.calcGroupXfo();}),this.__highlightedParam=this.insertParameter(new pe("Highlighted",!1),t++),this.__highlightedParam.valueChanged.connect(()=>{this.__updateHighlight();}),this.__updateHighlight=this.__updateHighlight.bind(this),this.insertParameter(new Ge("HighlightColor",new u(.5,.5,1)),t++).valueChanged.connect(this.__updateHighlight),this.insertParameter(new ue("HighlightFill",0,[0,1]),t++).valueChanged.connect(this.__updateHighlight),this.__materialParam=this.insertParameter(new Rt("Material"),t++),this.__materialParam.valueChanged.connect(()=>{this.__updateMaterial();}),this.__updateCutaway=this.__updateCutaway.bind(this),this.insertParameter(new pe("CutAwayEnabled",!1),t++).valueChanged.connect(this.__updateCutaway),this.insertParameter(new _e("CutVector",new d(1,0,0)),t++).valueChanged.connect(this.__updateCutaway),this.insertParameter(new ue("CutDist",0),t++).valueChanged.connect(this.__updateCutaway),this.__globalXfoParam.valueChanged.connect(e=>{this.calculatingGroupXfo||this._propagateDirtyXfoToItems();});}static get INITIAL_XFO_MODES(){return na}__updateVisiblity(){if(super.__updateVisiblity()){const e=this.getVisible();return Array.from(this.__itemsParam.getValue()).forEach(t=>{t instanceof $t&&t.propagateVisiblity(e?1:-1);}),!0}return !1}__updateHighlight(){let e,t=!1;(this.getParameter("Highlighted").getValue()||this.isSelected())&&(t=!0,e=this.getParameter("HighlightColor").getValue(),e.a=this.getParameter("HighlightFill").getValue());const a="groupItemHighlight"+this.getId();Array.from(this.__itemsParam.getValue()).forEach(i=>{i instanceof $t&&(t?i.addHighlight(a,e,!0):i.removeHighlight(a,!0));});}setSelected(e){super.setSelected(e),this.__updateHighlight();}_setGlobalXfoDirty(){super._setGlobalXfoDirty();}calcGroupXfo(){const e=Array.from(this.__itemsParam.getValue());if(0==e.length)return new X;this.calculatingGroupXfo=!0;const t=this.__initialXfoModeParam.getValue();let a;if(t==na.manual)return this.invGroupXfo=this.getGlobalXfo().inverse(),void(this.calculatingGroupXfo=!1);if(t==na.first)a=this.__initialXfos[0];else if(t==na.average){a=new X,a.ori.set(0,0,0,0);let t=0;e.forEach((e,i)=>{e instanceof $t&&(a.tr.addInPlace(this.__initialXfos[i].tr),a.ori.addInPlace(this.__initialXfos[i].ori),t++);}),a.tr.scaleInPlace(1/t),a.ori.normalizeInPlace();}else {if(t!=na.globalOri)throw new Error("Invalid mode.");{a=new X;let t=0;e.forEach((e,i)=>{e instanceof $t&&(a.tr.addInPlace(this.__initialXfos[i].tr),t++);}),a.tr.scaleInPlace(1/t);}}this.setGlobalXfo(a,N.GENERATED_VALUE);const i=this.getGlobalXfo();this.invGroupXfo=i.inverse(),this.calculatingGroupXfo=!1;}_propagateDirtyXfoToItems(){if(this.calculatingGroupXfo)return;const e=Array.from(this.__itemsParam.getValue());if(!this.calculatingGroupXfo&&e.length>0&&this.invGroupXfo&&!this.dirty){let t;this.dirty=!0,this.propagatingXfoToItems=!0;const a=(e,a)=>{const i=e.getParameter("GlobalXfo");i.setDirty(()=>{if(!t){const e=this.__globalXfoParam.getValue();t=e.multiply(this.invGroupXfo),this.dirty=!1;}const e=t.multiply(a);i.setClean(e);});};e.forEach((e,t)=>{e instanceof $t&&a(e,this.__initialXfos[t]);}),this.propagatingXfoToItems=!1;}}__updateMaterial(){const e=this.getParameter("Material").getValue();Array.from(this.__itemsParam.getValue()).forEach(t=>{t.traverse(t=>{if(t instanceof $t&&t.hasParameter("Material")){const a=t.getParameter("Material");if(e){const t=a.getValue();t!=e&&(a.__backupMaterial=t,a.setValue(e,N.GENERATED_VALUE));}else a.__backupMaterial&&a.setValue(a.__backupMaterial,N.GENERATED_VALUE);}},!1);});}__updateCutaway(){const e=this.getParameter("CutAwayEnabled").getValue(),t=this.getParameter("CutVector").getValue(),a=this.getParameter("CutDist").getValue();Array.from(this.__itemsParam.getValue()).forEach(i=>{i.traverse(i=>{i instanceof ia&&(i.setCutawayEnabled(e),i.setCutVector(t),i.setCutDist(a));},!0);});}setPaths(e){this.clearItems(!1);const t=this.getOwner();if(null==t)return void console.warn("Group does not have an owner and so cannot resolve paths:",this.getName());const a=[];e.forEach(e=>{const i=t.resolvePath(e);i?a.push(i):console.warn("Path does not resolve to an Item:",e," group:",this.getName());}),this.setItems(a);}resolveItems(e){this.setPaths(e);}__bindItem(e,t){if(!(e instanceof $t))return;const a={};a.mouseDownIndex=e.mouseDown.connect(e=>{this.onMouseDown(e);}),a.mouseUpIndex=e.mouseUp.connect(e=>{this.onMouseUp(e);}),a.mouseMoveIndex=e.mouseMove.connect(e=>{this.onMouseMove(e);}),a.mouseEnterIndex=e.mouseEnter.connect(e=>{this.onMouseEnter(e);}),a.mouseLeaveIndex=e.mouseLeave.connect(e=>{this.onMouseLeave(e);});const i=this.getParameter("Material").getValue();if(i&&e.traverse(e=>{if(e instanceof $t&&e.hasParameter("Material")){const t=e.getParameter("Material");if(i){const e=t.getValue();e!=i&&(t.__backupMaterial=e,t.setValue(i,N.GENERATED_VALUE));}}},!0),e instanceof $t&&this.getParameter("Highlighted").getValue()){const t=this.getParameter("HighlightColor").getValue();t.a=this.getParameter("HighlightFill").getValue(),e.addHighlight("groupItemHighlight"+this.getId(),t,!0);}const s=this.getParameter("CutAwayEnabled").getValue();if(s){const t=this.getParameter("CutVector").getValue(),a=this.getParameter("CutDist").getValue();e.traverse(e=>{e instanceof ia&&(e.setCutawayEnabled(s),e.setCutVector(t),e.setCutDist(a));},!0);}this.getVisible()||e.propagateVisiblity(-1);const n=()=>{const e=this.__initialXfoModeParam.getValue();e==na.first&&0==t?this.calcGroupXfo():e!=na.average&&e!=na.globalOri||this.calcGroupXfo();};a.globalXfoChangedIndex=e.globalXfoChanged.connect(a=>{this.propagatingXfoToItems||(this.__initialXfos[t]=e.getGlobalXfo(),n());}),this.__initialXfos[t]=e.getGlobalXfo(),a.bboxChangedIndex=e.boundingChanged.connect(this._setBoundingBoxDirty),this.__signalIndices[t]=a,n();}__unbindItem(e,t){if(!(e instanceof $t))return;e.removeHighlight("branchselected"+this.getId(),!0),this.getParameter("Highlighted").getValue()&&e.removeHighlight("groupItemHighlight"+this.getId(),!0),this.getVisible()||e.propagateVisiblity(1),e.traverse(e=>{e instanceof ia&&e.setCutawayEnabled(!1);},!0);const a=this.__signalIndices[t];e.mouseDown.disconnectId(a.mouseDownIndex),e.mouseUp.disconnectId(a.mouseUpIndex),e.mouseMove.disconnectId(a.mouseMoveIndex),e.mouseEnter.disconnectId(a.mouseEnterIndex),e.mouseLeave.disconnectId(a.mouseLeaveIndex),e.globalXfoChanged.disconnectId(a.globalXfoChangedIndex),e.boundingChanged.disconnectId(a.bboxChangedIndex),this.__signalIndices.splice(t,1),this.__initialXfos.splice(t,1);}addItem(e,t=!0){e?this.__itemsParam.addItem(e,t):console.warn("Error adding item to group. Item is null");}removeItem(e,t=!0){this.__itemsParam.removeItem(e,t);}clearItems(e=!0){const t=Array.from(this.__itemsParam.getValue());for(let e=t.length-1;e>=0;e--)this.__unbindItem(t[e],e);this.__signalIndices=[],this.__initialXfos=[],this.__itemsParam.clearItems(e);}getItems(){return this.__itemsParam.getValue()}setItems(e){this.clearItems(!1),this.__itemsParam.setItems(e);}_cleanBoundingBox(e){const t=super._cleanBoundingBox(e);return Array.from(this.__itemsParam.getValue()).forEach(e=>{e instanceof $t&&e.getVisible()&&!e.testFlag(k.IGNORE_BBOX)&&t.addBox3(e.getBoundingBox());}),t}onMouseDown(e){super.onMouseDown(e);}onMouseUp(e){super.onMouseUp(e);}onMouseMove(e){super.onMouseMove(e);}toJSON(e,t){const a=super.toJSON(e,t),i=Array.from(this.__itemsParam.getValue()),s=[];return i.forEach(t=>{const a=t.getPath();s.push(e?e.makeRelative(a):a);}),a.treeItems=s,a}fromJSON(e,t,a){if(super.fromJSON(e,t,a),this.setFlag(k.USER_EDITED),!e.treeItems)return void console.warn("Invalid Parameter JSON");let i=e.treeItems.length;const s=e=>{t.resolvePath(e,e=>{this.addItem(e),i--,0==i&&(this.calculatingGroupXfo=!0,this.calcGroupXfo(),this.calculatingGroupXfo=!1);},t=>{console.warn("Group: '"+this.getName()+"'. Unable to load item:"+e);});};for(const t of e.treeItems)s(t);}clone(e){const t=new la;return t.copyFrom(this,e),t}copyFrom(e,t){super.copyFrom(e,t);}destroy(){super.destroy();}}C.registerClass("Group",la);const ra=ie("Lyogcm9sbHVwLXBsdWdpbi13ZWItd29ya2VyLWxvYWRlciAqLwpjb25zdCB0PU1hdGguUEkvMTgwO01hdGguSEFMRl9QST0uNSpNYXRoLlBJLE1hdGguVFdPX1BJPTIqTWF0aC5QSTtNYXRoLnJhZFRvRGVnPWZ1bmN0aW9uKGUpe3JldHVybiBlL3R9LE1hdGguZGVnVG9SYWQ9ZnVuY3Rpb24oZSl7cmV0dXJuIGUqdH0sTnVtYmVyLmlzTnVtZXJpYz10PT4haXNOYU4ocGFyc2VGbG9hdCh0KSkmJmlzRmluaXRlKHQpLFN0cmluZy5wcm90b3R5cGUucmVwbGFjZUFsbD1mdW5jdGlvbih0LGUpe3JldHVybiB0aGlzLnJlcGxhY2UobmV3IFJlZ0V4cCh0LCJnIiksZSl9O2Z1bmN0aW9uIGUodCxlPTAscz01KXtyZXR1cm4gSlNPTi5zdHJpbmdpZnkodCwoZnVuY3Rpb24odCxlKXtyZXR1cm4gZSYmZS50b0ZpeGVkP051bWJlcihlLnRvRml4ZWQocykpOmV9KSxlKX1TdHJpbmcucHJvdG90eXBlLmhhc2g9ZnVuY3Rpb24oKXtyZXR1cm4gZnVuY3Rpb24odCl7bGV0IGUscyxhLGk9MDtpZigwPT09dC5sZW5ndGgpcmV0dXJuIGk7Zm9yKGU9MCxhPXQubGVuZ3RoO2U8YTtlKyspcz10LmNoYXJDb2RlQXQoZSksaT0oaTw8NSktaStzLGl8PTA7cmV0dXJuIE1hdGguYWJzKGkpfSh0aGlzKX0sU3RyaW5nLnByb3RvdHlwZS50cmltPWZ1bmN0aW9uKCl7cmV0dXJuIHRoaXMucmVwbGFjZSgvXlxzK3xccyskL2csIiIpfSxTdHJpbmcucHJvdG90eXBlLmx0cmltPWZ1bmN0aW9uKCl7cmV0dXJuIHRoaXMucmVwbGFjZSgvXlxzKy8sIiIpfSxTdHJpbmcucHJvdG90eXBlLnJ0cmltPWZ1bmN0aW9uKCl7cmV0dXJuIHRoaXMucmVwbGFjZSgvXHMrJC8sIiIpfSxTdHJpbmcucHJvdG90eXBlLmxwYWQ9ZnVuY3Rpb24odCxlKXtsZXQgcz10aGlzO2Zvcig7cy5sZW5ndGg8ZTspcz10K3M7cmV0dXJuIHN9LFN0cmluZy5wcm90b3R5cGUucnBhZD1mdW5jdGlvbih0LGUpe2xldCBzPXRoaXM7Zm9yKDtzLmxlbmd0aDxlOylzKz10O3JldHVybiBzfSxNYXRoLnJhbmRvbUludD1mdW5jdGlvbih0LGUpe3JldHVybiB0PU1hdGguY2VpbCh0KSxlPU1hdGguZmxvb3IoZSksTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpKihlLXQpKSt0fSxNYXRoLmxlcnA9KHQsZSxzKT0+dCtzKihlLXQpLE1hdGguY2xhbXA9ZnVuY3Rpb24odCxlLHMpe3JldHVybiBNYXRoLm1pbihNYXRoLm1heCh0LGUpLHMpfSxNYXRoLm5lYXJlc3RQb3cyPWZ1bmN0aW9uKHQpe3JldHVybiBNYXRoLnBvdygyLE1hdGgucm91bmQoTWF0aC5sb2codCkvTWF0aC5sb2coMikpKX0sTWF0aC5uZWFyZXN0UG93MTA9ZnVuY3Rpb24odCl7cmV0dXJuIE1hdGgucG93KDEwLE1hdGgucm91bmQoTWF0aC5sb2cxMCh0KS9NYXRoLmxvZzEwKDEwKSkpfSxNYXRoLm5leHRQb3cyPWZ1bmN0aW9uKHQpe2xldCBlPTA7Zm9yKDt0PjA7KWUrKyx0Pj49MTtyZXR1cm4gMTw8ZX0sTWF0aC5mcmFjdD1mdW5jdGlvbih0KXtyZXR1cm4gMD09dD8wOnQ8MD90Pi0xPy10Oi10JU1hdGguZmxvb3IoLXQpOnQ8MT90OnQlTWF0aC5mbG9vcih0KX0sTWF0aC5yZW1hcD1mdW5jdGlvbih0LGUscyxhLGkpe3JldHVybiBhKyh0LWUpLyhzLWUpKihpLWEpfSxNYXRoLmNvbnZlcnRGbG9hdDMyQXJyYXlUb1VJbnQxNkFycmF5PWZ1bmN0aW9uKHQpe2NvbnN0IGU9bmV3IFVpbnQxNkFycmF5KHQubGVuZ3RoKSxzPW5ldyBJbnQzMkFycmF5KHQuYnVmZmVyKSxhPXQ9PntsZXQgZT10Pj4xNiYzMjc2OCxzPXQ+PjEyJjIwNDc7Y29uc3QgYT10Pj4yMyYyNTU7cmV0dXJuIGE8MTAzP2U6YT4xNDI/KGV8PTMxNzQ0LGV8PSgyNTU9PWE/MDoxKSYmODM4ODYwNyZ0LGUpOmE8MTEzPyhzfD0yMDQ4LGV8PShzPj4xMTQtYSkrKHM+PjExMy1hJjEpLGUpOihlfD1hLTExMjw8MTB8cz4+MSxlKz0xJnMsZSl9O2ZvcihsZXQgaT0wO2k8dC5sZW5ndGg7aSsrKWVbaV09YShzW2ldKTtyZXR1cm4gZX0sTWF0aC5kZWNvZGUxNkJpdEZsb2F0RnJvbTJ4VUludDg9dD0+e2NvbnN0IGU9dFswXSxzPSgxMjAmZSk+PjM7bGV0IGE9MD09cz8wOjIwNDg7Y29uc3QgaT1hKygoNyZlKTw8OCkrdFsxXTtyZXR1cm4gYT0wPT1zPzE6MCwoMTI4JmU/MTotMSkqaSpNYXRoLnBvdygyLHMrYS0xNil9LE1hdGguZW5jb2RlMTZCaXRGbG9hdEludG8yeFVJbnQ4PXQ9PntjfHwoYz1uZXcgVWludDhBcnJheSgyKSk7Y29uc3QgZT10Pj0wPzEyODowO3Q9TWF0aC5hYnModCk7bGV0IHMsYT0xNSxpPTEwMjQ7Zm9yKGxldCBlPTE1O2U+MDtlLS0pdDxpJiYoaS89MixhLS0pO3M9MD09YT90L2kvMjoodC1pKS9pO2NvbnN0IHI9TWF0aC5yb3VuZCgyMDQ4KnMpLG49ci8yNTYsaD1yLTI1NipuO3JldHVybiBjWzBdPWUrOCphK24sY1sxXT1oLHQ+PTIwNDgmJihjWzBdPTI1NSksY30sTWF0aC5lbmNvZGUxNkJpdEZsb2F0PXQ9Pntjb25zdCBlPW5ldyBGbG9hdDMyQXJyYXkoMSk7ZVswXT10O3JldHVybih0PT57bGV0IGU9dD4+MTYmMzI3Njgscz10Pj4xMiYyMDQ3O2NvbnN0IGE9dD4+MjMmMjU1O3JldHVybiBhPDEwMz9lOmE+MTQyPyhlfD0zMTc0NCxlfD0oMjU1PT1hPzA6MSkmJjgzODg2MDcmdCxlKTphPDExMz8oc3w9MjA0OCxlfD0ocz4+MTE0LWEpKyhzPj4xMTMtYSYxKSxlKTooZXw9YS0xMTI8PDEwfHM+PjEsZSs9MSZzLGUpfSkobmV3IEludDMyQXJyYXkoZS5idWZmZXIpWzBdKX0sTWF0aC5kZWNvZGUxNkJpdEZsb2F0PXQ9Pntjb25zdCBlPSgzMjc2OCZ0KT4+MTUscz0oMzE3NDQmdCk+PjEwLGE9MTAyMyZ0O3JldHVybiAwPT1zPyhlPy0xOjEpKk1hdGgucG93KDIsLTE0KSooYS9NYXRoLnBvdygyLDEwKSk6MzE9PXM/YT9OYU46MS8wKihlPy0xOjEpOihlPy0xOjEpKk1hdGgucG93KDIscy0xNSkqKDErYS9NYXRoLnBvdygyLDEwKSl9LE1hdGguc21vb3RoU3RlcD0odCxlLHMpPT57Y29uc3QgYT1NYXRoLmNsYW1wKChzLXQpLyhlLXQpLDAsMSk7cmV0dXJuIGEqYSooMy0yKmEpfSxNYXRoLmxpblN0ZXA9KHQsZSxzKT0+TWF0aC5jbGFtcCgocy10KS8oZS10KSwwLDEpO2NsYXNzIHN7aXNWYWxpZCgpe2Zvcihjb25zdCB0IG9mIHRoaXMuX19kYXRhKWlmKHQ9PTEvMHx8aXNOYU4odCkpcmV0dXJuITE7cmV0dXJuITB9c3RhdGljIGNyZWF0ZUZyb21GbG9hdDMyQnVmZmVyKHQsZSl7dGhyb3cgbmV3IEVycm9yKCJOb3QgeWV0IGltcGxlbWVudGVkIGZvciB0aGlzIHR5cGU6Iit0aGlzLmNvbnN0cnVjdG9yLm5hbWUpfXN0YXRpYyBudW1FbGVtZW50cygpe3Rocm93IG5ldyBFcnJvcigiTm90IHlldCBpbXBsZW1lbnRlZCBmb3IgdGhpcyB0eXBlOiIrdGhpcy5jb25zdHJ1Y3Rvci5uYW1lKX1hc0FycmF5KCl7cmV0dXJuIHRoaXMuX19kYXRhfXRvU3RyaW5nKCl7cmV0dXJuIGUodGhpcy50b0pTT04oKSl9fWNvbnN0IGE9bmV3IGNsYXNze2NvbnN0cnVjdG9yKCl7dGhpcy5fX3R5cGVzPXt9LHRoaXMuX19uYW1lcz17fSx0aGlzLnJlZ2lzdGVyVHlwZSgiU0ludDMyIiw1KSx0aGlzLnJlZ2lzdGVyVHlwZSgiVUludDMyIiw0KSx0aGlzLnJlZ2lzdGVyVHlwZSgiRmxvYXQzMiIsNil9cmVnaXN0ZXJUeXBlKHQsZSl7dGhpcy5fX3R5cGVzW3RdPWUsZS5uYW1lP3RoaXMuX19uYW1lc1tlLm5hbWVdPXQ6dGhpcy5fX25hbWVzW2VdPXR9Z2V0VHlwZSh0KXtyZXR1cm4gdGhpcy5fX3R5cGVzW3RdfWdldFR5cGVOYW1lKHQpe2lmKHRoaXMuX19uYW1lc1t0XSlyZXR1cm4gdGhpcy5fX25hbWVzW3RdO2lmKHRoaXMuX19uYW1lc1t0Lm5hbWVdKXJldHVybiB0aGlzLl9fbmFtZXNbdC5uYW1lXTt0aHJvdyB0fX07Y2xhc3MgaSBleHRlbmRzIHN7Y29uc3RydWN0b3IodD0wLGU9MCl7aWYoc3VwZXIoKSx0IGluc3RhbmNlb2YgRmxvYXQzMkFycmF5fHx0IGluc3RhbmNlb2YgVWludDMyQXJyYXl8fHQgaW5zdGFuY2VvZiBJbnQzMkFycmF5KXRoaXMuX19kYXRhPXQ7ZWxzZSBpZih0IGluc3RhbmNlb2YgQXJyYXlCdWZmZXIpe2NvbnN0IHM9dCxhPWU7dGhpcy5fX2RhdGE9bmV3IEZsb2F0MzJBcnJheShzLGEsMil9ZWxzZSBudWxsIT10JiYib2JqZWN0Ij09dHlwZW9mIHQ/KHRoaXMuX19kYXRhPW5ldyBGbG9hdDMyQXJyYXkoMiksdGhpcy5mcm9tSlNPTih0KSk6KHRoaXMuX19kYXRhPW5ldyBGbG9hdDMyQXJyYXkoMiksdGhpcy5fX2RhdGFbMF09dCx0aGlzLl9fZGF0YVsxXT1lKX1nZXQgeCgpe3JldHVybiB0aGlzLl9fZGF0YVswXX1zZXQgeCh0KXt0aGlzLl9fZGF0YVswXT10fWdldCB5KCl7cmV0dXJuIHRoaXMuX19kYXRhWzFdfXNldCB5KHQpe3RoaXMuX19kYXRhWzFdPXR9c2V0KHQsZSl7dGhpcy5fX2RhdGFbMF09dCx0aGlzLl9fZGF0YVsxXT1lfXNldEZyb21PdGhlcih0KXt0aGlzLng9dC54LHRoaXMueT10Lnl9ZXF1YWwodCl7cmV0dXJuIHRoaXMueD09dC54JiZ0aGlzLnk9PXQueX1ub3RFcXVhbHModCl7cmV0dXJuIHRoaXMueCE9dC54JiZ0aGlzLnkhPXQueX1hcHByb3hFcXVhbCh0LGU9TnVtYmVyLkVQU0lMT04pe3JldHVybiBNYXRoLmFicyh0aGlzLngtdC54KTxlJiZNYXRoLmFicyh0aGlzLnktdC55KTxlfWFkZCh0KXtyZXR1cm4gbmV3IGkodGhpcy54K3QueCx0aGlzLnkrdC55KX1hZGRJblBsYWNlKHQpe3RoaXMueCs9dC54LHRoaXMueSs9dC55fXN1YnRyYWN0KHQpe3JldHVybiBuZXcgaSh0aGlzLngtdC54LHRoaXMueS10LnkpfXN1YnRyYWN0SW5QbGFjZSh0KXtyZXR1cm4gdGhpcy54LT10LngsdGhpcy55LT10LnksdGhpc31zY2FsZSh0KXtyZXR1cm4gbmV3IGkodGhpcy54KnQsdGhpcy55KnQpfXNjYWxlSW5QbGFjZSh0KXt0aGlzLngqPXQsdGhpcy55Kj10fWludmVydCgpe3JldHVybiBuZXcgaSgxL3RoaXMueCwxL3RoaXMueSl9aW52ZXJ0SW5QbGFjZSgpe3JldHVybiB0aGlzLng9MS90aGlzLngsdGhpcy55PTEvdGhpcy55LHRoaXN9bXVsdGlwbHkodCl7cmV0dXJuIG5ldyBpKHRoaXMueCp0LngsdGhpcy55KnQueSl9bXVsdGlwbHlJblBsYWNlKHQpe3RoaXMueCo9dC54LHRoaXMueSo9dC55fWxlbmd0aFNxdWFyZWQoKXtjb25zdCB0PXRoaXMuX19kYXRhWzBdLGU9dGhpcy5fX2RhdGFbMV07cmV0dXJuIHQqdCtlKmV9bGVuZ3RoKCl7cmV0dXJuIE1hdGguc3FydCh0aGlzLmxlbmd0aFNxdWFyZWQoKSl9ZGlzdGFuY2VUbyh0KXtjb25zdCBlPXRoaXMuX19kYXRhWzBdLXQueCxzPXRoaXMuX19kYXRhWzFdLXQueTtyZXR1cm4gTWF0aC5zcXJ0KGUqZStzKnMpfW5vcm1hbGl6ZSgpe2NvbnN0IHQ9dGhpcy5fX2RhdGFbMF0sZT10aGlzLl9fZGF0YVsxXTtsZXQgcz10KnQrZSplO3JldHVybiBzPE51bWJlci5FUFNJTE9OP25ldyBpOihzPTEvTWF0aC5zcXJ0KHMpLG5ldyBpKHQqcyxlKnMpKX1ub3JtYWxpemVJblBsYWNlKCl7Y29uc3QgdD10aGlzLl9fZGF0YVswXSxlPXRoaXMuX19kYXRhWzFdO2xldCBzPXQqdCtlKmU7czxOdW1iZXIuRVBTSUxPTnx8KHM9MS9NYXRoLnNxcnQocyksdGhpcy5zZXQodCpzLGUqcykpfWRvdCh0KXtyZXR1cm4gdGhpcy54KnQueCt0aGlzLnkqdC55fWNyb3NzKHQpe3JldHVybiB0aGlzLngqdC55LXRoaXMueSp0Lnh9YW5nbGVUbyh0KXtjb25zdCBlPXRoaXMubm9ybWFsaXplKCkuZG90KHQubm9ybWFsaXplKCkpO3JldHVybiBlPjE/MDplPC0xP01hdGguUEk6TWF0aC5hY29zKGUpfXNpZ25lZEFuZ2xlVG8odCl7Y29uc3QgZT10aGlzLmFuZ2xlVG8odCk7cmV0dXJuIHRoaXMuY3Jvc3ModCk8MD8tZTplfXJvdGF0ZSh0KXtjb25zdCBlPU1hdGguY29zKHQpLHM9TWF0aC5zaW4odCk7cmV0dXJuIG5ldyBpKHRoaXMueCplLXRoaXMueSpzLHRoaXMueCpzK3RoaXMueSplKX1sZXJwKHQsZSl7Y29uc3Qgcz10aGlzLngsYT10aGlzLnk7cmV0dXJuIG5ldyBpKHMrZSoodC54LXMpLGErZSoodC55LWEpKX1zZXRSYW5kb21EaXIodD0xKXtjb25zdCBlPTIqTWF0aC5yYW5kb20oKSpNYXRoLlBJO3JldHVybiB0aGlzLl9fZGF0YVswXT1NYXRoLmNvcyhlKSp6U2NhbGUsdGhpcy5fX2RhdGFbMV09TWF0aC5zaW4oZSkqelNjYWxlLHRoaXN9c2V0UmFuZG9tKHQ9MSl7cmV0dXJuIHRoaXMuX19kYXRhWzBdPU1hdGgucmFuZG9tKCkqdCx0aGlzLl9fZGF0YVsxXT1NYXRoLnJhbmRvbSgpKnQsdGhpc31jbG9uZSgpe3JldHVybiBuZXcgaSh0aGlzLl9fZGF0YVswXSx0aGlzLl9fZGF0YVsxXSl9YXNBcnJheSgpe3JldHVybiB0aGlzLl9fZGF0YX1zdGF0aWMgY3JlYXRlKC4uLnQpe3JldHVybiBuZXcgaSguLi50KX1zdGF0aWMgY3JlYXRlRnJvbUZsb2F0MzJCdWZmZXIodCxlPTApe3JldHVybiBuZXcgaSh0LDQqZSl9c3RhdGljIGNyZWF0ZUZyb21GbG9hdDMyQXJyYXkodCl7cmV0dXJuIG5ldyBpKHQpfXN0YXRpYyBudW1FbGVtZW50cygpe3JldHVybiAyfXRvSlNPTigpe3JldHVybnt4OnRoaXMueCx5OnRoaXMueX19ZnJvbUpTT04odCl7dGhpcy54PXQueCx0aGlzLnk9dC55fX1hLnJlZ2lzdGVyVHlwZSgiVmVjMiIsaSk7Y2xhc3MgciBleHRlbmRzIHN7Y29uc3RydWN0b3IodD0wLGU9MCxzPTApe2lmKHN1cGVyKCksdCBpbnN0YW5jZW9mIEZsb2F0MzJBcnJheXx8dCBpbnN0YW5jZW9mIFVpbnQzMkFycmF5KXRoaXMuX19kYXRhPXQ7ZWxzZSBpZih0IGluc3RhbmNlb2YgQXJyYXlCdWZmZXIpe2NvbnN0IHM9dCxhPWU7dGhpcy5fX2RhdGE9bmV3IEZsb2F0MzJBcnJheShzLGEsMyl9ZWxzZSBudWxsIT10JiYib2JqZWN0Ij09dHlwZW9mIHQ/KHRoaXMuX19kYXRhPW5ldyBGbG9hdDMyQXJyYXkoMyksdGhpcy5mcm9tSlNPTih0KSk6KHRoaXMuX19kYXRhPW5ldyBGbG9hdDMyQXJyYXkoMyksdGhpcy5fX2RhdGFbMF09dCx0aGlzLl9fZGF0YVsxXT1lLHRoaXMuX19kYXRhWzJdPXMpfWdldCB4KCl7cmV0dXJuIHRoaXMuX19kYXRhWzBdfXNldCB4KHQpe3RoaXMuX19kYXRhWzBdPXR9Z2V0IHkoKXtyZXR1cm4gdGhpcy5fX2RhdGFbMV19c2V0IHkodCl7dGhpcy5fX2RhdGFbMV09dH1nZXQgeigpe3JldHVybiB0aGlzLl9fZGF0YVsyXX1zZXQgeih0KXt0aGlzLl9fZGF0YVsyXT10fWdldCB4eSgpe3JldHVybiBuZXcgaSh0aGlzLl9fZGF0YVswXSx0aGlzLl9fZGF0YVsxXSl9Z2V0IHl6KCl7cmV0dXJuIG5ldyBpKHRoaXMuX19kYXRhWzFdLHRoaXMuX19kYXRhWzJdKX1zZXQodCxlLHMpe3RoaXMueD10LHRoaXMueT12b2lkIDAhPT1lP2U6dCx0aGlzLno9dm9pZCAwIT09cz9zOnR9c2V0RGF0YUFycmF5KHQpe3RoaXMuX19kYXRhPXR9c2V0RnJvbU90aGVyKHQpe3RoaXMueD10LngsdGhpcy55PXQueSx0aGlzLno9dC56fWlzTnVsbCgpe3JldHVybiBNYXRoLmFicyh0aGlzLngpPE51bWJlci5FUFNJTE9OJiZNYXRoLmFicyh0aGlzLnkpPE51bWJlci5FUFNJTE9OJiZNYXRoLmFicyh0aGlzLnopPE51bWJlci5FUFNJTE9OfWlzMTExKCl7cmV0dXJuIE1hdGguYWJzKDEtdGhpcy54KTxOdW1iZXIuRVBTSUxPTiYmTWF0aC5hYnMoMS10aGlzLnkpPE51bWJlci5FUFNJTE9OJiZNYXRoLmFicygxLXRoaXMueik8TnVtYmVyLkVQU0lMT059ZXF1YWwodCl7cmV0dXJuIHRoaXMueD09dC54JiZ0aGlzLnk9PXQueSYmdGhpcy56PT10Lnp9bm90RXF1YWxzKHQpe3JldHVybiB0aGlzLnghPXQueCYmdGhpcy55IT10LnkmJnRoaXMueiE9dC56fWFwcHJveEVxdWFsKHQsZT1OdW1iZXIuRVBTSUxPTil7cmV0dXJuIE1hdGguYWJzKHRoaXMueC10LngpPGUmJk1hdGguYWJzKHRoaXMueS10LnkpPGUmJk1hdGguYWJzKHRoaXMuei10LnopPGV9YWRkKHQpe3JldHVybiBuZXcgcih0aGlzLngrdC54LHRoaXMueSt0LnksdGhpcy56K3Queil9YWRkSW5QbGFjZSh0KXt0aGlzLngrPXQueCx0aGlzLnkrPXQueSx0aGlzLnorPXQuen1zdWJ0cmFjdCh0KXtyZXR1cm4gbmV3IHIodGhpcy54LXQueCx0aGlzLnktdC55LHRoaXMuei10LnopfXN1YnRyYWN0SW5QbGFjZSh0KXt0aGlzLngtPXQueCx0aGlzLnktPXQueSx0aGlzLnotPXQuen1tdWx0aXBseSh0KXtyZXR1cm4gbmV3IHIodGhpcy54KnQueCx0aGlzLnkqdC55LHRoaXMueip0LnopfW11bHRpcGx5SW5QbGFjZSh0KXt0aGlzLngqPXQueCx0aGlzLnkqPXQueSx0aGlzLnoqPXQuen1kaXZpZGUodCl7cmV0dXJuIG5ldyByKHRoaXMueC90LngsdGhpcy55L3QueSx0aGlzLnovdC56KX1kaXZpZGVJblBsYWNlKHQpe3RoaXMueC89dC54LHRoaXMueS89dC55LHRoaXMuei89dC56fXNjYWxlKHQpe3JldHVybiBuZXcgcih0aGlzLngqdCx0aGlzLnkqdCx0aGlzLnoqdCl9c2NhbGVJblBsYWNlKHQpe3RoaXMueCo9dCx0aGlzLnkqPXQsdGhpcy56Kj10fW5lZ2F0ZSgpe3JldHVybiBuZXcgcigtdGhpcy54LC10aGlzLnksLXRoaXMueil9aW52ZXJzZSgpe3JldHVybiBuZXcgcigxL3RoaXMueCwxL3RoaXMueSwxL3RoaXMueil9bGVuZ3RoU3F1YXJlZCgpe2NvbnN0IHQ9dGhpcy5fX2RhdGFbMF0sZT10aGlzLl9fZGF0YVsxXSxzPXRoaXMuX19kYXRhWzJdO3JldHVybiB0KnQrZSplK3Mqc31sZW5ndGgoKXtyZXR1cm4gTWF0aC5zcXJ0KHRoaXMubGVuZ3RoU3F1YXJlZCgpKX1kaXN0YW5jZVRvKHQpe2NvbnN0IGU9dGhpcy5fX2RhdGFbMF0tdC54LHM9dGhpcy5fX2RhdGFbMV0tdC55LGE9dGhpcy5fX2RhdGFbMl0tdC56O3JldHVybiBNYXRoLnNxcnQoZSplK3MqcythKmEpfW5vcm1hbGl6ZSgpe2xldCB0PXRoaXMuX19kYXRhWzBdKnRoaXMuX19kYXRhWzBdK3RoaXMuX19kYXRhWzFdKnRoaXMuX19kYXRhWzFdK3RoaXMuX19kYXRhWzJdKnRoaXMuX19kYXRhWzJdO3JldHVybiB0PE51bWJlci5FUFNJTE9OP25ldyByOih0PTEvTWF0aC5zcXJ0KHQpLG5ldyByKHRoaXMuX19kYXRhWzBdKnQsdGhpcy5fX2RhdGFbMV0qdCx0aGlzLl9fZGF0YVsyXSp0KSl9bm9ybWFsaXplSW5QbGFjZSgpe2xldCB0PXRoaXMuX19kYXRhWzBdKnRoaXMuX19kYXRhWzBdK3RoaXMuX19kYXRhWzFdKnRoaXMuX19kYXRhWzFdK3RoaXMuX19kYXRhWzJdKnRoaXMuX19kYXRhWzJdO2lmKHQ8TnVtYmVyLkVQU0lMT04pcmV0dXJuO3Q9TWF0aC5zcXJ0KHQpO2NvbnN0IGU9MS90O3JldHVybiB0aGlzLl9fZGF0YVswXSo9ZSx0aGlzLl9fZGF0YVsxXSo9ZSx0aGlzLl9fZGF0YVsyXSo9ZSx0fXJlc2l6ZSh0KXtjb25zdCBlPXRoaXMuX19kYXRhWzBdKnRoaXMuX19kYXRhWzBdK3RoaXMuX19kYXRhWzFdKnRoaXMuX19kYXRhWzFdK3RoaXMuX19kYXRhWzJdKnRoaXMuX19kYXRhWzJdO2lmKGU8TnVtYmVyLkVQU0lMT04pcmV0dXJuO2NvbnN0IHM9dC9NYXRoLnNxcnQoZSk7cmV0dXJuIG5ldyByKHRoaXMuX19kYXRhWzBdKnMsdGhpcy5fX2RhdGFbMV0qcyx0aGlzLl9fZGF0YVsyXSpzKX1yZXNpemVJblBsYWNlKHQpe2NvbnN0IGU9dGhpcy5fX2RhdGFbMF0qdGhpcy5fX2RhdGFbMF0rdGhpcy5fX2RhdGFbMV0qdGhpcy5fX2RhdGFbMV0rdGhpcy5fX2RhdGFbMl0qdGhpcy5fX2RhdGFbMl07aWYoZTxOdW1iZXIuRVBTSUxPTilyZXR1cm47Y29uc3Qgcz10L01hdGguc3FydChlKTt0aGlzLl9fZGF0YVswXSo9cyx0aGlzLl9fZGF0YVsxXSo9cyx0aGlzLl9fZGF0YVsyXSo9c31kb3QodCl7cmV0dXJuIHRoaXMueCp0LngrdGhpcy55KnQueSt0aGlzLnoqdC56fWNyb3NzKHQpe2NvbnN0IGU9dGhpcy54LHM9dGhpcy55LGE9dGhpcy56LGk9dC54LG49dC55LGg9dC56O3JldHVybiBuZXcgcihzKmgtYSpuLGEqaS1lKmgsZSpuLXMqaSl9YW5nbGVUbyh0KXtjb25zdCBlPXRoaXMuZG90KHQpO3JldHVybiBlPjE/MDpNYXRoLmFjb3MoZSl9bGVycCh0LGUpe2NvbnN0IHM9dGhpcy54LGE9dGhpcy55LGk9dGhpcy56O3JldHVybiBuZXcgcihzK2UqKHQueC1zKSxhK2UqKHQueS1hKSxpK2UqKHQuei1pKSl9YWJzKCl7cmV0dXJuIG5ldyByKE1hdGguYWJzKHRoaXMueCksTWF0aC5hYnModGhpcy55KSxNYXRoLmFicyh0aGlzLnopKX1zZXRSYW5kb21EaXIodD0xKXtjb25zdCBlPTIqTWF0aC5yYW5kb20oKSpNYXRoLlBJLHM9MipNYXRoLnJhbmRvbSgpLTEsYT1NYXRoLnNxcnQoMS1zKnMpKnQ7cmV0dXJuIHRoaXMuX19kYXRhWzBdPU1hdGguY29zKGUpKmEsdGhpcy5fX2RhdGFbMV09TWF0aC5zaW4oZSkqYSx0aGlzLl9fZGF0YVsyXT1zKnQsdGhpc31zZXRSYW5kb20odD0xKXtyZXR1cm4gdGhpcy5fX2RhdGFbMF09KE1hdGgucmFuZG9tKCktLjUpKnQsdGhpcy5fX2RhdGFbMV09KE1hdGgucmFuZG9tKCktLjUpKnQsdGhpcy5fX2RhdGFbMl09KE1hdGgucmFuZG9tKCktLjUpKnQsdGhpc31jbG9uZSgpe3JldHVybiBuZXcgcih0aGlzLl9fZGF0YVswXSx0aGlzLl9fZGF0YVsxXSx0aGlzLl9fZGF0YVsyXSl9YXNBcnJheSgpe3JldHVybiB0aGlzLl9fZGF0YX1zdGF0aWMgY3JlYXRlKC4uLnQpe3JldHVybiBuZXcgciguLi50KX1zdGF0aWMgY3JlYXRlRnJvbUpTT04odCl7Y29uc3QgZT1uZXcgcjtyZXR1cm4gZS5mcm9tSlNPTih0KSxlfXN0YXRpYyBjcmVhdGVGcm9tRmxvYXQzMkJ1ZmZlcih0LGU9MCl7cmV0dXJuIG5ldyByKHQsNCplKX1zdGF0aWMgY3JlYXRlRnJvbUZsb2F0MzJBcnJheSh0KXtyZXR1cm4gbmV3IHIodCl9c3RhdGljIG51bUVsZW1lbnRzKCl7cmV0dXJuIDN9dG9KU09OKCl7cmV0dXJue3g6dGhpcy54LHk6dGhpcy55LHo6dGhpcy56fX1mcm9tSlNPTih0KXt0aGlzLng9dC54LHRoaXMueT10LnksdGhpcy56PXQuen19YS5yZWdpc3RlclR5cGUoIlZlYzMiLHIpO2NsYXNzIG4gZXh0ZW5kcyBze2NvbnN0cnVjdG9yKHQ9MCxlPTAscz0wLGE9MCl7aWYoc3VwZXIoKSx0IGluc3RhbmNlb2YgQXJyYXlCdWZmZXIpe2NvbnN0IHM9dCxhPWU7dGhpcy5fX2RhdGE9bmV3IEZsb2F0MzJBcnJheShzLGEsNCl9ZWxzZSBudWxsIT10JiYib2JqZWN0Ij09dHlwZW9mIHQ/KHRoaXMuX19kYXRhPW5ldyBGbG9hdDMyQXJyYXkoNCksdGhpcy5mcm9tSlNPTih0KSk6KHRoaXMuX19kYXRhPW5ldyBGbG9hdDMyQXJyYXkoNCksdGhpcy5fX2RhdGFbMF09dCx0aGlzLl9fZGF0YVsxXT1lLHRoaXMuX19kYXRhWzJdPXMsdGhpcy5fX2RhdGFbM109YSl9Z2V0IHgoKXtyZXR1cm4gdGhpcy5fX2RhdGFbMF19c2V0IHgodCl7dGhpcy5fX2RhdGFbMF09dH1nZXQgeSgpe3JldHVybiB0aGlzLl9fZGF0YVsxXX1zZXQgeSh0KXt0aGlzLl9fZGF0YVsxXT10fWdldCB6KCl7cmV0dXJuIHRoaXMuX19kYXRhWzJdfXNldCB6KHQpe3RoaXMuX19kYXRhWzJdPXR9Z2V0IHQoKXtyZXR1cm4gdGhpcy5fX2RhdGFbM119c2V0IHQodCl7dGhpcy5fX2RhdGFbM109dH1nZXQgeHl6KCl7cmV0dXJuIG5ldyByKHRoaXMuX19kYXRhWzBdLHRoaXMuX19kYXRhWzFdLHRoaXMuX19kYXRhWzJdKX1zZXQodCxlLHMsYSl7dGhpcy54PXQsdGhpcy55PWUsdGhpcy56PXMsdGhpcy50PWF9c2V0RnJvbU90aGVyKHQpe3RoaXMueD10LngsdGhpcy55PXQueSx0aGlzLno9dC56LHRoaXMudD10LnR9ZXF1YWwodCl7cmV0dXJuIHRoaXMueD09dC54JiZ0aGlzLnk9PXQueSYmdGhpcy56PT10LnomJnRoaXMudD09dC50fW5vdEVxdWFscyh0KXtyZXR1cm4gdGhpcy54IT10LngmJnRoaXMueSE9dC55JiZ0aGlzLnohPXQueiYmdGhpcy50IT10LnR9YXBwcm94RXF1YWwodCxlPU51bWJlci5FUFNJTE9OKXtyZXR1cm4gTWF0aC5hYnModGhpcy54LXQueCk8ZSYmTWF0aC5hYnModGhpcy55LXQueSk8ZSYmTWF0aC5hYnModGhpcy56LXQueik8ZSYmTWF0aC5hYnModGhpcy50LXQudCk8ZX1hZGQodCl7cmV0dXJuIG5ldyBuKHRoaXMueCt0LngsdGhpcy55K3QueSx0aGlzLnordC56LHRoaXMudCt0LnQpfWFkZEluUGxhY2UodCl7dGhpcy54Kz10LngsdGhpcy55Kz10LnksdGhpcy56Kz10LnosdGhpcy50Kz10LnR9c3VidHJhY3QodCl7cmV0dXJuIG5ldyBuKHRoaXMueC10LngsdGhpcy55LXQueSx0aGlzLnotdC56LHRoaXMudC10LnQpfXN1YnRyYWN0SW5QbGFjZSh0KXt0aGlzLngtPXQueCx0aGlzLnktPXQueSx0aGlzLnotPXQueix0aGlzLnQtPXQudH1tdWx0aXBseSh0KXtyZXR1cm4gbmV3IG4odGhpcy54KnQueCx0aGlzLnkqdC55LHRoaXMueip0LnosdGhpcy50KnQudCl9bXVsdGlwbHlJblBsYWNlKHQpe3RoaXMueCo9dC54LHRoaXMueSo9dC55LHRoaXMueio9dC56LHRoaXMudCo9dC50fWRpdmlkZSh0KXtyZXR1cm4gbmV3IG4odGhpcy54L3QueCx0aGlzLnkvdC55LHRoaXMuei90LnosdGhpcy50L3QudCl9ZGl2aWRlSW5QbGFjZSh0KXt0aGlzLngvPXQueCx0aGlzLnkvPXQueSx0aGlzLnovPXQueix0aGlzLnQvPXQudH1zY2FsZSh0KXtyZXR1cm4gbmV3IG4odGhpcy54KnQsdGhpcy55KnQsdGhpcy56KnQsdGhpcy50KnQpfXNjYWxlSW5QbGFjZSh0KXt0aGlzLnNldCh0aGlzLngqdCx0aGlzLnkqdCx0aGlzLnoqdCx0aGlzLnQqdCl9bGVuZ3RoKCl7Y29uc3QgdD10aGlzLl9fZGF0YVswXSxlPXRoaXMuX19kYXRhWzFdLHM9dGhpcy5fX2RhdGFbMl0sYT10aGlzLl9fZGF0YVsyXTtyZXR1cm4gTWF0aC5zcXJ0KHQqdCtlKmUrcypzK2EqYSl9bGVuZ3RoU3F1YXJlZCgpe2NvbnN0IHQ9dGhpcy5fX2RhdGFbMF0sZT10aGlzLl9fZGF0YVsxXSxzPXRoaXMuX19kYXRhWzJdLGE9dGhpcy5fX2RhdGFbM107cmV0dXJuIHQqdCtlKmUrcypzK2EqYX1ub3JtYWxpemUoKXtjb25zdCB0PXRoaXMuX19kYXRhWzBdLGU9dGhpcy5fX2RhdGFbMV0scz10aGlzLl9fZGF0YVsyXSxhPXRoaXMuX19kYXRhWzNdO2xldCBpPXQqdCtlKmUrcypzK2EqYTtyZXR1cm4gaTxOdW1iZXIuRVBTSUxPTj9uZXcgbjooaT0xL01hdGguc3FydChpKSxuZXcgbih0KmksZSppLHMqaSkpfW5vcm1hbGl6ZUluUGxhY2UoKXtjb25zdCB0PXRoaXMuX19kYXRhWzBdLGU9dGhpcy5fX2RhdGFbMV0scz10aGlzLl9fZGF0YVsyXSxhPXRoaXMuX19kYXRhWzNdO2xldCBpPXQqdCtlKmUrcypzK2EqYTtpPE51bWJlci5FUFNJTE9OfHwoaT0xL01hdGguc3FydChpKSx0aGlzLnNldCh0KmksZSppLHMqaSxhKmkpKX1kb3QodCl7cmV0dXJuIHRoaXMueCp0LngrdGhpcy55KnQueSt0aGlzLnoqdC56K3RoaXMudCpiLnR9Y3Jvc3ModCl7Y29uc3QgZT10aGlzLngscz10aGlzLnksYT10aGlzLnosaT10aGlzLnQscj10LngsaD10Lnksbz10LnosXz10LnQ7cmV0dXJuIG5ldyBuKHMqby1hKmgsYSpfLWkqbyxpKnItZSpfLGUqaC1zKnIpfWFuZ2xlVG8odCl7Y29uc3QgZT10aGlzLm5vcm1hbGl6ZSgpLHM9dC5ub3JtYWxpemUoKSxhPWUuZG90KHMpO3JldHVybiBhPjE/MDpNYXRoLmFjb3MoYSl9bGVycCh0LGUpe2NvbnN0IHM9dGhpcy54LGE9dGhpcy55LGk9dGhpcy56O3JldHVybiBhdD10aGlzLnQsbmV3IG4ocytlKih0LngtcyksYStlKih0LnktYSksaStlKih0LnotaSksYXQrZSoodC50LWF0KSl9cmFuZG9tKHQ9MSl7Y29uc3QgZT0yKmdsTWF0cml4LlJBTkRPTSgpKk1hdGguUEkscz0yKmdsTWF0cml4LlJBTkRPTSgpLTEsYT1NYXRoLnNxcnQoMS1zKnMpKnQ7cmV0dXJuIG91dFswXT1NYXRoLmNvcyhlKSphLG91dFsxXT1NYXRoLnNpbihlKSphLG91dFsyXT1zKnQsb3V0fWNsb25lKCl7cmV0dXJuIG5ldyBuKHRoaXMuX19kYXRhWzBdLHRoaXMuX19kYXRhWzFdLHRoaXMuX19kYXRhWzJdLHRoaXMuX19kYXRhWzNdKX10b1ZlYzMoKXtyZXR1cm4gbmV3IHIodGhpcy5fX2RhdGFbMF0sdGhpcy5fX2RhdGFbMV0sdGhpcy5fX2RhdGFbMl0pfWFzQXJyYXkoKXtyZXR1cm4gdGhpcy5fX2RhdGF9c3RhdGljIGNyZWF0ZSguLi50KXtyZXR1cm4gbmV3IHIoLi4udCl9c3RhdGljIGNyZWF0ZUZyb21GbG9hdDMyQnVmZmVyKHQsZT0wKXtyZXR1cm4gbmV3IG4odCw0KmUpfXN0YXRpYyBudW1FbGVtZW50cygpe3JldHVybiA0fXRvSlNPTigpe3JldHVybnt4OnRoaXMueCx5OnRoaXMueSx6OnRoaXMueix0OnRoaXMudH19fWEucmVnaXN0ZXJUeXBlKCJWZWM0IixuKTtjbGFzcyBoIGV4dGVuZHMgc3tjb25zdHJ1Y3Rvcih0PTAsZT0wLHM9MCxhPTI1NSl7aWYoc3VwZXIoKSx0IGluc3RhbmNlb2YgVWludDhBcnJheSl0aGlzLl9fZGF0YT10O2Vsc2UgaWYodCBpbnN0YW5jZW9mIEFycmF5QnVmZmVyKXtjb25zdCBzPXQsYT1lO3RoaXMuX19kYXRhPW5ldyBVaW50OEFycmF5KHMsYSw0KX1lbHNlIHRoaXMuX19kYXRhPW5ldyBVaW50OEFycmF5KDQpLCJzdHJpbmciPT10eXBlb2YgdD90LnN0YXJ0c1dpdGgoIiMiKT90aGlzLnNldEZyb21IZXgodCk6dGhpcy5zZXRGcm9tQ1NTQ29sb3JOYW1lKHQpOih0aGlzLl9fZGF0YVswXT10LHRoaXMuX19kYXRhWzFdPWUsdGhpcy5fX2RhdGFbMl09cyx0aGlzLl9fZGF0YVszXT1hKX1nZXQgcigpe3JldHVybiB0aGlzLl9fZGF0YVswXX1zZXQgcih0KXt0aGlzLl9fZGF0YVswXT10fWdldCBnKCl7cmV0dXJuIHRoaXMuX19kYXRhWzFdfXNldCBnKHQpe3RoaXMuX19kYXRhWzFdPXR9Z2V0IGIoKXtyZXR1cm4gdGhpcy5fX2RhdGFbMl19c2V0IGIodCl7dGhpcy5fX2RhdGFbMl09dH1nZXQgYSgpe3JldHVybiB0aGlzLl9fZGF0YVszXX1zZXQgYSh0KXt0aGlzLl9fZGF0YVszXT10fXNldCh0LGUscyxhPTI1NSl7dGhpcy5yPXQsdGhpcy5nPWUsdGhpcy5iPXMsdGhpcy5hPWF9c2V0RnJvbU90aGVyKHQpe3RoaXMucj10LnIsdGhpcy5nPXQuZyx0aGlzLmI9dC5iLHRoaXMuYT10LmF9c2V0RnJvbUFycmF5KHQpe3RoaXMucj10WzBdLHRoaXMuZz10WzFdLHRoaXMuYj10WzJdLHRoaXMuYT00PT10Lmxlbmd0aD90WzNdOjF9c2V0RnJvbUhleCh0KXtjb25zdCBlPWZ1bmN0aW9uKHQpe2NvbnN0IGU9L14jPyhbYS1mXGRdezJ9KShbYS1mXGRdezJ9KShbYS1mXGRdezJ9KSQvaS5leGVjKHQpO3JldHVybiBlP3tyOnBhcnNlSW50KGVbMV0sMTYpLGc6cGFyc2VJbnQoZVsyXSwxNiksYjpwYXJzZUludChlWzNdLDE2KX06bnVsbH0odCk7ZT90aGlzLnNldChlLnIsZS5nLGUuYik6Y29uc29sZS53YXJuKCJJbnZhbGlkIGhleCBjb2RlOiIrdCl9c2V0RnJvbUNTU0NvbG9yTmFtZSh0KXt0LnN0YXJ0c1dpdGgoIiMiKT90aGlzLnNldEZyb21IZXgodCk6dGhpcy5zZXRGcm9tSGV4KCh0PT57Y29uc3QgZT17YWxpY2VibHVlOiIjZjBmOGZmIixhbnRpcXVld2hpdGU6IiNmYWViZDciLGFxdWE6IiMwMGZmZmYiLGFxdWFtYXJpbmU6IiM3ZmZmZDQiLGF6dXJlOiIjZjBmZmZmIixiZWlnZToiI2Y1ZjVkYyIsYmlzcXVlOiIjZmZlNGM0IixibGFjazoiIzAwMDAwMCIsYmxhbmNoZWRhbG1vbmQ6IiNmZmViY2QiLGJsdWU6IiMwMDAwZmYiLGJsdWV2aW9sZXQ6IiM4YTJiZTIiLGJyb3duOiIjYTUyYTJhIixidXJseXdvb2Q6IiNkZWI4ODciLGNhZGV0Ymx1ZToiIzVmOWVhMCIsY2hhcnRyZXVzZToiIzdmZmYwMCIsY2hvY29sYXRlOiIjZDI2OTFlIixjb3JhbDoiI2ZmN2Y1MCIsY29ybmZsb3dlcmJsdWU6IiM2NDk1ZWQiLGNvcm5zaWxrOiIjZmZmOGRjIixjcmltc29uOiIjZGMxNDNjIixjeWFuOiIjMDBmZmZmIixkYXJrYmx1ZToiIzAwMDA4YiIsZGFya2N5YW46IiMwMDhiOGIiLGRhcmtnb2xkZW5yb2Q6IiNiODg2MGIiLGRhcmtncmF5OiIjYTlhOWE5IixkYXJrZ3JlZW46IiMwMDY0MDAiLGRhcmtraGFraToiI2JkYjc2YiIsZGFya21hZ2VudGE6IiM4YjAwOGIiLGRhcmtvbGl2ZWdyZWVuOiIjNTU2YjJmIixkYXJrb3JhbmdlOiIjZmY4YzAwIixkYXJrb3JjaGlkOiIjOTkzMmNjIixkYXJrcmVkOiIjOGIwMDAwIixkYXJrc2FsbW9uOiIjZTk5NjdhIixkYXJrc2VhZ3JlZW46IiM4ZmJjOGYiLGRhcmtzbGF0ZWJsdWU6IiM0ODNkOGIiLGRhcmtzbGF0ZWdyYXk6IiMyZjRmNGYiLGRhcmt0dXJxdW9pc2U6IiMwMGNlZDEiLGRhcmt2aW9sZXQ6IiM5NDAwZDMiLGRlZXBwaW5rOiIjZmYxNDkzIixkZWVwc2t5Ymx1ZToiIzAwYmZmZiIsZGltZ3JheToiIzY5Njk2OSIsZG9kZ2VyYmx1ZToiIzFlOTBmZiIsZmlyZWJyaWNrOiIjYjIyMjIyIixmbG9yYWx3aGl0ZToiI2ZmZmFmMCIsZm9yZXN0Z3JlZW46IiMyMjhiMjIiLGZ1Y2hzaWE6IiNmZjAwZmYiLGdhaW5zYm9ybzoiI2RjZGNkYyIsZ2hvc3R3aGl0ZToiI2Y4ZjhmZiIsZ29sZDoiI2ZmZDcwMCIsZ29sZGVucm9kOiIjZGFhNTIwIixncmF5OiIjODA4MDgwIixncmVlbjoiIzAwODAwMCIsZ3JlZW55ZWxsb3c6IiNhZGZmMmYiLGhvbmV5ZGV3OiIjZjBmZmYwIixob3RwaW5rOiIjZmY2OWI0IiwiaW5kaWFucmVkICI6IiNjZDVjNWMiLGluZGlnbzoiIzRiMDA4MiIsaXZvcnk6IiNmZmZmZjAiLGtoYWtpOiIjZjBlNjhjIixsYXZlbmRlcjoiI2U2ZTZmYSIsbGF2ZW5kZXJibHVzaDoiI2ZmZjBmNSIsbGF3bmdyZWVuOiIjN2NmYzAwIixsZW1vbmNoaWZmb246IiNmZmZhY2QiLGxpZ2h0Ymx1ZToiI2FkZDhlNiIsbGlnaHRjb3JhbDoiI2YwODA4MCIsbGlnaHRjeWFuOiIjZTBmZmZmIixsaWdodGdvbGRlbnJvZHllbGxvdzoiI2ZhZmFkMiIsbGlnaHRncmV5OiIjZDNkM2QzIixsaWdodGdyZWVuOiIjOTBlZTkwIixsaWdodHBpbms6IiNmZmI2YzEiLGxpZ2h0c2FsbW9uOiIjZmZhMDdhIixsaWdodHNlYWdyZWVuOiIjMjBiMmFhIixsaWdodHNreWJsdWU6IiM4N2NlZmEiLGxpZ2h0c2xhdGVncmF5OiIjNzc4ODk5IixsaWdodHN0ZWVsYmx1ZToiI2IwYzRkZSIsbGlnaHR5ZWxsb3c6IiNmZmZmZTAiLGxpbWU6IiMwMGZmMDAiLGxpbWVncmVlbjoiIzMyY2QzMiIsbGluZW46IiNmYWYwZTYiLG1hZ2VudGE6IiNmZjAwZmYiLG1hcm9vbjoiIzgwMDAwMCIsbWVkaXVtYXF1YW1hcmluZToiIzY2Y2RhYSIsbWVkaXVtYmx1ZToiIzAwMDBjZCIsbWVkaXVtb3JjaGlkOiIjYmE1NWQzIixtZWRpdW1wdXJwbGU6IiM5MzcwZDgiLG1lZGl1bXNlYWdyZWVuOiIjM2NiMzcxIixtZWRpdW1zbGF0ZWJsdWU6IiM3YjY4ZWUiLG1lZGl1bXNwcmluZ2dyZWVuOiIjMDBmYTlhIixtZWRpdW10dXJxdW9pc2U6IiM0OGQxY2MiLG1lZGl1bXZpb2xldHJlZDoiI2M3MTU4NSIsbWlkbmlnaHRibHVlOiIjMTkxOTcwIixtaW50Y3JlYW06IiNmNWZmZmEiLG1pc3R5cm9zZToiI2ZmZTRlMSIsbW9jY2FzaW46IiNmZmU0YjUiLG5hdmFqb3doaXRlOiIjZmZkZWFkIixuYXZ5OiIjMDAwMDgwIixvbGRsYWNlOiIjZmRmNWU2IixvbGl2ZToiIzgwODAwMCIsb2xpdmVkcmFiOiIjNmI4ZTIzIixvcmFuZ2U6IiNmZmE1MDAiLG9yYW5nZXJlZDoiI2ZmNDUwMCIsb3JjaGlkOiIjZGE3MGQ2IixwYWxlZ29sZGVucm9kOiIjZWVlOGFhIixwYWxlZ3JlZW46IiM5OGZiOTgiLHBhbGV0dXJxdW9pc2U6IiNhZmVlZWUiLHBhbGV2aW9sZXRyZWQ6IiNkODcwOTMiLHBhcGF5YXdoaXA6IiNmZmVmZDUiLHBlYWNocHVmZjoiI2ZmZGFiOSIscGVydToiI2NkODUzZiIscGluazoiI2ZmYzBjYiIscGx1bToiI2RkYTBkZCIscG93ZGVyYmx1ZToiI2IwZTBlNiIscHVycGxlOiIjODAwMDgwIixyZWJlY2NhcHVycGxlOiIjNjYzMzk5IixyZWQ6IiNmZjAwMDAiLHJvc3licm93bjoiI2JjOGY4ZiIscm95YWxibHVlOiIjNDE2OWUxIixzYWRkbGVicm93bjoiIzhiNDUxMyIsc2FsbW9uOiIjZmE4MDcyIixzYW5keWJyb3duOiIjZjRhNDYwIixzZWFncmVlbjoiIzJlOGI1NyIsc2Vhc2hlbGw6IiNmZmY1ZWUiLHNpZW5uYToiI2EwNTIyZCIsc2lsdmVyOiIjYzBjMGMwIixza3libHVlOiIjODdjZWViIixzbGF0ZWJsdWU6IiM2YTVhY2QiLHNsYXRlZ3JheToiIzcwODA5MCIsc25vdzoiI2ZmZmFmYSIsc3ByaW5nZ3JlZW46IiMwMGZmN2YiLHN0ZWVsYmx1ZToiIzQ2ODJiNCIsdGFuOiIjZDJiNDhjIix0ZWFsOiIjMDA4MDgwIix0aGlzdGxlOiIjZDhiZmQ4Iix0b21hdG86IiNmZjYzNDciLHR1cnF1b2lzZToiIzQwZTBkMCIsdmlvbGV0OiIjZWU4MmVlIix3aGVhdDoiI2Y1ZGViMyIsd2hpdGU6IiNmZmZmZmYiLHdoaXRlc21va2U6IiNmNWY1ZjUiLHllbGxvdzoiI2ZmZmYwMCIseWVsbG93Z3JlZW46IiM5YWNkMzIifTtyZXR1cm4gdm9pZCAwIT09ZVt0LnRvTG93ZXJDYXNlKCldJiZlW3QudG9Mb3dlckNhc2UoKV19KSh0KSl9dG9IZXgoKXtmdW5jdGlvbiB0KHQpe2NvbnN0IGU9dC50b1N0cmluZygxNik7cmV0dXJuIDE9PWUubGVuZ3RoPyIwIitlOmV9cmV0dXJuIiMiK3QodGhpcy5yKSt0KHRoaXMuZykrdCh0aGlzLmIpfWVxdWFsKHQpe3JldHVybiB0aGlzLnI9PXQuciYmdGhpcy5nPT10LmcmJnRoaXMuYj09dC5iJiZ0aGlzLmE9PXQuYX1ub3RlcXVhbHModCl7cmV0dXJuIHRoaXMuciE9dC5yJiZ0aGlzLmchPXQuZyYmdGhpcy5iIT10LmImJnRoaXMuYSE9dC5hfWFwcHJveEVxdWFsKHQsZT1OdW1iZXIuRVBTSUxPTil7cmV0dXJuIE1hdGguYWJzKHRoaXMuci10LnIpPGUmJk1hdGguYWJzKHRoaXMuZy10LmcpPGUmJk1hdGguYWJzKHRoaXMuYi10LmIpPGUmJk1hdGguYWJzKHRoaXMuYS10LmEpPGV9YWRkKHQpe3JldHVybiBuZXcgaCh0aGlzLnIrdC5yLHRoaXMuZyt0LmcsdGhpcy5iK3QuYix0aGlzLmErdC5hKX1zdWJ0cmFjdCh0KXtyZXR1cm4gbmV3IGgodGhpcy5yLXQucix0aGlzLmctdC5nLHRoaXMuYi10LmIsdGhpcy5hLXQuYSl9c2NhbGUodCl7cmV0dXJuIG5ldyBoKHRoaXMucip0LHRoaXMuZyp0LHRoaXMuYip0LHRoaXMuYSp0KX1zY2FsZUluUGxhY2UodCl7dGhpcy5yKj10LHRoaXMuZyo9dCx0aGlzLmIqPXQsdGhpcy5hKj10fWFwcGx5R2FtbWEodCl7dGhpcy5zZXQoTWF0aC5wb3codGhpcy5yLHQpLE1hdGgucG93KHRoaXMuZyx0KSxNYXRoLnBvdyh0aGlzLmIsdCksdGhpcy5hKX10b0xpbmVhcih0PTIuMil7cmV0dXJuIG5ldyBoKE1hdGgucG93KHRoaXMucix0KSxNYXRoLnBvdyh0aGlzLmcsdCksTWF0aC5wb3codGhpcy5iLHQpLHRoaXMuYSl9dG9HYW1tYSh0PTIuMil7cmV0dXJuIG5ldyBoKE1hdGgucG93KHRoaXMuciwxL3QpLE1hdGgucG93KHRoaXMuZywxL3QpLE1hdGgucG93KHRoaXMuYiwxL3QpLHRoaXMuYSl9bHVtaW5hbmNlKCl7cmV0dXJuLjIxMjYqdGhpcy5yKy43MTUyKnRoaXMuZysuMDcyMip0aGlzLmJ9bGVycCh0LGUpe2NvbnN0IHM9dGhpcy5yLGE9dGhpcy5nLGk9dGhpcy5iLHI9dGhpcy5hO3JldHVybiBuZXcgaChzK2UqKHQuci1zKSxhK2UqKHQuZy1hKSxpK2UqKHQuYi1pKSxyK2UqKHQuYS1yKSl9c3RhdGljIHJhbmRvbSh0PTAsZT0hMSl7cmV0dXJuIHQ+MD9uZXcgaCh0K01hdGgucmFuZG9tKCkqKDEtdCksdCtNYXRoLnJhbmRvbSgpKigxLXQpLHQrTWF0aC5yYW5kb20oKSooMS10KSxlP3QrTWF0aC5yYW5kb20oKSooMS10KToxKTp0PDA/bmV3IGgoTWF0aC5yYW5kb20oKSooMSt0KSxNYXRoLnJhbmRvbSgpKigxK3QpLE1hdGgucmFuZG9tKCkqKDErdCksZT9NYXRoLnJhbmRvbSgpKigxK3QpOjEpOm5ldyBoKE1hdGgucmFuZG9tKCksTWF0aC5yYW5kb20oKSxNYXRoLnJhbmRvbSgpLGU/TWF0aC5yYW5kb20oKToxKX1jbG9uZSgpe3JldHVybiBuZXcgaCh0aGlzLl9fZGF0YVswXSx0aGlzLl9fZGF0YVsxXSx0aGlzLl9fZGF0YVsyXSx0aGlzLl9fZGF0YVszXSl9YXNBcnJheSgpe3JldHVybiB0aGlzLl9fZGF0YX1hczNDb21wb25lbnRBcnJheSgpe3JldHVyblt0aGlzLl9fZGF0YVswXSx0aGlzLl9fZGF0YVsxXSx0aGlzLl9fZGF0YVsyXV19c3RhdGljIGNyZWF0ZSguLi50KXtyZXR1cm4gbmV3IGgoLi4udCl9c3RhdGljIGNyZWF0ZUZyb21GbG9hdDMyQnVmZmVyKHQsZT0wKXtyZXR1cm4gbmV3IGgodCw0KmUpfXN0YXRpYyBudW1FbGVtZW50cygpe3JldHVybiA0fXRvSlNPTigpe3JldHVybntyOnRoaXMucixnOnRoaXMuZyxiOnRoaXMuYixhOnRoaXMuYX19ZnJvbUpTT04odCl7dGhpcy5yPXQucix0aGlzLmc9dC5nLHRoaXMuYj10LmIsdGhpcy5hPXQuYX10b0NTU1N0cmluZygpe3JldHVybiJyZ2JhKCIrTWF0aC5yb3VuZCgyNTUqdGhpcy5yKSsiLCAiK01hdGgucm91bmQoMjU1KnRoaXMuZykrIiwgIitNYXRoLnJvdW5kKDI1NSp0aGlzLmIpKyIsICIrdGhpcy5hKyIpIn19YS5yZWdpc3RlclR5cGUoIlJHQkEiLGgpO2NsYXNzIG8gZXh0ZW5kcyBze2NvbnN0cnVjdG9yKHQ9MCxlPTAscz0wLGE9MSl7aWYoc3VwZXIoKSx0IGluc3RhbmNlb2YgRmxvYXQzMkFycmF5KXRoaXMuX19kYXRhPXQ7ZWxzZSBpZih0IGluc3RhbmNlb2YgQXJyYXlCdWZmZXIpe2NvbnN0IHM9dCxhPWU7dGhpcy5fX2RhdGE9bmV3IEZsb2F0MzJBcnJheShzLGEsNCl9ZWxzZSB0aGlzLl9fZGF0YT1uZXcgRmxvYXQzMkFycmF5KDQpLCJzdHJpbmciPT10eXBlb2YgdD90LnN0YXJ0c1dpdGgoIiMiKT90aGlzLnNldEZyb21IZXgodCk6dGhpcy5zZXRGcm9tQ1NTQ29sb3JOYW1lKHQpOih0aGlzLl9fZGF0YVswXT10LHRoaXMuX19kYXRhWzFdPWUsdGhpcy5fX2RhdGFbMl09cyx0aGlzLl9fZGF0YVszXT1hKX1nZXQgcigpe3JldHVybiB0aGlzLl9fZGF0YVswXX1zZXQgcih0KXt0aGlzLl9fZGF0YVswXT10fWdldCBnKCl7cmV0dXJuIHRoaXMuX19kYXRhWzFdfXNldCBnKHQpe3RoaXMuX19kYXRhWzFdPXR9Z2V0IGIoKXtyZXR1cm4gdGhpcy5fX2RhdGFbMl19c2V0IGIodCl7dGhpcy5fX2RhdGFbMl09dH1nZXQgYSgpe3JldHVybiB0aGlzLl9fZGF0YVszXX1zZXQgYSh0KXt0aGlzLl9fZGF0YVszXT10fXNldCh0LGUscyxhPTEpe3RoaXMucj10LHRoaXMuZz1lLHRoaXMuYj1zLHRoaXMuYT1hfXNldEZyb21PdGhlcih0KXt0aGlzLnI9dC5yLHRoaXMuZz10LmcsdGhpcy5iPXQuYix0aGlzLmE9dC5hfXNldEZyb21TY2FsYXJBcnJheSh0KXt0aGlzLnI9dFswXSx0aGlzLmc9dFsxXSx0aGlzLmI9dFsyXSx0aGlzLmE9ND09dC5sZW5ndGg/dFszXToxfWdldEFzUkdCQXJyYXkoKXtyZXR1cm5bMjU1KnRoaXMuciwyNTUqdGhpcy5nLDI1NSp0aGlzLmJdfWdldEFzUkdCRGljdCgpe3JldHVybntyOjI1NSp0aGlzLnIsZzoyNTUqdGhpcy5nLGI6MjU1KnRoaXMuYn19c2V0RnJvbVJHQih0LGUscyxhKXt0aGlzLnI9dC8yNTUsdGhpcy5nPWUvMjU1LHRoaXMuYj1zLzI1NSx0aGlzLmE9YT9hLzI1NToxfXNldEZyb21SR0JBcnJheSh0KXt0aGlzLnI9dFswXS8yNTUsdGhpcy5nPXRbMV0vMjU1LHRoaXMuYj10WzJdLzI1NSx0aGlzLmE9ND09dC5sZW5ndGg/dFszXS8yNTU6MX1zZXRGcm9tUkdCRGljdCh0KXt0aGlzLnI9dC5yLzI1NSx0aGlzLmc9dC5nLzI1NSx0aGlzLmI9dC5iLzI1NSx0aGlzLmE9ND09dC5hP3QuYS8yNTU6MX1zZXRGcm9tSGV4KHQpe2NvbnN0IGU9ZnVuY3Rpb24odCl7Y29uc3QgZT0vXiM/KFthLWZcZF17Mn0pKFthLWZcZF17Mn0pKFthLWZcZF17Mn0pJC9pLmV4ZWModCk7cmV0dXJuIGU/e3I6cGFyc2VJbnQoZVsxXSwxNiksZzpwYXJzZUludChlWzJdLDE2KSxiOnBhcnNlSW50KGVbM10sMTYpfTpudWxsfSh0KTtlP3RoaXMuc2V0RnJvbVJHQihlLnIsZS5nLGUuYik6Y29uc29sZS53YXJuKCJJbnZhbGlkIGhleCBjb2RlOiIrdCl9c2V0RnJvbUNTU0NvbG9yTmFtZSh0KXt0LnN0YXJ0c1dpdGgoIiMiKT90aGlzLnNldEZyb21IZXgodCk6dGhpcy5zZXRGcm9tSGV4KCh0PT57Y29uc3QgZT17YWxpY2VibHVlOiIjZjBmOGZmIixhbnRpcXVld2hpdGU6IiNmYWViZDciLGFxdWE6IiMwMGZmZmYiLGFxdWFtYXJpbmU6IiM3ZmZmZDQiLGF6dXJlOiIjZjBmZmZmIixiZWlnZToiI2Y1ZjVkYyIsYmlzcXVlOiIjZmZlNGM0IixibGFjazoiIzAwMDAwMCIsYmxhbmNoZWRhbG1vbmQ6IiNmZmViY2QiLGJsdWU6IiMwMDAwZmYiLGJsdWV2aW9sZXQ6IiM4YTJiZTIiLGJyb3duOiIjYTUyYTJhIixidXJseXdvb2Q6IiNkZWI4ODciLGNhZGV0Ymx1ZToiIzVmOWVhMCIsY2hhcnRyZXVzZToiIzdmZmYwMCIsY2hvY29sYXRlOiIjZDI2OTFlIixjb3JhbDoiI2ZmN2Y1MCIsY29ybmZsb3dlcmJsdWU6IiM2NDk1ZWQiLGNvcm5zaWxrOiIjZmZmOGRjIixjcmltc29uOiIjZGMxNDNjIixjeWFuOiIjMDBmZmZmIixkYXJrYmx1ZToiIzAwMDA4YiIsZGFya2N5YW46IiMwMDhiOGIiLGRhcmtnb2xkZW5yb2Q6IiNiODg2MGIiLGRhcmtncmF5OiIjYTlhOWE5IixkYXJrZ3JlZW46IiMwMDY0MDAiLGRhcmtraGFraToiI2JkYjc2YiIsZGFya21hZ2VudGE6IiM4YjAwOGIiLGRhcmtvbGl2ZWdyZWVuOiIjNTU2YjJmIixkYXJrb3JhbmdlOiIjZmY4YzAwIixkYXJrb3JjaGlkOiIjOTkzMmNjIixkYXJrcmVkOiIjOGIwMDAwIixkYXJrc2FsbW9uOiIjZTk5NjdhIixkYXJrc2VhZ3JlZW46IiM4ZmJjOGYiLGRhcmtzbGF0ZWJsdWU6IiM0ODNkOGIiLGRhcmtzbGF0ZWdyYXk6IiMyZjRmNGYiLGRhcmt0dXJxdW9pc2U6IiMwMGNlZDEiLGRhcmt2aW9sZXQ6IiM5NDAwZDMiLGRlZXBwaW5rOiIjZmYxNDkzIixkZWVwc2t5Ymx1ZToiIzAwYmZmZiIsZGltZ3JheToiIzY5Njk2OSIsZG9kZ2VyYmx1ZToiIzFlOTBmZiIsZmlyZWJyaWNrOiIjYjIyMjIyIixmbG9yYWx3aGl0ZToiI2ZmZmFmMCIsZm9yZXN0Z3JlZW46IiMyMjhiMjIiLGZ1Y2hzaWE6IiNmZjAwZmYiLGdhaW5zYm9ybzoiI2RjZGNkYyIsZ2hvc3R3aGl0ZToiI2Y4ZjhmZiIsZ29sZDoiI2ZmZDcwMCIsZ29sZGVucm9kOiIjZGFhNTIwIixncmF5OiIjODA4MDgwIixncmVlbjoiIzAwODAwMCIsZ3JlZW55ZWxsb3c6IiNhZGZmMmYiLGhvbmV5ZGV3OiIjZjBmZmYwIixob3RwaW5rOiIjZmY2OWI0IiwiaW5kaWFucmVkICI6IiNjZDVjNWMiLGluZGlnbzoiIzRiMDA4MiIsaXZvcnk6IiNmZmZmZjAiLGtoYWtpOiIjZjBlNjhjIixsYXZlbmRlcjoiI2U2ZTZmYSIsbGF2ZW5kZXJibHVzaDoiI2ZmZjBmNSIsbGF3bmdyZWVuOiIjN2NmYzAwIixsZW1vbmNoaWZmb246IiNmZmZhY2QiLGxpZ2h0Ymx1ZToiI2FkZDhlNiIsbGlnaHRjb3JhbDoiI2YwODA4MCIsbGlnaHRjeWFuOiIjZTBmZmZmIixsaWdodGdvbGRlbnJvZHllbGxvdzoiI2ZhZmFkMiIsbGlnaHRncmV5OiIjZDNkM2QzIixsaWdodGdyZWVuOiIjOTBlZTkwIixsaWdodHBpbms6IiNmZmI2YzEiLGxpZ2h0c2FsbW9uOiIjZmZhMDdhIixsaWdodHNlYWdyZWVuOiIjMjBiMmFhIixsaWdodHNreWJsdWU6IiM4N2NlZmEiLGxpZ2h0c2xhdGVncmF5OiIjNzc4ODk5IixsaWdodHN0ZWVsYmx1ZToiI2IwYzRkZSIsbGlnaHR5ZWxsb3c6IiNmZmZmZTAiLGxpbWU6IiMwMGZmMDAiLGxpbWVncmVlbjoiIzMyY2QzMiIsbGluZW46IiNmYWYwZTYiLG1hZ2VudGE6IiNmZjAwZmYiLG1hcm9vbjoiIzgwMDAwMCIsbWVkaXVtYXF1YW1hcmluZToiIzY2Y2RhYSIsbWVkaXVtYmx1ZToiIzAwMDBjZCIsbWVkaXVtb3JjaGlkOiIjYmE1NWQzIixtZWRpdW1wdXJwbGU6IiM5MzcwZDgiLG1lZGl1bXNlYWdyZWVuOiIjM2NiMzcxIixtZWRpdW1zbGF0ZWJsdWU6IiM3YjY4ZWUiLG1lZGl1bXNwcmluZ2dyZWVuOiIjMDBmYTlhIixtZWRpdW10dXJxdW9pc2U6IiM0OGQxY2MiLG1lZGl1bXZpb2xldHJlZDoiI2M3MTU4NSIsbWlkbmlnaHRibHVlOiIjMTkxOTcwIixtaW50Y3JlYW06IiNmNWZmZmEiLG1pc3R5cm9zZToiI2ZmZTRlMSIsbW9jY2FzaW46IiNmZmU0YjUiLG5hdmFqb3doaXRlOiIjZmZkZWFkIixuYXZ5OiIjMDAwMDgwIixvbGRsYWNlOiIjZmRmNWU2IixvbGl2ZToiIzgwODAwMCIsb2xpdmVkcmFiOiIjNmI4ZTIzIixvcmFuZ2U6IiNmZmE1MDAiLG9yYW5nZXJlZDoiI2ZmNDUwMCIsb3JjaGlkOiIjZGE3MGQ2IixwYWxlZ29sZGVucm9kOiIjZWVlOGFhIixwYWxlZ3JlZW46IiM5OGZiOTgiLHBhbGV0dXJxdW9pc2U6IiNhZmVlZWUiLHBhbGV2aW9sZXRyZWQ6IiNkODcwOTMiLHBhcGF5YXdoaXA6IiNmZmVmZDUiLHBlYWNocHVmZjoiI2ZmZGFiOSIscGVydToiI2NkODUzZiIscGluazoiI2ZmYzBjYiIscGx1bToiI2RkYTBkZCIscG93ZGVyYmx1ZToiI2IwZTBlNiIscHVycGxlOiIjODAwMDgwIixyZWJlY2NhcHVycGxlOiIjNjYzMzk5IixyZWQ6IiNmZjAwMDAiLHJvc3licm93bjoiI2JjOGY4ZiIscm95YWxibHVlOiIjNDE2OWUxIixzYWRkbGVicm93bjoiIzhiNDUxMyIsc2FsbW9uOiIjZmE4MDcyIixzYW5keWJyb3duOiIjZjRhNDYwIixzZWFncmVlbjoiIzJlOGI1NyIsc2Vhc2hlbGw6IiNmZmY1ZWUiLHNpZW5uYToiI2EwNTIyZCIsc2lsdmVyOiIjYzBjMGMwIixza3libHVlOiIjODdjZWViIixzbGF0ZWJsdWU6IiM2YTVhY2QiLHNsYXRlZ3JheToiIzcwODA5MCIsc25vdzoiI2ZmZmFmYSIsc3ByaW5nZ3JlZW46IiMwMGZmN2YiLHN0ZWVsYmx1ZToiIzQ2ODJiNCIsdGFuOiIjZDJiNDhjIix0ZWFsOiIjMDA4MDgwIix0aGlzdGxlOiIjZDhiZmQ4Iix0b21hdG86IiNmZjYzNDciLHR1cnF1b2lzZToiIzQwZTBkMCIsdmlvbGV0OiIjZWU4MmVlIix3aGVhdDoiI2Y1ZGViMyIsd2hpdGU6IiNmZmZmZmYiLHdoaXRlc21va2U6IiNmNWY1ZjUiLHllbGxvdzoiI2ZmZmYwMCIseWVsbG93Z3JlZW46IiM5YWNkMzIifTtyZXR1cm4gdm9pZCAwIT09ZVt0LnRvTG93ZXJDYXNlKCldJiZlW3QudG9Mb3dlckNhc2UoKV19KSh0KSl9dG9IZXgoKXtmdW5jdGlvbiB0KHQpe2NvbnN0IGU9TWF0aC5yb3VuZCgyNTUqdCkudG9TdHJpbmcoMTYpO3JldHVybiAxPT1lLmxlbmd0aD8iMCIrZTplfXJldHVybiIjIit0KHRoaXMucikrdCh0aGlzLmcpK3QodGhpcy5iKX1lcXVhbCh0KXtyZXR1cm4gdGhpcy5yPT10LnImJnRoaXMuZz09dC5nJiZ0aGlzLmI9PXQuYiYmdGhpcy5hPT10LmF9bm90ZXF1YWxzKHQpe3JldHVybiB0aGlzLnIhPXQuciYmdGhpcy5nIT10LmcmJnRoaXMuYiE9dC5iJiZ0aGlzLmEhPXQuYX1hcHByb3hFcXVhbCh0LGU9TnVtYmVyLkVQU0lMT04pe3JldHVybiBNYXRoLmFicyh0aGlzLnItdC5yKTxlJiZNYXRoLmFicyh0aGlzLmctdC5nKTxlJiZNYXRoLmFicyh0aGlzLmItdC5iKTxlJiZNYXRoLmFicyh0aGlzLmEtdC5hKTxlfWFkZCh0KXtyZXR1cm4gbmV3IG8odGhpcy5yK3Qucix0aGlzLmcrdC5nLHRoaXMuYit0LmIsdGhpcy5hK3QuYSl9c3VidHJhY3QodCl7cmV0dXJuIG5ldyBvKHRoaXMuci10LnIsdGhpcy5nLXQuZyx0aGlzLmItdC5iLHRoaXMuYS10LmEpfXNjYWxlKHQpe3JldHVybiBuZXcgbyh0aGlzLnIqdCx0aGlzLmcqdCx0aGlzLmIqdCx0aGlzLmEqdCl9c2NhbGVJblBsYWNlKHQpe3RoaXMucio9dCx0aGlzLmcqPXQsdGhpcy5iKj10LHRoaXMuYSo9dH1hcHBseUdhbW1hKHQpe3RoaXMuc2V0KE1hdGgucG93KHRoaXMucix0KSxNYXRoLnBvdyh0aGlzLmcsdCksTWF0aC5wb3codGhpcy5iLHQpLHRoaXMuYSl9dG9MaW5lYXIodD0yLjIpe3JldHVybiBuZXcgbyhNYXRoLnBvdyh0aGlzLnIsdCksTWF0aC5wb3codGhpcy5nLHQpLE1hdGgucG93KHRoaXMuYix0KSx0aGlzLmEpfXRvR2FtbWEodD0yLjIpe3JldHVybiBuZXcgbyhNYXRoLnBvdyh0aGlzLnIsMS90KSxNYXRoLnBvdyh0aGlzLmcsMS90KSxNYXRoLnBvdyh0aGlzLmIsMS90KSx0aGlzLmEpfWx1bWluYW5jZSgpe3JldHVybi4yMTI2KnRoaXMucisuNzE1Mip0aGlzLmcrLjA3MjIqdGhpcy5ifWxlcnAodCxlKXtjb25zdCBzPXRoaXMucixhPXRoaXMuZyxpPXRoaXMuYixyPXRoaXMuYTtyZXR1cm4gbmV3IG8ocytlKih0LnItcyksYStlKih0LmctYSksaStlKih0LmItaSkscitlKih0LmEtcikpfXN0YXRpYyByYW5kb20odD0wLGU9ITEpe3JldHVybiB0PjA/bmV3IG8odCtNYXRoLnJhbmRvbSgpKigxLXQpLHQrTWF0aC5yYW5kb20oKSooMS10KSx0K01hdGgucmFuZG9tKCkqKDEtdCksZT90K01hdGgucmFuZG9tKCkqKDEtdCk6MSk6dDwwP25ldyBvKE1hdGgucmFuZG9tKCkqKDErdCksTWF0aC5yYW5kb20oKSooMSt0KSxNYXRoLnJhbmRvbSgpKigxK3QpLGU/TWF0aC5yYW5kb20oKSooMSt0KToxKTpuZXcgbyhNYXRoLnJhbmRvbSgpLE1hdGgucmFuZG9tKCksTWF0aC5yYW5kb20oKSxlP01hdGgucmFuZG9tKCk6MSl9Y2xvbmUoKXtyZXR1cm4gbmV3IG8odGhpcy5fX2RhdGFbMF0sdGhpcy5fX2RhdGFbMV0sdGhpcy5fX2RhdGFbMl0sdGhpcy5fX2RhdGFbM10pfWFzQXJyYXkoKXtyZXR1cm4gdGhpcy5fX2RhdGF9YXMzQ29tcG9uZW50QXJyYXkoKXtyZXR1cm5bdGhpcy5fX2RhdGFbMF0sdGhpcy5fX2RhdGFbMV0sdGhpcy5fX2RhdGFbMl1dfXN0YXRpYyBjcmVhdGUoLi4udCl7cmV0dXJuIG5ldyBvKC4uLnQpfXN0YXRpYyBjcmVhdGVGcm9tRmxvYXQzMkJ1ZmZlcih0LGU9MCl7cmV0dXJuIG5ldyBvKHQsNCplKX1zdGF0aWMgbnVtRWxlbWVudHMoKXtyZXR1cm4gNH10b0pTT04oKXtyZXR1cm57cjp0aGlzLnIsZzp0aGlzLmcsYjp0aGlzLmIsYTp0aGlzLmF9fWZyb21KU09OKHQpe3RoaXMucj10LnIsdGhpcy5nPXQuZyx0aGlzLmI9dC5iLHRoaXMuYT10LmF9dG9DU1NTdHJpbmcoKXtyZXR1cm4icmdiYSgiK01hdGgucm91bmQoMjU1KnRoaXMucikrIiwgIitNYXRoLnJvdW5kKDI1NSp0aGlzLmcpKyIsICIrTWF0aC5yb3VuZCgyNTUqdGhpcy5iKSsiLCAiK3RoaXMuYSsiKSJ9fWEucmVnaXN0ZXJUeXBlKCJDb2xvciIsbyk7Y2xhc3MgXyBleHRlbmRzIHN7Y29uc3RydWN0b3IodD0wLGU9MCxzPTAsYT0wKXtpZihzdXBlcigpLGlzTmFOKGEpKXN3aXRjaChhKXtjYXNlIlhZWiI6dGhpcy5vcmRlcj0wO2JyZWFrO2Nhc2UiWVpYIjp0aGlzLm9yZGVyPTE7YnJlYWs7Y2FzZSJaWFkiOnRoaXMub3JkZXI9MjticmVhaztjYXNlIlhaWSI6dGhpcy5vcmRlcj0zO2JyZWFrO2Nhc2UiWllYIjp0aGlzLm9yZGVyPTQ7YnJlYWs7Y2FzZSJZWFoiOnRoaXMub3JkZXI9NTticmVhaztkZWZhdWx0OnRocm93IG5ldyBFcnJvcigiSW52YWxpZCBFdWxlciBBbmdsZXMgT3JkZXI6IithKX1lbHNlIHRoaXMub3JkZXI9YTtpZih0IGluc3RhbmNlb2YgQXJyYXlCdWZmZXIpe2NvbnN0IHM9dCxhPWU7dGhpcy5fX2RhdGE9bmV3IEZsb2F0MzJBcnJheShzLGEsNCl9ZWxzZSB0aGlzLl9fZGF0YT1uZXcgRmxvYXQzMkFycmF5KDMpLHRoaXMuX19kYXRhWzBdPXQsdGhpcy5fX2RhdGFbMV09ZSx0aGlzLl9fZGF0YVsyXT1zfWdldCB4KCl7cmV0dXJuIHRoaXMuX19kYXRhWzBdfXNldCB4KHQpe3RoaXMuX19kYXRhWzBdPXR9Z2V0IHkoKXtyZXR1cm4gdGhpcy5fX2RhdGFbMV19c2V0IHkodCl7dGhpcy5fX2RhdGFbMV09dH1nZXQgeigpe3JldHVybiB0aGlzLl9fZGF0YVsyXX1zZXQgeih0KXt0aGlzLl9fZGF0YVsyXT10fXNldCh0LGUscyl7dGhpcy5fX2RhdGFbMF09dCx0aGlzLl9fZGF0YVsxXT1lLHRoaXMuX19kYXRhWzJdPXN9fWEucmVnaXN0ZXJUeXBlKCJFdWxlckFuZ2xlcyIsXyk7Y2xhc3MgZCBleHRlbmRzIHN7Y29uc3RydWN0b3IodD0xLGU9MCxzPTAsYT0wLGk9MSxyPTAsbj0wLGg9MCxvPTEpe2lmKHN1cGVyKCksdCBpbnN0YW5jZW9mIEFycmF5QnVmZmVyKXtjb25zdCBzPXQsYT1lO3RoaXMuX19kYXRhPW5ldyBGbG9hdDMyQXJyYXkocyxhLDkpfWVsc2UgdGhpcy5fX2RhdGE9bmV3IEZsb2F0MzJBcnJheSg5KSx0aGlzLnNldCh0LGUscyxhLGkscixuLGgsbyl9Z2V0IG0wMCgpe3JldHVybiB0aGlzLl9fZGF0YVswXX1zZXQgbTAwKHQpe3RoaXMuX19kYXRhWzBdPXR9Z2V0IG0wMSgpe3JldHVybiB0aGlzLl9fZGF0YVsxXX1zZXQgbTAxKHQpe3RoaXMuX19kYXRhWzFdPXR9Z2V0IG0wMigpe3JldHVybiB0aGlzLl9fZGF0YVsyXX1zZXQgbTAyKHQpe3RoaXMuX19kYXRhWzJdPXR9Z2V0IG0xMCgpe3JldHVybiB0aGlzLl9fZGF0YVszXX1zZXQgbTEwKHQpe3RoaXMuX19kYXRhWzNdPXR9Z2V0IG0xMSgpe3JldHVybiB0aGlzLl9fZGF0YVs0XX1zZXQgbTExKHQpe3RoaXMuX19kYXRhWzRdPXR9Z2V0IG0xMigpe3JldHVybiB0aGlzLl9fZGF0YVs1XX1zZXQgbTEyKHQpe3RoaXMuX19kYXRhWzVdPXR9Z2V0IG0yMCgpe3JldHVybiB0aGlzLl9fZGF0YVs2XX1zZXQgbTIwKHQpe3RoaXMuX19kYXRhWzZdPXR9Z2V0IG0yMSgpe3JldHVybiB0aGlzLl9fZGF0YVs3XX1zZXQgbTIxKHQpe3RoaXMuX19kYXRhWzddPXR9Z2V0IG0yMigpe3JldHVybiB0aGlzLl9fZGF0YVs4XX1zZXQgbTIyKHQpe3RoaXMuX19kYXRhWzhdPXR9Z2V0IHhBeGlzKCl7cmV0dXJuIHIuY3JlYXRlRnJvbUZsb2F0MzJCdWZmZXIodGhpcy5fX2RhdGEuYnVmZmVyLDApfXNldCB4QXhpcyh0KXt0aGlzLnhBeGlzLnNldCh0LngsdC55LHQueil9Z2V0IHlBeGlzKCl7cmV0dXJuIHIuY3JlYXRlRnJvbUZsb2F0MzJCdWZmZXIodGhpcy5fX2RhdGEuYnVmZmVyLDMpfXNldCB5QXhpcyh0KXt0aGlzLnlBeGlzLnNldCh0LngsdC55LHQueil9Z2V0IHpBeGlzKCl7cmV0dXJuIHIuY3JlYXRlRnJvbUZsb2F0MzJCdWZmZXIodGhpcy5fX2RhdGEuYnVmZmVyLDYpfXNldCB6QXhpcyh0KXt0aGlzLnpBeGlzLnNldCh0LngsdC55LHQueil9c2V0KHQ9MSxlPTAscz0wLGE9MCxpPTEscj0wLG49MCxoPTAsbz0xKXt0aGlzLl9fZGF0YVswXT10LHRoaXMuX19kYXRhWzFdPWUsdGhpcy5fX2RhdGFbMl09cyx0aGlzLl9fZGF0YVszXT1hLHRoaXMuX19kYXRhWzRdPWksdGhpcy5fX2RhdGFbNV09cix0aGlzLl9fZGF0YVs2XT1uLHRoaXMuX19kYXRhWzddPWgsdGhpcy5fX2RhdGFbOF09b31zZXRJZGVudGl0eSgpe3RoaXMuc2V0KCl9c2V0RnJvbU1hdCh0KXt0aGlzLl9fZGF0YVswXT10Lm0wMCx0aGlzLl9fZGF0YVsxXT10Lm0wMSx0aGlzLl9fZGF0YVsyXT10Lm0wMix0aGlzLl9fZGF0YVszXT10Lm0xMCx0aGlzLl9fZGF0YVs0XT10Lm0xMSx0aGlzLl9fZGF0YVs1XT10Lm0xMix0aGlzLl9fZGF0YVs2XT10Lm0yMCx0aGlzLl9fZGF0YVs3XT10Lm0yMSx0aGlzLl9fZGF0YVs4XT10Lm0yMn1zZXRGcm9tRGlyZWN0aW9uQW5kVXB2ZWN0b3IodCxlKXtjb25zdCBzPXQsYT1zLmxlbmd0aCgpO2lmKGE8TnVtYmVyLkVQU0lMT04pcmV0dXJuIHZvaWQgdGhpcy5zZXRJZGVudGl0eSgpO3Muc2NhbGVJblBsYWNlKDEvYSk7Y29uc3QgaT1lLmNyb3NzKHMpLHI9aS5sZW5ndGgoKTtyPk51bWJlci5FUFNJTE9OJiZpLnNjYWxlSW5QbGFjZSgxL3IpO2NvbnN0IG49cy5jcm9zcyhpKSxoPW4ubGVuZ3RoKCk7aD5OdW1iZXIuRVBTSUxPTiYmbi5zY2FsZUluUGxhY2UoMS9oKSx0aGlzLnNldChpLngsaS55LGkueixuLngsbi55LG4ueixzLngscy55LHMueil9aW52ZXJzZSgpe2NvbnN0IHQ9dGhpcy5fX2RhdGFbMF0sZT10aGlzLl9fZGF0YVsxXSxzPXRoaXMuX19kYXRhWzJdLGE9dGhpcy5fX2RhdGFbM10saT10aGlzLl9fZGF0YVs0XSxyPXRoaXMuX19kYXRhWzVdLG49dGhpcy5fX2RhdGFbNl0saD10aGlzLl9fZGF0YVs3XSxvPXRoaXMuX19kYXRhWzhdLF89byppLXIqaCxsPS1vKmErcipuLGM9aCphLWkqbix1PXQqXytlKmwrcypjO3JldHVybiB1Pyh1PTEvdSxuZXcgZChfKnUsKC1vKmUrcypoKSp1LChyKmUtcyppKSp1LGwqdSwobyp0LXMqbikqdSwoLXIqdCtzKmEpKnUsYyp1LCgtaCp0K2UqbikqdSwoaSp0LWUqYSkqdSkpOihjb25zb2xlLndhcm4oIlVuYWJsZSB0byBpbnZlcnQgTWF0MyIpLG51bGwpfWludmVydEluUGxhY2UoKXtjb25zdCB0PXRoaXMuX19kYXRhWzBdLGU9dGhpcy5fX2RhdGFbMV0scz10aGlzLl9fZGF0YVsyXSxhPXRoaXMuX19kYXRhWzNdLGk9dGhpcy5fX2RhdGFbNF0scj10aGlzLl9fZGF0YVs1XSxuPXRoaXMuX19kYXRhWzZdLGg9dGhpcy5fX2RhdGFbN10sbz10aGlzLl9fZGF0YVs4XSxfPW8qaS1yKmgsZD0tbyphK3IqbixsPWgqYS1pKm4sYz10Kl8rZSpkK3MqbDtyZXR1cm4gYz8oYz0xL2MsdGhpcy5zZXQoXypjLCgtbyplK3MqaCkqYywociplLXMqaSkqYyxkKmMsKG8qdC1zKm4pKmMsKC1yKnQrcyphKSpjLGwqYywoLWgqdCtlKm4pKmMsKGkqdC1lKmEpKmMpLCEwKTooY29uc29sZS53YXJuKCJVbmFibGUgdG8gaW52ZXJ0IE1hdDMiKSwhMSl9dHJhbnNwb3NlKCl7cmV0dXJuIGQodGhpcy5fX2RhdGFbMF0sdGhpcy5fX2RhdGFbM10sdGhpcy5fX2RhdGFbNl0sdGhpcy5fX2RhdGFbMV0sdGhpcy5fX2RhdGFbNF0sdGhpcy5fX2RhdGFbN10sdGhpcy5fX2RhdGFbMl0sdGhpcy5fX2RhdGFbNV0sdGhpcy5fX2RhdGFbOF0pfXRyYW5zcG9zZUluUGxhY2UoKXtjb25zdCB0PXRoaXMuX19kYXRhWzFdLGU9dGhpcy5fX2RhdGFbMl0scz10aGlzLl9fZGF0YVs1XTt0aGlzLl9fZGF0YVsxXT10aGlzLl9fZGF0YVszXSx0aGlzLl9fZGF0YVsyXT10aGlzLl9fZGF0YVs2XSx0aGlzLl9fZGF0YVszXT10LHRoaXMuX19kYXRhWzVdPXRoaXMuX19kYXRhWzddLHRoaXMuX19kYXRhWzZdPWUsdGhpcy5fX2RhdGFbN109c310cmFuc2Zvcm1WZWMzKHQpe3JldHVybiBuZXcgcih0aGlzLl9fZGF0YVswXSp0LngrdGhpcy5fX2RhdGFbMV0qdC55K3RoaXMuX19kYXRhWzJdKnQueix0aGlzLl9fZGF0YVszXSp0LngrdGhpcy5fX2RhdGFbNF0qdC55K3RoaXMuX19kYXRhWzVdKnQueix0aGlzLl9fZGF0YVs2XSp0LngrdGhpcy5fX2RhdGFbN10qdC55K3RoaXMuX19kYXRhWzhdKnQueil9Y2xvbmUoKXtyZXR1cm4gbmV3IGQodGhpcy5fX2RhdGFbMF0sdGhpcy5fX2RhdGFbMV0sdGhpcy5fX2RhdGFbMl0sdGhpcy5fX2RhdGFbM10sdGhpcy5fX2RhdGFbNF0sdGhpcy5fX2RhdGFbNV0sdGhpcy5fX2RhdGFbNl0sdGhpcy5fX2RhdGFbN10sdGhpcy5fX2RhdGFbOF0sdGhpcy5fX2RhdGFbOV0pfXN0YXRpYyBjcmVhdGUoLi4udCl7cmV0dXJuIG5ldyBkKC4uLnQpfXN0YXRpYyBjcmVhdGVGcm9tRmxvYXQzMkJ1ZmZlcih0LGU9MCl7cmV0dXJuIG5ldyBkKHQsNCplKX10b0pTT04oKXtyZXR1cm4gdGhpcy5fX2RhdGF9ZnJvbUpTT04odCl7dGhpcy5fX2RhdGE9bmV3IEZsb2F0MzJBcnJheSh0KX10b1N0cmluZygpe3JldHVybiB0aGlzLnRvSlNPTigpLnRvU3RyaW5nKCl9fWEucmVnaXN0ZXJUeXBlKCJNYXQzIixkKTtjbGFzcyBsIGV4dGVuZHMgc3tjb25zdHJ1Y3Rvcih0PTEsZT0wLHM9MCxhPTAsaT0wLHI9MSxuPTAsaD0wLG89MCxfPTAsZD0xLGw9MCxjPTAsdT0wLGY9MCxtPTEpe2lmKHN1cGVyKCksdCBpbnN0YW5jZW9mIEZsb2F0MzJBcnJheSl0aGlzLl9fZGF0YT10O2Vsc2UgaWYodCBpbnN0YW5jZW9mIEFycmF5QnVmZmVyKXtjb25zdCBzPXQsYT1lO3RoaXMuX19kYXRhPW5ldyBGbG9hdDMyQXJyYXkocyxhLDE2KX1lbHNlIHRoaXMuX19kYXRhPW5ldyBGbG9hdDMyQXJyYXkoMTYpLHRoaXMuc2V0KHQsZSxzLGEsaSxyLG4saCxvLF8sZCxsLGMsdSxmLG0pfWdldCBtMDAoKXtyZXR1cm4gdGhpcy5fX2RhdGFbMF19c2V0IG0wMCh0KXt0aGlzLl9fZGF0YVswXT10fWdldCBtMDEoKXtyZXR1cm4gdGhpcy5fX2RhdGFbMV19c2V0IG0wMSh0KXt0aGlzLl9fZGF0YVsxXT10fWdldCBtMDIoKXtyZXR1cm4gdGhpcy5fX2RhdGFbMl19c2V0IG0wMih0KXt0aGlzLl9fZGF0YVsyXT10fWdldCBtMDMoKXtyZXR1cm4gdGhpcy5fX2RhdGFbM119c2V0IG0wMyh0KXt0aGlzLl9fZGF0YVszXT10fWdldCBtMTAoKXtyZXR1cm4gdGhpcy5fX2RhdGFbNF19c2V0IG0xMCh0KXt0aGlzLl9fZGF0YVs0XT10fWdldCBtMTEoKXtyZXR1cm4gdGhpcy5fX2RhdGFbNV19c2V0IG0xMSh0KXt0aGlzLl9fZGF0YVs1XT10fWdldCBtMTIoKXtyZXR1cm4gdGhpcy5fX2RhdGFbNl19c2V0IG0xMih0KXt0aGlzLl9fZGF0YVs2XT10fWdldCBtMTMoKXtyZXR1cm4gdGhpcy5fX2RhdGFbN119c2V0IG0xMyh0KXt0aGlzLl9fZGF0YVs3XT10fWdldCBtMjAoKXtyZXR1cm4gdGhpcy5fX2RhdGFbOF19c2V0IG0yMCh0KXt0aGlzLl9fZGF0YVs4XT10fWdldCBtMjEoKXtyZXR1cm4gdGhpcy5fX2RhdGFbOV19c2V0IG0yMSh0KXt0aGlzLl9fZGF0YVs5XT10fWdldCBtMjIoKXtyZXR1cm4gdGhpcy5fX2RhdGFbMTBdfXNldCBtMjIodCl7dGhpcy5fX2RhdGFbMTBdPXR9Z2V0IG0yMygpe3JldHVybiB0aGlzLl9fZGF0YVsxMV19c2V0IG0yMyh0KXt0aGlzLl9fZGF0YVsxMV09dH1nZXQgbTMwKCl7cmV0dXJuIHRoaXMuX19kYXRhWzEyXX1zZXQgbTMwKHQpe3RoaXMuX19kYXRhWzEyXT10fWdldCBtMzEoKXtyZXR1cm4gdGhpcy5fX2RhdGFbMTNdfXNldCBtMzEodCl7dGhpcy5fX2RhdGFbMTNdPXR9Z2V0IG0zMigpe3JldHVybiB0aGlzLl9fZGF0YVsxNF19c2V0IG0zMih0KXt0aGlzLl9fZGF0YVsxNF09dH1nZXQgbTMzKCl7cmV0dXJuIHRoaXMuX19kYXRhWzE1XX1zZXQgbTMzKHQpe3RoaXMuX19kYXRhWzE1XT10fWdldCB4QXhpcygpe3JldHVybiByLmNyZWF0ZUZyb21GbG9hdDMyQnVmZmVyKHRoaXMuX19kYXRhLmJ1ZmZlciwwKX1zZXQgeEF4aXModCl7dGhpcy54QXhpcy5zZXQodC54LHQueSx0LnopfWdldCB5QXhpcygpe3JldHVybiByLmNyZWF0ZUZyb21GbG9hdDMyQnVmZmVyKHRoaXMuX19kYXRhLmJ1ZmZlciw0KX1zZXQgeUF4aXModCl7dGhpcy55QXhpcy5zZXQodC54LHQueSx0LnopfWdldCB6QXhpcygpe3JldHVybiByLmNyZWF0ZUZyb21GbG9hdDMyQnVmZmVyKHRoaXMuX19kYXRhLmJ1ZmZlciw4KX1zZXQgekF4aXModCl7dGhpcy56QXhpcy5zZXQodC54LHQueSx0LnopfWdldCB0cmFuc2xhdGlvbigpe3JldHVybiByLmNyZWF0ZUZyb21GbG9hdDMyQnVmZmVyKHRoaXMuX19kYXRhLmJ1ZmZlciwxMil9c2V0IHRyYW5zbGF0aW9uKHQpe3RoaXMudHJhbnNsYXRpb24uc2V0KHQueCx0LnksdC56KX1zZXQodD0xLGU9MCxzPTAsYT0wLGk9MCxyPTEsbj0wLGg9MCxvPTAsXz0wLGQ9MSxsPTAsYz0wLHU9MCxmPTAsbT0xKXt0aGlzLl9fZGF0YVswXT10LHRoaXMuX19kYXRhWzFdPWUsdGhpcy5fX2RhdGFbMl09cyx0aGlzLl9fZGF0YVszXT1hLHRoaXMuX19kYXRhWzRdPWksdGhpcy5fX2RhdGFbNV09cix0aGlzLl9fZGF0YVs2XT1uLHRoaXMuX19kYXRhWzddPWgsdGhpcy5fX2RhdGFbOF09byx0aGlzLl9fZGF0YVs5XT1fLHRoaXMuX19kYXRhWzEwXT1kLHRoaXMuX19kYXRhWzExXT1sLHRoaXMuX19kYXRhWzEyXT1jLHRoaXMuX19kYXRhWzEzXT11LHRoaXMuX19kYXRhWzE0XT1mLHRoaXMuX19kYXRhWzE1XT1tfXNldElkZW50aXR5KCl7dGhpcy5zZXQoKX1zZXREYXRhQXJyYXkodCl7dGhpcy5fX2RhdGE9dH1zZXRGcm9tTWF0NCh0KXt0aGlzLl9fZGF0YVswXT10Lm0wMCx0aGlzLl9fZGF0YVsxXT10Lm0wMSx0aGlzLl9fZGF0YVsyXT10Lm0wMix0aGlzLl9fZGF0YVszXT10Lm0wMyx0aGlzLl9fZGF0YVs0XT10Lm0xMCx0aGlzLl9fZGF0YVs1XT10Lm0xMSx0aGlzLl9fZGF0YVs2XT10Lm0xMix0aGlzLl9fZGF0YVs3XT10Lm0xMyx0aGlzLl9fZGF0YVs4XT10Lm0yMCx0aGlzLl9fZGF0YVs5XT10Lm0yMSx0aGlzLl9fZGF0YVsxMF09dC5tMjIsdGhpcy5fX2RhdGFbMTFdPXQubTIzLHRoaXMuX19kYXRhWzEyXT10Lm0zMCx0aGlzLl9fZGF0YVsxM109dC5tMzEsdGhpcy5fX2RhdGFbMTRdPXQubTMyLHRoaXMuX19kYXRhWzE1XT10Lm0zM310b01hdDModCl7cmV0dXJuIG5ldyBkKHRoaXMuX19kYXRhWzBdLHRoaXMuX19kYXRhWzFdLHRoaXMuX19kYXRhWzJdLHRoaXMuX19kYXRhWzRdLHRoaXMuX19kYXRhWzVdLHRoaXMuX19kYXRhWzZdLHRoaXMuX19kYXRhWzhdLHRoaXMuX19kYXRhWzldLHRoaXMuX19kYXRhWzEwXSl9dHJhbnNwb3NlSW5QbGFjZSgpe2NvbnN0IHQ9dGhpcy5fX2RhdGFbMV0sZT10aGlzLl9fZGF0YVsyXSxzPXRoaXMuX19kYXRhWzNdLGE9dGhpcy5fX2RhdGFbNl0saT10aGlzLl9fZGF0YVs3XSxyPXRoaXMuX19kYXRhWzExXTt0aGlzLl9fZGF0YVsxXT10aGlzLl9fZGF0YVs0XSx0aGlzLl9fZGF0YVsyXT10aGlzLl9fZGF0YVs4XSx0aGlzLl9fZGF0YVszXT10aGlzLl9fZGF0YVsxMl0sdGhpcy5fX2RhdGFbNF09dCx0aGlzLl9fZGF0YVs2XT10aGlzLl9fZGF0YVs5XSx0aGlzLl9fZGF0YVs3XT10aGlzLl9fZGF0YVsxM10sdGhpcy5fX2RhdGFbOF09ZSx0aGlzLl9fZGF0YVs5XT1hLHRoaXMuX19kYXRhWzExXT10aGlzLl9fZGF0YVsxNF0sdGhpcy5fX2RhdGFbMTJdPXMsdGhpcy5fX2RhdGFbMTNdPWksdGhpcy5fX2RhdGFbMTRdPXJ9dHJhbnNwb3NlKCl7cmV0dXJuIG5ldyBsKHRoaXMuX19kYXRhWzBdLHRoaXMuX19kYXRhWzRdLHRoaXMuX19kYXRhWzhdLHRoaXMuX19kYXRhWzEyXSx0aGlzLl9fZGF0YVsxXSx0aGlzLl9fZGF0YVs1XSx0aGlzLl9fZGF0YVs5XSx0aGlzLl9fZGF0YVsxM10sdGhpcy5fX2RhdGFbMl0sdGhpcy5fX2RhdGFbNl0sdGhpcy5fX2RhdGFbMTBdLHRoaXMuX19kYXRhWzE0XSx0aGlzLl9fZGF0YVszXSx0aGlzLl9fZGF0YVs3XSx0aGlzLl9fZGF0YVsxMV0sdGhpcy5fX2RhdGFbMTVdKX1pbnZlcnNlKCl7Y29uc3QgdD10aGlzLl9fZGF0YVswXSxlPXRoaXMuX19kYXRhWzFdLHM9dGhpcy5fX2RhdGFbMl0sYT10aGlzLl9fZGF0YVszXSxpPXRoaXMuX19kYXRhWzRdLHI9dGhpcy5fX2RhdGFbNV0sbj10aGlzLl9fZGF0YVs2XSxoPXRoaXMuX19kYXRhWzddLG89dGhpcy5fX2RhdGFbOF0sXz10aGlzLl9fZGF0YVs5XSxkPXRoaXMuX19kYXRhWzEwXSxjPXRoaXMuX19kYXRhWzExXSx1PXRoaXMuX19kYXRhWzEyXSxmPXRoaXMuX19kYXRhWzEzXSxtPXRoaXMuX19kYXRhWzE0XSxnPXRoaXMuX19kYXRhWzE1XSx5PXQqci1lKmkscD10Km4tcyppLGI9dCpoLWEqaSx4PWUqbi1zKnIsdz1lKmgtYSpyLEk9cypoLWEqbixOPW8qZi1fKnUsRj1vKm0tZCp1LHo9bypnLWMqdSxWPV8qbS1kKmYsTT1fKmctYypmLEE9ZCpnLWMqbTtsZXQgUz15KkEtcCpNK2IqVit4KnotdypGK0kqTjtyZXR1cm4gUz8oUz0xL1MsbmV3IGwoKHIqQS1uKk0raCpWKSpTLChzKk0tZSpBLWEqVikqUywoZipJLW0qdytnKngpKlMsKGQqdy1fKkktYyp4KSpTLChuKnotaSpBLWgqRikqUywodCpBLXMqeithKkYpKlMsKG0qYi11KkktZypwKSpTLChvKkktZCpiK2MqcCkqUywoaSpNLXIqeitoKk4pKlMsKGUqei10Kk0tYSpOKSpTLCh1KnctZipiK2cqeSkqUywoXypiLW8qdy1jKnkpKlMsKHIqRi1pKlYtbipOKSpTLCh0KlYtZSpGK3MqTikqUywoZipwLXUqeC1tKnkpKlMsKG8qeC1fKnArZCp5KSpTKSk6KGNvbnNvbGUud2FybigiVW5hYmxlIHRvIGludmVydCBNYXQ0IiksbnVsbCl9aW52ZXJ0SW5QbGFjZSgpe2NvbnN0IHQ9dGhpcy5fX2RhdGFbMF0sZT10aGlzLl9fZGF0YVsxXSxzPXRoaXMuX19kYXRhWzJdLGE9dGhpcy5fX2RhdGFbM10saT10aGlzLl9fZGF0YVs0XSxyPXRoaXMuX19kYXRhWzVdLG49dGhpcy5fX2RhdGFbNl0saD10aGlzLl9fZGF0YVs3XSxvPXRoaXMuX19kYXRhWzhdLF89dGhpcy5fX2RhdGFbOV0sZD10aGlzLl9fZGF0YVsxMF0sbD10aGlzLl9fZGF0YVsxMV0sYz10aGlzLl9fZGF0YVsxMl0sdT10aGlzLl9fZGF0YVsxM10sZj10aGlzLl9fZGF0YVsxNF0sbT10aGlzLl9fZGF0YVsxNV0sZz10KnItZSppLHk9dCpuLXMqaSxwPXQqaC1hKmksYj1lKm4tcypyLHg9ZSpoLWEqcix3PXMqaC1hKm4sST1vKnUtXypjLE49bypmLWQqYyxGPW8qbS1sKmMsej1fKmYtZCp1LFY9XyptLWwqdSxNPWQqbS1sKmY7bGV0IEE9ZypNLXkqVitwKnorYipGLXgqTit3Kkk7cmV0dXJuIEE/KEE9MS9BLHRoaXMuc2V0KChyKk0tbipWK2gqeikqQSwocypWLWUqTS1hKnopKkEsKHUqdy1mKngrbSpiKSpBLChkKngtXyp3LWwqYikqQSwobipGLWkqTS1oKk4pKkEsKHQqTS1zKkYrYSpOKSpBLChmKnAtYyp3LW0qeSkqQSwobyp3LWQqcCtsKnkpKkEsKGkqVi1yKkYraCpJKSpBLChlKkYtdCpWLWEqSSkqQSwoYyp4LXUqcCttKmcpKkEsKF8qcC1vKngtbCpnKSpBLChyKk4taSp6LW4qSSkqQSwodCp6LWUqTitzKkkpKkEsKHUqeS1jKmItZipnKSpBLChvKmItXyp5K2QqZykqQSksITApOihjb25zb2xlLndhcm4oIlVuYWJsZSB0byBpbnZlcnQgTWF0NCIpLCExKX1zZXRJbnZlcnNlKHQpe2NvbnN0IGU9dC5fX2RhdGFbMF0scz10Ll9fZGF0YVsxXSxhPXQuX19kYXRhWzJdLGk9dC5fX2RhdGFbM10scj10Ll9fZGF0YVs0XSxuPXQuX19kYXRhWzVdLGg9dC5fX2RhdGFbNl0sbz10Ll9fZGF0YVs3XSxfPXQuX19kYXRhWzhdLGQ9dC5fX2RhdGFbOV0sbD10Ll9fZGF0YVsxMF0sYz10Ll9fZGF0YVsxMV0sdT10Ll9fZGF0YVsxMl0sZj10Ll9fZGF0YVsxM10sbT10Ll9fZGF0YVsxNF0sZz10Ll9fZGF0YVsxNV0seT1lKm4tcypyLHA9ZSpoLWEqcixiPWUqby1pKnIseD1zKmgtYSpuLHc9cypvLWkqbixJPWEqby1pKmgsTj1fKmYtZCp1LEY9XyptLWwqdSx6PV8qZy1jKnUsVj1kKm0tbCpmLE09ZCpnLWMqZixBPWwqZy1jKm07bGV0IFM9eSpBLXAqTStiKlYreCp6LXcqRitJKk47aWYoIVMpdGhyb3cgbmV3IEVycm9yKCJVbmFibGUgdG8gaW52ZXJ0IE1hdDQiKTtTPTEvUyx0aGlzLnNldCgobipBLWgqTStvKlYpKlMsKGEqTS1zKkEtaSpWKSpTLChmKkktbSp3K2cqeCkqUywobCp3LWQqSS1jKngpKlMsKGgqei1yKkEtbypGKSpTLChlKkEtYSp6K2kqRikqUywobSpiLXUqSS1nKnApKlMsKF8qSS1sKmIrYypwKSpTLChyKk0tbip6K28qTikqUywocyp6LWUqTS1pKk4pKlMsKHUqdy1mKmIrZyp5KSpTLChkKmItXyp3LWMqeSkqUywobipGLXIqVi1oKk4pKlMsKGUqVi1zKkYrYSpOKSpTLChmKnAtdSp4LW0qeSkqUywoXyp4LWQqcCtsKnkpKlMpfW11bHRpcGx5KHQpe2NvbnN0IGU9dGhpcy5fX2RhdGFbMF0scz10aGlzLl9fZGF0YVsxXSxhPXRoaXMuX19kYXRhWzJdLGk9dGhpcy5fX2RhdGFbM10scj10aGlzLl9fZGF0YVs0XSxuPXRoaXMuX19kYXRhWzVdLGg9dGhpcy5fX2RhdGFbNl0sbz10aGlzLl9fZGF0YVs3XSxfPXRoaXMuX19kYXRhWzhdLGQ9dGhpcy5fX2RhdGFbOV0sYz10aGlzLl9fZGF0YVsxMF0sdT10aGlzLl9fZGF0YVsxMV0sZj10aGlzLl9fZGF0YVsxMl0sbT10aGlzLl9fZGF0YVsxM10sZz10aGlzLl9fZGF0YVsxNF0seT10aGlzLl9fZGF0YVsxNV0scD10LmFzQXJyYXkoKTtsZXQgYj1wWzBdLHg9cFsxXSx3PXBbMl0sST1wWzNdO2NvbnN0IE49bmV3IGw7cmV0dXJuIE4ubTAwPWIqZSt4KnIrdypfK0kqZixOLm0wMT1iKnMreCpuK3cqZCtJKm0sTi5tMDI9YiphK3gqaCt3KmMrSSpnLE4ubTAzPWIqaSt4Km8rdyp1K0kqeSxiPXBbNF0seD1wWzVdLHc9cFs2XSxJPXBbN10sTi5tMTA9YiplK3gqcit3Kl8rSSpmLE4ubTExPWIqcyt4Km4rdypkK0kqbSxOLm0xMj1iKmEreCpoK3cqYytJKmcsTi5tMTM9YippK3gqbyt3KnUrSSp5LGI9cFs4XSx4PXBbOV0sdz1wWzEwXSxJPXBbMTFdLE4ubTIwPWIqZSt4KnIrdypfK0kqZixOLm0yMT1iKnMreCpuK3cqZCtJKm0sTi5tMjI9YiphK3gqaCt3KmMrSSpnLE4ubTIzPWIqaSt4Km8rdyp1K0kqeSxiPXBbMTJdLHg9cFsxM10sdz1wWzE0XSxJPXBbMTVdLE4ubTMwPWIqZSt4KnIrdypfK0kqZixOLm0zMT1iKnMreCpuK3cqZCtJKm0sTi5tMzI9YiphK3gqaCt3KmMrSSpnLE4ubTMzPWIqaSt4Km8rdyp1K0kqeSxOfW11bHRpcGx5SW5QbGFjZSh0KXtjb25zdCBlPXRoaXMuYXNBcnJheSgpLHM9ZVswXSxhPWVbMV0saT1lWzJdLHI9ZVszXSxuPWVbNF0saD1lWzVdLG89ZVs2XSxfPWVbN10sZD1lWzhdLGw9ZVs5XSxjPWVbMTBdLHU9ZVsxMV0sZj1lWzEyXSxtPWVbMTNdLGc9ZVsxNF0seT1lWzE1XSxwPXQuYXNBcnJheSgpO2xldCBiPXBbMF0seD1wWzFdLHc9cFsyXSxJPXBbM107cmV0dXJuIHRoaXMubTAwPWIqcyt4Km4rdypkK0kqZix0aGlzLm0wMT1iKmEreCpoK3cqbCtJKm0sdGhpcy5tMDI9YippK3gqbyt3KmMrSSpnLHRoaXMubTAzPWIqcit4Kl8rdyp1K0kqeSxiPXBbNF0seD1wWzVdLHc9cFs2XSxJPXBbN10sdGhpcy5tMTA9YipzK3gqbit3KmQrSSpmLHRoaXMubTExPWIqYSt4KmgrdypsK0kqbSx0aGlzLm0xMj1iKmkreCpvK3cqYytJKmcsdGhpcy5tMTM9YipyK3gqXyt3KnUrSSp5LGI9cFs4XSx4PXBbOV0sdz1wWzEwXSxJPXBbMTFdLHRoaXMubTIwPWIqcyt4Km4rdypkK0kqZix0aGlzLm0yMT1iKmEreCpoK3cqbCtJKm0sdGhpcy5tMjI9YippK3gqbyt3KmMrSSpnLHRoaXMubTIzPWIqcit4Kl8rdyp1K0kqeSxiPXBbMTJdLHg9cFsxM10sdz1wWzE0XSxJPXBbMTVdLHRoaXMubTMwPWIqcyt4Km4rdypkK0kqZix0aGlzLm0zMT1iKmEreCpoK3cqbCtJKm0sdGhpcy5tMzI9YippK3gqbyt3KmMrSSpnLHRoaXMubTMzPWIqcit4Kl8rdyp1K0kqeSx0aGlzfXBvc3RtdWx0aXBseUluUGxhY2UodCl7Y29uc3QgZT10LmFzQXJyYXkoKSxzPWVbMF0sYT1lWzFdLGk9ZVsyXSxyPWVbM10sbj1lWzRdLGg9ZVs1XSxvPWVbNl0sXz1lWzddLGQ9ZVs4XSxsPWVbOV0sYz1lWzEwXSx1PWVbMTFdLGY9ZVsxMl0sbT1lWzEzXSxnPWVbMTRdLHk9ZVsxNV0scD10aGlzLmFzQXJyYXkoKTtsZXQgYj1wWzBdLHg9cFsxXSx3PXBbMl0sST1wWzNdO3JldHVybiB0aGlzLm0wMD1iKnMreCpuK3cqZCtJKmYsdGhpcy5tMDE9YiphK3gqaCt3KmwrSSptLHRoaXMubTAyPWIqaSt4Km8rdypjK0kqZyx0aGlzLm0wMz1iKnIreCpfK3cqdStJKnksYj1wWzRdLHg9cFs1XSx3PXBbNl0sST1wWzddLHRoaXMubTEwPWIqcyt4Km4rdypkK0kqZix0aGlzLm0xMT1iKmEreCpoK3cqbCtJKm0sdGhpcy5tMTI9YippK3gqbyt3KmMrSSpnLHRoaXMubTEzPWIqcit4Kl8rdyp1K0kqeSxiPXBbOF0seD1wWzldLHc9cFsxMF0sST1wWzExXSx0aGlzLm0yMD1iKnMreCpuK3cqZCtJKmYsdGhpcy5tMjE9YiphK3gqaCt3KmwrSSptLHRoaXMubTIyPWIqaSt4Km8rdypjK0kqZyx0aGlzLm0yMz1iKnIreCpfK3cqdStJKnksYj1wWzEyXSx4PXBbMTNdLHc9cFsxNF0sST1wWzE1XSx0aGlzLm0zMD1iKnMreCpuK3cqZCtJKmYsdGhpcy5tMzE9YiphK3gqaCt3KmwrSSptLHRoaXMubTMyPWIqaSt4Km8rdypjK0kqZyx0aGlzLm0zMz1iKnIreCpfK3cqdStJKnksdGhpc310cmFuc2xhdGVJblBsYWNlKHQpe2NvbnN0IGU9dGhpcy5fX2RhdGEscz10LngsYT10LnksaT10Lno7cmV0dXJuIGVbMTJdPWVbMF0qcytlWzRdKmErZVs4XSppK2VbMTJdLGVbMTNdPWVbMV0qcytlWzVdKmErZVs5XSppK2VbMTNdLGVbMTRdPWVbMl0qcytlWzZdKmErZVsxMF0qaStlWzE0XSxlWzE1XT1lWzNdKnMrZVs3XSphK2VbMTFdKmkrZVsxNV0sdGhpc31zZXRMb29rQXQodCxlLHMpe2NvbnN0IGE9dC5zdWJ0cmFjdChlKSxpPWEubGVuZ3RoKCk7aWYoaTxOdW1iZXIuRVBTSUxPTilyZXR1cm4gdm9pZCB0aGlzLnNldElkZW50aXR5KCk7YS5zY2FsZUluUGxhY2UoMS9pKTtjb25zdCByPXMuY3Jvc3MoYSksbj1yLmxlbmd0aCgpO24+TnVtYmVyLkVQU0lMT04mJnIuc2NhbGVJblBsYWNlKDEvbik7Y29uc3QgaD1hLmNyb3NzKHIpLG89aC5sZW5ndGgoKTtvPk51bWJlci5FUFNJTE9OJiZoLnNjYWxlSW5QbGFjZSgxL28pLHRoaXMuc2V0KHIueCxyLnksci56LDAsaC54LGgueSxoLnosMCxhLngsYS55LGEueiwwLHQueCx0LnksdC56LDEpfXNldFJvdGF0aW9uKHQsZSl7Y29uc3Qgcz10Lmxlbmd0aCgpO2lmKE1hdGguYWJzKHMpPE51bWJlci5FUFNJTE9OKXJldHVybiBudWxsO2NvbnN0IGE9dC54L3MsaT10LnkvcyxyPXQuei9zLG49TWF0aC5zaW4oZSksaD1NYXRoLmNvcyhlKSxvPTEtaCxfPXRoaXMuX19kYXRhO3JldHVybiBfWzBdPWEqYSpvK2gsX1sxXT1pKmEqbytyKm4sX1syXT1yKmEqby1pKm4sX1szXT0wLF9bNF09YSppKm8tcipuLF9bNV09aSppKm8raCxfWzZdPXIqaSpvK2EqbixfWzddPTAsX1s4XT1hKnIqbytpKm4sX1s5XT1pKnIqby1hKm4sX1sxMF09cipyKm8raCxfWzExXT0wLF9bMTJdPTAsX1sxM109MCxfWzE0XT0wLF9bMTVdPTEsdGhpc31zZXRYUm90YXRpb24odCl7Y29uc3QgZT1NYXRoLnNpbih0KSxzPU1hdGguY29zKHQpLGE9dGhpcy5fX2RhdGE7cmV0dXJuIGFbMF09MSxhWzFdPTAsYVsyXT0wLGFbM109MCxhWzRdPTAsYVs1XT1zLGFbNl09ZSxhWzddPTAsYVs4XT0wLGFbOV09LWUsYVsxMF09cyxhWzExXT0wLGFbMTJdPTAsYVsxM109MCxhWzE0XT0wLGFbMTVdPTEsdGhpc31zZXRZUm90YXRpb24odCl7Y29uc3QgZT1NYXRoLnNpbih0KSxzPU1hdGguY29zKHQpLGE9dGhpcy5fX2RhdGE7cmV0dXJuIGFbMF09cyxhWzFdPTAsYVsyXT0tZSxhWzNdPTAsYVs0XT0wLGFbNV09MSxhWzZdPTAsYVs3XT0wLGFbOF09ZSxhWzldPTAsYVsxMF09cyxhWzExXT0wLGFbMTJdPTAsYVsxM109MCxhWzE0XT0wLGFbMTVdPTEsdGhpc31zZXRaUm90YXRpb24odCl7Y29uc3QgZT1NYXRoLnNpbih0KSxzPU1hdGguY29zKHQpLGE9dGhpcy5fX2RhdGE7cmV0dXJuIGFbMF09cyxhWzFdPWUsYVsyXT0wLGFbM109MCxhWzRdPS1lLGFbNV09cyxhWzZdPTAsYVs3XT0wLGFbOF09MCxhWzldPTAsYVsxMF09MSxhWzExXT0wLGFbMTJdPTAsYVsxM109MCxhWzE0XT0wLGFbMTVdPTEsdGhpc310cmFuc2Zvcm1WZWM0KHQpe2NvbnN0IGU9dGhpcy5fX2RhdGEscz10LngsYT10LnksaT10Lnoscj10LnQ7cmV0dXJuIG5ldyBWZWM0KGVbMF0qcytlWzRdKmErZVs4XSppK2VbMTJdKnIsZVsxXSpzK2VbNV0qYStlWzldKmkrZVsxM10qcixlWzJdKnMrZVs2XSphK2VbMTBdKmkrZVsxNF0qcixlWzNdKnMrZVs3XSphK2VbMTFdKmkrZVsxNV0qcil9dHJhbnNmb3JtVmVjMyh0KXtjb25zdCBlPXRoaXMuX19kYXRhLHM9dC54LGE9dC55LGk9dC56O3JldHVybiBuZXcgcihlWzBdKnMrZVs0XSphK2VbOF0qaStlWzEyXSxlWzFdKnMrZVs1XSphK2VbOV0qaStlWzEzXSxlWzJdKnMrZVs2XSphK2VbMTBdKmkrZVsxNF0pfXJvdGF0ZVZlYzModCl7Y29uc3QgZT10aGlzLl9fZGF0YSxzPXQueCxhPXQueSxpPXQuejtyZXR1cm4gbmV3IHIoZVswXSpzK2VbNF0qYStlWzhdKmksZVsxXSpzK2VbNV0qYStlWzldKmksZVsyXSpzK2VbNl0qYStlWzEwXSppKX1zZXRQZXJzcGVjdGl2ZU1hdHJpeCh0LGUscyxhKXtjb25zdCBpPU1hdGgudGFuKC41Kk1hdGguUEktLjUqdCkscj0xLyhzLWEpO3RoaXMuc2V0KGkvZSwwLDAsMCwwLGksMCwwLDAsMCwocythKSpyLC0xLDAsMCxzKmEqcioyLDApfXNldE9ydGhvZ3JhcGhpY01hdHJpeCh0LGUscyxhLGkscil7Y29uc3Qgbj0xLyh0LWUpLGg9MS8ocy1hKSxvPTEvKGktcik7dGhpcy5zZXQoLTIqbiwwLDAsMCwwLC0yKmgsMCwwLDAsMCwyKm8sMCwodCtlKSpuLChhK3MpKmgsKHIraSkqbywxKX1zZXRTY2FsZSh0LGUscyl7dCBpbnN0YW5jZW9mIHI/dGhpcy5zZXQodC54LDAsMCwwLDAsdC55LDAsMCwwLDAsdC56LDAsMCwwLDAsMSk6dGhpcy5zZXQodCwwLDAsMCwwLGUsMCwwLDAsMCxzLDAsMCwwLDAsMSl9c2V0RnJvbU1hdDN4NEFycmF5KHQpe3RoaXMuc2V0KHRbMF0sdFsxXSx0WzJdLDAsdFszXSx0WzRdLHRbNV0sMCx0WzZdLHRbN10sdFs4XSwwLHRbOV0sdFsxMF0sdFsxMV0sMSl9c3RhdGljIGNyZWF0ZUZyb21GbG9hdDMyQnVmZmVyKHQsZT0wKXtyZXR1cm4gbmV3IGwodCw0KmUpfWNsb25lKCl7cmV0dXJuIG5ldyBsKHRoaXMuX19kYXRhWzBdLHRoaXMuX19kYXRhWzFdLHRoaXMuX19kYXRhWzJdLHRoaXMuX19kYXRhWzNdLHRoaXMuX19kYXRhWzRdLHRoaXMuX19kYXRhWzVdLHRoaXMuX19kYXRhWzZdLHRoaXMuX19kYXRhWzddLHRoaXMuX19kYXRhWzhdLHRoaXMuX19kYXRhWzldLHRoaXMuX19kYXRhWzEwXSx0aGlzLl9fZGF0YVsxMV0sdGhpcy5fX2RhdGFbMTJdLHRoaXMuX19kYXRhWzEzXSx0aGlzLl9fZGF0YVsxNF0sdGhpcy5fX2RhdGFbMTVdKX1zdGF0aWMgY3JlYXRlKC4uLnQpe3JldHVybiBuZXcgbCguLi50KX10b0pTT04oKXtyZXR1cm4gdGhpcy5fX2RhdGF9ZnJvbUpTT04odCl7dGhpcy5fX2RhdGE9bmV3IEZsb2F0MzJBcnJheSh0KX19YS5yZWdpc3RlclR5cGUoIk1hdDQiLGwpO2NsYXNzIHUgZXh0ZW5kcyBze2NvbnN0cnVjdG9yKHQ9MCxlPTAscz0wLGE9MSl7aWYoc3VwZXIoKSx0IGluc3RhbmNlb2YgQXJyYXlCdWZmZXIpe2NvbnN0IHM9dCxhPWU7dGhpcy5fX2RhdGE9bmV3IEZsb2F0MzJBcnJheShzLGEsNCl9ZWxzZSBpZih0aGlzLl9fZGF0YT1uZXcgRmxvYXQzMkFycmF5KDQpLCJvYmplY3QiPT10eXBlb2YgdCl7dGhpcy5fX2RhdGFbMF09MCx0aGlzLl9fZGF0YVsxXT0wLHRoaXMuX19kYXRhWzJdPTAsdGhpcy5fX2RhdGFbM109MTtmb3IoY29uc3QgZSBpbiB0KUFycmF5LmlzQXJyYXkodFtlXSk/dGhpc1tlXS5jYWxsKHRoaXMsLi4udFtlXSk6dGhpc1tlXS5jYWxsKHRoaXMsdFtlXSl9ZWxzZSB0aGlzLl9fZGF0YVswXT10LHRoaXMuX19kYXRhWzFdPWUsdGhpcy5fX2RhdGFbMl09cyx0aGlzLl9fZGF0YVszXT1hfWdldCB4KCl7cmV0dXJuIHRoaXMuX19kYXRhWzBdfXNldCB4KHQpe3RoaXMuX19kYXRhWzBdPXR9Z2V0IHkoKXtyZXR1cm4gdGhpcy5fX2RhdGFbMV19c2V0IHkodCl7dGhpcy5fX2RhdGFbMV09dH1nZXQgeigpe3JldHVybiB0aGlzLl9fZGF0YVsyXX1zZXQgeih0KXt0aGlzLl9fZGF0YVsyXT10fWdldCB3KCl7cmV0dXJuIHRoaXMuX19kYXRhWzNdfXNldCB3KHQpe3RoaXMuX19kYXRhWzNdPXR9c2V0KHQsZSxzLGEpe3RoaXMuX19kYXRhWzBdPXQsdGhpcy5fX2RhdGFbMV09ZSx0aGlzLl9fZGF0YVsyXT1zLHRoaXMuX19kYXRhWzNdPWF9c2V0RGF0YUFycmF5KHQpe3RoaXMuX19kYXRhPXR9c2V0RnJvbU90aGVyKHQpe3RoaXMuX19kYXRhWzBdPXQueCx0aGlzLl9fZGF0YVsxXT10LnksdGhpcy5fX2RhdGFbMl09dC56LHRoaXMuX19kYXRhWzNdPXQud31zZXRGcm9tRXVsZXJBbmdsZXModCl7Y29uc3QgZT1uZXcgcjtzd2l0Y2godC5vcmRlcil7Y2FzZSAwOmUuc2V0KHQueCwtdC55LHQueik7YnJlYWs7Y2FzZSAxOmUuc2V0KHQueSwtdC56LHQueCk7YnJlYWs7Y2FzZSAyOmUuc2V0KHQueiwtdC54LHQueSk7YnJlYWs7Y2FzZSAzOmUuc2V0KHQueCx0LnosdC55KTticmVhaztjYXNlIDQ6ZS5zZXQodC56LHQueSx0LngpO2JyZWFrO2Nhc2UgNTplLnNldCh0LnksdC54LHQueik7YnJlYWs7ZGVmYXVsdDp0aHJvdyBuZXcgRXJyb3IoInNkcnR5Iil9Y29uc3Qgcz0uNSplLngsYT0uNSplLnksaT0uNSplLnosbj1NYXRoLmNvcyhzKSxoPU1hdGguY29zKGEpLG89TWF0aC5jb3MoaSksXz1NYXRoLnNpbihzKSxkPU1hdGguc2luKGEpLGw9TWF0aC5zaW4oaSksYz1uKm8sdT1uKmwsZj1fKm8sbT1fKmwsZz1oKmYtZCp1LHk9aCptK2QqYyxwPWgqdS1kKmY7c3dpdGNoKHRoaXMudz1oKmMrZCptLHQub3JkZXIpe2Nhc2UgMDp0aGlzLng9Zyx0aGlzLnk9LXksdGhpcy56PXA7YnJlYWs7Y2FzZSAxOnRoaXMueD1wLHRoaXMueT1nLHRoaXMuej0teTticmVhaztjYXNlIDI6dGhpcy54PS15LHRoaXMueT1wLHRoaXMuej1nO2JyZWFrO2Nhc2UgMzp0aGlzLng9Zyx0aGlzLnk9cCx0aGlzLno9eTticmVhaztjYXNlIDQ6dGhpcy54PXAsdGhpcy55PXksdGhpcy56PWc7YnJlYWs7Y2FzZSA1OnRoaXMueD15LHRoaXMueT1nLHRoaXMuej1wO2JyZWFrO2RlZmF1bHQ6dGhyb3cgbmV3IEVycm9yKCJzZHJ0eSIpfX10b0V1bGVyQW5nbGVzKHQpe2NvbnN0IGU9bmV3IHI7c3dpdGNoKHQpe2Nhc2UgMDplLnNldCh0aGlzLnosdGhpcy54LHRoaXMueSk7YnJlYWs7Y2FzZSAxOmUuc2V0KHRoaXMueCx0aGlzLnksdGhpcy56KTticmVhaztjYXNlIDI6ZS5zZXQodGhpcy55LHRoaXMueix0aGlzLngpO2JyZWFrO2Nhc2UgMzplLnNldCh0aGlzLnksLXRoaXMueCx0aGlzLnopO2JyZWFrO2Nhc2UgNDplLnNldCh0aGlzLngsLXRoaXMueix0aGlzLnkpO2JyZWFrO2Nhc2UgNTplLnNldCh0aGlzLnosLXRoaXMueSx0aGlzLngpO2JyZWFrO2RlZmF1bHQ6dGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIHJvdGF0aW9uIG9yZGVyOiIrdCl9Y29uc3Qgcz1uZXcgcixhPWUueCplLnkrZS56KnRoaXMudztpZihhPi40OTk5OSlzLnk9MipNYXRoLmF0YW4yKGUueCx0aGlzLncpLHMuej0uNSpNYXRoLlBJLHMueD0wO2Vsc2UgaWYoYTwtLjQ5OTk5KXMueT0tMipNYXRoLmF0YW4yKGUueCx0aGlzLncpLHMuej0tLjUqTWF0aC5QSSxzLng9MDtlbHNle2NvbnN0IHQ9ZS54KmUueCxpPWUueSplLnkscj1lLnoqZS56O3MueT1NYXRoLmF0YW4yKDIqZS55KnRoaXMudy0yKmUueCplLnosMS0yKmktMipyKSxzLno9TWF0aC5hc2luKDIqYSkscy54PU1hdGguYXRhbjIoMiplLngqdGhpcy53LTIqZS55KmUueiwxLTIqdC0yKnIpfXN3aXRjaCh0KXtjYXNlIDA6cmV0dXJuIG5ldyBfKHMueSxzLnoscy54LHQpO2Nhc2UgMTpyZXR1cm4gbmV3IF8ocy54LHMueSxzLnosdCk7Y2FzZSAyOnJldHVybiBuZXcgXyhzLnoscy54LHMueSx0KTtjYXNlIDM6cmV0dXJuIG5ldyBfKC1zLnkscy54LHMueix0KTtjYXNlIDQ6cmV0dXJuIG5ldyBfKHMueCxzLnosLXMueSx0KTtjYXNlIDU6cmV0dXJuIG5ldyBfKHMueiwtcy55LHMueCx0KX19c2V0RnJvbUF4aXNBbmRBbmdsZSh0LGUpe2NvbnN0IHM9ZS8yLGE9dC5ub3JtYWxpemUoKS5zY2FsZShNYXRoLnNpbihzKSk7dGhpcy5zZXQoYS54LGEueSxhLnosTWF0aC5jb3MocykpfXNldEZyb21EaXJlY3Rpb25BbmRVcHZlY3Rvcih0LGUpe2NvbnN0IHM9bmV3IGQ7cy5zZXRGcm9tRGlyZWN0aW9uQW5kVXB2ZWN0b3IodCxlKSx0aGlzLnNldEZyb21NYXQzKHMpfXNldEZyb20yVmVjdG9ycyh0LGUpe3Qubm9ybWFsaXplKCksZS5ub3JtYWxpemUoKTtjb25zdCBzPXQuY3Jvc3MoZSksYT10LmRvdChlKSxpPU1hdGguc3FydCgyKigxK2EpKTt0aGlzLnNldChzLngvaSxzLnkvaSxzLnovaSxpLzIpLHRoaXMubm9ybWFsaXplSW5QbGFjZSgpfXNldEZyb21NYXQzKHQpe2NvbnN0IGU9dC5fX2RhdGFbMF0rdC5fX2RhdGFbNF0rdC5fX2RhdGFbOF07bGV0IHM7aWYoZT4wKXM9TWF0aC5zcXJ0KGUrMSksdGhpcy5fX2RhdGFbM109LjUqcyxzPS41L3MsdGhpcy5fX2RhdGFbMF09KHQuX19kYXRhWzVdLXQuX19kYXRhWzddKSpzLHRoaXMuX19kYXRhWzFdPSh0Ll9fZGF0YVs2XS10Ll9fZGF0YVsyXSkqcyx0aGlzLl9fZGF0YVsyXT0odC5fX2RhdGFbMV0tdC5fX2RhdGFbM10pKnM7ZWxzZXtsZXQgZT0wO3QuX19kYXRhWzRdPnQuX19kYXRhWzBdJiYoZT0xKSx0Ll9fZGF0YVs4XT50Ll9fZGF0YVszKmUrZV0mJihlPTIpO2NvbnN0IGE9KGUrMSklMyxpPShlKzIpJTM7cz1NYXRoLnNxcnQodC5fX2RhdGFbMyplK2VdLXQuX19kYXRhWzMqYSthXS10Ll9fZGF0YVszKmkraV0rMSksdGhpcy5fX2RhdGFbZV09LjUqcyxzPS41L3MsdGhpcy5fX2RhdGFbM109KHQuX19kYXRhWzMqYStpXS10Ll9fZGF0YVszKmkrYV0pKnMsdGhpcy5fX2RhdGFbYV09KHQuX19kYXRhWzMqYStlXSt0Ll9fZGF0YVszKmUrYV0pKnMsdGhpcy5fX2RhdGFbaV09KHQuX19kYXRhWzMqaStlXSt0Ll9fZGF0YVszKmUraV0pKnN9dGhpcy5ub3JtYWxpemVJblBsYWNlKCl9c2V0RnJvbU1hdDQodCl7Y29uc3QgZT10Ll9fZGF0YVswXSt0Ll9fZGF0YVs1XSt0Ll9fZGF0YVsxMF07bGV0IHM7aWYoZT4wKXM9TWF0aC5zcXJ0KGUrMSksdGhpcy5fX2RhdGFbM109LjUqcyxzPS41L3MsdGhpcy5fX2RhdGFbMF09KHQuX19kYXRhWzZdLXQuX19kYXRhWzldKSpzLHRoaXMuX19kYXRhWzFdPSh0Ll9fZGF0YVs4XS10Ll9fZGF0YVsyXSkqcyx0aGlzLl9fZGF0YVsyXT0odC5fX2RhdGFbMV0tdC5fX2RhdGFbNF0pKnM7ZWxzZXtsZXQgZT0wO3QuX19kYXRhWzVdPnQuX19kYXRhWzBdJiYoZT0xKSx0Ll9fZGF0YVsxMF0+dC5fX2RhdGFbNCplK2VdJiYoZT0yKTtjb25zdCBhPShlKzEpJTMsaT0oZSsyKSUzO3M9TWF0aC5zcXJ0KHQuX19kYXRhWzQqZStlXS10Ll9fZGF0YVs0KmErYV0tdC5fX2RhdGFbNCppK2ldKzEpLHRoaXMuX19kYXRhW2VdPS41KnMscz0uNS9zLHRoaXMuX19kYXRhWzNdPSh0Ll9fZGF0YVs0KmEraV0tdC5fX2RhdGFbNCppK2FdKSpzLHRoaXMuX19kYXRhW2FdPSh0Ll9fZGF0YVs0KmErZV0rdC5fX2RhdGFbNCplK2FdKSpzLHRoaXMuX19kYXRhW2ldPSh0Ll9fZGF0YVs0KmkrZV0rdC5fX2RhdGFbNCplK2ldKSpzfXRoaXMubm9ybWFsaXplSW5QbGFjZSgpfWlzSWRlbnRpdHkoKXtyZXR1cm4gdGhpcy5nZXRBbmdsZSgpPE51bWJlci5FUFNJTE9OfWdldEFuZ2xlKCl7cmV0dXJuIDIqTWF0aC5hY29zKHRoaXMudyl9ZXF1YWwodCl7cmV0dXJuIHRoaXMueD09dC54JiZ0aGlzLnk9PXQueSYmdGhpcy56PT10LnomJnRoaXMudz09dC53fW5vdGVxdWFscyh0KXtyZXR1cm4gdGhpcy54IT10LngmJnRoaXMueSE9dC55JiZ0aGlzLnohPXQueiYmdGhpcy53IT10Lnd9YXBwcm94RXF1YWwodCxlPU51bWJlci5FUFNJTE9OKXtyZXR1cm4gTWF0aC5hYnModGhpcy54LXQueCk8ZSYmTWF0aC5hYnModGhpcy55LXQueSk8ZSYmTWF0aC5hYnModGhpcy56LXQueik8ZSYmTWF0aC5hYnModGhpcy53LXQudyk8ZX1hZGQodCl7cmV0dXJuIG5ldyB1KHRoaXMueCt0LngsdGhpcy55K3QueSx0aGlzLnordC56LHRoaXMudyt0LncpfWFkZEluUGxhY2UodCl7dGhpcy54Kz10LngsdGhpcy55Kz10LnksdGhpcy56Kz10LnosdGhpcy53Kz10Lnd9c3VidHJhY3QodCl7cmV0dXJuIG5ldyB1KHRoaXMueC10LngsdGhpcy55LXQueSx0aGlzLnotdC56LHRoaXMudy10LncpfXNjYWxlKHQpe3JldHVybiBuZXcgdSh0aGlzLngqdCx0aGlzLnkqdCx0aGlzLnoqdCx0aGlzLncqdCl9c2NhbGVJblBsYWNlKHQpe3RoaXMueCo9dCx0aGlzLnkqPXQsdGhpcy56Kj10LHRoaXMudyo9dH1sZW5ndGgoKXtjb25zdCB0PXRoaXMuX19kYXRhWzBdLGU9dGhpcy5fX2RhdGFbMV0scz10aGlzLl9fZGF0YVsyXSxhPXRoaXMuX19kYXRhWzNdO3JldHVybiBNYXRoLnNxcnQodCp0K2UqZStzKnMrYSphKX1sZW5ndGhTcXVhcmVkKCl7Y29uc3QgdD10aGlzLl9fZGF0YVswXSxlPXRoaXMuX19kYXRhWzFdLHM9dGhpcy5fX2RhdGFbMl0sYT10aGlzLl9fZGF0YVszXTtyZXR1cm4gdCp0K2UqZStzKnMrYSphfW5vcm1hbGl6ZSgpe2NvbnN0IHQ9dGhpcy5fX2RhdGFbMF0sZT10aGlzLl9fZGF0YVsxXSxzPXRoaXMuX19kYXRhWzJdLGE9dGhpcy5fX2RhdGFbM107bGV0IGk9dCp0K2UqZStzKnMrYSphO3JldHVybiBpPE51bWJlci5FUFNJTE9OP25ldyB1OihpPTEvTWF0aC5zcXJ0KGkpLG5ldyB1KHQqaSxlKmkscyppKSl9bm9ybWFsaXplSW5QbGFjZSgpe2NvbnN0IHQ9dGhpcy5fX2RhdGFbMF0sZT10aGlzLl9fZGF0YVsxXSxzPXRoaXMuX19kYXRhWzJdLGE9dGhpcy5fX2RhdGFbM107bGV0IGk9dCp0K2UqZStzKnMrYSphO2k8TnVtYmVyLkVQU0lMT058fChpPTEvTWF0aC5zcXJ0KGkpLHRoaXMuc2V0KHQqaSxlKmkscyppLGEqaSkpfWRvdCh0KXtyZXR1cm4gdGhpcy54KnQueCt0aGlzLnkqdC55K3RoaXMueip0LnordGhpcy53KnQud31jcm9zcyh0KXtjb25zdCBlPXRoaXMueCxzPXRoaXMueSxhPXRoaXMueixpPXRoaXMudyxyPXQueCxuPXQueSxoPXQueixvPXQudztyZXR1cm4gbmV3IHUocypoLWEqbixhKm8taSpoLGkqci1lKm8sZSpuLXMqcil9Y29uanVnYXRlKCl7cmV0dXJuIG5ldyB1KC10aGlzLngsLXRoaXMueSwtdGhpcy56LHRoaXMudyl9aW52ZXJzZSgpe3JldHVybiB0aGlzLmNvbmp1Z2F0ZSgpfWFsaWduV2l0aCh0KXt0aGlzLmRvdCh0KTwwJiZ0aGlzLnNldCgtdGhpcy54LC10aGlzLnksLXRoaXMueiwtdGhpcy53KX1tdWx0aXBseSh0KXtjb25zdCBlPXRoaXMuX19kYXRhWzBdLHM9dGhpcy5fX2RhdGFbMV0sYT10aGlzLl9fZGF0YVsyXSxpPXRoaXMuX19kYXRhWzNdLHI9dC5fX2RhdGFbMF0sbj10Ll9fZGF0YVsxXSxoPXQuX19kYXRhWzJdLG89dC5fX2RhdGFbM107cmV0dXJuIG5ldyB1KGUqbytpKnIrcypoLWEqbixzKm8raSpuK2Eqci1lKmgsYSpvK2kqaCtlKm4tcypyLGkqby1lKnItcypuLWEqaCl9bXVsdGlwbHlJblBsYWNlKHQpe2NvbnN0IGU9dGhpcy5fX2RhdGFbMF0scz10aGlzLl9fZGF0YVsxXSxhPXRoaXMuX19kYXRhWzJdLGk9dGhpcy5fX2RhdGFbM10scj10Ll9fZGF0YVswXSxuPXQuX19kYXRhWzFdLGg9dC5fX2RhdGFbMl0sbz10Ll9fZGF0YVszXTt0aGlzLnNldChlKm8raSpyK3MqaC1hKm4scypvK2kqbithKnItZSpoLGEqbytpKmgrZSpuLXMqcixpKm8tZSpyLXMqbi1hKmgpfXJvdGF0ZVZlYzModCl7Y29uc3QgZT1uZXcgdSh0LngsdC55LHQueiwwKSxzPXRoaXMubXVsdGlwbHkoZSkubXVsdGlwbHkodGhpcy5jb25qdWdhdGUoKSk7cmV0dXJuIG5ldyByKHMueCxzLnkscy56KX1yb3RhdGVYKHQpe3QqPS41O2NvbnN0IGU9dGhpcy54LHM9dGhpcy55LGE9dGhpcy56LGk9dGhpcy53LHI9TWF0aC5zaW4odCksbj1NYXRoLmNvcyh0KTt0aGlzLng9ZSpuK2kqcix0aGlzLnk9cypuK2Eqcix0aGlzLno9YSpuLXMqcix0aGlzLnc9aSpuLWUqcn1yb3RhdGVZKHQpe3QqPS41O2NvbnN0IGU9dGhpcy54LHM9dGhpcy55LGE9dGhpcy56LGk9dGhpcy53LHI9TWF0aC5zaW4odCksbj1NYXRoLmNvcyh0KTt0aGlzLng9ZSpuLWEqcix0aGlzLnk9cypuK2kqcix0aGlzLno9YSpuK2Uqcix0aGlzLnc9aSpuLXMqcn1yb3RhdGVaKHQpe3QqPS41O2NvbnN0IGU9dGhpcy54LHM9dGhpcy55LGE9dGhpcy56LGk9dGhpcy53LHI9TWF0aC5zaW4odCksbj1NYXRoLmNvcyh0KTt0aGlzLng9ZSpuK3Mqcix0aGlzLnk9cypuLWUqcix0aGlzLno9YSpuK2kqcix0aGlzLnc9aSpuLWEqcn10b01hdDMoKXtjb25zdCB0PXRoaXMueCxlPXRoaXMueSxzPXRoaXMueixhPXRoaXMudyxpPXQrdCxyPWUrZSxuPXMrcyxoPXQqaSxvPWUqaSxfPWUqcixsPXMqaSxjPXMqcix1PXMqbixmPWEqaSxtPWEqcixnPWEqbix5PW5ldyBkO3JldHVybiB5Ll9fZGF0YVswXT0xLV8tdSx5Ll9fZGF0YVszXT1vLWcseS5fX2RhdGFbNl09bCttLHkuX19kYXRhWzFdPW8rZyx5Ll9fZGF0YVs0XT0xLWgtdSx5Ll9fZGF0YVs3XT1jLWYseS5fX2RhdGFbMl09bC1tLHkuX19kYXRhWzVdPWMrZix5Ll9fZGF0YVs4XT0xLWgtXyx5fWdldFhheGlzKCl7Y29uc3QgdD10aGlzLngqdGhpcy55LGU9dGhpcy54KnRoaXMueixzPXRoaXMueSp0aGlzLnksYT10aGlzLnkqdGhpcy53LGk9dGhpcy56KnRoaXMueixuPXRoaXMueip0aGlzLnc7cmV0dXJuIG5ldyByKDEtMiooaStzKSwyKih0K24pLDIqKGUtYSkpfWdldFlheGlzKCl7Y29uc3QgdD10aGlzLngqdGhpcy54LGU9dGhpcy54KnRoaXMueSxzPXRoaXMueCp0aGlzLncsYT10aGlzLnkqdGhpcy56LGk9dGhpcy56KnRoaXMueixuPXRoaXMueip0aGlzLnc7cmV0dXJuIG5ldyByKDIqKGUtbiksMS0yKihpK3QpLDIqKGErcykpfWdldFpheGlzKCl7Y29uc3QgdD10aGlzLngqdGhpcy54LGU9dGhpcy54KnRoaXMueixzPXRoaXMueCp0aGlzLncsYT10aGlzLnkqdGhpcy55LGk9dGhpcy55KnRoaXMueixuPXRoaXMueSp0aGlzLnc7bmV3IHI7cmV0dXJuIG5ldyByKDIqKG4rZSksMiooaS1zKSwxLTIqKGErdCkpfW1pcnJvcih0KXtzd2l0Y2godCl7Y2FzZSAwOnJldHVybiBuZXcgdSh0aGlzLnosdGhpcy53LHRoaXMueCx0aGlzLnkpO2Nhc2UgMTpyZXR1cm4gbmV3IHUoLXRoaXMudyx0aGlzLnosdGhpcy55LC10aGlzLngpO2Nhc2UgMjpyZXR1cm4gbmV3IHUodGhpcy54LHRoaXMueSx0aGlzLnosLXRoaXMudyl9fXRvTWF0NCgpe2NvbnN0IHQ9dGhpcy54LGU9dGhpcy55LHM9dGhpcy56LGE9dGhpcy53LGk9dCt0LHI9ZStlLG49cytzLGg9dCppLG89ZSppLF89ZSpyLGQ9cyppLGM9cypyLHU9cypuLGY9YSppLG09YSpyLGc9YSpuLHk9bmV3IGw7cmV0dXJuIHkuX19kYXRhWzBdPTEtXy11LHkuX19kYXRhWzRdPW8tZyx5Ll9fZGF0YVs4XT1kK20seS5fX2RhdGFbMV09bytnLHkuX19kYXRhWzVdPTEtaC11LHkuX19kYXRhWzldPWMtZix5Ll9fZGF0YVsyXT1kLW0seS5fX2RhdGFbNl09YytmLHkuX19kYXRhWzEwXT0xLWgtXyx5fWxlcnAodCxlKXtjb25zdCBzPW5ldyB1KHRoaXMueCtlKih0LngtdGhpcy54KSx0aGlzLnkrZSoodC55LXRoaXMueSksdGhpcy56K2UqKHQuei10aGlzLnopLHRoaXMudytlKih0LnctdGhpcy53KSk7cmV0dXJuIHMubm9ybWFsaXplSW5QbGFjZSgpLHN9c3RhdGljIGNyZWF0ZSguLi50KXtyZXR1cm4gbmV3IHUoLi4udCl9c3RhdGljIGNyZWF0ZUZyb21GbG9hdDMyQnVmZmVyKHQsZT0wKXtyZXR1cm4gbmV3IHUodCw0KmUpfXN0YXRpYyBudW1FbGVtZW50cygpe3JldHVybiA0fWNsb25lKCl7cmV0dXJuIG5ldyB1KHRoaXMuX19kYXRhWzBdLHRoaXMuX19kYXRhWzFdLHRoaXMuX19kYXRhWzJdLHRoaXMuX19kYXRhWzNdKX10b0pTT04oKXtyZXR1cm57eDp0aGlzLngseTp0aGlzLnksejp0aGlzLnosdzp0aGlzLnd9fWZyb21KU09OKHQpe3RoaXMuX19kYXRhWzBdPXQueCx0aGlzLl9fZGF0YVsxXT10LnksdGhpcy5fX2RhdGFbMl09dC56LHRoaXMuX19kYXRhWzNdPXQudyx0aGlzLm5vcm1hbGl6ZUluUGxhY2UoKX19YS5yZWdpc3RlclR5cGUoIlF1YXQiLHUpO2NsYXNzIGZ7Y29uc3RydWN0b3IodCxlKXt0aGlzLnN0YXJ0PXQgaW5zdGFuY2VvZiByP3Q6bmV3IHIsdGhpcy5kaXI9ZSBpbnN0YW5jZW9mIHI/ZTpuZXcgcn1jbG9zZXN0UG9pbnQodCl7Y29uc3QgZT10LnN1YnRyYWN0KHRoaXMuc3RhcnQpLmRvdCh0aGlzLmRpcik7aWYoZTxOdW1iZXIuRVBTSUxPTilyZXR1cm4gdGhpcy5zdGFydDtjb25zdCBzPWUvdGhpcy5kaXIuZG90KHRoaXMuZGlyKTtyZXR1cm4gdGhpcy5zdGFydC5hZGQodGhpcy5kaXIuc2NhbGUocykpfXBvaW50QXREaXN0KHQpe3JldHVybiB0aGlzLnN0YXJ0LmFkZCh0aGlzLmRpci5zY2FsZSh0KSl9aW50ZXJzZWN0UmF5VmVjdG9yKHQpe2NvbnN0IGU9dGhpcy5kaXIscz10LmRpcixhPXRoaXMuc3RhcnQuc3VidHJhY3QodC5zdGFydCksaT1lLmRvdChlKSxyPWUuZG90KHMpLG49cy5kb3QocyksaD1lLmRvdChhKSxvPXMuZG90KGEpO2lmKDA9PWkmJjA9PW4pcmV0dXJuIHRoaXMuc3RhcnQuZGlzdGFuY2VUbyh0LnN0YXJ0KTtpZigwPT1pKXJldHVybiB0LmNsb3Nlc3RQb2ludCh0aGlzLnN0YXJ0KTtpZigwPT1uKXJldHVybiB0aGlzLmNsb3Nlc3RQb2ludCh0LnN0YXJ0KTtjb25zdCBfPWkqbi1yKnI7bGV0IGQsbDtyZXR1cm4gXzwuMDAxPyhkPTAsbD1yPm4/aC9yOm8vbik6KGQ9KHIqby1uKmgpL18sbD0oaSpvLXIqaCkvXyksW2QsbF19aW50ZXJzZWN0UmF5UGxhbmUodCl7Y29uc3QgZT10aGlzLnN0YXJ0LnN1YnRyYWN0KHQuc3RhcnQpLHM9dC5kaXIuZG90KHRoaXMuZGlyKSxhPS10LmRpci5kb3QoZSk7aWYoTWF0aC5hYnMocyk8TnVtYmVyLlBSRUNJU0lPTilyZXR1cm4tMTtjb25zdCBpPWEvcztyZXR1cm4gaTwtTnVtYmVyLlBSRUNJU0lPTj8tMTppfWNsb25lKCl7cmV0dXJuIG5ldyBmKHRoaXMuc3RhcnQuY2xvbmUoKSx0aGlzLmRpci5jbG9uZSgpKX1zdGF0aWMgY3JlYXRlKC4uLnQpe3JldHVybiBuZXcgZiguLi50KX10b0pTT04oKXtyZXR1cm57c3RhcnQ6dGhpcy5zdGFydCxkaXI6dGhpcy5kaXJ9fWZyb21KU09OKHQpe3RoaXMuc3RhcnQuZnJvbUpTT04odC5zdGFydCksdGhpcy5kaXIuZnJvbUpTT04odC5kaXIpfXRvU3RyaW5nKCl7cmV0dXJuIGUodGhpcy50b0pTT04oKSl9fWEucmVnaXN0ZXJUeXBlKCJSYXkiLGYpO25ldyByKDEsMSwxKTtjbGFzcyBte2NvbnN0cnVjdG9yKHQsZSxzKXtpZih0IGluc3RhbmNlb2YgRmxvYXQzMkFycmF5KXRoaXMuc2V0RnJvbUZsb2F0MzJBcnJheSh0KTtlbHNle2lmKHQgaW5zdGFuY2VvZiByKXRoaXMudHI9dDtlbHNle2lmKHQgaW5zdGFuY2VvZiB1JiZudWxsPT1lJiZudWxsPT1zKXJldHVybiB0aGlzLnRyPW5ldyByLHRoaXMub3JpPXQsdm9pZCh0aGlzLnNjPW5ldyByKDEsMSwxKSk7dGhpcy50cj1uZXcgcn10aGlzLm9yaT1lIGluc3RhbmNlb2YgdT9lOm5ldyB1LHRoaXMuc2M9cyBpbnN0YW5jZW9mIHI/czpuZXcgcigxLDEsMSl9fXNldCh0LGUscyl7dGhpcy50cj10LHRoaXMub3JpPWUscyBpbnN0YW5jZW9mIHImJih0aGlzLnNjPXMpfXNldEZyb21PdGhlcih0KXt0aGlzLnRyPXQudHIsdGhpcy5vcmk9dC5vcmksdGhpcy5zYz10LnNjfWlzSWRlbnRpdHkoKXtyZXR1cm4gdGhpcy50ci5pc051bGwoKSYmdGhpcy5vcmkuaXNJZGVudGl0eSgpJiZ0aGlzLnNjLmlzMTExKCl9c2V0TG9va0F0KHQsZSxzKXtjb25zdCBhPXQuc3VidHJhY3QoZSk7aWYoYS5sZW5ndGgoKTxOdW1iZXIuRVBTSUxPTil0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgZGlyIik7dGhpcy5vcmkuc2V0RnJvbURpcmVjdGlvbkFuZFVwdmVjdG9yKGEscyksdGhpcy50cj10fW11bHRpcGx5KHQpe2xldCBlPXRoaXMuc2M7cmV0dXJuIHRoaXMuc2MueD09dGhpcy5zYy55JiZ0aGlzLnNjLng9PXRoaXMuc2Muenx8KGU9dC5vcmkucm90YXRlVmVjMyh0aGlzLnNjKSxNYXRoLnNpZ24oZS54KSE9TWF0aC5zaWduKHRoaXMuc2MueCkmJihlLng9LWUueCksTWF0aC5zaWduKGUueSkhPU1hdGguc2lnbih0aGlzLnNjLnkpJiYoZS55PS1lLnkpLE1hdGguc2lnbihlLnopIT1NYXRoLnNpZ24odGhpcy5zYy56KSYmKGUuej0tZS56KSksbmV3IG0odGhpcy50ci5hZGQodGhpcy5vcmkucm90YXRlVmVjMyhlLm11bHRpcGx5KHQudHIpKSksdGhpcy5vcmkubXVsdGlwbHkodC5vcmkpLGUubXVsdGlwbHkodC5zYykpfWludmVyc2UoKXtjb25zdCB0PW5ldyBtO3JldHVybiB0Lm9yaT10aGlzLm9yaS5pbnZlcnNlKCksdGhpcy5zYy54IT10aGlzLnNjLnl8fHRoaXMuc2MueCE9dGhpcy5zYy56Pyh0LnNjPXQub3JpLnJvdGF0ZVZlYzModGhpcy5zYyksTWF0aC5zaWduKHQuc2MueCkhPU1hdGguc2lnbih0aGlzLnNjLngpJiYodC5zYy54PS10LnNjLngpLE1hdGguc2lnbih0LnNjLnkpIT1NYXRoLnNpZ24odGhpcy5zYy55KSYmKHQuc2MueT0tdC5zYy55KSxNYXRoLnNpZ24odC5zYy56KSE9TWF0aC5zaWduKHRoaXMuc2MueikmJih0LnNjLno9LXQuc2MueikpOnQuc2M9dGhpcy5zYy5pbnZlcnNlKCksdC50cj10Lm9yaS5yb3RhdGVWZWMzKHRoaXMudHIubmVnYXRlKCkubXVsdGlwbHkodC5zYykpLHR9dHJhbnNmb3JtVmVjMyh0KXtyZXR1cm4gdGhpcy50ci5hZGQodGhpcy5vcmkucm90YXRlVmVjMyh0aGlzLnNjLm11bHRpcGx5KHQpKSl9dG9NYXQ0KCl7Y29uc3QgdD1uZXcgbCh0aGlzLnNjLngsMCwwLDAsMCx0aGlzLnNjLnksMCwwLDAsMCx0aGlzLnNjLnosMCwwLDAsMCwxKSxlPXRoaXMub3JpLnRvTWF0NCgpLHM9bmV3IGw7cmV0dXJuIHMudHJhbnNsYXRpb249dGhpcy50cixzLm11bHRpcGx5KGUpLm11bHRpcGx5KHQpfWZyb21NYXQ0KHQpe3RoaXMudHI9dC50cmFuc2xhdGlvbix0aGlzLm9yaS5zZXRGcm9tTWF0NCh0KX1zZXRGcm9tRmxvYXQzMkFycmF5KHQpe2lmKDc9PXQubGVuZ3RoKXJldHVybiB0aGlzLnRyPW5ldyByKHQuYnVmZmVyLHQuYnl0ZU9mZnNldCksdGhpcy5vcmk9bmV3IHUodC5idWZmZXIsdC5ieXRlT2Zmc2V0KzEyKSx2b2lkKHRoaXMuc2M9bmV3IHIoMSwxLDEpKTtpZig4IT10Lmxlbmd0aClyZXR1cm4gMTA9PXQubGVuZ3RoPyh0aGlzLnRyPW5ldyByKHQuYnVmZmVyLHQuYnl0ZU9mZnNldCksdGhpcy5vcmk9bmV3IHUodC5idWZmZXIsdC5ieXRlT2Zmc2V0KzEyKSx2b2lkKHRoaXMuc2M9bmV3IHIodC5idWZmZXIsdC5ieXRlT2Zmc2V0KzIxKSkpOnZvaWQgMDt7dGhpcy50cj1uZXcgcih0LmJ1ZmZlcix0LmJ5dGVPZmZzZXQpLHRoaXMub3JpPW5ldyB1KHQuYnVmZmVyLHQuYnl0ZU9mZnNldCsxMik7Y29uc3QgZT10WzddO3RoaXMuc2M9bmV3IHIoZSxlLGUpfX1jbG9uZSgpe3JldHVybiBuZXcgbSh0aGlzLnRyLmNsb25lKCksdGhpcy5vcmkuY2xvbmUoKSx0aGlzLnNjLmNsb25lKCkpfXN0YXRpYyBjcmVhdGUoLi4udCl7cmV0dXJuIG5ldyBtKC4uLnQpfXRvSlNPTigpe2NvbnN0IHQ9e3RyOnRoaXMudHIudG9KU09OKCksb3JpOnRoaXMub3JpLnRvSlNPTigpfTtyZXR1cm4gdGhpcy5zYy5pczExMSgpfHwodC5zYz10aGlzLnNjLnRvSlNPTigpKSx0fWZyb21KU09OKHQpe3RoaXMudHIuZnJvbUpTT04odC50ciksdGhpcy5vcmkuZnJvbUpTT04odC5vcmkpLHQuc2MmJnRoaXMuc2MuZnJvbUpTT04odC5zYyl9dG9TdHJpbmcoKXtyZXR1cm4gZSh0aGlzLnRvSlNPTigpKX19YS5yZWdpc3RlclR5cGUoIlhmbyIsbSk7Y2xhc3MgZ3tjb25zdHJ1Y3Rvcih0LGUpe3RoaXMucDA9dCBpbnN0YW5jZW9mIGk/dDpuZXcgaShOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFksTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZKSx0aGlzLnAxPWUgaW5zdGFuY2VvZiBpP2U6bmV3IGkoTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZLE51bWJlci5ORUdBVElWRV9JTkZJTklUWSl9c2V0KHQsZSl7dGhpcy5wMD10LHRoaXMucDE9ZX1yZXNldCgpe3RoaXMucDAueD1OdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFksdGhpcy5wMS54PU51bWJlci5ORUdBVElWRV9JTkZJTklUWSx0aGlzLnAwLnk9TnVtYmVyLlBPU0lUSVZFX0lORklOSVRZLHRoaXMucDEueT1OdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFl9aXNWYWxpZCgpe3JldHVybiB0aGlzLnAwLnghPU51bWJlci5QT1NJVElWRV9JTkZJTklUWSYmdGhpcy5wMS54IT1OdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFkmJnRoaXMucDAueSE9TnVtYmVyLlBPU0lUSVZFX0lORklOSVRZJiZ0aGlzLnAxLnkhPU51bWJlci5ORUdBVElWRV9JTkZJTklUWX1hZGRQb2ludCh0KXsodGhpcy5wMC54PT1OdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFl8fHQueDx0aGlzLnAwLngpJiYodGhpcy5wMC54PXQueCksKHRoaXMucDAueT09TnVtYmVyLlBPU0lUSVZFX0lORklOSVRZfHx0Lnk8dGhpcy5wMC55KSYmKHRoaXMucDAueT10LnkpLCh0aGlzLnAxLnk9PU51bWJlci5ORUdBVElWRV9JTkZJTklUWXx8dC54PnRoaXMucDEueCkmJih0aGlzLnAxLng9dC54KSwodGhpcy5wMS55PT1OdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFl8fHQueT50aGlzLnAxLnkpJiYodGhpcy5wMS55PXQueSl9c2l6ZSgpe3JldHVybiB0aGlzLnAxLnN1YnRyYWN0KHRoaXMucDApfWRpYWdvbmFsKCl7cmV0dXJuIHRoaXMucDEuc3VidHJhY3QodGhpcy5wMCl9Y2VudGVyKCl7Y29uc3QgdD10aGlzLnAxLnN1YnRyYWN0KHRoaXMucDApO3JldHVybiB0LnNjYWxlSW5QbGFjZSguNSksdC5hZGRJblBsYWNlKHRoaXMucDApLHR9c3RhdGljIGNyZWF0ZSguLi50KXtyZXR1cm4gbmV3IGcoLi4udCl9dG9KU09OKCl7cmV0dXJue3AwOnRoaXMucDAudG9KU09OKCkscDE6dGhpcy5wMS50b0pTT04oKX19dG9TdHJpbmcoKXtyZXR1cm4gZSh0aGlzLnRvSlNPTigpKX19YS5yZWdpc3RlclR5cGUoIkJveDIiLGcpO2NsYXNzIHkgZXh0ZW5kcyBze2NvbnN0cnVjdG9yKHQsZT0wKXtzdXBlcigpLHRoaXMucG9zPXQgaW5zdGFuY2VvZiByP3Q6bmV3IHIsdGhpcy5yYWRpdXM9ZX1jbG9uZSgpe3JldHVybiBuZXcgU3BoZXJlKHRoaXMucG9zLmNsb25lKCksdGhpcy5yYWRpdXMpfWludGVyc2VjdHNCb3godCl7cmV0dXJuIHQuaW50ZXJzZWN0c1NwaGVyZSh0aGlzKX1zdGF0aWMgY3JlYXRlKC4uLnQpe3JldHVybiBuZXcgU3BoZXJlKC4uLnQpfXRvSlNPTigpe3JldHVybntwb3M6dGhpcy5wb3MudG9KU09OKCkscmFkaXVzOnRoaXMucmFkaXVzfX10b1N0cmluZygpe3JldHVybiBlKHRoaXMudG9KU09OKCkpfX1hLnJlZ2lzdGVyVHlwZSgiU3BoZXJlVHlwZSIseSk7Y2xhc3MgcHtjb25zdHJ1Y3Rvcih0LGUpe3QgaW5zdGFuY2VvZiBGbG9hdDMyQXJyYXk/dGhpcy5zZXRGcm9tRmxvYXQzMkFycmF5KHQpOih0aGlzLnAwPXQgaW5zdGFuY2VvZiByP3Q6bmV3IHIoTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZLE51bWJlci5QT1NJVElWRV9JTkZJTklUWSxOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFkpLHRoaXMucDE9ZSBpbnN0YW5jZW9mIHI/ZTpuZXcgcihOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFksTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZLE51bWJlci5ORUdBVElWRV9JTkZJTklUWSkpfWdldCBtaW4oKXtyZXR1cm4gdGhpcy5wMH1nZXQgbWF4KCl7cmV0dXJuIHRoaXMucDF9c2V0KHQsZSl7dGhpcy5wMD10LHRoaXMucDE9ZX1yZXNldCgpe3RoaXMucDAueD1OdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFksdGhpcy5wMS54PU51bWJlci5ORUdBVElWRV9JTkZJTklUWSx0aGlzLnAwLnk9TnVtYmVyLlBPU0lUSVZFX0lORklOSVRZLHRoaXMucDEueT1OdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFksdGhpcy5wMC56PU51bWJlci5QT1NJVElWRV9JTkZJTklUWSx0aGlzLnAxLno9TnVtYmVyLk5FR0FUSVZFX0lORklOSVRZfWlzVmFsaWQoKXtyZXR1cm4gdGhpcy5wMC54IT1OdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFkmJnRoaXMucDEueCE9TnVtYmVyLk5FR0FUSVZFX0lORklOSVRZJiZ0aGlzLnAwLnkhPU51bWJlci5QT1NJVElWRV9JTkZJTklUWSYmdGhpcy5wMS55IT1OdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFkmJnRoaXMucDAueiE9TnVtYmVyLlBPU0lUSVZFX0lORklOSVRZJiZ0aGlzLnAxLnohPU51bWJlci5ORUdBVElWRV9JTkZJTklUWX1hZGRQb2ludCh0KXt0LnghPU51bWJlci5QT1NJVElWRV9JTkZJTklUWSYmdC54IT1OdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFkmJih0Lng8dGhpcy5wMC54JiYodGhpcy5wMC54PXQueCksdC54PnRoaXMucDEueCYmKHRoaXMucDEueD10LngpKSx0LnkhPU51bWJlci5QT1NJVElWRV9JTkZJTklUWSYmdC55IT1OdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFkmJih0Lnk8dGhpcy5wMC55JiYodGhpcy5wMC55PXQueSksdC55PnRoaXMucDEueSYmKHRoaXMucDEueT10LnkpKSx0LnohPU51bWJlci5QT1NJVElWRV9JTkZJTklUWSYmdC56IT1OdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFkmJih0Lno8dGhpcy5wMC56JiYodGhpcy5wMC56PXQueiksdC56PnRoaXMucDEueiYmKHRoaXMucDEuej10LnopKX1hZGRCb3gzKHQsZSl7ZT8odGhpcy5hZGRQb2ludChlLnRyYW5zZm9ybVZlYzModC5wMCkpLHRoaXMuYWRkUG9pbnQoZS50cmFuc2Zvcm1WZWMzKG5ldyByKHQucDAueCx0LnAwLnksdC5wMS56KSkpLHRoaXMuYWRkUG9pbnQoZS50cmFuc2Zvcm1WZWMzKG5ldyByKHQucDAueCx0LnAxLnksdC5wMC56KSkpLHRoaXMuYWRkUG9pbnQoZS50cmFuc2Zvcm1WZWMzKG5ldyByKHQucDEueCx0LnAwLnksdC5wMC56KSkpLHRoaXMuYWRkUG9pbnQoZS50cmFuc2Zvcm1WZWMzKG5ldyByKHQucDAueCx0LnAxLnksdC5wMS56KSkpLHRoaXMuYWRkUG9pbnQoZS50cmFuc2Zvcm1WZWMzKG5ldyByKHQucDEueCx0LnAwLnksdC5wMS56KSkpLHRoaXMuYWRkUG9pbnQoZS50cmFuc2Zvcm1WZWMzKG5ldyByKHQucDEueCx0LnAxLnksdC5wMC56KSkpLHRoaXMuYWRkUG9pbnQoZS50cmFuc2Zvcm1WZWMzKHQucDEpKSk6KHRoaXMuYWRkUG9pbnQodC5wMCksdGhpcy5hZGRQb2ludCh0LnAxKSl9c2l6ZSgpe3JldHVybiB0aGlzLnAxLnN1YnRyYWN0KHRoaXMucDApfWRpYWdvbmFsKCl7cmV0dXJuIHRoaXMucDEuc3VidHJhY3QodGhpcy5wMCl9Y2VudGVyKCl7Y29uc3QgdD10aGlzLnAxLnN1YnRyYWN0KHRoaXMucDApO3JldHVybiB0LnNjYWxlSW5QbGFjZSguNSksdC5hZGRJblBsYWNlKHRoaXMucDApLHR9dG9NYXQ0KCl7Y29uc3QgdD10aGlzLnAxLngtdGhpcy5wMC54LGU9dGhpcy5wMS55LXRoaXMucDAueSxzPXRoaXMucDEuei10aGlzLnAwLno7cmV0dXJuIG5ldyBsKHQsMCwwLDAsMCxlLDAsMCwwLDAscywwLHRoaXMucDAueCx0aGlzLnAwLnksdGhpcy5wMC56LDEpfWdldEJvdW5kaW5nU3BoZXJlKCl7cmV0dXJuIG5ldyB5KHRoaXMuY2VudGVyKCksLjUqdGhpcy5kaWFnb25hbCgpLmxlbmd0aCgpKX1pbnRlcnNlY3RzQm94KHQpe3JldHVybiEodC5tYXgueDx0aGlzLm1pbi54fHx0Lm1pbi54PnRoaXMubWF4Lnh8fHQubWF4Lnk8dGhpcy5taW4ueXx8dC5taW4ueT50aGlzLm1heC55fHx0Lm1heC56PHRoaXMubWluLnp8fHQubWluLno+dGhpcy5tYXgueil9aW50ZXJzZWN0c1NwaGVyZSh0KXtyZXR1cm4gY2xvc2VzdFBvaW50LmRpc3RhbmNlVG9TcXVhcmVkKHQuY2VudGVyKTw9dC5yYWRpdXMqdC5yYWRpdXN9aW50ZXJzZWN0c1BsYW5lKHQpe2xldCBlLHM7cmV0dXJuIHQubm9ybWFsLng+MD8oZT10Lm5vcm1hbC54KnRoaXMubWluLngscz10Lm5vcm1hbC54KnRoaXMubWF4LngpOihlPXQubm9ybWFsLngqdGhpcy5tYXgueCxzPXQubm9ybWFsLngqdGhpcy5taW4ueCksdC5ub3JtYWwueT4wPyhlKz10Lm5vcm1hbC55KnRoaXMubWluLnkscys9dC5ub3JtYWwueSp0aGlzLm1heC55KTooZSs9dC5ub3JtYWwueSp0aGlzLm1heC55LHMrPXQubm9ybWFsLnkqdGhpcy5taW4ueSksdC5ub3JtYWwuej4wPyhlKz10Lm5vcm1hbC56KnRoaXMubWluLnoscys9dC5ub3JtYWwueip0aGlzLm1heC56KTooZSs9dC5ub3JtYWwueip0aGlzLm1heC56LHMrPXQubm9ybWFsLnoqdGhpcy5taW4ueiksZTw9LXQuY29uc3RhbnQmJnM+PS10LmNvbnN0YW50fWNsb25lKCl7cmV0dXJuIG5ldyBwKHRoaXMucDAuY2xvbmUoKSx0aGlzLnAxLmNsb25lKCkpfXN0YXRpYyBjcmVhdGUoLi4udCl7cmV0dXJuIG5ldyBwKC4uLnQpfXN0YXRpYyBzaXplSW5CeXRlcygpe3JldHVybiAyNH10b0pTT04oKXtyZXR1cm57cDA6dGhpcy5wMC50b0pTT04oKSxwMTp0aGlzLnAxLnRvSlNPTigpfX1mcm9tSlNPTih0KXt0aGlzLnAwLmZyb21KU09OKHQucDApLHRoaXMucDEuZnJvbUpTT04odC5wMSl9bG9hZEJpbih0LGUpe3RoaXMucDAubG9hZEJpbih0LGUpLHRoaXMucDAubG9hZEJpbih0LGUrMTIpfXNldEZyb21GbG9hdDMyQXJyYXkodCl7dGhpcy5wMD1uZXcgcih0LmJ1ZmZlcix0LmJ5dGVPZmZzZXQpLHRoaXMucDE9bmV3IHIodC5idWZmZXIsdC5ieXRlT2Zmc2V0KzEyKX10b1N0cmluZygpe3JldHVybiBlKHRoaXMudG9KU09OKCkpfX1hLnJlZ2lzdGVyVHlwZSgiQm94MyIscCk7Y2xhc3MgeCBleHRlbmRzIHN7Y29uc3RydWN0b3IodCxlPTApe3N1cGVyKCksdGhpcy5ub3JtYWw9dCBpbnN0YW5jZW9mIHI/dDpuZXcgcix0aGlzLnc9ZX1zZXQodCxlLHMsYSl7dGhpcy5ub3JtYWwuc2V0KHQsZSxzKSx0aGlzLnc9YX1kaXZpZGVTY2FsYXIodCl7dGhpcy5ub3JtYWwuc2NhbGVJblBsYWNlKDEvdCksdGhpcy53Lz10fWRpc3RhbmNlVG9Qb2ludCh0KXtyZXR1cm4gdC5kb3QodGhpcy5ub3JtYWwpK3RoaXMud31ub3JtYWxpemVJblBsYWNlKCl7Y29uc3QgdD0xL3RoaXMubm9ybWFsLmxlbmd0aCgpO3RoaXMubm9ybWFsLnNjYWxlSW5QbGFjZSh0KSx0aGlzLncqPXR9Y2xvbmUoKXtyZXR1cm4gbmV3IFBsYW5lKHRoaXMubm9ybWFsLmNsb25lKCksdGhpcy53KX1zdGF0aWMgY3JlYXRlKC4uLnQpe3JldHVybiBuZXcgUGxhbmUoLi4udCl9dG9KU09OKCl7cmV0dXJue25vcm1hbDp0aGlzLm5vcm1hbC50b0pTT04oKSx3OnRoaXMud319dG9TdHJpbmcoKXtyZXR1cm4gZSh0aGlzLnRvSlNPTigpKX19YS5yZWdpc3RlclR5cGUoIlBsYW5lVHlwZSIseCk7YS5yZWdpc3RlclR5cGUoIkZydXN0dW0iLGNsYXNze2NvbnN0cnVjdG9yKHQsZSxzLGEsaSxyKXt0aGlzLnBsYW5lcz1bdHx8bmV3IHgsZXx8bmV3IHgsc3x8bmV3IHgsYXx8bmV3IHgsaXx8bmV3IHgscnx8bmV3IHhdfXNldEZyb21NYXRyaXgodCl7Y29uc3QgZT10LHM9dGhpcy5wbGFuZXM7c1swXS5zZXQoZS5tMDMtZS5tMDAsZS5tMTMtZS5tMTAsZS5tMjMtZS5tMjAsZS5tMzMtZS5tMzApLHNbMV0uc2V0KGUubTAzK2UubTAwLGUubTEzK2UubTEwLGUubTIzK2UubTIwLGUubTMzK2UubTMwKSxzWzJdLnNldChlLm0wMytlLm0wMSxlLm0xMytlLm0xMSxlLm0yMytlLm0yMSxlLm0zMytlLm0zMSksc1szXS5zZXQoZS5tMDMtZS5tMDEsZS5tMTMtZS5tMTEsZS5tMjMtZS5tMjEsZS5tMzMtZS5tMzEpLHNbNF0uc2V0KGUubTAzLWUubTAyLGUubTEzLWUubTEyLGUubTIzLWUubTIyLGUubTMzLWUubTMyKSxzWzVdLnNldChlLm0wMytlLm0wMixlLm0xMytlLm0xMixlLm0yMytlLm0yMixlLm0zMytlLm0zMikscy5mb3JFYWNoKHQ9PnQubm9ybWFsaXplSW5QbGFjZSgpKX1pbnRlcnNlY3RzQm94KHQpe2NvbnN0IGU9bmV3IHIscz10aGlzLnBsYW5lcyx7bWluOmEsbWF4Oml9PXQ7Zm9yKGxldCB0PTA7dDw2O3QrKyl7Y29uc3Qgcj1zW3RdO2lmKGUueD1yLm5vcm1hbC54PjA/aS54OmEueCxlLnk9ci5ub3JtYWwueT4wP2kueTphLnksZS56PXIubm9ybWFsLno+MD9pLno6YS56LHIuZGlzdGFuY2VUb1BvaW50KGUpPDApcmV0dXJuITF9cmV0dXJuITB9dG9KU09OKCl7cmV0dXJue3AwOnRoaXMucDAudG9KU09OKCkscDE6dGhpcy5wMS50b0pTT04oKSxwMjp0aGlzLnAyLnRvSlNPTigpLHAzOnRoaXMucDMudG9KU09OKCkscDQ6dGhpcy5wNC50b0pTT04oKSxwNTp0aGlzLnA1LnRvSlNPTigpfX1mcm9tSlNPTih0KXt0aGlzLnAwLmZyb21KU09OKHQucDApLHRoaXMucDEuZnJvbUpTT04odC5wMSksdGhpcy5wMi5mcm9tSlNPTih0LnAyKSx0aGlzLnAzLmZyb21KU09OKHQucDMpLHRoaXMucDQuZnJvbUpTT04odC5wNCksdGhpcy5wNS5mcm9tSlNPTih0LnA1KX10b1N0cmluZygpe3JldHVybiBlKHRoaXMudG9KU09OKCkpfX0pO2NsYXNzIHd7Y29uc3RydWN0b3IodD0hMSl7dGhpcy5fX3Nsb3RzPVtdLHRoaXMuX190b2dnbGVkU2lnbmFsPXQsdGhpcy5fX3RvZ2dsZWQ9ITEsdGhpcy5fX2RhdGE9bnVsbCx0aGlzLmNvbm5lY3Q9dGhpcy5jb25uZWN0LmJpbmQodGhpcyksdGhpcy5kaXNjb25uZWN0PXRoaXMuZGlzY29ubmVjdC5iaW5kKHRoaXMpLHRoaXMuZW1pdD10aGlzLmVtaXQuYmluZCh0aGlzKX1jb25uZWN0KHQpe2lmKG51bGw9PXQpdGhyb3cgbmV3IEVycm9yKCJhIGZ1bmN0aW9uIGNhbGxiYWNrIG11c3QgYmUgcGFzc2VkIHRvIFNpZ25hbC5jb25uZWN0Iik7aWYoLTEhPXRoaXMuX19zbG90cy5pbmRleE9mKHQpKXJldHVybiB2b2lkIGNvbnNvbGUud2FybigiZm4gJyIrdC5uYW1lKyInIGFscmVhZHkgY29ubmVjdGVkIHRvIFNpZ25hbC4iKTtjb25zdCBlPXRoaXMuX19zbG90cy5sZW5ndGg7cmV0dXJuIHRoaXMuX19zbG90c1tlXT10LHRoaXMuX190b2dnbGVkU2lnbmFsJiZ0aGlzLl9fdG9nZ2xlZCYmKHRoaXMuX19kYXRhP3QoLi4udGhpcy5fX2RhdGEpOnQoKSksZX1kaXNjb25uZWN0KHQpe2lmKG51bGw9PXQpdGhyb3cgbmV3IEVycm9yKCJhIGZ1bmN0aW9uIGNhbGxiYWNrIG11c3QgYmUgcGFzc2VkIHRvIFNpZ25hbC5kaXNjb25uZWN0Iik7Y29uc3QgZT1bXTtpZih0aGlzLl9fc2xvdHMuZm9yRWFjaCgoZnVuY3Rpb24ocyxhKXtzPT09dCYmZS5wdXNoKGEpfSkpLDAhPWUubGVuZ3RoKWZvcihjb25zdCB0IG9mIGUpdGhpcy5fX3Nsb3RzW3RdPXZvaWQgMDtlbHNlIGNvbnNvbGUud2FybigiY2FsbGJhY2sgOiIrdC5uYW1lKyIgd2FzIG5vdCBjb25uZWN0ZWQgdG8gdGhpcyBzaWduYWw6Iit0aGlzLl9fbmFtZSl9ZGlzY29ubmVjdElkKHQpe2lmKCF0aGlzLl9fc2xvdHNbdF0pdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIElEIik7dGhpcy5fX3Nsb3RzW3RdPXZvaWQgMH1lbWl0KC4uLnQpe3RoaXMuX190b2dnbGVkU2lnbmFsJiYodGhpcy5fX3RvZ2dsZWQ/Y29uc29sZS53YXJuKCJUb2dnbGVkIHNpZ25hbHMgc2hvdWxkIG9ubHkgYmUgZmlyZWQgb25jZSwgb3IgdW50b2dnbGVkIGJlZm9yZSByZS1maXJpbmcuLiIpOih0aGlzLl9fdG9nZ2xlZD0hMCx0aGlzLl9fZGF0YT10KSk7Y29uc3QgZT10aGlzLl9fc2xvdHMubGVuZ3RoO2ZvcihsZXQgcz0wO3M8ZTtzKyspe2NvbnN0IGU9dGhpcy5fX3Nsb3RzW3NdO2UmJmUoLi4udCl9fWlzVG9nZ2xlZCgpe3JldHVybiB0aGlzLl9fdG9nZ2xlZH1zZXRUb2dnbGVkKHQpe3RoaXMuX190b2dnbGVkPXQsdGhpcy5fX2RhdGE9dm9pZCAwfWdldE51bUNvbm5lY3Rpb25zKCl7cmV0dXJuIHRoaXMuX19zbG90cy5sZW5ndGh9dW50b2dnbGUoKXt0aGlzLl9fdG9nZ2xlZD0hMSx0aGlzLl9fZGF0YT12b2lkIDB9fWNvbnN0IEk9bmV3IGNsYXNze2NvbnN0cnVjdG9yKCl7dGhpcy5fX3JlZ2lzdGVyZWRDbGFzc2VzPXt9LHRoaXMuX19jbGFzc05hbWVzPXt9fXJlZ2lzdGVyQ2xhc3ModCxlKXt0aGlzLl9fcmVnaXN0ZXJlZENsYXNzZXNbdF09e2NsczplLGNhbGxiYWNrczpbXX0sdGhpcy5fX2NsYXNzTmFtZXNbZS5uYW1lXT10fXJlZ2lzdGVyQ2FsbGJhY2sodCxlKXtjb25zdCBzPXRoaXMuX19yZWdpc3RlcmVkQ2xhc3Nlc1t0XTtzP3MuY2FsbGJhY2tzLnB1c2goZSk6Y29uc29sZS53YXJuKCJGYWN0b3J5IG5vdCByZWdpc3RlcmVkOiIrdCl9Z2V0Q2xhc3ModCl7aWYodGhpcy5fX3JlZ2lzdGVyZWRDbGFzc2VzW3RdKXJldHVybiB0aGlzLl9fcmVnaXN0ZXJlZENsYXNzZXNbdF0uY2xzfWdldENsYXNzTmFtZSh0KXtyZXR1cm4gdGhpcy5fX2NsYXNzTmFtZXNbdC5jb25zdHJ1Y3Rvci5uYW1lXT90aGlzLl9fY2xhc3NOYW1lc1t0LmNvbnN0cnVjdG9yLm5hbWVdOnQuY29uc3RydWN0b3IubmFtZX1pc0NvbnN0cnVjdGluZygpe3JldHVybiB0aGlzLl9fY29uc3RydWN0aW5nfWNvbnN0cnVjdENsYXNzKHQpe2NvbnN0IGU9dGhpcy5fX3JlZ2lzdGVyZWRDbGFzc2VzW3RdO2lmKCFlKXJldHVybiBjb25zb2xlLndhcm4oIkZhY3Rvcnkgbm90IHJlZ2lzdGVyZWQ6Iit0KSxudWxsO3RoaXMuX19jb25zdHJ1Y3Rpbmc9ITA7Y29uc3Qgcz1BcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsMSksYT1uZXcgZS5jbHMoLi4ucyk7cmV0dXJuIHRoaXMuX19jb25zdHJ1Y3Rpbmc9ITEsdGhpcy5pbnZva2VDYWxsYmFja3MoYSksYX1pbnZva2VDYWxsYmFja3ModCl7aWYodGhpcy5fX2NsYXNzTmFtZXNbdC5jb25zdHJ1Y3Rvci5uYW1lXSl7Y29uc3QgZT10aGlzLl9fcmVnaXN0ZXJlZENsYXNzZXNbdGhpcy5fX2NsYXNzTmFtZXNbdC5jb25zdHJ1Y3Rvci5uYW1lXV07Zm9yKGNvbnN0IHMgb2YgZS5jYWxsYmFja3Mpcyh0KX19fSxOPTMsRj0yO2xldCB6PTA7Y2xhc3MgVntjb25zdHJ1Y3Rvcih0LGUscyl7aWYodGhpcy5fX2RhdGFUeXBlPXQsdGhpcy5ub3JtYWxpemVkPSExLG51bGwhPXQubnVtRWxlbWVudHMpdGhpcy5fX2RpbWVuc2lvbj10aGlzLl9fZGF0YVR5cGUubnVtRWxlbWVudHMoKTtlbHNlIHN3aXRjaCh0KXtjYXNlIDY6Y2FzZSA0OmNhc2UgNTp0aGlzLl9fZGltZW5zaW9uPTE7YnJlYWs7ZGVmYXVsdDp0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgZGF0YSB0eXBlIGZvciBhdHRyaWJ1dGU6Iit0KX12YXIgYTt0aGlzLl9fZGVmYXVsdEVsZW1lbnRWYWx1ZT1udWxsIT1zP3M6TnVtYmVyLk1BWF9WQUxVRSwoYT1lKSYmdm9pZCAwIT09YS5ieXRlTGVuZ3RoP3RoaXMuX19kYXRhPWU6KHRoaXMuX19kYXRhPW5ldyBGbG9hdDMyQXJyYXkoZSp0aGlzLl9fZGltZW5zaW9uKSx0aGlzLmluaXRSYW5nZSgwKSl9cmVzaXplKHQpe2NvbnN0IGU9dGhpcy5fX2RhdGEubGVuZ3RoLHM9dCp0aGlzLl9fZGltZW5zaW9uLGE9bmV3IEZsb2F0MzJBcnJheShzKTtmb3IobGV0IHQ9MDt0PE1hdGgubWluKHRoaXMuX19kYXRhLmxlbmd0aCxzKTt0KyspYVt0XT10aGlzLl9fZGF0YVt0XTt0aGlzLl9fZGF0YS5sZW5ndGg8cyYmKHRoaXMuX19kYXRhPWEpLHRoaXMuaW5pdFJhbmdlKGUpfWluaXRSYW5nZSh0KXtmb3IobGV0IGU9dDtlPHRoaXMuX19kYXRhLmxlbmd0aDtlKyspdGhpcy5fX2RhdGFbZV09dGhpcy5fX2RlZmF1bHRFbGVtZW50VmFsdWV9Z2V0Q291bnQoKXtyZXR1cm4gdGhpcy5fX2RhdGEubGVuZ3RoL3RoaXMuX19kaW1lbnNpb259Z2V0IGxlbmd0aCgpe3JldHVybiB0aGlzLl9fZGF0YS5sZW5ndGgvdGhpcy5fX2RpbWVuc2lvbn1nZXQgZGF0YVR5cGUoKXtyZXR1cm4gdGhpcy5fX2RhdGFUeXBlfWdldCBkYXRhKCl7cmV0dXJuIHRoaXMuX19kYXRhfXNldCBkYXRhKHQpe3RoaXMuX19kYXRhPXR9Z2V0IG51bUVsZW1lbnRzKCl7cmV0dXJuIHRoaXMuX19kaW1lbnNpb259Z2V0RmxvYXQzMlZhbHVlKHQpe3JldHVybiB0aGlzLl9fZGF0YVt0XX1zZXRGbG9hdDMyVmFsdWUodCxlKXt0aGlzLl9fZGF0YVt0XT1lfWdldFZhbHVlUmVmKHQpe2NvbnN0IGU9dGhpcy5fX2RpbWVuc2lvbjtpZih0Pj10aGlzLl9fZGF0YS5sZW5ndGgvZSl0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgdmVydGV4IGluZGV4OiIrdCsiLiBOdW0gVmVydGljZXM6Iit0aGlzLl9fZGF0YS5sZW5ndGgvMyk7cmV0dXJuIHRoaXMuX19kYXRhVHlwZS5jcmVhdGVGcm9tRmxvYXQzMkJ1ZmZlcih0aGlzLl9fZGF0YS5idWZmZXIsdCplKX1zZXRWYWx1ZSh0LGUpe2NvbnN0IHM9dGhpcy5fX2RpbWVuc2lvbjtpZih0Pj10aGlzLl9fZGF0YS5sZW5ndGgvcyl0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgdmVydGV4IGluZGV4OiIrdCsiLiBOdW0gVmVydGljZXM6Iit0aGlzLl9fZGF0YS5sZW5ndGgvMyk7dGhpcy5fX2RhdGFUeXBlLmNyZWF0ZUZyb21GbG9hdDMyQnVmZmVyKHRoaXMuX19kYXRhLmJ1ZmZlcix0KnMpLnNldEZyb21PdGhlcihlKX10b0pTT04odCxlKXtyZXR1cm57ZGF0YTpBcnJheS5mcm9tKHRoaXMuX19kYXRhKSxkYXRhVHlwZTphLmdldFR5cGVOYW1lKHRoaXMuX19kYXRhVHlwZSksZGVmYXVsdFZhbHVlOnRoaXMuX19kZWZhdWx0RWxlbWVudFZhbHVlLGxlbmd0aDp0aGlzLl9fZGF0YS5sZW5ndGgvdGhpcy5fX2RpbWVuc2lvbn19ZnJvbUpTT04odCl7dGhpcy5fX2RhdGE9RmxvYXQzMkFycmF5LmZyb20odC5kYXRhKX10b1N0cmluZygpe3JldHVybiBKU09OLnN0cmluZ2lmeSh0aGlzLnRvSlNPTigpLG51bGwsMil9fWNsYXNzIE0gZXh0ZW5kcyBjbGFzc3tjb25zdHJ1Y3Rvcigpe3RoaXMuX19pZD0rK3osdGhpcy5fX3BhcmFtcz1bXSx0aGlzLl9fcGFyYW1NYXBwaW5nPXt9LHRoaXMuX19wYXJhbVNpZ25hbElkcz17fSx0aGlzLnBhcmFtZXRlckFkZGVkPW5ldyB3LHRoaXMucGFyYW1ldGVyUmVtb3ZlZD1uZXcgdyx0aGlzLnBhcmFtZXRlclZhbHVlQ2hhbmdlZD1uZXcgd31nZXRJZCgpe3JldHVybiB0aGlzLl9faWR9bnVtUGFyYW1ldGVycygpe3JldHVybiB0aGlzLl9fcGFyYW1zLmxlbmd0aH1nZXRQYXJhbWV0ZXJzKCl7cmV0dXJuIHRoaXMuX19wYXJhbXN9Z2V0UGFyYW1ldGVySW5kZXgodCl7cmV0dXJuIHRoaXMuX19wYXJhbU1hcHBpbmdbdF19Z2V0UGFyYW1ldGVyQnlJbmRleCh0KXtyZXR1cm4gdGhpcy5fX3BhcmFtc1t0XX1oYXNQYXJhbWV0ZXIodCl7cmV0dXJuIHQgaW4gdGhpcy5fX3BhcmFtTWFwcGluZ31nZXRQYXJhbWV0ZXIodCl7Y29uc3QgZT10aGlzLl9fcGFyYW1NYXBwaW5nW3RdO3JldHVybi0xPT1lP251bGw6dGhpcy5fX3BhcmFtc1tlXX1fX3BhcmFtZXRlclZhbHVlQ2hhbmdlZCh0LGUpe3RoaXMucGFyYW1ldGVyVmFsdWVDaGFuZ2VkLmVtaXQodCxlKX1hZGRQYXJhbWV0ZXIodCl7Y29uc3QgZT10LmdldE5hbWUoKTtyZXR1cm4gbnVsbCE9dGhpcy5fX3BhcmFtTWFwcGluZ1tlXSYmKGNvbnNvbGUud2FybigiUmVwbGFjaW5nIFBhcmFtZXRlcjoiK2UpLHRoaXMucmVtb3ZlUGFyYW1ldGVyKGUpKSx0aGlzLl9fcGFyYW1TaWduYWxJZHNbZV09dC52YWx1ZUNoYW5nZWQuY29ubmVjdChlPT50aGlzLl9fcGFyYW1ldGVyVmFsdWVDaGFuZ2VkKHQsZSkpLHRoaXMuX19wYXJhbXMucHVzaCh0KSx0aGlzLl9fcGFyYW1NYXBwaW5nW2VdPXRoaXMuX19wYXJhbXMubGVuZ3RoLTEsdGhpcy5wYXJhbWV0ZXJBZGRlZC5lbWl0KGUpLHR9aW5zZXJ0UGFyYW1ldGVyKHQsZSl7Y29uc3Qgcz10LmdldE5hbWUoKTtudWxsIT10aGlzLl9fcGFyYW1NYXBwaW5nW3NdJiYoY29uc29sZS53YXJuKCJSZXBsYWNpbmcgUGFyYW1ldGVyOiIrcyksdGhpcy5yZW1vdmVQYXJhbWV0ZXIocykpLHRoaXMuX19wYXJhbVNpZ25hbElkc1tzXT10LnZhbHVlQ2hhbmdlZC5jb25uZWN0KGU9PnRoaXMuX19wYXJhbWV0ZXJWYWx1ZUNoYW5nZWQodCxlKSksdGhpcy5fX3BhcmFtcy5zcGxpY2UoZSwwLHQpO2NvbnN0IGE9e307Zm9yKGxldCB0PTA7dDx0aGlzLl9fcGFyYW1zLmxlbmd0aDt0KyspYVt0aGlzLl9fcGFyYW1zW3RdLmdldE5hbWUoKV09dDtyZXR1cm4gdGhpcy5fX3BhcmFtTWFwcGluZz1hLHRoaXMucGFyYW1ldGVyQWRkZWQuZW1pdChzKSx0fXJlbW92ZVBhcmFtZXRlcih0KXtudWxsPT10aGlzLl9fcGFyYW1NYXBwaW5nW3RdJiZjb25zb2xlLnRocm93KCJVbmFibGUgdG8gUmVtb3ZlIFBhcmFtZXRlcjoiK3QpO2NvbnN0IGU9dGhpcy5fX3BhcmFtTWFwcGluZ1t0XTt0aGlzLl9fcGFyYW1zW3RoaXMuX19wYXJhbU1hcHBpbmdbdF1dLnZhbHVlQ2hhbmdlZC5kaXNjb25uZWN0SWQodGhpcy5fX3BhcmFtU2lnbmFsSWRzW3RdKSx0aGlzLl9fcGFyYW1zLnNwbGljZShlLDEpO2NvbnN0IHM9e307Zm9yKGxldCB0PTA7dDx0aGlzLl9fcGFyYW1zLmxlbmd0aDt0Kyspc1t0aGlzLl9fcGFyYW1zW3RdLmdldE5hbWUoKV09dDt0aGlzLl9fcGFyYW1NYXBwaW5nPXMsdGhpcy5wYXJhbWV0ZXJSZW1vdmVkLmVtaXQodCl9cmVwbGFjZVBhcmFtZXRlcih0KXtjb25zdCBlPXQuZ2V0TmFtZSgpLHM9dGhpcy5fX3BhcmFtTWFwcGluZ1tlXTtyZXR1cm4gdGhpcy5fX3BhcmFtc1t0aGlzLl9fcGFyYW1NYXBwaW5nW2VdXS52YWx1ZUNoYW5nZWQuZGlzY29ubmVjdElkKHRoaXMuX19wYXJhbVNpZ25hbElkc1tlXSksdGhpcy5fX3BhcmFtU2lnbmFsSWRzW2VdPXQudmFsdWVDaGFuZ2VkLmNvbm5lY3QoZT0+dGhpcy5fX3BhcmFtZXRlclZhbHVlQ2hhbmdlZCh0LGUpKSx0aGlzLl9fcGFyYW1zW3NdPXQsdH10b0pTT04odCxlKXtjb25zdCBzPXt9O2xldCBhPTA7Zm9yKGNvbnN0IGkgb2YgdGhpcy5fX3BhcmFtcylpZihpLnRlc3RGbGFnKEYpKWlmKGkubnVtUmVmcygpPjEmJjAhPWkuZ2V0UmVmSW5kZXgodGhpcykpc1tpLmdldE5hbWUoKV09e3BhcmFtUGF0aDp0Lm1ha2VSZWxhdGl2ZShpLmdldFBhdGgoKSl9LGErKztlbHNle2NvbnN0IHI9aS50b0pTT04odCxlKTtyJiYoc1tpLmdldE5hbWUoKV09cixhKyspfWlmKGE+MClyZXR1cm57cGFyYW1zOnN9fWZyb21KU09OKHQsZSxzKXtpZih0LnBhcmFtcylmb3IoY29uc3QgcyBpbiB0LnBhcmFtcyl7Y29uc3QgYT10LnBhcmFtc1tzXSxpPXRoaXMuZ2V0UGFyYW1ldGVyKHMpO2k/YS5wYXJhbVBhdGg/ZS5yZXNvbHZlUGF0aChhLnBhcmFtUGF0aCx0PT57dGhpcy5yZXBsYWNlUGFyYW1ldGVyKHQpfSx0PT57Y29uc29sZS53YXJuKCJVbmFibGUgdG8gcmVzb2x2ZSBzaGFyZWQgcGFyYW1ldGVyOiIrYS5wYXJhbVBhdGgpfSk6aS5mcm9tSlNPTihhLGUpOmNvbnNvbGUud2FybigiUGFyYW0gbm90IGZvdW5kOiIrcyl9fXJlYWRCaW5hcnkodCxlKXtpZihlLnZlcnNpb25zWyJ6ZWEtZW5naW5lIl0uZ3JlYXRlck9yRXF1YWxUaGFuKFswLDAsM10pKXtjb25zdCBzPXQubG9hZFVJbnQzMigpO2ZvcihsZXQgYT0wO2E8czthKyspe2NvbnN0IHM9dC5sb2FkU3RyKCksYT10LmxvYWRTdHIoKTtsZXQgaT10aGlzLmdldFBhcmFtZXRlcihhKTtpZighaSl7aWYoaT1JLmNvbnN0cnVjdENsYXNzKHMsYSksIWkpe2NvbnNvbGUuZXJyb3IoIlVuYWJsZSB0byBjb25zdHJ1Y3QgcHJvcDoiK2ErIiBvZiB0eXBlOiIrcyk7Y29udGludWV9dGhpcy5hZGRQYXJhbWV0ZXIoaSl9aS5yZWFkQmluYXJ5KHQsZSl9fX10b1N0cmluZygpe3JldHVybiBKU09OLnN0cmluZ2lmeSh0aGlzLnRvSlNPTigpLG51bGwsMil9Y29weUZyb20odCxlKXtsZXQgcz10Lm51bVBhcmFtZXRlcnMoKTtmb3IoO3MtLTspe2NvbnN0IGU9dC5nZXRQYXJhbWV0ZXJCeUluZGV4KHMpLGE9dGhpcy5nZXRQYXJhbWV0ZXIoZS5nZXROYW1lKCkpO2E/YS5zZXRWYWx1ZShlLmdldFZhbHVlKCksTik6dGhpcy5hZGRQYXJhbWV0ZXIoZS5jbG9uZSgpKX19ZGVzdHJveSgpe2Zvcihjb25zdCB0IG9mIHRoaXMuX19wYXJhbXMpdC5kZXN0cm95KCk7c3VwZXIuZGVzdHJveSgpfX17Y29uc3RydWN0b3IoKXtzdXBlcigpLHRoaXMuX19ib3VuZGluZ0JveD1uZXcgcCx0aGlzLl9fYm91bmRpbmdCb3hEaXJ0eT0hMCx0aGlzLl9fdmVydGV4QXR0cmlidXRlcz1uZXcgTWFwLHRoaXMuX19tZXRhRGF0YT1uZXcgTWFwLHRoaXMuYWRkVmVydGV4QXR0cmlidXRlKCJwb3NpdGlvbnMiLHIsMCksdGhpcy5ib3VuZGluZ0JveERpcnRpZWQ9bmV3IHcsdGhpcy5nZW9tRGF0YUNoYW5nZWQ9bmV3IHcsdGhpcy5nZW9tRGF0YVRvcG9sb2d5Q2hhbmdlZD1uZXcgd31zZXREZWJ1Z05hbWUodCl7dGhpcy5fX25hbWU9dH1hZGRWZXJ0ZXhBdHRyaWJ1dGUodCxlLHMpe2xldCBhO3ZhciBpO3JldHVybiBhPShpPXMpJiZ2b2lkIDAhPT1pLmJ5dGVMZW5ndGg/bmV3IFYoZSxzKTpuZXcgVihlLG51bGwhPXRoaXMudmVydGljZXM/dGhpcy52ZXJ0aWNlcy5sZW5ndGg6MCxzKSx0aGlzLl9fdmVydGV4QXR0cmlidXRlcy5zZXQodCxhKSxhfWhhc1ZlcnRleEF0dHJpYnV0ZSh0KXtyZXR1cm4gdGhpcy5fX3ZlcnRleEF0dHJpYnV0ZXMuaGFzKHQpfWdldFZlcnRleEF0dHJpYnV0ZSh0KXtyZXR1cm4gdGhpcy5fX3ZlcnRleEF0dHJpYnV0ZXMuZ2V0KHQpfWdldFZlcnRleEF0dHJpYnV0ZXModCl7Y29uc3QgZT17fTtmb3IoY29uc3RbdCxzXW9mIHRoaXMuX192ZXJ0ZXhBdHRyaWJ1dGVzLmVudHJpZXMoKSllW3RdPXM7cmV0dXJuIGV9Z2V0IHZlcnRpY2VzKCl7cmV0dXJuIHRoaXMuX192ZXJ0ZXhBdHRyaWJ1dGVzLmdldCgicG9zaXRpb25zIil9bnVtVmVydGljZXMoKXtyZXR1cm4gdGhpcy52ZXJ0aWNlcy5sZW5ndGh9Z2V0TnVtVmVydGljZXMoKXtyZXR1cm4gdGhpcy52ZXJ0aWNlcy5sZW5ndGh9c2V0TnVtVmVydGljZXModCl7dGhpcy5fX3ZlcnRleEF0dHJpYnV0ZXMuZm9yRWFjaChlPT5lLnJlc2l6ZSh0KSl9Z2V0VmVydGV4KHQpe3JldHVybiByLmNyZWF0ZUZyb21GbG9hdDMyQnVmZmVyKHRoaXMudmVydGljZXMuZGF0YS5idWZmZXIsMyp0KX1zZXRWZXJ0ZXgodCxlKXtyZXR1cm4gci5jcmVhdGVGcm9tRmxvYXQzMkJ1ZmZlcih0aGlzLnZlcnRpY2VzLmRhdGEuYnVmZmVyLDMqdCkuc2V0RnJvbU90aGVyKGUpfW1vdmVWZXJ0aWNlcyh0KXtjb25zdCBlPXRoaXMudmVydGljZXM7Zm9yKGxldCBzPTA7czxlLmxlbmd0aDtzKyspZS5nZXRWYWx1ZVJlZihzKS5hZGRJblBsYWNlKHQpO3RoaXMuc2V0Qm91bmRpbmdCb3hEaXJ0eSgpfXRyYW5zZm9ybVZlcnRpY2VzKHQpe2NvbnN0IGU9dGhpcy52ZXJ0aWNlcztmb3IobGV0IHM9MDtzPGUubGVuZ3RoO3MrKyl7Y29uc3QgYT1lLmdldFZhbHVlUmVmKHMpLGk9dC50cmFuc2Zvcm1WZWMzKGEpO2Euc2V0KGkueCxpLnksaS56KX10aGlzLnNldEJvdW5kaW5nQm94RGlydHkoKX1nZXQgYm91bmRpbmdCb3goKXtyZXR1cm4gdGhpcy5fX2JvdW5kaW5nQm94RGlydHkmJnRoaXMudXBkYXRlQm91bmRpbmdCb3goKSx0aGlzLl9fYm91bmRpbmdCb3h9c2V0Qm91bmRpbmdCb3hEaXJ0eSgpe3RoaXMuX19ib3VuZGluZ0JveERpcnR5PSEwLHRoaXMuYm91bmRpbmdCb3hEaXJ0aWVkLmVtaXQoKX11cGRhdGVCb3VuZGluZ0JveCgpe2NvbnN0IHQ9dGhpcy52ZXJ0aWNlcyxlPW5ldyBwLHM9dC5sZW5ndGg7Zm9yKGxldCBhPTA7YTxzO2ErKyllLmFkZFBvaW50KHQuZ2V0VmFsdWVSZWYoYSkpO3RoaXMuX19ib3VuZGluZ0JveD1lLHRoaXMuX19ib3VuZGluZ0JveERpcnR5PSExfWdldE1ldGFkYXRhKHQpe3JldHVybiB0aGlzLl9fbWV0YURhdGEuZ2V0KHQpfWhhc01ldGFkYXRhKHQpe3JldHVybiB0aGlzLl9fbWV0YURhdGEuaGFzKHQpfXNldE1ldGFkYXRhKHQsZSl7dGhpcy5fX21ldGFEYXRhLnNldCh0LGUpfWRlbGV0ZU1ldGFkYXRhKHQpe3RoaXMuX19tZXRhRGF0YS5kZWxldGUodCl9Z2VuQnVmZmVycyh0KXtjb25zdCBlPXt9O2Zvcihjb25zdFt0LHNdb2YgdGhpcy5fX3ZlcnRleEF0dHJpYnV0ZXMpZVt0XT17dmFsdWVzOnMuZGF0YSxjb3VudDpzLnNpemUsZGF0YVR5cGU6cy5kYXRhVHlwZSxub3JtYWxpemVkOnMubm9ybWFsaXplZH07cmV0dXJue251bVZlcnRpY2VzOnRoaXMubnVtVmVydGljZXMoKSxhdHRyQnVmZmVyczplfX1mcmVlQnVmZmVycygpe31sb2FkQmFzZUdlb21CaW5hcnkodCl7dGhpcy5uYW1lPXQubG9hZFN0cigpO2NvbnN0IGU9dC5sb2FkVUludDgoKTt0aGlzLmRlYnVnQ29sb3I9dC5sb2FkUkdCRmxvYXQzMkNvbG9yKCk7Y29uc3Qgcz10LmxvYWRVSW50MzIoKTt0aGlzLl9fYm91bmRpbmdCb3guc2V0KHQubG9hZEZsb2F0MzJWZWMzKCksdC5sb2FkRmxvYXQzMlZlYzMoKSksdGhpcy5zZXROdW1WZXJ0aWNlcyhzKTtjb25zdCBhPXRoaXMudmVydGljZXM7bGV0IG4saDsyJmUmJihuPXRoaXMuZ2V0VmVydGV4QXR0cmlidXRlKCJub3JtYWxzIiksbnx8KG49dGhpcy5hZGRWZXJ0ZXhBdHRyaWJ1dGUoIm5vcm1hbHMiLHIsMCkpKSw0JmUmJihoPXRoaXMuZ2V0VmVydGV4QXR0cmlidXRlKCJ0ZXhDb29yZHMiKSxofHwoaD10aGlzLmFkZFZlcnRleEF0dHJpYnV0ZSgidGV4Q29vcmRzIixpLDApKSk7Y29uc3Qgbz0odCxlLHMsaSk9Pntmb3IobGV0IG49dFswXTtuPHRbMV07bisrKXtjb25zdCB0PW5ldyByKGlbMypuKzBdLzI1NSxpWzMqbisxXS8yNTUsaVszKm4rMl0vMjU1KTt0Lm11bHRpcGx5SW5QbGFjZShzKSx0LmFkZEluUGxhY2UoZSksYS5zZXRWYWx1ZShuLHQpfX0sXz0odCxlLHMsYSk9PntzLmlzTnVsbCgpJiZzLnNldCgxLDEsMSk7Zm9yKGxldCBpPXRbMF07aTx0WzFdO2krKyl7Y29uc3QgdD1uZXcgcihhWzMqaSswXS8yNTUsYVszKmkrMV0vMjU1LGFbMyppKzJdLzI1NSk7dC5tdWx0aXBseUluUGxhY2UocyksdC5hZGRJblBsYWNlKGUpLHQubm9ybWFsaXplSW5QbGFjZSgpLG4uc2V0VmFsdWUoaSx0KX19LGQ9KHQsZSxzLGEpPT57Zm9yKGxldCByPXRbMF07cjx0WzFdO3IrKyl7Y29uc3QgdD1uZXcgaShhWzIqciswXS8yNTUsYVsyKnIrMV0vMjU1KTt0Lm11bHRpcGx5SW5QbGFjZShzKSx0LmFkZEluUGxhY2UoZSksaC5zZXRWYWx1ZShyLHQpfX0sbD10LmxvYWRVSW50MzIoKTtpZigxPT1sKXt7Y29uc3QgZT10aGlzLl9fYm91bmRpbmdCb3gsYT10LmxvYWRVSW50OEFycmF5KDMqcyk7byhbMCxzXSxlLnAwLGUuZGlhZ29uYWwoKSxhKX1pZihuKXtjb25zdCBlPW5ldyBwKHQubG9hZEZsb2F0MzJWZWMzKCksdC5sb2FkRmxvYXQzMlZlYzMoKSksYT10LmxvYWRVSW50OEFycmF5KDMqcyk7XyhbMCxzXSxlLnAwLGUuZGlhZ29uYWwoKSxhKSxuLmxvYWRTcGxpdFZhbHVlcyh0KX1pZihoKXtjb25zdCBlPW5ldyBnKHQubG9hZEZsb2F0MzJWZWMyKCksdC5sb2FkRmxvYXQzMlZlYzIoKSksYT10LmxvYWRVSW50OEFycmF5KDIqcyk7ZChbMCxzXSxlLnAwLGUuZGlhZ29uYWwoKSxhKSxoLmxvYWRTcGxpdFZhbHVlcyh0KX19ZWxzZXtjb25zdCBlPVtdO2xldCBhPTA7Zm9yKGxldCBzPTA7czxsO3MrKyl7Y29uc3Qgcz10LmxvYWRVSW50MzIoKSxpPXtyYW5nZTpbYSxhK3NdLGJib3g6bmV3IHAodC5sb2FkRmxvYXQzMlZlYzMoKSx0LmxvYWRGbG9hdDMyVmVjMygpKX07biYmKGkubm9ybWFsc1JhbmdlPW5ldyBwKHQubG9hZEZsb2F0MzJWZWMzKCksdC5sb2FkRmxvYXQzMlZlYzMoKSkpLGgmJihpLnRleENvb3Jkc1JhbmdlPW5ldyBnKHQubG9hZEZsb2F0MzJWZWMyKCksdC5sb2FkRmxvYXQzMlZlYzIoKSkpLGUucHVzaChpKSxhKz1zfWNvbnN0IGk9dC5sb2FkVUludDhBcnJheSgzKnMpO2xldCByLGM7biYmKHI9dC5sb2FkVUludDhBcnJheSgzKnMpKSxoJiYoYz10LmxvYWRVSW50OEFycmF5KDIqcykpO2ZvcihsZXQgdD0wO3Q8bDt0Kyspe3tjb25zdCBzPWVbdF0uYmJveDtvKGVbdF0ucmFuZ2Uscy5wMCxzLmRpYWdvbmFsKCksaSl9aWYobil7Y29uc3Qgcz1lW3RdLm5vcm1hbHNSYW5nZTtfKGVbdF0ucmFuZ2Uscy5wMCxzLmRpYWdvbmFsKCkscil9aWYoaCl7Y29uc3Qgcz1lW3RdLnRleENvb3Jkc1JhbmdlO2QoZVt0XS5yYW5nZSxzLnAwLHMuZGlhZ29uYWwoKSxjKX19biYmbi5sb2FkU3BsaXRWYWx1ZXModCksaCYmaC5sb2FkU3BsaXRWYWx1ZXModCl9fXRvSlNPTih0LGUpe2xldCBzPXN1cGVyLnRvSlNPTih0LGUpO2lmKHN8fChzPXt9KSxzLnR5cGU9SS5nZXRDbGFzc05hbWUodGhpcyksISgxMDI0JmUpKXtjb25zdCBhPXt9O2Zvcihjb25zdFtzLGldb2YgdGhpcy5fX3ZlcnRleEF0dHJpYnV0ZXMuZW50cmllcygpKWFbc109aS50b0pTT04odCxlKTtzLnZlcnRleEF0dHJpYnV0ZXM9YX1yZXR1cm4gc31mcm9tSlNPTih0LGUscyl7c3VwZXIuZnJvbUpTT04odCxlLHMpO2Zvcihjb25zdCBlIGluIHQudmVydGV4QXR0cmlidXRlcyl7bGV0IHM9dGhpcy5fX3ZlcnRleEF0dHJpYnV0ZXMuZ2V0KGUpO2NvbnN0IGk9dC52ZXJ0ZXhBdHRyaWJ1dGVzW2VdO2lmKCFzKXtjb25zdCB0PWEuZ2V0VHlwZShpLmRhdGFUeXBlKTtzPW5ldyBWZXJ0ZXhBdHRyaWJ1dGUodGhpcyx0LDAsaS5kZWZhdWx0U2NhbGFyVmFsdWUpLHRoaXMuX192ZXJ0ZXhBdHRyaWJ1dGVzLnNldChlLHMpfXMuZnJvbUpTT04oaSl9fXRvU3RyaW5nKCl7cmV0dXJuIEpTT04uc3RyaW5naWZ5KHRoaXMudG9KU09OKCksbnVsbCwyKX19Y2xhc3MgQSBleHRlbmRzIE17Y29uc3RydWN0b3IoKXtzdXBlcigpfWxvYWRCaW4odCl7dGhpcy5uYW1lPXQubG9hZFN0cigpO2NvbnN0IGU9dC5sb2FkVUludDMyKCk7dGhpcy5fX2JvdW5kaW5nQm94LnNldCh0LmxvYWRGbG9hdDMyVmVjMygpLHQubG9hZEZsb2F0MzJWZWMzKCkpLHRoaXMuc2V0TnVtVmVydGljZXMoZSk7Y29uc3Qgcz10aGlzLnZlcnRpY2VzO2lmKGU8MjU2KXtjb25zdCBhPXRoaXMuX19ib3VuZGluZ0JveC50b01hdDQoKSxpPXQubG9hZFVJbnQ4QXJyYXkoMyplKTtmb3IobGV0IHQ9MDt0PGU7dCsrKXtjb25zdCBlPW5ldyBWZWMzKGlbMyp0KzBdLzI1NSxpWzMqdCsxXS8yNTUsaVszKnQrMl0vMjU1KTtzLnNldFZhbHVlKHQsYS50cmFuc2Zvcm1WZWMzKGUpKX19ZWxzZXtjb25zdCBhPXQubG9hZFVJbnQzMigpLGk9W107Zm9yKGxldCBlPTA7ZTxhO2UrKyl7Y29uc3QgZT10LmxvYWRVSW50MzJWZWMyKCkscz10LmxvYWRGbG9hdDMyVmVjMygpLGE9dC5sb2FkRmxvYXQzMlZlYzMoKTtpLnB1c2goe3JhbmdlOmUsYmJveDpuZXcgQm94MyhzLGEpfSl9Y29uc3Qgcj10LmxvYWRVSW50OEFycmF5KDMqZSk7Zm9yKGxldCB0PTA7dDxhO3QrKyl7Y29uc3QgZT1pW3RdLmJib3gudG9NYXQ0KCk7Zm9yKGxldCBhPWlbdF0ucmFuZ2UueDthPGlbdF0ucmFuZ2UueTthKyspe2NvbnN0IHQ9bmV3IFZlYzMoclszKmErMF0vMjU1LHJbMyphKzFdLzI1NSxyWzMqYSsyXS8yNTUpO3Muc2V0VmFsdWUoYSxlLnRyYW5zZm9ybVZlYzModCkpfX19fXJlYWRCaW5hcnkodCxlKXtzdXBlci5sb2FkQmFzZUdlb21CaW5hcnkodCksdGhpcy5nZW9tRGF0YUNoYW5nZWQuZW1pdCgpfX1jbGFzcyBTIGV4dGVuZHMgTXtjb25zdHJ1Y3Rvcigpe3N1cGVyKCksdGhpcy5fX2luZGljZXM9bmV3IFVpbnQzMkFycmF5LHRoaXMuX19zZWdtZW50QXR0cmlidXRlcz1uZXcgTWFwLHRoaXMubGluZVRoaWNrbmVzcz0wfWdldEluZGljZXMoKXtyZXR1cm4gdGhpcy5fX2luZGljZXN9Z2V0TnVtU2VnbWVudHMoKXtyZXR1cm4gdGhpcy5fX2luZGljZXMubGVuZ3RoLzJ9c2V0TnVtU2VnbWVudHModCl7Y29uc3QgZT1uZXcgVWludDMyQXJyYXkoMip0KTt0aGlzLl9faW5kaWNlcz1lfXNldFNlZ21lbnQodCxlLHMpe2lmKHQ+PXRoaXMuX19pbmRpY2VzLmxlbmd0aC8yKXRocm93IG5ldyBFcnJvcigiSW52YWxpZCBsaW5lIGluZGV4OiIrdCsiLiBOdW0gU2VnbWVudHM6Iit0aGlzLl9faW5kaWNlcy5sZW5ndGgvMik7dGhpcy5fX2luZGljZXNbMip0KzBdPWUsdGhpcy5fX2luZGljZXNbMip0KzFdPXN9Z2V0U2VnbWVudFZlcnRleEluZGV4KHQsZSl7aWYodDx0aGlzLm51bUxpbmVzKXJldHVybiB0aGlzLl9faW5kaWNlc1syKnQrZV19YWRkU2VnbWVudEF0dHJpYnV0ZSh0LGUscyl7Y29uc3QgYT1uZXcgQXR0cmlidXRlKGUsbnVsbCE9cz9zOnRoaXMucG9seWdvbkNvdW50KTtyZXR1cm4gdGhpcy5fX3NlZ21lbnRBdHRyaWJ1dGVzLnNldCh0LGEpLGF9aGFzU2VnbWVudEF0dHJpYnV0ZSh0KXtyZXR1cm4gdGhpcy5fX3NlZ21lbnRBdHRyaWJ1dGVzLmhhcyh0KX1nZXRTZWdtZW50QXR0cmlidXRlKHQpe3JldHVybiB0aGlzLl9fc2VnbWVudEF0dHJpYnV0ZXMuZ2V0KHQpfWdlbkJ1ZmZlcnMoKXtjb25zdCB0PXN1cGVyLmdlbkJ1ZmZlcnMoKTtsZXQgZTtyZXR1cm4gdC5udW1WZXJ0aWNlczxNYXRoLnBvdygyLDgpPyhlPW5ldyBVaW50OEFycmF5KHRoaXMuX19pbmRpY2VzLmxlbmd0aCksdGhpcy5fX2luZGljZXMuZm9yRWFjaCgodCxzKT0+e2Vbc109dH0pKTp0Lm51bVZlcnRpY2VzPE1hdGgucG93KDIsMTYpPyhlPW5ldyBVaW50MTZBcnJheSh0aGlzLl9faW5kaWNlcy5sZW5ndGgpLHRoaXMuX19pbmRpY2VzLmZvckVhY2goKHQscyk9PntlW3NdPXR9KSk6ZT10aGlzLl9faW5kaWNlcyx0LmluZGljZXM9ZSx0fXJlYWRCaW5hcnkodCxlKXtzdXBlci5sb2FkQmFzZUdlb21CaW5hcnkodCksdGhpcy5zZXROdW1TZWdtZW50cyh0LmxvYWRVSW50MzIoKSk7Y29uc3Qgcz10LmxvYWRVSW50OCgpOzE9PXM/dGhpcy5fX2luZGljZXM9dC5sb2FkVUludDhBcnJheSgpOjI9PXM/dGhpcy5fX2luZGljZXM9dC5sb2FkVUludDE2QXJyYXkoKTo0PT1zJiYodGhpcy5fX2luZGljZXM9dC5sb2FkVUludDMyQXJyYXkoKSksdGhpcy5nZW9tRGF0YUNoYW5nZWQuZW1pdCgpfXRvSlNPTih0LGUpe2NvbnN0IHM9c3VwZXIudG9KU09OKHQsZSk7cmV0dXJuIDEwMjQmZXx8KHMuaW5kaWNlcz1BcnJheS5mcm9tKHRoaXMuX19pbmRpY2VzKSksc31mcm9tSlNPTih0LGUscyl7c3VwZXIuZnJvbUpTT04odCxlLHMpLHRoaXMuX19pbmRpY2VzPVVpbnQzMkFycmF5LmZyb20odC5pbmRpY2VzKX19Y2xhc3MgTyBleHRlbmRzIFZ7Y29uc3RydWN0b3IodCxlLHMsYSl7c3VwZXIoZSxzLGEpLHRoaXMuX19nZW9tPXQsdGhpcy5fX3NwbGl0cz17fSx0aGlzLl9fc3BsaXRWYWx1ZXM9W119Z2V0RmFjZVZlcnRleFZhbHVlUmVmKHQsZSl7Y29uc3Qgcz10aGlzLl9fZ2VvbS5nZXRGYWNlVmVydGV4SW5kZXgodCxlKTtyZXR1cm4gcyBpbiB0aGlzLl9fc3BsaXRzJiZ0IGluIHRoaXMuX19zcGxpdHNbc10/dGhpcy5fX3NwbGl0VmFsdWVzW3RoaXMuX19zcGxpdHNbc11bdF1dOnRoaXMuZ2V0VmFsdWVSZWYocyl9c2V0RmFjZVZlcnRleFZhbHVlKHQsZSxzKXtjb25zdCBhPXRoaXMuX19nZW9tLmdldEZhY2VWZXJ0ZXhJbmRleCh0LGUpO3RoaXMuc2V0RmFjZVZlcnRleFZhbHVlX0J5VmVydGV4SW5kZXgodCxhLHMpfXNldEZhY2VWZXJ0ZXhWYWx1ZV9CeVZlcnRleEluZGV4KHQsZSxzKXtjb25zdCBhPXRoaXMuZ2V0VmFsdWVSZWYoZSk7aWYoYS5pc1ZhbGlkKCkpaWYoYS5hcHByb3hFcXVhbChzKSk7ZWxzZXtpZihlIGluIHRoaXMuX19zcGxpdHMpe2NvbnN0IGE9dGhpcy5fX3NwbGl0c1tlXTtmb3IoY29uc3QgZSBpbiBhKXtjb25zdCBpPWFbZV07aWYodGhpcy5fX3NwbGl0VmFsdWVzW2ldLmFwcHJveEVxdWFsKHMpKXJldHVybiB2b2lkKGFbdF09aSl9aWYodCBpbiB0aGlzLl9fc3BsaXRzW2VdKXtyZXR1cm4gdm9pZCB0aGlzLl9fc3BsaXRWYWx1ZXNbdGhpcy5fX3NwbGl0c1tlXVt0XV0uc2V0RnJvbU90aGVyKHMpfX1lbHNlIHRoaXMuX19zcGxpdHNbZV09e307dGhpcy5fX3NwbGl0c1tlXVt0XT10aGlzLl9fc3BsaXRWYWx1ZXMubGVuZ3RoLHRoaXMuX19zcGxpdFZhbHVlcy5wdXNoKHMpfWVsc2UgYS5zZXRGcm9tT3RoZXIocyl9c2V0U3BsaXRWZXJ0ZXhWYWx1ZSh0LGUscyl7aWYodCBpbiB0aGlzLl9fc3BsaXRzfHwodGhpcy5fX3NwbGl0c1t0XT17fSksZSBpbiB0aGlzLl9fc3BsaXRzW3RdKXtpZih0aGlzLl9fc3BsaXRWYWx1ZXNbdGhpcy5fX3NwbGl0c1t0XVtlXV0uYXBwcm94RXF1YWwocykpcmV0dXJuO2NvbnNvbGUud2FybigiRmFjZSBWZXJ0ZXggQWxyZWFkeSBTcGxpdCB3aXRoIGRpZmZlcmVudCB2YWx1ZSIpfXRoaXMuX19zcGxpdHNbdF1bZV09dGhpcy5fX3NwbGl0VmFsdWVzLmxlbmd0aCx0aGlzLl9fc3BsaXRWYWx1ZXMucHVzaChzKX1zZXRTcGxpdFZlcnRleFZhbHVlcyh0LGUscyl7dCBpbiB0aGlzLl9fc3BsaXRzfHwodGhpcy5fX3NwbGl0c1t0XT17fSk7Y29uc3QgYT10aGlzLl9fc3BsaXRWYWx1ZXMubGVuZ3RoO3RoaXMuX19zcGxpdFZhbHVlcy5wdXNoKHMpO2Zvcihjb25zdCBzIG9mIGUpdGhpcy5fX3NwbGl0c1t0XVtzXT1hfWdldFNwbGl0cygpe3JldHVybiB0aGlzLl9fc3BsaXRzfWdldFNwbGl0Q291bnQoKXtsZXQgdD0wO2Zvcihjb25zdCBlIGluIHRoaXMuX19zcGxpdHMpdCs9T2JqZWN0LmtleXModGhpcy5fX3NwbGl0c1tlXSkubGVuZ3RoO3JldHVybiB0fWdlbmVyYXRlU3BsaXRWYWx1ZXModCxlKXtpZigwPT1lKXJldHVybiB0aGlzLl9fZGF0YTtjb25zdCBzPXRoaXMubGVuZ3RoLGE9dGhpcy5sZW5ndGgrZSxpPXRoaXMuX19kYXRhVHlwZS5udW1FbGVtZW50cz90aGlzLl9fZGF0YVR5cGUubnVtRWxlbWVudHMoKToxLHI9bmV3IEZsb2F0MzJBcnJheShhKmkpO2ZvcihsZXQgdD0wO3Q8dGhpcy5fX2RhdGEubGVuZ3RoO3QrKylyW3RdPXRoaXMuX19kYXRhW3RdO2Zvcihjb25zdCBlIGluIHQpe2NvbnN0IGE9dFtlXTtmb3IoY29uc3QgdCBpbiBhKXtjb25zdCBuPXMrYVt0XTtpZihlIGluIHRoaXMuX19zcGxpdHMmJnQgaW4gdGhpcy5fX3NwbGl0c1tlXSl7Y29uc3Qgcz10aGlzLl9fc3BsaXRzW2VdW3RdOzY9PXRoaXMuX19kYXRhVHlwZT9yW24qaV09dGhpcy5fX3NwbGl0VmFsdWVzW3NdOnRoaXMuX19kYXRhVHlwZS5jcmVhdGVGcm9tRmxvYXQzMkJ1ZmZlcihyLmJ1ZmZlcixuKmkpLnNldEZyb21PdGhlcih0aGlzLl9fc3BsaXRWYWx1ZXNbc10pfWVsc2V7Y29uc3QgdD1wYXJzZUludChlKTtmb3IobGV0IGU9MDtlPGk7ZSsrKXQqaStlPnRoaXMuX19kYXRhLmxlbmd0aCYmY29uc29sZS5sb2coIkVycm9yIHJlbWFwcGluZyBzcmM6Iit0KmkrZSksbippK2U+ci5sZW5ndGgmJmNvbnNvbGUubG9nKCJFcnJvciByZW1hcHBpbmcgdGd0OiIrbippK2UpLHJbbippK2VdPXRoaXMuX19kYXRhW3QqaStlXX19fXJldHVybiByfXRvSlNPTih0LGUpe2NvbnN0IHM9c3VwZXIudG9KU09OKHQsZSk7cmV0dXJuIHMuc3BsaXRzPXRoaXMuX19zcGxpdHMscy5zcGxpdFZhbHVlcz10aGlzLl9fc3BsaXRWYWx1ZXMsc31mcm9tSlNPTih0LGUscyl7c3VwZXIuZnJvbUpTT04odCxlLHMpLHRoaXMuX19zcGxpdHM9dC5zcGxpdHMsdGhpcy5fX3NwbGl0VmFsdWVzPVtdO2Zvcihjb25zdCBlIG9mIHQuc3BsaXRWYWx1ZXMpdGhpcy5fX3NwbGl0VmFsdWVzLnB1c2godGhpcy5fX2RhdGFUeXBlLmNyZWF0ZUZyb21KU09OKGUpKX1sb2FkU3BsaXRWYWx1ZXModCl7Y29uc3QgZT10LmxvYWRVSW50MzJBcnJheSgpO2lmKDA9PWUubGVuZ3RoKXJldHVybjtsZXQgcz0wLGE9MDtmb3IoOzspe2NvbnN0IHQ9ZVtzKytdLGk9ZVtzKytdLHI9e307Zm9yKGxldCB0PTA7dDxpO3QrKyl7Y29uc3QgdD1lW3MrK10saT1lW3MrK107clt0XT1pLGk+PWEmJihhPWkrMSl9aWYodGhpcy5fX3NwbGl0c1t0XT1yLHM+PWUubGVuZ3RoKWJyZWFrfWNvbnN0IGk9dGhpcy5fX251bUZsb2F0MzJFbGVtZW50cyxyPXQubG9hZEZsb2F0MzJBcnJheShhKmkpO3RoaXMuX19zcGxpdFZhbHVlcz1bXTtmb3IobGV0IHQ9MDt0PGE7dCsrKXtjb25zdCBlPXRoaXMuX19kYXRhVHlwZS5jcmVhdGVGcm9tRmxvYXQzMkFycmF5KHIuc2xpY2UodCppLHQqaStpKSk7dGhpcy5fX3NwbGl0VmFsdWVzLnB1c2goZSl9fX1jbGFzcyBQIGV4dGVuZHMgTXtjb25zdHJ1Y3Rvcigpe3N1cGVyKCksdGhpcy5pbml0KCl9aW5pdCgpe3RoaXMuX19mYWNlQ291bnRzPVtdLHRoaXMuX19mYWNlVmVydGV4Q291bnRzPW5ldyBVaW50OEFycmF5LHRoaXMuX19mYWNlT2Zmc2V0cz1uZXcgVWludDMyQXJyYXksdGhpcy5fX2ZhY2VWZXJ0ZXhJbmRpY2VzPW5ldyBVaW50MzJBcnJheSx0aGlzLl9fbnVtUG9wdWxhdGVkRmFjZVZlcnRleEluZGljZXM9MCx0aGlzLl9fZmFjZUF0dHJpYnV0ZXM9bmV3IE1hcCx0aGlzLl9fZWRnZUF0dHJpYnV0ZXM9bmV3IE1hcCx0aGlzLl9fbG9nVG9wb2xvZ3lXYXJuaW5ncz0hMSx0aGlzLmVkZ2VWZXJ0cz12b2lkIDAsdGhpcy52ZXJ0ZXhFZGdlcz12b2lkIDAsdGhpcy5udW1FZGdlcz0wLHRoaXMuZWRnZUZsYWdzPW5ldyBVaW50MzJBcnJheSx0aGlzLmVkZ2VBbmdsZXM9bmV3IEZsb2F0MzJBcnJheX1nZXRGYWNlVmVydGV4SW5kaWNlcygpe3JldHVybiB0aGlzLl9fZmFjZVZlcnRleEluZGljZXN9Z2V0RmFjZUNvdW50cygpe3JldHVybiB0aGlzLl9fZmFjZUNvdW50c31jbGVhcigpe3RoaXMuX19mYWNlVmVydGV4SW5kaWNlcz12b2lkIDAsdGhpcy5fX2ZhY2VDb3VudHM9W10sdGhpcy5fX251bVBvcHVsYXRlZEZhY2VWZXJ0ZXhJbmRpY2VzPTB9c2V0RmFjZUNvdW50cyh0KXtpZih0aGlzLl9fbnVtUG9wdWxhdGVkRmFjZVZlcnRleEluZGljZXMpdGhyb3cgbmV3IEVycm9yKCJDYW5ub3Qgc2V0IGZhY2UgY291bnRzIG9uIGEgbWVzaCB0aGF0IGlzIGFscmVhZHkgcG9wdWxhdGVkLiBQbGVhc2UgY2FsbCAnY2xlYXInIGJlZm9yZSByZS1idWlsZGluZyB0aGUgbWVzaC4iKTt0aGlzLl9fZmFjZUNvdW50cz10O2xldCBlPTAscz0wLGE9Mztmb3IoY29uc3QgdCBvZiB0aGlzLl9fZmFjZUNvdW50cyllKz10LHMrPXQqYSxhKys7dGhpcy5fX2ZhY2VWZXJ0ZXhDb3VudHM9bmV3IFVpbnQ4QXJyYXkoZSksdGhpcy5fX2ZhY2VPZmZzZXRzPW5ldyBVaW50MzJBcnJheShlKSx0aGlzLl9fZmFjZVZlcnRleEluZGljZXM9bmV3IFVpbnQzMkFycmF5KHMpO2Zvcihjb25zdCB0IG9mIHRoaXMuX19mYWNlQXR0cmlidXRlcyl0LnJlc2l6ZShlKX1zZXRGYWNlVmVydGV4SW5kaWNlcyh0KXtjb25zdCBlPUFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywxKSxzPXRoaXMuX19udW1Qb3B1bGF0ZWRGYWNlVmVydGV4SW5kaWNlcztmb3IobGV0IHQ9MDt0PGUubGVuZ3RoO3QrKyl0aGlzLl9fZmFjZVZlcnRleEluZGljZXNbcyt0XT1lW3RdO3RoaXMuX19mYWNlVmVydGV4Q291bnRzW3RdPWUubGVuZ3RoLTMsdGhpcy5fX2ZhY2VPZmZzZXRzW3RdPXMsdGhpcy5fX251bVBvcHVsYXRlZEZhY2VWZXJ0ZXhJbmRpY2VzKz1lLmxlbmd0aH1nZXRGYWNlVmVydGV4SW5kaWNlcyh0KXtjb25zdCBlPVtdLHM9dGhpcy5fX2ZhY2VPZmZzZXRzW3RdLGE9dGhpcy5fX2ZhY2VWZXJ0ZXhDb3VudHNbdF0rMztmb3IobGV0IHQ9MDt0PGE7dCsrKWUucHVzaCh0aGlzLl9fZmFjZVZlcnRleEluZGljZXNbcyt0XSk7cmV0dXJuIGV9Z2V0RmFjZVZlcnRleEluZGV4KHQsZSl7Y29uc3Qgcz10aGlzLl9fZmFjZU9mZnNldHNbdF07cmV0dXJuIHRoaXMuX19mYWNlVmVydGV4SW5kaWNlc1tzK2VdfWdldE51bUZhY2VzKCl7cmV0dXJuIHRoaXMuX19mYWNlVmVydGV4Q291bnRzLmxlbmd0aH1hZGRWZXJ0ZXhBdHRyaWJ1dGUodCxlLHMpe2NvbnN0IGE9bmV3IE8odGhpcyxlLG51bGwhPXRoaXMudmVydGljZXM/dGhpcy52ZXJ0aWNlcy5sZW5ndGg6MCxzKTtyZXR1cm4gdGhpcy5fX3ZlcnRleEF0dHJpYnV0ZXMuc2V0KHQsYSksYX1hZGRGYWNlQXR0cmlidXRlKHQsZSxzKXtjb25zdCBhPW5ldyBWKGUsbnVsbCE9cz9zOnRoaXMuZ2V0TnVtRmFjZXMoKSk7cmV0dXJuIHRoaXMuX19mYWNlQXR0cmlidXRlcy5zZXQodCxhKSxhfWhhc0ZhY2VBdHRyaWJ1dGUodCl7cmV0dXJuIHRoaXMuX19mYWNlQXR0cmlidXRlcy5oYXModCl9Z2V0RmFjZUF0dHJpYnV0ZSh0KXtyZXR1cm4gdGhpcy5fX2ZhY2VBdHRyaWJ1dGVzLmdldCh0KX1hZGRFZGdlQXR0cmlidXRlKHQsZSxzKXtjb25zdCBhPW5ldyBWKGUsbnVsbCE9cz9zOnRoaXMuZ2V0TnVtRWRnZXMoKSk7cmV0dXJuIHRoaXMuX19lZGdlQXR0cmlidXRlcy5zZXQodCxhKSxhfWhhc0VkZ2VBdHRyaWJ1dGUodCl7cmV0dXJuIHRoaXMuX19lZGdlQXR0cmlidXRlcy5oYXModCl9Z2V0RWRnZUF0dHJpYnV0ZSh0KXtyZXR1cm4gdGhpcy5fX2VkZ2VBdHRyaWJ1dGVzLmdldCh0KX1nZW5Ub3BvbG9neUluZm8oKXtjb25zdCB0PXt9O3RoaXMudmVydGV4RWRnZXM9W10sdGhpcy5lZGdlRmFjZXM9W10sdGhpcy5lZGdlVmVydHM9W10sdGhpcy5mYWNlRWRnZXM9W10sdGhpcy5udW1FZGdlcz0wO2NvbnN0IGU9KGUscyk9PntsZXQgYT1lLGk9cztpZihpPGEpe2NvbnN0IHQ9YTthPWksaT10fWNvbnN0IHI9YSsiPiIraTtpZihyIGluIHQpcmV0dXJuIHRbcl07Y29uc3Qgbj10aGlzLnZlcnRpY2VzLmdldFZhbHVlUmVmKGEpLGg9dGhpcy52ZXJ0aWNlcy5nZXRWYWx1ZVJlZihpKS5zdWJ0cmFjdChuKSxvPXtlZGdlSW5kZXg6dGhpcy5lZGdlRmFjZXMubGVuZ3RoLzIsZWRnZVZlYzpofTtyZXR1cm4gdFtyXT1vLHRoaXMuZWRnZUZhY2VzLnB1c2goLTEpLHRoaXMuZWRnZUZhY2VzLnB1c2goLTEpLHRoaXMuZWRnZVZlcnRzLnB1c2goYSksdGhpcy5lZGdlVmVydHMucHVzaChpKSx0aGlzLm51bUVkZ2VzKyssb30scz0odCxzLGEpPT57Y29uc3QgaT1lKHQscykuZWRnZUluZGV4O2lmKHM8dCl7Y29uc3QgdD0yKmkrMDt0aGlzLl9fbG9nVG9wb2xvZ3lXYXJuaW5ncyYmLTEhPXRoaXMuZWRnZUZhY2VzW3RdJiZjb25zb2xlLndhcm4oIkVkZ2UgcG9seSAwIGFscmVhZHkgc2V0LiBNZXNoIGlzIG5vbi1tYW5pZm9sZC4iKSx0aGlzLmVkZ2VGYWNlc1t0XT1hfWVsc2V7Y29uc3QgdD0yKmkrMTt0aGlzLl9fbG9nVG9wb2xvZ3lXYXJuaW5ncyYmLTEhPXRoaXMuZWRnZUZhY2VzW3RdJiZjb25zb2xlLndhcm4oIkVkZ2UgcG9seSAxIGFscmVhZHkgc2V0LiBNZXNoIGlzIG5vbi1tYW5pZm9sZC4iKSx0aGlzLmVkZ2VGYWNlc1t0XT1hfWEgaW4gdGhpcy5mYWNlRWRnZXN8fCh0aGlzLmZhY2VFZGdlc1thXT1bXSksdGhpcy5mYWNlRWRnZXNbYV0ucHVzaChpKSxudWxsPT10aGlzLnZlcnRleEVkZ2VzW3RdJiYodGhpcy52ZXJ0ZXhFZGdlc1t0XT1uZXcgU2V0KSxudWxsPT10aGlzLnZlcnRleEVkZ2VzW3NdJiYodGhpcy52ZXJ0ZXhFZGdlc1tzXT1uZXcgU2V0KSx0aGlzLnZlcnRleEVkZ2VzW3RdLmFkZChpKSx0aGlzLnZlcnRleEVkZ2VzW3NdLmFkZChpKX0sYT10aGlzLmdldE51bUZhY2VzKCk7Zm9yKGxldCB0PTA7dDxhO3QrKyl7Y29uc3QgZT10aGlzLmdldEZhY2VWZXJ0ZXhJbmRpY2VzKHQpO2ZvcihsZXQgYT0wO2E8ZS5sZW5ndGg7YSsrKXtzKGVbYV0sZVsoYSsxKSVlLmxlbmd0aF0sdCl9fX1jb21wdXRlRmFjZU5vcm1hbHMoKXtjb25zdCB0PXRoaXMudmVydGljZXMsZT10aGlzLmFkZEZhY2VBdHRyaWJ1dGUoIm5vcm1hbHMiLHIpLHM9dGhpcy5nZXROdW1GYWNlcygpO2ZvcihsZXQgYT0wO2E8czthKyspe2NvbnN0IHM9dGhpcy5nZXRGYWNlVmVydGV4SW5kaWNlcyhhKSxpPXQuZ2V0VmFsdWVSZWYoc1swXSk7bGV0IG49dC5nZXRWYWx1ZVJlZihzWzFdKTtjb25zdCBoPW5ldyByO2ZvcihsZXQgZT0yO2U8cy5sZW5ndGg7ZSsrKXtjb25zdCBhPXQuZ2V0VmFsdWVSZWYoc1tlXSkscj1uLnN1YnRyYWN0KGkpLG89YS5zdWJ0cmFjdChpKTtoLmFkZEluUGxhY2Uoci5jcm9zcyhvKS5ub3JtYWxpemUoKSksbj1hfWgubGVuZ3RoU3F1YXJlZCgpLE51bWJlci5FUFNJTE9OLGUuc2V0VmFsdWUoYSxoLm5vcm1hbGl6ZSgpKX19Z2VuZXJhdGVFZGdlRmxhZ3MoKXtudWxsPT10aGlzLnZlcnRleEVkZ2VzJiZ0aGlzLmdlblRvcG9sb2d5SW5mbygpLHRoaXMuaGFzRmFjZUF0dHJpYnV0ZSgibm9ybWFscyIpfHx0aGlzLmNvbXB1dGVGYWNlTm9ybWFscygpO2NvbnN0IHQ9dGhpcy52ZXJ0aWNlcyxlPXRoaXMuZ2V0RmFjZUF0dHJpYnV0ZSgibm9ybWFscyIpO3RoaXMuZWRnZVZlY3M9W10sdGhpcy5lZGdlQW5nbGVzPW5ldyBGbG9hdDMyQXJyYXkodGhpcy5udW1FZGdlcyk7Zm9yKGxldCBzPTA7czx0aGlzLmVkZ2VGYWNlcy5sZW5ndGg7cys9Mil7Y29uc3QgYT10aGlzLmVkZ2VWZXJ0c1tzXSxpPXRoaXMuZWRnZVZlcnRzW3MrMV0scj10LmdldFZhbHVlUmVmKGkpLnN1YnRyYWN0KHQuZ2V0VmFsdWVSZWYoYSkpO3Iubm9ybWFsaXplSW5QbGFjZSgpLHRoaXMuZWRnZVZlY3MucHVzaChyKTtjb25zdCBuPXRoaXMuZWRnZUZhY2VzW3NdLGg9dGhpcy5lZGdlRmFjZXNbcysxXTtpZigtMT09bnx8LTE9PWgpe3RoaXMuZWRnZUFuZ2xlc1tzLzJdPTIqTWF0aC5QSTtjb250aW51ZX1jb25zdCBvPWUuZ2V0VmFsdWVSZWYobiksXz1lLmdldFZhbHVlUmVmKGgpO3RoaXMuZWRnZUFuZ2xlc1tzLzJdPW8uYW5nbGVUbyhfKX19Y29tcHV0ZVZlcnRleE5vcm1hbHModD0xKXt0aGlzLmdlbmVyYXRlRWRnZUZsYWdzKCk7dGhpcy52ZXJ0aWNlcztjb25zdCBlPXRoaXMuZ2V0RmFjZUF0dHJpYnV0ZSgibm9ybWFscyIpLHM9dGhpcy5hZGRWZXJ0ZXhBdHRyaWJ1dGUoIm5vcm1hbHMiLHIpLGE9ZS5kYXRhLmJ1ZmZlcixpPXMuZGF0YSxuPSh0LGUpPT57aVszKnQrMF09ZS54LGlbMyp0KzFdPWUueSxpWzMqdCsyXT1lLnp9LGg9KHQsZSk9PntsZXQgcyxhO2NvbnN0IGk9dGhpcy5mYWNlRWRnZXNbdF07Zm9yKGNvbnN0IHQgb2YgaSkodGhpcy5lZGdlVmVydHNbMip0XT09ZXx8dGhpcy5lZGdlVmVydHNbMip0KzFdPT1lKSYmKHM/YT10aGlzLmVkZ2VWZWNzW3RdOnM9dGhpcy5lZGdlVmVjc1t0XSk7cmV0dXJuW3MsYV19O2ZvcihsZXQgZT0wO2U8dGhpcy52ZXJ0ZXhFZGdlcy5sZW5ndGg7ZSsrKXtpZihudWxsPT10aGlzLnZlcnRleEVkZ2VzW2VdKWNvbnRpbnVlO2NvbnN0IGk9dGhpcy52ZXJ0ZXhFZGdlc1tlXSxfPVtdLGQ9dD0+e2xldCBlPSExO2Zvcihjb25zdCBzIG9mIF8paWYoZT0tMSE9cy5pbmRleE9mKHQpLGUpYnJlYWs7ZXx8Xy5wdXNoKFt0XSl9O2Zvcihjb25zdCBlIG9mIGkpe2NvbnN0IHM9dGhpcy5lZGdlRmFjZXNbMiplXSxhPXRoaXMuZWRnZUZhY2VzWzIqZSsxXTtpZigtMSE9cyYmLTE9PWEmJnRoaXMuZWRnZUFuZ2xlc1tlXTx0KXtsZXQgdD0tMSxlPS0xO2ZvcihsZXQgaT0wO2k8Xy5sZW5ndGg7aSsrKS0xPT10JiYtMSE9X1tpXS5pbmRleE9mKHMpJiYodD1pKSwtMT09ZSYmLTEhPV9baV0uaW5kZXhPZihhKSYmKGU9aSk7LTE9PXQmJi0xPT1lP18ucHVzaChbcyxhXSk6LTEhPXQmJi0xIT1lP3QhPWUmJihfW3RdPV9bdF0uY29uY2F0KF9bZV0pLF8uc3BsaWNlKGUsMSkpOigtMT09dCYmX1tlXS5wdXNoKHMpLC0xPT1lJiZfW3RdLnB1c2goYSkpfWVsc2UtMSE9cyYmZChzKSwtMSE9YSYmZChhKX1fLnNvcnQoKHQsZSk9PnQubGVuZ3RoPGUubGVuZ3RoPzE6dC5sZW5ndGg+ZS5sZW5ndGg/LTE6MCk7bGV0IGw9ITA7Zm9yKGNvbnN0IHQgb2YgXyl7Y29uc3QgaT1uZXcgcjtmb3IoY29uc3QgcyBvZiB0KXtjb25zdCB0PWgocyxlKSxuPXRbMF0uYW5nbGVUbyh0WzFdKTtpLmFkZEluUGxhY2UoKG89cyxuZXcgcihhLDEyKm8pKS5zY2FsZShuKSl9aS5ub3JtYWxpemVJblBsYWNlKCksbD8obihlLGkpLGw9ITEpOnMuc2V0U3BsaXRWZXJ0ZXhWYWx1ZXMoZSx0LGkpfX12YXIgbztyZXR1cm4gc31jb21wdXRlTnVtVHJpYW5nbGVzKCl7bGV0IHQ9MyxlPTA7Zm9yKGNvbnN0IHMgb2YgdGhpcy5fX2ZhY2VDb3VudHMpZSs9cyoodC0yKSx0Kys7cmV0dXJuIGV9Z2VuZXJhdGVUcmlhbmd1bGF0ZWRJbmRpY2VzKHQsZSxzKXtjb25zdCBhPXRoaXMuY29tcHV0ZU51bVRyaWFuZ2xlcygpO2xldCBpO2k9dDxNYXRoLnBvdygyLDgpP25ldyBVaW50OEFycmF5KDMqYSk6dDxNYXRoLnBvdygyLDE2KT9uZXcgVWludDE2QXJyYXkoMyphKTpuZXcgVWludDMyQXJyYXkoMyphKTtsZXQgcj0wO2NvbnN0IG49ZnVuY3Rpb24odCxhKXt0IGluIHMmJmEgaW4gc1t0XSYmKHQ9ZStzW3RdW2FdKSxpW3JdPXQscisrfSxoPXRoaXMuZ2V0TnVtRmFjZXMoKTtmb3IobGV0IHQ9MDt0PGg7dCsrKXtjb25zdCBlPXRoaXMuZ2V0RmFjZVZlcnRleEluZGljZXModCk7Zm9yKGxldCBzPTA7czxlLmxlbmd0aDtzKyspcz49MyYmKG4oZVswXSx0KSxuKGVbcy0xXSx0KSksbihlW3NdLHQpfXJldHVybiBpfWNvbXB1dGVIYXJkRWRnZXNJbmRpY2VzKHQ9MSl7Y29uc3QgZT1bXSxzPXQ9PntlLnB1c2godGhpcy5lZGdlVmVydHNbdF0pLGUucHVzaCh0aGlzLmVkZ2VWZXJ0c1t0KzFdKX07Zm9yKGxldCBlPTA7ZTx0aGlzLmVkZ2VGbGFncy5sZW5ndGg7ZSs9Mil0aGlzLmVkZ2VBbmdsZXNbZS8yXT50JiZzKGUpO3JldHVybiBlfWdldFdpcmVmcmFtZUluZGljZXMoKXtyZXR1cm4gaW5kaWNlc31nZW5CdWZmZXJzKHQpe2NvbnN0IGU9e307bGV0IHM9MDtmb3IoY29uc3RbLHRdb2YgdGhpcy5fX3ZlcnRleEF0dHJpYnV0ZXMpe2NvbnN0IGE9dC5nZXRTcGxpdHMoKTtmb3IoY29uc3QgdCBpbiBhKXt0IGluIGV8fChlW3RdPXt9KTtjb25zdCBpPWFbdF07Zm9yKGNvbnN0IGEgaW4gaSl7Y29uc3QgaT1wYXJzZUludChhKTtpIGluIGVbdF18fChlW3RdW2ldPXMscysrKX19fWNvbnN0IGE9dGhpcy52ZXJ0aWNlcy5sZW5ndGgsaT1hK3M7bGV0IHI7dCYmMD09dC5pbmNsdWRlSW5kaWNlc3x8KHI9dGhpcy5nZW5lcmF0ZVRyaWFuZ3VsYXRlZEluZGljZXMoaSxhLGUpKTtjb25zdCBuPXt9O2Zvcihjb25zdFt0LGFdb2YgdGhpcy5fX3ZlcnRleEF0dHJpYnV0ZXMpe2xldCBpO2k9MD09cz9hLmRhdGE6YS5nZW5lcmF0ZVNwbGl0VmFsdWVzKGUscyk7Y29uc3Qgcj1hLm51bUVsZW1lbnRzLGg9aS5sZW5ndGgvcjtuW3RdPXt2YWx1ZXM6aSxjb3VudDpoLGRpbWVuc2lvbjpyLG5vcm1hbGl6ZWQ6Im5vcm1hbHMiPT10LGRhdGFUeXBlOmEuZGF0YVR5cGV9fWNvbnN0IGg9e251bVZlcnRpY2VzOnRoaXMubnVtVmVydGljZXMoKSxudW1SZW5kZXJWZXJ0czppLGluZGljZXM6cixhdHRyQnVmZmVyczpufTtpZih0JiZ0LmluY2x1ZGVWZXJ0ZXhOZWlnaGJvcnMpe251bGw9PXRoaXMudmVydGV4RWRnZXMmJnRoaXMuZ2VuVG9wb2xvZ3lJbmZvKCk7bGV0IHQ9MDtmb3IobGV0IGU9MDtlPHRoaXMudmVydGV4RWRnZXMubGVuZ3RoO2UrKyl0aGlzLnZlcnRleEVkZ2VzW2VdJiYodCs9dGhpcy52ZXJ0ZXhFZGdlc1tlXS5zaXplKTtjb25zdCBlPW5ldyBVaW50MzJBcnJheSgyKnRoaXMudmVydGV4RWRnZXMubGVuZ3RoK3QpLHM9dD0+e2ZvcihsZXQgZT0wO2U8dC5sZW5ndGg7ZSsrKXtjb25zdCBzPXRbZV07Zm9yKGxldCBhPTA7YTxlO2ErKyl7Y29uc3QgaT10W2FdO2lmKC0xIT1zWzBdJiZzWzBdPT1pWzFdKXtlIT1hKzEmJih0LnNwbGljZShlLDEpLHQuc3BsaWNlKGErMSwwLHMpKTticmVha31pZigtMSE9c1sxXSYmc1sxXT09aVswXSl7dC5zcGxpY2UoZSwxKSx0LnNwbGljZShhLDAscyk7YnJlYWt9fX19LGE9dD0+e2lmKCEoLTEhPXRbMF1bMF0mJi0xIT10W3QubGVuZ3RoLTFdWzFdfHwtMT09dFswXVswXSYmLTE9PXRbdC5sZW5ndGgtMV1bMV0pKXRocm93IG5ldyBFcnJvcigiSWYgZmFuIHN0YXJ0cyB3aXRoIC0xLCBpdCBtdXN0IGFsc28gZW5kIHdpdGggLTEiKTtmb3IobGV0IGU9MDtlPHQubGVuZ3RoO2UrKyl7Y29uc3Qgcz10W2VdO2lmKCgtMT09c1swXXx8LTE9PXNbMV0pJiYwIT1lJiZlIT10Lmxlbmd0aC0xKXRocm93IG5ldyBFcnJvcigiLTEgb25seSBhbGxvd2VkIGF0IHRoZSBiZWdpbm5pbmcgYW5kIGVuZCBvZiBhIGZhbi4iKTtpZigtMSE9c1swXSl7bGV0IGE9ZS0xO2lmKGE8MCYmKGErPXQubGVuZ3RoKSxzWzBdIT10W2FdWzFdKXRocm93IG5ldyBFcnJvcigiRmFjZXMgYXJlIG5vdCBzZXF1ZW50aWFsIil9aWYoLTEhPXNbMV0pe2NvbnN0IGE9KGUrMSkldC5sZW5ndGg7aWYoc1sxXSE9dFthXVswXSl0aHJvdyBuZXcgRXJyb3IoIkZhY2VzIGFyZSBub3Qgc2VxdWVudGlhbCIpfX19O2xldCBpPTIqdGhpcy52ZXJ0ZXhFZGdlcy5sZW5ndGg7Zm9yKGxldCB0PTA7dDx0aGlzLnZlcnRleEVkZ2VzLmxlbmd0aDt0Kyspe2lmKG51bGw9PXRoaXMudmVydGV4RWRnZXNbdF0pY29udGludWU7Y29uc3Qgcj10aGlzLnZlcnRleEVkZ2VzW3RdLG49W107Zm9yKGNvbnN0IGUgb2Ygcil7Y29uc3Qgcz10aGlzLmVkZ2VWZXJ0c1syKmVdLGE9dGhpcy5lZGdlVmVydHNbMiplKzFdO2xldCBpLHI9dGhpcy5lZGdlRmFjZXNbMiplXSxoPXRoaXMuZWRnZUZhY2VzWzIqZSsxXTtpZihzPT10KWk9YTtlbHNle2lmKGEhPXQpdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIHRvcG9sb2d5Iik7e2k9cztjb25zdCB0PXI7cj1oLGg9dH19bi5wdXNoKFtyLGgsaV0pfXMobiksYShuKTtsZXQgaD0wOygtMSE9blswXVswXXx8LTEhPW5bbi5sZW5ndGgtMV1bMV0pJiYoaCs9MSksZVsyKnRdPWksZVsyKnQrMV09ci5zaXplKyhoPDw4KTtmb3IoY29uc3QgdCBvZiBuKWVbaV09dFsyXSxpKyt9aC52ZXJ0ZXhOZWlnaGJvcnM9ZX1yZXR1cm4gaH1mcmVlQnVmZmVycygpe3N1cGVyLmZyZWVCdWZmZXJzKCksdGhpcy5pbml0KCl9cmVhZEJpbmFyeSh0LGUpe3N1cGVyLmxvYWRCYXNlR2VvbUJpbmFyeSh0KSx0aGlzLnNldEZhY2VDb3VudHModC5sb2FkVUludDMyQXJyYXkoKSksdGhpcy5fX2ZhY2VWZXJ0ZXhDb3VudHM9dC5sb2FkVUludDhBcnJheSh0aGlzLl9fZmFjZVZlcnRleENvdW50cy5sZW5ndGgpO2NvbnN0IHM9dC5sb2FkU0ludDMyVmVjMigpLGE9dC5sb2FkVUludDgoKTtsZXQgcjsxPT1hP3I9dC5sb2FkVUludDhBcnJheSgpOjI9PWE/cj10LmxvYWRVSW50MTZBcnJheSgpOjQ9PWEmJihyPXQubG9hZFVJbnQzMkFycmF5KCkpO2NvbnN0IG49dGhpcy5nZXROdW1GYWNlcygpO2xldCBoPTAsbz0wO2ZvcihsZXQgdD0wO3Q8bjt0Kyspe2NvbnN0IGU9dGhpcy5fX2ZhY2VWZXJ0ZXhDb3VudHNbdF0rMzt0aGlzLl9fZmFjZU9mZnNldHNbdF09aDtmb3IobGV0IGE9MDthPGU7YSsrKXtjb25zdCBlPWgrYSxpPXJbZV0rcy54O2lmKDA9PXQpdGhpcy5fX2ZhY2VWZXJ0ZXhJbmRpY2VzW2VdPWk7ZWxzZXtsZXQgcz10aGlzLl9fZmFjZU9mZnNldHNbdC0xXTtzKz1hPG8/YTpvLTEsdGhpcy5fX2ZhY2VWZXJ0ZXhJbmRpY2VzW2VdPXRoaXMuX19mYWNlVmVydGV4SW5kaWNlc1tzXStpfX1oKz1lLG89ZX10aGlzLl9fbnVtUG9wdWxhdGVkRmFjZVZlcnRleEluZGljZXM9aDtjb25zdCBfPXQubG9hZFVJbnQzMigpO2lmKF8+MCl7Y29uc3QgZT10aGlzLnZlcnRpY2VzLHM9dGhpcy5hZGRWZXJ0ZXhBdHRyaWJ1dGUoImxpZ2h0bWFwQ29vcmRzIixpKTtmb3IobGV0IGE9MDthPF87YSsrKXtjb25zdCBhPW5ldyBtKHQubG9hZEZsb2F0MzJWZWMzKCksdC5sb2FkRmxvYXQzMlF1YXQoKSkscj10LmxvYWRGbG9hdDMyKCksbj10LmxvYWRGbG9hdDMyVmVjMigpLGg9dC5sb2FkU0ludDMyVmVjMigpLG89dC5sb2FkVUludDgoKTtsZXQgXztfPTE9PW8/dC5sb2FkVUludDhBcnJheSgpOjI9PW8/dC5sb2FkVUludDE2QXJyYXkoKTp0LmxvYWRVSW50MzJBcnJheSgpO2xldCBkPTA7Zm9yKGNvbnN0IHQgb2YgXyl7bGV0IG89dCtoLng7bys9ZCxkPW87Y29uc3QgXz10aGlzLmdldEZhY2VWZXJ0ZXhJbmRpY2VzKG8pO2Zvcihjb25zdCB0IG9mIF8pe2NvbnN0IGg9ZS5nZXRWYWx1ZVJlZih0KSxfPWEudHJhbnNmb3JtVmVjMyhoKSxkPW5ldyBpKF8ueCxfLnopO2Quc2NhbGVJblBsYWNlKHIpLGQuYWRkSW5QbGFjZShuKSxzLnNldEZhY2VWZXJ0ZXhWYWx1ZV9CeVZlcnRleEluZGV4KG8sdCxkKX19fX10aGlzLmhhc1ZlcnRleEF0dHJpYnV0ZSgibm9ybWFscyIpfHx0aGlzLmNvbXB1dGVWZXJ0ZXhOb3JtYWxzKCksdGhpcy5nZW9tRGF0YUNoYW5nZWQuZW1pdCgpfXRvSlNPTih0LGUpe2NvbnN0IHM9c3VwZXIudG9KU09OKHQsZSk7cmV0dXJuIDEwMjQmZXx8KHMuZmFjZUNvdW50cz1BcnJheS5mcm9tKHRoaXMuX19mYWNlQ291bnRzKSxzLmZhY2VWZXJ0ZXhJbmRpY2VzPUFycmF5LmZyb20odGhpcy5fX2ZhY2VWZXJ0ZXhJbmRpY2VzKSksc31mcm9tSlNPTih0LGUscyl7c3VwZXIuZnJvbUpTT04odCxlLHMpLHQuZmFjZUNvdW50cyYmKHRoaXMuX19mYWNlQ291bnRzPVVpbnQzMkFycmF5LmZyb20odC5mYWNlQ291bnRzKSksdC5mYWNlVmVydGV4SW5kaWNlcyYmKHRoaXMuX19mYWNlVmVydGV4SW5kaWNlcz1VaW50MzJBcnJheS5mcm9tKHQuZmFjZVZlcnRleEluZGljZXMpKX19Y2xhc3MgRXtjb25zdHJ1Y3Rvcih0LGU9MCxzPSEwKXt0aGlzLl9fZGF0YT10LHRoaXMuX19ieXRlT2Zmc2V0PWUsdGhpcy5fX2RhdGFWaWV3PW5ldyBEYXRhVmlldyh0aGlzLl9fZGF0YSksdGhpcy5fX2lzTW9iaWxlRGV2aWNlPXMsdGhpcy51dGY4ZGVjb2Rlcj1uZXcgVGV4dERlY29kZXJ9Z2V0IGlzTW9iaWxlRGV2aWNlKCl7cmV0dXJuIHRoaXMuX19pc01vYmlsZURldmljZX1nZXQgZGF0YSgpe3JldHVybiB0aGlzLl9fZGF0YX1nZXQgYnl0ZUxlbmd0aCgpe3JldHVybiB0aGlzLl9fZGF0YVZpZXcuYnl0ZUxlbmd0aH1nZXQgcmVtYWluaW5nQnl0ZUxlbmd0aCgpe3JldHVybiB0aGlzLl9fZGF0YVZpZXcuYnl0ZUxlbmd0aC10aGlzLl9fYnl0ZU9mZnNldH1wb3MoKXtyZXR1cm4gdGhpcy5fX2J5dGVPZmZzZXR9c2Vlayh0KXt0aGlzLl9fYnl0ZU9mZnNldD10fWFkdmFuY2UodCl7dGhpcy5fX2J5dGVPZmZzZXQrPXR9bG9hZFVJbnQ4KCl7Y29uc3QgdD10aGlzLl9fZGF0YVZpZXcuZ2V0VWludDgodGhpcy5fX2J5dGVPZmZzZXQpO3JldHVybiB0aGlzLl9fYnl0ZU9mZnNldCs9MSx0fWxvYWRVSW50MTYoKXtjb25zdCB0PXRoaXMuX19kYXRhVmlldy5nZXRVaW50MTYodGhpcy5fX2J5dGVPZmZzZXQsITApO3JldHVybiB0aGlzLl9fYnl0ZU9mZnNldCs9Mix0fWxvYWRVSW50MzIoKXtjb25zdCB0PXRoaXMuX19kYXRhVmlldy5nZXRVaW50MzIodGhpcy5fX2J5dGVPZmZzZXQsITApO3JldHVybiB0aGlzLl9fYnl0ZU9mZnNldCs9NCx0fWxvYWRTSW50MzIoKXtjb25zdCB0PXRoaXMuX19kYXRhVmlldy5nZXRJbnQzMih0aGlzLl9fYnl0ZU9mZnNldCwhMCk7cmV0dXJuIHRoaXMuX19ieXRlT2Zmc2V0Kz00LHR9bG9hZEZsb2F0MTYoKXtjb25zdCB0PXRoaXMubG9hZFVJbnQxNigpO3JldHVybiBNYXRoLmRlY29kZTE2Qml0RmxvYXQodCl9bG9hZFVGbG9hdDE2KCl7Y29uc3QgdD10aGlzLmxvYWRGbG9hdDE2KCk7cmV0dXJuIHQ8MD8yMDQ4LXQ6dH1sb2FkRmxvYXQxNkZyb20yeFVJbnQ4KCl7Y29uc3QgdD10aGlzLl9fZGF0YVZpZXcuZ2V0RmxvYXQxNih0aGlzLl9fYnl0ZU9mZnNldCwhMCk7cmV0dXJuIHRoaXMuX19ieXRlT2Zmc2V0Kz0yLHR9bG9hZFVJbnQzMkZyb20yeFVGbG9hdDE2KCl7cmV0dXJuIHRoaXMubG9hZFVGbG9hdDE2KCkrNDA5Nip0aGlzLmxvYWRVRmxvYXQxNigpfWxvYWRTSW50MzJGcm9tMnhGbG9hdDE2KCl7cmV0dXJuIHRoaXMubG9hZEZsb2F0MTYoKSsyMDQ4KnRoaXMubG9hZEZsb2F0MTYoKX1sb2FkRmxvYXQzMigpe2NvbnN0IHQ9dGhpcy5fX2RhdGFWaWV3LmdldEZsb2F0MzIodGhpcy5fX2J5dGVPZmZzZXQsITApO3JldHVybiB0aGlzLl9fYnl0ZU9mZnNldCs9NCx0fWxvYWRVSW50OEFycmF5KHQsZT0hMSl7bnVsbD09dCYmKHQ9dGhpcy5sb2FkVUludDMyKCkpO2NvbnN0IHM9bmV3IFVpbnQ4QXJyYXkodGhpcy5fX2RhdGEsdGhpcy5fX2J5dGVPZmZzZXQsdCk7dGhpcy5fX2J5dGVPZmZzZXQrPXQ7dGhpcy5fX2J5dGVPZmZzZXQ7cmV0dXJuIHN9bG9hZFVJbnQxNkFycmF5KHQsZT0hMSl7aWYobnVsbD09dCYmKHQ9dGhpcy5sb2FkVUludDMyKCkpLDA9PXQpcmV0dXJuIG5ldyBVaW50MTZBcnJheTtsZXQgcztpZih0aGlzLnJlYWRQYWRkKDIpLHRoaXMuX19pc01vYmlsZURldmljZSl7cz1uZXcgVWludDE2QXJyYXkodCk7Zm9yKGxldCBlPTA7ZTx0O2UrKylzW2VdPXRoaXMuX19kYXRhVmlldy5nZXRVaW50MTYodGhpcy5fX2J5dGVPZmZzZXQsITApLHRoaXMuX19ieXRlT2Zmc2V0Kz0yfWVsc2Ugcz1uZXcgVWludDE2QXJyYXkodGhpcy5fX2RhdGEsdGhpcy5fX2J5dGVPZmZzZXQsdCksdGhpcy5fX2J5dGVPZmZzZXQrPTIqdDtyZXR1cm4gc31sb2FkVUludDMyQXJyYXkodCxlPSExKXtpZihudWxsPT10JiYodD10aGlzLmxvYWRVSW50MzIoKSksMD09dClyZXR1cm4gbmV3IFVpbnQzMkFycmF5O2xldCBzO2lmKHRoaXMucmVhZFBhZGQoNCksdGhpcy5fX2lzTW9iaWxlRGV2aWNlKXtzPW5ldyBVaW50MzJBcnJheSh0KTtmb3IobGV0IGU9MDtlPHQ7ZSsrKXNbZV09dGhpcy5fX2RhdGFWaWV3LmdldFVpbnQzMih0aGlzLl9fYnl0ZU9mZnNldCwhMCksdGhpcy5fX2J5dGVPZmZzZXQrPTR9ZWxzZSBzPW5ldyBVaW50MzJBcnJheSh0aGlzLl9fZGF0YSx0aGlzLl9fYnl0ZU9mZnNldCx0KSx0aGlzLl9fYnl0ZU9mZnNldCs9NCp0O3JldHVybiBzfWxvYWRGbG9hdDMyQXJyYXkodCxlPSExKXtpZihudWxsPT10JiYodD10aGlzLmxvYWRVSW50MzIoKSksMD09dClyZXR1cm4gbmV3IEZsb2F0MzJBcnJheTtsZXQgcztpZih0aGlzLnJlYWRQYWRkKDQpLHRoaXMuX19pc01vYmlsZURldmljZSl7cz1uZXcgRmxvYXQzMkFycmF5KHQpO2ZvcihsZXQgZT0wO2U8dDtlKyspc1tlXT10aGlzLl9fZGF0YVZpZXcuZ2V0RmxvYXQzMih0aGlzLl9fYnl0ZU9mZnNldCwhMCksdGhpcy5fX2J5dGVPZmZzZXQrPTR9ZWxzZSBzPW5ldyBGbG9hdDMyQXJyYXkodGhpcy5fX2RhdGEsdGhpcy5fX2J5dGVPZmZzZXQsdCksdGhpcy5fX2J5dGVPZmZzZXQrPTQqdDtyZXR1cm4gc31sb2FkU3RyKCl7Y29uc3QgdD10aGlzLmxvYWRVSW50MzIoKSxlPW5ldyBVaW50OEFycmF5KHRoaXMuX19kYXRhLHRoaXMuX19ieXRlT2Zmc2V0LHQpO3JldHVybiB0aGlzLl9fYnl0ZU9mZnNldCs9dCx0aGlzLnV0ZjhkZWNvZGVyLmRlY29kZShlKX1sb2FkU3RyQXJyYXkoKXtjb25zdCB0PXRoaXMubG9hZFVJbnQzMigpLGU9W107Zm9yKGxldCBzPTA7czx0O3MrKyllW3NdPXRoaXMubG9hZFN0cigpO3JldHVybiBlfWxvYWRTSW50MzJWZWMyKCl7Y29uc3QgdD10aGlzLmxvYWRTSW50MzIoKSxlPXRoaXMubG9hZFNJbnQzMigpO3JldHVybiBuZXcgaSh0LGUpfWxvYWRVSW50MzJWZWMyKCl7Y29uc3QgdD10aGlzLmxvYWRVSW50MzIoKSxlPXRoaXMubG9hZFVJbnQzMigpO3JldHVybiBuZXcgaSh0LGUpfWxvYWRGbG9hdDE2VmVjMigpe2NvbnN0IHQ9dGhpcy5sb2FkRmxvYXQxNigpLGU9dGhpcy5sb2FkRmxvYXQxNigpO3JldHVybiBuZXcgaSh0LGUpfWxvYWRGbG9hdDMyVmVjMigpe2NvbnN0IHQ9dGhpcy5sb2FkRmxvYXQzMigpLGU9dGhpcy5sb2FkRmxvYXQzMigpO3JldHVybiBuZXcgaSh0LGUpfWxvYWRGbG9hdDE2VmVjMygpe2NvbnN0IHQ9dGhpcy5sb2FkRmxvYXQxNigpLGU9dGhpcy5sb2FkRmxvYXQxNigpLHM9dGhpcy5sb2FkRmxvYXQxNigpO3JldHVybiBuZXcgcih0LGUscyl9bG9hZEZsb2F0MzJWZWMzKCl7Y29uc3QgdD10aGlzLmxvYWRGbG9hdDMyKCksZT10aGlzLmxvYWRGbG9hdDMyKCkscz10aGlzLmxvYWRGbG9hdDMyKCk7cmV0dXJuIG5ldyByKHQsZSxzKX1sb2FkRmxvYXQxNlF1YXQoKXtjb25zdCB0PXRoaXMubG9hZEZsb2F0MTYoKSxlPXRoaXMubG9hZEZsb2F0MTYoKSxzPXRoaXMubG9hZEZsb2F0MTYoKSxhPXRoaXMubG9hZEZsb2F0MTYoKTtyZXR1cm4gbmV3IHUodCxlLHMsYSl9bG9hZEZsb2F0MzJRdWF0KCl7Y29uc3QgdD10aGlzLmxvYWRGbG9hdDMyKCksZT10aGlzLmxvYWRGbG9hdDMyKCkscz10aGlzLmxvYWRGbG9hdDMyKCksYT10aGlzLmxvYWRGbG9hdDMyKCk7cmV0dXJuIG5ldyB1KHQsZSxzLGEpfWxvYWRSR0JGbG9hdDMyQ29sb3IoKXtjb25zdCB0PXRoaXMubG9hZEZsb2F0MzIoKSxlPXRoaXMubG9hZEZsb2F0MzIoKSxzPXRoaXMubG9hZEZsb2F0MzIoKTtyZXR1cm4gbmV3IG8odCxlLHMpfWxvYWRSR0JBRmxvYXQzMkNvbG9yKCl7Y29uc3QgdD10aGlzLmxvYWRGbG9hdDMyKCksZT10aGlzLmxvYWRGbG9hdDMyKCkscz10aGlzLmxvYWRGbG9hdDMyKCksYT10aGlzLmxvYWRGbG9hdDMyKCk7cmV0dXJuIG5ldyBvKHQsZSxzLGEpfWxvYWRSR0JVSW50OENvbG9yKCl7Y29uc3QgdD10aGlzLmxvYWRVSW50OCgpLGU9dGhpcy5sb2FkVUludDgoKSxzPXRoaXMubG9hZFVJbnQ4KCk7cmV0dXJuIG5ldyBvKHQvMjU1LGUvMjU1LHMvMjU1KX1sb2FkUkdCQVVJbnQ4Q29sb3IoKXtjb25zdCB0PXRoaXMubG9hZFVJbnQ4KCksZT10aGlzLmxvYWRVSW50OCgpLHM9dGhpcy5sb2FkVUludDgoKSxhPXRoaXMubG9hZFVJbnQ4KCk7cmV0dXJuIG5ldyBvKHQvMjU1LGUvMjU1LHMvMjU1LGEvMjU1KX1sb2FkQm94Migpe3JldHVybiBuZXcgZyh0aGlzLmxvYWRGbG9hdDMyVmVjMigpLHRoaXMubG9hZEZsb2F0MzJWZWMyKCkpfWxvYWRCb3gzKCl7cmV0dXJuIG5ldyBwKHRoaXMubG9hZEZsb2F0MzJWZWMzKCksdGhpcy5sb2FkRmxvYXQzMlZlYzMoKSl9cmVhZFBhZGQodCl7Y29uc3QgZT10aGlzLl9fYnl0ZU9mZnNldCV0OzAhPWUmJih0aGlzLl9fYnl0ZU9mZnNldCs9dC1lKX19Y2xhc3Mgdntjb25zdHJ1Y3Rvcih0KXtpZih0KXtjb25zdCBlPXQuc3BsaXQoIi0iKSxzPWVbMF0uc3BsaXQoIi4iKTt0aGlzLm1ham9yPXBhcnNlSW50KHNbMF0pLHRoaXMubWlub3I9cGFyc2VJbnQoc1sxXSksdGhpcy5wYXRjaD1wYXJzZUludChzWzJdKSwyPT1lLmxlbmd0aCYmKHRoaXMuYnJhbmNoPWVbMV0pfWVsc2UgdGhpcy5tYWpvcj0wLHRoaXMubWlub3I9MCx0aGlzLnBhdGNoPTB9ZXF1YWxzKHQpe3JldHVybiEodGhpcy5wYXRjaD09dFsyXSYmdGhpcy5taW5vcj09dFsxXSYmdGhpcy5tYWpvcj09dFswXSl9bGVzc1RoYW4odCl7cmV0dXJuISh0aGlzLm1ham9yPj10WzBdfHx0aGlzLm1pbm9yPj10WzFdfHx0aGlzLnBhdGNoPj10WzJdKX1ncmVhdGVyVGhhbih0KXtyZXR1cm4gdGhpcy5tYWpvcj50WzBdfHx0aGlzLm1pbm9yPnRbMV18fHRoaXMucGF0Y2g+dFsyXX1ncmVhdGVyT3JFcXVhbFRoYW4odCl7cmV0dXJuISh0aGlzLm1ham9yPHRbMF0pJiYodGhpcy5tYWpvcj50WzBdfHwhKHRoaXMubWlub3I8dFsxXSkmJih0aGlzLm1pbm9yPnRbMV18fCEodGhpcy5wYXRjaDx0WzJdKSkpfX1zZWxmLm9ubWVzc2FnZT1mdW5jdGlvbih0KXsoKHQsZSk9Pntmb3IobGV0IGUgaW4gdC5jb250ZXh0LnZlcnNpb25zKXtjb25zdCBzPXQuY29udGV4dC52ZXJzaW9uc1tlXSxhPW5ldyB2O2EubWFqb3I9cy5tYWpvcixhLm1pbm9yPXMubWlub3IsYS5wYXRjaD1zLnBhdGNoLGEuYnJhbmNoPXMuYnJhbmNoLHQuY29udGV4dC52ZXJzaW9uc1tlXT1hfWNvbnN0IHM9W10saT10LnRvY1t0Lmdlb21zUmFuZ2VbMF1dLHI9W107Zm9yKGxldCBlPXQuZ2VvbXNSYW5nZVswXTtlPHQuZ2VvbXNSYW5nZVsxXTtlKyspe2NvbnN0IG49bmV3IEUodC5idWZmZXJTbGljZSx0LnRvY1tlXS1pLHQuaXNNb2JpbGVEZXZpY2UpLGg9bi5sb2FkU3RyKCksbz1uLnBvcygpO2xldCBfO3N3aXRjaChoKXtjYXNlIlBvaW50cyI6Xz1uZXcgQTticmVhaztjYXNlIkxpbmVzIjpfPW5ldyBTO2JyZWFrO2Nhc2UiTWVzaCI6Xz1uZXcgUDticmVhaztkZWZhdWx0OnRocm93IG5ldyBFcnJvcigiVW5zdXBwb3J0ZWQgR2VvbSB0eXBlOiIraCl9dHJ5e24uc2VlayhvKSxfLnJlYWRCaW5hcnkobix0LmNvbnRleHQpfWNhdGNoKHQpe2NvbnNvbGUud2FybigiRXJyb3IgbG9hZGluZzoiK18ubmFtZSsiXG46Iit0KSxzLnB1c2goe30pO2NvbnRpbnVlfWNvbnN0IGQ9Xy5nZW5CdWZmZXJzKHQuZ2VuQnVmZmVyc09wdHMpO2QuaW5kaWNlcyYmci5wdXNoKGQuaW5kaWNlcy5idWZmZXIpO2Zvcihjb25zdCB0IGluIGQuYXR0ckJ1ZmZlcnMpe2NvbnN0IGU9ZC5hdHRyQnVmZmVyc1t0XSxzPWEuZ2V0VHlwZU5hbWUoZS5kYXRhVHlwZSk7ZS5kYXRhVHlwZT1zLHIucHVzaChlLnZhbHVlcy5idWZmZXIpfWQudmVydGV4TmVpZ2hib3JzJiZyLnB1c2goZC52ZXJ0ZXhOZWlnaGJvcnMuYnVmZmVyKSxyLnB1c2goXy5ib3VuZGluZ0JveC5wMC5fX2RhdGEuYnVmZmVyKSxyLnB1c2goXy5ib3VuZGluZ0JveC5wMS5fX2RhdGEuYnVmZmVyKSxzLnB1c2goe25hbWU6Xy5uYW1lLHR5cGU6aCxnZW9tQnVmZmVyczpkLGJib3g6Xy5ib3VuZGluZ0JveH0pfWUoe2tleTp0LmtleSxnZW9tSW5kZXhPZmZzZXQ6dC5nZW9tSW5kZXhPZmZzZXQsZ2VvbXNSYW5nZTp0Lmdlb21zUmFuZ2UsZ2VvbURhdGFzOnN9LHIpfSkodC5kYXRhLCh0LGUpPT57c2VsZi5wb3N0TWVzc2FnZSh0LGUpfSl9OwoK",null,!1);class oa{constructor(){this.rangeLoaded=new S,this.streamFileParsed=new S,this.loaded=new S(!0),this.__streamInfos={},this.__genBuffersOpts={},this.__workers=[],this.__nextWorker=0;for(let e=0;e<3;e++)this.__workers.push(this.__constructWorker());this.clear();}clear(){this.__loaded=0,this.__numGeoms=0,this.geoms=[];}__constructWorker(){const e=new ra;return e.onmessage=e=>{this.__recieveGeomDatas(e.data.key,e.data.geomDatas,e.data.geomIndexOffset,e.data.geomsRange);},e}__terminateWorkers(){for(const e of this.__workers)e.terminate();this.__workers=[];}setGenBufferOption(e,t){this.__genBuffersOpts[e]=t;}setNumGeoms(e){this.__numGeoms=e;}getGeom(e){return e>=this.geoms.length?null:this.geoms[e]}loadUrl(e){ee(e,e=>{this.loadBin(e);},e=>{console.warn(e);});}readBinaryBuffer(e,a,i){const s=t.isMobileDevice,n=new de(a,0,s),l=n.loadUInt32(),r=n.loadUInt32();if(this.__streamInfos[e]={total:l,done:0},0==l)return this.streamFileParsed.emit(1),l;0==this.__numGeoms&&(this.__numGeoms=l);const o=n.loadUInt32Array(l);let d=window.navigator.hardwareConcurrency;d||(d=s?2:4);const h=Math.max(1,Math.floor(l/d+1));let c=0;for(;c<l;){const t=o[c];let s,d;c+h>=l?(d=[c,l],s=a.byteLength):(d=[c,c+h],s=o[d[1]]);const m=a.slice(t,s);c+=h,this.__workers[this.__nextWorker].postMessage({key:e,toc:o,geomIndexOffset:r,geomsRange:d,isMobileDevice:n.isMobileDevice,bufferSlice:m,genBuffersOpts:this.__genBuffersOpts,context:i},[m]),this.__nextWorker=(this.__nextWorker+1)%this.__workers.length;}return l}__recieveGeomDatas(e,t,a,i){const s=a+i[0],n=[s,a+i[1]];for(let e=0;e<t.length;e++){const a=t[e];if(!a.type)continue;let i;switch(a.type){case"Points":i=new Ct(a);break;case"Lines":i=new Yt(a);break;case"Mesh":case"Plane":case"Sphere":case"Cone":i=new Nt(a);break;default:throw new Error("Unsupported Geom type:"+className)}this.geoms[s+e]=i;}this.rangeLoaded.emit(n);const l=n[1]-n[0],r=this.__streamInfos[e];r.done+=l,r.done==r.total&&this.streamFileParsed.emit(1),this.__loaded+=l,this.__loaded==this.__numGeoms&&(this.__terminateWorkers(),this.loaded.emit());}toJSON(){return {numGeoms:this.geoms.length()}}toString(){return JSON.stringify(this.toJSON(),null,2)}}class da extends $t{constructor(e){super(e),this.__geomLibrary=new oa,this.__materials=new xt,this.loaded=new S(!0),this.loaded.setToggled(!0);}isLoaded(){return this.loaded.isToggled()}getEngineDataVersion(){return this.__engineDataVersion}getGeometryLibrary(){return this.__geomLibrary}getMaterialLibrary(){return this.__materials}getUnitsConversion(){return this.__unitsScale}readBinary(e,t={}){let a;t.assetItem=this,t.numTreeItems=0,t.numGeomItems=0,t.versions["zea-engine"]||(t.versions["zea-engine"]=new oe(e.loadStr())),this.__engineDataVersion=t.versions["zea-engine"],console.log("Loading Engine File version:",t.versions["zea-engine"]);const i={};t.addGeomToLayer=(e,t)=>{if(!i[t]){a||(a=new $t("Layers"),this.addChild(a,!1));const e=new la(t);e.propagateXfoToItems=!1,a.addChild(e,!1),i[t]=e;}i[t].addItem(e);};const s=()=>{this.__units=e.loadStr();let t=1;switch(this.__units){case"Millimeters":t=.001;break;case"Centimeters":t=.01;break;case"Meters":t=1;break;case"Kilometers":t=1e3;break;case"Inches":t=.0254;break;case"Feet":t=.3048;break;case"Miles":t=1609.34;}this.__unitsScale=t;const a=this.getLocalXfo().clone();a.sc.scaleInPlace(t),this.setLocalXfo(a);};t.versions["zea-engine"].greaterThan([0,0,6])&&s(),this.__materials.readBinary(e,t),super.readBinary(e,t),t.versions["zea-engine"].greaterOrEqualThan([0,0,5])&&t.versions["zea-engine"].lessThan([0,0,7])&&s();}toJSON(e={},t=0){return e.makeRelative=e=>{const t=this.getPath(),a=e.slice(0,t.length);for(let i=0;i<a.length-1;i++)if(a[i]!=t[i])return console.warn("Param Path is not relative to the asset. May not be able to be resolved at load time:"+e),e;const i=e.slice(t.length-1);return i[0]=".",i},e.assetItem=this,super.toJSON(e,t)}fromJSON(e,t={},a=0,i){t||(t={}),t.assetItem=this,t.numTreeItems=0,t.numGeomItems=0,null==t.version&&(t.version=0),t.assetItem=this;const s=[];t.resolvePath=(e,t)=>{if(!e)throw new Error("Path not spcecified");const a=this.resolvePath(e);a?t(a):s.push(()=>{const a=this.resolvePath(e);a?t(a):console.warn("Path unable to be resolved:"+e);});},t.addPLCB=e=>s.push(e),super.fromJSON(e,t,a);for(const e of s)e();i&&i();}}C.registerClass("AssetItem",da);class ha extends $t{constructor(e,t){super(e);const a=this.addParameter(new Ve("image"));t&&a.setValue(t),this.addParameter(new ue("scale",.01)),this.addParameter(new ue("alpha",1)),this.addParameter(new Ge("color",new u(1,1,1))),this.addParameter(new pe("alignedToCamera",!1));const i=this.addParameter(new _e("lineStartOffset")),s=this.addParameter(new Se("lineEnd",d)),n=[],l=new Ke("LabelLinesMaterial","LinesShader");l.getParameter("Color").setValue(new u(0,0,0),N.OPERATOR_SETVALUE),l.getParameter("Opacity").setValue(1,N.OPERATOR_SETVALUE),s.elementAdded.connect((e,t)=>{const a=new Mt;a.setNumVertices(2),a.setNumSegments(1),a.setSegment(0,0,1);const i=new sa("line"+t);i.setGeometry(a,N.OPERATOR_SETVALUE),i.setMaterial(l,N.OPERATOR_SETVALUE),n[t]=i,r(t),this.addChild(i,!1);}),s.elementRemoved.connect(()=>{});const r=e=>{const t=this.__globalXfoParam.getValue().inverse(),a=i.getValue(),l=s.getValue()[e],r=n[e].getGeometry();r.setVertex(0,a),r.setVertex(1,t.transformVec3(l));},o=()=>{for(let e=0;e<n.length;e++)r(e);};i.valueChanged.connect(o),s.valueChanged.connect(o),this.__globalXfoParam.valueChanged.connect(o);}toJSON(e,t){return super.toJSON(e,t)}fromJSON(e,t,a){return super.fromJSON(e,t,a)}}C.registerClass("BillboardItem",ha);class ca extends $t{constructor(e){null==e&&(e="Camera"),super(e),this.__isOrthographicParam=this.addParameter(new pe("isOrthographic",!1)),this.__fovParam=this.addParameter(new ue("fov",1)),this.__nearParam=this.addParameter(new ue("near",.1)),this.__farParam=this.addParameter(new ue("far",1e3)),this.__focalDistanceParam=this.addParameter(new ue("focalDistance",5)),this.projectionParamChanged=new S,this.movementFinished=new S,this.__isOrthographicParam.valueChanged.connect(this.projectionParamChanged.emit),this.__fovParam.valueChanged.connect(this.projectionParamChanged.emit),this.__nearParam.valueChanged.connect(this.projectionParamChanged.emit),this.__farParam.valueChanged.connect(this.projectionParamChanged.emit),this.setPositionAndTarget(new d(3,3,1.75),new d(0,0,1),N.GENERATED_VALUE),this.setLensFocalLength("28mm",N.GENERATED_VALUE);}getNear(){return this.__nearParam.getValue()}setNear(e){this.__nearParam.setValue(e);}getFar(){return this.__farParam.getValue()}setFar(e){this.__farParam.setValue(e);}getFov(){return this.__fovParam.getValue()}setFov(e){this.__fovParam.setValue(e);}setLensFocalLength(e,t=N.USER_SETVALUE){const a={"10mm":100.4,"11mm":95,"12mm":90,"14mm":81.2,"15mm":77.3,"17mm":70.4,"18mm":67.4,"19mm":64.6,"20mm":61.9,"24mm":53.1,"28mm":46.4,"30mm":43.6,"35mm":37.8,"45mm":29.9,"50mm":27,"55mm":24.6,"60mm":22.6,"70mm":19.5,"75mm":18.2,"80mm":17.1,"85mm":16.1,"90mm":15.2,"100mm":13.7,"105mm":13,"120mm":11.4,"125mm":11,"135mm":10.2,"150mm":9.1,"170mm":8.1,"180mm":7.6,"210mm":6.5,"300mm":4.6,"400mm":3.4,"500mm":2.7,"600mm":2.3,"800mm":1.7};!e in a?console.warn("Camera lense focal length not suported:"+e):this.__fovParam.setValue(Math.degToRad(a[e]),t);}getFocalDistance(){return this.__focalDistanceParam.getValue()}setFocalDistance(e,t=N.USER_SETVALUE){e<1e-4&&console.error("Never set focal distance to zero"),this.__focalDistanceParam.setValue(e,t),this.__nearParam.setValue(.01*e,t),this.__farParam.setValue(200*e,t);}getIsOrthographic(){return this.__isOrthographicParam.getValue()}setIsOrthographic(e,t=N.USER_SETVALUE){this.__isOrthographicParam.setValue(e,t);}setPositionAndTarget(e,t,a=N.USER_SETVALUE){this.setFocalDistance(e.distanceTo(t),a);const i=new X;i.setLookAt(e,t,new d(0,0,1)),this.setGlobalXfo(i,a);}getTargetPostion(){const e=this.__focalDistanceParam.getValue(),t=this.getGlobalXfo(),a=t.ori.getZaxis();return a.scaleInPlace(-e),a.addInPlace(t.tr),a}frameView(e,t,a=N.USER_SETVALUE){const i=new V;for(const e of t)i.addBox3(e.getBoundingBox());if(!i.isValid())return void console.warn("Bounding box not valid.");const s=this.__focalDistanceParam.getValue(),n=this.__fovParam.getValue(),l=this.getGlobalXfo().clone(),r=l.ori.getZaxis(),o=r.scale(-s),d=l.tr.add(o),h=i.center().subtract(d);l.tr.addInPlace(h);const c=new V;c.addBox3(i,l.inverse());c.center();const m=n*(e.getWidth()/e.getHeight()),u=c.p1,b=Math.abs(u.x)/Math.tan(.5*m)*1.2,p=Math.abs(u.y)/Math.tan(.5*n)*1.2,g=-.5*(c.p0.z-c.p1.z),_=Math.max(b,p)+g,Z=_-s;l.tr.addInPlace(r.scale(Z)),this.setFocalDistance(_,a),this.setGlobalXfo(l,a),this.movementFinished.emit();}updateProjectionMatrix(e,t){this.__isOrthographicParam.getValue();const a=this.__fovParam.getValue(),i=this.__nearParam.getValue(),s=this.__farParam.getValue();e.setPerspectiveMatrix(a,t,i,s);}}C.registerClass("Camera",ca);class ma extends D{constructor(e){super(e),this.addParameter(new Ge("BackgroundColor",new u("#808080"))),this.addParameter(new Ve("EnvMap")),this.addParameter(new pe("Display EnvMap",!1)),this.addParameter(new ue("EnvMapLOD",0));}}class ua extends da{constructor(e){super(e),this.loaded.setToggled(!1),this.lightmap=null,this.geomsLoaded=new S(!0),this.geomsLoaded.setToggled(!1),this.loaded.setToggled(!1),this.__geomLibrary.loaded.connect(()=>{this.geomsLoaded.emit();}),this.__datafileParam=this.addParameter(new Re("DataFilePath")),this.__datafileParam.valueChanged.connect(()=>{const e=this.__datafileParam.getFileDesc();if(e){if(console.log(e),this.getName()==C.getClassName(this)){const e=this.__datafileParam.getStem();this.setName(e);}this.geomsLoaded.setToggled(!1),this.loadDataFile(()=>{this.loaded.isToggled()||this.loaded.emit();},()=>{});}}),this.addParameter(new Ge("LightmapTint",new u(1,1,1,1)));}getLightmap(){return this.lightmap}readBinary(e,t){if(-1!=t.version){const e=new oe;e.patch=t.version,t.versions={"zea-mesh":e,"zea-engine":e},t.meshSdk="FBX";}else {const a=e.loadUInt8();if(e.seek(0),10!=a){const a=new oe;a.patch=e.loadUInt32(),t.versions={"zea-mesh":a,"zea-engine":a},t.meshSdk="FBX";}else {const a=new oe(e.loadStr());t.versions={"zea-mesh":a},t.meshSdk="FBX";}}this.meshfileversion=t.versions["zea-mesh"],this.meshSdk=t.meshSdk,console.log("Loading CAD File version:",t.versions["zea-mesh"]," exported using SDK:",t.meshSdk);const a=e.loadUInt32();return super.readBinary(e,t),t.versions["zea-engine"].lessThan([0,0,5])&&e.seek(e.byteLength-4),this.__geomLibrary.setNumGeoms(e.loadUInt32()),a}loadDataFile(e,a){const i=this.__datafileParam.getFileDesc();if(!i)return void console.warn("VLAAsset data file not found.");const s=this.__datafileParam.getFileFolderPath(),n=this.__datafileParam.getValue(),l=this.__datafileParam.getStem();let r=0;const o=new RegExp("\\.(vla)$","i").test(i.name),d=[],h=i=>{let s,l=-1;if(i.tree2)s=new de(i.tree2.buffer,0,t.isMobileDevice);else {const e=i.tree?i.tree:i[Object.keys(i)[0]];s=new de(e.buffer,0,t.isMobileDevice),l=0;}r=this.readBinary(s,{assetItem:this,version:l}),o||r!=d.length&&console.error("The number of GeomFiles does not match the count given by the VLA file."),e(),0==r&&i.geoms0?(re.addWork(n+"geoms",1),this.__geomLibrary.readBinaryBuffer(n,i.geoms0.buffer,{version:l}),a()):(re.addWork(n+"geoms",4*r),c());},c=()=>{const e=[];for(let t=0;t<r;t++)if(o){const a=s+l+t+".vlageoms",i=re.resolveFilepath(a);if(!i)throw new Error("VLA Geoms file not found:"+a);e.push(m(t,i.url));}else e.push(m(t,d[t].url));Promise.all(e).then(()=>{a&&a();});},m=(e,t)=>new Promise(a=>{re.loadUrl(n+e,t,e=>{const t=e[Object.keys(e)[0]];this.__geomLibrary.readBinaryBuffer(n,t.buffer),a();},!1);});if(o)re.loadResource(n,h);else if(i.metadata.ConvertFile){let e;i.metadata.ConvertFile.map(t=>{t.filename.endsWith(".vla")?e=t:t.filename.endsWith(".vlageoms")&&d.push(t);}),e?re.loadUrl(n,e.url,h):console.warn("ConvertFile metadata contains no vla file.");}this.__geomLibrary.streamFileParsed.connect(e=>{re.addWorkDone(n+"geoms",e);});}fromJSON(e,t,a){t||(t={}),t.assetItem=this;const i=()=>{super.fromJSON(e,t,a),a&&a();};if(e.params&&e.params.DataFilePath){this.__datafileLoaded=i;const a=e.params.DataFilePath;delete e.params.DataFilePath,this.__datafileParam.fromJSON(a,t);}else i();}}C.registerClass("VLAAsset",ua);const ba=new u("#DCDCDC");class pa{constructor(e){e&&re.setResources(e),this.settings=new ma("Scene Settings"),this.root=new $t("root"),this.root.addChild(this.settings),this.__commonResources={};}getSettings(){return this.settings}getRoot(){return this.root}getResourceLoader(){return re}setEnvMap(e){console.warn("Deprecated Function. Please access the Scene Settings object."),this.settings.getParameter("EnvMap").setValue(e);}addAsset(e){console.warn("Deprecated Function. Please access the Scene Root object."),this.root.addChild(e,!1);}setupGrid(e=5,t=50,a=ba){const i=new $t("Grid"),s=new Ke("gridMaterial","LinesShader");s.getParameter("BaseColor").setValue(a);const n=new Pt(e,e,t,t,!0);i.addChild(new sa("GridItem",n,s),!1);const l=new Mt;l.setNumVertices(2),l.setNumSegments(1),l.setSegment(0,0,1),l.getVertex(0).set(-.5*e,0,0),l.getVertex(1).set(.5*e,0,0);const r=new Ke("gridXAxisMaterial","LinesShader");r.getParameter("BaseColor").setValue(new u(a.luminance(),0,0)),i.addChild(new sa("xAxisLine",l,r),!1);const o=new Ke("gridZAxisMaterial","LinesShader");o.getParameter("BaseColor").setValue(new u(0,a.luminance(),0));const h=new X;h.ori.setFromAxisAndAngle(new d(0,0,1),.5*Math.PI);const c=new sa("yAxisLine",l,o);return c.setGeomOffsetXfo(h),i.addChild(c,!1),i.setSelectable(!1,!0),i.setFlag(k.IGNORE_BBOX),i.clearFlag(k.USER_EDITED),i.setFlag(k.INVISIBLE),this.root.addChild(i,!1),i}loadCommonAssetResource(e){if(e in this.__commonResources)return this.__commonResources[e];const t=new ua;return t.getParameter("DataFilePath").setValue(e),this.__commonResources[e]=t,t}toJSON(e={},t=0){return e.makeRelative=e=>e,{root:this.root.toJSON(e,t)}}fromJSON(e,t={}){const a=[];t.resolvePath=(e,t)=>{if(!e)throw new Error("Path not spcecified");const i=this.root.resolvePath(e);i?t(i):a.push(()=>{const a=this.resolvePath(e);a?t(a):console.warn("Path unable to be resolved:"+e);});},t.addPLCB=e=>a.push(e),t.settings=this.settings,e.root&&this.root.fromJSON(e.root,t);for(const e of a)e();}}class ga extends da{constructor(e){super(e),this.geomsLoaded=new S(!0),this.geomsLoaded.setToggled(!1),this.loaded.setToggled(!1),this.addParameter(new pe("splitObjects",!1)),this.addParameter(new pe("splitGroupsIntoObjects",!1)),this.addParameter(new pe("loadMtlFile",!0)),this.addParameter(new ue("unitsConversion",1)),this.addParameter(new xe("defaultShader","")),this.objfileParam=this.addParameter(new Re("ObjFilePath")),this.objfileParam.valueChanged.connect(()=>{this.loaded.untoggle(),this.__loadObj(()=>{this.loaded.emit();},()=>{this.geomsLoaded.emit();});}),this.geomLibrary=new oa,this.materials=new xt;}getGeometryLibrary(){return this.geomLibrary}getMaterialLibrary(){return this.materials}__loadObj(e,t){const a=this.objfileParam.getStem(),i=e=>{const t=e.split("\n"),a=/\s+/;let i;const s=function(e){if(3==e.length)return new u(parseFloat(e[0]),parseFloat(e[1]),parseFloat(e[2]));throw new Error("Unable to parse a color from the following parts:"+e.join("_"))},n=e=>{const t=this.objfileParam.getFileFolder();return new FileImage(e[0],t+e[0])};for(let e=0;e<t.length;e++){let l=t[e].trim();if(l.startsWith("#"))continue;-1!=l.indexOf("#")&&(l=l.substring(0,l.indexOf("#")).trim());const r=l.split(a),o=r.shift(),d=r.join(" ");switch(o){case"newmtl":i=new Ke(d),i.setShaderName("StandardSurfaceShader"),this.materials.addMaterial(i);break;case"Kd":i.getParameter("BaseColor").setValue(s(r));break;case"map_Kd":i.getParameter("BaseColor").setValue(n(r));break;case"Ks":const e=(parseFloat(r[0])+parseFloat(r[1])+parseFloat(r[2]))/3;i.roughness=1-e,i.getParameter("Roughness").setValue(1-e),i.getParameter("Reflectance").setValue(e);break;case"map_Ks":i.getParameter("Roughness").setValue(n(r)),i.getParameter("Reflectance").setValue(.2);break;case"d":const t=parseFloat(d);t<1&&(i.setShaderName("TransparentSurfaceShader"),i.getParameter("Opacity").setValue(t));break;case"map_d":i.getParameter("alpha").setValue(parseFloat(r));break;case"map_bump":i.getParameter("normal").setValue(n(r));}}},s=new L;s.incAsyncCount(),s.ready.connect(()=>{b();});const n=e=>new Promise(t=>{A(e.url,e=>{re.addWorkDone(a,1),i(e),s.decAsyncCount(),re.addWorkDone(a,1),t();});}),l=new Array,r=new Array,h=new Array,c={},m=async e=>{const t=e.split("\n"),i=/\s+/;let o=void 0,d=void 0;const m=e=>{let t=0;for(;e in c;)t++,e+=String(t);o={verticesRemapping:{},texCoordsRemapping:{},normalsRemapping:{},vertexIndices:[],texCoordIndices:[],normalIndices:[],numVertices:0,numTexCoords:0,numNormals:0,numTris:0,numQuads:0,material:d},c[e]=o;};m(a);const u=this.getParameter("splitGroupsIntoObjects").getValue();for(let e=0;e<t.length;e++){let b=t[e].trim();if(b.startsWith("#"))continue;-1!=b.indexOf("#")&&(b=b.substring(0,b.indexOf("#")).trim());const p=b.split(i),g=p.shift(),_=p.join(" ");switch(g){case"":case"s":continue;case"mtllib":if(!this.getParameter("loadMtlFile").getValue())continue;s.incAsyncCount(),re.addWork(a,2);const e=this.objfileParam.getFileFolderPath(),t=re.resolveFilepath(e+_);t&&await n(t);break;case"o":m(_);break;case"usemtl":d=_,m(_+Object.keys(c).length);break;case"g":u&&m(p.join("_"));break;case"v":l.push(p.map(e=>parseFloat(e)));break;case"vt":h.push(p.map(e=>parseFloat(e)));break;case"vn":r.push(p.map(e=>parseFloat(e)));break;case"f":{const e=[],t=[],a=[];for(let i=0,s=p.length;i<s;i++){const s=p[i].split("/").map(e=>parseInt(e)-1),n=s[0];let l=o.verticesRemapping[n];if(null==l&&(l=o.numVertices,o.verticesRemapping[n]=l,o.numVertices++),e.push(l),s.length>1&&!isNaN(s[1])){const e=s[1];t.push(e);}if(s.length>2&&!isNaN(s[2])){const e=s[2];a.push(e);}}o.vertexIndices.push(e),a.length>0&&o.normalIndices.push(a),t.length>0&&o.texCoordIndices.push(t),3==e.length?o.numTris++:o.numQuads++;break}default:console.warn("Unhandled line:"+b);}}s.decAsyncCount();},b=()=>{for(const e in c)0!=c[e].numVertices&&p(e,c[e]);e(),t();},p=(e,t)=>{const a=t.numVertices,i=new Ft(e);i.setFaceCounts([t.numTris,t.numQuads]),i.setNumVertices(a);const s=i.getVertexAttribute("positions"),n=this.getParameter("unitsConversion").getValue();for(const e in t.verticesRemapping){const a=t.verticesRemapping[e];s.getValueRef(a).set(l[e][0]*n,l[e][1]*n,l[e][2]*n);}let c,m;t.normalIndices.length>0&&(c=i.addVertexAttribute("normals",d)),t.texCoordIndices.length>0&&(m=i.addVertexAttribute("texCoords",o));for(let e=0;e<t.vertexIndices.length;e++){const a=t.vertexIndices[e];if(i.setFaceVertexIndices(e,...a),c){const a=t.normalIndices[e];for(let t=0;t<a.length;t++){const i=new d(r[a[t]][0],r[a[t]][1],r[a[t]][2]);c.setFaceVertexValue(e,t,i);}}if(m&&t.texCoordIndices.length==t.vertexIndices.length){const a=t.texCoordIndices[e];for(let t=0;t<a.length;t++){const i=new o(h[a[t]][0],h[a[t]][1]);m.setFaceVertexValue(e,t,i);}}}const b=new sa(e,i);b.selectable=!0;const p=i.boundingBox.center();if(i.moveVertices(p.negate()),b.setLocalXfo(new X(p)),null!=t.material&&this.materials.hasMaterial(t.material))b.setMaterial(this.materials.getMaterial(t.material));else {const t=this.getParameter("defaultShader").getValue(),a=new Ke(e+"mat");a.setShaderName(""!=t?t:"StandardSurfaceShader");const i=a.getParameter("BaseColor");if(i)i.setValue(u.random(.5));else {const e=a.getParameter("Color");e&&e.setValue(u.random(.5));}const s=a.getParameter("Roughness");s&&s.setValue(.6);const n=a.getParameter("Reflectance");n&&n.setValue(.2),this.materials.addMaterial(a),b.setMaterial(a);}this.addChild(b,!1);};(()=>{const e=this.objfileParam.getFileDesc(),t=this.objfileParam.getStem();re.addWork(t,2),A(e.url,e=>{re.addWorkDone(t,1),m(e),re.addWorkDone(t,1);});})();}}class _a extends D{constructor(e){super(e),this.setFlag(k.USER_EDITED),this.__outputs=[],this.__evalOutput=this.__evalOutput.bind(this),this.postEval=new S;}setDirty(){for(const e of this.__outputs)e.setDirtyFromOp();}__parameterValueChanged(e,t){this.setDirty();}addOutput(e){return this.__outputs.push(e),e.paramSet.connect(e=>{e.bindOperator(this);}),e}removeOutput(e){e.getParam()&&e.getParam().unbindOperator(this),this.__outputs.splice(this.__outputs.indexOf(e),1);}getNumOutputs(){return this.__outputs.length}getOutputByIndex(e){return this.__outputs[e]}getOutput(e){for(const t of this.__outputs)if(t.getName()==e)return t}__evalOutput(e){for(const e of this.__outputs)e.removeCleanerFn(this.__evalOutput);this.evaluate();}__opInputChanged(){this.setDirty();}evaluate(){throw new Error("Not yet implemented")}toJSON(e,t){const a=super.toJSON(e,t);a.type=C.getClassName(this);const i=[];for(const a of this.__outputs)i.push(a.toJSON(e,t));return a.outputs=i,a}fromJSON(e,t,a){if(super.fromJSON(e,t,a),e.outputs){for(let a=0;a<this.__outputs.length;a++){this.__outputs[a].fromJSON(e.outputs[a],t);}t.addPLCB(()=>{this.__opInputChanged();});}}detach(){this.__outputs.forEach(e=>e.detach());}reattach(){this.__outputs.forEach(e=>e.reattach());}destroy(){super.destroy(),this.__outputs=[];}}class Za{constructor(e,t){this.__name=e,this.__filterFn=t,this._param=void 0,this.detached=!1,this.paramSet=new S;}getName(){return this.__name}getFilterFn(){return this.__filterFn}isConnected(){return null!=this._param}getParam(){return this._param}setParam(e){this._param=e,this.paramSet.emit();}getValue(e=Y.OPERATOR_GETVALUE){if(this._param)return this._param.getValue(e)}setValue(e,t=N.OPERATOR_SETVALUE){this._param&&this._param.setValue(e,t);}setClean(e){this._param&&this._param.setClean(e);}setDirty(e){this._param&&this._param.setDirty(e);}setDirtyFromOp(){this._param&&this._param.setDirtyFromOp();}removeCleanerFn(e){this._param&&this._param.removeCleanerFn(e);}toJSON(e,t){const a=this._param?this._param.getPath():"";return {type:this.constructor.name,paramPath:e&&e.makeRelative?e.makeRelative(a):a}}fromJSON(e,t,a){e.paramPath&&t.resolvePath(e.paramPath,e=>{this.setParam(e);},t=>{console.warn("Operator Output: '"+this.getName()+"'. Unable to load item:"+e.paramPath);});}detach(){this.detached=!0;}reattach(){this.detached=!1;}}C.registerClass("OperatorOutput",Za);class Ga extends Za{constructor(e){super(e,e=>"Xfo"==e.getDataType());}getInitialValue(){return this._initialParamValue}setParam(e){(()=>{if(this._initialParamValue=e.getValue(),this._initialParamValue.clone&&(this._initialParamValue=this._initialParamValue.clone()),null==this._initialParamValue)throw new Error("WTF?")})(),this._param=e,this.paramSet.emit(e);}}C.registerClass("XfoOperatorOutput",Ga);class Xa extends _a{constructor(e){super(e),this.addParameter(new fe("ParentGlobal")),this.addParameter(new fe("LocalXfo")),this.addOutput(new Ga("GlobalXfo"));}evaluate(){const e=this.getParameter("ParentGlobal").getValue(),t=this.getParameter("LocalXfo").getValue();this.getOutputByIndex(0).setClean(e.multiply(t));}}C.registerClass("CalcGlobalXfoOperator",Xa);class ya extends We{constructor(e){super(e),this.__stageParam=this._addMember(new ue("Stage",0)),this.__axisParam=this._addMember(new _e("Axis",new d(1,0,0))),this.__movementParam=this._addMember(new ge("MovementTiming",new o(0,1),[new o(0,0),new o(1,1)])),this.__multiplierParam=this._addMember(new ue("Multiplier",1)),this.__output=new Ga("Part");}getStage(e=N.USER_GETVALUE){return this.__stageParam.getValue(e)}setStage(e,t=N.USER_SETVALUE){this.__stageParam.setValue(e,t);}getOutput(){return this.__output}evaluate(e,t,a,i,s,n,l,r){if(!this.__output.isConnected())return;const o=this.__stageParam.getValue(),d=this.__movementParam.getValue();let h;if(s){let a=o/i;n&&(a-=.5),h=t*Math.linStep(d.x,d.y,Math.max(0,e-a));}else {let a=1-o/i;n&&(a-=.5),h=t*Math.linStep(d.x,d.y,e)*a;}h+=a;let c=this.__axisParam.getValue();const m=this.__multiplierParam.getValue(),u=this.__output.getInitialValue();let b;l?(b=r.multiply(u),c=l.ori.rotateVec3(c),b.tr.addInPlace(c.scale(h*m))):(b=this.__output.getValue(),b.tr=u.tr.add(c.scale(h*m))),this.__output.setClean(b);}toJSON(e,t){const a=super.toJSON(e,t);return a&&(a.output=this.__output.toJSON(e,t)),a}fromJSON(e,t,a){super.fromJSON(e,t,a),e.output&&this.__output.fromJSON(e.output,t);}}class fa extends _a{constructor(e){super(e),this.__stagesParam=this.addParameter(new ue("Stages",0)),this._explodeParam=this.addParameter(new ue("Explode",0,[0,1])),this._distParam=this.addParameter(new ue("Dist",1)),this._offsetParam=this.addParameter(new ue("Offset",0)),this._cascadeParam=this.addParameter(new pe("Cascade",!1)),this._centeredParam=this.addParameter(new pe("Centered",!1)),this.__parentItemParam=this.addParameter(new Le("RelativeTo")),this.__parentItemParam.valueChanged.connect(()=>{const e=this.__parentItemParam.getValue();this.__invParentSpace=e?e.getGlobalXfo().inverse():void 0;}),this.__parentItemParam.treeItemGlobalXfoChanged.connect(()=>{this.setDirty();}),this.__itemsParam=this.addParameter(new Se("Parts",ya)),this.__itemsParam.elementAdded.connect((e,t)=>{if(t>0){const a=this.__itemsParam.getElement(t-1).getStage();e.setStage(a+1),this.__stagesParam.setClean(a+2);}else this.__stagesParam.setClean(1);this.addOutput(e.getOutput()),this.setDirty();}),this.__itemsParam.elementRemoved.connect((e,t)=>{this.removeOutput(e.getOutput());}),this.__localXfos=[],this.__parts=[],this.__stages=2;}evaluate(){const e=this.__stagesParam.getValue(),t=this._explodeParam.getValue(),a=this._distParam.getValue(),i=this._offsetParam.getValue(),s=this._cascadeParam.getValue(),n=this._centeredParam.getValue(),l=this.__parentItemParam.getValue();let r,o;l&&(r=l.getGlobalXfo(),o=this.__invParentSpace.multiply(r));const d=this.__itemsParam.getValue();for(let l=0;l<d.length;l++){d[l].evaluate(t,a,i,e,s,n,r,o);}}toJSON(e,t){return super.toJSON(e,t)}fromJSON(e,t,a){super.fromJSON(e,t,a);}destroy(){clearTimeout(this.__timeoutId),super.destroy();}}C.registerClass("ExplodePartsOperator",fa);class Va extends We{constructor(e){super(e),this.__ratioParam=this._addMember(new ue("Ratio",1)),this.__offsetParam=this._addMember(new ue("Offset",0)),this.__axisParam=this._addMember(new _e("Axis",new d(1,0,0))),this.__output=new Ga("Gear");}getOutput(){return this.__output}getRatio(){return this.__ratioParam.getValue()}getOffset(){return this.__offsetParam.getValue()}getAxis(){return this.__axisParam.getValue()}toJSON(e,t){const a=super.toJSON(e,t);return a&&(a.output=this.__output.toJSON(e,t)),a}fromJSON(e,t,a){super.fromJSON(e,t,a),e.output&&this.__output.fromJSON(e.output,t);}}class xa extends _a{constructor(e){super(e),this.__revolutionsParam=this.addParameter(new ue("Revolutions",0));const t=this.addParameter(new ue("RPM",0));t.valueChanged.connect(()=>{const e=t.getValue();if(Math.abs(e)>0){if(!this.__timeoutId){const e=()=>{const a=t.getValue(),i=this.__revolutionsParam.getValue();this.__revolutionsParam.setValue(i+a*(1/3e3)),this.__timeoutId=setTimeout(e,20);};e();}}else clearTimeout(this.__timeoutId),this.__timeoutId=void 0;}),this.__gearsParam=this.addParameter(new Se("Gears",Va)),this.__gearsParam.elementAdded.connect((e,t)=>{this.addOutput(e.getOutput());}),this.__gearsParam.elementRemoved.connect((e,t)=>{this.removeOutput(t);}),this.__gears=[];}evaluate(){const e=this.__revolutionsParam.getValue(),t=this.__gearsParam.getValue();for(const a of t){const t=a.getOutput(),i=t.getInitialValue();if(!i)return;const s=e*a.getRatio()+a.getOffset(),n=new Z;n.setFromAxisAndAngle(a.getAxis(),s*Math.PI*2);const l=t.getValue();l.ori=n.multiply(i.ori),t.setClean(l);}}detach(){super.detach(),this.__timeoutId&&(clearTimeout(this.__timeoutId),this.__timeoutId=null);}reattach(){super.reattach(),this.getParameter("RPM").valueChanged.emit();}destroy(){this.__timeoutId&&(clearTimeout(this.__timeoutId),this.__timeoutId=null),super.destroy();}}C.registerClass("GearsOperator",xa);class Ia extends We{constructor(){super("Piston"),this.__pistonAngleParam=this._addMember(new ue("PistonAngle",0)),this.__camPhaseParam=this._addMember(new ue("CamPhase",0)),this.__camLengthParam=this._addMember(new ue("CamLength",3)),this.__rodLengthParam=this._addMember(new ue("RodLength",3)),this.__rodoutput=new Ga("Rod"),this.__capoutput=new Ga("Cap"),this.__pistonAngleParam.valueChanged.connect(this.init.bind(this)),this.__camPhaseParam.valueChanged.connect(this.init.bind(this)),this.__camLengthParam.valueChanged.connect(this.init.bind(this)),this.__rodLengthParam.valueChanged.connect(this.init.bind(this)),this.__bindXfos={};}getRodOutput(){return this.__rodoutput}getCapOutput(){return this.__capoutput}setCrankXfo(e){this.__baseCrankXfo=e,this.init();}init(){if(!this.__baseCrankXfo)return;const e=this.__camPhaseParam.getValue(),t=this.__camLengthParam.getValue(),a=this.__rodLengthParam.getValue(),i=this.__pistonAngleParam.getValue(),s=new d(Math.sin(Math.degToRad(i)),Math.cos(Math.degToRad(i)),0);this.__pistonAxis=this.__baseCrankXfo.ori.rotateVec3(s),this.__camVec=this.__baseCrankXfo.ori.rotateVec3(new d(Math.sin(2*e*Math.PI)*t,Math.cos(2*e*Math.PI)*t,0));const n=2*e*Math.PI,l=Math.sin(n)*t,r=Math.sqrt(a*a-l*l)+Math.cos(n)*t;this.__pistonOffset=r;}evaluate(e,t,a){const i=this.__camPhaseParam.getValue(),s=this.__camLengthParam.getValue(),n=this.__rodLengthParam.getValue(),l=2*(i+a)*Math.PI,r=Math.sin(l)*s,o=Math.asin(r/n),d=Math.sqrt(n*n-r*r)+Math.cos(l)*s;if(this.__rodoutput.isConnected()){const a=this.__rodoutput.getInitialValue().clone(),i=this.__rodoutput.getValue(),s=i.tr.subtract(this.__baseCrankXfo.tr).dot(t),n=new Z;n.setFromAxisAndAngle(t,-o),i.tr=this.__baseCrankXfo.tr.add(e.rotateVec3(this.__camVec)),i.tr.addInPlace(t.scale(s)),i.ori=n.multiply(a.ori),this.__rodoutput.setValue(i);}if(this.__capoutput.isConnected()){const e=this.__capoutput.getInitialValue().clone(),t=this.__capoutput.getValue();t.tr=e.tr.add(this.__pistonAxis.scale(d-this.__pistonOffset)),this.__capoutput.setValue(t);}}setOwner(e){this.__owner=e;}getOwner(){return this.__owner}toJSON(e,t){return super.toJSON(e,t)}fromJSON(e,t,a){super.fromJSON(e,t,a);}clone(e){return new Ia(this.__name,this.__value)}}class Ra extends _a{constructor(e){super(e),this.__revolutionsParam=this.addParameter(new ue("Revolutions",0,[0,1]));const t=this.addParameter(new ue("RPM",0));t.valueChanged.connect(()=>{let e=t.getValue();if(e>0){if(!this.__timeoutId){const a=()=>{e=t.getValue();const i=this.__revolutionsParam.getValue();this.__revolutionsParam.setValue(i+e*(1/3e3)),this.__timeoutId=setTimeout(a,20);};a();}}else clearTimeout(this.__timeoutId),this.__timeoutId=void 0;}),this.__crankOutput=this.addOutput(new Ga("Crank")),this.__crankOutput.paramSet.connect(this.init.bind(this)),this.__crankAxisParam=this.addParameter(new _e("CrankAxis",new d(1,0,0))),this.__crankAxisParam.valueChanged.connect(()=>{this.__baseCrankXfo.ori.setFromDirectionAndUpvector(this.__crankAxisParam.getValue(),new d(0,0,1)),this.init();}),this.__pistonsParam=this.addParameter(new Se("Pistons",Ia)),this.__pistonsParam.elementAdded.connect(e=>{e.setCrankXfo(this.__baseCrankXfo),this.addOutput(e.getRodOutput()),this.addOutput(e.getCapOutput());}),this.__pistonsParam.elementRemoved.connect(e=>{this.removeOutput(e.getRodOutput()),this.removeOutput(e.getCapOutput());}),this.__baseCrankXfo=new X,this.__pistons=[];}setOwner(e){super.setOwner(e);}getCrankOutput(){return this.__crankOutput}init(){const e=this.__pistonsParam.getValue();for(const t of e)t.setCrankXfo(this.__baseCrankXfo);this.__crankOutput.isConnected()&&(this.__crankOffset=this.__baseCrankXfo.inverse().multiply(this.__crankOutput.getInitialValue()));}evaluate(){const e=this.__revolutionsParam.getValue(Y.OPERATOR_GETVALUE),t=this.__crankAxisParam.getValue(Y.OPERATOR_GETVALUE),a=new Z;if(a.setFromAxisAndAngle(t,e*Math.PI*2),this.__crankOutput.isConnected()){const e=this.__crankOutput.getValue();e.ori=a.multiply(this.__crankOutput.getInitialValue().ori),this.__crankOutput.setValue(e);}const i=this.__pistonsParam.getValue(),s=i.length;for(let n=0;n<s;n++){i[n].evaluate(a,t,e);}this.postEval.emit(e);}toJSON(e,t){return super.toJSON(e,t)}fromJSON(e,t,a){super.fromJSON(e,t,a),e.crankOutput&&this.__crankOutput.fromJSON(e.crankOutput,t),this.init();}destroy(){clearTimeout(this.__timeoutId),super.destroy();}}C.registerClass("PistonOperator",Ra);class Sa extends _a{constructor(e){super(e),this.__inputParam=this.addParameter(new ue("Input")),this.__routesParam=this.addParameter(new Se("Routes",ue)),this.__routesParam.elementAdded.connect(e=>{e.setValue(1),this.addOutput(new Za("Output"));}),this.__routesParam.elementRemoved.connect((e,t)=>{this.removeOutput(this.getOutputByIndex(t));});}evaluate(){const e=this.__inputParam.getValue(Y.OPERATOR_GETVALUE),t=this.__routesParam.getValue();let a=this.__outputs.length;for(;a--;){this.__outputs[a].setValue(e*t[a].getValue(Y.OPERATOR_GETVALUE));}this.postEval.emit(e);}toJSON(e,t){return super.toJSON(e,t)}fromJSON(e,t,a){super.fromJSON(e,t,a);}destroy(){super.destroy();}}C.registerClass("RouterOperator",Sa);class Wa extends _a{constructor(e){super(e),this.addParameter(new ue("Weight",1)),this.addParameter(new be("Axis",0,["+X Axis","-X Axis","+Y Axis","-Y Axis","+Z Axis","-Z Axis"])),this.addParameter(new ue("Stretch",0)),this.addParameter(new ue("Initial Dist",1)),this.addParameter(new fe("Target")),this.addOutput(new Ga("InputOutput"));}resetStretchRefDist(){const e=this.getParameter("Target").getValue(),t=this.getOutputByIndex(0).getValue(),a=e.tr.subtract(t.tr).length();this.getParameter("Initial Dist").setValue(a);}evaluate(){const e=this.getParameter("Weight").getValue(),t=this.getParameter("Target").getValue(),a=this.getParameter("Axis").getValue(),i=this.getOutputByIndex(0),s=i.getValue(),n=t.tr.subtract(s.tr),l=n.length();if(l<1e-6)return;let r;switch(n.scaleInPlace(1/l),a){case 0:r=s.ori.getXaxis();break;case 1:r=s.ori.getXaxis().negate();break;case 2:r=s.ori.getYaxis();break;case 3:r=s.ori.getYaxis().negate();break;case 4:r=s.ori.getZaxis();break;case 5:r=s.ori.getZaxis().negate();}let o=new Z;o.setFrom2Vectors(r,n),o.alignWith(new Z),e<1&&(o=(new Z).lerp(o,e)),s.ori=o.multiply(s.ori);const d=this.getParameter("Stretch").getValue();if(d>0){const e=1+(l/this.getParameter("Initial Dist").getValue()-1)*d;switch(a){case 0:case 1:s.sc.x=e;break;case 2:case 3:s.sc.y=e;break;case 4:case 5:s.sc.z=e;}}i.setClean(s);}}C.registerClass("AimOperator",Wa);class La extends H{constructor(e){null==e&&(e="Camera"),super(e),this.__defaultManipulationState="orbit",this.__manipulationState=this.__defaultManipulationState,this.__mouseDown=!1,this.__dragging=!1,this.__mouseDragDelta=new o,this.__keyboardMovement=!1,this.__keysPressed=[],this.__maxVel=.002,this.__velocity=new d,this.__ongoingTouches={},this.__orbitRateParam=this.addParameter(new ue("orbitRate",t.isMobileDevice?-.3:1)),this.__dollySpeedParam=this.addParameter(new ue("dollySpeed",.02)),this.__mouseWheelDollySpeedParam=this.addParameter(new ue("mouseWheelDollySpeed",5e-4)),this.movementFinished=new S;}setDefaultManipulationMode(e){this.__defaultManipulationState=e;}look(e,t){const{viewport:a}=e,i=a.getCamera(),s=i.getFocalDistance(),n=this.__orbitRateParam.getValue();if(this.__keyboardMovement){const e=i.getGlobalXfo();this.__mouseDownCameraXfo=e.clone(),this.__mouseDownZaxis=e.ori.getZaxis();const t=this.__mouseDownZaxis.scale(-s);this.__mouseDownCameraTarget=e.tr.add(t);}const l=this.__mouseDownCameraXfo.clone(),r=new Z;r.rotateZ(t.x/a.getWidth()*Math.PI*n),l.ori=r.multiply(l.ori);const o=new Z;o.rotateX(t.y/a.getHeight()*Math.PI*n),l.ori.multiplyInPlace(o),i.setGlobalXfo(l);}orbit(e,t){const{viewport:a}=e,i=a.getCamera(),s=i.getFocalDistance(),n=this.__orbitRateParam.getValue();if(this.__keyboardMovement){const e=i.getGlobalXfo();this.__mouseDownCameraXfo=e.clone(),this.__mouseDownZaxis=e.ori.getZaxis();const t=this.__mouseDownZaxis.scale(-s);this.__mouseDownCameraTarget=e.tr.add(t);}const l=this.__mouseDownCameraXfo.clone(),r=new Z;r.rotateZ(t.x/a.getWidth()*2*Math.PI*-n),l.ori=r.multiply(l.ori);const o=new Z;o.rotateX(t.y/a.getHeight()*Math.PI*-n),l.ori.multiplyInPlace(o),l.tr=this.__mouseDownCameraTarget.add(l.ori.getZaxis().scale(s)),i.setGlobalXfo(l);}pan(e,t){const{viewport:a}=e,i=a.getCamera(),s=i.getFocalDistance(),n=i.getFov(),l=new d(1,0,0),r=new d(0,1,0),o=2*s*Math.tan(.5*n),h=o*(a.getWidth()/a.getHeight()),c=new X;c.tr=l.scale(-t.x/a.getWidth()*h),c.tr.addInPlace(r.scale(t.y/a.getHeight()*o)),i.setGlobalXfo(this.__mouseDownCameraXfo.multiply(c));}dolly(e,t){const{viewport:a}=e,i=a.getCamera(),s=t.x*this.__dollySpeedParam.getValue(),n=new X;n.tr.set(0,0,s),i.setGlobalXfo(this.__mouseDownCameraXfo.multiply(n));}panAndZoom(e,t,a){const{viewport:i}=e,s=i.getCamera(),n=s.getFocalDistance(),l=s.getFov(),r=new d(1,0,0),o=new d(0,1,0),h=2*n*Math.tan(.5*l),c=h*(i.getWidth()/i.getHeight()),m=new X;m.tr=r.scale(-t.x/i.getWidth()*c),m.tr.addInPlace(o.scale(t.y/i.getHeight()*h));const u=a*n;s.setFocalDistance(this.__mouseDownFocalDist+u),m.tr.z+=u,s.setGlobalXfo(this.__mouseDownCameraXfo.multiply(m));}initDrag(e){const{viewport:t}=e,a=t.getCamera(),i=a.getFocalDistance();this.__mouseDown=!0,this.__calculatingDragAction=!1,this.__mouseDownPos=e.mousePos,this.__mouseDownViewport=t,this.__mouseDragDelta.set(0,0),this.__mouseDownCameraXfo=a.getGlobalXfo().clone(),this.__mouseDownZaxis=this.__mouseDownCameraXfo.ori.getZaxis();const s=this.__mouseDownZaxis.scale(-i);this.__mouseDownCameraTarget=a.getGlobalXfo().tr.add(s),this.__mouseDownFocalDist=i,this.__dragListenerId=a.getParameter("GlobalXfo").valueChanged.connect(this.__globalXfoChangedDuringDrag.bind(this));}__globalXfoChangedDuringDrag(e){if(!this.__calculatingDragAction){this.__mouseDownViewport.getCamera().getParameter("GlobalXfo").valueChanged.disconnectId(this.__dragListenerId),this.initDrag({viewport:this.__mouseDownViewport,mousePos:this.__mouseDownPos});}}endDrag(e){if(this.__dragListenerId){const{viewport:t}=e;t.getCamera().getParameter("GlobalXfo").valueChanged.disconnectId(this.__dragListenerId),this.__dragListenerId=null;}this.__mouseDown=!1,this.__dragging=!1;}aimFocus(e,t){const{viewport:a}=e,i=a.getCamera();this.__focusIntervalId&&clearInterval(this.__focusIntervalId);let s=0;const n=()=>{const e=i.getGlobalXfo(),a=i.getFocalDistance(),l=t.subtract(e.tr),r=l.normalizeInPlace(),o=new Z,d=new Z;{const t=e.ori.getZaxis().clone();t.z=0;const a=l.negate();a.z=0,o.setFrom2Vectors(t,a);}{const t=e.ori.getZaxis().clone(),a=l.negate();t.x=a.x,t.y=a.y,t.normalizeInPlace(),t.cross(a).dot(e.ori.getXaxis())>0?d.rotateX(t.angleTo(a)):d.rotateX(-t.angleTo(a));}const h=e.clone();h.ori=o.multiply(h.ori),h.ori.multiplyInPlace(d);const c=Math.pow(s/20,2),m=e.clone();m.ori=e.ori.lerp(h.ori,c),i.setFocalDistance(a+(r-a)*c),i.setGlobalXfo(m),s++,s<=20?this.__focusIntervalId=setTimeout(n,20):(this.__focusIntervalId=void 0,this.movementFinished.emit());};n(),this.__manipulationState="focussing";}onMouseMove(e){}onDoubleClick(e){if(e.intersectionData){const t=e.viewport.getCamera().getGlobalXfo().tr.add(e.mouseRay.dir.scale(e.intersectionData.dist));this.aimFocus(e,t);}}onMouseDown(e){this.initDrag(e),2==e.button?this.__manipulationState="pan":e.ctrlKey&&e.altKey?this.__manipulationState="dolly":e.ctrlKey||2==e.button?this.__manipulationState="look":this.__manipulationState=this.__defaultManipulationState;}onMouseMove(e){if(!this.__mouseDown)return;const t=e.mousePos;switch(this.__calculatingDragAction=!0,this.__keyboardMovement?this.__mouseDragDelta=t:this.__mouseDragDelta=t.subtract(this.__mouseDownPos),this.__manipulationState){case"orbit":this.orbit(e,this.__mouseDragDelta);break;case"look":this.look(e,this.__mouseDragDelta);break;case"pan":this.pan(e,this.__mouseDragDelta);break;case"dolly":this.dolly(e,this.__mouseDragDelta);}this.__dragging=!0,this.__calculatingDragAction=!1,e.stopPropagation();}onMouseUp(e){this.__dragging&&(this.movementFinished.emit(),e.stopPropagation()),this.endDrag(e);}onWheel(e){const{viewport:t}=e,a=t.getCamera(),i=this.__mouseWheelDollySpeedParam.getValue(),s=e.shiftKey?.1:.5,n=a.getGlobalXfo(),l=n.ori.getZaxis();this.__mouseWheelZoomIntervalId&&clearInterval(this.__mouseWheelZoomIntervalId);let r=0;const o=()=>{const t=a.getFocalDistance(),d=e.deltaY*i*t*s;n.tr.addInPlace(l.scale(d)),"orbit"==this.__defaultManipulationState&&a.setFocalDistance(a.getFocalDistance()+d),a.setGlobalXfo(n),r++,r<10?this.__mouseWheelZoomIntervalId=setTimeout(o,10):(this.__mouseWheelZoomIntervalId=void 0,this.movementFinished.emit());};o();}__integrateVelocityChange(e){const{viewport:t}=e,a=t.getCamera(),i=new X;i.tr=this.__velocity.normalize().scale(this.__maxVel),a.setGlobalXfo(a.getGlobalXfo().multiply(i));}onKeyPressed(e,t){return !1}onKeyDown(e,t){}onKeyUp(e,t){}__startTouch(e){this.__ongoingTouches[e.identifier]={identifier:e.identifier,pos:new o(e.pageX,e.pageY)};}__endTouch(e){delete this.__ongoingTouches[e.identifier];}onTouchStart(e){console.log("onTouchStart"),e.preventDefault(),e.stopPropagation(),0==Object.keys(this.__ongoingTouches).length&&(this.__manipMode=void 0);const t=e.changedTouches;for(let e=0;e<t.length;e++)this.__startTouch(t[e]);1==Object.keys(this.__ongoingTouches).length&&(this.initDrag(e),this.__dragging=!0);}onTouchMove(e){e.preventDefault(),e.stopPropagation(),this.__calculatingDragAction=!0;const t=e.touches;if(1==t.length&&"panAndZoom"!=this.__manipMode){const a=t[0],i=new o(a.pageX,a.pageY),s=this.__ongoingTouches[a.identifier].pos.subtract(i);"look"==this.__defaultManipulationState?(s.scaleInPlace(6),this.look(e,s)):this.orbit(e,s);}else if(2==t.length){const a=t[0],i=this.__ongoingTouches[a.identifier],s=t[1],n=this.__ongoingTouches[s.identifier],l=new o(a.pageX,a.pageY),r=new o(s.pageX,s.pageY),d=n.pos.subtract(i.pos).length()-r.subtract(l).length(),h=l.subtract(i.pos),c=r.subtract(n.pos),m=h.add(c);m.scaleInPlace(.5),this.panAndZoom(e,m,.002*d),this.__manipMode="panAndZoom";}this.__calculatingDragAction=!1;}onTouchEnd(e){e.preventDefault(),e.stopPropagation();const t=e.changedTouches;for(let e=0;e<t.length;e++)this.__endTouch(t[e]);0==Object.keys(this.__ongoingTouches).length&&this.endDrag(e);}onTouchCancel(e){e.preventDefault();const t=e.touches;for(let e=0;e<t.length;e++)this.__endTouch(t[e]);0==Object.keys(this.__ongoingTouches).length&&this.endDrag(e);}onDoubleTap(e){if(e.intersectionData){const{viewport:t}=e,a=t.getCamera().getGlobalXfo().tr.add(e.touchRay.dir.scale(e.intersectionData.dist));this.aimFocus(e,a);}e.preventDefault();}}var va=Object.freeze({__proto__:null,RefCounted:T,ParameterOwner:H,ItemFlags:k,BaseItem:D,getFileFolder:O,loadTextfile:A,loadJSONfile:q,loadXMLfile:$,loadBinfile:ee,sgFactory:C,isObject:ne,mergeDeep:le,resourceLoader:re,Version:oe,BinReader:de,BinWriter:he,Command:me,ParamFlags:K,ValueGetMode:Y,ValueSetMode:N,BaseParameter:J,Parameter:P,MultiChoiceParameter:be,BooleanParameter:pe,NumberParameter:ue,Vec2Parameter:ge,Vec3Parameter:_e,Vec4Parameter:Ze,ColorParameter:Ge,Mat3Parameter:Xe,Mat4Parameter:ye,XfoParameter:fe,ImageParameter:Ve,StringParameter:xe,CodeParameter:Ie,FilePathParameter:Re,ListParameter:Se,StructParameter:We,TreeItemParameter:Le,ItemSetParameter:ve,ProxyParameter:Me,GeometryParameter:Fe,MaterialParameter:Rt,MaterialFloatParam:Ce,MaterialColorParam:Ye,Attribute:St,BaseGeom:Wt,SAVE_FLAG_SKIP_GEOMDATA:1024,VertexAttribute:Lt,Points:vt,Lines:Mt,Mesh:Ft,PointsProxy:Ct,LinesProxy:Yt,MeshProxy:Nt,PointGrid:Kt,Rect:wt,Circle:zt,Cross:Ut,LinesCuboid:Jt,Grid:Pt,Cone:Et,Cuboid:Ht,Cylinder:kt,Disc:Bt,Plane:Dt,Sphere:Ot,Torus:Qt,DataImage:we,FileImage:it,FileImage2D:st,LDRImage:lt,LDRVideo:rt,GIFImage:ot,EnvMap:Zt,Lightmap:Gt,LightmapMixer:Xt,Label:ft,VideoStreamImage2D:Vt,labelManager:yt,SaveFlags:At,LoadFlags:jt,CloneFlags:qt,TreeItem:$t,InstanceItem:ea,AudioItem:ta,FileAudioItem:aa,BaseGeomItem:ia,GeomItem:sa,AssetItem:da,BillboardItem:ha,Camera:ca,Group:la,GeomLibrary:oa,Material:Ke,BaseImage:Te,MaterialLibrary:xt,materialLibraryManager:It,Scene:pa,VLAAsset:ua,ObjAsset:ga,Operator:_a,OperatorOutput:Za,XfoOperatorOutput:Ga,CalcGlobalXfoOperator:Xa,ExplodePartsOperator:fa,GearsOperator:xa,PistonOperator:Ra,RouterOperator:Sa,AimOperator:Wa,CameraMouseAndKeyboard:La});const Ma=function(e,a){console.log(t);let i=null;if(null!=a.webglContextType)try{i=e.getContext(a.webglContextType,a),i.name=a.webglContextType;}catch(e){}else {["webgl2","webgl"].some(t=>{try{i=e.getContext(t,a),i.name=t;}catch(e){}if(i)return !0});}if(i)return i.sizeInBytes=function(e){switch(e){case this.BYTE:case this.UNSIGNED_BYTE:return 1;case this.SHORT:case this.UNSIGNED_SHORT:return 2;case this.INT:case this.UNSIGNED_INT:case this.FLOAT:return 4;default:throw new Error("unknown type")}},"webgl2"==i.name?(i.floatTexturesSupported=!0,i.__ext_float_linear=i.getExtension("OES_texture_float_linear"),i.__ext_texture_half_float_linear=i.getExtension("OES_texture_half_float_linear"),i.__ext_color_buffer_float=i.getExtension("EXT_color_buffer_float")):(i.__ext_float=i.getExtension("OES_texture_float"),i.__ext_float?(i.floatTexturesSupported=!0,i.__ext_float_linear=i.getExtension("OES_texture_float_linear")):console.warn("OES_texture_float is not available"),i.__ext_half_float=i.getExtension("OES_texture_half_float"),i.__ext_half_float&&(i.HALF_FLOAT=i.__ext_half_float.HALF_FLOAT_OES,i.floatTexturesSupported=!0,i.__ext_texture_half_float_linear=i.getExtension("OES_texture_half_float_linear")),i.__ext_color_buffer_float=i.getExtension("EXT_color_buffer_float"),i.__ext_std_derivatives=i.getExtension("OES_standard_derivatives"),i.__ext_Inst=i.getExtension("ANGLE_instanced_arrays"),i.__ext_Inst&&(i.vertexAttribDivisor=i.__ext_Inst.vertexAttribDivisorANGLE.bind(i.__ext_Inst),i.drawArraysInstanced=i.__ext_Inst.drawArraysInstancedANGLE.bind(i.__ext_Inst),i.drawElementsInstanced=i.__ext_Inst.drawElementsInstancedANGLE.bind(i.__ext_Inst)),i.__ext_VAO=i.getExtension("OES_vertex_array_object"),i.__ext_VAO&&(i.createVertexArray=i.__ext_VAO.createVertexArrayOES.bind(i.__ext_VAO),i.deleteVertexArray=i.__ext_VAO.deleteVertexArrayOES.bind(i.__ext_VAO),i.bindVertexArray=i.__ext_VAO.bindVertexArrayOES.bind(i.__ext_VAO)),i.__ext_element_index_uint=i.getExtension("OES_element_index_uint"),i.__ext_WEBGL_depth_texture=i.getExtension("WEBGL_depth_texture"),i.__ext_WEBGL_depth_texture&&(i.UNSIGNED_INT_24_8=i.__ext_WEBGL_depth_texture.UNSIGNED_INT_24_8_WEBGL),i.DRAW_FRAMEBUFFER=i.FRAMEBUFFER),i.__ext_frag_depth=i.getExtension("EXT_frag_depth"),i.setupInstancedQuad=function(){const e=new Float32Array([0,1,2,3]),t=new Uint16Array([0,1,2,2,1,3]);this.__quadVertexIdsBuffer=this.createBuffer(),this.bindBuffer(this.ARRAY_BUFFER,this.__quadVertexIdsBuffer),this.bufferData(this.ARRAY_BUFFER,e,this.STATIC_DRAW),this.__quadIndexBuffer=this.createBuffer(),this.bindBuffer(this.ELEMENT_ARRAY_BUFFER,this.__quadIndexBuffer),this.bufferData(this.ELEMENT_ARRAY_BUFFER,t,this.STATIC_DRAW),this.__quadattrbuffers={vertexIDs:{buffer:this.__quadVertexIdsBuffer,dataType:6,dimension:1,count:e.length,shared:!0}};},i.drawQuad=function(){this.drawElements(this.TRIANGLES,6,this.UNSIGNED_SHORT,0);},i.setupLineSegAttrBuffers=function(){const e=new Float32Array([0,1]),t=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,t),i.bufferData(i.ARRAY_BUFFER,e,i.STATIC_DRAW),i.__linesegattrbuffers={vertexIDs:{buffer:t,dimension:1,count:e.length,shared:!0}};},i};class Fa extends T{constructor(e,t){if(super(),this.__gl=e,this.ready=new S(!0),this.updated=new S,this.resized=new S,this.width=0,this.height=0,this.textureType=1,this.textureDesc=[0,0,0,0],this.__loaded=!1,this.__bound=!1,null!=t)if(t instanceof Te){this.__texture=t,this.__texture.setMetadata("gltexture",this);const e=()=>{const e=this.__texture.getParams(),t=e.width,a=e.height,i=e.data;this.bufferData(i,t,a);};this.__texture.isLoaded()?(this.configure(this.__texture.getParams()),this.__texture.updated.connect(e)):this.__texture.loaded.connect(()=>{this.configure(this.__texture.getParams()),this.__texture.updated.connect(e);});}else this.configure(t);}isLoaded(){return this.__loaded}getTexture(){return this.__texture}getInternalFormat(){return this.__internalFormat}getType(){return this.__typeParam}getTypeID(){return this.__type}getFormat(){return this.__formatParam}getFormatID(){return this.__format}getFilter(){return this.__filterParam}getWrap(){return this.__wrapParam}getMipMapped(){return this.__mipMapped}configure(e,t=!0){if(!("type"in e&&"format"in e&&"width"in e&&"height"in e))throw new Error("Invalid texture params");const a=this.__gl,i=e.width,s=e.height,n=e.data,l=a.getParameter(a.MAX_TEXTURE_SIZE);if(i<=0||i>l||s<=0||s>l)throw new Error("gl-texture2d: Invalid texture size. width:"+i+" height:"+s+" maxSize:"+l);const r=e.format,o=e.type;let d="minFilter"in e?e.minFilter:"filter"in e?e.filter:"LINEAR",h="magFilter"in e?e.magFilter:"filter"in e?e.filter:"LINEAR";const c="wrap"in e?e.wrap:"CLAMP_TO_EDGE";if("FLOAT"==o)if(this.textureType=3,"webgl2"==a.name)"LINEAR"!=d||a.__ext_float_linear||(console.warn("Floating point texture filtering not supported on this device"),d="NEAREST"),"LINEAR"!=h||a.__ext_float_linear||(console.warn("Floating point texture filtering not supported on this device"),h="NEAREST");else if(a.__ext_float)"LINEAR"!=d||a.__ext_float_linear||(console.warn("Floating point texture filtering not supported on this device"),d="NEAREST"),"LINEAR"!=h||a.__ext_float_linear||(console.warn("Floating point texture filtering not supported on this device"),h="NEAREST");else {if(!a.__ext_half_float)throw new Error("OES_texture_half_float is not available");o="HALF_FLOAT","LINEAR"!=d||a.__ext_texture_half_float_linear||(console.warn("Half Float texture filtering not supported on this device"),d="NEAREST"),"LINEAR"!=h||a.__ext_texture_half_float_linear||(console.warn("Half Float texture filtering not supported on this device"),h="NEAREST");}else if("HALF_FLOAT"==o)if("webgl2"==a.name);else {if(!a.supportUploadingHalfFloat&&null!=n)throw new Error("Safari does not support uploading HALF_FLOAT texture data.");if(!a.__ext_half_float)throw new Error("OES_texture_half_float is not available");if("LINEAR"!=d||a.__ext_texture_half_float_linear||(console.warn("Half Float texture filtering not supported on this device"),d="NEAREST"),"LINEAR"!=h||a.__ext_texture_half_float_linear||(console.warn("Half Float texture filtering not supported on this device"),h="NEAREST"),"RGB"==r)throw new Error("OES_texture_half_float onlysupports RGBA textures")}else if("sRGB"==o&&!a.__ext_sRGB)throw new Error("EXT_sRGB is not available");this.__formatParam=r,this.__typeParam=o,this.__minFilterParam=d,this.__magFilterParam=h,this.__wrapParam=c,this.__format=a[r],this.__internalFormat="internalFormat"in e?a[e.internalFormat]:this.__format,this.__type=a[o],"webgl2"==a.name&&("internalFormat"in e||(this.__type==a.FLOAT?this.__format==a.RED?this.__internalFormat=a.R32F:this.__format==a.RG?this.__internalFormat=a.RG32F:this.__format==a.RGB?this.__internalFormat=a.RGB32F:this.__format==a.RGBA&&(this.__internalFormat=a.RGBA32F):this.__type==a.HALF_FLOAT?this.__format==a.RED?this.__internalFormat=a.R16F:this.__format==a.RG?this.__internalFormat=a.RG16F:this.__format==a.RGB?this.__internalFormat=a.RGB16F:this.__format==a.RGBA&&(this.__internalFormat=a.RGBA16F):this.__type==a.UNSIGNED_BYTE&&(this.__format==a.RED&&(this.__internalFormat=a.R8),this.__format==a.RG&&(this.__internalFormat=a.RG8),this.__format==a.RGB?this.__internalFormat=a.RGB8:this.__format==a.RGBA&&(this.__internalFormat=a.RGBA8)))),this.__minFilter=a[d],this.__magFilter=a[h],this.__wrap=a[c],this.__flipY="flipY"in e&&e.flipY,this.__mipMapped="mipMapped"in e&&e.mipMapped,this.invert="invert"in e&&e.invert,this.alphaFromLuminance="alphaFromLuminance"in e&&e.alphaFromLuminance,this.textureDesc=[i,s,0,0],this.__gltex&&a.deleteTexture(this.__gltex),this.__gltex=a.createTexture(),this.__updateGLTexParams(),n?this.bufferData(n,i,s,!1,!1):this.resize(i,s,!1,!1),this.__loaded||(this.ready.emit(),this.__loaded=!0);}__updateGLTexParams(){const e=this.__gl;e.bindTexture(e.TEXTURE_2D,this.__gltex),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,this.__minFilter),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,this.__magFilter),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,this.__wrap),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,this.__wrap);}bufferData(e,t=-1,a=-1,i=!0,s=!0){const n=this.__gl;if(i&&n.bindTexture(n.TEXTURE_2D,this.__gltex),null!=e){if(e instanceof Image||e instanceof ImageData||e instanceof HTMLCanvasElement||e instanceof HTMLImageElement||e instanceof HTMLVideoElement)n.texImage2D(n.TEXTURE_2D,0,this.__internalFormat,this.__format,this.__type,e),this.width=e.width,this.height=e.height;else {-1==t&&(t=this.width),-1==a&&(a=this.height);const i=t*a;let s;switch(this.__format){case n.RED:case n.RED_INTEGER:case n.ALPHA:case n.LUMINANCE:case n.LUMINANCE_ALPHA:s=1;break;case n.RG:s=2;break;case n.RGB:s=3;break;case n.RGBA:s=4;}e.length!=i*s&&console.warn("Invalid data for Image width:"+t+" height:"+a+" format:"+this.__formatParam+" type:"+this.__typeParam+" Data Length:"+e.length+" Expected:"+i*s),this.__type==n.HALF_FLOAT&&e instanceof Float32Array&&(e=Math.convertFloat32ArrayToUInt16Array(e)),"webgl2"==n.name?n.texImage2D(n.TEXTURE_2D,0,this.__internalFormat,t,a,0,this.__format,this.__type,e,0):n.texImage2D(n.TEXTURE_2D,0,this.__internalFormat,t,a,0,this.__format,this.__type,e),this.width=t,this.height=a;}this.__mipMapped&&n.generateMipmap(n.TEXTURE_2D);}else n.texImage2D(n.TEXTURE_2D,0,this.__internalFormat,this.width,this.height,0,this.__format,this.__type,null),this.width=t,this.height=a;s&&this.updated.emit();}clear(){const e=this.__gl,t=this.width*this.height;let a,i;switch(this.__format){case e.RED:case e.RED_INTEGER:case e.ALPHA:case e.LUMINANCE:case e.LUMINANCE_ALPHA:a=1;break;case e.RG:a=2;break;case e.RGB:a=3;break;case e.RGBA:a=4;break;default:throw new Error("Invalid Format")}switch(this.__type){case e.UNSIGNED_BYTE:i=new UInt8Array(t*a);break;case e.HALF_FLOAT:i=new UInt16Array(t*a);break;case e.FLOAT:i=new Float32Array(t*a);break;default:throw new Error("Invalid Type")}"webgl2"==e.name?e.texImage2D(e.TEXTURE_2D,0,this.__internalFormat,this.width,this.height,0,this.__format,this.__type,i,0):e.texImage2D(e.TEXTURE_2D,0,this.__internalFormat,this.width,this.height,0,this.__format,this.__type,i);}resize(e,t,a=!1,i=!0){const s=this.__gl;if(this.width!=e||this.height!=t){const n=s.getParameter(s.MAX_TEXTURE_SIZE);if(e<0||e>n||t<0||t>n)throw new Error("gl-texture2d: Invalid texture size. width:"+e+" height:"+t+" maxSize:"+n);if(a){const a=s.createTexture();s.bindTexture(s.TEXTURE_2D,a),s.texImage2D(s.TEXTURE_2D,0,this.__internalFormat,e,t,0,this.__format,this.__type,null);const i=s.createFramebuffer();s.bindFramebuffer(s.FRAMEBUFFER,i),s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,this.__gltex,0),s.bindTexture(s.TEXTURE_2D,a),s.copyTexImage2D(s.TEXTURE_2D,0,this.__internalFormat,0,0,this.width,this.height,0),s.bindFramebuffer(s.FRAMEBUFFER,null),s.deleteFramebuffer(i),this.__gl.deleteTexture(this.__gltex),this.__gltex=a,this.__updateGLTexParams();}else s.bindTexture(s.TEXTURE_2D,this.__gltex),s.texImage2D(s.TEXTURE_2D,0,this.__internalFormat,e,t,0,this.__format,this.__type,null);this.width=e,this.height=t,i&&this.resized.emit(e,t);}}populate(e,t,a,i=0,s=0,n=!0){const l=this.__gl;n&&l.bindTexture(l.TEXTURE_2D,this.__gltex),l.texSubImage2D(l.TEXTURE_2D,0,i,s,t,a,this.__format,this.__type,e);}getSize(){return [this.width,this.height]}get glTex(){return this.__gltex}getTexHdl(){return this.__gltex}bind(e,t){return console.warn("'bind' is deprecated. Please use 'bindToUniform'"),this.bindToUniform(e,t)}preBind(e,t){return {textureTypeUnif:t[e.name+"Type"],textureDescUnif:t[e.name+"Desc"]}}bindToUniform(e,t,a){if(!this.__loaded)return !1;if(!this.__gltex)throw new Error("Unable to bind non-initialized or deleted texture.");const i=e.boundTextures++,s=this.__gl.TEXTURE0+i,n=this.__gl;return n.activeTexture(s),n.bindTexture(n.TEXTURE_2D,this.__gltex),n.uniform1i(t.location,i),a&&(a.textureTypeUnif&&n.uniform1i(a.textureTypeUnif.location,this.textureType),a.textureDescUnif&&this.__gl.uniform4fv(a.textureDescUnif.location,this.textureDesc)),!0}destroy(){super.destroy(),this.__texture&&this.__texture.setMetadata("gltexture",void 0),this.__gl.deleteTexture(this.__gltex),this.__gltex=void 0;}}class Ta{constructor(e,t,a,i){this.__gl=e,this.__shaderAttrs=t,this.__glattrbuffers=a,this.__indexBuffer=i;}bind(e){const t=this.__gl;for(const e in this.__shaderAttrs){if("instancedIds"==e)continue;const a=this.__shaderAttrs[e],i=a.location;if(-1==i)continue;const s=this.__glattrbuffers[e];if(!s){t.disableVertexAttribArray(i);continue}let n,l,r;switch(s.dataType){case 0:n=1,l=4,r=t.UNSIGNED_BYTE;break;case 1:n=1,l=4,r=t.BYTE;break;case 2:n=1,l=4,r=t.UNSIGNED_SHORT;break;case 3:n=1,l=4,r=t.SHORT;break;case 4:n=1,l=4,r=t.UNSIGNED_INT;break;case 5:n=1,l=4,r=t.INT;break;case 6:n=1,l=4,r=t.FLOAT;break;case o:n=2,l=4,r=t.FLOAT;break;case d:n=3,l=4,r=t.FLOAT;break;case h:case u:n=4,l=4,r=t.FLOAT;break;case m:n=4,l=1,r=t.UNSIGNED_BYTE;break;default:throw "Unhandled Type"}const c=n*l,b=null!=s.offset?s.offset*n*l:0,p=1==s.normalized,g=a.instanced;t.enableVertexAttribArray(i),t.bindBuffer(t.ARRAY_BUFFER,s.buffer),t.vertexAttribPointer(i,n,r,p,c,b),t.vertexAttribDivisor&&(1==g?t.vertexAttribDivisor(i,1):t.vertexAttribDivisor(i,0));}return t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.__indexBuffer),!0}unbind(){const e=this.__gl;for(const t in this.__shaderAttrs){const a=this.__shaderAttrs[t].location;-1!=a&&(e.disableVertexAttribArray(a),e.vertexAttribDivisor(a,0));}e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null);}destroy(){}}class Ca{constructor(e,t,a,i){this.__gl=e,this.__vao=e.createVertexArray(),e.bindVertexArray(this.__vao);for(const i in t){if("instancedIds"==i)continue;const s=t[i],n=s.location;if(-1==n)continue;const l=a[i];if(!l){e.disableVertexAttribArray(n);continue}let r,c,b;switch(l.dataType){case 0:r=1,c=4,b=e.UNSIGNED_BYTE;break;case 1:r=1,c=4,b=e.BYTE;break;case 2:r=1,c=4,b=e.UNSIGNED_SHORT;break;case 3:r=1,c=4,b=e.SHORT;break;case 4:r=1,c=4,b=e.UNSIGNED_INT;break;case 5:r=1,c=4,b=e.INT;break;case 6:r=1,c=4,b=e.FLOAT;break;case o:r=2,c=4,b=e.FLOAT;break;case d:r=3,c=4,b=e.FLOAT;break;case h:case u:r=4,c=4,b=e.FLOAT;break;case m:r=4,c=1,b=e.UNSIGNED_BYTE;break;default:throw "Unhandled Type"}const p=r*c,g=null!=l.offset?l.offset*r*c:0,_=1==l.normalized,Z=s.instanced;e.enableVertexAttribArray(n),e.bindBuffer(e.ARRAY_BUFFER,l.buffer),e.vertexAttribPointer(n,r,b,_,p,g),Z?e.vertexAttribDivisor(n,1):e.vertexAttribDivisor(n,0);}this.__indexBuffer=i;}bind(e){return this.__gl.bindVertexArray(this.__vao),this.__indexBuffer&&this.__gl.bindBuffer(this.__gl.ELEMENT_ARRAY_BUFFER,this.__indexBuffer),!0}unbind(){const e=this.__gl;for(const t in this.__shaderAttrs){const a=this.__shaderAttrs[t].location;-1!=a&&(e.disableVertexAttribArray(a),e.vertexAttribDivisor(a,0));}this.__gl.bindVertexArray(null),this.__indexBuffer&&e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null);}destroy(){this.__gl.deleteVertexArray(this.__vao);}}function Ya(e,t,a,i){return null==e.createVertexArray?new Ta(e,t,a,i):new Ca(e,t,a,i)}class Na extends T{constructor(e,t){super(),this.__gl=e,this.__geom=t,this.__glattrs={},this.__glattrbuffers={},this.__shaderBindings={},this.destructing=new S,this.updated=new S;this.__geom.geomDataChanged.connect(e=>{this.updateBuffers(e),this.updated.emit();});this.__geom.geomDataTopologyChanged.connect(e=>{this.clearShaderBindings(),this.updateBuffers(e),this.updated.emit();});}getGeom(){return this.__geom}genBuffers(){}updateBuffers(e){}bind(e){if(this.__destroyed)throw new Error("Error binding a destroyed geom");let t=this.__shaderBindings[e.shaderkey];if(!t){t=Ya(this.__gl,e.attrs,this.__glattrbuffers,this.__indexBuffer),this.__shaderBindings[e.shaderkey]=t;}return t.bind(e),!0}unbind(e){const t=this.__shaderBindings[e.shaderkey];t&&t.unbind(e);}draw(){throw new Error("Not implemented. Implement this method in a derived class.")}drawInstanced(e){throw new Error("Not implemented. Implement this method in a derived class.")}bindAndDraw(e){this.bind(e),this.draw(e);}clearShaderBindings(){for(const e in this.__shaderBindings){this.__shaderBindings[e].destroy();}this.__shaderBindings={};}destroy(){this.__geom.deleteMetadata("glgeom"),this.clearShaderBindings();const e=this.__gl;for(const t in this.__glattrbuffers){const a=this.__glattrbuffers[t];a.shared||e.deleteBuffer(a.buffer);}this.__glattrs={},this.__shaderBindings={},this.__destroyed=!0,this.destructing.emit(this);}}class Ka extends Na{constructor(e,t){super(e,t),this.genBuffers();}getNumTriangles(){return this.__numTriangles}genBuffers(){super.genBuffers();const e=this.__gl,t=this.__geom.genBuffers(),a=t.indices;this.__numTriIndices=t.indices.length,a instanceof Uint8Array&&(this.__indexDataType=this.__gl.UNSIGNED_BYTE),a instanceof Uint16Array&&(this.__indexDataType=this.__gl.UNSIGNED_SHORT),a instanceof Uint32Array&&(this.__indexDataType=this.__gl.UNSIGNED_INT),this.__numTriangles=a.length/3,this.__numRenderVerts=t.numRenderVerts,this.__indexBuffer=e.createBuffer(),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.__indexBuffer),e.bufferData(e.ELEMENT_ARRAY_BUFFER,t.indices,e.STATIC_DRAW);for(const a in t.attrBuffers){const i=t.attrBuffers[a],s=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,s),e.bufferData(e.ARRAY_BUFFER,i.values,e.STATIC_DRAW),this.__glattrbuffers[a]={buffer:s,dataType:i.dataType,normalized:i.normalized},"textureCoords"==a&&(this.__glattrbuffers.texCoords=this.__glattrbuffers.textureCoords);}}updateBuffers(e){const t=this.__gl,a=this.__geom.genBuffers({includeIndices:!1});for(const e in a.attrBuffers){const i=a.attrBuffers[e],s=this.__glattrbuffers[e];t.bindBuffer(t.ARRAY_BUFFER,s.buffer),t.bufferData(t.ARRAY_BUFFER,i.values,t.STATIC_DRAW);}}getNumUnSplitVerts(){return this.__geom.vertices.length}getNumSplitVerts(){return this.__numRenderVerts}generateWireframesVAO(){if(!this.__vao)return !1;this.__geom.edgeVerts||this.__geom.genTopologyInfo(),this.__wireframesVao&&this.__ext.deleteVertexArrayOES(this.__wireframesVao),this.__wireframesVao=this.__ext.createVertexArrayOES(),this.__ext.bindVertexArrayOES(this.__wireframesVao);const e=this.__gl,t=e.createBuffer(),a=Uint32Array.from(this.__geom.edgeVerts);e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,t),e.bufferData(e.ELEMENT_ARRAY_BUFFER,a,e.STATIC_DRAW);const i=this.__glattrbuffers.positions.buffer;e.enableVertexAttribArray(0),e.bindBuffer(e.ARRAY_BUFFER,i),e.vertexAttribPointer(0,3,e.FLOAT,!1,12,0),this.__numWireIndices=a.length,this.__ext.bindVertexArrayOES(null);}bindWireframeVAO(e){return null!=this.__wireframesVao&&(this.__ext.bindVertexArrayOES(this.__wireframesVao),!0)}unbindWireframeVAO(){this.__ext.bindVertexArrayOES(null);}drawWireframe(){this.__wireframesVao&&this.__gl.drawElements(this.__gl.LINES,this.__numWireIndices,this.__gl.UNSIGNED_INT,0);}generateHardEdgesVAO(){if(!this.__vao)return !1;this.__geom.edgeVerts||this.__geom.generateHardEdgesFlags(),this.__hardEdgesVao&&this.__ext.deleteVertexArrayOES(this.__hardEdgesVao),this.__hardEdgesVao=this.__ext.createVertexArrayOES(),this.__ext.bindVertexArrayOES(this.__hardEdgesVao);const e=this.__gl,t=e.createBuffer(),a=Uint32Array.from(this.__geom.computeHardEdgesIndices());e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,t),e.bufferData(e.ELEMENT_ARRAY_BUFFER,a,e.STATIC_DRAW);const i=this.__glattrbuffers.positions.buffer;e.enableVertexAttribArray(0),e.bindBuffer(e.ARRAY_BUFFER,i),e.vertexAttribPointer(0,3,e.FLOAT,!1,12,0),this.__numEdgeIndices=a.length,this.__ext.bindVertexArrayOES(null);}bindHardEdgesVAO(e){return null!=this.__hardEdgesVao&&(this.__ext.bindVertexArrayOES(this.__hardEdgesVao),!0)}unbindHardEdgesVAO(){this.__ext.bindVertexArrayOES(null);}drawHardEdges(){this.__hardEdgesVao&&this.__gl.drawElements(this.__gl.LINES,this.__numEdgeIndices,this.__gl.UNSIGNED_INT,0);}drawPoints(){this.__gl.drawArrays(this.__gl.POINTS,0,this.__geom.numVertices());}draw(){this.__gl.drawElements(this.__gl.TRIANGLES,this.__numTriIndices,this.__indexDataType,0);}drawInstanced(e){this.__gl.drawElementsInstanced(this.__gl.TRIANGLES,this.__numTriIndices,this.__indexDataType,0,e);}destroy(){super.destroy(),this.__gl.deleteBuffer(this.__indexBuffer),this.__indexBuffer=void 0;}}class wa extends Na{constructor(e,t){super(e,t),this.genBuffers();}genBuffers(){super.genBuffers();const e=this.__gl,t=this.__geom.genBuffers(),a=t.indices;if(this.fatLines=(this.__geom.lineThickness>0||t.attrBuffers.lineThickness)&&e.floatTexturesSupported,this.fatLines){e.__quadVertexIdsBuffer||e.setupInstancedQuad(),this.__glattrbuffers.vertexIDs=e.__quadattrbuffers.vertexIDs,this.__drawCount=a.length/2;const t=this.__geom.getVertexAttributes(),i=t.positions,s=t.lineThickness,n=4,l=new Float32Array(i.length*n);for(let e=0;e<i.length;e++){d.createFromFloat32Buffer(l.buffer,4*e).setFromOther(i.getValueRef(e)),l[4*e+3]=s?s.getFloat32Value(e):this.__geom.lineThickness;}this.__positionsTexture=new Fa(e,{format:"RGBA",type:"FLOAT",width:i.length,height:1,filter:"NEAREST",wrap:"CLAMP_TO_EDGE",data:l,mipMapped:!1});const r=new Float32Array(a.length);for(let e=0;e<a.length;e++){let t;t=e%2==0?e>0?a[e]==a[e-1]:a[e]==a[a.length-1]:e<a.length-1?a[e]==a[e+1]:a[e]==a[0],r[e]=(t?1:0)+2*a[e];}const o=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,o),e.bufferData(e.ARRAY_BUFFER,r,e.STATIC_DRAW),this.__glattrbuffers.segmentIndices={buffer:o,dimension:2};}else {this.__indexBuffer=e.createBuffer(),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.__indexBuffer),e.bufferData(e.ELEMENT_ARRAY_BUFFER,a,e.STATIC_DRAW);for(const a in t.attrBuffers){const i=t.attrBuffers[a],s=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,s),e.bufferData(e.ARRAY_BUFFER,i.values,e.STATIC_DRAW),this.__glattrbuffers[a]={buffer:s,dataType:i.dataType,normalized:i.normalized};}this.__numSegIndices=a.length,this.__numVertices=t.numVertices;}a instanceof Uint8Array&&(this.__indexDataType=this.__gl.UNSIGNED_BYTE),a instanceof Uint16Array&&(this.__indexDataType=this.__gl.UNSIGNED_SHORT),a instanceof Uint32Array&&(this.__indexDataType=this.__gl.UNSIGNED_INT);}updateBuffers(e){const t=this.__gl,a=this.__geom.genBuffers(),i=a.indices;if(this.fatLines){this.__drawCount=i.length/2;const e=this.__geom.getVertexAttributes(),a=e.positions,s=e.lineThickness,n=4,l=new Float32Array(a.length*n);for(let e=0;e<a.length;e++){d.createFromFloat32Buffer(l.buffer,4*e).setFromOther(a.getValueRef(e)),l[4*e+3]=s?s.getFloat32Value(e):this.__geom.lineThickness;}this.__positionsTexture.bufferData(l,a.length,1);const r=new Float32Array(i.length);for(let e=0;e<i.length;e++){let t;t=e%2==0?e>0&&i[e]==i[e-1]:e<i.length-1&&i[e]==i[e+1],r[e]=(t?1:0)+2*i[e];}t.bindBuffer(t.ARRAY_BUFFER,this.__glattrbuffers.segmentIndices.buffer),t.bufferData(t.ARRAY_BUFFER,r,t.STATIC_DRAW);}else {this.__geom.getVertexAttributes();if(e&&e.indicesChanged){const e=this.__geom.getIndices();this.__numSegIndices!=e.length&&(t.deleteBuffer(this.__indexBuffer),this.__indexBuffer=t.createBuffer()),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.__indexBuffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,e,t.STATIC_DRAW),this.__numSegIndices=e.length;}const s=a.numVertices!=this.__numVertices;for(const e in a.attrBuffers){const i=a.attrBuffers[e],n=this.__glattrbuffers[e];s&&(t.deleteBuffer(n.buffer),n.buffer=t.createBuffer()),t.bindBuffer(t.ARRAY_BUFFER,n.buffer),t.bufferData(t.ARRAY_BUFFER,i.values,t.STATIC_DRAW);}this.__numVertices=a.numVertices,this.__numSegIndices=i.length;}i instanceof Uint8Array&&(this.__indexDataType=this.__gl.UNSIGNED_BYTE),i instanceof Uint16Array&&(this.__indexDataType=this.__gl.UNSIGNED_SHORT),i instanceof Uint32Array&&(this.__indexDataType=this.__gl.UNSIGNED_INT);}bind(e){if(this.fatLines&&"LineThickness"in e.unifs){const t=this.__gl;let a=this.__shaderBindings[e.shaderkey];a||(a=Ya(t,e.attrs,this.__glattrbuffers,t.__quadIndexBuffer),this.__shaderBindings[e.shaderkey]=a),a.bind(e);{const a=e.unifs;a.positionsTexture&&(this.__positionsTexture.bindToUniform(e,a.positionsTexture),t.uniform1i(a.positionsTextureSize.location,this.__positionsTexture.width));}const i=e.unifs;return t.uniform1f(i.LineThickness.location,(this.__geom.lineThickness?this.__geom.lineThickness:1)*e.viewScale),!0}return super.bind(e)}drawPoints(){this.__gl.drawArrays(this.__gl.POINTS,0,this.__geom.numVertices());}draw(e){const t=this.__gl;this.fatLines?e.unifs.LineThickness&&t.drawElementsInstanced(t.TRIANGLES,6,t.UNSIGNED_SHORT,0,this.__drawCount):t.drawElements(this.__gl.LINES,this.__numSegIndices,this.__indexDataType,0);}drawInstanced(e){this.__gl.drawElementsInstanced(this.__gl.LINES,this.__numSegIndices,this.__indexDataType,0,e);}}class za extends Na{constructor(e,t){super(e,t),this.genBuffers();}genBuffers(){super.genBuffers();const e=this.__gl,t=this.__geom.genBuffers();for(const a in t.attrBuffers){const i=t.attrBuffers[a],s=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,s),e.bufferData(e.ARRAY_BUFFER,i.values,e.STATIC_DRAW),this.__glattrbuffers[a]={buffer:s,dataType:i.dataType,normalized:i.normalized};}this.__numVerts=t.numVertices,this.__vboState=2;}bind(e){if(e.unifs.PointSize){const t=this.__gl;let a=this.__shaderBindings[e.shaderkey];if(!a){t.__quadVertexIdsBuffer||t.setupInstancedQuad();const i=Object.assign(this.__glattrbuffers,t.__quadattrbuffers);a=Ya(t,e.attrs,i,t.__quadIndexBuffer),this.__shaderBindings[e.shaderkey]=a;}return a.bind(e),!0}return super.bind(e)}draw(e){const t=this.__gl;e.unifs.PointSize?t.drawElementsInstanced(t.TRIANGLES,6,t.UNSIGNED_SHORT,0,this.__numVerts):t.drawArrays(t.POINTS,0,this.__numVerts);}drawInstanced(e){this.__gl.drawArraysInstanced(this.__gl.POINTS,0,this.__numVerts,e);}}const Ua={bool:Boolean,int:5,uint:4,float:6,ivec2:o,ivec3:d,ivec4:h,vec2:o,vec3:d,vec4:h,color:u,mat3:g,mat4:_,sampler2D:Te};const Ja=new class{constructor(){this.__shaderModules={};}hasShaderModule(e){return e in this.__shaderModules}setShaderModule(e,t){return this.parseShader(e,t)}getShaderModule(e){return this.__shaderModules[e]}getShaderModuleNames(){const e=[];for(const t in this.__shaderModules)e.push(t);return e}parseShader(e,t){const a=e=>{if(e.startsWith("..")){return i.substring(0,i.lastIndexOf("/"))+e.substring(2)}return e.startsWith(".")?i+e.substring(1):e.startsWith("/")?e.substring(1):e},i=(s(e),e.substring(0,e.lastIndexOf("/"))),n=t.split("\n"),l={glsl:" //starting:"+e+"\n",lines:n,numLines:0,includeMetaData:[],uniforms:{},attributes:{}},r=/\s+/;for(let t=0;t<n.length;t++){let i=n[t],o=i.trim();if(o.startsWith("//")||o.startsWith("*"))l.glsl=l.glsl+i+"\n",l.numLines++;else if(-1!=o.indexOf("//")&&(o=o.slice(0,o.indexOf("//")).trim()),o.startsWith("<%")||o.startsWith("</%")){const o=function(e){const t=(e=(e=e.startsWith("</%")?e.slice(3):e.slice(2)).endsWith("/>")?e.slice(0,e.length-2):e.slice(0,e.length-1)).split(r),a={tag:t.shift(),attributes:{}};for(const e of t){const t=e.split("=");a.attributes[t[0]]=t[1].replace(/['"]+/g,"");}return a}(n[t].trim());switch(o.tag){case"include":{const i=a(o.attributes.file);if(!this.hasShaderModule(i))throw new Error("Error while parsing :"+e+" \nShader module not found:"+i+"\n in:"+this.getShaderModuleNames());const n=this.getShaderModule(i);s(o.attributes.file);let r=n.glsl;r=r.substring(r.indexOf("\n")+1),l.glsl=l.glsl+" //including:"+o.attributes.file+"\n";const d={};for(const e in o.attributes){if("file"==e)continue;const t=o.attributes[e];r=r.replaceAll(e,t),d[e]=t;}l.glsl=l.glsl+r,l.includeMetaData.push({src:l.numLines,tgt:t,length:n.numLines,key:i}),l.glsl=l.glsl+" //continuing:"+e+"\n",l.numLines+=n.numLines+1;for(const e in n.attributes){let t=e;for(const e in d)t=t.replaceAll(e,d[e]);l.attributes[t]=n.attributes[e];}for(const e in n.uniforms){let t=e;for(const e in d)t=t.replaceAll(e,d[e]);l.uniforms[t]=n.uniforms[e];}break}default:console.warn("Error while parsing :"+e+" \nUnhandled line:"+i);continue}}else {const a=(t,a)=>{if(!(t[1]in Ua))throw new Error("Error while parsing :"+e+" \nType not recognized:"+t[1]);const s=t[2].slice(0,t[2].length-1);l.attributes[s]={type:Ua[t[1]],instanced:a},"color"==t[1]&&(t[1]="vec4",i=t.join(" "));};if(o.startsWith("struct")){let e="";if(-1!=o.indexOf("}"))e=o.substring(o.indexOf("{")+1,o.indexOf("}")-1);else for(t++;i+=n[t]+"\n",e+=i.trim(),t++,-1==e.indexOf("}"););const a=e.substring(e.indexOf("{")+1,e.indexOf("}")-1).split(";"),s=[];for(const e of a){if(0==e.length)continue;const t=e.trim().split(r);s.push({name:t[1],type:Ua[t[0]]});}const l=o.split(r);Ua[l[1]]=s;}if(o.startsWith("attribute")){a(o.split(r),!1);}if(o.startsWith("instancedattribute")){const e=o.split(r);a(e,!0),e[0]="attribute",i=e.join(" ");}else if(o.startsWith("uniform")){const t=o.split(r);let a=1;4==t.length&&(a=2);const s=t[a];if(!(s in Ua))throw new Error("Error while parsing :"+e+" \nType not recognized:"+t[1]);const n=t[a+1].slice(0,t[a+1].length-1);l.uniforms[n]=Ua[s],"struct"==l.uniforms[n]&&console.log(t),"color"==t[1]&&(t[1]="vec4",i=t.join(" "));}l.glsl=l.glsl+i+"\n",l.numLines++;}}return this.__shaderModules[e]=l,l}};class Pa extends D{constructor(e){if(super(),!e)throw new Error("gl context must be passed to shader constructor");this.__gl=e,this.__shaderStages={VERTEX_SHADER:{glsl:"",lines:0,uniforms:{},attributes:{}},FRAGMENT_SHADER:{glsl:"",lines:0,uniforms:{},attributes:{}}},this.__shaderProgramHdls={},this.__gltextures={},this.updated=new S,this.invisibleToGeomBuffer=!1;}static isTransparent(){return !1}static isOverlay(){return !1}__compileShaderStage(e,t,a,i){const s=this.__gl;if(i||(i=s.shaderopts),i){if(i.repl)for(const t in i.repl)e=e.replaceAll(t,i.repl[t]);i.defines&&(e=i.defines+e);}"webgl2"==s.name&&(e=e.replaceAll("attribute","in"),e="#version 300 es\n"+(e=(e="vertexShader"==a?e.replaceAll("varying","out"):e.replaceAll("varying","in")).replaceAll("texture2D","texture")));const l=s.createShader(t);if(s.shaderSource(l,e),s.compileShader(l),!s.getShaderParameter(l,s.COMPILE_STATUS)){console.log("Errors in :"+this.constructor.name);const t=s.getShaderInfoLog(l).split("\n"),i={};for(let e in t){if(t[e].startsWith("'")){t[e-1]=t[e-1]+t[e],delete t[e],e--;continue}const a=t[e].split(":");if(a.length>=2){const s=parseInt(a[2]);isNaN(s)||(i[s]?i[s].push(t[e]):i[s]=[t[e]]);}}const n=[],r=e.split("\n");for(let e=0;e<r.length;e++)if(n.push((e+1+":").lpad(" ",3)+r[e]),e+1 in i){const t=i[e+1];for(const e of t)n.push(e),n.push("-".lpad("-",e.length));}throw new Error("An error occurred compiling the shader \n=================\n"+this.constructor.name+"."+a+": \n\n"+t.join("\n")+"\n"+n.join("\n"))}return l}__createProgram(e){const t=this.__gl;this.__shaderCompilationAttempted=!0;const a=t.createProgram(),i=this.__shaderStages.VERTEX_SHADER.glsl,s={};if(null!=i){const n=this.__compileShaderStage(i,t.VERTEX_SHADER,"vertexShader",e);if(!n)return !1;t.attachShader(a,n),s[t.VERTEX_SHADER]=n;}const n=this.__shaderStages.FRAGMENT_SHADER.glsl;if(null!=n){const i=Object.assign({},t.shaderopts,e);i.frag&&(i.defines=i.frag.defines+i.defines);const l=this.__compileShaderStage(n,t.FRAGMENT_SHADER,"fragmentShader",i);if(!l)return !1;t.attachShader(a,l),s[t.FRAGMENT_SHADER]=l;}if(t.linkProgram(a),!t.getProgramParameter(a,t.LINK_STATUS)){const e=t.getProgramInfoLog(a);if(e.includes("D3D shader compilation failed")){const e=t.getExtension("WEBGL_debug_shaders");if(e){const a=e.getTranslatedShaderSource(s[t.VERTEX_SHADER]);console.log(a);}}throw console.log("vertexShaderGLSL:"+i),console.log("fragmentShaderGLSL:"+n),new Error("Unable to link the shader program:"+this.constructor.name+"\n==================\n"+e)}const l=this.__extractAttributeAndUniformLocations(a,e);return l.shaderProgramHdl=a,l}__extractAttributeAndUniformLocations(e,t){const a=this.__gl,i=this.getAttributes(),s={attrs:{},unifs:{}};for(const t in i){const n=a.getAttribLocation(e,t);if(null==n){console.warn("Shader attribute not found:"+t);continue}const l=i[t];s.attrs[t]={name:t,location:n,type:l.type,instanced:l.instanced};}const n=this.getUniforms();for(let i in n){const l=n[i];if(l instanceof Array)for(const t of l){const n=i+"."+t.name,l=a.getUniformLocation(e,n);null!=l&&(s.unifs[n]={name:n,location:l,type:t.type});}if(t&&t.repl)for(const e in t.repl)i=i.replace(e,t.repl[e]);const r=a.getUniformLocation(e,i);null!=r&&(s.unifs[i]={name:i,location:r,type:l});}return s}getAttributes(){const e={};for(const t in this.__shaderStages){const a=this.__shaderStages[t];for(const t in a.attributes)e[t]=a.attributes[t];}return e}getUniforms(){const e={};for(const t in this.__shaderStages){const a=this.__shaderStages[t];for(const t in a.uniforms)e[t]=a.uniforms[t];}return e}finalize(){}compileForTarget(e,t){e||(e=this.constructor.name);let a=this.__shaderProgramHdls[e];return a||!1!==a&&(a=this.__createProgram(t),this.__shaderProgramHdls[e]=a),a}compile(){this.compileForTarget();}bind(e,t){const a=this.__gl;if(e.glshader!=this){const i=this.compileForTarget(t,e.shaderopts);if(!1===i)return console.warn(this.constructor.name+" is not compiled for "+t),!1;const s=i.shaderProgramHdl;a.useProgram(s),e.shaderkey=this.constructor.name,e.glshader=this,e.boundTextures=0,e.boundLightmap=void 0,e.glgeom=void 0,e.unifs=i.unifs,e.attrs=i.attrs,e.bindRendererUnifs&&e.bindRendererUnifs(i.unifs);}return e.supportsInstancing=!0,!0}unbind(e){return !0}static getParamDeclarations(){return []}static getGeomDataShaderName(){}static getSelectedShaderName(){}destroy(){const e=this.__gl;for(const t in this.__shaderProgramHdls){const a=this.__shaderProgramHdls[t];e.deleteProgram(a.shaderProgramHdl);}this.__shaderProgramHdls={};}}Ja.setShaderModule("utils/quadVertexFromID.glsl","\n\nattribute float vertexIDs;\n\nvec2 getQuadVertexPositionFromID(){\n    int vertexID = int(vertexIDs);\n    if(vertexID == 0)\n        return vec2(-0.5, -0.5);\n    else if(vertexID == 1)\n        return vec2(0.5, -0.5);\n    else if(vertexID == 2)\n        return vec2(-0.5, 0.5);\n    else if(vertexID == 3)\n        return vec2(0.5, 0.5);\n    return vec2(0,0);\n}\n"),Ja.setShaderModule("utils/unpackHDR.glsl","\n\nvec3 decodeHDR(const in vec3 ldrPixel, const in float cdmAlpha) {\n    float avg = (cdmAlpha * 16.0 - 8.0);\n    float scl = 1.0;\n    vec3 color;\n    color.x = (tan((ldrPixel.x-0.5)*1.5)/scl)+avg;\n    color.y = (tan((ldrPixel.y-0.5)*1.5)/scl)+avg;\n    color.z = (tan((ldrPixel.z-0.5)*1.5)/scl)+avg;\n\n    // convert from logarithmic curve to linear curve.\n    // subtract the epsilon that was added during encoding.\n    const float eps = 0.001;\n    color.x = pow(10.0, color.x) - eps;\n    color.y = pow(10.0, color.y) - eps;\n    color.z = pow(10.0, color.z) - eps;\n    return color;\n}\n\nvec3 decodeHDR(sampler2D ldrSampler, sampler2D cdmSampler, vec2 texCoord) {\n#ifdef ENABLE_ES3\n    float cdm = texture2D(cdmSampler, texCoord).r;\n#else\n    float cdm = texture2D(cdmSampler, texCoord).a;\n#endif\n    return decodeHDR(texture2D(ldrSampler, texCoord).rgb, cdm);\n}\n\n");class Ea extends Pa{constructor(e){super(e),this.__shaderStages.VERTEX_SHADER=Ja.parseShader("UnpackHDRShader.vertexShader",'\nprecision highp float;\n\n<%include file="utils/quadVertexFromID.glsl"/>\n\n/* VS Outputs */\nvarying vec2 v_texCoord;\n \nvoid main()\n{\n    vec2 position = getQuadVertexPositionFromID();\n    v_texCoord = position+0.5;\n    gl_Position = vec4(position*2.0, 0.0, 1.0);\n}\n'),this.__shaderStages.FRAGMENT_SHADER=Ja.parseShader("UnpackHDRShader.fragmentShader",'\nprecision highp float;\n\nvarying vec2 v_texCoord;\nuniform sampler2D ldrSampler;\nuniform sampler2D cdmSampler;\nuniform float exposure;\nuniform vec4 tint;\n\n<%include file="utils/unpackHDR.glsl"/>\n\n#ifdef ENABLE_ES3\n    out vec4 fragColor;\n#endif\nvoid main(void) {\n\n#ifndef ENABLE_ES3\n    vec4 fragColor;\n#endif\n\n    fragColor = vec4(decodeHDR(ldrSampler, cdmSampler, v_texCoord) * tint.rgb * exposure, 1.0);\n\n#ifndef ENABLE_ES3\n    gl_FragColor = fragColor;\n#endif\n}\n\n');}}class Ha{constructor(e,a,i=!1){!t.isIOSDevice||"FLOAT"!=a.getType()&&"HALF_FLOAT"!=a.getType()||console.error("IOS devices are unable to render to float textures."),this.__gl=e,this.__colorTexture=a,this.__createDepthTexture=i,this.__clearColor=[0,0,0,0],this.__depthTexture=void 0,this.setup=this.setup.bind(this),this.resize=this.resize.bind(this),this.__colorTexture&&this.__colorTexture.resized.connect(this.resize),this.setup();}setClearColor(e){this.__clearColor=e;}getWidth(){return this.__colorTexture.width}getHeight(){return this.__colorTexture.height}getSize(){return [this.__colorTexture.width,this.__colorTexture.height]}getColorTexture(){return this.__colorTexture}getDepthTextureGL(){return this.__depthTexture}get width(){return this.__colorTexture.width}get height(){return this.__colorTexture.height}get size(){return [this.__colorTexture.width,this.__colorTexture.height]}get colorTexture(){return this.__colorTexture}setColorTexture(e){this.__colorTexture=e,gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,this.__colorTexture.glTex,0);}get depthTextureGL(){return this.__depthTexture}setup(){const e=this.__gl;if(this.__fbo=e.createFramebuffer(),"webgl2"==e.name?e.bindFramebuffer(e.DRAW_FRAMEBUFFER,this.__fbo):e.bindFramebuffer(e.FRAMEBUFFER,this.__fbo),this.__colorTexture&&("webgl2"==e.name?e.framebufferTexture2D(e.DRAW_FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.__colorTexture.glTex,0):e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.__colorTexture.glTex,0)),this.__createDepthTexture)if("webgl2"==e.name||e.__ext_WEBGL_depth_texture)e.activeTexture(e.TEXTURE0),this.__depthTexture=e.createTexture(),e.bindTexture(e.TEXTURE_2D,this.__depthTexture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),"webgl2"==e.name?(e.texImage2D(e.TEXTURE_2D,0,e.DEPTH_COMPONENT24,this.width,this.height,0,e.DEPTH_COMPONENT,e.UNSIGNED_INT,null),e.framebufferTexture2D(e.DRAW_FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.TEXTURE_2D,this.__depthTexture,0)):(e.texImage2D(e.TEXTURE_2D,0,e.DEPTH_COMPONENT,this.width,this.height,0,e.DEPTH_COMPONENT,e.UNSIGNED_INT,null),e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.TEXTURE_2D,this.__depthTexture,0));else {const t=e.createRenderbuffer();e.bindRenderbuffer(e.RENDERBUFFER,t),e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,this.width,this.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,t);}this.__checkFramebuffer(),"webgl2"==e.name?e.bindFramebuffer(e.DRAW_FRAMEBUFFER,null):e.bindFramebuffer(e.FRAMEBUFFER,null);}resize(){const e=this.__gl;"webgl2"==e.name?e.bindFramebuffer(e.DRAW_FRAMEBUFFER,this.__fbo):e.bindFramebuffer(e.FRAMEBUFFER,this.__fbo),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.__colorTexture.glTex,0),this.__depthTexture&&(e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.__depthTexture),"webgl2"==e.name?e.texImage2D(e.TEXTURE_2D,0,e.DEPTH_COMPONENT24,this.width,this.height,0,e.DEPTH_COMPONENT,e.UNSIGNED_INT,null):e.texImage2D(e.TEXTURE_2D,0,e.DEPTH_COMPONENT,this.width,this.height,0,e.DEPTH_COMPONENT,e.UNSIGNED_INT,null)),this.__checkFramebuffer();}__checkFramebuffer(){const e=this.__gl;let t;if(t="webgl2"==e.name?e.checkFramebufferStatus(e.DRAW_FRAMEBUFFER):e.checkFramebufferStatus(e.FRAMEBUFFER),t!==e.FRAMEBUFFER_COMPLETE)switch(e.bindTexture(e.TEXTURE_2D,null),"webgl2"==e.name?e.bindFramebuffer(e.DRAW_FRAMEBUFFER,null):e.bindFramebuffer(e.FRAMEBUFFER,null),console.warn("Error creating Fbo width:",this.width,", height:",this.height," Texture Type:",this.__colorTexture.getType()),t){case e.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw new Error("The attachment types are mismatched or not all framebuffer attachment points are framebuffer attachment complete.");case e.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw new Error("There is no attachment.");case e.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw new Error("Height and width of the attachment are not the same.");case e.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw new Error("The format of the attachment is not supported or if depth and stencil attachments are not the same renderbuffer.");case 36061:throw new Error("The framebuffer is unsupported");default:throw new Error("Incomplete Frambuffer")}}bindForWriting(e){e&&(this.__prevBoundFbo=e.boundRendertarget,e.boundRendertarget=this.__fbo);const t=this.__gl;"webgl2"==t.name?t.bindFramebuffer(t.DRAW_FRAMEBUFFER,this.__fbo):t.bindFramebuffer(t.FRAMEBUFFER,this.__fbo),t.viewport(0,0,this.width,this.height);}unbindForWriting(e){e&&(e.boundRendertarget=this.__prevBoundFbo);const t=this.__gl;"webgl2"==t.name?t.bindFramebuffer(t.DRAW_FRAMEBUFFER,this.__prevBoundFbo):t.bindFramebuffer(t.FRAMEBUFFER,this.__prevBoundFbo);}bind(e){this.bindForWriting(e);}unbind(e){this.unbindForWriting(e);}bindForReading(){const e=this.__gl;"webgl2"==e.name?e.bindFramebuffer(e.READ_FRAMEBUFFER,this.__fbo):e.bindFramebuffer(e.FRAMEBUFFER,this.__fbo);}unbindForReading(){const e=this.__gl;"webgl2"==e.name?e.bindFramebuffer(e.READ_FRAMEBUFFER,null):e.bindFramebuffer(e.FRAMEBUFFER,null);}clear(){const e=this.__gl;e.colorMask(!0,!0,!0,!0),e.clearColor(...this.__clearColor),this.__createDepthTexture?e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT):e.clear(e.COLOR_BUFFER_BIT);}bindAndClear(e){this.bind(e),this.clear(e);}unbind(){const e=this.__gl;e.bindFramebuffer(e.FRAMEBUFFER,null);}destroy(){const e=this.__gl;e.bindFramebuffer(e.FRAMEBUFFER,null),e.deleteFramebuffer(this.__fbo),this.__fbo=null,this.__colorTexture.resized.disconnect(this.resize);}}class ka extends Fa{constructor(e,t){super(e),this.__hdrImage=t,this.__hdrImage.setMetadata("gltexture",this),this.__hdrImage.updated.connect(()=>{this.__unpackHDRImage(this.__hdrImage.getParams());}),this.__hdrImage.isLoaded()?this.__unpackHDRImage(this.__hdrImage.getParams()):this.__hdrImage.loaded.connect(()=>{this.__unpackHDRImage(this.__hdrImage.getParams());});}__unpackHDRImage(e){const t=this.__gl,a=e.data.ldr,i=e.data.cdm;if(this.__fbo)this.__srcLDRTex.bufferData(a),this.__srcCDMTex.bufferData(i);else {this.configure({format:"RGBA",type:"FLOAT",width:a.width,height:a.height,filter:"LINEAR",wrap:"CLAMP_TO_EDGE"}),this.__fbo=new Ha(t,this),this.__fbo.setClearColor([0,0,0,0]),this.__srcLDRTex=new Fa(t,{format:"RGB",type:"UNSIGNED_BYTE",width:a.width,height:a.height,filter:"NEAREST",mipMapped:!1,wrap:"CLAMP_TO_EDGE",data:a}),this.__srcCDMTex=new Fa(t,{format:"webgl2"==t.name?"RED":"ALPHA",type:"UNSIGNED_BYTE",width:a.width,height:a.height,filter:"NEAREST",mipMapped:!1,wrap:"CLAMP_TO_EDGE",data:i}),this.__unpackHDRShader=new Ea(t);const e=this.__unpackHDRShader.compileForTarget("GLHDRImage");this.__shaderBinding=Ya(t,e.attrs,t.__quadattrbuffers,t.__quadIndexBuffer);}this.__fbo.bindAndClear();const s={};this.__unpackHDRShader.bind(s,"GLHDRImage"),this.__shaderBinding.bind(s);const n=s.unifs;this.__srcLDRTex.bindToUniform(s,n.ldrSampler),this.__srcCDMTex.bindToUniform(s,n.cdmSampler),t.uniform1f(n.exposure.location,1),t.uniform4fv(n.tint.location,this.__hdrImage.getHDRTint().asArray()),t.drawQuad(),this.__fbo.unbind(),this.updated.emit();}bindToUniform(e,t,a){return super.bindToUniform(e,t,a)}destroy(){super.destroy(),this.__fbo&&(this.__fbo.destroy(),this.__srcLDRTex.destroy(),this.__srcCDMTex.destroy()),this.__unpackHDRShader&&this.__unpackHDRShader.destroy(),this.__shaderBinding&&this.__shaderBinding.destroy(),this.__hdrImage.loaded.disconnectScope(this),this.__hdrImage.updated.disconnectScope(this);}}Ja.setShaderModule("GLSLUtils.glsl","\n\n\nint ftoi(float val){\n    return int(floor(val + 0.5));\n}\n\n#ifdef ENABLE_ES3\n\nint imod(int x, int y) {\n    return x % y;\n}\n\nvoid setFlag(inout int flags, int flag) {\n    flags |= flag;\n}\n\nvoid clearFlag(inout int flags, int flag) {\n    flags &= ~flag;\n}\n\nbool testFlag(int flags, int flag) {\n    return (flags & flag) != 0;\n}\n\n// private function: Mangle me...\nivec2 _pixelIndexToUV(int index, int textureWidth){\n    return ivec2(index % textureWidth, index / textureWidth);\n}\n\nvec4 fetchTexel(sampler2D texture, int textureWidth, int index) {\n    return texelFetch(texture, _pixelIndexToUV(index, textureWidth), 0);\n}\n\nvec4 fetchTexel(sampler2D texture, ivec2 textureSize, ivec2 texCoord) {\n    return texelFetch(texture, texCoord, 0);\n}\n\n#else\n\n// TODO: integrate: https://gist.github.com/mattatz/70b96f8c57d4ba1ad2cd\n\nint max(int a, int b) {\n    return a > b ? a : b;\n}\nint min(int a, int b) {\n    return a < b ? a : b;\n}\n\n\nfloat round(float val){\n    return floor(val + 0.4);\n}\n\nint imod(int x, int y) {\n    return x-y*(x/y);\n}\n\nvoid setFlag(inout int flags, int flag) {\n    flags += flag;\n}\nvoid clearFlag(inout int flags, int flag) {\n    flags -= flag;\n}\n\nbool testFlag(int flags, int flag) {\n    return imod(flags / flag, 2) != 0;\n}\n\n// private function: Mangle me...\nvec2 _pixelIndexToUV(int index, int textureSize){\n    float flTexSize = float(textureSize);\n    float x = (float(imod(index, textureSize))+0.5)/flTexSize;\n    float y = (floor(float(index / textureSize))+0.5)/flTexSize;\n    return vec2(x, y);\n}\n\nvec4 fetchTexel(sampler2D texture, int textureSize, int index) {\n    vec2 texCoord = _pixelIndexToUV(index, textureSize);\n    return texture2D(texture, texCoord);\n}\n\nvec4 fetchTexel(sampler2D texture, ivec2 textureSize, ivec2 texCoord) {\n    vec2 ftextureSize = vec2(textureSize);\n    return texture2D(texture, (vec2(texCoord) + 0.5) / ftextureSize);\n}\n\n\n#endif\n\nint uvToPixelIndex(vec2 uv, int textureSize){\n    return int(uv.x * float(textureSize)) + (int(floor(uv.y * float(textureSize))) * textureSize);\n}\n\n\n\n"),Ja.setShaderModule("utils/ImageStream.glsl","\n\n// Stream Desc looks like the following\n// x : atlas Width in images\n// y : atlas height in images\n// z : image Width\n// w : image Height\n\nvec2 calcFrameImageTexCoords(vec2 texCoord, int index, in vec4 streamDesc){\n\tfloat index_x = floor(mod(float(index), streamDesc.x));\n\tfloat index_y = floor(float(index) / streamDesc.x);\n    return vec2( \n    \t(index_x + texCoord.x) / streamDesc.x, \n    \t(index_y + texCoord.y) / streamDesc.y\n    \t);\n}\n\nvec4 sampleStreamFrame(vec2 texCoord, int index, in sampler2D streamImage, in vec4 streamDesc){\n    return texture2D(streamImage, calcFrameImageTexCoords(texCoord, index, streamDesc));\n}\n\n");class Ba{constructor(e,t){this.__gl=e,this.__streamImage=t,this.ready=new S(!0),this.updated=new S,this.resized=new S,this.__descParam=this.__streamImage.getParameter("StreamAtlasDesc"),this.__indexParam=this.__streamImage.getParameter("StreamAtlasIndex"),this.__indexParam.valueChanged.connect(this.updated.emit);const a=()=>{const t=this.__streamImage.getParams();t.data.__atlasTexture||(t.data.__atlasTexture=new Fa(e,t)),this.__atlasTexture=t.data.__atlasTexture,this.__atlasTexture.textureType=2,this.__atlasTexture.textureDesc=this.__descParam.getValue().asArray();};this.__streamImage.isLoaded()?a():this.__streamImage.loaded.connect(()=>{a();});}preBind(e,t){const a=this.__atlasTexture.preBind(e,t);return a.textureDescUnif=t[e.name+"Desc"],a.textureIndexUnif=t[e.name+"Index"],a}bindToUniform(e,t,a){return !!this.__atlasTexture.bindToUniform(e,t,a)&&(a&&a.textureIndexUnif&&this.__gl.uniform1i(a.textureIndexUnif.location,this.__indexParam.getValue()),!0)}}class Da{constructor(e,t,a,i){switch(this.__unif=i,i.type){case Boolean:this.uniformXX=e.uniform1i.bind(e);break;case 4:"webgl2"==e.name?this.uniformXX=e.uniform1ui.bind(e):this.uniformXX=e.uniform1i.bind(e);break;case 5:this.uniformXX=e.uniform1i.bind(e);break;case 6:this.uniformXX=e.uniform1f.bind(e);}this.__val=a.getValue(),a.valueChanged.connect(()=>{this.__val=a.getValue(),t.updated.emit();});}bind(e){this.uniformXX(this.__unif.location,this.__val);}unbind(){}destroy(){}}class Oa{constructor(e,t,a,i){switch(this.__unif=i,i.type){case o:this.uniformXX=e.uniform2fv.bind(e);break;case d:this.uniformXX=e.uniform3fv.bind(e);break;case h:this.uniformXX=e.uniform4fv.bind(e);}this.__vals=a.getValue().asArray(),a.valueChanged.connect(()=>{this.__vals=a.getValue().asArray(),t.updated.emit();});}bind(e){this.uniformXX(this.__unif.location,this.__vals);}unbind(){}destroy(){}}class Qa{constructor(e,t,a,i){switch(this.__unif=i,i.type){case Mat3:this.uniformMatrixXXX=e.uniformMatrix3fv.bind(e);break;case _:this.uniformMatrixXXX=e.uniformMatrix4fv.bind(e);}this.__vals=a.getValue().asArray(),a.valueChanged.connect(()=>{this.__val=a.getValue().asArray(),t.updated.emit();});}bind(e){this.uniformMatrixXXX(this.__unif.location,!1,this.__val);}unbind(){}destroy(){}}class Aa{constructor(e,t,a,i,s){this.__gl=e,this.__unif=i,this.__textureUnif=s[i.name+"Tex"],this.__textureTypeUnif=s[i.name+"TexType"],this.__vals=[0,0,0,0],this.bind=this.bindValue;const n=e=>{let a=e.getMetadata("gltexture");a||(a="FLOAT"===e.type?new ka(this.__gl,e):e.isStreamAtlas()?new Ba(this.__gl,e):new Fa(this.__gl,e)),this.texBinding=a.preBind(this.__textureUnif,s),a.updated.connect(()=>{t.updated.emit();}),this.gltexture=a,this.gltexture.addRef(this),this.textureType=1,this.bind=this.bindTexture,t.updated.emit();};let l,r;const o=()=>{n(l);},d=e=>{e.isLoaded()?n(e):e.loaded.connect(o),l=e;},h=()=>{l.getMetadata("gltexture").removeRef(this),this.texBinding=null,this.gltexture=null,this.textureType=null,this.bind=this.bindValue,r&&l.loaded.disconnectId(r),l=null,r=null,t.updated.emit();},c=()=>{const e=a.getValue(!1);if(this.__vals=e.asArray(),this.__textureUnif){let e;a.getImage&&(e=a.getImage()),e&&e!=l?d(e):!e&&l&&h();}t.updated.emit();};c(),a.textureConnected&&a.textureConnected.connect(()=>{d(a.getImage());}),a.valueChanged.connect(c),this.uniform1i=e.uniform1i.bind(e),this.uniform4fv=e.uniform4fv.bind(e);}bindValue(e){this.uniform4fv(this.__unif.location,this.__vals),this.__textureTypeUnif&&this.uniform1i(this.__textureTypeUnif.location,0);}bindTexture(e){this.gltexture.bindToUniform(e,this.__textureUnif,this.texBinding);}}const ja={};class qa{constructor(e,t,a,i){this.__uniformBindings=[];const s=s=>{const n=s.getName(),l=a[n];if(null!=l)switch(l.type){case Boolean:case 4:case 5:case 6:this.__uniformBindings.push(new Da(e,t,s,l));break;case o:case d:case h:this.__uniformBindings.push(new Oa(e,t,s,l));break;case u:this.__uniformBindings.push(new Aa(e,t,s,l,a));break;case _:this.__uniformBindings.push(new Qa(e,t,s,l));break;default:return void console.warn("Param :"+n+" has unhandled data type:"+l.type)}else if(i){const e=t.getMaterial().getShaderName();ja[e]||(ja[e]={}),ja[e][n]||(console.warn("Material:"+t.getMaterial().getName(),"with Shader ",e,"Param has no unif",n),ja[e][n]=!0);}},n=t.getMaterial().getParameters();for(const e of n)s(e);}bind(e){for(const t of this.__uniformBindings)t.bind(e);return !0}unbind(){for(const e of this.__uniformBindings)e.unbind(renderstate);}destroy(){for(const e of this.__uniformBindings)e.destroy(renderstate);}}class $a{constructor(e,t,a){this.__gl=e,this.__material=t,this.__glshader=a,this.updated=new S,this.__shaderBindings={};}getMaterial(){return this.__material}getGLShader(){return this.__glshader}generateShaderBinding(){const e=this.__material.getParameters();for(const t of e)bindParam(gl,t);}bind(e,t){this.__boundTexturesBeforeMaterial=e.boundTextures;let a=this.__shaderBindings[e.shaderkey];if(!a){const i=this.__gl;a=new qa(i,this,e.unifs,t),this.__shaderBindings[e.shaderkey]=a;}return a.bind(e)}unbind(e){e.boundTextures=this.__boundTexturesBeforeMaterial;}}class ei{constructor(e,t){this.resized=new S,this.updated=new S,this.__gl=e,this.textureTargets=[],this.depthTexture=null,t&&this.configure(t);}configure(e){const t=this.__gl,a=function(e,t){if(!t.width||!t.height)throw new Error("Invalid texture params");const a=e.getParameter(e.MAX_TEXTURE_SIZE);if(t.width<=0||t.width>a||t.height<=0||t.height>a)throw new Error("GLTextureParams: Invalid texture size. width:"+t.width+" height:"+t.height+" maxSize:"+a);const i={width:t.width,height:t.height},s=(a,s)=>{a in t?i[a]=isNaN(t[a])?e[t[a]]:t[a]:s&&(i[a]=s);};if(s("format"),s("internalFormat",i.format),s("type",e.UNSIGNED_BYTE),s("minFilter",e.LINEAR),s("magFilter",e.LINEAR),s("wrapS",e.CLAMP_TO_EDGE),s("wrapT",e.CLAMP_TO_EDGE),s("flipY",!1),s("mipMapped",!1),s("depthFormat"),s("depthType"),i.format==e.FLOAT)if("webgl2"==e.name)i.filter!=e.LINEAR||e.__ext_float_linear||(console.warn("Floating point texture filtering not supported on result device"),i.filter=e.NEAREST);else if(e.__ext_float)i.filter!=e.LINEAR||e.__ext_float_linear||(console.warn("Floating point texture filtering not supported on result device"),i.filter=e.NEAREST);else {if(!e.__ext_half_float)throw new Error("OES_texture_half_float is not available");i.format=e.HALF_FLOAT,i.filter!=e.LINEAR||e.__ext_texture_half_float_linear||(console.warn("Half Float texture filtering not supported on result device"),i.filter=e.NEAREST);}else if(i.format==e.HALF_FLOAT)if("webgl2"==e.name);else {if(!e.__ext_half_float)throw new Error("OES_texture_half_float is not available");if(i.filter!=e.LINEAR||e.__ext_texture_half_float_linear||(console.warn("Half Float texture filtering not supported on result device"),i.filter=e.NEAREST),i.channels==e.RGB)throw new Error("OES_texture_half_float onlysupports RGBA textures")}else if("sRGB"==i.format&&!e.__ext_sRGB)throw new Error("EXT_sRGB is not available");return null!=i.format&&"webgl2"==e.name&&i.internalFormat==i.format&&(i.type==e.FLOAT?i.format==e.RED||i.format==e.RED?i.internalFormat=e.R32F:i.format==e.RG?i.internalFormat=e.RG32F:i.format==e.RGBA&&(i.internalFormat=e.RGBA32F):i.type==e.HALF_FLOAT?i.format==e.RED?i.internalFormat=e.R16F:i.format==e.RGB?i.internalFormat=e.RGB16F:i.format==e.RGBA&&(i.internalFormat=e.RGBA16F):i.type==e.UNSIGNED_BYTE&&(i.format==e.RED&&(i.internalFormat=e.R8),i.format==e.RGB?i.internalFormat=e.RGB8:i.format==e.RGBA&&(i.internalFormat=e.RGBA8))),null!=i.depthFormat&&("webgl2"==e.name?i.depthType==e.UNSIGNED_SHORT?i.depthInternalFormat=e.DEPTH_COMPONENT16:i.depthType==e.UNSIGNED_INT&&(i.depthInternalFormat=e.UNSIGNED_INT):i.depthInternalFormat=i.depthFormat),i}(t,e);this.textureTargets.forEach(e=>{t.deleteTexture(e);}),this.textureTargets=[],this.depthTexture&&(t.deleteTexture(this.depthTexture),this.depthTexture=null),this.frameBuffer&&t.deleteFramebuffer(this.frameBuffer),this.type=a.type,this.format=a.format,this.internalFormat=a.internalFormat,this.filter=a.filter,this.wrap=a.wrap,this.flipY=a.flipY,this.width=a.width,this.height=a.height,this.clearColor=new u(0,0,0,0),this.colorMask=[!0,!0,!0,!0],this.textureType=1,this.textureDesc=[this.width,this.height,0,0];const i=null!=e.numColorChannels?e.numColorChannels:null!=a.format?1:0;for(let e=0;e<i;e++){t.activeTexture(t.TEXTURE0+1);const e=t.createTexture();t.bindTexture(t.TEXTURE_2D,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,a.wrapS),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,a.wrapT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,a.minFilter),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,a.magFilter),t.texImage2D(t.TEXTURE_2D,0,this.internalFormat,a.width,a.height,0,this.format,this.type,null),this.textureTargets.push(e);}if(a.depthFormat){if("webgl"==t.name&&!t.__ext_WEBGL_depth_texture)throw new Error("Depth textures not support on this device");t.activeTexture(t.TEXTURE0),this.depthTexture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this.depthTexture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,a.wrapS),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,a.wrapT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,a.minFilter),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,a.magFilter),t.texImage2D(t.TEXTURE_2D,0,a.depthInternalFormat,a.width,a.height,0,a.depthFormat,a.depthType,null);}if(this.frameBuffer=t.createFramebuffer(),"webgl2"==t.name?t.bindFramebuffer(t.DRAW_FRAMEBUFFER,this.frameBuffer):t.bindFramebuffer(t.FRAMEBUFFER,this.frameBuffer),this.textureTargets.length>0){if(this.textureTargets.length>1&&"webgl"==t.name&&!t.drawBuffers){t.__ext_draw_buffers=t.getExtension("WEBGL_draw_buffers"),t.drawBuffers=t.__ext_draw_buffers.drawBuffersWEBGL.bind(t.__ext_draw_buffers);for(let e=1;e<14;e++)t["COLOR_ATTACHMENT"+e]=t.__ext_draw_buffers["COLOR_ATTACHMENT"+e+"_WEBGL"];t.MAX_COLOR_ATTACHMENTS=t.__ext_draw_buffers.MAX_COLOR_ATTACHMENTS_WEBGL,t.MAX_DRAW_BUFFERS=t.__ext_draw_buffers.MAX_DRAW_BUFFERS_WEBGL;}const e=[];for(let a=0;a<this.textureTargets.length;a++)t.framebufferTexture2D(t.DRAW_FRAMEBUFFER,t.COLOR_ATTACHMENT0+a,t.TEXTURE_2D,this.textureTargets[a],0),e.push(t.COLOR_ATTACHMENT0+a);this.textureTargets.length>1&&t.drawBuffers(e);}this.depthTexture&&t.framebufferTexture2D(t.DRAW_FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.TEXTURE_2D,this.depthTexture,0);const s=t.checkFramebufferStatus(t.DRAW_FRAMEBUFFER);if(s!=t.FRAMEBUFFER_COMPLETE)switch(s){case t.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw new Error("The attachment types are mismatched or not all framebuffer attachment points are framebuffer attachment complete.");case t.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw new Error("There is no attachment.");case t.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw new Error("Height and width of the attachment are not the same.");case t.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw new Error("The format of the attachment is not supported or if depth and stencil attachments are not the same renderbuffer.");case 36061:throw new Error("The framebuffer is unsupported");default:throw new Error("Incomplete Frambuffer")}this.unbind();}bindForWriting(e,t=!1){e&&(this.__prevBoundFbo=e.boundRendertarget,e.boundRendertarget=this.frameBuffer);const a=this.__gl;"webgl2"==a.name?a.bindFramebuffer(a.DRAW_FRAMEBUFFER,this.frameBuffer):a.bindFramebuffer(a.FRAMEBUFFER,this.frameBuffer),a.viewport(0,0,this.width,this.height),t&&this.clear();}unbindForWriting(e){e&&(e.boundRendertarget=this.__prevBoundFbo);const t=this.__gl;"webgl2"==t.name?t.bindFramebuffer(t.DRAW_FRAMEBUFFER,this.__prevBoundFbo):t.bindFramebuffer(t.FRAMEBUFFER,this.__prevBoundFbo);}clear(e=!0){const t=this.__gl;t.colorMask(...this.colorMask),t.clearColor(...this.clearColor.asArray());let a=0;this.textureTargets.length>0&&(a|=t.COLOR_BUFFER_BIT),this.depthTexture&&(a|=t.DEPTH_BUFFER_BIT),t.clear(a);}bindForReading(){const e=this.__gl;"webgl2"==e.name?e.bindFramebuffer(e.READ_FRAMEBUFFER,this.frameBuffer):e.bindFramebuffer(e.FRAMEBUFFER,this.frameBuffer);}unbindForReading(){const e=this.__gl;"webgl2"==e.name?e.bindFramebuffer(e.READ_FRAMEBUFFER,null):e.bindFramebuffer(e.FRAMEBUFFER,null);}bindColorTexture(e,t,a=0){const i=this.__gl,s=e.boundTextures++;return i.uniform1i(t.location,s),i.activeTexture(i.TEXTURE0+s),i.bindTexture(i.TEXTURE_2D,this.textureTargets[a]),!0}bindDepthTexture(e,t){const a=this.__gl,i=e.boundTextures++;return a.uniform1i(t.location,i),a.activeTexture(a.TEXTURE0+i),a.bindTexture(a.TEXTURE_2D,this.depthTexture),!0}unbind(){const e=this.__gl;e.bindFramebuffer(e.DRAW_FRAMEBUFFER,null);}resize(e,t,a=!1){}bindToUniform(e,t,a){const i=e.boundTextures++,s=this.__gl.TEXTURE0+i,n=this.__gl;return n.activeTexture(s),n.bindTexture(n.TEXTURE_2D,this.textureTargets[0]),n.uniform1i(t.location,i),a&&(a.textureTypeUnif&&n.uniform1i(a.textureTypeUnif.location,this.textureType),a.textureDescUnif&&this.__gl.uniform4fv(a.textureDescUnif.location,this.textureDesc)),!0}destroy(){const e=this.__gl;this.textureTargets.forEach(t=>{e.deleteTexture(t);}),this.textureTargets=[],this.depthTexture&&(e.deleteTexture(this.depthTexture),this.depthTexture=null),this.frameBuffer&&e.deleteFramebuffer(this.frameBuffer);}}const ti=new Uint32Array(1);function ai(e){return ti[0]=e,ti[0]=(ti[0]<<16|ti[0]>>16)>>>0,ti[0]=(1431655765&ti[0])<<1|(2863311530&ti[0])>>>1>>>0,ti[0]=(858993459&ti[0])<<2|(3435973836&ti[0])>>>2>>>0,ti[0]=(252645135&ti[0])<<4|(4042322160&ti[0])>>>4>>>0,ti[0]=(16711935&ti[0])<<8|(4278255360&ti[0])>>>8>>>0,2.3283064365386963e-10*ti[0]}function ii(e,t){return [e/t,ai(e)]}Ja.setShaderModule("utils/imageAtlas.glsl","\n\n// Note: On mobile, I can't seem to pass around a stuct containing sampler2D.\n// I have to unpack the struct and pass its members. :(\n// struct ImageAtlas {\n//     sampler2D layout;\n//     sampler2D image;\n//     vec4 desc;\n// };\n\n\n\nvec4 getSubImageLayout(int index, in sampler2D atlasLayout, in vec4 atlasDesc){\n    return fetchTexel(atlasLayout, int(floor(atlasDesc.z+0.5)), index);\n}\n\nvec2 calcSubImageTexCoords(vec2 texCoord, int index, in sampler2D atlasLayout, in vec4 atlasDesc){\n    vec4 layoutData = fetchTexel(atlasLayout, int(floor(atlasDesc.z+0.5)), index);\n    // The following line is a hack to fix artifacts in our PBR lighting\n    // We were seeing loads of lighting garbage on some sufaces that were orthogonal\n    // to the world. The UV coordinates would have been landing right on the edges\n    // of our subimages and were often sampling outside the image. This couuld\n    // have been because of filtering, or an error in the uv coords. \n    texCoord = clamp(texCoord, vec2(0.01, 0.01), vec2(0.99, 0.99));\n    vec2 subimageTexel = texCoord * layoutData.zw;\n    // subimageTexel = clamp(subimageTexel, vec2(0.0, 0.0), vec2(1.0, 1.0));\n    return subimageTexel + layoutData.xy;\n}\n\nvec4 sampleSubImage(vec2 texCoord, int index, in sampler2D atlasLayout, in sampler2D atlasImage, in vec4 atlasDesc){\n    vec4 layoutData = fetchTexel(atlasLayout, int(floor(atlasDesc.z+0.5)), index);\n    vec2 atlasCoords = calcSubImageTexCoords(texCoord, index, atlasLayout, atlasDesc);\n    return texture2D(atlasImage, atlasCoords);\n}\n\n");class si extends Pa{constructor(e){super(e),this.__shaderStages.VERTEX_SHADER=Ja.parseShader("AtlasLayoutShader.vertexShader",'\n\nprecision highp float;\n\n<%include file="utils/quadVertexFromID.glsl"/>\n\nuniform vec2 pos;\nuniform vec2 size;\nuniform vec2 srctextureDim;\nconst int border = 2;\n\n/* VS Outputs */\nvarying vec2 v_texCoord;\n \nvoid main()\n{\n  vec2 position = getQuadVertexPositionFromID();\n  v_texCoord = position+0.5;\n  gl_Position = vec4(vec2(-1.0, -1.0) + (pos * 2.0) + (v_texCoord * size * 2.0), 0.0, 1.0);\n\n  vec2 borderVec2 = vec2(float(border), float(border));\n  v_texCoord *= (srctextureDim + (borderVec2 * 2.0)) / srctextureDim;\n  v_texCoord -= borderVec2 / srctextureDim;\n}\n\n'),this.__shaderStages.FRAGMENT_SHADER=Ja.parseShader("AtlasLayoutShader.fragmentShader","\nprecision highp float;\n\nuniform sampler2D srctexture;\nuniform vec2 srctextureDim;\nuniform bool alphaFromLuminance;\nuniform bool invert;\n\n/* VS Outputs */\nvarying vec2 v_texCoord;\n\nfloat luminanceFromRGB(vec3 rgb) {\n  return 0.2126*rgb.r + 0.7152*rgb.g + 0.0722*rgb.b;\n}\n\n#ifdef ENABLE_ES3\n  out vec4 fragColor;\n#endif\n\nvoid main(void) {\n  vec2 pixelCoord = v_texCoord*srctextureDim;\n  vec2 uv = v_texCoord;\n\n  // Wrap X coords\n  if(pixelCoord.x < 0.0){\n    uv.x += 1.0/srctextureDim.x;\n    uv.y = 1.0 - uv.y;\n  }\n  else if(pixelCoord.x > srctextureDim.x){\n    uv.x -= 1.0/srctextureDim.x;\n    uv.y = 1.0 - uv.y;\n  }\n\n  // Wrap Y coords\n  if(pixelCoord.y < 0.0){\n    uv.y += 1.0/srctextureDim.y;\n    uv.x = 1.0 - uv.x;\n  }\n  else if(pixelCoord.y > srctextureDim.y){\n    uv.y -= 1.0/srctextureDim.y;\n    uv.x = 1.0 - uv.x;\n  }\n\n  vec4 texel = texture2D(srctexture, uv);\n\n#ifndef ENABLE_ES3\n  vec4 fragColor;\n#endif\n\n  // TODO: check why we pre-multiply alphas here.\n  // fragColor = vec4(texel.rgb/texel.a, texel.a);\n\n  if(alphaFromLuminance) {\n    fragColor = vec4(texel.rgb, luminanceFromRGB(texel.rgb));\n  }\n  else {\n    fragColor = texel;\n  }\n  \n  if(invert) {\n    fragColor = vec4(1.0) - fragColor;\n  }\n\n#ifndef ENABLE_ES3\n  gl_FragColor = fragColor;\n#endif\n}\n\n");}}class ni extends ei{constructor(e,t,a="RGBA",i="FLOAT"){super(e),this.__name=t,this.__formatParam=a,this.__typeParam=i,this.clearColor=new u(0,0,0,0),this.__subImages=[],this.__layoutNeedsRegeneration=!1,this.__async=new L,this.loaded=this.__async.ready;}isLoaded(){return 0==this.__async.count}getMainImage(){return this.super}addSubImage(e){if(e instanceof Te){const t=new Fa(this.__gl,e);e.isLoaded()||(this.__async.incAsyncCount(),e.loaded.connect(()=>{this.__async.decAsyncCount();})),e.setMetadata("ImageAtlas_gltex",t),t.addRef(this),e.updated.connect(()=>{this.__layoutNeedsRegeneration=!0,this.renderAtlas();}),this.__subImages.push(t);}else e.addRef(this),this.__subImages.push(e);return this.__layoutNeedsRegeneration=!0,this.__subImages.length-1}removeSubImage(e){let t;if(e instanceof Te){const a=e.getMetadata("ImageAtlas_gltex");t=this.__subImages.indexOf(a),e.deleteMetadata("ImageAtlas_gltex");}else t=this.__subImages.indexOf(e);this.__subImages[t].removeRef(this),this.__subImages.splice(t,1),this.__layoutNeedsRegeneration=!0;}getSubImage(e){return this.__subImages[e]}numSubImages(){return this.__layout?this.__layout.length:this.__subImages.length}generateAtlasLayout(){if(0==this.__subImages.length)return void(this.__layoutNeedsRegeneration=!1);const e=[];this.__subImages.forEach((t,a)=>{e.push({w:t.width+4,h:t.height+4,area:t.width*t.height,index:a});}),e.sort((e,t)=>e.area>t.area?-1:e.area<t.area?1:0);const t=new W;t.fit(e),this.__layout=[],e.forEach((e,t)=>{e.fit?this.__layout[e.index]={pos:new o(e.fit.x+2,e.fit.y+2),size:new o(e.w,e.h)}:console.warn("Unable to fit image");});const a=t.root.w,i=t.root.h;this.configure({width:a,height:i,format:"FLOAT"==this.__typeParam&&"RGB"==this.__formatParam?"RGBA":this.__formatParam,type:this.__typeParam,filter:"LINEAR"});const s=this.__gl;if(s.__quadVertexIdsBuffer||s.setupInstancedQuad(),!s.__atlasLayoutShader){s.__atlasLayoutShader=new si(s);const e=s.__atlasLayoutShader.compileForTarget("GLImageAtlas");s.__atlasLayoutShaderBinding=Ya(s,e.attrs,s.__quadattrbuffers,s.__quadIndexBuffer);}let n=Math.round(Math.sqrt(1*this.__layout.length)+.5);if(n=Math.nextPow2(n),n%1!=0&&(n+=1-n%1),s.floatTexturesSupported){const e=new Float32Array(n*n*4);for(let t=0;t<this.__layout.length;t++){const s=this.__layout[t];h.createFromFloat32Buffer(e.buffer,4*t).set(s.pos.x/a,s.pos.y/i,s.size.x/a,s.size.y/i);}this.__atlasLayoutTexture&&this.__atlasLayoutTexture.width==n&&this.__atlasLayoutTexture.height==n?this.__atlasLayoutTexture.bufferData(e,n,n):(this.__atlasLayoutTexture&&this.__atlasLayoutTexture.destroy(),this.__atlasLayoutTexture=new Fa(s,{format:"RGBA",type:"FLOAT",filter:"NEAREST",wrap:"CLAMP_TO_EDGE",mipMapped:!1,width:n,height:n,data:e}));}else this.__layoutVec4s=[],this.__layout.forEach((e,t)=>{this.__layoutVec4s[t]=[e.pos.x/a,e.pos.y/i,e.size.x/a,e.size.y/i];});this.__layoutNeedsRegeneration=!1;}getLayoutData(e){return this.__layoutVec4s[e]}renderAtlas(e=!1,t=0){if(0==this.__subImages.length)return;this.__layoutNeedsRegeneration&&this.generateAtlasLayout();const a=this.__gl,i={};this.bindForWriting(i,!0),a.__atlasLayoutShader.bind(i,"GLImageAtlas"),a.__atlasLayoutShaderBinding.bind(i);const s=new o(1/this.width,1/this.height),n=i.unifs;for(let e=t;e<this.__subImages.length;e++){const t=this.__subImages[e],l=this.__layout[e];t.bindToUniform(i,n.srctexture),a.uniform2fv(n.pos.location,l.pos.multiply(s).asArray()),a.uniform2fv(n.size.location,l.size.multiply(s).asArray()),a.uniform2f(n.srctextureDim.location,t.width,t.height),a.uniform1i(n.alphaFromLuminance.location,t.alphaFromLuminance),a.uniform1i(n.invert.location,t.invert),a.drawQuad(),i.boundTextures--;}e&&this.cleanup(),this.unbind(i),this.updated.emit();}isReady(){return null!=this.__atlasLayoutTexture}bindToUniform(e,t){if(!this.__atlasLayoutTexture)return !1;super.bindToUniform(e,t);const a=e.unifs,i=a[t.name+"_layout"];i&&this.__atlasLayoutTexture.bindToUniform(e,i);const s=a[t.name+"_desc"];return s&&this.__gl.uniform4f(s.location,this.width,this.height,this.__atlasLayoutTexture.width,0),!0}cleanup(){for(const e of this.__subImages)e.removeRef(this);this.__subImages=[],this.destroy();}destroy(){this.cleanup(),super.destroy();}}class li extends Pa{constructor(e){super(e),this.__shaderStages.VERTEX_SHADER=Ja.parseShader("ConvolverShader.vertexShader",'\nprecision highp float;\n\n<%include file="utils/quadVertexFromID.glsl"/>\n\n/* VS Outputs */\nvarying vec2 v_texCoord;\n \nvoid main()\n{\n  vec2 position = getQuadVertexPositionFromID();\n  v_texCoord = position+0.5;\n  gl_Position = vec4(position*2.0, 0.0, 1.0);\n}\n'),this.__shaderStages.FRAGMENT_SHADER=Ja.parseShader("ConvolverShader.fragmentShader",'\nprecision highp float;\n\n<%include file="math/constants.glsl"/>\n<%include file="GLSLUtils.glsl"/>\n<%include file="utils/imagePyramid.glsl"/>\n<%include file="pragmatic-pbr/envmap-octahedral.glsl"/>\n\nuniform float roughness;\nvarying vec2 v_texCoord;\n\nuniform sampler2D hammersleyMap;\nvec2 Hammersley(int i, int N) {\n  vec4 rgba =  texture2D(hammersleyMap, vec2((float(i) + 0.5)/float(N)), 0.5);\n  return rgba.rg;\n}\n\nmat3 matrixFromVector(vec3 n) { // frisvad\n  float a = 1.0 / (1.0 + n.z);\n  float b = -n.x * n.y * a;\n  vec3 b1 = vec3(1.0 - n.x * n.x * a, b, -n.x);\n  vec3 b2 = vec3(b, 1.0 - n.y * n.y * a, -n.y);\n  return mat3(b1, b2, n);\n}\n\nvec3 ImportanceSampleGGX(vec2 Xi, float a) {\n  float phi = 2.0 * PI * Xi.x;\n  float cos_theta = sqrt((1.0 - Xi.y)/(1.0 + (a*a - 1.0) * Xi.y));\n  float sin_theta = sqrt(1.0 - cos_theta * cos_theta);\n\n  // float phi = Xi.y * 2.0 * PI;\n  // float cos_theta = sqrt(1.0 - Xi.x);\n  // float sin_theta = sqrt(1.0 - cos_theta * cos_theta);\n\n  vec3 H;\n  H.x = sin_theta * cos(phi);\n  H.y = sin_theta * sin(phi);\n  H.z = cos_theta;\n  return H;\n}\n\n// TODO: use tobias\'s code. The guy clearly knows what he\'s doing...\n// https://github.com/thefranke/dirtchamber/blob/master/shader/importance.hlsl\n// Compute a LOD level for filtered importance sampling.\n// From GPU Gems 3: GPU-Based Importance Sampling.\n\n\n#define M_PI       3.14159265358979323846   // pi\n#define M_HALF_PI  1.57079632679489661923   // pi/2\nfloat sqr(float val){ return val*val; }\nfloat saturate(float val) { return clamp(val, 0.0, 1.0); }\nvec3 saturate(vec3 val) { return clamp(val, 0.0, 1.0); }\n\n// Microfacet Models for Refraction through Rough Surfaces\n// Walter et al.\n// http://www.cs.cornell.edu/~srm/publications/EGSR07-btdf.html\n// aka Towbridge-Reitz\nfloat D_ggx(in float alpha, in float NoH)\n{\n  float a2 = alpha*alpha;\n  float cos2 = NoH*NoH;\n\n  return (1.0/M_PI) * sqr(alpha/(cos2 * (a2 - 1.0) + 1.0));\n\n  /*\n  // version from the paper, eq 33\n  float CosSquared = NoH*NoH;\n  float TanSquared = (1.0 - CosSquared)/CosSquared;\n  return (1.0/M_PI) * sqr(alpha/(CosSquared * (alpha*alpha + TanSquared)));\n  */\n}\nfloat compute_lod(in vec3 H, in float pdf, in int num_samples, in int ww, in int hh)\n{\n  return max(0.0, 0.5*log2(float(ww*hh)/float(num_samples)) - 0.5*log2(pdf));\n}\n\nuniform sampler2D   envMapPyramid;\nuniform sampler2D   envMapPyramid_layout;\nuniform vec4        envMapPyramid_desc;\n\n#ifdef ENABLE_ES3\n  out vec4 fragColor;\n#endif\nvoid main(void) {\n#ifndef ENABLE_ES3\n  vec4 fragColor;\n#endif\n\n  vec3 N = sphOctUvToDir(v_texCoord);\n\n  if(false){\n    vec2 uv = dirToSphOctUv(N);\n    // fragColor = vec4(uv.x, uv.y, 0.0, 1.0);\n    fragColor = sampleImagePyramid(uv, 0.5, envMapPyramid_layout, envMapPyramid, envMapPyramid_desc);\n    // fragColor = sampleSubImage(uv, 0, envMapPyramid_layout, envMapPyramid, envMapPyramid_desc);\n    // fragColor = texture2D(envMapPyramid, uv);\n  }\n  else{\n    const int numSamples = NUM_SAMPLES;\n    int w = int(floor(envMapPyramid_desc.x + 0.5));\n    int h = int(floor(envMapPyramid_desc.y + 0.5));\n\n    vec4 color = vec4(0.0,0.0,0.0,0.0);\n    float weight = 0.0;\n    mat3 vecSpace = matrixFromVector(N);\n    float a = roughness*roughness;\n    for(int i=0; i<numSamples; i++) {\n      vec2 Xi = Hammersley(i, numSamples);\n      vec3 H = ImportanceSampleGGX(Xi, a);\n      vec3 V = normalize(vecSpace * H);\n      float VdotN = dot(V, N);\n      float NoH = saturate( dot( N, H ) );\n      float VoH = saturate( dot( V, H ) );\n\n      vec2 uv = dirToSphOctUv(V);\n      // float pdf = D_ggx(a, NoH) * NoH / (4.0 * VoH);\n      // float lod = compute_lod(H, pdf, numSamples, w, h);\n\n      color += sampleImagePyramid(uv, a, envMapPyramid_layout, envMapPyramid, envMapPyramid_desc) * VdotN;\n      weight += VdotN;\n    }\n    color /= float(weight);\n    fragColor = vec4(color.rgb, 1.0);\n  }\n  \n#ifndef ENABLE_ES3\n  gl_FragColor = fragColor;\n#endif\n}\n\n');}}Ja.setShaderModule("utils/imagePyramid.glsl",'\n\n<%include file="utils/imageAtlas.glsl"/>\n\nvec4 sampleImagePyramid(vec2 uv, float lod, in sampler2D atlasLayout, in sampler2D atlasImage, in vec4 atlasDesc){\n  if (lod < 0.00001 || lod > 0.9999) {\n    float imageIndex = lod * (atlasDesc.z-1.0);\n    int imageId0 = int(imageIndex);\n    return sampleSubImage(uv, imageId0, atlasLayout, atlasImage, atlasDesc);\n  } else {\n    float imageIndex = lod * (atlasDesc.z-1.0);\n    int imageId0 = int(floor(imageIndex));\n    int imageId1 = imageId0+1;\n    float blend = fract(imageIndex);\n    vec4 c0 = sampleSubImage(uv, imageId0, atlasLayout, atlasImage, atlasDesc);\n    vec4 c1 = sampleSubImage(uv, imageId1, atlasLayout, atlasImage, atlasDesc);\n    return mix(c0, c1, blend);\n  } \n}\n\n\n');class ri extends ni{constructor(e,t,a,i=!0,s=16){super(e,t),this.__srcGLTex=a,this.__fbos=[],a.updated.connect(()=>{this.renderAtlas(i);}),this.__srcGLTex.isLoaded()?(this.generateAtlasLayout(s),this.renderAtlas(i)):this.__srcGLTex.updated.connect(()=>{this.generateAtlasLayout(s),this.renderAtlas(i);});}generateAtlasLayout(e){const t=this.__gl;this.size=this.__srcGLTex.height;const a=this.__srcGLTex.width/this.__srcGLTex.height;this.addSubImage(this.__srcGLTex);for(let i=Math.round(function(e){return Math.log2(e)}(this.size))-1;i>=0;--i){const s=Math.pow(2,i);if(s<e)break;const n=new Fa(t,{format:this.__srcGLTex.getFormat(),type:this.__srcGLTex.getType(),width:s*a,height:s,filter:"LINEAR",wrap:"CLAMP_TO_EDGE"});this.addSubImage(n),this.__fbos.push(new Ha(t,n));}super.generateAtlasLayout();}renderAtlas(e=!0){const t=this.__gl,a={};t.screenQuad.bindShader(a);for(let e=0;e<this.__fbos.length;e++)this.__fbos[e].bindAndClear(),t.screenQuad.draw(a,this.getSubImage(e));super.renderAtlas(e);}destroy(){super.destroy();for(const e of this.__fbos)e.destroy();}}class oi extends ni{constructor(e,t){super(e,t),this.__gl=e,e.__quadVertexIdsBuffer||e.setupInstancedQuad(),this.__convolved=!1,this.__fbos=[];}generateHammersleySamples(e){const t=this.__gl;if(!t["Hammersley"+e]){const a=new Float32Array(3*e);for(let t=0;t<e;t++){const i=ii(t,e),s=3*t;a[s+0]=i[0],a[s+1]=i[1];}t["Hammersley"+e]=new Fa(t,{format:"RGB",type:"FLOAT",filter:"NEAREST",wrap:"CLAMP_TO_EDGE",width:e,height:1,data:a,mipMapped:!1});}return t["Hammersley"+e]}convolveProbe(e){const t=this.__gl,a=this.generateHammersleySamples(1024);if(!this.__convolved){this.__lodPyramid||(this.__lodPyramid=new ri(t,"Probe Lods",e,!1),this.__lodPyramid.updated.connect(()=>{this.convolveProbe(e);})),this.addSubImage(e);let a=[e.width/2,e.height/2];const i=6;for(let e=0;e<i;e++){const e=new Fa(t,{format:"RGBA",type:"FLOAT",filter:"LINEAR",wrap:"CLAMP_TO_EDGE",width:a[0],height:a[1]});this.addSubImage(e);const i=new Ha(t,e);i.setClearColor([0,1,0,0]),this.__fbos.push(i),a=[a[0]/2,a[1]/2];}this.generateAtlasLayout(),this.__convolverShader=new li(t);const s=this.__convolverShader.compileForTarget("GLProbe",Object.assign({repl:{NUM_SAMPLES:1024}},t.shaderopts));this.__covolverShaderBinding=Ya(t,s.attrs,t.__quadattrbuffers,t.__quadIndexBuffer);}const i={};this.__convolverShader.bind(i,"GLProbe"),this.__covolverShaderBinding.bind(i);const s=i.unifs;for(let e=0;e<this.__fbos.length;e++){if(this.__fbos[e].bindAndClear(),this.__lodPyramid.bindToUniform(i,s.envMapPyramid),"hammersleyMap"in s&&a.bindToUniform(i,s.hammersleyMap),"roughness"in s){const a=(e+1)/this.__fbos.length;t.uniform1f(s.roughness.location,a);}t.drawQuad();}this.__convolved=!0,this.renderAtlas(!1);}bindProbeToUniform(e,t){this.__convolved&&super.bindToUniform(e,t);}destroy(){super.destroy(),this.__convolverShader.destroy();for(const e of this.__fbos)e.destroy();}}Ja.setShaderModule("stack-gl/inverse.glsl","\n\n\n#ifndef ENABLE_ES3\n\nfloat inverse(float m) {\n  return 1.0 / m;\n}\n\nmat2 inverse(mat2 m) {\n  return mat2(m[1][1],-m[0][1],\n             -m[1][0], m[0][0]) / (m[0][0]*m[1][1] - m[0][1]*m[1][0]);\n}\n\nmat3 inverse(mat3 m) {\n  float a00 = m[0][0], a01 = m[0][1], a02 = m[0][2];\n  float a10 = m[1][0], a11 = m[1][1], a12 = m[1][2];\n  float a20 = m[2][0], a21 = m[2][1], a22 = m[2][2];\n\n  float b01 = a22 * a11 - a12 * a21;\n  float b11 = -a22 * a10 + a12 * a20;\n  float b21 = a21 * a10 - a11 * a20;\n\n  float det = a00 * b01 + a01 * b11 + a02 * b21;\n\n  return mat3(b01, (-a22 * a01 + a02 * a21), (a12 * a01 - a02 * a11),\n              b11, (a22 * a00 - a02 * a20), (-a12 * a00 + a02 * a10),\n              b21, (-a21 * a00 + a01 * a20), (a11 * a00 - a01 * a10)) / det;\n}\n\nmat4 inverse(mat4 m) {\n  float\n      a00 = m[0][0], a01 = m[0][1], a02 = m[0][2], a03 = m[0][3],\n      a10 = m[1][0], a11 = m[1][1], a12 = m[1][2], a13 = m[1][3],\n      a20 = m[2][0], a21 = m[2][1], a22 = m[2][2], a23 = m[2][3],\n      a30 = m[3][0], a31 = m[3][1], a32 = m[3][2], a33 = m[3][3],\n\n      b00 = a00 * a11 - a01 * a10,\n      b01 = a00 * a12 - a02 * a10,\n      b02 = a00 * a13 - a03 * a10,\n      b03 = a01 * a12 - a02 * a11,\n      b04 = a01 * a13 - a03 * a11,\n      b05 = a02 * a13 - a03 * a12,\n      b06 = a20 * a31 - a21 * a30,\n      b07 = a20 * a32 - a22 * a30,\n      b08 = a20 * a33 - a23 * a30,\n      b09 = a21 * a32 - a22 * a31,\n      b10 = a21 * a33 - a23 * a31,\n      b11 = a22 * a33 - a23 * a32,\n\n      det = b00 * b11 - b01 * b10 + b02 * b09 + b03 * b08 - b04 * b07 + b05 * b06;\n\n  return mat4(\n      a11 * b11 - a12 * b10 + a13 * b09,\n      a02 * b10 - a01 * b11 - a03 * b09,\n      a31 * b05 - a32 * b04 + a33 * b03,\n      a22 * b04 - a21 * b05 - a23 * b03,\n      a12 * b08 - a10 * b11 - a13 * b07,\n      a00 * b11 - a02 * b08 + a03 * b07,\n      a32 * b02 - a30 * b05 - a33 * b01,\n      a20 * b05 - a22 * b02 + a23 * b01,\n      a10 * b10 - a11 * b08 + a13 * b06,\n      a01 * b08 - a00 * b10 - a03 * b06,\n      a30 * b04 - a31 * b02 + a33 * b00,\n      a21 * b02 - a20 * b04 - a23 * b00,\n      a11 * b07 - a10 * b09 - a12 * b06,\n      a00 * b09 - a01 * b07 + a02 * b06,\n      a31 * b01 - a30 * b03 - a32 * b00,\n      a20 * b03 - a21 * b01 + a22 * b00) / det;\n}\n\n#endif\n\n"),Ja.setShaderModule("stack-gl/transpose.glsl","\n\n\n#ifndef ENABLE_ES3\n\nfloat transpose(float m) {\n  return m;\n}\n\nmat2 transpose(mat2 m) {\n  return mat2(m[0][0], m[1][0],\n              m[0][1], m[1][1]);\n}\n\nmat3 transpose(mat3 m) {\n  return mat3(m[0][0], m[1][0], m[2][0],\n              m[0][1], m[1][1], m[2][1],\n              m[0][2], m[1][2], m[2][2]);\n}\n\nmat4 transpose(mat4 m) {\n  return mat4(m[0][0], m[1][0], m[2][0], m[3][0],\n              m[0][1], m[1][1], m[2][1], m[3][1],\n              m[0][2], m[1][2], m[2][2], m[3][2],\n              m[0][3], m[1][3], m[2][3], m[3][3]);\n}\n\n#endif\n\n"),Ja.setShaderModule("pragmatic-pbr/envmap-octahedral.glsl","\n\n#define sectorize(value) step(0.0, (value))*2.0-1.0\n#define sum(value) dot(clamp((value), 1.0, 1.0), (value))\n\n\nvec2 dirToSphOctUv(vec3 normal){\n    normal = normalize(normal);\n    vec3 aNorm = abs(normal);\n    vec3 sNorm = sectorize(normal);\n\n    vec2 dir = max(aNorm.xy, 1e-20);\n    float orient = atan(dir.x, dir.y)/HalfPI;\n\n    dir = max(vec2(aNorm.z, length(aNorm.xy)), 1e-20);\n    float pitch = atan(dir.y, dir.x)/HalfPI;\n\n    vec2 uv = vec2(sNorm.x*orient, sNorm.y*(1.0-orient))*pitch;\n\n    if(normal.z < 0.0){\n        uv = sNorm.xy - abs(uv.ts)*sNorm.xy;\n    }\n    return uv*0.5+0.5;\n}\n\n\nvec3 sphOctUvToDir(vec2 uv){\n    uv = uv*2.0-1.0;\n    vec2 suv = sectorize(uv);\n    float sabsuv =  sum(abs(uv));\n    float pitch = sabsuv*HalfPI;\n\n    if (pitch <= 0.0) {\n        return vec3(0.0, 0.0, 1.0);\n    }\n    if (abs(pitch - PI) < 0.000001) {\n        return vec3(0.0, 0.0, -1.0);\n    }\n    if(sabsuv > 1.0){\n        uv = (1.0-abs(uv.ts))*suv;\n    }\n\n    float orient = (abs(uv.s)/sabsuv)*HalfPI;\n    float sOrient = sin(orient);\n    float cOrient = cos(orient);\n    float sPitch = sin(pitch);\n    float cPitch = cos(pitch);\n\n    return vec3(\n        sOrient*suv.s*sPitch,\n        cOrient*suv.t*sPitch,\n        cPitch\n    );\n}\n\n"),Ja.setShaderModule("pragmatic-pbr/envmap-equirect.glsl","\n\n\nvec2 latLongUVsFromDir(vec3 dir) {\n  // Math function taken from...\n  // http://gl.ict.usc.edu/Data/HighResProbes/\n  // Note: Scaling from u=[0,2], v=[0,1] to u=[0,1], v=[0,1]\n  float phi = acos(dir.z);\n  float theta = atan(dir.x, dir.y);\n  return vec2((1.0 + theta / PI) / 2.0, phi / PI);\n}\n\n// Note: when u == 0.5 z = 1.0\nvec3 dirFromLatLongUVs(float u, float v) {\n    // http://gl.ict.usc.edu/Data/HighResProbes/\n    float theta = PI*((u * 2.0) - 1.0);\n    float phi = PI*v;\n    return vec3(sin(phi)*sin(theta), sin(phi)*cos(theta), cos(phi));\n}\n\nvec3 dirFromPolar(vec2 polar) {\n    float u = polar.x / (PI * 2.0);\n    float v = polar.y / PI;\n    return dirFromLatLongUVs(u, v);\n}\n\n"),Ja.setShaderModule("pragmatic-pbr/envmap-dualfisheye.glsl","\n\n\n\nvec2 dualfisheyeUVsFromDir(vec3 dir) {\n  vec2 result;\n  float angle = 0.465;\n    if(dir.x < 0.0) {\n        result = vec2(((dir.z * -angle) + 0.5) * 0.5, (dir.y * angle) + 0.5);\n    }\n    else {\n        result = vec2( 0.5 + ((dir.z * angle) + 0.5) * 0.5, (dir.y * angle) + 0.5);\n    }\n    return result;\n}\n\n\n");class di extends Pa{constructor(e){super(e),this.__shaderStages.VERTEX_SHADER=Ja.parseShader("EnvMapShader.vertexShader",'\nprecision highp float;\n\n<%include file="utils/quadVertexFromID.glsl"/>\n\nuniform mat4 projectionMatrix;\nuniform mat4 viewMatrix;\n\n<%include file="stack-gl/inverse.glsl"/>\n<%include file="stack-gl/transpose.glsl"/>\n\n/* VS Outputs */\nvarying vec3 v_worldDir;\nvarying vec2 v_texCoord;\n \nvoid main()\n{\n  vec2 position = getQuadVertexPositionFromID() * 2.0;\n  v_texCoord = position * 0.5 + 0.5;\n\n  mat4 inverseProjection = inverse(projectionMatrix);\n  mat3 inverseModelview = transpose(mat3(viewMatrix));\n\n  // transform from the normalized device coordinates back to the view space\n  vec3 unprojected = (inverseProjection * vec4(position, 0, 1)).xyz;\n\n  // transfrom from the view space back to the world space\n  // and use it as a sampling vector\n  v_worldDir = inverseModelview * unprojected;\n\n  gl_Position = vec4(position, 0, 1);\n}\n\n');}}class hi extends di{constructor(e){super(e),this.__shaderStages.FRAGMENT_SHADER=Ja.parseShader("LatLongEnvMapShader.fragmentShader",'\nprecision highp float;\n\n<%include file="math/constants.glsl"/>\n<%include file="GLSLUtils.glsl"/>\n<%include file="pragmatic-pbr/envmap-equirect.glsl"/>\n\n#define ENABLE_INLINE_GAMMACORRECTION\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n<%include file="stack-gl/gamma.glsl"/>\nuniform float exposure;\n#endif\n\nuniform sampler2D backgroundImage;\n\n\n/* VS Outputs */\nvarying vec2 v_texCoord;\n\n#ifdef ENABLE_ES3\n  out vec4 fragColor;\n#endif\n\nvoid main(void) {\n#ifndef ENABLE_ES3\n  vec4 fragColor;\n#endif\n\n  vec4 texel = texture2D(backgroundImage, v_texCoord);\n  fragColor = vec4(texel.rgb/texel.a, 1.0);\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n  //fragColor.rgb = toGamma(fragColor.rgb * exposure);\n\n  // Assuming a simple RGB image in gamma space for now.\n  fragColor.rgb = fragColor.rgb * exposure;\n#endif\n\n\n#ifndef ENABLE_ES3\n  gl_FragColor = fragColor;\n#endif\n}\n'),this.finalize();}}class ci extends di{constructor(e){super(e),this.__shaderStages.FRAGMENT_SHADER=Ja.parseShader("OctahedralEnvMapShader.fragmentShader",'\nprecision highp float;\n\n<%include file="math/constants.glsl"/>\n<%include file="GLSLUtils.glsl"/>\n<%include file="pragmatic-pbr/envmap-octahedral.glsl"/>\n<%include file="utils/imagePyramid.glsl"/>\n<%include file="stack-gl/gamma.glsl"/>\n\nuniform float focus;\n\n#define ENABLE_INLINE_GAMMACORRECTION\n#ifdef ENABLE_INLINE_GAMMACORRECTION\nuniform float exposure;\n#endif\n\n// uniform ImageAtlas envMap;\nuniform sampler2D   envMapPyramid;\nuniform sampler2D   envMapPyramid_layout;\nuniform vec4        envMapPyramid_desc;\n\n\n/* VS Outputs */\nvarying vec3 v_worldDir;\nvarying vec2 v_texCoord;\n\n#ifdef ENABLE_ES3\n  out vec4 fragColor;\n#endif\n\nvoid main(void) {\n#ifndef ENABLE_ES3\n  vec4 fragColor;\n#endif\n\n  vec2 uv = dirToSphOctUv(normalize(v_worldDir));\n  if(false){\n    // Use these lines to debug the src GL image.\n    vec4 texel = texture2D(envMapPyramid, uv);\n    fragColor = vec4(texel.rgb/texel.a, 1.0);\n  }\n  else{\n    fragColor = vec4(sampleImagePyramid(uv, focus, envMapPyramid_layout, envMapPyramid, envMapPyramid_desc).rgb, 1.0);\n  }\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n  fragColor.rgb = toGamma(fragColor.rgb * exposure);\n#endif\n\n#ifndef ENABLE_ES3\n  gl_FragColor = fragColor;\n#endif\n}\n'),this.finalize();}}class mi extends di{constructor(e){super(e),this.__shaderStages.FRAGMENT_SHADER=Ja.parseShader("LatLongEnvMapShader.fragmentShader",'\nprecision highp float;\n\n<%include file="math/constants.glsl"/>\n<%include file="GLSLUtils.glsl"/>\n<%include file="pragmatic-pbr/envmap-equirect.glsl"/>\n\n#define ENABLE_INLINE_GAMMACORRECTION\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n<%include file="stack-gl/gamma.glsl"/>\nuniform float exposure;\n#endif\n\nuniform sampler2D backgroundImage;\n\n\n/* VS Outputs */\nvarying vec3 v_worldDir;\nvarying vec2 v_texCoord;\n\n#ifdef ENABLE_ES3\n  out vec4 fragColor;\n#endif\n\nvoid main(void) {\n#ifndef ENABLE_ES3\n  vec4 fragColor;\n#endif\n\n  vec2 uv = latLongUVsFromDir(normalize(v_worldDir));\n\n  vec4 texel = texture2D(backgroundImage, uv);\n  fragColor = vec4(texel.rgb/texel.a, 1.0);\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n  fragColor.rgb = toGamma(fragColor.rgb * exposure);\n#endif\n#ifndef ENABLE_ES3\n  gl_FragColor = fragColor;\n#endif\n}\n'),this.finalize();}static getParamDeclarations(){return super.getParamDeclarations()}}class ui extends di{constructor(e){super(e),this.__shaderStages.FRAGMENT_SHADER=Ja.parseShader("SterioLatLongEnvMapShader.fragmentShader",'\nprecision highp float;\n\n<%include file="math/constants.glsl"/>\n<%include file="GLSLUtils.glsl"/>\n<%include file="pragmatic-pbr/envmap-equirect.glsl"/>\n\n#define ENABLE_INLINE_GAMMACORRECTION\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n<%include file="stack-gl/gamma.glsl"/>\nuniform float exposure;\n#endif\n\nuniform int eye;// L = 0, R = 1;\n\nuniform sampler2D backgroundImage;\n\n/* VS Outputs */\nvarying vec3 v_worldDir;\nvarying vec2 v_texCoord;\n\n#ifdef ENABLE_ES3\n  out vec4 fragColor;\n#endif\n\nvoid main(void) {\n#ifndef ENABLE_ES3\n  vec4 fragColor;\n#endif\n\n  vec2 uv = latLongUVsFromDir(normalize(v_worldDir));\n  uv.y *= 0.5;\n  if(eye == 1){\n    uv.y += 0.5;\n  }\n\n  vec4 texel = texture2D(backgroundImage, uv);\n  fragColor = vec4(texel.rgb/texel.a, 1.0);\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n  //fragColor.rgb = toGamma(fragColor.rgb * exposure);\n\n  // Assuming a simple RGB image in gamma space for now.\n  fragColor.rgb = fragColor.rgb * exposure;\n#endif\n\n#ifndef ENABLE_ES3\n  gl_FragColor = fragColor;\n#endif\n}\n'),this.finalize();}}class bi extends di{constructor(e){super(e),this.__shaderStages.FRAGMENT_SHADER=Ja.parseShader("DualFishEyeEnvMapShader.fragmentShader",'\nprecision highp float;\n\n<%include file="math/constants.glsl"/>\n<%include file="GLSLUtils.glsl"/>\n<%include file="pragmatic-pbr/envmap-dualfisheye.glsl"/>\n\n#define ENABLE_INLINE_GAMMACORRECTION\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n<%include file="stack-gl/gamma.glsl"/>\nuniform float exposure;\n#endif\n\nuniform sampler2D backgroundImage;\n\n/* VS Outputs */\nvarying vec3 v_worldDir;\nvarying vec2 v_texCoord;\n\n#ifdef ENABLE_ES3\n  out vec4 fragColor;\n#endif\n\nvoid main(void) {\n#ifndef ENABLE_ES3\n  vec4 fragColor;\n#endif\n\n  vec2 uv = dualfisheyeUVsFromDir(normalize(v_worldDir));\n\n  vec4 texel = texture2D(backgroundImage, uv);\n  fragColor = vec4(texel.rgb/texel.a, 1.0);\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n  //fragColor.rgb = toGamma(fragColor.rgb * exposure);\n\n  // Assuming a simple RGB image in gamma space for now.\n  fragColor.rgb = fragColor.rgb * exposure;\n#endif\n\n#ifndef ENABLE_ES3\n  gl_FragColor = fragColor;\n#endif\n}\n'),this.finalize();}}class pi extends di{constructor(e){super(e),this.__shaderStages.FRAGMENT_SHADER=Ja.parseShader("DualFishEyeEnvMapShader.fragmentShader",'\nprecision highp float;\n\n<%include file="math/constants.glsl"/>\n<%include file="GLSLUtils.glsl"/>\n<%include file="pragmatic-pbr/envmap-equirect.glsl"/>\n<%include file="pragmatic-pbr/envmap-dualfisheye.glsl"/>\n\n#define ENABLE_INLINE_GAMMACORRECTION\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n<%include file="stack-gl/gamma.glsl"/>\nuniform float exposure;\n#endif\n\nuniform sampler2D backgroundImage;\n\n/* VS Outputs */\nvarying vec3 v_worldDir;\nvarying vec2 v_texCoord;\n\n#ifdef ENABLE_ES3\n  out vec4 fragColor;\n#endif\n\nvoid main(void) {\n#ifndef ENABLE_ES3\n  vec4 fragColor;\n#endif\n\n  vec2 uv = dualfisheyeUVsFromDir(dirFromLatLongUVs(v_texCoord.x, v_texCoord.y));\n  vec4 texel = texture2D(backgroundImage, uv);\n  fragColor = vec4(texel.rgb/texel.a, 1.0);\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n  //fragColor.rgb = toGamma(fragColor.rgb * exposure);\n\n  // Assuming a simple RGB image in gamma space for now.\n  // fragColor.rgb = fragColor.rgb * exposure;\n#endif\n\n#ifndef ENABLE_ES3\n  gl_FragColor = fragColor;\n#endif\n}\n'),this.finalize();}}class gi extends oi{constructor(e,t,a){super(e.gl,"EnvMap"),this.__renderer=e,this.__envMap=t,this.__backgroundFocus=0;const i=e.gl;i.__quadVertexIdsBuffer||i.setupInstancedQuad();let s=this.__envMap.getMetadata("gltexture");s||(s=new ka(i,this.__envMap)),this.__srcGLTex=s,this.__envMapShader=new ci(i);const n=this.__envMapShader.compileForTarget("GLEnvMap",a);this.__envMapShaderBinding=Ya(i,n.attrs,i.__quadattrbuffers,i.__quadIndexBuffer),this.__envMap.isLoaded()?this.convolveProbe(s):this.__envMap.loaded.connect(()=>{this.convolveProbe(s),this.loaded.emit();});}getEnvMap(){return this.__envMap}getBackgroundFocus(){return this.__backgroundFocus}setBackgroundFocus(e){this.__backgroundFocus=e,this.__renderer.requestRedraw();}draw(e){if(this.__envMap.isLoaded()){const t=this.__gl;{this.__envMapShader.bind(e,"GLEnvMap");const a=e.unifs;this.bindProbeToUniform(e,a.envMapPyramid);{const e=a.focus;e&&t.uniform1f(e.location,this.__backgroundFocus);}{const i=a.exposure;i&&t.uniform1f(i.location,e.exposure);}this.__envMapShaderBinding.bind(e),t.depthMask(!1),e.bindViewports(a,()=>{t.drawQuad();});}}}bindToUniform(e,t,a){return this.__srcGLTex.bindToUniform(e,t,a)}destroy(){super.destroy(),this.__srcGLTex.loaded.disconnectScope(this),this.__srcGLTex.updated.disconnectScope(this),this.__srcGLTex.destroy();}}class _i extends Pa{constructor(e){super(e),this.__shaderStages.VERTEX_SHADER=Ja.parseShader("ScreenQuadShader.vertexShader",'\nprecision highp float;\n\n<%include file="utils/quadVertexFromID.glsl"/>\n\nuniform vec2 pos;\nuniform vec2 size;\n\n/* VS Outputs */\nvarying vec2 v_texCoord;\n \nvoid main()\n{\n    vec2 position = getQuadVertexPositionFromID();\n    v_texCoord = position+0.5;\n    gl_Position = vec4(vec2(-1.0, -1.0) + (pos * 2.0) + (v_texCoord * abs(size) * 2.0), 0.0, 1.0);\n    if(size.x < 0.0)\n        v_texCoord.x = 1.0 - v_texCoord.x;\n    if(size.y < 0.0)\n        v_texCoord.y = 1.0 - v_texCoord.y;\n}\n'),this.__shaderStages.FRAGMENT_SHADER=Ja.parseShader("ScreenQuadShader.fragmentShader","\nprecision highp float;\n\nuniform sampler2D image;\n\nvarying vec2 v_texCoord;\n\n\n#ifdef ENABLE_ES3\n    out vec4 fragColor;\n#endif\nvoid main(void) {\n#ifndef ENABLE_ES3\n    vec4 fragColor;\n#endif\n    fragColor = texture2D(image, v_texCoord);\n    fragColor = vec4(fragColor.rgb/fragColor.a, 1.0);\n\n#ifndef ENABLE_ES3\n    gl_FragColor = fragColor;\n#endif\n}\n"),this.finalize();}}class Zi{constructor(e,t){this.__gl=e,this.__pos=[0,0],this.__size=[1,1],this.flipY=!0,this.__glshader=new _i(e),e.__quadVertexIdsBuffer||e.setupInstancedQuad();const a=this.__glshader.compileForTarget("GLScreenQuad",t);this.__quadBinding=Ya(e,a.attrs,e.__quadattrbuffers,e.__quadIndexBuffer),this.ready=!0;}bind(e,t,a,i){const s=e.unifs;t.bindToUniform(e,e.unifs.image);const n=this.__gl;{const e=s.pos;e&&n.uniform2fv(e.location,a?a instanceof l?a.asArray():a:this.__pos);}{const e=s.size;e&&n.uniform2fv(e.location,i?i instanceof l?i.asArray():i:this.__size);}this.__quadBinding.bind(e);}bindShader(e){return this.__glshader.bind(e,"GLScreenQuad")}draw(e,t,a,i){this.bind(e,t,a,i),this.__gl.drawQuad();}destroy(){}}class Gi extends H{constructor(e){super(),this.__renderer=e,this.__doubleClickTimeMSParam=this.addParameter(new ue("DoubleClickTimeMS",200)),this.__fbo=void 0,this.updated=new S,this.resized=new S,this.__renderer.sceneSet.connect(()=>{const t=e.getScene().settings.getParameter("BackgroundColor"),a=e=>{const a=t.getValue();let i=this.__renderer.gl;a instanceof Te?"FLOAT"===a.type?(this.__backgroundTexture=a,this.__backgroundGLTexture=new ka(i,a)):(this.__backgroundTexture=a,this.__backgroundGLTexture=new Fa(i,a)):a instanceof u?(this.__backgroundGLTexture&&(this.__backgroundGLTexture.destroy(),this.__backgroundGLTexture=void 0,this.__backgroundTexture=void 0),this.__backgroundColor=a):console.warn("Invalid background:"+a),this.updated.emit();};a(t.getValue()),t.valueChanged.connect(a);});}getRenderer(){return this.__renderer}getName(){return this.__name}getBl(){return this.__bl}setBl(e){this.__bl=e,this.resize(this.__canvasWidth,this.__canvasHeight);}getTr(){return this.__tr}setTr(e){this.__tr=e,this.resize(this.__canvasWidth,this.__canvasHeight);}getPosX(){return this.__x}getPosY(){return this.__y}getWidth(){return this.__width}getHeight(){return this.__height}getBackground(){return console.warn("Deprecated Function. Please access the Scene Settings object."),this.__renderer.getScene().settings.getParameter("BackgroundColor").getValue()}setBackground(e){console.warn("Deprecated Function. Please access the Scene Settings object."),this.__renderer.getScene().settings.getParameter("BackgroundColor").setValue(e),this.updated.emit();}resize(e,t){this.__canvasWidth=e,this.__canvasHeight=t,this.__width=e,this.__height=t,this.resized.emit();}onMouseDown(e){return !1}onMouseUp(e){return !1}onMouseMove(e){return !1}onMouseLeave(e){return !1}onKeyPressed(e,t){return !1}onKeyDown(e,t){return !1}onKeyUp(e,t){return !1}}class Xi extends Gi{constructor(e,t,a,i){super(e),this.__name=t,this.__projectionMatrix=new _,this.__frustumDim=new o,this.__bl=new o(0,0),this.__tr=new o(1,1),this.__exposure=0,this.__exposureRange=[-5,10],this.__tonemap=!0,this.__gamma=2.2,this.__prevDownTime=0,this.__geomDataBuffer=void 0,this.__geomDataBufferFbo=void 0,this.viewChanged=new S,this.capturedItem=null,this.keyDown=new S,this.keyPressed=new S,this.keyUp=new S,this.mouseDown=new S,this.mouseDoubleClicked=new S,this.mouseMove=new S,this.mouseUp=new S,this.mouseLeave=new S,this.mouseDownOnGeom=new S,this.mouseWheel=new S,this.touchStart=new S,this.touchMove=new S,this.touchEnd=new S,this.touchCancel=new S,this.doubleTapped=new S,this.setCamera(new ca("Default")),this.setManipulator(new La),this.resize(a,i);}resize(e,t){this.__canvasWidth=e,this.__canvasHeight=t,this.__x=e*this.__bl.x,this.__y=e*this.__bl.y,this.__width=e*this.__tr.x-e*this.__bl.x,this.__height=t*this.__tr.y-t*this.__bl.y,this.region=[this.__x,this.__y,this.__width,this.__height],this.__camera&&this.__updateProjectionMatrix(),this.__geomDataBufferFbo&&(this.__geomDataBuffer.resize(this.__width,this.__height),this.__geomDataBufferFbo.resize()),this.resized.emit();}getCamera(){return this.__camera}setCamera(e){this.__camera=e;const t=e.getParameter("GlobalXfo"),a=()=>{this.__cameraXfo=t.getValue(),this.__cameraMat=this.__cameraXfo.toMat4(),this.__viewMat=this.__cameraMat.inverse();};a(),t.valueChanged.connect(()=>{a(),this.invalidateGeomDataBuffer(),this.updated.emit(),this.viewChanged.emit({interfaceType:"CameraAndPointer",viewXfo:this.__cameraXfo,focalDistance:this.__camera.getFocalDistance()});}),this.__camera.projectionParamChanged.connect(()=>{this.__updateProjectionMatrix(),this.updated.emit();}),this.__updateProjectionMatrix();}getManipulator(){return this.__cameraManipulator}setManipulator(e){this.__cameraManipulator=e;}__updateProjectionMatrix(){const e=this.__width/this.__height;this.__camera.updateProjectionMatrix(this.__projectionMatrix,e);const t=Math.tan(this.__camera.getFov()/2)*this.__camera.getNear()*2,a=t*e;this.__frustumDim.set(a,t);}getProjectionMatrix(){return this.__projectionMatrix}getViewMatrix(){return this.__viewMat}setActive(e){activeViewport=e?this:void 0;}frameView(e){this.__camera.frameView(this,e);}calcRayFromScreenPos(e){const t=this.__canvasHeight*(1-this.__tr.y);let a=(e.x-this.__x)/this.__width,i=(e.y-t)/this.__height;a=2*a-1,i=2*i-1;const s=this.__cameraMat,n=this.__projectionMatrix.inverse();if(null==n)return null;let l,r;return this.__camera.getIsOrthographic()?(l=s.transformVec3(n.transformVec3(new d(a,-i,-1))),r=new d(0,0,-1)):(l=s.translation,r=n.transformVec3(new d(a,-i,-1))),r=s.rotateVec3(r).normalize(),new G(l,r)}createGeomDataFbo(e){const t=this.__renderer.gl;this.__floatGeomBuffer=e,this.__floatGeomBuffer?this.__geomDataBuffer=new Fa(t,{type:"FLOAT",format:"RGBA",filter:"NEAREST",width:this.__width<=1?1:this.__width,height:this.__height<=1?1:this.__height}):this.__geomDataBuffer=new Fa(t,{type:"UNSIGNED_BYTE",format:"RGBA",filter:"NEAREST",width:this.__width<=1?1:this.__width,height:this.__height<=1?1:this.__height}),this.__geomDataBufferFbo=new Ha(t,this.__geomDataBuffer,!0),this.__geomDataBufferFbo.setClearColor([0,0,0,0]);}getGeomDataFbo(){return this.__geomDataBufferFbo}renderGeomDataFbo(){if(this.__geomDataBufferFbo){this.__geomDataBufferFbo.bindAndClear();const e={};this.__initRenderState(e),this.__renderer.drawSceneGeomData(e),this.__geomDataBufferInvalid=!1;}}invalidateGeomDataBuffer(){this.__geomDataBufferInvalid=!0;}getGeomDataAtPos(e,t){if(this.__geomDataBufferFbo){if(this.__geomDataBufferInvalid&&(this.renderGeomDataFbo(),this.__screenPos=null),e===this.__screenPos)return this.__intersectionData;this.__screenPos=e,this.__intersectionData=null;const a=this.__renderer.gl;let i,s;if(a.finish(),this.__geomDataBufferFbo.bindForReading(),a.floatGeomBuffer){if(s=new Float32Array(4),a.readPixels(e.x,this.__height-e.y,1,1,a.RGBA,a.FLOAT,s),0==s[3])return;i=63&Math.round(s[0]);}else {if(s=new Uint8Array(4),a.readPixels(e.x,this.__height-e.y,1,1,a.RGBA,a.UNSIGNED_BYTE,s),a.bindFramebuffer(a.FRAMEBUFFER,null),0==s[0]&&0==s[1])return;i=0;}this.__geomDataBufferFbo.unbind();const n=this.__renderer.getPass(i);if(!n)return void console.warn("Geom data buffer returns invalid pass id:",i);const l=n.getGeomItemAndDist(s);if(l){t||(t=this.calcRayFromScreenPos(e));const a=t.start.add(t.dir.scale(l.dist));this.__intersectionData={screenPos:e,mouseRay:t,intersectionPos:a,geomItem:l.geomItem,dist:l.dist,geomData:s};}return this.__intersectionData}}getGeomItemsInRect(e,t){if(this.__geomDataBufferFbo){const a=this.__renderer.gl;a.finish();const i=Math.round(this.__height-t.y),s=Math.round(e.x),n=Math.round(t.x-e.x),l=Math.round(t.y-e.y),r=n*l;let o;this.__geomDataBufferFbo.bindForReading(),a.floatGeomBuffer?(o=new Float32Array(4*r),a.readPixels(s,i,n,l,a.RGBA,a.FLOAT,o)):(o=new Uint8Array(4*r),a.readPixels(s,i,n,l,a.RGBA,a.UNSIGNED_BYTE,o)),a.bindFramebuffer(a.FRAMEBUFFER,null);const d=new Set;for(let e=0;e<r;e++){let t;const i=o.subarray(4*e,4*(e+1));t=a.floatGeomBuffer?Math.round(i[0]):0;const s=this.__renderer.getPass(t).getGeomItemAndDist(i);s&&d.add(s.geomItem);}return d}}__eventMousePos(e){return new o(e.rendererX-this.getPosX(),e.rendererY-this.getPosY())}__prepareEvent(e){if(e.viewport=this,e.propagating=!0,e.stopPropagation(),e.stopPropagation=()=>{e.propagating=!1;},e.setCapture=e=>{this.capturedItem=e;},e.getCapture=e=>this.capturedItem,e.releaseCapture=()=>{this.capturedItem=null,this.renderGeomDataFbo();},e instanceof MouseEvent){const t=this.__eventMousePos(e);e.mousePos=t,e.mouseRay=this.calcRayFromScreenPos(t);const a=this.getGeomDataAtPos(e.mousePos,e.mouseRay);null!=a&&(e.intersectionData=a);}}setCapture(e){this.capturedItem=e;}getCapture(){return this.capturedItem}releaseCapture(){this.capturedItem=null,this.renderGeomDataFbo();}onMouseDown(e){if(this.__prepareEvent(e),this.capturedItem)return void this.capturedItem.onMouseDown(e);if(null!=e.intersectionData){if(e.intersectionData.geomItem.onMouseDown(e),!e.propagating||this.capturedItem)return;if(this.mouseDownOnGeom.emit(e),!e.propagating)return}const t=Date.now();if(t-this.__prevDownTime<this.__doubleClickTimeMSParam.getValue()){if(this.__cameraManipulator&&(this.__cameraManipulator.onDoubleClick(e),!e.propagating))return;this.mouseDoubleClicked.emit(e);}else {if(this.__prevDownTime=t,this.__cameraManipulator&&(this.__cameraManipulator.onMouseDown(e),!e.propagating))return;this.mouseDown.emit(e);}return !1}onMouseMove(e){if(this.__prepareEvent(e),this.capturedItem)this.capturedItem.onMouseMove(e);else {if(null!=e.intersectionData){if(e.intersectionData.geomItem!=this.mouseOverItem&&(this.mouseOverItem&&this.mouseOverItem.onMouseLeave(e),this.mouseOverItem=e.intersectionData.geomItem,this.mouseOverItem.onMouseEnter(e)),e.intersectionData.geomItem.onMouseMove(e),!e.propagating||this.capturedItem)return}else this.mouseOverItem&&(this.mouseOverItem.onMouseLeave(e),this.mouseOverItem=null);this.__cameraManipulator&&(this.__cameraManipulator.onMouseMove(e),!e.propagating)||this.mouseMove.emit(e);}}onMouseUp(e){this.__prepareEvent(e),this.capturedItem?this.capturedItem.onMouseUp(e):(null==e.intersectionData||(e.intersectionData.geomItem.onMouseUp(e),e.propagating))&&(this.__cameraManipulator&&(this.__cameraManipulator.onMouseUp(e),!e.propagating)||this.mouseUp.emit(e));}onMouseLeave(e){this.__prepareEvent(e),this.mouseLeave.emit(e);}onKeyPressed(e,t){this.__prepareEvent(t),this.__cameraManipulator&&this.__cameraManipulator.onKeyPressed(e,t)||this.keyPressed.emit(e,t);}onKeyDown(e,t){this.__prepareEvent(t),this.__cameraManipulator&&this.__cameraManipulator.onKeyDown(e,t)||this.keyDown.emit(e,t);}onKeyUp(e,t){this.__prepareEvent(t),this.__cameraManipulator&&this.__cameraManipulator.onKeyUp(e,t)||this.keyUp.emit(e,t);}onWheel(e){this.__prepareEvent(e),(null==e.intersectionData||(e.intersectionData.geomItem.onWheel(e),e.propagating))&&(this.__cameraManipulator?this.__cameraManipulator.onWheel(e):this.mouseWheel.emit(e));}__eventTouchPos(e){return new o(e.rendererX-this.getPosX(),e.rendererY-this.getPosY())}onTouchStart(e){if(this.__prepareEvent(e),1==e.touches.length){const t=e.touches[0],a=this.__eventTouchPos(t);e.touchPos=a,e.touchRay=this.calcRayFromScreenPos(a);const i=this.getGeomDataAtPos(a,e.touchRay);if(null!=i){if(e.intersectionData=i,i.geomItem.onMouseDown(e,i),!e.propagating)return;if(this.capturedItem)return;if(this.mouseDownOnGeom.emit(e),!e.propagating)return}const s=Date.now();if(s-this.__prevDownTime<this.__doubleClickTimeMSParam.getValue()){if(this.__cameraManipulator&&(this.__cameraManipulator.onDoubleTap(e),!e.propagating))return;return void this.doubleTapped.emit(e)}this.__prevDownTime=s;}this.__cameraManipulator?this.__cameraManipulator.onTouchStart(e):this.touchStart.emit(e);}onTouchMove(e){if(this.__prepareEvent(e),this.capturedItem){e.touchPos=[],e.touchRay=[];for(let t=0;t<e.touches.length;t++){const a=e.touches[t],i=this.__eventTouchPos(a);e.touchPos[t]=i,e.touchRay[t]=this.calcRayFromScreenPos(i);}return e.mousePos=e.touchPos[0],e.mouseRay=e.touchRay[0],void this.capturedItem.onMouseMove(e)}this.__cameraManipulator?this.__cameraManipulator.onTouchMove(e):this.touchMove.emit(e);}onTouchEnd(e){this.__prepareEvent(e),this.capturedItem?this.capturedItem.onMouseUp(e):this.__cameraManipulator?this.__cameraManipulator.onTouchEnd(e):this.touchEnd.emit(e);}onTouchCancel(e){this.__prepareEvent(e),this.capturedItem?this.capturedItem.onTouchCancel(e):this.__cameraManipulator?this.__cameraManipulator.onTouchCancel(e):this.touchCancel.emit(e);}__initRenderState(e){e.viewXfo=this.__cameraXfo,e.viewScale=1,e.region=this.region,e.cameraMatrix=this.__cameraMat,e.viewports=[{region:this.region,viewMatrix:this.__viewMat,projectionMatrix:this.__projectionMatrix,viewportFrustumSize:this.__frustumDim,isOrthographic:this.__camera.getIsOrthographic(),fovY:this.__camera.getFov()}];}draw(){const e=this.__renderer.gl;e.bindFramebuffer(e.FRAMEBUFFER,null),e.viewport(...this.region),this.__backgroundColor&&e.clearColor(...this.__backgroundColor.asArray()),e.colorMask(!0,!0,!0,!0),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);const t={};this.__initRenderState(t),this.__renderer.drawScene(t);}}class yi{constructor(e,t){this.__vrviewport=e,this.__treeItem=new $t("VRHead"),t.addChild(this.__treeItem),this.__mat4=new _,this.__localXfo=new X;}update(e){this.__mat4.setDataArray(e.transform.matrix),this.__localXfo.fromMat4(this.__mat4),this.__treeItem.setLocalXfo(this.__localXfo);}getTreeItem(){return this.__treeItem}getXfo(){return this.__localXfo}}class fi{constructor(e,a,i){if(this.__vrviewport=e,this.__inputSource=a,this.__id=i,this.__isDaydramController=t.isMobileDevice,this.touchpadTouched=new S,this.buttonPressed=new S,this.buttonReleased=new S,this.__pressedButtons=[],this.__mat4=new _,this.__xfo=new X,this.__treeItem=new $t("VRController:"+a.handedness+i),!this.__isDaydramController){this.__tip=new $t("Tip");const t=new X;t.tr.set(0,-.05,-.13),this.__tip.setLocalXfo(t),this.__treeItem.addChild(this.__tip,!1),e.getTreeItem().addChild(this.__treeItem),this.__activeVolumeSize=.04,e.loadHMDResources().then(e=>{e.loaded.connect(()=>{let t;0==i?t=e.getChildByName("LeftController"):1==i&&(t=e.getChildByName("RightController")),t||(t=e.getChildByName("Controller"));const a=t.clone();a.setLocalXfo(new X(new d(0,-.035,-.085),new Z({setFromAxisAndAngle:[new d(0,1,0),Math.PI]}),new d(.001,.001,.001))),this.__treeItem.addChild(a,!1);});});}}getHandedness(){return this.__inputSource.handedness}getId(){return this.__id}getTreeItem(){return this.__treeItem}getTipItem(){return this.__tip}getTipXfo(){return this.__tip.getGlobalXfo()}getTouchPadValue(){return this.__touchpadValue}isButtonPressed(){return this.__buttonPressed}getControllerStageLocalXfo(){return this.__xfo}getControllerTipStageLocalXfo(){return this.__xfo.multiply(this.__tip.getLocalXfo())}updatePose(e,t,a){const i=t.getPose(a.gripSpace,e);i&&i.transform&&(this.__mat4.setDataArray(i.transform.matrix),this.__xfo.fromMat4(this.__mat4),this.__treeItem.setLocalXfo(this.__xfo),this.__geomAtTip=void 0,this.__hitTested=!1);}getGeomItemAtTip(){if(this.__hitTested)return this.__intersectionData;this.__hitTested=!0;const e=this.__vrviewport.getRenderer(),t=this.__tip.getGlobalXfo(),a=this.__activeVolumeSize;return this.__intersectionData=e.raycastWithXfo(t,a,a),this.__intersectionData}}class Vi extends Gi{constructor(e){super(e),this.getParameter("DoubleClickTimeMS").setValue(300),this.__projectionMatriciesUpdated=!1,this.__far=1024,this.__near=.1,this.__stageTreeItem=new $t("VRStage"),this.__stageTreeItem.setSelectable(!1),this.__stageTreeItem.setVisible(!1),this.__renderer.addTreeItem(this.__stageTreeItem),this.__vrhead=new yi(this.__renderer.gl,this.__stageTreeItem),this.__vrControllersMap={},this.__vrControllers=[];const t=new X;t.ori.setFromAxisAndAngle(new d(1,0,0),.5*Math.PI),this.setXfo(t),this.__leftViewMatrix=new _,this.__leftProjectionMatrix=new _,this.__rightViewMatrix=new _,this.__rightProjectionMatrix=new _,this.resized=new S,this.viewChanged=new S,this.presentingChanged=new S,this.controllerAdded=new S,this.controllerButtonDown=new S,this.controllerButtonUp=new S,this.controllerDoubleClicked=new S,this.controllerTouchpadTouched=new S;}getVRDisplay(){return this.__vrDisplay}getAsset(){return this.__vrAsset}getTreeItem(){return this.__stageTreeItem}getVRHead(){return this.__vrhead}getXfo(){return this.__stageXfo}setXfo(e){this.__stageXfo=e,this.__stageTreeItem.setGlobalXfo(e),this.__stageMatrix=e.inverse().toMat4(),this.__stageScale=e.sc.x;}getControllers(){return this.__vrControllers}canPresent(){return this.__canPresent}isPresenting(){return this.__session}__startSession(){const e=(t,a)=>{this.__session&&(this.__session.requestAnimationFrame(e),this.draw(a));};this.__session.requestAnimationFrame(e);}loadHMDResources(){const e=localStorage.getItem("hmd");return this.__hmd!=e&&(this.__hmdAssetPromise=void 0),this.__hmdAssetPromise||(this.__hmd=e,this.__hmdAssetPromise=new Promise((a,i)=>{this.__renderer.sceneSet.connect(s=>{const n=s.getResourceLoader();let l;switch(e){case"Vive":l="ZeaEngine/Vive.vla";break;case"Oculus":default:l="ZeaEngine/Oculus.vla";}const r=n.resolveFilePathToId(l);r&&!t.isMobileDevice?(this.__vrAsset=this.__renderer.getScene().loadCommonAssetResource(r),this.__vrAsset.loaded.connect(()=>{const e=this.__vrAsset.getMaterialLibrary(),t=e.getMaterialNames();for(const a of t){const t=e.getMaterial(a,!1);t&&(t.visibleInGeomDataBuffer=!1,t.setShaderName("SimpleSurfaceShader"));}a(this.__vrAsset);})):i();});})),this.__hmdAssetPromise}startPresenting(){const e=this.__renderer.gl;this.loadHMDResources().then(()=>{navigator.xr.requestSession("immersive-vr",{requiredFeatures:["local-floor"],optionalFeatures:["bounded-floor"]}).then(t=>{this.__renderer.__xrViewportPresenting=!0;const a=document.createElement("canvas");a.style.position="relative",a.style.left="0px",a.style.top="0px",a.style.width="100%",a.style.height="100%",this.__renderer.getDiv().replaceChild(a,this.__renderer.getGLCanvas()),t.addEventListener("end",e=>{this.__stageTreeItem.setVisible(!1),this.__renderer.getDiv().replaceChild(this.__renderer.getGLCanvas(),a),this.__session=null,this.presentingChanged.emit(!1);});t.addEventListener("selectstart",e=>{const t=this.__vrControllersMap[e.inputSource.handedness];if(t){const a=Date.now();console.log("controller:",e.inputSource.handedness," down",a-t.__prevDownTime),a-t.__prevDownTime<this.__doubleClickTimeMSParam.getValue()?this.controllerDoubleClicked.emit({button:1,controller:t,vleStopPropagation:!1,vrviewport:this},this):(t.__prevDownTime=a,this.controllerButtonDown.emit({button:1,controller:t,vleStopPropagation:!1,vrviewport:this},this));}}),t.addEventListener("selectend",e=>{const t=this.__vrControllersMap[e.inputSource.handedness];t&&(console.log("controller:",e.inputSource.handedness," up"),this.controllerButtonUp.emit({button:1,controller:t,vleStopPropagation:!1,vrviewport:this},this));}),this.__session=t,t.updateRenderState({baseLayer:new XRWebGLLayer(t,e,{compositionDisabled:"inline"==t.mode}),outputContext:a.getContext("xrpresent")}),t.requestReferenceSpace("local-floor").catch(e=>(console.log("Falling back to identity reference space"),t.requestReferenceSpace("viewer").then(e=>e.getOffsetReferenceSpace(new XRRigidTransform({y:-1.6}))))).then(e=>{this.__refSpace=e,this.__stageTreeItem.setVisible(!0),this.presentingChanged.emit(!0),this.__startSession();}).catch(e=>{console.warn(e.message);});}).catch(e=>{console.warn(e.message);});});}stopPresenting(){this.__session&&this.__session.end();}togglePresenting(){this.__session?this.stopPresenting():this.startPresenting();}getHMDCanvasSize(){return this.__hmdCanvasSize}__createController(e,t){console.log("creating controller:",t.handedness);const a=new fi(this,t,e);return this.__vrControllersMap[t.handedness]=a,this.__vrControllers[e]=a,this.controllerAdded.emit(a),a}updateControllers(e){const t=this.__session.inputSources;for(let a=0;a<t.length;a++){const i=t[a];if(""==i.handedness||"none"==i.handedness)return;this.__vrControllers[a]||this.__createController(a,i),this.__vrControllers[a].updatePose(this.__refSpace,e,i);}}draw(e){const t=e.session.renderState.baseLayer,a=e.getViewerPose(this.__refSpace),i=a.views;if(!this.__projectionMatriciesUpdated){this.__projectionMatrices=[],this.__viewMatrices=[],this.__cameraMatrices=[],this.__region=[0,0,0,0];for(let e=0;e<i.length;e++){const a=i[e],s=new _;s.setDataArray(a.projectionMatrix),this.__projectionMatrices[e]=s,this.__viewMatrices[e]=new _,this.__cameraMatrices[e]=new _;const n=t.getViewport(a);this.__region[2]=Math.max(this.__region[2],n.x+n.width),this.__region[3]=Math.max(this.__region[3],n.y+n.height);}this.__renderer.resizeFbos(this.__region[2],this.__region[3]),this.__projectionMatriciesUpdated=!0;}const s=this.__renderer.gl;s.bindFramebuffer(s.FRAMEBUFFER,t.framebuffer),this.__backgroundColor&&s.clearColor(...this.__backgroundColor.asArray()),s.colorMask(!0,!0,!0,!0),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT);const n={boundRendertarget:t.framebuffer,region:this.__region,viewports:[]};for(let e=0;e<i.length;e++){const a=i[e];this.__viewMatrices[e].setDataArray(a.transform.inverse.matrix),this.__viewMatrices[e].multiplyInPlace(this.__stageMatrix);const s=t.getViewport(a);n.viewports.push({viewMatrix:this.__viewMatrices[e],projectionMatrix:this.__projectionMatrices[e],region:[s.x,s.y,s.width,s.height]});}if(this.__vrhead.update(a),this.updateControllers(e),n.viewXfo=this.__vrhead.getTreeItem().getGlobalXfo(),n.viewScale=1/this.__stageScale,n.cameraMatrix=n.viewXfo.toMat4(),n.region=this.__region,this.__renderer.drawScene(n),this.capturedElement){const e={viewport:this};this.capturedElement.onMouseMove(e);}const l={interfaceType:"VR",hmd:this.__hmd,viewXfo:n.viewXfo,controllers:this.__vrControllers,vrviewport:this};this.viewChanged.emit(l,this);}setCapture(e){this.capturedElement=e;}getCapture(){return this.capturedElement}releaseCapture(){this.capturedElement=null,this.renderGeomDataFbo();}}let xi=void 0,Ii=!1,Ri=!1;const Si={};const Wi={OPAQUE:1,TRANSPARENT:2,OVERLAY:4};class Li extends H{constructor(){super(),this.updated=new S,this.enabled=!0,this.__passIndex=0;const e=this.addParameter(new pe("Enabled",!0));e.valueChanged.connect(t=>this.enabled=e.getValue());}__parameterValueChanged(e,t){super.__parameterValueChanged(e,t),this.__renderer&&this.__renderer.requestRedraw();}init(e,t){if(null==t)throw new Error("Missing constructor argument.");this.__gl=e.gl,this.__renderer=e,this.__passIndex=t;}setPassIndex(e){this.__passIndex=e;}startPresenting(){}stopPresenting(){}draw(e){}drawHighlightedGeoms(e){}drawGeomData(e){}getGeomItemAndDist(e){}}class vi extends Pa{constructor(e){super(e),this.__shaderStages.VERTEX_SHADER=Ja.parseShader("OutlinesShader.vertexShader","\nprecision highp float;\n\nattribute vec3 positions;    //(location = 0)\n\n/* VS Outputs */\nvarying vec2 v_texCoord;\n \nvoid main()\n{\n    v_texCoord = positions.xy+0.5;\n    gl_Position = vec4(positions.xy*2.0, 0.0, 1.0);\n}\n\n"),this.__shaderStages.FRAGMENT_SHADER=Ja.parseShader("OutlinesShader.fragmentShader","\nprecision highp float;\n\nuniform sampler2D highlightDataTexture;\nuniform vec2 highlightDataTextureSize;\n\nvarying vec2 v_texCoord;\n\n\nbool isFilledPixel(vec4 p) {\n    return p.r > 0.01 || p.g > 0.01 || p.b > 0.01;\n}\nvoid accumOutlinePixel(vec2 fragCoord, inout vec4 res) {\n    vec3 p = texture2D(highlightDataTexture, fragCoord/highlightDataTextureSize).rgb;\n    if(p.r > 0.01 || p.g > 0.01 || p.b > 0.01) {\n        res.r += p.r;\n        res.g += p.g;\n        res.b += p.b;\n        res.a += 1.0;\n    }\n}\nvec4 getOutlinePixelColor(vec2 fragCoord) {\n    vec4 M = texture2D(highlightDataTexture, fragCoord/highlightDataTextureSize);\n    \n    /// To display a fill instead of an outline.\n    // return M;\n\n    if( isFilledPixel(M) ) {\n        // Note: the filled pixel has an alpha value\n        // that determines how much fill is applied\n        // The outline is a solid color. \n        return M;\n    }\n    // Search surrounding pixels for selected geoms.\n    vec4 res;\n    accumOutlinePixel(fragCoord+vec2( 1, 1), res); // NW\n    accumOutlinePixel(fragCoord+vec2(-1, 1), res); // NE\n    accumOutlinePixel(fragCoord+vec2( 1,-1), res); // SW\n    accumOutlinePixel(fragCoord+vec2(-1,-1), res); // SE\n    accumOutlinePixel(fragCoord+vec2( 0, 2), res); // NN\n    accumOutlinePixel(fragCoord+vec2(-2, 0), res); // EE\n    accumOutlinePixel(fragCoord+vec2( 2, 0), res); // WW\n    accumOutlinePixel(fragCoord+vec2( 0,-2), res); // SS\n    accumOutlinePixel(fragCoord+vec2( 1, 2), res); // NNW\n    accumOutlinePixel(fragCoord+vec2(-1, 2), res); // NNE\n    accumOutlinePixel(fragCoord+vec2(-2, 1), res); // EEN\n    accumOutlinePixel(fragCoord+vec2(-2,-1), res); // EES\n    accumOutlinePixel(fragCoord+vec2( 2, 1), res); // WWN\n    accumOutlinePixel(fragCoord+vec2( 2,-1), res); // WWS\n    accumOutlinePixel(fragCoord+vec2( 1,-2), res); // SSW\n    accumOutlinePixel(fragCoord+vec2(-1,-2), res); // SSE\n\n    if(isFilledPixel(res))\n        return vec4(res.rgb / res.a, 1.0);\n    else\n        return vec4(0.0, 0.0, 0.0, 0.0);\n}\n\n\n#ifdef ENABLE_ES3\nout vec4 fragColor;\n#endif\n\nvoid main(void) {\n\n    // fragColor = texture2D(highlightDataTexture, v_texCoord);;\n    //can also use gl_FragCoord.xy\n    mediump vec2 fragCoord = v_texCoord * highlightDataTextureSize; \n    /////////////////\n    // Selection Outlines\n    vec4 outlineColor = getOutlinePixelColor(fragCoord);\n    if(outlineColor.a > 0.0001){\n#ifndef ENABLE_ES3\n        gl_FragColor = outlineColor;\n#else\n        fragColor = outlineColor;\n#endif\n    }\n    else {\n        discard;\n    }\n}\n\n");}}const Mi=Wi.OPAQUE|Wi.TRANSPARENT|Wi.OVERLAY;class Fi extends class{constructor(e,a={}){if(t.gpuDesc){this.__shaders={},this.__passes={},this.__passCallbacks=[],this.addTreeItem=this.addTreeItem.bind(this),this.removeTreeItem=this.removeTreeItem.bind(this),this.__viewports=[],this.__activeViewport=void 0,this.__continuousDrawing=!1,this.__redrawRequested=!1,this.__isMobile=t.isMobileDevice,this.__drawSuspensionLevel=1,this.__shaderDirectives={},this.__preproc={},this.__xrViewportPresenting=!1,this.renderGeomDataFbos=this.renderGeomDataFbos.bind(this),this.requestRedraw=this.requestRedraw.bind(this),this.resized=new S,this.keyPressed=new S,this.sceneSet=new S(!0),this.vrViewportSetup=new S(!0),this.sessionClientSetup=new S(!0),this.viewChanged=new S,this.redrawOccured=new S,this.setupWebGL(e,a.webglOptions?a.webglOptions:{}),this.bindEventHandlers();for(const e in Si)for(const t of Si[e])this.addPass(new t,e,!1);this.addViewport("main"),this.__supportXR=void 0===a.supportXR||a.supportXR,this.__xrViewport=void 0,this.__xrViewportPromise=new Promise((e,t)=>{if(this.__supportXR&&navigator.xr){const t=()=>{this.__gl.makeXRCompatible().then(()=>{this.__xrViewport=this.__setupXRViewport(),this.vrViewportSetup.emit(this.__xrViewport),e(this.__xrViewport);});};navigator.xr.supportsSessionMode?navigator.xr.supportsSessionMode("immersive-vr").then(t).catch(e=>{console.warn("Unable to setup XR:"+e);}):navigator.xr.isSessionSupported("immersive-vr").then(e=>{e&&t();}).catch(e=>{console.warn("Unable to setup XR:"+e);});}});}else console.warn("Unable to create renderer");}addShaderPreprocessorDirective(e,t){this.__shaderDirectives[e]=t?"#define "+e+" = "+t:"#define "+e;const a=[];for(const e in this.__shaderDirectives)a.push(this.__shaderDirectives[e]);this.__preproc.defines=a.join("\n")+"\n",this.__gl.shaderopts=this.__preproc;}getShaderPreproc(){return this.__preproc}getWidth(){return this.__glcanvas.width}getHeight(){return this.__glcanvas.height}addViewport(e){const t=new Xi(this,e,this.getWidth(),this.getHeight());return t.updated.connect(()=>{this.requestRedraw();}),t.createGeomDataFbo(this.__floatGeomBuffer),t.viewChanged.connect(e=>{this.__xrViewportPresenting||this.viewChanged.emit(e);}),this.__viewports.push(t),t}getViewport(e=0){return this.__viewports[e]}getViewportAtPos(e,t){for(const a of this.__viewports){const i=a.getPosX(),s=a.getPosY(),n=a.getWidth(),l=a.getHeight();if(e>=i&&t>=s&&e<=n+i&&t<=l+s)return a}}activateViewport(e){this.__activeViewport!=e&&(this.__activeViewport=e);}activateViewportAtPos(e,t){if(this.__xrViewportPresenting)return;const a=this.getViewportAtPos(e,t);a&&a!=this.__activeViewport&&this.activateViewport(a);}getActiveViewport(){return this.__xrViewportPresenting?this.__xrViewport:this.__activeViewport}suspendDrawing(){this.__drawSuspensionLevel++;}resumeDrawing(){this.__drawSuspensionLevel--,0==this.__drawSuspensionLevel&&(this.__loadingImg&&this.__glcanvasDiv.removeChild(this.__loadingImg),this.renderGeomDataFbos(),this.requestRedraw());}renderGeomDataFbos(){if(1==this.__renderGeomDataFbosRequested)return;this.__renderGeomDataFbosRequested=!0;window.requestAnimationFrame(()=>{for(const e of this.__viewports)e.renderGeomDataFbo();this.__renderGeomDataFbosRequested=!1;});}setupGrid(e,t,a,i){return console.warn("Deprecated Method. Please use scene.setupGrid"),this.__scene.setupGrid(e,a,t)}getScene(){return this.__scene}setScene(e){this.__scene=e,this.addTreeItem(this.__scene.getRoot()),this.__gizmoContext&&this.__gizmoContext.setSelectionManager(e.getSelectionManager()),this.sceneSet.emit(this.__scene);}addTreeItem(e){if(e instanceof $t){for(const t of this.__passCallbacks){const a={continueInSubTree:!0};if(t.itemAddedFn(e,a)){if(!a.continueInSubTree)return;break}}for(const t of e.getChildren())t&&this.addTreeItem(t);e.childAdded.connect(this.addTreeItem),e.childRemoved.connect(this.removeTreeItem),this.renderGeomDataFbos();}}removeTreeItem(e){if(e instanceof $t){e.childAdded.disconnect(this.addTreeItem),e.childRemoved.disconnect(this.removeTreeItem);for(const t of this.__passCallbacks){if(!t.itemRemovedFn)continue;const a={continueInSubTree:!0};if(t.itemRemovedFn(e,a)){if(!a.continueInSubTree)return;break}}for(const t of e.getChildren())t&&this.removeTreeItem(t);this.renderGeomDataFbos();}}get gl(){return this.__gl}getGL(){return this.__gl}resizeFbos(e,t){}__onResize(){if(!this.__xrViewportPresenting){const e=1;this.__glcanvas.width=this.__glcanvas.clientWidth*e,this.__glcanvas.height=this.__glcanvas.clientHeight*e;for(const e of this.__viewports)e.resize(this.__glcanvas.width,this.__glcanvas.height);this.resizeFbos(this.__glcanvas.width,this.__glcanvas.height),this.resized.emit(this.__glcanvas.width,this.__glcanvas.height),this.requestRedraw();}}getDiv(){return this.__glcanvasDiv}setupWebGL(a,i){this.__glcanvas=document.createElement("canvas"),this.__glcanvas.style.position=i.canvasPosition?i.canvasPosition:"absolute",this.__glcanvas.style.left="0px",this.__glcanvas.style.top="0px",this.__glcanvas.style.width="100%",this.__glcanvas.style.height="100%",this.__glcanvasDiv=a,this.__glcanvasDiv.appendChild(this.__glcanvas),e(this.__glcanvas,e=>{this.__onResize();}),this.__onResize(),i.preserveDrawingBuffer=!0,i.stencil=!!i.stencil&&i.stencil,i.alpha=!!i.alpha&&i.alpha,i.xrCompatible=!0,this.__gl=Ma(this.__glcanvas,i),this.__gl||alert("Unable to create WebGL context. WebGL not supported."),this.__gl.renderer=this,"webgl2"==this.__gl.name&&this.addShaderPreprocessorDirective("ENABLE_ES3"),this.__gl.floatTexturesSupported&&this.addShaderPreprocessorDirective("ENABLE_FLOAT_TEXTURES"),this.__gl.screenQuad=new Zi(this.__gl),this.__screenQuad=this.__gl.screenQuad,this.__floatGeomBuffer=this.__gl.floatTexturesSupported&&"Safari"!=t.browserName,this.__gl.floatGeomBuffer=this.__floatGeomBuffer;}bindEventHandlers(){const e=()=>this.__glcanvas.width>0&&this.__glcanvas.height,t=e=>{const t=this.__glcanvas.getBoundingClientRect();e.rendererX=1*(e.clientX-t.left),e.rendererY=1*(e.clientY-t.top);};this.__glcanvas.addEventListener("mouseenter",e=>{e.stopPropagation(),e.undoRedoManager=this.undoRedoManager,Ii||(xi=this,t(e),xi.activateViewportAtPos(e.rendererX,e.rendererY),Ri=!1);}),this.__glcanvas.addEventListener("mouseleave",t=>{if(xi==this&&e())if(t.stopPropagation(),t.undoRedoManager=this.undoRedoManager,Ii)Ri=!0;else {const e=xi.getActiveViewport();e&&(e.onMouseLeave(t),t.preventDefault()),xi=void 0;}}),this.__glcanvas.addEventListener("mousedown",e=>{e.stopPropagation(),e.undoRedoManager=this.undoRedoManager,t(e),Ii=!0,xi=this,xi.activateViewportAtPos(e.rendererX,e.rendererY);const a=xi.getActiveViewport();return a&&a.onMouseDown(e),Ri=!1,!1}),document.addEventListener("mouseup",a=>{if(xi!=this||!e())return;a.stopPropagation(),a.undoRedoManager=this.undoRedoManager,t(a),Ii=!1;const i=xi.getActiveViewport();if(i&&i.onMouseUp(a),Ri){const e=xi.getActiveViewport();e&&(e.onMouseLeave(a),a.preventDefault()),xi=void 0;}return !1}),document.addEventListener("mousemove",a=>{if(xi!=this||!e())return;a.preventDefault(),a.stopPropagation(),a.undoRedoManager=this.undoRedoManager,t(a),Ii||xi.activateViewportAtPos(a.rendererX,a.rendererY);const i=xi.getActiveViewport();return i&&i.onMouseMove(a),!1});const a=t=>{if(xi==this&&e())return xi&&(t.stopPropagation(),t.undoRedoManager=this.undoRedoManager,window.addEventListener||t.preventDefault(),this.onWheel(t)),!1};window.addEventListener?window.addEventListener("wheel",a,{passive:!0}):window.onmousewheel=document.onmousewheel=a,window.oncontextmenu=function(){return !1},document.addEventListener("keypress",t=>{if(xi!=this||!e())return;const a=String.fromCharCode(t.keyCode).toLowerCase(),i=xi.getActiveViewport();i&&i.onKeyPressed(a,t);}),document.addEventListener("keydown",t=>{if(xi!=this||!e())return;const a=String.fromCharCode(t.keyCode).toLowerCase(),i=xi.getActiveViewport();i&&i.onKeyDown(a,t);}),document.addEventListener("keyup",t=>{if(xi!=this||!e())return;const a=String.fromCharCode(t.keyCode).toLowerCase(),i=xi.getActiveViewport();i&&i.onKeyUp(a,t);}),this.__glcanvas.addEventListener("touchstart",e=>{e.stopPropagation(),e.undoRedoManager=this.undoRedoManager;for(let a=0;a<e.touches.length;a++)t(e.touches[a]);this.getViewport().onTouchStart(e);},!1),this.__glcanvas.addEventListener("touchmove",e=>{e.stopPropagation(),e.undoRedoManager=this.undoRedoManager;for(let a=0;a<e.touches.length;a++)t(e.touches[a]);this.getViewport().onTouchMove(e);},!1),this.__glcanvas.addEventListener("touchend",e=>{e.stopPropagation(),e.undoRedoManager=this.undoRedoManager;for(let a=0;a<e.touches.length;a++)t(e.touches[a]);this.getViewport().onTouchEnd(e);},!1),this.__glcanvas.addEventListener("touchcancel",e=>{e.stopPropagation(),e.undoRedoManager=this.undoRedoManager,this.getViewport().onTouchCancel(e);},!1);}setUndoRedoManager(e){this.undoRedoManager=e;}getGLCanvas(){return this.__glcanvas}getScreenQuad(){return this.__screenQuad}onWheel(e){this.__viewports[0].onWheel(e);}frameAll(e=0){this.__viewports[e].frameView([this.__scene.getRoot()]);}getOrCreateShader(e){let t=this.__shaders[e];return t||(t=C.constructClass(e,this.__gl),t||console.error("Shader not registered with the SGFactory:",e),this.__shaders[e]=t),t}addPass(e,t=0,a=!0){this.__passes[t]||(this.__passes[t]=[]);let i=0;for(const e in this.__passes){if(e==t)break;i+=this.__passes[e].length;}if(i+=this.__passes[t].length,e.updated.connect(this.requestRedraw.bind(this)),e.init(this,i),this.__passes[t].push(e),a){let e=0;for(const t in this.__passes){const a=this.__passes[t];a.forEach((t,a)=>{t.setPassIndex(e+a);}),e+=a.length;}}return this.requestRedraw(),i}registerPass(e,t){this.__passCallbacks.splice(0,0,{itemAddedFn:e,itemRemovedFn:t});}getPass(e){let t=0;for(const a in this.__passes){const i=this.__passes[a];if(e-t<i.length)return i[e-t];t+=i.length;}}findPass(e){for(const t in this.__passes){const a=this.__passes[t];for(const t of a)if(t.constructor==e)return t}}getGizmoPass(){return this.__gizmoPass}supportsVR(){return console.warn("Deprecated Method. Please instead connect to the vrViewportSetup signal."),this.__supportXR&&null!=navigator.xr}__setupXRViewport(){const e=new Vi(this);return e.presentingChanged.connect(t=>{if(this.__xrViewportPresenting=t,t){for(const e in this.__passes){const t=this.__passes[e];for(const e of t)e.startPresenting();}e.viewChanged.connect(this.viewChanged.emit);}else {e.viewChanged.disconnect(this.viewChanged.emit);for(const e in this.__passes){const t=this.__passes[e];for(const e of t)e.stopPresenting();}this.viewChanged.emit({interfaceType:"CameraAndPointer",viewXfo:this.getViewport().getCamera().getGlobalXfo()}),this.resizeFbos(this.__glcanvas.width,this.__glcanvas.height),this.requestRedraw();}}),e}getVRViewport(){return this.__xrViewport}getXRViewport(){return this.__xrViewportPromise}isXRViewportPresenting(){return this.__xrViewportPresenting}isContinuouslyDrawing(){return this.__continuousDrawing}startContinuousDrawing(){if(this.isContinuouslyDrawing()||this.__xrViewportPresenting)return;const e=()=>{this.__continuousDrawing&&!this.__xrViewportPresenting&&window.requestAnimationFrame(e);for(const e of this.__viewports)e.draw();};this.__continuousDrawing=!0,window.requestAnimationFrame(e);}stopContinuousDrawing(){this.__continuousDrawing=!1;}toggleContinuousDrawing(){this.__continuousDrawing?this.stopContinuousDrawing():this.startContinuousDrawing();}drawItemChanged(){for(const e of this.__viewports)e.invalidateGeomDataBuffer();this.requestRedraw();}requestRedraw(){if(this.__redrawRequested||this.__continuousDrawing||this.__xrViewportPresenting)return !1;return window.requestAnimationFrame(()=>{this.__redrawRequested=!1;for(const e of this.__viewports)e.draw();}),this.__redrawRequested=!0,!0}bindGLBaseRenderer(e){e.shaderopts=this.__preproc;const t=this.__gl;e.viewports&&1!=e.viewports.length?(e.bindRendererUnifs=a=>{const{cameraMatrix:i}=a;i&&t.uniformMatrix4fv(i.location,!1,e.cameraMatrix.asArray());},e.bindViewports=(a,i)=>{e.viewports.forEach((e,s)=>{t.viewport(...e.region);const{viewMatrix:n,projectionMatrix:l,eye:r}=a;n&&t.uniformMatrix4fv(n.location,!1,e.viewMatrix.asArray()),l&&t.uniformMatrix4fv(l.location,!1,e.projectionMatrix.asArray()),r&&t.uniform1i(r.location,s),i();});}):(e.bindRendererUnifs=a=>{const{cameraMatrix:i,viewMatrix:s,projectionMatrix:n,eye:l}=a;i&&t.uniformMatrix4fv(i.location,!1,e.cameraMatrix.asArray());const r=e.viewports[0];s&&t.uniformMatrix4fv(s.location,!1,r.viewMatrix.asArray()),n&&t.uniformMatrix4fv(n.location,!1,r.projectionMatrix.asArray()),l&&t.uniform1i(l.location,index);},e.bindViewports=(e,t)=>t());}drawScene(e){for(const t in this.__passes){const a=this.__passes[t];for(const t of a)t.enabled&&t.draw(e);}}drawHighlightedGeoms(e){this.bindGLBaseRenderer(e);for(const t in this.__passes){const a=this.__passes[t];for(const t of a)t.enabled&&t.drawHighlightedGeoms(e);}}drawSceneGeomData(e,t=255){this.bindGLBaseRenderer(e);for(const a in this.__passes){if(0==(Number.parseInt(a)&t))continue;const i=this.__passes[a];for(const t of i)t.enabled&&t.drawGeomData(e);}}static registerPass(e,t){Si[t]||(Si[t]=[]),Si[t].push(e);}}{constructor(e,a={}){super(e,a,{antialias:!0,depth:!0}),this.__exposure=1,this.__tonemap=!0,this.__gamma=2.2,this.__glEnvMap=void 0,this.__glBackgroundMap=void 0,this.envMapAssigned=new S(!0),this.__glLightmaps={},this.__displayEnvironment=!0,this.__debugMode=0,this.__debugLightmaps=!1,this._planeDist=0,this.__cutPlaneNormal=new d(1,0,0);const i=this.__gl;this.__debugTextures=[void 0],this.addShaderPreprocessorDirective("ENABLE_INLINE_GAMMACORRECTION"),a.disableLightmaps||this.addShaderPreprocessorDirective("ENABLE_LIGHTMAPS"),a.disableTextures||this.addShaderPreprocessorDirective("ENABLE_TEXTURES"),t.isMobileDevice||a.disableSpecular||this.addShaderPreprocessorDirective("ENABLE_SPECULAR"),this.__outlineShader=new vi(i),this.quad=new Ka(i,new Dt(1,1)),this.createSelectedGeomsFbo(),this.createRayCastRenderTarget();}__bindEnvMap(e){if(e instanceof Zt)this.__glEnvMap=e.getMetadata("gltexture"),this.__glEnvMap||("FLOAT"===e.type?(this.addShaderPreprocessorDirective("ENABLE_SPECULAR"),this.__glEnvMap=new gi(this,e,this.__preproc)):e.isStreamAtlas()?this.__glEnvMap=new GLImageStream(this.__gl,e):this.__glEnvMap=new Fa(this.__gl,e)),this.__glEnvMap.loaded.connect(this.requestRedraw),this.__glEnvMap.updated.connect(this.requestRedraw),this.envMapAssigned.emit(this.__glEnvMap);else {const t=e;if(this.__glBackgroundMap=t.getMetadata("gltexture"),this.__glBackgroundMap||("FLOAT"===t.type?this.__glBackgroundMap=new ka(gl,t):this.__glBackgroundMap=new Fa(gl,t)),this.__glBackgroundMap.loaded.connect(this.requestRedraw),this.__glBackgroundMap.updated.connect(this.requestRedraw),!this.__backgroundMapShader){switch(gl.__quadVertexIdsBuffer||gl.setupInstancedQuad(),t.getMapping()){case"octahedral":this.__backgroundMapShader=new ci(gl);break;case"latlong":this.__backgroundMapShader=new mi(gl);break;case"steriolatlong":this.__backgroundMapShader=new ui(gl);break;case"dualfisheye":this.__backgroundMapShader=new pi(gl);break;case"uv":default:this.__backgroundMapShader=new hi(gl);}const e=this.__backgroundMapShader.compileForTarget();this.__backgroundMapShaderBinding=Ya(gl,e.attrs,gl.__quadattrbuffers,gl.__quadIndexBuffer);}}}getGLEnvMap(){return this.__glEnvMap}getEnvMapTex(){return console.warn("Deprecated Function"),this.__glEnvMap}setScene(e){const t=e.settings.getParameter("EnvMap");null!=t.getValue()&&this.__bindEnvMap(t.getValue()),t.valueChanged.connect(()=>{this.__bindEnvMap(t.getValue());});const a=e.settings.getParameter("Display EnvMap");this.__displayEnvironment=a.getValue(),a.valueChanged.connect(()=>{this.__displayEnvironment=a.getValue(),this.requestRedraw();}),super.setScene(e);}addTreeItem(e){if(super.addTreeItem(e),e instanceof ua){const t=(e,t)=>{let a=t.image.getMetadata("gltexture");a||(a=new ka(this.__gl,t.image)),a.updated.connect(e=>{this.requestRedraw();}),this.__glLightmaps[e]={atlasSize:t.atlasSize,glimage:a};},a=e;a.loaded.connect(()=>{this.__glEnvMap&&a.getLightmap()&&t(a.getName(),a.getLightmap());});}}removeTreeItem(e){super.removeTreeItem(e);}addViewport(e){return super.addViewport(e)}onKeyPressed(e,t){switch(e){case"b":this.__displayEnvironment=!this.__displayEnvironment,this.requestRedraw();break;default:super.onKeyPressed(e,t);}}get exposure(){return this.__exposure}set exposure(e){this.__exposure=e,this.requestRedraw();}get gamma(){return this.__gamma}set gamma(e){this.__gamma=e,this.requestRedraw();}get displayEnvironment(){return this.__displayEnvironment}set displayEnvironment(e){this.__displayEnvironment=e,this.requestRedraw();}get planeDist(){return this._planeDist}set planeDist(e){this._planeDist=e,this.requestRedraw();}get cutPlaneNormal(){return this.__cutPlaneNormal}set cutPlaneNormal(e){this.__cutPlaneNormal=e,this.requestRedraw();}resizeFbos(e,t){super.resizeFbos(),this.__fbo&&this.__fbo.colorTexture.resize(e,t),this.__highlightedGeomsBufferFbo&&this.__highlightedGeomsBuffer.resize(e,t);}createSelectedGeomsFbo(){const e=this.__gl;this.__highlightedGeomsBuffer=new Fa(e,{type:"UNSIGNED_BYTE",format:"RGBA",filter:"NEAREST",width:this.__glcanvas.width<=1?1:this.__glcanvas.width,height:this.__glcanvas.height<=1?1:this.__glcanvas.height}),this.__highlightedGeomsBufferFbo=new Ha(e,this.__highlightedGeomsBuffer,!0),this.__highlightedGeomsBufferFbo.setClearColor([0,0,0,0]);}getFbo(){return this.__fbo}createOffscreenFbo(e="RGB"){const t=this.__glcanvas.width,a=this.__glcanvas.height,i=this.__gl;this.__fwBuffer=new Fa(i,{type:"FLOAT",format:e,filter:"NEAREST",width:t,height:a}),this.__fbo=new Ha(i,this.__fwBuffer,!0),this.__fbo.setClearColor(this.__backgroundColor.asArray());}createRayCastRenderTarget(){const e=this.__gl;this.__rayCastRenderTarget=new ei(e,{type:"FLOAT",format:"RGBA",filter:"NEAREST",width:3,height:3,numColorChannels:1}),this.__rayCastRenderTargetProjMatrix=new _,this.rayCastDist=0,this.rayCastArea=0;}raycastWithRay(e,t,a=.01,i=Mi){const s=new X;return s.setLookAt(e.start,e.start.add(e.dir)),this.raycast(s,e,t,a,i)}raycastWithXfo(e,t,a=.01,i=Mi){const s=new G(e.tr,e.ori.getZaxis().negate());return this.raycast(e,s,t,a,i)}raycast(e,t,a,i=.01,s=Mi){this.rayCastDist==a&&this.rayCastArea==i||(this.__rayCastRenderTargetProjMatrix.setOrthographicMatrix(-.5*i,.5*i,-.5*i,.5*i,0,a),this.rayCastDist=a,this.rayCastArea=i);const n=this.__gl,l={cameraMatrix:e.toMat4(),viewports:[{region:[0,0,3,3],viewMatrix:e.inverse().toMat4(),projectionMatrix:this.__rayCastRenderTargetProjMatrix,isOrthographic:!0}]};this.__rayCastRenderTarget.bindForWriting(l,!0),n.enable(n.CULL_FACE),n.enable(n.DEPTH_TEST),n.depthFunc(n.LEQUAL),n.depthMask(!0),this.drawSceneGeomData(l,s),n.finish(),this.__rayCastRenderTarget.unbindForWriting(),this.__rayCastRenderTarget.bindForReading();const r=new Float32Array(36);n.readPixels(0,0,3,3,n.RGBA,n.FLOAT,r),this.__rayCastRenderTarget.unbindForReading();const o=[4,3,5,1,7];let d;for(const e of o)if(0!=r[4*e+3]){d=r.subarray(4*e,4*e+4);break}if(!d)return;const h=63&Math.round(d[0]),c=this.getPass(h).getGeomItemAndDist(d);if(c){const e=t.start.add(t.dir.scale(c.dist));return {ray:t,intersectionPos:e,geomItem:c.geomItem,dist:c.dist,geomData:d}}}drawBackground(e){if(this.__glBackgroundMap){if(!this.__glBackgroundMap.isLoaded())return;const t=this.__gl;t.depthMask(!1),this.__backgroundMapShader.bind(e);const a=e.unifs;this.__glBackgroundMap.bindToUniform(e,a.backgroundImage),this.__backgroundMapShaderBinding.bind(e),t.drawQuad();}else this.__glEnvMap&&this.__glEnvMap.draw&&this.__glEnvMap.draw(e);}bindGLRenderer(e){super.bindGLBaseRenderer(e),e.envMap=this.__glEnvMap,e.exposure=this.__exposure,e.gamma=this.__gamma,e.lightmaps=this.__glLightmaps,e.boundLightmap=void 0;const t=this.__gl,a=e.bindRendererUnifs;e.bindRendererUnifs=i=>{if(a(i),this.__glEnvMap){const t=i.envMapPyramid;if(t&&this.__glEnvMap.bindProbeToUniform)this.__glEnvMap.bindProbeToUniform(e,t);else {const{envMapTex:t,envMapTexType:a}=i;t&&this.__glEnvMap.bindToUniform(e,t,{textureTypeUnif:a});}}{const e=i.exposure;e&&t.uniform1f(e.location,this.__exposure);}{const e=i.gamma;e&&t.uniform1f(e.location,this.__gamma);}};}drawScene(e){if(this.bindGLRenderer(e),this.__displayEnvironment&&this.drawBackground(e),super.drawScene(e),this.__highlightedGeomsBufferFbo){const t=this.__gl;this.__highlightedGeomsBufferFbo.bindForWriting(e),this.__highlightedGeomsBufferFbo.clear(),t.disable(t.BLEND),t.enable(t.DEPTH_TEST),t.depthFunc(t.LESS),t.depthMask(!0),this.drawHighlightedGeoms(e),this.__highlightedGeomsBufferFbo.unbindForWriting(e),t.viewport(...e.region),this.__outlineShader.bind(e),t.enable(t.BLEND),t.blendEquation(t.FUNC_ADD),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA);const a=e.unifs;this.__highlightedGeomsBuffer.bindToUniform(e,a.highlightDataTexture),t.uniform2f(a.highlightDataTextureSize.location,e.region[2],e.region[3]),this.quad.bindAndDraw(e),t.disable(t.BLEND);}this.redrawOccured.emit();}}Ja.setShaderModule("drawItemId.glsl","\n\n#ifdef ENABLE_FLOAT_TEXTURES\n\nattribute float instancedIds;    // instanced attribute..\nuniform int instancedDraw;\nuniform int transformIndex;\n\nint getDrawItemId() {\n    if(instancedDraw == 0){\n       return transformIndex;\n    }\n    else{\n       return int(instancedIds);\n    }\n}\n\n\n#else\n\nuniform int transformIndex;\n\nint getDrawItemId() {\n    return transformIndex;\n}\n\n#endif\n\n"),Ja.setShaderModule("drawItemTexture.glsl",'\n\n#ifdef ENABLE_FLOAT_TEXTURES\n\nuniform sampler2D instancesTexture;\nuniform highp int instancesTextureSize;\n\n<%include file="GLSLUtils.glsl"/>\n\nconst int pixelsPerItem = 6;\n\nvec4 getInstanceData(int id) {\n    return fetchTexel(instancesTexture, instancesTextureSize, (id * pixelsPerItem) + 0);\n}\n\n#else\n\nuniform vec4 drawItemData;\n\nvec4 getInstanceData(int id) {\n    return drawItemData;\n}\n\n#endif\n\n\n'),Ja.setShaderModule("modelMatrix.glsl","\n\n#ifdef ENABLE_FLOAT_TEXTURES\n\nmat4 getMatrix(sampler2D texture, int textureSize, int index) {\n    // Unpack 3 x 4 matix columns into a 4 x 4 matrix.\n    vec4 col0 = fetchTexel(texture, textureSize, (index * pixelsPerItem) + 1);\n    vec4 col1 = fetchTexel(texture, textureSize, (index * pixelsPerItem) + 2);\n    vec4 col2 = fetchTexel(texture, textureSize, (index * pixelsPerItem) + 3);\n    mat4 result = mat4(col0, col1, col2, vec4(0.0, 0.0, 0.0, 1.0));\n    return transpose(result);\n    // return mat4(1.0);\n}\n\nmat4 getModelMatrix(int id) {\n    return getMatrix(instancesTexture, instancesTextureSize, id);\n}\n\n#else\n\nuniform mat4 modelMatrix;\n\nmat4 getModelMatrix(int id) {\n    return modelMatrix;\n}\n\n#endif\n\n\n"),Ja.setShaderModule("materialparams.glsl","\n\n////////////////////////\n// Material Param Helpers.\n\nvec4 getColorParamValue(vec4 value, sampler2D tex, int texType, vec2 texCoord) {\n    if(texType == 0){\n        return toLinear(value);\n    }\n    else if(texType == 1 || texType == 2){\n        // TODO: Use SRGB textures.\n        return toLinear(texture2D(tex, texCoord));\n    }\n    else if(texType == 3){\n        // Float HDR Texture\n        return texture2D(tex, texCoord);\n    }\n    else\n        return value;\n}\n\n\n\nfloat luminanceFromRGB(vec3 rgb) {\n    return 0.2126*rgb.r + 0.7152*rgb.g + 0.0722*rgb.b;\n}\n\nfloat getLuminanceParamValue(float value, sampler2D tex, int texType, vec2 texCoord) {\n    if(texType == 0)\n        return value;\n    else\n        return luminanceFromRGB(texture2D(tex, texCoord).rgb);\n}\n"),Ja.setShaderModule("debugColors.glsl","\n\nfloat modI(float a, float b) {\n    float m=a-floor((a+0.5)/b)*b;\n    return floor(m+0.5);\n}\n\nvec3 getDebugColor(float id) {\n#ifdef GLSL_ES3\n    const vec3 clusterColors[4] = vec3[4]( vec3(0.0, 0.25, 0.25), vec3(0.0, 0.85, 0.25), vec3(0.0, 0.25, 0.85), vec3(0.0, 0.85, 0.85) );\n#else\n    vec3 clusterColors[8];\n    clusterColors[0] = vec3(0.0, 0.15, 0.15);\n    clusterColors[1] = vec3(0.0, 0.85, 0.15);\n    clusterColors[2] = vec3(0.0, 0.15, 0.85);\n    clusterColors[3] = vec3(0.0, 0.85, 0.85);\n    clusterColors[4] = vec3(0.75, 0.15, 0.15);\n    clusterColors[5] = vec3(0.75, 0.85, 0.15);\n    clusterColors[6] = vec3(0.75, 0.15, 0.85);\n    clusterColors[7] = vec3(0.75, 0.85, 0.85);\n#endif\n\n    if(modI(id, 8.0) == 0.0)\n        return clusterColors[0];\n    else if(modI(id, 8.0) == 1.0)\n        return clusterColors[1];\n    else if(modI(id, 8.0) == 2.0)\n        return clusterColors[2];\n    else if(modI(id, 8.0) == 3.0)\n        return clusterColors[3];\n    else if(modI(id, 8.0) == 4.0)\n        return clusterColors[4];\n    else if(modI(id, 8.0) == 5.0)\n        return clusterColors[5];\n    else if(modI(id, 8.0) == 6.0)\n        return clusterColors[6];\n    else if(modI(id, 8.0) == 7.0)\n        return clusterColors[7];\n\n    return vec3(1,0,0);\n}\n\n\n");class Ti extends Pa{constructor(e){super(e),this.__shaderStages.VERTEX_SHADER=Ja.parseShader("BillboardShader.vertexShader",'\nprecision highp float;\n\n\n<%include file="utils/quadVertexFromID.glsl"/>\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\nuniform mat4 cameraMatrix;\n\n#ifdef ENABLE_FLOAT_TEXTURES\n\ninstancedattribute float instanceIds;\n\n<%include file="GLSLUtils.glsl"/>\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="utils/imageAtlas.glsl"/>\n\nuniform sampler2D atlasBillboards_layout;\nuniform vec4 atlasBillboards_desc;\n\nuniform sampler2D instancesTexture;\nuniform int instancesTextureSize;\n\n\nconst int cols_per_instance = 5;\n\nmat4 getMatrix(sampler2D texture, int textureSize, int index) {\n  // Unpack 3 x 4 matix columns into a 4 x 4 matrix.\n  vec4 col0 = fetchTexel(texture, textureSize, (index * cols_per_instance) + 0);\n  vec4 col1 = fetchTexel(texture, textureSize, (index * cols_per_instance) + 1);\n  vec4 col2 = fetchTexel(texture, textureSize, (index * cols_per_instance) + 2);\n  mat4 result = mat4(col0, col1, col2, vec4(0.0, 0.0, 0.0, 1.0));\n  return transpose(result);\n  // return mat4(1.0);\n}\n\nmat4 getModelMatrix(int id) {\n  return getMatrix(instancesTexture, instancesTextureSize, id);\n}\nvec4 getInstanceData(int id) {\n  return fetchTexel(instancesTexture, instancesTextureSize, (id * cols_per_instance) + 3);\n}\nvec4 getTintColor(int id) {\n  return fetchTexel(instancesTexture, instancesTextureSize, (id * cols_per_instance) + 4);\n}\n\n\n#else\n\nuniform vec4 atlasBillboards_desc;\n\nuniform mat4 modelMatrix;\nuniform vec4 billboardData;\nuniform vec4 tintColor;\nuniform vec4 layoutData;\n\n\n#endif\n\nmat4 calcLookAtMatrix(vec3 origin, vec3 target, float roll) {\n  // vec3 rr = vec3(sin(roll), 0.0, cos(roll));\n  vec3 rr = vec3(0.0, 0.0, 1.0);\n  vec3 ww = normalize(target - origin);\n  vec3 uu = normalize(cross(rr, ww));\n  vec3 vv = normalize(cross(ww, uu));\n\n  return mat4(vec4(uu, 0.0), vec4(vv, 0.0), vec4(ww, 0.0), vec4(origin, 1.0));\n}\n\nfloat map(float value, float inMin, float inMax, float outMin, float outMax) {\n  return outMin + (outMax - outMin) * (value - inMin) / (inMax - inMin);\n}\n\n/* VS Outputs */\nvarying vec2 v_texCoord;\nvarying float v_alpha;\nvarying vec4 v_tint;\n\nvoid main(void) {\n\n#ifdef ENABLE_FLOAT_TEXTURES\n\n  int instanceID = int(instanceIds);\n\n  mat4 modelMatrix = getModelMatrix(instanceID);\n  vec4 billboardData = getInstanceData(instanceID);\n  vec4 layoutData = fetchTexel(atlasBillboards_layout, int(atlasBillboards_desc.z), int(billboardData.z));\n  v_tint = getTintColor(instanceID);\n\n#else\n\n  v_tint = tintColor;\n\n#endif\n\n  vec2 quadVertex = getQuadVertexPositionFromID();\n\n\n  v_texCoord = vec2(quadVertex.x, -quadVertex.y) + 0.5;\n  v_alpha = billboardData.w;\n  v_texCoord *= layoutData.zw;\n  v_texCoord += layoutData.xy;\n\n  float scl = billboardData.x;\n  float width = layoutData.z * atlasBillboards_desc.x * scl * 0.002;\n  float height = layoutData.w * atlasBillboards_desc.y * scl * 0.002;\n  int flags = int(billboardData.y);\n  bool alignedToCamera = flags > 0;\n  if(alignedToCamera){\n    vec3 cameraPos = vec3(cameraMatrix[3][0], cameraMatrix[3][1], cameraMatrix[3][2]);\n    vec3 billboardPos = vec3(modelMatrix[3][0], modelMatrix[3][1], modelMatrix[3][2]);\n    mat4 lookAt = calcLookAtMatrix(billboardPos, cameraPos, 0.0);\n    mat4 modelViewProjectionMatrix = projectionMatrix * viewMatrix * lookAt;\n    gl_Position = modelViewProjectionMatrix * vec4(quadVertex.x * width, (quadVertex.y + 0.5) * height, 0.0, 1.0);\n  }\n  else{\n    mat4 modelViewProjectionMatrix = projectionMatrix * viewMatrix * modelMatrix;\n    gl_Position = modelViewProjectionMatrix * vec4(quadVertex.x * width, (quadVertex.y + 0.5) * height, 0.0, 1.0);\n  }\n\n  bool overlay = flags > 0;\n  if(overlay){\n    gl_Position.z -= 0.05;\n  }\n}\n'),this.__shaderStages.FRAGMENT_SHADER=Ja.parseShader("BillboardShader.fragmentShader",'\nprecision highp float;\n\n<%include file="stack-gl/gamma.glsl"/>\n<%include file="GLSLUtils.glsl"/>\n<%include file="materialparams.glsl"/>\n<%include file="utils/imageAtlas.glsl"/>\n\nuniform sampler2D atlasBillboards;\n\n/* VS Outputs */\nvarying vec2 v_texCoord;\nvarying float v_alpha;\nvarying vec4 v_tint;\n\n\n#ifdef ENABLE_ES3\n  out vec4 fragColor;\n#endif\nvoid main(void) {\n#ifndef ENABLE_ES3\n  vec4 fragColor;\n#endif\n\n  fragColor = texture2D(atlasBillboards, v_texCoord) * v_tint;\n  fragColor.a *= v_alpha;\n\n  // fragColor.r = 1.0;\n  // fragColor.a = 1.0;\n  \n#ifndef ENABLE_ES3\n  gl_FragColor = fragColor;\n#endif\n}\n');}}class Ci extends Pa{constructor(e){super(e),this.__shaderStages.VERTEX_SHADER=Ja.parseShader("DepthMapShader.vertexShader","\nprecision highp float;\n\nattribute vec3 positions;    //(location = 0)\n\nuniform mat4 modelMatrix;\nuniform mat4 lightViewMatrix;\nuniform mat4 lightProjectionMatrix;\n\n/* VS Outputs */\nvarying vec3 v_viewPos;\n\nvoid main(void) {\n  mat4 modelViewMatrix = lightViewMatrix * modelMatrix;\n  v_viewPos = modelViewMatrix * vec4(positions, 1.0);\n  gl_Position = lightProjectionMatrix * v_viewPos;\n}\n\n"),this.__shaderStages.FRAGMENT_SHADER=Ja.parseShader("DepthMapShader.fragmentShader","\n#extension GL_OES_standard_derivatives : enable\nprecision highp float;\n\nuniform float near;\nuniform float far;\n\nvarying vec3 v_viewPos;\n\nfloat linstep(float edge0, float edge1, float value){\n  return clamp((value-edge0)/(edge1-edge0), 0.0, 1.0);\n}\n\nvoid main(void) {\n  float depth = linstep(near, far, -v_viewPos.z);\n  //gl_FragColor = vec4(depth, depth, depth,  1.0);\n\n  float dx = dFdx(depth);\n  float dy = dFdy(depth);\n  gl_FragColor = vec4(depth, pow(depth, 2.0) + 0.25*(dx*dx + dy*dy), 0.0, 1.0);\n}\n");}}class Yi extends Pa{constructor(e){super(e),this.__shaderStages.VERTEX_SHADER=Ja.parseShader("EnvProjectionShader.vertexShader",'\nprecision highp float;\n\nattribute vec3 positions;    //(location = 0)\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\nuniform vec3 projectionCenter;\n\n<%include file="stack-gl/inverse.glsl"/>\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n\n/* VS Outputs */\nvarying vec3 v_worldDir;\n \nvoid main()\n{\n  int drawItemId = getDrawItemId();\n  vec4 pos = vec4(positions, 1.);\n  mat4 modelMatrix = getModelMatrix(drawItemId);\n  mat4 modelViewProjectionMatrix = projectionMatrix * viewMatrix * modelMatrix;\n\n  gl_Position = modelViewProjectionMatrix * pos;\n\n  vec4 worldPos = modelMatrix * pos;\n  v_worldDir = worldPos.xyz - projectionCenter;\n}\n\n'),this.finalize();}static getParamDeclarations(){const e=super.getParamDeclarations();return e.push({name:"projectionCenter",defaultValue:new d(0,0,1.7)}),e}}class Ni extends Yi{constructor(e){super(e),this.__shaderStages.FRAGMENT_SHADER=Ja.parseShader("OctahedralEnvProjectionShader.fragmentShader",'\nprecision highp float;\n\n<%include file="math/constants.glsl"/>\n<%include file="GLSLUtils.glsl"/>\n<%include file="pragmatic-pbr/envmap-octahedral.glsl"/>\n<%include file="stack-gl/gamma.glsl"/>\n<%include file="materialparams.glsl"/>\n\n\nuniform color envMap;\nuniform sampler2D envMapTex;\nuniform int envMapTexType;\n\n\nuniform float exposure;\n\n/* VS Outputs */\nvarying vec3 v_worldDir;\n\n#ifdef ENABLE_ES3\n  out vec4 fragColor;\n#endif\nvoid main(void) {\n#ifndef ENABLE_ES3\n  vec4 fragColor;\n#endif\n\n  vec2 texCoord = dirToSphOctUv(normalize(v_worldDir));\n  vec4 env = getColorParamValue(envMap, envMapTex, envMapTexType, texCoord);\n\n  fragColor = vec4(env.rgb/env.a, 1.0);\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n  fragColor.rgb = toGamma(fragColor.rgb * exposure);\n#endif\n\n#ifndef ENABLE_ES3\n  gl_FragColor = fragColor;\n#endif\n}\n'),this.finalize();}}C.registerClass("OctahedralEnvProjectionShader",Ni);class Ki extends Yi{constructor(e){super(e),this.__shaderStages.FRAGMENT_SHADER=Ja.parseShader("LatLongEnvProjectionShader.fragmentShader",'\nprecision highp float;\n\n<%include file="math/constants.glsl"/>\n<%include file="GLSLUtils.glsl"/>\n<%include file="pragmatic-pbr/envmap-equirect.glsl"/>\n<%include file="stack-gl/gamma.glsl"/>\n<%include file="materialparams.glsl"/>\n\nuniform color envMap;\nuniform sampler2D envMapTex;\nuniform int envMapTexType;\n\nuniform float exposure;\n\n/* VS Outputs */\nvarying vec3 v_worldDir;\n\n#ifdef ENABLE_ES3\n  out vec4 fragColor;\n#endif\nvoid main(void) {\n#ifndef ENABLE_ES3\n  vec4 fragColor;\n#endif\n\n  vec2 texCoord = latLongUVsFromDir(normalize(v_worldDir));\n  vec4 env = getColorParamValue(envMap, envMapTex, envMapTexType, texCoord);\n  fragColor = vec4(env.rgb/env.a, 1.0);\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n  fragColor.rgb = toGamma(fragColor.rgb * exposure);\n#endif\n\n\n#ifndef ENABLE_ES3\n  gl_FragColor = fragColor;\n#endif\n}\n'),this.finalize();}}C.registerClass("LatLongEnvProjectionShader",Ki);class wi extends Pa{constructor(e){super(e),this.__shaderStages.VERTEX_SHADER=Ja.parseShader("FatLinesShader.vertexShader",'\nprecision highp float;\n\ninstancedattribute vec2 segmentIndices;\nattribute float vertexIDs;\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\n\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="drawItemId.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n\nuniform sampler2D positionsTexture;\nuniform int positionsTextureSize;\n\nuniform float LineThickness;\n\n/* VS Outputs */\nvarying vec3 v_viewPos;\nvarying vec3 v_viewNormal;\nvarying vec2 v_texCoord;\n\nvoid main(void) {\n  int drawItemId = getDrawItemId();\n  int vertexID = int(vertexIDs);\n\n  mat4 modelMatrix = getModelMatrix(drawItemId);\n  mat4 modelViewMatrix = viewMatrix * modelMatrix;\n\n  int seqentialIndex_0 = int(mod(segmentIndices.x, 2.));\n  int seqentialIndex_1 = int(mod(segmentIndices.y, 2.));\n  int index_0 = int(segmentIndices.x) / 2;\n  int index_1 = int(segmentIndices.y) / 2;\n\n  vec3 viewPos;\n  vec4 data_0 = fetchTexel(positionsTexture, positionsTextureSize, index_0);\n  vec4 data_1 = fetchTexel(positionsTexture, positionsTextureSize, index_1);\n\n  vec4 pos_0 = modelViewMatrix * vec4(data_0.xyz, 1.0);\n  vec4 pos_1 = modelViewMatrix * vec4(data_1.xyz, 1.0);\n  // Note: multiply the per-vertex line thickness with the line thickness uniform value;\n  float lineThickness_0 = LineThickness * data_0.w;\n  float lineThickness_1 = LineThickness * data_1.w;\n\n  if(vertexID < 2){\n    viewPos = pos_0.xyz;\n  }\n  else{\n    viewPos = pos_1.xyz;\n  }\n  if(pos_1 != pos_0){\n    vec3 segmentDir = normalize(pos_1.xyz - pos_0.xyz);\n    vec3 viewVector = normalize(viewPos);\n\n    if(vertexID < 2){\n      vec3 segmentStartDir = segmentDir;\n      if(seqentialIndex_0 != 0){\n        //if index_0 == 0, get the last index in the line as previous\n        int index_prev = (index_0 > 0) ? (index_0-1) : (positionsTextureSize-1);\n        vec4 data_prev = fetchTexel(positionsTexture, positionsTextureSize, index_prev);\n        vec4 pos_prev = modelViewMatrix * vec4(data_prev.xyz, 1.0);\n        segmentStartDir = normalize(segmentDir + normalize(pos_0.xyz - pos_prev.xyz));\n      }\n      vec3 startBiTangent = normalize(cross(segmentStartDir, viewVector));\n      v_viewNormal = normalize(cross(segmentStartDir, startBiTangent));\n      // Move the endpoints to overlap a bit more.\n      //viewPos -= vec3(segmentStartDir * lineThickness_0 * 0.25);\n      if(mod(vertexIDs, 2.0) == 0.0){\n        viewPos += vec3(startBiTangent * lineThickness_0);\n        v_texCoord.x = 1.0;\n      }\n      else{\n        viewPos -= vec3(startBiTangent * lineThickness_0);\n        v_texCoord.x = 0.0;\n      }\n      v_texCoord.y = 0.0;\n    }\n    else{\n      vec3 segmentEndDir = segmentDir;\n      if(seqentialIndex_1 != 0){\n        //if index_1 == numPoints-1, get the first index in the line as next\n        int index_next = (index_1 < (positionsTextureSize-1)) ? (index_1+1) : 0;\n        vec4 data_next = fetchTexel(positionsTexture, positionsTextureSize, index_next);\n        vec4 pos_next = modelViewMatrix * vec4(data_next.xyz, 1.0);\n        segmentEndDir = normalize(segmentDir + normalize(pos_next.xyz - pos_1.xyz));\n      }\n      vec3 endBiTangent = normalize(cross(segmentEndDir, viewVector));\n      v_viewNormal = normalize(cross(segmentEndDir, endBiTangent));\n      // Move the endpoints to overlap a bit more.\n      //viewPos += vec3(segmentEndDir * lineThickness_1 * 0.25);\n      if(mod(vertexIDs, 2.0) == 0.0){\n        viewPos += vec3(endBiTangent * lineThickness_1);\n        v_texCoord.x = 1.0;\n      }\n      else{\n        viewPos -= vec3(endBiTangent * lineThickness_1);\n        v_texCoord.x = 0.0;\n      }\n      v_texCoord.y = 1.0;\n    }\n\n    // Move the line towards the viewer by the line thickness.\n    // this is to avoid depth issues when lines are rendered over meshes. \n    viewPos.z -= (lineThickness_0 + lineThickness_1) * 0.25;\n  }\n\n  v_viewPos       = viewPos;\n  gl_Position     = projectionMatrix * vec4(viewPos, 1.0);\n}\n'),this.__shaderStages.FRAGMENT_SHADER=Ja.parseShader("FatLinesShader.fragmentShader","\nprecision highp float;\n\n/* VS Outputs */\nvarying vec3 v_viewPos;\nvarying vec3 v_viewNormal;\nvarying vec2 v_texCoord;\n\nuniform color BaseColor;\nuniform mat4 cameraMatrix;\n\n#ifdef ENABLE_ES3\n  out vec4 fragColor;\n#endif\nvoid main(void) {\n#ifndef ENABLE_ES3\n  vec4 fragColor;\n#endif\n\n  int debugLevel = 0;\n  if(debugLevel == 0){\n\n    vec3 viewVector = mat3(cameraMatrix) * normalize(-v_viewPos);\n    vec3 normal = mat3(cameraMatrix) * v_viewNormal;\n    float NdotV = dot(normalize(normal), normalize(viewVector));\n\n    // Modulate the lighting using the texture coord so the line looks round.\n    NdotV *= cos((v_texCoord.x - 0.5) * 2.0);\n\n    vec4 color = BaseColor * NdotV;\n    fragColor = vec4(color.rgb, BaseColor.a);\n  }\n  else{\n    fragColor = vec4(v_texCoord.x, 0.0, 0.0, 1.0);\n  }\n\n#ifndef ENABLE_ES3\n  gl_FragColor = fragColor;\n#endif\n}\n"),this.finalize();}bind(e){return !!super.bind(e)&&(e.supportsInstancing=!1,!0)}static getParamDeclarations(){const e=super.getParamDeclarations();return e.push({name:"BaseColor",defaultValue:new u(1,1,.5)}),e.push({name:"Opacity",defaultValue:1}),e}}C.registerClass("FatLinesShader",wi),Ja.setShaderModule("stack-gl/gamma.glsl","\n\nconst float gamma_const = 2.2;\n\nfloat toLinear(float v) {\n  return pow(v, gamma_const);\n}\n\nvec2 toLinear(vec2 v) {\n  return pow(v, vec2(gamma_const));\n}\n\nvec3 toLinear(vec3 v) {\n  return pow(v, vec3(gamma_const));\n}\n\nvec4 toLinear(vec4 v) {\n  return vec4(toLinear(v.rgb), v.a);\n}\n\n\nfloat toGamma(float v) {\n  return pow(v, 1.0 / gamma_const);\n}\n\nvec2 toGamma(vec2 v) {\n  return pow(v, vec2(1.0 / gamma_const));\n}\n\nvec3 toGamma(vec3 v) {\n  return pow(v, vec3(1.0 / gamma_const));\n}\n\nvec4 toGamma(vec4 v) {\n  return vec4(toGamma(v.rgb), v.a);\n}\n\nfloat toGamma(float v, float gamma) {\n  return pow(v, 1.0 / gamma);\n}\n\nvec2 toGamma(vec2 v, float gamma) {\n  return pow(v, vec2(1.0 / gamma));\n}\n\nvec3 toGamma(vec3 v, float gamma) {\n  return pow(v, vec3(1.0 / gamma));\n}\n\nvec4 toGamma(vec4 v, float gamma) {\n  return vec4(toGamma(v.rgb, gamma), v.a);\n}\n\n\n");class zi extends Pa{constructor(e){super(e),this.__shaderStages.VERTEX_SHADER=Ja.parseShader("FlatSurfaceShader.vertexShader",'\nprecision highp float;\n\nattribute vec3 positions;\n#ifdef ENABLE_TEXTURES\nattribute vec2 texCoords;\n#endif\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\n\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="drawItemId.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n\n/* VS Outputs */\nvarying vec3 v_viewPos;\n#ifdef ENABLE_TEXTURES\nvarying vec2 v_textureCoord;\n#endif\n\n\nvoid main(void) {\n  int drawItemId = getDrawItemId();\n    mat4 modelMatrix = getModelMatrix(drawItemId);\n    mat4 modelViewMatrix = viewMatrix * modelMatrix;\n\n    vec4 viewPos = (modelViewMatrix * vec4(positions, 1.0));\n    gl_Position = projectionMatrix * viewPos;\n\n    v_viewPos = viewPos.xyz;\n    v_textureCoord = texCoords;\n    v_textureCoord.y = 1.0 - v_textureCoord.y;// Flip y\n}\n'),this.__shaderStages.FRAGMENT_SHADER=Ja.parseShader("FlatSurfaceShader.fragmentShader",'\nprecision highp float;\n\n<%include file="stack-gl/gamma.glsl"/>\n<%include file="materialparams.glsl"/>\n\nuniform color BaseColor;\n\n#ifdef ENABLE_TEXTURES\nuniform sampler2D BaseColorTex;\nuniform int BaseColorTexType;\n#endif\n\n/* VS Outputs */\nvarying vec3 v_viewPos;\n#ifdef ENABLE_TEXTURES\nvarying vec2 v_textureCoord;\n#endif\n\n\n#ifdef ENABLE_ES3\n    out vec4 fragColor;\n#endif\nvoid main(void) {\n\n#ifndef ENABLE_TEXTURES\n    vec4 baseColor = BaseColor;\n#else\n    vec4 baseColor      = getColorParamValue(BaseColor, BaseColorTex, BaseColorTexType, v_textureCoord);\n#endif\n\n#ifndef ENABLE_ES3\n    vec4 fragColor;\n#endif\n    fragColor = baseColor;\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n    fragColor.rgb = toGamma(fragColor.rgb);\n#endif\n\n#ifndef ENABLE_ES3\n    gl_FragColor = fragColor;\n#endif\n}\n'),this.finalize();}static getParamDeclarations(){const e=super.getParamDeclarations();return e.push({name:"BaseColor",defaultValue:new u(1,1,.5)}),e}static getGeomDataShaderName(){return "StandardSurfaceGeomDataShader"}static getSelectedShaderName(){return "StandardSurfaceSelectedGeomsShader"}}C.registerClass("FlatSurfaceShader",zi);class Ui extends zi{static isTransparent(){return !0}bind(e,t){return "ADD"==e.pass&&super.bind(e,t)}}C.registerClass("FlatAlphaSurfaceShader",Ui),Ja.setShaderModule("math/constants.glsl","\n\n#define PI 3.141592653589793\n#define TwoPI (2.0 * PI)\n#define HalfPI (0.5 * PI)\n\n"),Ja.setShaderModule("GGX_Specular.glsl",'\n\n\n<%include file="pragmatic-pbr/envmap-octahedral.glsl"/>\n<%include file="utils/imagePyramid.glsl"/>\n\n// uniform ImageAtlas envMap;\n// see: GLImageAtlas.js: line 460.\nuniform sampler2D   envMapPyramid;\nuniform sampler2D   envMapPyramid_layout;\nuniform vec4        envMapPyramid_desc;\n\n\nvec3 sampleEnvMap(vec3 dir, float roughness) {\n    return sampleImagePyramid(dirToSphOctUv(dir), roughness, envMapPyramid_layout, envMapPyramid, envMapPyramid_desc).rgb;\n}\n\n\n// Borrowed heavily from here: http://www.codinglabs.net/article_physically_based_rendering_cook_torrance.aspx\n\nvec3 Fresnel_Schlick(float cosT, vec3 F0)\n{\n    return F0 + (vec3(1.0)-F0) * vec3(pow( 1.0 - cosT, 5.0));\n\n    // for now we calculate this in the suface shader\n    // float schlick = reflectance + pow((1.0-reflectance)*(1.0-dot(N,V)), 5.0);\n}\n\nfloat chiGGX(float v)\n{\n    return v > 0.0 ? 1.0 : 0.0;\n}\n\nfloat saturate(float v)\n{\n    return clamp(v, 0.0, 1.0);\n}\n\nvec3 saturate(vec3 v)\n{\n    return clamp(v, vec3(0.0), vec3(1.0));\n}\n\nfloat saturatedDot( in vec3 a, in vec3 b )\n{\n    return max( dot( a, b ), 0.0 );   \n}\n\nfloat GGX_PartialGeometryTerm(vec3 v, vec3 n, vec3 h, float alpha)\n{\n    float VoH2 = saturate(dot(v,h));\n    float chi = chiGGX( VoH2 / saturate(dot(v,n)) );\n    VoH2 = VoH2 * VoH2;\n    float tan2 = ( 1.0 - VoH2 ) / VoH2;\n    return (chi * 2.0) / ( 1.0 + sqrt( 1.0 + alpha * alpha * tan2 ) );\n}\n\nvec3 GGX_Specular_PrefilteredEnv(vec3 normal, vec3 viewVector, float roughness, float fresnel)\n{\n    vec3 reflectionVector = reflect(-viewVector, normal);\n    vec3 radiance = vec3(0.0);\n    float NoV = saturate(dot(normal, viewVector));\n\n    vec3 sampleVector = reflectionVector;\n\n    // Calculate the half vector\n    vec3 halfVector = normalize(sampleVector + viewVector);\n    float cosT = saturatedDot(reflectionVector, normal);\n    float sinT = sqrt( 1.0 - cosT * cosT);\n\n    // Calculate fresnel\n    // vec3 fresnel = Fresnel_Schlick( saturate(dot( halfVector, viewVector ) ), F0 );\n    // Geometry term\n    float geometry = GGX_PartialGeometryTerm(viewVector, normal, halfVector, clamp(roughness, 0.01, 1.0)) * GGX_PartialGeometryTerm(reflectionVector, normal, halfVector, clamp(roughness, 0.01, 1.0));\n\n    // Calculate the Cook-Torrance denominator\n    float denominator = clamp( 4.0 * (NoV * saturate(dot(halfVector, normal)) + 0.05), 0.0, 1.0 );\n    // kS += fresnel;\n\n    // Accumulate the radiance\n    vec3 envColor = sampleEnvMap(reflectionVector, roughness);\n    radiance += envColor * geometry * fresnel * sinT / denominator;\n    //radiance += envColor * fresnel; // Removing "geometry" for now until we construct a better geometric shading term\n\n    return radiance;        \n}\n'),Ja.setShaderModule("PBRSurfaceRadiance.glsl","\n\nstruct MaterialParams {\n    vec3 baseColor;\n    float metallic;\n    float roughness;\n    float reflectance;\n};\n\nvec4 pbrSpecularReflectance(in MaterialParams materialParams, vec3 normal, in vec3 viewVector) {\n\n    float NdotV = dot(normal, viewVector);\n    \n    // -------------------------- Specular Reflectance --------------------------\n    // vec3 ks = vec3(0.0);\n    // vec3 specular = GGX_Specular_PrefilteredEnv(normal, viewVector, materialParams.roughness, F0, ks );\n    // vec3 kd = (vec3(1.0) - ks) * vec3(1.0 - metallic);    \n\n    float schlickFresnel = materialParams.reflectance + pow((1.0-materialParams.reflectance)*(1.0-NdotV), 5.0);\n\n    vec3 specularReflectance = GGX_Specular_PrefilteredEnv(normal, viewVector, materialParams.roughness, schlickFresnel);\n\n\n    // -------------------------- Specular Occlusion --------------------------\n    // Fast and quick way of reducing specular reflection in areas that are less exposed to the environment\n    // A better approch is to try screen space specular occlusion but need to check performance and feasibility in webGL\n    //float specularOcclusion = clamp(length(irradiance), 0.01, 1.0);    \n    //specularReflectance = (specularReflectance * specularOcclusion); \n\n    return vec4(specularReflectance, schlickFresnel);\n}\n\n\nvec3 pbrSurfaceRadiance(in MaterialParams materialParams, vec3 irradiance, vec3 normal, in vec3 viewVector) {\n\n    float NdotV = dot(normal, viewVector);\n    vec3 specularReflectance;\n\n    // -------------------------- Diffuse Reflectance --------------------------\n\n    vec3 diffuseReflectance = materialParams.baseColor * irradiance;\n\n    // From the Disney dielectric BRDF    \n    // Need to check if this is useful for us but the implementation works based on their paper\n    //diffuseReflectance = (diffuseReflectance / PI); // << [PT 18-08-2018] What did this line do??? (makes everything 3.1x darker.)\n    // diffuseReflectance = vec3(mix(diffuseReflectance, diffuseReflectance * mix(0.5, 2.5, materialParams.roughness), pow(1.0 - NdotV, 5.0)));\n    diffuseReflectance = vec3(mix(diffuseReflectance, diffuseReflectance * mix(0.5, 1.0, materialParams.roughness), pow(1.0 - NdotV, 5.0)));\n\n\n    // -------------------------- Color at normal incidence --------------------------\n    \n    // Need to use 'Reflectance' here instead of 'ior'\n    //vec3 F0 = vec3(abs((1.0 - ior) / (1.0 + ior)));    \n    //F0 = F0 * F0;\n    //F0 = mix(F0, materialParams.baseColor, materialParams.metallic);      \n\n\n    // -------------------------- Specular Reflectance --------------------------\n    // vec3 ks = vec3(0.0);\n    // vec3 specular = GGX_Specular_PrefilteredEnv(normal, viewVector, materialParams.roughness, F0, ks );\n    // vec3 kd = (vec3(1.0) - ks) * vec3(1.0 - metallic);    \n\n    float schlickFresnel = materialParams.reflectance + pow((1.0-materialParams.reflectance)*(1.0-NdotV), 5.0);\n\n    specularReflectance = GGX_Specular_PrefilteredEnv(normal, viewVector, materialParams.roughness, schlickFresnel);\n\n\n    // -------------------------- Specular Occlusion --------------------------\n    // Fast and quick way of reducing specular reflection in areas that are less exposed to the environment\n    // A better approch is to try screen space specular occlusion but need to check performance and feasibility in webGL\n    //float specularOcclusion = clamp(length(irradiance), 0.01, 1.0);    \n    //specularReflectance = (specularReflectance * specularOcclusion);  \n      \n\n    // -------------------------- Metallic --------------------------\n    // We need to do few things given a higher > 0 metallic value\n    //      1. tint specular reflectance by the albedo color (not at grazing angles)\n    //      2. almost elliminate all diffuse reflectance (in reality metals have some diffuse due to layering (i.e. dust, prints, etc.))\n    //      3. set \"specular\" artistic value to metallic range (0.6 - 0.85)\n\n    specularReflectance = mix(specularReflectance, specularReflectance * materialParams.baseColor, materialParams.metallic);\n    diffuseReflectance = mix(diffuseReflectance, vec3(0.0,0.0,0.0), materialParams.metallic); // Leaveing at pure black for now but always need some %3 diffuse left for imperfection of pulished pure metal\n    // Would be best to compute reflectace internally and set here to 0.6-0.85 for metals\n    \n\n    // -------------------------- Final color --------------------------\n    // Energy conservation already taken into account in both the diffuse and specular reflectance\n    vec3 radiance = diffuseReflectance + specularReflectance;\n\n    // radiance = vec4( kd * diffuse + /*ks */ specular, 1);\n    return radiance;\n}\n");class Ji extends Pa{constructor(e){super(e),this.__shaderStages.VERTEX_SHADER=Ja.parseShader("LayeredCarPaintShader.vertexShader",'\nprecision highp float;\n\nattribute vec3 positions;\nattribute vec3 normals;\n#ifdef ENABLE_TEXTURES\nattribute vec2 texCoords;\n#endif\nattribute vec2 lightmapCoords;\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\n\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="stack-gl/inverse.glsl"/>\n<%include file="drawItemId.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n\nattribute float clusterIDs;\nuniform vec2 lightmapSize;\n\n/* VS Outputs */\nvarying vec4 v_geomItemData;\nvarying vec3 v_viewPos;\nvarying vec3 v_viewNormal;\n#ifdef ENABLE_TEXTURES\nvarying vec2 v_textureCoord;\n#endif\n// varying vec2 v_lightmapCoord;\n// #ifdef ENABLE_DEBUGGING_LIGHTMAPS\n// varying float v_clusterID;\n// #endif\nvarying vec3 v_worldPos;\n/* VS Outputs */\n\nvoid main(void) {\n    int drawItemId = getDrawItemId();\n\n    v_geomItemData = getInstanceData(drawItemId);\n\n    vec4 pos = vec4(positions, 1.);\n    mat4 modelMatrix = getModelMatrix(drawItemId);\n    mat4 modelViewMatrix = viewMatrix * modelMatrix;\n    vec4 viewPos    = modelViewMatrix * pos;\n    gl_Position     = projectionMatrix * viewPos;\n\n\n#ifdef ENABLE_TEXTURES\n    v_textureCoord  = texCoords;\n#endif\n    // v_lightmapCoord = (lightmapCoords + geomItemData.zw) / lightmapSize;\n\n    // mat4 mvp = projectionMatrix * viewMatrix * modelMatrix;\n    // gl_Position = mvp * vec4((lightmapCoords + geomItemData.xy), 0., 1.);\n// #ifdef ENABLE_DEBUGGING_LIGHTMAPS\n//     v_clusterID = clusterIDs;\n// #endif\n\n    v_worldPos      = (modelMatrix * pos).xyz;\n    mat3 normalMatrix = mat3(transpose(inverse(modelViewMatrix)));\n    v_viewPos       = -viewPos.xyz;\n    v_viewNormal    = normalMatrix * normals;\n}\n'),this.__shaderStages.FRAGMENT_SHADER=Ja.parseShader("LayeredCarPaintShader.fragmentShader",'\n#ifndef ENABLE_ES3\n    #extension GL_OES_standard_derivatives : enable\n#endif\nprecision highp float;\n\n<%include file="math/constants.glsl"/>\n<%include file="GLSLUtils.glsl"/>\n<%include file="GGX_Specular.glsl"/>\n<%include file="PBRSurfaceRadiance.glsl"/>\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n<%include file="stack-gl/gamma.glsl"/>\n#endif\n<%include file="materialparams.glsl"/>\n\n/* VS Outputs */\nvarying vec4 v_geomItemData;\nvarying vec3 v_viewPos;\nvarying vec3 v_viewNormal;\n#ifdef ENABLE_TEXTURES\nvarying vec2 v_textureCoord;\n#endif\n// varying vec2 v_lightmapCoord;\n// #ifdef ENABLE_DEBUGGING_LIGHTMAPS\n// varying float v_clusterID;\n// #endif\nvarying vec3 v_worldPos;\n/* VS Outputs */\n\n\nuniform sampler2D lightmap;\nuniform vec2 lightmapSize;\n#ifdef ENABLE_DEBUGGING_LIGHTMAPS\n<%include file="debugColors.glsl"/>\nuniform bool debugLightmapTexelSize;\n#endif\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\nuniform float exposure;\n#endif\n\nuniform mat4 cameraMatrix;\n\nuniform color BaseColor;\nuniform color MidColorTint;\nuniform float MidColorTintReflectance;\n\nuniform float MicroflakePerturbation;\nuniform sampler2D FlakesNormalTex;\nuniform float FlakesScale;\n\n#ifdef ENABLE_SPECULAR\n\nuniform float BaseRoughness;\nuniform float BaseMetallic;\nuniform float BaseReflectance;\nuniform float GlossRoughness;\nuniform float GlossMetallic;\nuniform float GlossReflectance;\n\n#endif\n\n#ifdef ENABLE_TEXTURES\n\nuniform sampler2D BaseColorTex;\nuniform int BaseColorTexType;\n\n#endif\n\n// Followup: Normal Mapping Without Precomputed Tangents\n// http://www.thetenthplanet.de/archives/1180\nmat3 cotangent_frame( vec3 normal, vec3 position, vec2 uv )\n{\n    // get edge vectors of the pixel triangle\n    vec3 dp1 = dFdx( position );\n    vec3 dp2 = dFdy( position );\n    vec2 duv1 = dFdx( uv );\n    vec2 duv2 = dFdy( uv );\n \n    // solve the linear system\n    vec3 dp2perp = cross( dp2, normal );\n    vec3 dp1perp = cross( normal, dp1 );\n    vec3 tangent = dp2perp * duv1.x + dp1perp * duv2.x;\n    vec3 bitangent = dp2perp * duv1.y + dp1perp * duv2.y;\n \n    // construct a scale-invariant frame \n    float invmax = inversesqrt( max( dot(tangent,tangent), dot(bitangent,bitangent) ) );\n    return mat3( tangent * invmax, bitangent * invmax, normal );\n}\n\n#define WITH_NORMALMAP_UNSIGNED 1\n\nvec3 sampleNormalMap( sampler2D normalMap, vec2 texcoord )\n{\n    // assume normal, the interpolated vertex normal and \n    // viewVec, the view vector (vertex to eye)\n    vec3 map = texture2D( normalMap, texcoord ).xyz;\n#ifdef WITH_NORMALMAP_UNSIGNED\n    map = map * 255./127. - 128./127.;\n#endif\n#ifdef WITH_NORMALMAP_2CHANNEL\n    map.z = sqrt( 1. - dot( map.xy, map.xy ) );\n#endif\n#ifdef WITH_NORMALMAP_GREEN_UP\n    map.y = -map.y;\n#endif\n    return map;\n}\n\n\n#ifdef ENABLE_ES3\n    out vec4 fragColor;\n#endif\n\nvoid main(void) {\n\n    MaterialParams material;\n\n#ifndef ENABLE_TEXTURES\n    material.baseColor      = BaseColor.rgb;\n#else\n    vec2 texCoord           = vec2(v_textureCoord.x, 1.0 - v_textureCoord.y);\n    material.baseColor      = getColorParamValue(BaseColor, BaseColorTex, BaseColorTexType, texCoord).rgb;\n#endif\n\n#ifdef ENABLE_SPECULAR\n    material.roughness      = BaseRoughness;\n    material.metallic       = BaseMetallic;\n    material.reflectance    = BaseReflectance;\n#endif\n\n    vec3 irradiance = texture2D(lightmap, v_lightmapCoord).rgb;\n \n#ifdef ENABLE_DEBUGGING_LIGHTMAPS\n    if(debugLightmapTexelSize)\n    {\n        vec2 coord_texelSpace = (v_lightmapCoord * lightmapSize) - v_geomItemData.zw;\n        //vec2 coord_texelSpace = (v_textureCoord * lightmapSize);\n        float total = floor(coord_texelSpace.x) +\n                      floor(coord_texelSpace.y);\n                      \n        vec3 clustercolor = getDebugColor(v_clusterID);\n\n        if(mod(total,2.0)==0.0){\n            material.baseColor = clustercolor;\n            irradiance = vec3(1.0);\n        }\n        else{\n            material.baseColor = material.baseColor * 1.5;\n        }\n    }\n#endif\n\n    vec3 viewNormal = normalize(v_viewNormal);\n    vec3 surfacePos = -v_viewPos;\n\n    // The vector from the camera to the surface point.\n    vec3 viewVector = mat3(cameraMatrix) * normalize(v_viewPos);\n    vec3 viewDir = normalize(viewVector);\n    vec3 normal = normalize(mat3(cameraMatrix) * viewNormal);\n\n    float NdotV = dot(normal, viewDir);\n    if(NdotV < 0.0){\n        normal = -normal;\n        NdotV = dot(normal, viewDir);\n    }\n\n#ifndef ENABLE_SPECULAR\n    vec3 radiance = material.baseColor * irradiance;\n#else\n    \n    // Mix the base color to give a multi-layered paint look.\n    material.baseColor      = mix(material.baseColor, material.baseColor * MidColorTint.rgb, (1.0-NdotV));\n\n    mat3 TBN = cotangent_frame( normal, surfacePos, v_lightmapCoord );\n    vec3 flakesNormal = TBN * -sampleNormalMap( FlakesNormalTex, (v_lightmapCoord * lightmapSize) / FlakesScale );\n    flakesNormal = normalize(mix(normal, flakesNormal, MicroflakePerturbation));\n\n    vec3 baseRadiance = pbrSurfaceRadiance(material, irradiance, flakesNormal, viewVector);\n\n    material.roughness      = GlossRoughness;\n    material.reflectance    = GlossReflectance;\n    vec4 gloss = pbrSpecularReflectance(material, normal, viewVector);\n    vec3 radiance = mix(baseRadiance, gloss.rgb, gloss.a);\n    //vec3 radiance = baseRadiance;\n\n#endif\n\n#ifndef ENABLE_ES3\n    vec4 fragColor;\n#endif\n\n    fragColor = vec4(radiance, 1.0);\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n    fragColor.rgb = toGamma(fragColor.rgb * exposure);\n#endif\n\n#ifndef ENABLE_ES3\n    gl_FragColor = fragColor;\n#endif\n}\n'),this.finalize();}static getParamDeclarations(){const e=super.getParamDeclarations();e.push({name:"BaseColor",defaultValue:new u(1,0,0)}),e.push({name:"BaseMetallic",defaultValue:0}),e.push({name:"BaseRoughness",defaultValue:.35}),e.push({name:"BaseReflectance",defaultValue:.03}),e.push({name:"MidColorTint",defaultValue:new u(1,1,1)}),e.push({name:"MidColorTintReflectance",defaultValue:.03}),e.push({name:"GlossMetallic",defaultValue:0}),e.push({name:"GlossRoughness",defaultValue:.35}),e.push({name:"GlossReflectance",defaultValue:.03});const t=new it("flakes","ZeaEngine/FlakesNormalMap.png");return t.wrap="REPEAT",t.mipMapped=!0,e.push({name:"FlakesNormal",defaultValue:t}),e.push({name:"FlakesScale",defaultValue:.1}),e.push({name:"MicroflakePerturbation",defaultValue:.1}),e}static getGeomDataShaderName(){return "StandardSurfaceGeomDataShader"}static getSelectedShaderName(){return "StandardSurfaceSelectedGeomsShader"}}C.registerClass("LayeredCarPaintShader",Ji);class Pi extends Pa{constructor(e){super(e),this.__shaderStages.VERTEX_SHADER=Ja.parseShader("FlatShader.vertexShader",'\nprecision highp float;\n\nattribute vec3 positions;\nattribute vec2 lightmapCoords;\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\nuniform vec3 ProjectionCenter;\n\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="stack-gl/inverse.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n\nattribute float clusterIDs;\nuniform vec2 lightmapSize;\n\n/* VS Outputs */\n// varying vec2 v_lightmapCoord;\nvarying vec3 v_worldDir;\n\nvoid main(void) {\n    int drawItemId = getDrawItemId();\n\n    vec4 geomItemData = getInstanceData(drawItemId);\n\n    vec4 pos = vec4(positions, 1.);\n    mat4 modelMatrix = getModelMatrix(drawItemId);\n    mat4 modelViewProjectionMatrix = projectionMatrix * viewMatrix * modelMatrix;\n    gl_Position     = modelViewProjectionMatrix * pos;\n\n    vec4 worldPos = modelMatrix * pos;\n    v_worldDir = worldPos.xyz - ProjectionCenter;\n\n    v_lightmapCoord = (lightmapCoords + geomItemData.zw) / lightmapSize;\n}\n');}}C.registerClass("ShadowCatcherShader",class extends Pi{constructor(e){super(e),this.__shaderStages.FRAGMENT_SHADER=Ja.parseShader("ShadowCatcherShader.fragmentShader",'\nprecision highp float;\n\n<%include file="math/constants.glsl"/>\n<%include file="GLSLUtils.glsl"/>\n<%include file="pragmatic-pbr/envmap-octahedral.glsl"/>\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n<%include file="stack-gl/gamma.glsl"/>\n#endif\n\n/* VS Outputs */\nvarying vec2 v_lightmapCoord;\nvarying vec3 v_worldDir;\n\nuniform sampler2D lightmap;\nuniform float ShadowMultiplier;\n\nuniform color envMap;\nuniform sampler2D envMapTex;\nuniform int envMapTexType;\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\nuniform float exposure;\n#endif\n\nfloat luminanceFromRGB(vec3 rgb) {\n    return 0.2126*rgb.r + 0.7152*rgb.g + 0.0722*rgb.b;\n}\n\n\n#ifdef ENABLE_ES3\n    out vec4 fragColor;\n#endif\nvoid main(void) {\n\n    vec4 env = envMap;\n    if(envMapTexType != 0) {\n        vec2 texCoord = dirToSphOctUv(normalize(v_worldDir));\n        env = texture2D(envMapTex, texCoord);\n    }\n\n    vec3 irradiance = texture2D(lightmap, v_lightmapCoord).rgb * ShadowMultiplier;\n    float irradianceLum = clamp(luminanceFromRGB(irradiance), 0.0, 1.0);\n\n#ifndef ENABLE_ES3\n    vec4 fragColor;\n#endif\n\n    fragColor = vec4(env.rgb/env.a, 1.0);\n    fragColor.rgb = mix(fragColor.rgb * irradiance, fragColor.rgb, irradianceLum);\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n    fragColor.rgb = toGamma(fragColor.rgb * exposure);\n#endif\n\n\n#ifndef ENABLE_ES3\n    gl_FragColor = fragColor;\n#endif\n}\n'),this.finalize();}static getParamDeclarations(){const e=super.getParamDeclarations();return e.push({name:"ProjectionCenter",defaultValue:new d(0,0,1.7)}),e.push({name:"ShadowMultiplier",defaultValue:1}),e}static isTransparent(){return !0}bind(e,t){return "ADD"==e.pass&&super.bind(e,t)}});C.registerClass("FloatingShadowCatcherShader",class extends Pi{constructor(e){super(e),this.__shaderStages.FRAGMENT_SHADER=Ja.parseShader("FloatingShadowCatcherShader.fragmentShader",'\nprecision highp float;\n\n<%include file="math/constants.glsl"/>\n<%include file="GLSLUtils.glsl"/>\n<%include file="stack-gl/gamma.glsl"/>\n<%include file="materialparams.glsl"/>\n<%include file="pragmatic-pbr/envmap-octahedral.glsl"/>\n\n/* VS Outputs */\nvarying vec2 v_lightmapCoord;\nvarying vec3 v_worldDir;\n\nuniform sampler2D lightmap;\n\nuniform float ShadowMultiplier;\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\nuniform float exposure;\n#endif\n\n\n#ifdef ENABLE_ES3\n    out vec4 fragColor;\n#endif\nvoid main(void) {\n\n#ifndef ENABLE_ES3\n    vec4 fragColor;\n#endif\n    \n    float shadow = luminanceFromRGB(texture2D(lightmap, v_lightmapCoord).rgb) * ShadowMultiplier;\n\n    // This material works by multiplying the image buffer values by the luminance in the lightmap.\n    fragColor.rgb = vec3(pow(shadow, 1.0/ShadowMultiplier));\n    fragColor.a = 1.0;\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n    fragColor.rgb = toGamma(fragColor.rgb * exposure);\n#endif\n\n#ifndef ENABLE_ES3\n    gl_FragColor = fragColor;\n#endif\n}\n');}bind(e,t){return "MULTIPLY"==e.pass&&super.bind(e,t)}static isTransparent(){return !0}static getParamDeclarations(){const e=super.getParamDeclarations();return e.push({name:"ShadowMultiplier",defaultValue:1}),e}});class Ei extends Pa{constructor(e){super(e),this.__shaderStages.VERTEX_SHADER=Ja.parseShader("LinesShader.vertexShader",'\nprecision highp float;\n\nattribute vec3 positions;\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\n\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="drawItemId.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n\n/* VS Outputs */\n\nvoid main(void) {\n    int drawItemId = getDrawItemId();\n    mat4 modelMatrix = getModelMatrix(drawItemId);\n    mat4 modelViewProjectionMatrix = projectionMatrix * viewMatrix * modelMatrix;\n    gl_Position = modelViewProjectionMatrix * vec4(positions, 1.0);\n}\n'),this.__shaderStages.FRAGMENT_SHADER=Ja.parseShader("LinesShader.fragmentShader","\nprecision highp float;\n\nuniform color BaseColor;\nuniform float Opacity;\n\n#ifdef ENABLE_ES3\n    out vec4 fragColor;\n#endif\nvoid main(void) {\n#ifndef ENABLE_ES3\n    vec4 fragColor;\n#endif\n    fragColor = BaseColor;\n    fragColor.a *= Opacity;\n    \n#ifndef ENABLE_ES3\n    gl_FragColor = fragColor;\n#endif\n}\n"),this.finalize();}static getParamDeclarations(){const e=super.getParamDeclarations();return e.push({name:"BaseColor",defaultValue:new u(1,1,.5)}),e.push({name:"Opacity",defaultValue:1}),e}static getGeomDataShaderName(){return "StandardSurfaceGeomDataShader"}static getSelectedShaderName(){return "StandardSurfaceSelectedGeomsShader"}static isTransparent(){return !0}bind(e,t){return "ADD"==e.pass&&super.bind(e,t)}}C.registerClass("LinesShader",Ei);class Hi extends Pa{constructor(e){super(e),this.__shaderStages.VERTEX_SHADER=Ja.parseShader("NormalsShader.vertexShader",'\nprecision highp float;\n\ninstancedattribute vec3 positions;\ninstancedattribute vec3 normals;\nattribute vec2 vertexIDs;\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\n\nuniform float normalLength;\n\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n\n\n/* VS Outputs */\nvarying float v_weight;\n\nvoid main(void) {\n  mat4 modelMatrix = getModelMatrix(transformIndex);\n  mat4 modelViewProjectionMatrix = projectionMatrix * viewMatrix * modelMatrix;\n  if(vertexIDs.x == 0.0){\n    gl_Position = modelViewProjectionMatrix * vec4(positions, 1.0);\n    v_weight = 1.0;\n  }\n  else{\n    gl_Position = modelViewProjectionMatrix * vec4(positions+(normals*normalLength), 1.0);\n    v_weight = 0.0;\n  }\n}\n'),this.__shaderStages.FRAGMENT_SHADER=Ja.parseShader("NormalsShader.fragmentShader","\nprecision highp float;\n\nuniform color normalColor;\n\n/* VS Outputs */\nvarying float v_weight;\n\n\nvoid main(void) {\n  gl_FragColor = normalColor;\n  gl_FragColor.a = v_weight;\n}\n");}}class ki extends Pa{constructor(e){super(e),this.__shaderStages.VERTEX_SHADER=Ja.parseShader("PointsShader.vertexShader",'\nprecision highp float;\n\nattribute vec3 positions;\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\n\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="stack-gl/inverse.glsl"/>\n<%include file="drawItemId.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n\n/* VS Outputs */\n\nvoid main(void) {\n  int drawItemId = getDrawItemId();\n  mat4 modelMatrix = getModelMatrix(drawItemId);\n  mat4 modelViewProjectionMatrix = projectionMatrix * viewMatrix * modelMatrix;\n  gl_Position = modelViewProjectionMatrix * vec4(positions, 1.);\n}\n'),this.__shaderStages.FRAGMENT_SHADER=Ja.parseShader("PointsShader.fragmentShader","\nprecision highp float;\n\nuniform color BaseColor;\n\n#ifdef ENABLE_ES3\nout vec4 fragColor;\n#endif\n\nvoid main(void) {\n\n#ifndef ENABLE_ES3\n  vec4 fragColor;\n#endif\n\n  fragColor = BaseColor;\n\n#ifndef ENABLE_ES3\n  gl_FragColor = fragColor;\n#endif\n}\n");}static getParamDeclarations(){const e=super.getParamDeclarations();return e.push({name:"BaseColor",defaultValue:new u(1,1,.5)}),e}}C.registerClass("PointsShader",ki);class Bi extends Pa{constructor(e){super(e),this.__shaderStages.VERTEX_SHADER=Ja.parseShader("FatPointsShader.vertexShader",'\nprecision highp float;\n\ninstancedattribute vec3 positions;\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\n\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="stack-gl/inverse.glsl"/>\n<%include file="drawItemId.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n<%include file="utils/quadVertexFromID.glsl"/>\n\nuniform float PointSize;\n\n/* VS Outputs */\nvarying vec2 v_texCoord;\nvarying vec3 v_viewPos;\nvarying float v_drawItemId;\n\nvoid main(void) {\n  int drawItemId = getDrawItemId();\n  vec2 quadPointPos = getQuadVertexPositionFromID();\n  v_texCoord = quadPointPos + 0.5;\n\n  mat4 modelMatrix = getModelMatrix(drawItemId);\n  mat4 modelViewMatrix = viewMatrix * modelMatrix;\n  \n  vec4 viewPos = modelViewMatrix * vec4(positions, 1.);\n\n  viewPos += vec4(vec3(quadPointPos, 0.0) * PointSize, 0.);\n\n  // Generate a quad which is 0.5 * PointSize closer towards\n  // us. This allows points to be visualized even if snug on \n  // a surface. (else they get fully clipped)\n  viewPos.z += 0.5 * PointSize;\n\n  v_drawItemId = float(getDrawItemId());\n  v_viewPos = -viewPos.xyz;\n  \n  gl_Position = projectionMatrix * viewPos;\n}\n'),this.__shaderStages.FRAGMENT_SHADER=Ja.parseShader("FatPointsShader.fragmentShader",'\nprecision highp float;\n\n<%include file="math/constants.glsl"/>\n\nuniform color BaseColor;\nuniform float Rounded;\nuniform float BorderWidth;\n\n/* VS Outputs */\nvarying vec2 v_texCoord;\nvarying vec3 v_viewPos;\nvarying float v_drawItemId;\n\n#ifdef ENABLE_ES3\nout vec4 fragColor;\n#endif\n\nvoid main(void) {\n\n#ifndef ENABLE_ES3\n  vec4 fragColor;\n#endif\n\n  float dist = length(v_texCoord - 0.5);\n  if(dist > 0.5)\n    discard;\n  if(dist > 0.5 - (BorderWidth * 0.5))\n    fragColor = vec4(0.,0.,0.,1.);\n  else {\n    // Modulate the lighting using the texture coord so the point looks round.\n    float NdotV = cos(dist * PI);\n\n    fragColor = BaseColor * mix(1.0, NdotV, Rounded);\n  }\n  \n\n#ifndef ENABLE_ES3\n  gl_FragColor = fragColor;\n#endif\n}\n');}bind(e){return !!super.bind(e)&&(e.supportsInstancing=!1,!0)}static getParamDeclarations(){const e=super.getParamDeclarations();return e.push({name:"BaseColor",defaultValue:new u(1,1,.5)}),e.push({name:"PointSize",defaultValue:.05}),e.push({name:"Rounded",defaultValue:1}),e.push({name:"BorderWidth",defaultValue:.2}),e}static getGeomDataShaderName(){return "FatPointsGeomDataShader"}static getSelectedShaderName(){return "FatPointsSelectedShader"}}class Di extends Bi{constructor(e){super(e),this.__shaderStages.FRAGMENT_SHADER=Ja.parseShader("FatPointsGeomDataShader.fragmentShader",'\nprecision highp float;\n\n<%include file="math/constants.glsl"/>\n<%include file="GLSLBits.glsl"/>\n\nuniform int floatGeomBuffer;\nuniform int passId;\n\n/* VS Outputs */\nvarying vec2 v_texCoord;\nvarying vec3 v_viewPos;\nvarying float v_drawItemId;\n\n#ifdef ENABLE_ES3\nout vec4 fragColor;\n#endif\n\nvoid main(void) {\n\n#ifndef ENABLE_ES3\n  vec4 fragColor;\n#endif\n\n  float dist = length(v_texCoord - 0.5);\n  if(dist > 0.5)\n    discard;\n    \n\n  float viewDist = length(v_viewPos);\n\n  if(floatGeomBuffer != 0) {\n    fragColor.r = float(passId); \n    fragColor.g = float(v_drawItemId);\n    fragColor.b = 0.0;// TODO: store poly-id or something.\n    fragColor.a = viewDist;\n  }\n  else {\n    ///////////////////////////////////\n    // UInt8 buffer\n    fragColor.r = (mod(v_drawItemId, 256.) + 0.5) / 255.;\n    fragColor.g = (floor(v_drawItemId / 256.) + 0.5) / 255.;\n\n    // encode the dist as a 16 bit float\n    vec2 float16bits = encode16BitFloatInto2xUInt8(viewDist);\n    fragColor.b = float16bits.x;\n    fragColor.a = float16bits.y;\n  }\n\n\n#ifndef ENABLE_ES3\n  gl_FragColor = fragColor;\n#endif\n}\n');}}class Oi extends Bi{constructor(e){super(e),this.__shaderStages.FRAGMENT_SHADER=Ja.parseShader("FatPointsSelectedShader.fragmentShader",'\nprecision highp float;\n\n<%include file="math/constants.glsl"/>\n<%include file="GLSLBits.glsl"/>\n\nuniform int floatGeomBuffer;\nuniform int passId;\n\n/* VS Outputs */\nvarying vec2 v_texCoord;\nvarying vec3 v_viewPos;\nvarying float v_drawItemId;\n\n\n<%include file="drawItemTexture.glsl"/>\n\n#ifdef ENABLE_FLOAT_TEXTURES\nvec4 getHighlightColor(int id) {\n  return fetchTexel(instancesTexture, instancesTextureSize, (id * pixelsPerItem) + 4);\n}\n#else\n\nuniform vec4 highlightColor;\n\nvec4 getHighlightColor() {\n    return highlightColor;\n}\n\n#endif\n\n\n#ifdef ENABLE_ES3\nout vec4 fragColor;\n#endif\n\nvoid main(void) {\n\n#ifndef ENABLE_ES3\n  vec4 fragColor;\n#endif\n\n  float dist = length(v_texCoord - 0.5);\n  if(dist > 0.5)\n    discard;\n  \n  int drawItemId = int(v_drawItemId + 0.5);\n  fragColor = getHighlightColor(drawItemId);\n\n#ifndef ENABLE_ES3\n  gl_FragColor = fragColor;\n#endif\n}\n');}}C.registerClass("FatPointsShader",Bi),C.registerClass("FatPointsGeomDataShader",Di),C.registerClass("FatPointsSelectedShader",Oi),Ja.setShaderModule("pragmatic-pbr/exposure.glsl","\n\n/*\n* Get an exposure using the Saturation-based Speed method.\n*/\nfloat getSaturationBasedExposure(float aperture,\n                                 float shutterSpeed,\n                                 float iso)\n{\n    float l_max = (7800.0 / 65.0) * sqrt(aperture) / (iso * shutterSpeed);\n    return 1.0 / l_max;\n}\n\n//White balance middle grey we are targetting for a good scene exposure\n//https://en.wikipedia.org/wiki/Middle_gray\nconst float MIDDLE_GREY = 0.18;\n\n/*\n* Get an exposure using the Standard Output Sensitivity method.\n* Accepts an additional parameter of the target middle grey.\n*/\nfloat getStandardOutputBasedExposure(float aperture,\n                                     float shutterSpeed,\n                                     float iso)\n{\n    //https://placeholderart.wordpress.com/2014/11/21/implementing-a-physically-based-camera-manual-exposure/\n    //https://en.wikipedia.org/wiki/Film_speed#Standard_output_sensitivity_.28SOS.29\n    //photometric exposure magic\n    //represents the properties of lens\n    float q = 0.65;\n\n    //float l_avg = (1000.0f / 65.0f) * sqrt(aperture) / (iso * shutterSpeed);\n    float l_avg = (1.0 / q) * sqrt(aperture) / (iso * shutterSpeed);\n    //float l_avg = sqrt(aperture) / (iso * shutterSpeed);\n    return MIDDLE_GREY / l_avg;\n}\n\n"),Ja.setShaderModule("pragmatic-pbr/tonemap-filmic.glsl","\n\n//Based on Filmic Tonemapping Operators http://filmicgames.com/archives/75\nvec3 tonemapFilmic(vec3 color) {\n    vec3 x = max(vec3(0.0), color - 0.004);\n    return (x * (6.2 * x + 0.5)) / (x * (6.2 * x + 1.7) + 0.06);\n}\n\n"),Ja.setShaderModule("mattdesl/fxaa-texcoords.glsl","\n//To save 9 dependent texture reads, you can compute\n//these in the vertex shader and use the optimized\n//frag.glsl function in your frag shader. \n\n//This is best suited for mobile devices, like iOS.\n\nvoid texcoords(vec2 fragCoord, vec2 resolution,\n            out vec2 v_rgbNW, out vec2 v_rgbNE,\n            out vec2 v_rgbSW, out vec2 v_rgbSE,\n            out vec2 v_rgbM) {\n    vec2 inverseVP = 1.0 / resolution.xy;\n    v_rgbNW = (fragCoord + vec2(-1.0, -1.0)) * inverseVP;\n    v_rgbNE = (fragCoord + vec2(1.0, -1.0)) * inverseVP;\n    v_rgbSW = (fragCoord + vec2(-1.0, 1.0)) * inverseVP;\n    v_rgbSE = (fragCoord + vec2(1.0, 1.0)) * inverseVP;\n    v_rgbM = vec2(fragCoord * inverseVP);\n}\n\n"),Ja.setShaderModule("mattdesl/fxaa.glsl",'\n\n/**\nBasic FXAA implementation based on the code on geeks3d.com with the\nmodification that the texture2DLod stuff was removed since it\'s\nunsupported by WebGL.\n--\nFrom:\nhttps://github.com/mitsuhiko/webgl-meincraft\nCopyright (c) 2011 by Armin Ronacher.\nSome rights reserved.\nRedistribution and use in source and binary forms, with or without\nmodification, are permitted provided that the following conditions are\nmet:\n    * Redistributions of source code must retain the above copyright\n      notice, this list of conditions and the following disclaimer.\n    * Redistributions in binary form must reproduce the above\n      copyright notice, this list of conditions and the following\n      disclaimer in the documentation and/or other materials provided\n      with the distribution.\n    * The names of the contributors may not be used to endorse or\n      promote products derived from this software without specific\n      prior written permission.\nTHIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS\n"AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT\nLIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR\nA PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT\nOWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,\nSPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT\nLIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,\nDATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY\nTHEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\n(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE\nOF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n*/\n\n#ifndef FXAA_REDUCE_MIN\n    #define FXAA_REDUCE_MIN   (1.0/ 128.0)\n#endif\n#ifndef FXAA_REDUCE_MUL\n    #define FXAA_REDUCE_MUL   (1.0 / 8.0)\n#endif\n#ifndef FXAA_SPAN_MAX\n    #define FXAA_SPAN_MAX     8.0\n#endif\n\n//optimized version for mobile, where dependent \n//texture reads can be a bottleneck\nvec4 fxaa(sampler2D tex, vec2 fragCoord, vec2 resolution,\n            vec2 v_rgbNW, vec2 v_rgbNE, \n            vec2 v_rgbSW, vec2 v_rgbSE, \n            vec2 v_rgbM) {\n    vec4 color;\n    mediump vec2 inverseVP = vec2(1.0 / resolution.x, 1.0 / resolution.y);\n    vec3 rgbNW = texture2D(tex, v_rgbNW).xyz;\n    vec3 rgbNE = texture2D(tex, v_rgbNE).xyz;\n    vec3 rgbSW = texture2D(tex, v_rgbSW).xyz;\n    vec3 rgbSE = texture2D(tex, v_rgbSE).xyz;\n    vec4 texColor = texture2D(tex, v_rgbM);\n    vec3 rgbM  = texColor.xyz;\n    vec3 luma = vec3(0.299, 0.587, 0.114);\n    float lumaNW = dot(rgbNW, luma);\n    float lumaNE = dot(rgbNE, luma);\n    float lumaSW = dot(rgbSW, luma);\n    float lumaSE = dot(rgbSE, luma);\n    float lumaM  = dot(rgbM,  luma);\n    float lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\n    float lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\n    \n    mediump vec2 dir;\n    dir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\n    dir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\n    \n    float dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) *\n                          (0.25 * FXAA_REDUCE_MUL), FXAA_REDUCE_MIN);\n    \n    float rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\n    dir = min(vec2(FXAA_SPAN_MAX, FXAA_SPAN_MAX),\n              max(vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX),\n              dir * rcpDirMin)) * inverseVP;\n    \n    vec3 rgbA = 0.5 * (\n        texture2D(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz +\n        texture2D(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\n    vec3 rgbB = rgbA * 0.5 + 0.25 * (\n        texture2D(tex, fragCoord * inverseVP + dir * -0.5).xyz +\n        texture2D(tex, fragCoord * inverseVP + dir * 0.5).xyz);\n\n    float lumaB = dot(rgbB, luma);\n    if ((lumaB < lumaMin) || (lumaB > lumaMax))\n        color = vec4(rgbA, texColor.a);\n    else\n        color = vec4(rgbB, texColor.a);\n    return color;\n}\n\n'),Ja.setShaderModule("mattdesl/fxaa-apply.glsl",'\n\n<%include file="mattdesl/fxaa.glsl"/>\n\nvec4 apply(sampler2D tex, vec2 fragCoord, vec2 resolution) {\n    mediump vec2 v_rgbNW;\n    mediump vec2 v_rgbNE;\n    mediump vec2 v_rgbSW;\n    mediump vec2 v_rgbSE;\n    mediump vec2 v_rgbM;\n\n    //compute the texture coords\n    texcoords(fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n    \n    //compute FXAA\n    return fxaa(tex, fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n}\n\n');class Qi extends Pa{constructor(e){super(e),this.__shaderStages.VERTEX_SHADER=Ja.parseShader("PostProcessing.vertexShader",'\nprecision highp float;\n\n<%include file="utils/quadVertexFromID.glsl"/>\n<%include file="mattdesl/fxaa-texcoords.glsl"/>\n\nuniform vec2 textureSize;\n\n/* VS Outputs */\nvarying vec2 v_texCoord;\n\n//texcoords computed in vertex step\n//to avoid dependent texture reads\nvarying vec2 v_rgbNW;\nvarying vec2 v_rgbNE;\nvarying vec2 v_rgbSW;\nvarying vec2 v_rgbSE;\nvarying vec2 v_rgbM;\n\n \nvoid main()\n{\n    vec2 position = getQuadVertexPositionFromID();\n    v_texCoord = position+0.5;\n    gl_Position = vec4(position*2.0, 0.0, 1.0);\n\n    vec2 fragCoord = v_texCoord * textureSize;\n    texcoords(fragCoord, textureSize, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n}\n\n'),this.__shaderStages.FRAGMENT_SHADER=Ja.parseShader("PostProcessing.fragmentShader",'\nprecision highp float;\n\n<%include file="pragmatic-pbr/exposure.glsl"/>\n<%include file="pragmatic-pbr/tonemap-filmic.glsl"/>\n<%include file="stack-gl/gamma.glsl"/>\n\n<%include file="mattdesl/fxaa.glsl"/>\n\n//texcoords computed in vertex step\n//to avoid dependent texture reads\nvarying vec2 v_rgbNW;\nvarying vec2 v_rgbNE;\nvarying vec2 v_rgbSW;\nvarying vec2 v_rgbSE;\nvarying vec2 v_rgbM;\n\nuniform sampler2D texture;\nuniform vec2 textureSize;\n\nuniform bool antialiase;\nuniform bool tonemap;\nuniform float exposure;\nuniform float gamma;\n\nvarying vec2 v_texCoord;\n\n#ifdef ENABLE_ES3\n    out vec4 fragColor;\n#endif\nvoid main(void) {\n    //can also use gl_FragCoord.xy\n    mediump vec2 fragCoord = v_texCoord * textureSize; \n\n    if (antialiase) {\n        fragColor = fxaa(texture, fragCoord, textureSize, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n    } else {\n        fragColor = texture2D(texture, v_texCoord);\n    }\n    \n    //fragColor.rgb *= getStandardOutputBasedExposure(aperture, shutterSpeed, iso);\n    fragColor.rgb *= exposure;\n    \n    if (tonemap) \n        fragColor.rgb = tonemapFilmic(fragColor.rgb);\n    else\n        fragColor.rgb = toGamma(fragColor.rgb, gamma);\n\n    \n    //fragColor.rgb = toGamma(fragColor.rgb, gamma);\n    \n    fragColor.a = 1.0;\n\n#ifndef ENABLE_ES3\n    gl_FragColor = fragColor;\n#endif\n}'),this.finalize();}}class Ai extends Pa{constructor(e){super(e),this.__shaderStages.VERTEX_SHADER=Ja.parseShader("SimpleSurfaceShader.vertexShader",'\nprecision highp float;\n\nattribute vec3 positions;\nattribute vec3 normals;\n#ifdef ENABLE_TEXTURES\nattribute vec2 texCoords;\n#endif\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\n\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="stack-gl/inverse.glsl"/>\n<%include file="drawItemId.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n\n/* VS Outputs */\nvarying float v_drawItemId;\nvarying vec4 v_geomItemData;\nvarying vec3 v_viewPos;\nvarying vec3 v_viewNormal;\n#ifdef ENABLE_TEXTURES\nvarying vec2 v_textureCoord;\n#endif\nvarying vec3 v_worldPos;\n\nvoid main(void) {\n    int drawItemId = getDrawItemId();\n    v_drawItemId = float(drawItemId);\n    v_geomItemData  = getInstanceData(drawItemId);\n\n    vec4 pos = vec4(positions, 1.);\n    mat4 modelMatrix = getModelMatrix(drawItemId);\n    mat4 modelViewMatrix = viewMatrix * modelMatrix;\n    vec4 viewPos    = modelViewMatrix * pos;\n    gl_Position     = projectionMatrix * viewPos;\n\n    mat3 normalMatrix = mat3(transpose(inverse(modelViewMatrix)));\n    v_viewPos       = -viewPos.xyz;\n    v_viewNormal    = normalMatrix * normals;\n\n#ifdef ENABLE_TEXTURES\n    v_textureCoord  = texCoords;\n    // v_textureCoord.y = 1.0 - v_textureCoord.y;// Flip y\n#endif\n\n    v_worldPos      = (modelMatrix * pos).xyz;\n}\n'),this.__shaderStages.FRAGMENT_SHADER=Ja.parseShader("SimpleSurfaceShader.fragmentShader",'\nprecision highp float;\n\n<%include file="drawItemTexture.glsl"/>\n<%include file="cutaways.glsl"/>\n<%include file="stack-gl/gamma.glsl"/>\n<%include file="materialparams.glsl"/>\n\n/* VS Outputs */\nvarying float v_drawItemId;\nvarying vec4 v_geomItemData;\nvarying vec3 v_viewPos;\nvarying vec3 v_viewNormal;\n#ifdef ENABLE_TEXTURES\nvarying vec2 v_textureCoord;\n#endif\nvarying vec3 v_worldPos;\n\nuniform mat4 cameraMatrix;\n\nuniform color BaseColor;\nuniform float Opacity;\n\n#ifdef ENABLE_TEXTURES\n\nuniform sampler2D BaseColorTex;\nuniform int BaseColorTexType;\nuniform sampler2D OpacityTex;\nuniform int OpacityTexType;\n\nuniform color cutColor;\nvec4 getCutaway(int id) {\n    return fetchTexel(instancesTexture, instancesTextureSize, (id * pixelsPerItem) + 5);\n}\n\n#endif\n\n#ifdef ENABLE_ES3\n    out vec4 fragColor;\n#endif\n\nvoid main(void) {\n    int drawItemId = int(v_drawItemId + 0.5);\n\n    int flags = int(v_geomItemData.r + 0.5);\n    // Cutaways\n    if(testFlag(flags, GEOMITEM_FLAG_CUTAWAY)) \n    {\n        vec4 cutAwayData   = getCutaway(drawItemId);\n        vec3 planeNormal = cutAwayData.xyz;\n        float planeDist = cutAwayData.w;\n        if(cutaway(v_worldPos, planeNormal, planeDist)){\n            discard;\n            return;\n        }\n        else if(!gl_FrontFacing){\n            fragColor = cutColor;\n#ifndef ENABLE_ES3\n            gl_FragColor = fragColor;\n#endif\n            return;\n        }\n    }\n\n#ifndef ENABLE_TEXTURES\n    vec4 baseColor      = BaseColor;\n    float opacity       = baseColor.a * Opacity;\n#else\n    vec4 baseColor      = getColorParamValue(BaseColor, BaseColorTex, BaseColorTexType, v_textureCoord);\n    float opacity       = baseColor.a * getLuminanceParamValue(Opacity, OpacityTex, OpacityTexType, v_textureCoord);\n#endif\n\n    // Hacky simple irradiance. \n    vec3 viewVector = normalize(mat3(cameraMatrix) * normalize(v_viewPos));\n    vec3 normal = normalize(mat3(cameraMatrix) * v_viewNormal);\n    float ndotv = dot(normal, viewVector);\n    if(ndotv < 0.0){\n        normal = -normal;\n        ndotv = dot(normal, viewVector);\n\n        // Note: these 2 lines can be used to debug inverted meshes.\n        //baseColor = vec4(1.0, 0.0, 0.0, 1.0);\n        //ndotv = 1.0;\n    }\n\n#ifndef ENABLE_ES3\n    vec4 fragColor;\n#endif\n    fragColor = vec4(ndotv * baseColor.rgb, opacity);\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n    fragColor.rgb = toGamma(fragColor.rgb);\n#endif\n\n#ifndef ENABLE_ES3\n    gl_FragColor = fragColor;\n#endif\n}\n'),this.finalize();}static getParamDeclarations(){const e=super.getParamDeclarations();return e.push({name:"BaseColor",defaultValue:new u(1,1,.5)}),e.push({name:"Opacity",defaultValue:1,range:[0,1]}),e}static getGeomDataShaderName(){return "StandardSurfaceGeomDataShader"}static getSelectedShaderName(){return "StandardSurfaceSelectedGeomsShader"}}C.registerClass("SimpleSurfaceShader",Ai),Ja.setShaderModule("cutaways.glsl","\n\n\nconst int GEOMITEM_FLAG_CUTAWAY =  1; // 1<<0;\n\n#define RAY_EPS 0.0000001\nstruct Ray {\n    vec3 start;\n    vec3 dir;\n};\n\nfloat intersectRayPlane(Ray ray, Ray plane) {\n    vec3 w = ray.start - plane.start;\n    float D = dot(plane.dir, ray.dir);\n    float N = dot(-plane.dir, w);\n\n    if (abs(D) < RAY_EPS) {\n        // segment is parallel to plane\n        if (N == 0.0)\n            return -1.0; // segment lies in plane\n        else\n            return -1.0; // no intersection\n    }\n    // they are not parallel\n    // compute intersect param\n    float sI = N / D;\n    if (sI < -RAY_EPS) {\n        return -1.0; // no intersection\n    }\n    return sI;\n}\n\n\nbool cutaway(vec3 worldPos, vec3 planeNormal, float planeDist) {\n\n    vec3 planePos = planeNormal * planeDist;\n    vec3 planeDir = worldPos + planePos;\n    float planeOffset = dot(planeDir, planeNormal);\n    if(planeOffset > 0.0){\n        return true;\n    }\n    return  false;\n}\n");class ji extends Pa{constructor(e){super(e),this.__shaderStages.VERTEX_SHADER=Ja.parseShader("StandardSurfaceShader.vertexShader",'\nprecision highp float;\n\nattribute vec3 positions;\nattribute vec3 normals;\n#ifdef ENABLE_TEXTURES\nattribute vec2 texCoords;\n#endif\nattribute vec2 lightmapCoords;\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\n\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="stack-gl/inverse.glsl"/>\n<%include file="drawItemId.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n\n// attribute float clusterIDs;\n// uniform vec2 lightmapSize;\n\n/* VS Outputs */\nvarying float v_drawItemId;\nvarying vec4 v_geomItemData;\nvarying vec3 v_viewPos;\nvarying vec3 v_viewNormal;\n#ifdef ENABLE_TEXTURES\nvarying vec2 v_textureCoord;\n#endif\n// varying vec2 v_lightmapCoord;\n// #ifdef ENABLE_DEBUGGING_LIGHTMAPS\n// varying float v_clusterID;\n// #endif\nvarying vec3 v_worldPos;\n/* VS Outputs */\n\n\nvoid main(void) {\n    int drawItemId = getDrawItemId();\n    v_drawItemId = float(drawItemId);\n    v_geomItemData = getInstanceData(drawItemId);\n\n    vec4 pos = vec4(positions, 1.);\n    mat4 modelMatrix = getModelMatrix(drawItemId);\n    mat4 modelViewMatrix = viewMatrix * modelMatrix;\n    vec4 viewPos    = modelViewMatrix * pos;\n    gl_Position     = projectionMatrix * viewPos;\n\n    mat3 normalMatrix = mat3(transpose(inverse(modelViewMatrix)));\n    v_viewPos       = -viewPos.xyz;\n    v_viewNormal    = normalMatrix * normals;\n\n#ifdef ENABLE_TEXTURES\n    v_textureCoord  = texCoords;\n#endif\n\n    // v_lightmapCoord = (lightmapCoords + v_geomItemData.zw) / lightmapSize;\n\n    // mat4 mvp = projectionMatrix * viewMatrix * modelMatrix;\n    // gl_Position = mvp * vec4((lightmapCoords + v_geomItemData.zw), 0., 1.);\n#ifdef ENABLE_DEBUGGING_LIGHTMAPS\n    v_clusterID = clusterIDs;\n#endif\n\n    v_worldPos      = (modelMatrix * pos).xyz;\n}\n'),this.__shaderStages.FRAGMENT_SHADER=Ja.parseShader("StandardSurfaceShader.fragmentShader",'\nprecision highp float;\n\n<%include file="math/constants.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="cutaways.glsl"/>\n\n\n<%include file="stack-gl/gamma.glsl"/>\n<%include file="materialparams.glsl"/>\n\n<%include file="GGX_Specular.glsl"/>\n<%include file="PBRSurfaceRadiance.glsl"/>\n\n/* VS Outputs */\nvarying float v_drawItemId;\nvarying vec4 v_geomItemData;\nvarying vec3 v_viewPos;\nvarying vec3 v_viewNormal;\n#ifdef ENABLE_TEXTURES\nvarying vec2 v_textureCoord;\n#endif\n// varying vec2 v_lightmapCoord;\n// #ifdef ENABLE_DEBUGGING_LIGHTMAPS\n// varying float v_clusterID;\n// #endif\nvarying vec3 v_worldPos;\n/* VS Outputs */\n\n\n// uniform sampler2D lightmap;\n// uniform bool lightmapConnected;\n// #ifdef ENABLE_DEBUGGING_LIGHTMAPS\n// <%include file="debugColors.glsl"/>\n// uniform vec2 lightmapSize;\n// uniform bool debugLightmapTexelSize;\n// #endif\n\nuniform color cutColor;\nvec4 getCutaway(int id) {\n    return fetchTexel(instancesTexture, instancesTextureSize, (id * pixelsPerItem) + 5);\n}\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\nuniform float exposure;\n#endif\n\nuniform mat4 cameraMatrix;\n\nuniform color BaseColor;\nuniform float EmissiveStrength;\n\n\n#ifdef ENABLE_SPECULAR\nuniform float Roughness;\nuniform float Metallic;\nuniform float Reflectance;\n#endif\n\n#ifdef ENABLE_TEXTURES\nuniform sampler2D BaseColorTex;\nuniform int BaseColorTexType;\n\n#ifdef ENABLE_SPECULAR\nuniform sampler2D RoughnessTex;\nuniform int RoughnessTexType;\n\nuniform sampler2D MetallicTex;\nuniform int MetallicTexType;\n\nuniform sampler2D ReflectanceTex;\nuniform int ReflectanceTexType;\n\nuniform sampler2D NormalTex;\nuniform int NormalTexType;\n// uniform float NormalScale;\n#endif\n\nuniform sampler2D EmissiveStrengthTex;\nuniform int EmissiveStrengthTexType;\n\n\n#endif\n\n#ifdef ENABLE_ES3\nout vec4 fragColor;\n\n#endif\n\nvoid main(void) {\n    int drawItemId = int(v_drawItemId + 0.5);\n\n    int flags = int(v_geomItemData.r + 0.5);\n    // Cutaways\n    if(testFlag(flags, GEOMITEM_FLAG_CUTAWAY)) {\n        vec4 cutAwayData   = getCutaway(drawItemId);\n        vec3 planeNormal = cutAwayData.xyz;\n        float planeDist = cutAwayData.w;\n        if(cutaway(v_worldPos, planeNormal, planeDist)){\n            discard;\n            return;\n        }\n        else if(!gl_FrontFacing){\n            fragColor = cutColor;\n#ifndef ENABLE_ES3\n            gl_FragColor = fragColor;\n#endif\n            return;\n        }\n    }\n\n\n    MaterialParams material;\n\n#ifndef ENABLE_TEXTURES\n    material.BaseColor     = BaseColor.rgb;\n    float emission         = EmissiveStrength;\n\n#ifdef ENABLE_SPECULAR\n    material.roughness     = Roughness;\n    material.metallic      = Metallic;\n    material.reflectance   = Reflectance;\n#endif\n\n#else\n    // Planar YZ projection for texturing, repeating every meter.\n    // vec2 texCoord       = v_worldPos.xz * 0.2;\n    vec2 texCoord          = vec2(v_textureCoord.x, 1.0 - v_textureCoord.y);\n    material.baseColor     = getColorParamValue(BaseColor, BaseColorTex, BaseColorTexType, texCoord).rgb;\n\n#ifdef ENABLE_SPECULAR\n    material.roughness     = getLuminanceParamValue(Roughness, RoughnessTex, RoughnessTexType, texCoord);\n    material.metallic      = getLuminanceParamValue(Metallic, MetallicTex, MetallicTexType, texCoord);\n    material.reflectance   = getLuminanceParamValue(Reflectance, ReflectanceTex, ReflectanceTexType, texCoord);\n#endif\n    float emission         = getLuminanceParamValue(EmissiveStrength, EmissiveStrengthTex, EmissiveStrengthTexType, texCoord);\n#endif\n\n    vec3 viewNormal = normalize(v_viewNormal);\n    //vec3 surfacePos = -v_viewPos;\n\n#ifdef ENABLE_TEXTURES\n#ifdef ENABLE_SPECULAR\n    if(NormalTexType != 0){\n        vec3 textureNormal_tangentspace = normalize(texture2D(NormalTex, texCoord).rgb * 2.0 - 1.0);\n        viewNormal = normalize(mix(viewNormal, textureNormal_tangentspace, 0.3));\n    }\n#endif\n#endif\n\n    vec3 viewVector = normalize(mat3(cameraMatrix) * normalize(v_viewPos));\n    vec3 normal = normalize(mat3(cameraMatrix) * viewNormal);\n    if(dot(normal, viewVector) < 0.0){\n        normal = -normal;\n        // Note: this line can be used to debug inverted meshes.\n        //material.baseColor = vec3(1.0, 0.0, 0.0);\n    }\n\n    vec3 irradiance;\n    // if(lightmapConnected){\n    //     irradiance = texture2D(lightmap, v_lightmapCoord).rgb;\n    // }\n    // else{\n#ifndef ENABLE_SPECULAR\n        irradiance = sampleEnvMap(normal, 1.0);\n#else\n        irradiance = vec3(dot(normal, viewVector));\n#endif\n        \n    // }\n\n// #ifdef ENABLE_DEBUGGING_LIGHTMAPS\n//     if(debugLightmapTexelSize)\n//     {\n//         vec2 coord_texelSpace = (v_lightmapCoord * lightmapSize) - v_geomItemData.zw;\n//         //vec2 coord_texelSpace = (v_textureCoord * lightmapSize);\n//         float total = floor(coord_texelSpace.x) +\n//                       floor(coord_texelSpace.y);\n                      \n//         vec3 clustercolor = getDebugColor(v_clusterID);\n\n//         material.metallic = 0.0;\n//         material.reflectance = 0.0;\n//         if(mod(total,2.0)==0.0){\n//             material.baseColor = clustercolor;\n//             irradiance = vec3(1.0);\n//         }\n//         else{\n//             material.baseColor = material.baseColor * 1.5;\n//         }\n//     }\n// #endif\n\n#ifndef ENABLE_SPECULAR\n    vec3 radiance = material.baseColor * irradiance;\n#else\n    vec3 radiance = pbrSurfaceRadiance(material, irradiance, normal, viewVector);\n#endif\n\n#ifndef ENABLE_ES3\n    vec4 fragColor;\n#endif\n    // fragColor = vec4(material.baseColor, 1.0);\n    // fragColor = vec4(material.baseColor * irradiance, 1.0);\n    fragColor = vec4(radiance + (emission * material.baseColor), 1.0);\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n    fragColor.rgb = toGamma(fragColor.rgb * exposure);\n#endif\n\n#ifndef ENABLE_ES3\n    gl_FragColor = fragColor;\n#endif\n}\n'),this.finalize();}static getParamDeclarations(){const e=super.getParamDeclarations();return e.push({name:"BaseColor",defaultValue:new u(1,1,.5)}),e.push({name:"Metallic",defaultValue:0,range:[0,1]}),e.push({name:"Roughness",defaultValue:.85,range:[0,1]}),e.push({name:"Reflectance",defaultValue:.1,range:[0,1]}),e.push({name:"EmissiveStrength",defaultValue:0,range:[0,1]}),e}static getGeomDataShaderName(){return "StandardSurfaceGeomDataShader"}static getSelectedShaderName(){return "StandardSurfaceSelectedGeomsShader"}}C.registerClass("StandardSurfaceShader",ji),Ja.setShaderModule("GLSLBits.glsl",'\n    \n/////////////////////////////////////////////////////////////////\n// http://concord-consortium.github.io/lab/experiments/webgl-gpgpu/script.js\nfloat shift_right(float v, float amt) {\n  v = floor(v) + 0.5;\n  return floor(v / exp2(amt));\n}\nfloat shift_left(float v, float amt) {\n  return floor(v * exp2(amt) + 0.5);\n}\n\nfloat mask_last(float v, float bits) {\n  return mod(v, shift_left(1.0, bits));\n}\nfloat extract_bits(float num, float from, float to) {\n  from = floor(from + 0.5);\n  to = floor(to + 0.5);\n  return mask_last(shift_right(num, from), to - from);\n}\n\n/////////////////////////////////////////////////////////////////\n// https://stackoverflow.com/questions/18453302/how-do-you-pack-one-32bit-int-into-4-8bit-ints-in-glsl-webgl\n\nconst vec4 bitEnc = vec4(1.,255.,65025.,16581375.);\nconst vec4 bitDec = 1./bitEnc;\nvec4 EncodeFloatRGBA (float v) {\n    vec4 enc = bitEnc * v;\n    enc = fract(enc);\n    enc -= enc.yzww * vec2(1./255., 0.).xxxy;\n    return enc;\n}\nfloat DecodeFloatRGBA (vec4 v) {\n    return dot(v, bitDec);\n}\n\n\n\n/////////////////////////////////////////////////////////////////\n// https://gist.github.com/Flexi23/1713774\n// \nvec2 encode16BitFloatInto2xUInt8(float v){\n    vec2 c = vec2(0.);\n\n    int signum = (v >= 0.) ? 128 : 0;\n    v = abs(v);\n    int exponent = 15;\n    float limit = 1024.; // considering the bias from 2^-5 to 2^10 (==1024)\n    for(int exp = 15; exp > 0; exp--){\n        if( v < limit){\n            limit /= 2.;\n            exponent--;\n        }\n    }\n\n    float rest;\n    if(exponent == 0){\n        rest = v / limit / 2.;      // "subnormalize" implicite preceding 0. \n    }else{\n        rest = (v - limit)/limit;   // normalize accordingly to implicite preceding 1.\n    }\n\n    int mantissa = int(rest * 2048.);   // 2048 = 2^11 for the (split) 11 bit mantissa\n    int msb = mantissa / 256;           // the most significant 3 bits go into the lower part of the first byte\n    int lsb = mantissa - msb * 256;     // there go the other 8 bit of the lower significance\n\n    c.x = float(signum + exponent * 8 + msb) / 255.;    // color normalization for texture2D\n    c.y = float(lsb) / 255.;\n\n    if(v >= 2048.){\n        c.y = 1.;\n    }\n\n    return c;\n}\n\nfloat decode16BitFloatFrom2xUInt8(vec2 c){\n    float v = 0.;\n\n    int ix = int(c.x*255.); // 1st byte: 1 bit signum, 4 bits exponent, 3 bits mantissa (MSB)\n    int iy = int(c.y*255.); // 2nd byte: 8 bit mantissa (LSB)\n\n    int s = (c.x >= 0.5) ? 1 : -1;\n    ix = (s > 0) ? ix - 128 : ix;   // remove the signum bit from exponent\n    int iexp = ix / 8;              // cut off the last 3 bits of the mantissa to select the 4 exponent bits\n    int msb = ix - iexp * 8;        // subtract the exponent bits to select the 3 most significant bits of the mantissa\n\n    int norm = (iexp == 0) ? 0 : 2048;          // distinguish between normalized and subnormalized numbers\n    int mantissa = norm + msb * 256 + iy;       // implicite preceding 1 or 0 added here\n    norm = (iexp == 0) ? 1 : 0;                 // normalization toggle\n    float exponent = pow( 2., float(iexp + norm) - 16.); // -5 for the the exponent bias from 2^-5 to 2^10 plus another -11 for the normalized 12 bit mantissa \n    v = float( s * mantissa ) * exponent;\n\n    return v;\n}\n\n\n// TODO : Encoding Float32 to 4x UInt8\n// http://concord-consortium.github.io/lab/experiments/webgl-gpgpu/script.js\n// http://ultraist.hatenablog.com/entry/20110608/1307539319\n\n');class qi extends Pa{constructor(e,t){super(e),this.__shaderStages.VERTEX_SHADER=Ja.parseShader("StandardSurfaceGeomDataShader.vertexShader",'\nprecision highp float;\n\nattribute vec3 positions;\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\n\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="drawItemId.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n\n\nvarying float v_drawItemId;\nvarying vec4 v_geomItemData;\nvarying vec3 v_viewPos;\nvarying float v_drawItemID;\nvarying vec3 v_worldPos;\n\nvoid main(void) {\n  int drawItemId = getDrawItemId();\n  v_drawItemId = float(drawItemId);\n  v_geomItemData = getInstanceData(drawItemId);\n\n  vec4 pos = vec4(positions, 1.);\n  mat4 modelMatrix = getModelMatrix(drawItemId);\n  mat4 modelViewMatrix = viewMatrix * modelMatrix;\n  vec4 viewPos = modelViewMatrix * pos;\n  gl_Position = projectionMatrix * viewPos;\n\n  v_viewPos = -viewPos.xyz;\n\n  v_drawItemID = float(getDrawItemId());\n  \n  v_worldPos      = (modelMatrix * pos).xyz;\n}\n'),this.__shaderStages.FRAGMENT_SHADER=Ja.parseShader("StandardSurfaceGeomDataShader.fragmentShader",'\nprecision highp float;\n\n<%include file="drawItemTexture.glsl"/>\n<%include file="cutaways.glsl"/>\n<%include file="GLSLBits.glsl"/>\n\nuniform int floatGeomBuffer;\nuniform int passId;\n\nuniform color cutColor;\nvec4 getCutaway(int id) {\n    return fetchTexel(instancesTexture, instancesTextureSize, (id * pixelsPerItem) + 5);\n}\n\nvarying float v_drawItemId;\nvarying vec4 v_geomItemData;\nvarying vec3 v_viewPos;\nvarying float v_drawItemID;\nvarying vec3 v_worldPos;\n\n\n#ifdef ENABLE_ES3\n    out vec4 fragColor;\n#endif\nvoid main(void) {\n  int drawItemId = int(v_drawItemId + 0.5);\n\n#ifndef ENABLE_ES3\n    vec4 fragColor;\n#endif\n\n  int flags = int(v_geomItemData.r + 0.5);\n  // Cutaways\n  if(testFlag(flags, GEOMITEM_FLAG_CUTAWAY)) {\n      vec4 cutAwayData   = getCutaway(drawItemId);\n      vec3 planeNormal = cutAwayData.xyz;\n      float planeDist = cutAwayData.w;\n      if(cutaway(v_worldPos, planeNormal, planeDist)){\n          discard;\n          return;\n      }\n      else if(!gl_FrontFacing){\n          fragColor = cutColor;\n  #ifndef ENABLE_ES3\n          gl_FragColor = fragColor;\n  #endif\n          return;\n      }\n  }\n\n    float dist = length(v_viewPos);\n\n    if(floatGeomBuffer != 0) {\n        fragColor.r = float(passId); \n        fragColor.g = float(v_drawItemID);\n        fragColor.b = 0.0;// TODO: store poly-id or something.\n        fragColor.a = dist;\n    }\n    else {\n        ///////////////////////////////////\n        // UInt8 buffer\n        fragColor.r = (mod(v_drawItemID, 256.) + 0.5) / 255.;\n        fragColor.g = (floor(v_drawItemID / 256.) + 0.5) / 255.;\n\n\n        // encode the dist as a 16 bit float\n        vec2 float16bits = encode16BitFloatInto2xUInt8(dist);\n        fragColor.b = float16bits.x;\n        fragColor.a = float16bits.y;\n    }\n\n\n#ifndef ENABLE_ES3\n    gl_FragColor = fragColor;\n#endif\n}\n');}}C.registerClass("StandardSurfaceGeomDataShader",qi);class $i extends Pa{constructor(e,t){super(e),this.__shaderStages.VERTEX_SHADER=Ja.parseShader("StandardSurfaceSelectedGeomsShader.vertexShader",'\nprecision highp float;\n\nattribute vec3 positions;\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\n\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="drawItemId.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n\nvarying float v_drawItemId;\n\nvoid main(void) {\n    int drawItemId = getDrawItemId();\n    v_drawItemId = float(drawItemId);\n    mat4 modelMatrix = getModelMatrix(drawItemId);\n    mat4 modelViewMatrix = viewMatrix * modelMatrix;\n    vec4 viewPos = modelViewMatrix * vec4(positions, 1.0);\n    gl_Position = projectionMatrix * viewPos;\n\n}\n'),this.__shaderStages.FRAGMENT_SHADER=Ja.parseShader("StandardSurfaceSelectedGeomsShader.fragmentShader",'\nprecision highp float;\n\nvarying float v_drawItemId;\n\n\n<%include file="drawItemTexture.glsl"/>\n\n#ifdef ENABLE_FLOAT_TEXTURES\nvec4 getHighlightColor(int id) {\n  return fetchTexel(instancesTexture, instancesTextureSize, (id * pixelsPerItem) + 4);\n}\n#else\n\nuniform vec4 highlightColor;\n\nvec4 getHighlightColor() {\n    return highlightColor;\n}\n\n#endif\n\n#ifdef ENABLE_ES3\n    out vec4 fragColor;\n#endif\nvoid main(void) {\n\n#ifndef ENABLE_ES3\n    vec4 fragColor;\n#endif\n    int drawItemId = int(v_drawItemId + 0.5);\n    fragColor = getHighlightColor(drawItemId);\n\n#ifndef ENABLE_ES3\n    gl_FragColor = fragColor;\n#endif\n}\n');}}C.registerClass("StandardSurfaceSelectedGeomsShader",$i);class es extends Pa{constructor(e){super(e),this.__shaderStages.VERTEX_SHADER=Ja.parseShader("HandleShader.vertexShader",'\nprecision highp float;\n\nattribute vec3 positions;\n#ifdef ENABLE_TEXTURES\nattribute vec2 texCoords;\n#endif\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\nuniform int maintainScreenSize;\n\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="drawItemId.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n\n/* VS Outputs */\nvarying vec3 v_viewPos;\n#ifdef ENABLE_TEXTURES\nvarying vec2 v_textureCoord;\n#endif\n\n\nvoid main(void) {\n  int drawItemId = getDrawItemId();\n  mat4 modelMatrix = getModelMatrix(drawItemId);\n  mat4 modelViewMatrix = viewMatrix * modelMatrix;\n\n  if(maintainScreenSize != 0) {\n    float dist = modelViewMatrix[3][2];\n    float sc = dist;\n    mat4 scmat = mat4(\n      sc, 0.0, 0.0, 0.0,\n      0.0, sc, 0.0, 0.0,\n      0.0, 0.0, sc, 0.0,\n      0.0, 0.0, 0.0, 1.0\n    );\n    modelViewMatrix = modelViewMatrix * scmat;\n  }\n\n  vec4 viewPos = modelViewMatrix * vec4(positions, 1.0);\n  gl_Position = projectionMatrix * viewPos;\n\n  v_viewPos = viewPos.xyz;\n  v_textureCoord = texCoords;\n  v_textureCoord.y = 1.0 - v_textureCoord.y;// Flip y\n}\n'),this.__shaderStages.FRAGMENT_SHADER=Ja.parseShader("HandleShader.fragmentShader",'\nprecision highp float;\n\n<%include file="stack-gl/gamma.glsl"/>\n<%include file="materialparams.glsl"/>\n\nuniform color BaseColor;\n\n#ifdef ENABLE_TEXTURES\nuniform sampler2D BaseColorTex;\nuniform int BaseColorTexType;\n#endif\n\n/* VS Outputs */\nvarying vec3 v_viewPos;\n#ifdef ENABLE_TEXTURES\nvarying vec2 v_textureCoord;\n#endif\n\n\n#ifdef ENABLE_ES3\n    out vec4 fragColor;\n#endif\nvoid main(void) {\n\n#ifndef ENABLE_TEXTURES\n    vec4 baseColor = BaseColor;\n#else\n    vec4 baseColor      = getColorParamValue(BaseColor, BaseColorTex, BaseColorTexType, v_textureCoord);\n#endif\n\n#ifndef ENABLE_ES3\n    vec4 fragColor;\n#endif\n    fragColor = baseColor;\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n    fragColor.rgb = toGamma(fragColor.rgb);\n#endif\n\n#ifndef ENABLE_ES3\n    gl_FragColor = fragColor;\n#endif\n}\n'),this.finalize();}static getParamDeclarations(){const e=super.getParamDeclarations();return e.push({name:"BaseColor",defaultValue:new u(1,1,.5)}),e.push({name:"maintainScreenSize",defaultValue:0}),e}static isOverlay(){return !0}static getGeomDataShaderName(){return "HandleGeomDataShader"}}C.registerClass("HandleShader",es);class ts extends qi{constructor(e,t){super(e),this.__shaderStages.VERTEX_SHADER=Ja.parseShader("HandleGeomDataShader.vertexShader",'\nprecision highp float;\n\nattribute vec3 positions;\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\nuniform int maintainScreenSize;\n\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="drawItemId.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n\n\nvarying float v_drawItemId;\nvarying vec4 v_geomItemData;\nvarying vec3 v_viewPos;\nvarying float v_drawItemID;\nvarying vec3 v_worldPos;\n\nvoid main(void) {\n  int drawItemId = getDrawItemId();\n  mat4 modelMatrix = getModelMatrix(drawItemId);\n  mat4 modelViewMatrix = viewMatrix * modelMatrix;\n  \n  if(maintainScreenSize != 0) {\n    float dist = modelViewMatrix[3][2];\n    float sc = dist;\n    mat4 scmat = mat4(\n      sc, 0.0, 0.0, 0.0,\n      0.0, sc, 0.0, 0.0,\n      0.0, 0.0, sc, 0.0,\n      0.0, 0.0, 0.0, 1.0\n    );\n    modelViewMatrix = modelViewMatrix * scmat;\n  }\n\n  vec4 viewPos = modelViewMatrix * vec4(positions, 1.0);\n  gl_Position = projectionMatrix * viewPos;\n\n  v_viewPos = -viewPos.xyz;\n\n  v_drawItemID = float(getDrawItemId());\n}\n');}}C.registerClass("HandleGeomDataShader",ts);class as extends Pa{constructor(e){super(e),this.__shaderStages.VERTEX_SHADER=Ja.parseShader("TransparentSurfaceShader.vertexShader",'\nprecision highp float;\n\n\nattribute vec3 positions;\nattribute vec3 normals;\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\n\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="stack-gl/inverse.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n\n/* VS Outputs */\nvarying vec3 v_viewPos;\nvarying vec3 v_viewNormal;\n\nvarying vec3 v_worldPos;\n/* VS Outputs */\n\nvoid main(void) {\n    int drawItemId = getDrawItemId();\n\n    vec4 geomItemData = getInstanceData(drawItemId);\n\n    vec4 pos = vec4(positions, 1.);\n    mat4 modelMatrix = getModelMatrix(drawItemId);\n    mat4 modelViewMatrix = viewMatrix * modelMatrix;\n    vec4 viewPos    = modelViewMatrix * pos;\n    gl_Position     = projectionMatrix * viewPos;\n\n    // mat4 mvp = projectionMatrix * viewMatrix * modelMatrix;\n    // gl_Position = mvp * vec4((lightmapCoords + geomItemData.xy), 0., 1.);\n\n    v_worldPos      = (modelMatrix * pos).xyz;\n\n    mat3 normalMatrix = mat3(transpose(inverse(modelViewMatrix)));\n    v_viewPos       = -viewPos.xyz;\n    v_viewNormal    = normalMatrix * normals;\n}\n'),this.__shaderStages.FRAGMENT_SHADER=Ja.parseShader("TransparentSurfaceShader.fragmentShader",'\nprecision highp float;\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n<%include file="stack-gl/gamma.glsl"/>\n#endif\n<%include file="GLSLUtils.glsl"/>\n\n/* VS Outputs */\nvarying vec3 v_viewPos;\nvarying vec3 v_viewNormal;\n\nvarying vec3 v_worldPos;\n/* VS Outputs */\n\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\nuniform float exposure;\n#endif\n\nuniform mat4 cameraMatrix;\nuniform float planeDist;\nuniform float planeAngle;\n\nuniform color BaseColor;\nuniform float Opacity;\n\n#ifdef ENABLE_SPECULAR\n<%include file="math/constants.glsl"/>\n<%include file="GGX_Specular.glsl"/>\n<%include file="PBRSurfaceRadiance.glsl"/>\nuniform float Roughness;\nuniform float Metallic;\nuniform float Reflectance;\n#endif\n\n#ifdef __ENABLE_TEXTURES\nuniform sampler2D BaseColorTex;\nuniform bool BaseColorTexType;\n\nuniform sampler2D OpacityTex;\nuniform bool OpacityTexType;\n\nuniform sampler2D RoughnessTex;\nuniform bool RoughnessTexType;\n\nuniform sampler2D ReflectanceTex;\nuniform bool ReflectanceTexType;\n\nuniform sampler2D NormalTex;\nuniform bool NormalTexType;\nuniform float NormalScale;\n\n\n#endif\n\n#ifdef ENABLE_ES3\n    out vec4 fragColor;\n#endif\nvoid main(void) {\n\n    MaterialParams material;\n\n#ifndef __ENABLE_TEXTURES\n    material.baseColor      = BaseColor.rgb;\n    float opacity           = Opacity;\n\n#ifdef ENABLE_SPECULAR\n    material.roughness      = Roughness;\n    material.metallic       = Metallic;\n    material.reflectance    = Reflectance;\n#endif\n\n#else\n    // Planar YZ projection for texturing, repeating every meter.\n    // vec2 texCoord        = v_worldPos.xz * 0.2;\n    vec2 texCoord           = vec2(v_textureCoord.x, 1.0 - v_textureCoord.y);\n    material.baseColor      = getColorParamValue(BaseColor, BaseColorTex, BaseColorTexType, texCoord).rgb;\n    material.roughness      = getLuminanceParamValue(Roughness, RoughnessTex, RoughnessTexType, texCoord);\n    material.metallic       = getLuminanceParamValue(Metallic, MetallicTex, MetallicTexType, texCoord);\n    material.reflectance    = Reflectance;//getLuminanceParamValue(Reflectance, ReflectanceTex, ReflectanceTexType, texCoord);\n\n    float opacity           = getLuminanceParamValue(Opacity, OpacityTex, OpacityTexType, texCoords);\n#endif\n\n#ifndef ENABLE_SPECULAR\n    gl_FragColor = vec4(material.baseColor.rgb, opacity);\n#else\n\n    vec3 viewNormal = normalize(v_viewNormal);\n    //vec3 surfacePos = -v_viewPos;\n\n#ifdef __ENABLE_TEXTURES\n    if(NormalTexType != 0){\n        vec3 textureNormal_tangentspace = normalize(texture2D(NormalTex, texCoord).rgb * 2.0 - 1.0);\n        viewNormal = normalize(mix(viewNormal, textureNormal_tangentspace, 0.3));\n    }\n#endif\n\n    vec3 viewVector = normalize(mat3(cameraMatrix) * normalize(v_viewPos));\n    vec3 normal = normalize(mat3(cameraMatrix) * viewNormal);\n    if(dot(normal, viewVector) < 0.0){\n        normal = -normal;\n        // Note: this line can be used to debug inverted meshes.\n        //material.baseColor = vec3(1.0, 0.0, 0.0);\n    }\n\n    vec4 specularReflectance = pbrSpecularReflectance(material, normal, viewVector);\n\n#ifndef ENABLE_ES3\n    vec4 fragColor;\n#endif\n\n    fragColor = vec4(specularReflectance.rgb, mix(opacity, 1.0, specularReflectance.a));\n\n#endif\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n    fragColor.rgb = toGamma(fragColor.rgb * exposure);\n#endif\n\n#ifndef ENABLE_ES3\n    gl_FragColor = fragColor;\n#endif\n}\n'),this.finalize();}static getParamDeclarations(){const e=super.getParamDeclarations();return e.push({name:"BaseColor",defaultValue:new u(1,1,.5)}),e.push({name:"Opacity",defaultValue:1,range:[0,1]}),e.push({name:"Roughness",defaultValue:.85}),e.push({name:"Reflectance",defaultValue:1e-4}),e}static getGeomDataShaderName(){return "StandardSurfaceGeomDataShader"}static getSelectedShaderName(){return "StandardSurfaceSelectedGeomsShader"}static isTransparent(){return !0}bind(e,t){return "ADD"==e.pass&&super.bind(e,t)}}C.registerClass("TransparentSurfaceShader",as);class is extends Pa{constructor(e){super(e),this.__shaderStages.VERTEX_SHADER=Ja.parseShader("ScreenSpaceShader.vertexShader",'\nprecision highp float;\n\nattribute vec3 positions;\n#ifdef ENABLE_TEXTURES\nattribute vec2 texCoords;\n#endif\n\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="drawItemId.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n\n/* VS Outputs */\n#ifdef ENABLE_TEXTURES\nvarying vec2 v_textureCoord;\n#endif\n\n\nvoid main(void) {\n  int drawItemId = getDrawItemId();\n    mat4 modelMatrix = getModelMatrix(drawItemId);\n\n    gl_Position = (modelMatrix * vec4(positions, 1.0));\n\n    v_textureCoord = texCoords;\n    v_textureCoord.y = 1.0 - v_textureCoord.y;// Flip y\n}\n'),this.__shaderStages.FRAGMENT_SHADER=Ja.parseShader("ScreenSpaceShader.fragmentShader",'\nprecision highp float;\n\n<%include file="stack-gl/gamma.glsl"/>\n<%include file="materialparams.glsl"/>\n\nuniform color BaseColor;\n\n#ifdef ENABLE_TEXTURES\nuniform sampler2D BaseColorTex;\nuniform int BaseColorTexType;\n#endif\n\n/* VS Outputs */\n#ifdef ENABLE_TEXTURES\nvarying vec2 v_textureCoord;\n#endif\n\n\n#ifdef ENABLE_ES3\n    out vec4 fragColor;\n#endif\nvoid main(void) {\n\n#ifndef ENABLE_TEXTURES\n    vec4 baseColor = BaseColor;\n#else\n    vec4 baseColor      = getColorParamValue(BaseColor, BaseColorTex, BaseColorTexType, v_textureCoord);\n#endif\n\n#ifndef ENABLE_ES3\n    vec4 fragColor;\n#endif\n    fragColor = baseColor;\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n    fragColor.rgb = toGamma(fragColor.rgb);\n#endif\n\n#ifndef ENABLE_ES3\n    gl_FragColor = fragColor;\n#endif\n}\n'),this.finalize();}static isOverlay(){return !0}static getParamDeclarations(){const e=super.getParamDeclarations();return e.push({name:"BaseColor",defaultValue:new u(1,1,.5)}),e}static getGeomDataShaderName(){return null}static getSelectedShaderName(){return null}}C.registerClass("ScreenSpaceShader",is);class ss extends zi{constructor(e){super(e),this.invisibleToGeomBuffer=!0;}}C.registerClass("ToolIconShader",ss);class ns extends Pa{constructor(e){super(e),this.__shaderStages.VERTEX_SHADER=Ja.parseShader("UnpackLDRAlphaImageShader.vertexShader",'\nprecision highp float;\n\n<%include file="utils/quadVertexFromID.glsl"/>\n\n/* VS Outputs */\nvarying vec2 v_texCoord;\n \nvoid main()\n{\n    vec2 position = getQuadVertexPositionFromID();\n    v_texCoord = position+0.5;\n    gl_Position = vec4(position*2.0, 0.0, 1.0);\n}\n'),this.__shaderStages.FRAGMENT_SHADER=Ja.parseShader("UnpackLDRAlphaImageShader.fragmentShader","\nprecision highp float;\n\nvarying vec2 v_texCoord;\nuniform sampler2D ldrSampler;\nuniform sampler2D alphaSampler;\n\nfloat luminanceFromRGB(vec3 rgb) {\n    return 0.2126*rgb.r + 0.7152*rgb.g + 0.0722*rgb.b;\n}\n\n\n#ifdef ENABLE_ES3\n    out vec4 fragColor;\n#endif\nvoid main(void) {\n\n#ifndef ENABLE_ES3\n    vec4 fragColor;\n#endif\n\n    fragColor = vec4(texture2D(ldrSampler, v_texCoord).rgb, luminanceFromRGB(texture2D(alphaSampler, v_texCoord).rgb));\n\n#ifndef ENABLE_ES3\n    gl_FragColor = fragColor;\n#endif\n}\n\n");}}class ls extends Pa{constructor(e){super(e),this.__shaderStages.VERTEX_SHADER=Ja.parseShader("WireShader.vertexShader","\nprecision highp float;\n\nattribute vec3 positions;    //(location = 0)\n\nuniform mat4 modelMatrix;\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\n\n/* VS Outputs */\n\nvoid main(void) {\n    mat4 modelViewProjectionMatrix = projectionMatrix * viewMatrix * modelMatrix;\n    gl_Position = modelViewProjectionMatrix * vec4(positions, 1.0);\n\n    // Apply the perspective transform, and then move the vertices\n    //  towards the camera by a tiny little bit...\n    gl_Position.z -= 0.001 / gl_Position.w;\n    //gl_Position.z *= 0.999;\n}\n"),this.__shaderStages.FRAGMENT_SHADER=Ja.parseShader("WireShader.fragmentShader","\nprecision highp float;\n\nuniform color wireColor;\n\n#ifdef ENABLE_ES3\n    out vec4 fragColor;\n#endif\nvoid main(void) {\n#ifdef ENABLE_ES3\n    gl_FragColor = color;\n#else\n    fragColor = color;\n#endif  \n}\n");}}const rs=0,os=1,ds=2,hs=3;class cs{constructor(e,t,a,i,s=null){this.gl=e,this.geomItem=t,this.glGeom=a,this.id=i,this.flags=s,this.visible=this.geomItem.getVisible(),this.culled=!1,this.lightmapName=t.getLightmapName(),this.updated=new S,this.visibilityChanged=new S,this.highlightChanged=t.highlightChanged,this.updateVisibility=this.updateVisibility.bind(this),this.updateVisibility=this.updateVisibility.bind(this),this.destroy=this.destroy.bind(this),e.floatTexturesSupported?this.updateXfo=e=>{this.updated.emit(rs);}:this.updateXfo=e=>{this.updateGeomMatrix();},this.geomItem.geomXfoChanged.connect(this.updateXfo),this.geomItem.visibilityChanged.connect(this.updateVisibility),this.geomItem.cutAwayChanged.connect(()=>{this.updated.emit(rs);}),this.highlightChangedId=this.geomItem.highlightChanged.connect(()=>{this.updated.emit(hs);}),this.glGeom.updated.connect(()=>{this.updated.emit(os);});const n=this.geomItem.getLightmapCoordsOffset();this.geomData=[n.x,n.y,0,0];}getGeomItem(){return this.geomItem}getGLGeom(){return this.glGeom}getVisible(){return this.geomItem.getVisible()}getId(){return this.id}getFlags(){return this.flags}updateVisibility(){const e=this.geomItem.getVisible()&&!this.culled;this.visible!=e&&(this.visible=e,this.visibilityChanged.emit(e),this.updated.emit());}setCullState(e){this.culled=e,this.updateVisibility();}updateGeomMatrix(){this.modelMatrixArray=this.geomItem.getGeomMat4().asArray();}getGeomMatrixArray(){return this.modelMatrixArray}bind(e){const t=this.gl,a=e.unifs;if(!t.floatTexturesSupported){const e=a.modelMatrix;e&&t.uniformMatrix4fv(e.location,!1,this.modelMatrixArray);const i=a.drawItemData;i&&t.uniform4f(i.location,this.geomData);}const i=a.transformIndex;if(i&&t.uniform1i(i.location,this.id),e.lightmaps&&a.lightmap&&e.boundLightmap!=this.lightmapName){const i=e.lightmaps[this.lightmapName];i&&i.glimage.isLoaded()?(i.glimage.bindToUniform(e,a.lightmap),t.uniform2fv(a.lightmapSize.location,i.atlasSize.asArray()),a.lightmapConnected&&t.uniform1i(a.lightmapConnected.location,!0),e.boundLightmap=this.lightmapName):a.lightmapConnected&&t.uniform1i(a.lightmapConnected.location,!1);}return !0}destroy(){this.geomItem.visibilityChanged.disconnect(this.updateVisibility),this.geomItem.geomXfoChanged.disconnect(this.updateXfo),this.geomItem.highlightChanged.disconnectId(this.highlightChangedId);}}class ms extends Li{constructor(){super(),this.__drawItems=[void 0],this.__drawItemsIndexFreeList=[],this.__dirtyItemIndices=[];}init(e,t){super.init(e,t),this.__renderer.registerPass(e=>{if(e instanceof sa){if(e.getMetadata("glgeomItem"))return !1;{const t=t=>!!this.filterGeomItem(t)&&(null==e.getGeometry()?e.geomAssigned.connect(()=>{this.addGeomItem(t);}):this.addGeomItem(t),!0);return null==e.getMaterial()?(console.warn("Scene item :"+e.getPath()+" has no material"),!1):t(e)}}return !1},e=>!!(e instanceof sa&&e.getMetadata("glgeomItem"))&&this.removeGeomItem(e));}filterGeomItem(e){return !0}addShader(e){return this.__renderer.getOrCreateShader(e.getShaderName())}constructShaders(e){let t,a;const i=this.__renderer.getOrCreateShader(e);return i.constructor.getGeomDataShaderName()&&(t=this.__renderer.getOrCreateShader(i.constructor.getGeomDataShaderName())),i.constructor.getSelectedShaderName()&&(a=this.__renderer.getOrCreateShader(i.constructor.getSelectedShaderName())),{glshader:i,glgeomdatashader:t,glselectedshader:a}}addMaterial(e){let t=e.getMetadata("glmaterial");if(t)return t;const a=this.__renderer.getOrCreateShader(e.getShaderName());return t=new $a(this.__gl,e,a),t.updated.connect(()=>{this.__renderer.requestRedraw();}),e.setMetadata("glmaterial",t),t}addGeom(e){let t=e.getMetadata("glgeom");if(t)return t.addRef(this),t;const a=this.__gl;if(e instanceof Ft||e instanceof Nt)t=new Ka(a,e);else if(e instanceof Mt||e instanceof Yt)t=new wa(a,e);else {if(!(e instanceof vt||e instanceof Ct))throw new Error("Unsupported geom type:"+e.constructor.name);t=new za(a,e);}return e.setMetadata("glgeom",t),t.addRef(this),t}removeGeom(e){let t=e.getMetadata("glgeom");if(t)return t.removeRef(this),t}addGeomItem(e){const t=this.addGeom(e.getGeometry());let a;this.__drawItemsIndexFreeList.length>0?a=this.__drawItemsIndexFreeList.pop():(a=this.__drawItems.length,this.__drawItems.push(null)),this.__dirtyItemIndices.push(a);const i=this.__gl,s=new cs(i,e,t,a,1);e.setMetadata("glgeomItem",s);s.updated.connect(e=>{switch(e){case rs:if(-1!=this.__dirtyItemIndices.indexOf(a))return;this.__dirtyItemIndices.push(a);break;case os:case ds:break;case hs:if(-1!=this.__dirtyItemIndices.indexOf(a))return;return this.__dirtyItemIndices.push(a),void this.__renderer.requestRedraw()}this.__renderer.drawItemChanged();});return this.__drawItems[a]=s,this.__renderer.requestRedraw(),e.setMetadata("glpass",this),s}removeGeomItem(e){if(e.getMetadata("glpass")!=this)return;const t=e.getMetadata("glgeomItem"),a=t.getId();return this.__drawItems[a]=null,this.__drawItemsIndexFreeList.push(a),this.__renderer.requestRedraw(),e.getMetadata("glpass"),e.deleteMetadata("glgeomItem"),t}removeGLGeom(e,t){const a=t.geomItemMappings.indexOf(e);t.geomItemMappings.splice(a,1);}getGeomItem(e){if(!(e>=this.__drawItems.length))return this.__drawItems[e];console.warn("Invalid Draw Item id:"+e+" NumItems:"+(this.__drawItems.length-1));}__populateDrawItemDataArray(e,t,a){const i=24*t;let s=0;if(e.isCutawayEnabled()){s|=1;}const n=e.getLightmapCoordsOffset();h.createFromFloat32Buffer(a.buffer,i+0).set(s,0,n.x,n.y);const l=e.getGeomMat4(),r=h.createFromFloat32Buffer(a.buffer,i+4),o=h.createFromFloat32Buffer(a.buffer,i+8),d=h.createFromFloat32Buffer(a.buffer,i+12);r.set(l.xAxis.x,l.yAxis.x,l.zAxis.x,l.translation.x),o.set(l.xAxis.y,l.yAxis.y,l.zAxis.y,l.translation.y),d.set(l.xAxis.z,l.yAxis.z,l.zAxis.z,l.translation.z);const c=h.createFromFloat32Buffer(a.buffer,i+16);if(e.isHighlighted()){const t=e.getHighlight();c.set(t.r,t.g,t.b,t.a);}const m=h.createFromFloat32Buffer(a.buffer,i+20);if(e.isCutawayEnabled()){const t=e.getCutVector(),a=e.getCutDist();m.set(t.x,t.y,t.z,a);}}newItemsReadyForLoading(){return this.__dirtyItemIndices.length>0}uploadGeomItems(){const e=this.__gl;if(!e.floatTexturesSupported){const e=this.__dirtyItemIndices.length;for(let t=0;t<e;t++){const e=this.__drawItems[this.__dirtyItemIndices[t]];e&&e.updateGeomMatrix();}return void(this.__dirtyItemIndices=[])}let t=Math.round(Math.sqrt(6*this.__drawItems.length)+.5);t=Math.nextPow2(t),t%6!=0&&(t+=6-t%6),this.__drawItemsTexture?this.__drawItemsTexture.width!=t&&(this.__drawItemsTexture.resize(t,t),this.__dirtyItemIndices=Array(t*t/6).fill().map((e,t)=>t)):(this.__drawItemsTexture=new Fa(e,{format:"RGBA",type:"FLOAT",width:t,height:t,filter:"NEAREST",wrap:"CLAMP_TO_EDGE",mipMapped:!1}),this.__drawItemsTexture.clear()),e.bindTexture(e.TEXTURE_2D,this.__drawItemsTexture.glTex);const a=this.__drawItemsTexture.getTypeID();for(let i=0;i<this.__dirtyItemIndices.length;i++){const s=this.__dirtyItemIndices[i],n=Math.floor(6*s/t);let l=s+1;for(let e=i+1;e<this.__dirtyItemIndices.length;e++){const a=this.__dirtyItemIndices[e];if(Math.floor(6*a/t)!=n)break;if(a!=l)break;l++;}const r=l-s,o=6*s%t,d=6*r,h=1,c=new Float32Array(24*r);for(let e=s;e<l;e++){const t=this.__drawItems[e];t&&this.__populateDrawItemDataArray(t.getGeomItem(),e-s,c);}if(a==e.FLOAT)this.__drawItemsTexture.populate(c,d,h,o,n,!1);else {const e=Math.convertFloat32ArrayToUInt16Array(c);this.__drawItemsTexture.populate(e,d,h,o,n,!1);}i+=r-1;}this.__dirtyItemIndices=[];}finalize(){0!=this.__dirtyItemIndices.length&&this.uploadGeomItems();}bind(e){const t=this.__gl,a=e.unifs;return this.__drawItemsTexture&&a.instancesTexture&&(this.__drawItemsTexture.bindToUniform(e,a.instancesTexture),t.uniform1i(a.instancesTextureSize.location,this.__drawItemsTexture.width)),!0}bindShader(e,t){return !!t.bind(e,this.constructor.name)&&!!this.bind(e)}bindMaterial(e,t,a){return t.bind(e,a)}}class us{constructor(e,t){this.gl=e,this.glgeom=t,this.glgeomItems=[],this.glgeomItems_freeIndices=[],this.glgeomItemSignalIds=[],this.drawIdsArray=null,this.drawIdsBuffer=null,this.drawIdsBufferDirty=!0,this.highlightedIdsArray=null,this.highlightedIdsBuffer=null,this.highlightedIdsBufferDirty=!0,this.lightmapName=void 0,this.drawCountChanged=new S,this.visibleItems=[],this.highlightedItems=[];}getGLGeom(){return this.glgeom}getLightmapName(){return this.lightmapName}getDrawCount(){return this.visibleItems.length}addGeomItem(e){let t;this.glgeomItems_freeIndices.length>0?t=this.glgeomItems_freeIndices.pop():(t=this.glgeomItems.length,this.glgeomItems.push(null)),e.visible&&(this.visibleItems.push(t),this.drawCountChanged.emit(1)),e.getGeomItem().isHighlighted()&&(this.highlightedItems.push(t),this.highlightedIdsBufferDirty=!0),1==this.glgeomItems.length&&(this.lightmapName=e.getGeomItem().getLightmapName());const a={};a.sel=e.highlightChanged.connect(()=>{if(e.getGeomItem().isHighlighted()){if(-1!=this.highlightedItems.indexOf(t))return;this.highlightedItems.push(t);}else this.highlightedItems.splice(this.highlightedItems.indexOf(t),1);this.highlightedIdsBufferDirty=!0;}),a.vis=e.visibilityChanged.connect(e=>{e?(this.visibleItems.push(t),this.drawCountChanged.emit(1)):(this.visibleItems.splice(this.visibleItems.indexOf(t),1),this.drawCountChanged.emit(-1)),this.drawIdsBufferDirty=!0;}),this.glgeomItems[t]=e,this.glgeomItemSignalIds[t]=a,this.drawIdsBufferDirty=!0;}removeGeomItem(e){const t=this.glgeomItems.indexOf(e),a=this.glgeomItemSignalIds[t];e.highlightChanged.disconnectId(a.sel),e.visibilityChanged.disconnectId(a.vis),this.glgeomItems[t]=null,this.glgeomItemSignalIds[t]=null,this.glgeomItems_freeIndices.push(t),e.visible&&(this.visibleItems.splice(this.visibleItems.indexOf(t),1),this.drawCountChanged.emit(-1)),e.getGeomItem().isHighlighted()&&this.highlightedItems.splice(this.highlightedItems.indexOf(t),1),this.drawIdsBufferDirty=!0,0==this.glgeomItems.length&&this.destroy();}updateDrawIDsBuffer(){const e=this.gl;e.floatTexturesSupported?(this.drawIdsBuffer&&this.glgeomItems.length!=this.drawIdsArray.length&&(this.gl.deleteBuffer(this.drawIdsBuffer),this.drawIdsBuffer=null),this.drawIdsBuffer||(this.drawIdsArray=new Float32Array(this.glgeomItems.length),this.drawIdsBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.drawIdsBuffer)),this.visibleItems.forEach((e,t)=>{this.drawIdsArray[t]=this.glgeomItems[e].getId();}),e.bindBuffer(e.ARRAY_BUFFER,this.drawIdsBuffer),e.bufferData(e.ARRAY_BUFFER,this.drawIdsArray,e.STATIC_DRAW),this.drawIdsBufferDirty=!1):this.drawIdsBufferDirty=!1;}updateHighlightedIDsBuffer(){const e=this.gl;e.floatTexturesSupported?(this.highlightedIdsBuffer&&this.glgeomItems.length!=this.highlightedIdsArray.length&&(this.gl.deleteBuffer(this.highlightedIdsBuffer),this.highlightedIdsBuffer=null),(!this.highlightedIdsArray||this.highlightedItems.length>this.highlightedIdsArray.length)&&(this.highlightedIdsArray=new Float32Array(this.highlightedItems.length),this.highlightedIdsBuffer&&(e.deleteBuffer(this.highlightedIdsBuffer),this.highlightedIdsBuffer=null)),this.highlightedItems.forEach((e,t)=>{this.highlightedIdsArray[t]=this.glgeomItems[e].getId();}),this.highlightedIdsBuffer||(this.highlightedIdsBuffer=e.createBuffer()),e.bindBuffer(e.ARRAY_BUFFER,this.highlightedIdsBuffer),e.bufferData(e.ARRAY_BUFFER,this.highlightedIdsArray,e.STATIC_DRAW),this.highlightedIdsBufferDirty=!1):this.highlightedIdsBufferDirty=!1;}draw(e){if(0==this.visibleItems.length)return;this.drawIdsBufferDirty&&this.updateDrawIDsBuffer();const t=this.gl,a=e.unifs;if(e.lightmaps&&a.lightmap&&e.boundLightmap!=this.lightmapName){const i=e.lightmaps[this.lightmapName];i&&i.glimage.isLoaded()?(i.glimage.bindToUniform(e,a.lightmap),t.uniform2fv(a.lightmapSize.location,i.atlasSize.asArray()),a.lightmapConnected&&t.uniform1i(a.lightmapConnected.location,!0),e.boundLightmap=this.lightmapName):a.lightmapConnected&&t.uniform1i(a.lightmapConnected.location,!1);}this.__bindAndRender(e,this.visibleItems,this.drawIdsBuffer);}drawHighlighted(e){0!=this.highlightedItems.length&&(this.highlightedIdsBufferDirty&&this.updateHighlightedIDsBuffer(),this.__bindAndRender(e,this.highlightedItems,this.highlightedIdsBuffer));}__bindAndRender(e,t,a){const i=this.gl,s=e.unifs;if(e.glgeom!=this.glgeom&&(this.glgeom.bind(e),e.glgeom=this.glgeom),i.floatTexturesSupported&&i.drawElementsInstanced&&e.supportsInstancing){i.uniform1i(e.unifs.instancedDraw.location,1);const n=e.attrs.instancedIds.location;i.enableVertexAttribArray(n),i.bindBuffer(i.ARRAY_BUFFER,a),i.vertexAttribPointer(n,1,i.FLOAT,!1,4,0),i.vertexAttribDivisor(n,1),e.bindViewports(s,()=>{this.glgeom.drawInstanced(t.length);});}else e.unifs.instancedDraw&&i.uniform1i(e.unifs.instancedDraw.location,0),t.forEach(t=>{this.glgeomItems[t].bind(e),e.bindViewports(s,()=>{this.glgeom.draw(e);});});}destroy(){}}class bs{constructor(e){this.glshader=e.glshader,this.glgeomdatashader=e.glgeomdatashader,this.glselectedshader=e.glselectedshader,this.glmaterialGeomItemSets=[];}findMaterialGeomItemSets(e){for(const t of this.glmaterialGeomItemSets)if(t.glmaterial==e)return t}addMaterialGeomItemSets(e){this.glmaterialGeomItemSets.push(e);}removeMaterialGeomItemSets(e){const t=this.glmaterialGeomItemSets.indexOf(e);this.glmaterialGeomItemSets.splice(t,1);}getMaterialGeomItemSets(){return this.glmaterialGeomItemSets}}class ps{constructor(e){this.glmaterial=e,this.geomItemSets=[],this.drawCount=0,this.visibleInGeomDataBuffer=e.getMaterial().visibleInGeomDataBuffer,this.__drawCountChanged=this.__drawCountChanged.bind(this);}getGLMaterial(){return this.glmaterial}__drawCountChanged(e){this.drawCount+=e;}addGeomItemSet(e){-1==this.geomItemSets.indexOf(e)?(this.geomItemSets.push(e),this.drawCount+=e.drawCount,e.drawCountChanged.connect(this.__drawCountChanged)):console.warn("geomItemSet already added to GLMaterialGeomItemSets");}removeGeomItemSet(e){const t=this.geomItemSets.indexOf(e);this.geomItemSets.splice(t,1),e.drawCountChanged.disconnect(this.__drawCountChanged),e.destroy();}findGeomItemSet(e){for(const t of this.geomItemSets)if(t.getGLGeom()==e)return t;return null}getGeomItemSets(){return this.geomItemSets}}class gs extends ms{constructor(){super(),this.__glshadermaterials={};}init(e,t){super.init(e,t);}filterGeomItem(e){const t=e.getMaterial().getShaderClass();if(t){if(t.isTransparent())return !1;if(t.isOverlay())return !1;const a=e.getMaterial().getParameter("BaseColor");return !(a&&a.getValue().a<1)}return !1}addGeomItem(e){const t=e.getMaterial(),a=t.getShaderName(),i=this.constructShaders(a);const s=this.addMaterial(t),n=super.addGeomItem(e);let l=this.__glshadermaterials[a];l||(l=new bs(i),this.__glshadermaterials[a]=l);let r=l.findMaterialGeomItemSets(s);r||(r=new ps(s),l.addMaterialGeomItemSets(r));let o=r.findGeomItemSet(n.glGeom);return o||(o=new us(this.__gl,n.glGeom),r.addGeomItemSet(o)),e.setMetadata("geomItemSet",o),o.addGeomItem(n),!0}removeGeomItem(e){const t=super.removeGeomItem(e);if(!t)return !1;const a=e.getMetadata("geomItemSet");return a&&(a.removeGeomItem(t),e.deleteMetadata("geomItemSet")),!0}removeMaterial(e){const t=this.__glshadermaterials[e.hash];if(!t||t!=e.getMetadata("glshaderMaterials"))return void console.warn("Material not found in pass");const a=e.getMetadata("glmaterialGeomItemSets");t.removeMaterialGeomItemSets(a);}__traverseTreeAndDraw(e){for(const t in this.__glshadermaterials){const a=this.__glshadermaterials[t],i=a.glshader;if(this.bindShader(e,i)){const t=a.getMaterialGeomItemSets();for(const a of t)if(0!=a.drawCount&&this.bindMaterial(e,a.getGLMaterial(),!0)){const t=a.getGeomItemSets();for(const a of t)a.draw(e);}}i.unbind(e);}e.glgeom&&e.glgeom.unbind(e);}draw(e){this.newItemsReadyForLoading()&&this.finalize();const t=this.__gl;t.disable(t.BLEND),t.disable(t.CULL_FACE),t.enable(t.DEPTH_TEST),t.depthFunc(t.LESS),t.depthMask(!0),this.__traverseTreeAndDraw(e);}drawHighlightedGeoms(e){const t=this.__gl;t.disable(t.CULL_FACE);for(const t in this.__glshadermaterials){const a=this.__glshadermaterials[t];if(!a.glselectedshader)continue;if(!this.bindShader(e,a.glselectedshader))continue;const i=a.getMaterialGeomItemSets();for(const t of i){const a=t.getGeomItemSets();for(const t of a)t.drawHighlighted(e);}}e.glgeom&&e.glgeom.unbind(e);}getGeomItemAndDist(e){let t,a;this.__gl.floatGeomBuffer?(t=Math.round(e[1]),a=e[3]):(t=e[0]+(e[1]<<8),a=Math.decode16BitFloatFrom2xUInt8([e[2],e[3]]));const i=this.__drawItems[t];if(i)return {geomItem:i.getGeomItem(),dist:a}}drawGeomData(e){this.newItemsReadyForLoading()&&this.finalize();const t=this.__gl;t.disable(t.BLEND),t.disable(t.CULL_FACE),t.enable(t.DEPTH_TEST),t.depthFunc(t.LESS),t.depthMask(!0);for(const a in this.__glshadermaterials){const i=this.__glshadermaterials[a];if(!i.glgeomdatashader)continue;if(!this.bindShader(e,i.glgeomdatashader))continue;{const a=e.unifs.floatGeomBuffer;a&&t.uniform1i(a.location,t.floatGeomBuffer?1:0);}{const a=e.unifs.passId;a&&t.uniform1i(a.location,this.__passIndex);}const s=i.getMaterialGeomItemSets();for(const t of s)if(0!=t.drawCount&&t.visibleInGeomDataBuffer&&this.bindMaterial(e,t.getGLMaterial(),!1)){const a=t.getGeomItemSets();for(const t of a)t.draw(e);}}e.glgeom&&e.glgeom.unbind(e);}}Fi.registerPass(gs,Wi.OPAQUE);class _s extends ms{constructor(){super();}init(e,t){super.init(e,t),this.transparentItems=[],this.freeList=[],this.visibleItems=[],this.prevSortCameraPos=new d(999,999,999),this.resort=!1;}filterGeomItem(e){const t=e.getMaterial().getShaderClass();if(t){if(t.isTransparent())return !0;if(t.isOverlay())return !1;const a=e.getMaterial().getParameter("BaseColor");if(a&&a.getValue().a<.999)return !0}return !1}addGeomItem(e){const t=e.getMaterial(),a=t.getShaderName(),i=this.constructShaders(a),s=this.addMaterial(t),n=super.addGeomItem(e),l=e.visibilityChanged.connect(e=>{if(e)this.visibleItems.push(o);else {const e=this.visibleItems.indexOf(o);this.visibleItems.splice(e,1);}}),r=e.geomXfoChanged.connect(()=>{this.resort=!0;}),o={geomItem:e,shaders:i,glmaterial:s,glgeomitem:n,visibilityChangedId:l,geomXfoChangedId:r};let d;d=this.freeList.length>0?this.freeList.pop():this.transparentItems.length,this.transparentItems[d]=o,e.setMetadata("itemIndex",d),e.getVisible()&&this.visibleItems.push(o),this.resort=!0;}removeGeomItem(e){if(!super.removeGeomItem(e))return;const t=e.getMetadata("itemIndex"),a=this.transparentItems[t];this.transparentItems[t]=null,this.freeList.push(t);const i=this.visibleItems.indexOf(a);-1!=i&&this.visibleItems.splice(i,1);}sortItems(e){for(const t of this.visibleItems){const a=t.glgeomitem.geomItem.getGeomMat4();t.dist=a.translation.distanceTo(e);}this.visibleItems.sort((e,t)=>e.dist>t.dist?-1:e.dist<t.dist?1:0),this.prevSortCameraPos=e,this.resort=!1;}_drawItem(e,t,a){if(a.currentglMaterial!=t.glmaterial&&(a.currentglMaterial=t.glmaterial,!a.currentglMaterial.bind(e)))return;const i=t.glgeomitem;if((a.currentglGeom==i.glGeom||(a.currentglGeom=i.glGeom,a.currentglGeom.bind(e)))&&i.bind(e)){if(e.unifs.instancedDraw){const t=this.__gl;t.uniform1i(e.unifs.instancedDraw.location,0),t.disableVertexAttribArray(e.attrs.instancedIds.location);}e.bindViewports(e.unifs,()=>{a.currentglGeom.draw(e);});}}_drawItems(e){const t={currentglShader:null,currentglMaterial:null,currentglGeom:null};for(const a of this.visibleItems){if(t.currentglShader!=a.shaders.glshader){if(!this.bindShader(e,a.shaders.glshader))continue;t.currentglShader=a.shaders.glshader;}this._drawItem(e,a,t);}t.currentglGeom&&t.currentglGeom.unbind(e);}draw(e){if(0==this.visibleItems.length)return;this.newItemsReadyForLoading()&&this.finalize();const t=this.__gl,a=e.viewXfo.tr;(this.resort||a.distanceTo(this.prevSortCameraPos)>.3)&&this.sortItems(a),t.enable(t.DEPTH_TEST),t.depthFunc(t.LESS),t.depthMask(!0),t.enable(t.BLEND),t.blendEquation(t.FUNC_ADD),e.pass="MULTIPLY",t.blendFunc(t.DST_COLOR,t.ZERO),this._drawItems(e),e.pass="ADD",t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),this._drawItems(e),t.disable(t.BLEND);}drawHighlightedGeoms(e){const t=this.__gl;t.disable(t.CULL_FACE);const a={currentglShader:null,currentglMaterial:null,currentglGeom:null};for(const t of this.visibleItems){if(!t.geomItem.isHighlighted())continue;if(!t.shaders.glselectedshader)continue;const i=t.shaders;if(a.currentglShader!=i.glselectedshader){if(!this.bindShader(e,i.glselectedshader))continue;a.currentglShader=i.glselectedshader;}this._drawItem(e,t,a);}a.currentglGeom&&a.currentglGeom.unbind(e);}getGeomItemAndDist(e){let t,a;this.__gl.floatGeomBuffer?(t=Math.round(e[1]),a=e[3]):(t=e[0]+(e[1]<<8),a=Math.decode16BitFloatFrom2xUInt8([e[2],e[3]]));const i=this.__drawItems[t];if(i)return {geomItem:i.getGeomItem(),dist:a}}drawGeomData(e){this.newItemsReadyForLoading()&&this.finalize();const t=this.__gl;t.disable(t.BLEND),t.disable(t.CULL_FACE),t.enable(t.DEPTH_TEST),t.depthFunc(t.LESS),t.depthMask(!0);const a={currentglShader:null,currentglMaterial:null,currentglGeom:null};for(const i of this.visibleItems){const s=i.shaders;if(a.currentglShader!=s.glgeomdatashader){if(!this.bindShader(e,s.glgeomdatashader))continue;a.currentglShader=s.glgeomdatashader;}{const a=e.unifs.floatGeomBuffer;a&&t.uniform1i(a.location,t.floatGeomBuffer?1:0);}{const a=e.unifs.passId;a&&t.uniform1i(a.location,this.__passIndex);}this._drawItem(e,i,a);}a.currentglGeom&&a.currentglGeom.unbind(e);}}Fi.registerPass(_s,Wi.TRANSPARENT);class Zs extends Li{constructor(){super();}init(e,t){super.init(e,t),this.__billboards=[],this.__freeIndices=[],this.__drawCount=0,this.__threshold=0,this.__updateRequested=!1,this.__prevSortCameraPos=new d,this.__atlas=new ni(this.__renderer.gl,"Billboards","RGBA","UNSIGNED_BYTE",[1,1,1,0]),this.__atlas.loaded.connect(this.updated.emit),this.__atlas.updated.connect(this.updated.emit),this.__renderer.registerPass(e=>e instanceof ha&&(this.addBillboard(e),!0),e=>e instanceof ha&&(this.removeBillboard(e),!0));}filterRenderTree(){}addBillboard(e){const t=e.getParameter("image"),a=t.getValue();if(!a)return void t.valueChanged.connect(()=>this.addBillboard(e));let i;i=this.__freeIndices.length>0?this.__freeIndices.pop():this.__billboards.length;const s=this.__atlas.addSubImage(a);e.setMetadata("GLBillboardsPass_Index",i);const n=e.visibilityChanged.connect(()=>{e.getVisible()?(this.__drawCount++,this.__updateBillboard(i)):this.__drawCount--,this.__reqUpdateIndexArray();}),l=e.getParameter("GlobalXfo").valueChanged.connect(()=>{e.getVisible()&&(this.__updateBillboard(i),this.updated.emit());}),r=e.getParameter("alpha").valueChanged.connect(()=>{e.getVisible()&&(this.__updateBillboard(i),this.updated.emit());});e.getVisible()&&this.__drawCount++,this.__billboards[i]={billboard:e,imageIndex:s,visibilityChangedId:n,xfoChangedId:l,alphaChangedId:r},this.indexArrayUpdateNeeded=!0,this.__requestUpdate();}removeBillboard(e){const t=e.getMetadata("GLBillboardsPass_Index");if(-1==t)return void console.warn("Billboard already removed.");const a=this.__billboards[t],i=a.billboard.getParameter("image").getValue();this.__atlas.removeSubImage(i),e.visibilityChanged.disconnectId(a.visibilityChangedId),e.getParameter("GlobalXfo").valueChanged.disconnectId(a.xfoChangedId),e.getParameter("alpha").valueChanged.disconnectId(a.alphaChangedId),this.__billboards[t]=null,this.__freeIndices.push(t),e.getVisible()&&this.__drawCount--,this.indexArrayUpdateNeeded=!0,this.__requestUpdate();}__populateBillboardDataArray(e,t,a){const i=e.billboard,s=i.getGlobalXfo().toMat4(),n=i.getParameter("scale").getValue();let l=0;i.getParameter("alignedToCamera").getValue()&&(l|=4);const r=i.getParameter("alpha").getValue(),o=i.getParameter("color").getValue(),d=5*t*4,c=h.createFromFloat32Buffer(a.buffer,d),m=h.createFromFloat32Buffer(a.buffer,d+4),u=h.createFromFloat32Buffer(a.buffer,d+8),b=h.createFromFloat32Buffer(a.buffer,d+12);c.set(s.xAxis.x,s.yAxis.x,s.zAxis.x,s.translation.x),m.set(s.xAxis.y,s.yAxis.y,s.zAxis.y,s.translation.y),u.set(s.xAxis.z,s.yAxis.z,s.zAxis.z,s.translation.z),b.set(n,l,e.imageIndex,r),h.createFromFloat32Buffer(a.buffer,d+16).set(o.r,o.g,o.b,o.a);}__requestUpdate(){this.__updateRequested||(this.__updateRequested=!0,setTimeout(()=>{this.__updateBillboards();},100));}__reqUpdateIndexArray(){this.indexArrayUpdateNeeded||(this.indexArrayUpdateNeeded=!0,this.updateIndexArrayId=setTimeout(()=>{this.indexArrayUpdateNeeded&&(this.__updateIndexArray(),this.updated.emit());},1));}__updateIndexArray(){const e=this.__gl;this.__indexArray&&this.__indexArray.length!=this.__drawCount&&(e.deleteBuffer(this.__instanceIdsBuffer),this.__instanceIdsBuffer=null),this.__indexArray=new Float32Array(this.__drawCount);let t=0;for(let e=0;e<this.__billboards.length;e++)this.__billboards[e]&&this.__billboards[e].billboard.getVisible()&&(this.__indexArray[t]=e,t++);this.__instanceIdsBuffer||(this.__instanceIdsBuffer=e.createBuffer()),e.bindBuffer(e.ARRAY_BUFFER,this.__instanceIdsBuffer),e.bufferData(e.ARRAY_BUFFER,this.__indexArray,e.STATIC_DRAW),this.indexArrayUpdateNeeded=!1;}__updateBillboards(){this.indexArrayUpdateNeeded&&this.__updateIndexArray();const e=this.__gl;if(!this.__glshader){e.__quadVertexIdsBuffer||e.setupInstancedQuad(),this.__glshader=new Ti(e);const t=this.__glshader.compileForTarget("GLBillboardsPass",this.__renderer.getShaderPreproc());this.__shaderBinding=Ya(e,t.attrs,e.__quadattrbuffers,e.__quadIndexBuffer);}const t=()=>{if(this.__atlas.renderAtlas(),!e.floatTexturesSupported||!e.drawElementsInstanced)return this.__modelMatrixArray=[],this.__billboardDataArray=[],this.__tintColorArray=[],this.__indexArray.forEach(e=>{const t=this.__billboards[e],a=t.billboard,i=a.getGlobalXfo().toMat4(),s=a.getParameter("scale").getValue(),n=a.getParameter("flags").getValue(),l=a.getParameter("alpha").getValue(),r=a.getParameter("color").getValue();this.__modelMatrixArray[e]=i.asArray(),this.__billboardDataArray[e]=[s,n,t.imageIndex,l],this.__tintColorArray[e]=[r.r,r.g,r.b,r.a];}),void(this.__updateRequested=!1);let t=Math.round(Math.sqrt(5*(this.__billboards.length-this.__freeIndices.length))+.5);t%5!=0&&(t+=5-t%5),this.__width=t,this.__drawItemsTexture?this.__drawItemsTexture.resize(t,t):(this.__drawItemsTexture=new Fa(e,{format:"RGBA",type:"FLOAT",width:t,height:t,filter:"NEAREST",wrap:"CLAMP_TO_EDGE",mipMapped:!1}),this.__drawItemsTexture.clear()),this.__indexArray.forEach(e=>{-1!=e&&this.__updateBillboard(e);}),this.__updateRequested=!1;};this.__atlas.isLoaded()?t():this.__atlas.loaded.connect(t);}__updateBillboard(e){if(0==this.__drawCount||!this.__drawItemsTexture)return;const t=this.__billboards[e];if(!t.billboard.getVisible())return;const a=this.__gl,i=new Float32Array(20);this.__populateBillboardDataArray(t,0,i),a.bindTexture(a.TEXTURE_2D,this.__drawItemsTexture.glTex);const s=5*e%this.__width,n=Math.floor(5*e/this.__width),l=this.__drawItemsTexture.getType(),r=this.__drawItemsTexture.getFormat();if("FLOAT"==l)a.texSubImage2D(a.TEXTURE_2D,0,s,n,5,1,a[r],a[l],i);else {const e=Math.convertFloat32ArrayToUInt16Array(i);a.texSubImage2D(a.TEXTURE_2D,0,s,n,5,1,a[r],a[l],e);}}sort(e){for(const t of this.__billboards)t&&t.billboard.getVisible()&&(t.dist=t.billboard.getGlobalXfo().tr.distanceTo(e));this.__indexArray.sort((e,t)=>-1==e?1:-1==t||this.__billboards[e].dist>this.__billboards[t].dist?-1:this.__billboards[e].dist<this.__billboards[t].dist?1:0);const t=this.__gl;t.floatTexturesSupported&&this.__instanceIdsBuffer&&(t.bindBuffer(t.ARRAY_BUFFER,this.__instanceIdsBuffer),t.bufferData(t.ARRAY_BUFFER,this.__indexArray,t.STATIC_DRAW));}draw(e){if(0==this.__drawCount||!this.__atlas.isReady()||this.__updateRequested)return;this.indexArrayUpdateNeeded&&this.__updateIndexArray();const t=this.__gl;t.disable(t.CULL_FACE),t.enable(t.BLEND),t.blendEquation(t.FUNC_ADD),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA);const a=e.viewXfo.tr;if(a.distanceTo(this.__prevSortCameraPos)>this.__threshold)if(this.sort(a),this.__prevSortCameraPos=a.clone(),this.__drawCount>1){const e=this.__billboards[this.__indexArray[0]].billboard.getGlobalXfo().tr,t=this.__billboards[this.__indexArray[1]].billboard.getGlobalXfo().tr;this.__threshold=e.distanceTo(t);}else this.__threshold=9999;this.__glshader.bind(e),this.__shaderBinding.bind(e);const i=e.unifs;if(this.__atlas.bindToUniform(e,i.atlasBillboards),t.floatTexturesSupported&&t.drawElementsInstanced){this.__drawItemsTexture.bindToUniform(e,i.instancesTexture),t.uniform1i(i.instancesTextureSize.location,this.__width);{const a=e.attrs.instanceIds.location;t.enableVertexAttribArray(a),t.bindBuffer(t.ARRAY_BUFFER,this.__instanceIdsBuffer),t.vertexAttribPointer(a,1,t.FLOAT,!1,4,0),t.vertexAttribDivisor(a,1);}e.bindViewports(i,()=>{t.drawElementsInstanced(t.TRIANGLES,6,t.UNSIGNED_SHORT,0,this.__drawCount);});}else {const a=this.__indexArray.length;for(let s=0;s<a;s++)t.uniformMatrix4fv(i.modelMatrix.location,!1,this.__modelMatrixArray[s]),t.uniform4fv(i.billboardData.location,this.__billboardDataArray[s]),t.uniform4fv(i.tintColor.location,this.__tintColorArray[s]),t.uniform4fv(i.layoutData.location,this.__atlas.getLayoutData(this.__billboards[s].imageIndex)),e.bindViewports(i,()=>{t.drawQuad();});}t.disable(t.BLEND);}}Fi.registerPass(Zs,Wi.TRANSPARENT);class Gs extends gs{constructor(){super();}init(e,t){super.init(e,t);}filterGeomItem(e){if(e.isOverlay())return !0;const t=e.getMaterial().getShaderClass();return !(!t||!t.isOverlay())}draw(e){this.newItemsReadyForLoading()&&this.finalize();const t=this.__gl;t.clear(t.DEPTH_BUFFER_BIT),t.enable(t.CULL_FACE),t.cullFace(t.BACK),t.enable(t.BLEND),t.blendEquation(t.FUNC_ADD),e.pass="ADD",t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),this.__traverseTreeAndDraw(e),t.disable(t.BLEND);}drawGeomData(e){const t=this.__gl;t.clear(t.DEPTH_BUFFER_BIT),t.enable(t.BLEND),t.blendEquation(t.FUNC_ADD),e.pass="ADD",t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),super.drawGeomData(e),t.disable(t.BLEND),t.enable(t.DEPTH_TEST);}}Fi.registerPass(Gs,Wi.OVERLAY);const Xs=window.AudioContext||window.webkitAudioContext||!1;Xs?exports.audioCtx=new Xs:alert("Sorry, but the Web Audio API is not supported by your browser. Please, consider upgrading to the latest version or downloading Google Chrome or Mozilla Firefox");class ys extends Li{constructor(){super(),this.__audioItems=[];}init(e,t){super.init(e,t),exports.audioCtx&&this.__renderer.registerPass(e=>{if(e instanceof ta)return e.audioSourceCreated.connect(t=>{this.addAudioSource(e,t,e);}),!0;if(e instanceof sa){const t=e.getMaterial();if(t){const a=t.getParameter("BaseColor");if(a&&a.getImage&&a.getImage()){const t=a.getImage();t.loaded.connect(()=>{if(t.getAudioSource){const a=t.getAudioSource();(a instanceof HTMLMediaElement||a instanceof AudioBufferSourceNode)&&this.addAudioSource(e,a,t);}});}}return !1}},e=>{});}addAudioSource(e,t,a){if(t.addedToCollector)return;let i;i=t instanceof HTMLMediaElement?exports.audioCtx.createMediaElementSource(t):t instanceof AudioBufferSourceNode?t:exports.audioCtx.createMediaStreamSource(t);const s=exports.audioCtx.createGain(),n=a.getParameter("Gain");var l,r;n&&(l=n,r=s.gain,l&&(r.setValueAtTime(l.getValue(),0),r.setValueAtTime(l.getValue(),5),l.valueChanged.connect(()=>{r.value=l.getValue();}))),i.connect(s);const o=a.getParameter("SpatializeAudio");if(o&&0==o.getValue())i.connect(exports.audioCtx.destination);else {const t=exports.audioCtx.createPanner();t.panningModel="HRTF",t.distanceModel="inverse",i.connect(t),t.connect(exports.audioCtx.destination);const s=e=>{const i=a.getParameter(e);i&&(t[e]=i.getValue(),i.valueChanged.connect(()=>{t[e]=i.getValue();}));};s("coneInnerAngle"),s("coneOuterAngle"),s("coneOuterGain");const n=()=>{let a;a=e instanceof sa?e.getGeomMat4():e.getGlobalXfo().toMat4();const i=a.translation;t.setPosition(i.x,i.y,i.z);const s=a.zAxis;t.setOrientation(s.x,s.y,s.z);};n(),e.globalXfoChanged.connect(e=>{n();});}t.addedToCollector=!0,this.__audioItems.push({treeItem:e,audioSource:t,parameterOwner:a}),this.updated.emit();}__updateListenerPosition(e){if(!exports.audioCtx)return;const t=exports.audioCtx.listener;t.setPosition(e.tr.x,e.tr.y,e.tr.z);const a=e.ori.getYaxis(),i=e.ori.getZaxis().negate();t.setOrientation(i.x,i.y,i.z,a.x,a.y,a.z);}draw(e){0!=this.__audioItems.length&&this.__updateListenerPosition(e.viewXfo);}}Fi.registerPass(ys,Wi.OVERLAY),window&&(window.ZeaAudioaudioCtx=exports.audioCtx);var fs=Object.freeze({__proto__:null,create3DContext:Ma,GLTexture2D:Fa,GLMesh:Ka,GLLines:wa,GLPoints:za,GLMaterial:$a,GLShader:Pa,GLFbo:Ha,GLRenderTarget:ei,GLRenderer:Fi,GLBaseViewport:Gi,GLViewport:Xi,shaderLibrary:Ja,generateShaderGeomBinding:Ya,BillboardShader:Ti,ConvolverShader:li,DepthMapShader:Ci,EnvMapShader:di,BackgroundImageShader:hi,OctahedralEnvMapShader:ci,LatLongEnvMapShader:mi,SterioLatLongEnvMapShader:ui,DualFishEyeEnvMapShader:bi,DualFishEyeToLatLongBackgroundShader:pi,EnvProjectionShader:Yi,OctahedralEnvProjectionShader:Ni,LatLongEnvProjectionShader:Ki,FatLinesShader:wi,FlatSurfaceShader:zi,FlatAlphaSurfaceShader:Ui,LayeredCarPaintShader:Ji,LinesShader:Ei,NormalsShader:Hi,PointsShader:ki,FatPointsShader:Bi,FatPointsGeomDataShader:Di,FatPointsSelectedShader:Oi,PostProcessing:Qi,ScreenQuadShader:_i,SimpleSurfaceShader:Ai,StandardSurfaceShader:ji,StandardSurfaceGeomDataShader:qi,StandardSurfaceSelectedGeomsShader:$i,HandleShader:es,HandleGeomDataShader:ts,TransparentSurfaceShader:as,ScreenSpaceShader:is,ToolIconShader:ss,UnpackHDRShader:Ea,UnpackLDRAlphaImageShader:ns,WireShader:ls,GLPass:Li,PassType:Wi,GLStandardGeomsPass:ms,GLOpaqueGeomsPass:gs,GLTransparentGeomsPass:_s,GLBillboardsPass:Zs,GLOverlayPass:Gs,GLAudioItemsPass:ys,get audioCtx(){return exports.audioCtx},VRViewport:Vi});class Vs{constructor(e){this.__name=e||this.constructor.name,this.__stateEvents=[],this.__activationActions=[],this.__deactivationActions=[];}getName(){return this.__name}setName(e){this.__name=e;}setStateMachine(e){this.__stateMachine=e;}getStateMachine(){return this.__stateMachine}activate(){this.__stateEvents.forEach(e=>{e.activate();}),this.__activationActions.forEach(e=>{e.activate();});}deactivate(){this.__stateEvents.forEach(e=>{e.deactivate();}),this.__deactivationActions.forEach(e=>{e.activate();});}addStateEvent(e){e.setState(this),this.__stateEvents.push(e);}getStateEvent(e){return this.__stateEvents[e]}addActivationAction(e){e.setState(this),this.__activationActions.push(e);}getActivationAction(e){return this.__activationActions[e]}addDeactivationAction(e){e.setState(this),this.__deactivationActions.push(e);}toJSON(e,t){const a={name:this.__name,type:this.constructor.name},i=[];for(const a of this.__stateEvents)i.push(a.toJSON(e,t));a.stateEvents=i;const s=[];for(const a of this.__activationActions)s.push(a.toJSON(e,t));a.activationActions=s;const n=[];for(const a of this.__deactivationActions)n.push(a.toJSON(e,t));return a.deactivationActions=n,a}fromJSON(e,t,a){this.__name=e.name;for(const a of e.stateEvents){const e=C.constructClass(a.type);e.fromJSON(a,t),this.addStateEvent(e);}for(const a of e.activationActions){const e=C.constructClass(a.type);e.fromJSON(a,t),this.addActivationAction(e);}for(const a of e.deactivationActions){const e=C.constructClass(a.type);e.fromJSON(a,t),this.addDeactivationAction(e);}}}C.registerClass("State",Vs);class xs extends H{constructor(e){super(),this.__name=e,this.__childActions=[],this.__outputs={};}addOutput(e){return this.__outputs[e.getName()]=e,e}getOutput(e){return this.__outputs[e]}setState(e){this.__state=e,this.__childActions.forEach(t=>{t.setState(e);});}addChild(e){this.__childActions.push(e),e.setState(this.__state);}getChild(e){return this.__childActions[e]}activate(){console.warn("activate must be implmented by each action. this:"+this.constructor.name);}addChild(e){this.__childActions.push(e),e.setState(this.__state);}deactivate(){}__onDone(){this.__childActions.forEach(e=>{e.activate();});}toJSON(e,t){let a=super.toJSON(e,t);a||(a={}),a.type=C.getClassName(this);const i=[];for(const a of this.__childActions)i.push(a.toJSON(e,t));a.childActions=i;const s={};for(const a in this.__outputs)s[a]=this.__outputs[a].toJSON(e,t);return a.outputs=s,a}fromJSON(e,t,a){super.fromJSON(e,t,a);for(const a of e.childActions){const e=C.constructClass(a.type);if(!e)throw new Error("Invalid type:"+a.type);e.fromJSON(a,t),this.addChild(e);}for(const a in e.outputs)this.__outputs[a].fromJSON(e.outputs[a],t);}destroy(){super.destroy(),this.__outputs=[];}}class Is extends xs{constructor(e){super(),this.__name=e,this.__onEvent=this.__onEvent.bind(this);}__onEvent(){this.__childActions.forEach(e=>{e.activate();});}}class Rs extends D{constructor(e){super(e),this.__states={},this.stateChanged=new S,this.setFlag(k.USER_EDITED),C.isConstructing()||C.invokeCallbacks(this);}addState(e){e.setStateMachine(this),this.__states[e.getName()]=e,1==Object.keys(this.__states).length&&null==this.__initialStateName&&(this.__initialStateName=e.getName());}getState(e){return this.__states[e]}activateState(e){if(!this.__states[e])throw new Error("Invalid state transtion:"+e);this.__currentState!=this.__states[e]&&(this.__currentState&&this.__currentState.deactivate(),this.__currentState=this.__states[e],this.__currentState.activate(),this.stateChanged.emit(e));}getActiveState(){return this.__currentState}getActiveStateName(){return this.__currentState.constructor.name}getInitialState(){return this.__initialStateName}setInitialState(e){this.__initialStateName=e;}toJSON(e,t){const a=super.toJSON(e,t);a.initialStateName=this.__initialStateName;const i={};for(const a in this.__states)i[a]=this.__states[a].toJSON(e,t);return a.states=i,a}fromJSON(e,t,a){super.fromJSON(e,t,a),this.__initialStateName=e.initialStateName,t.stateMachine=this;for(const a in e.states){const i=e.states[a],s=C.constructClass(i.type);if(!s)throw new Error("Invalid type:"+i.type);s.fromJSON(i,t),this.addState(s);}t.addPLCB(()=>{});}}C.registerClass("StateMachine",Rs);class Ss extends xs{constructor(){super(),this.__targetStateParam=this.addParameter(new xe("TargetState",""));}activate(){this.__state.getStateMachine().activateState(this.__targetStateParam.getValue());}}C.registerClass("SwitchState",Ss);class Ws extends xs{constructor(){super(),this.addParameter(new Le("Camera",e=>e instanceof ca)),this.addParameter(new _e("cameraPos")),this.addParameter(new _e("cameraTarget")),this.addParameter(new ue("interpTime",1)),this.addParameter(new ue("updateFrequency",30));}SetCameraPositionAndTarget(e,t){this.getParameter("cameraPos").setValue(e),this.getParameter("cameraTarget").setValue(t);}activate(){const e=this.getParameter("Camera").getValue();if(!e)return void console.warn("Camera not assigned to SetCameraPositionAndTarget state action");const t=this.getParameter("cameraPos").getValue(),a=this.getParameter("cameraTarget").getValue(),i=this.getParameter("interpTime").getValue();if(i>0){const s=e.getGlobalXfo().tr,n=e.getTargetPostion(),l=(s.subtract(n).length(),this.getParameter("updateFrequency").getValue()),r=t.subtract(a).length();let o=!0,d=0,h=0;const c=Math.round(i*l);let m=!1;const u=()=>{m||(o=!1);};e.globalXfoChanged.connect(u);const b=()=>{if(h++,h<c){const i=h/c,s=Math.smoothStep(0,1,i),n=(s-d)/(1-i);d=s;const u=e.getGlobalXfo().tr,p=e.getTargetPostion(),g=u.subtract(p).length();let _=u;const Z=p.lerp(a,n);o&&(_=u.lerp(t,n));const G=_.subtract(Z),X=(G.length(),Math.lerp(g,r,n));G.scaleInPlace(X/G.length()),m=!0,e.setPositionAndTarget(Z.add(G),Z),m=!1,this.__timeoutId=window.setTimeout(b,1e3/l);}else e.globalXfoChanged.disconnect(u),e.movementFinished.emit(),this.__timeoutId=void 0,this.__onDone();};b();}else e.setPositionAndTarget(t,a);}cancel(){this.__timeoutId&&(clearTimeout(this.__timeoutId),this.__timeoutId=void 0);}}C.registerClass("SetCameraPositionAndTarget",Ws);class Ls extends xs{constructor(){super(),this.__interpTimeParam=this.addParameter(new ue("InterpTime",1)),this.__updateFrequencyParam=this.addParameter(new ue("UpdateFrequency",30)),this.__outParam=this.addOutput(new Za("Param")),this.__outParam.paramSet.connect(()=>{if(!this.__valueParam||this.__outParam.getParam().getDataType()!=this.__valueParam.getDataType()){const e=this.__outParam.getParam().clone();e.setName("Value"),this.__outParam.getInitialValue?e.setValue(this.__outParam.getInitialValue()):e.setValue(this.__outParam.getParam().getValue()),this.__valueParam=this.addParameter(e);}});}activate(){if(this.__outParam.isConnected()){const e=this.__interpTimeParam.getValue();if(e>0){const t=this.__updateFrequencyParam.getValue(),a=this.__outParam.getValue(),i=this.__valueParam.getValue();let s=0;const n=Math.round(e/(1/t)),l=()=>{if(s++,s<n){const e=s/n,r=Math.smoothStep(0,1,e),o=Math.lerp(a,i,r);this.__outParam.setValue(o,N.GENERATED_VALUE),this.__timeoutId=window.setTimeout(l,1e3/t);}else this.__outParam.setValue(this.__valueParam.getValue(),N.GENERATED_VALUE),this.__timeoutId=void 0,this.__onDone();};l();}else this.__outParam.setValue(this.__valueParam.getValue(),N.GENERATED_VALUE),this.__onDone();}}cancel(){this.__timeoutId&&(clearTimeout(this.__timeoutId),this.__timeoutId=void 0);}toJSON(e,t){const a=super.toJSON(e,t);return this.__valueParam&&(a.valueParamType=this.__valueParam.constructor.name),a}fromJSON(e,t,a){if(e.valueParamType){const t=C.constructClass(e.valueParamType,"Value");t&&(this.__valueParam=this.addParameter(t));}super.fromJSON(e,t,a);}}C.registerClass("SetParameterValue",Ls);class vs extends Is{constructor(e){super(e),this.__geomParam=this.addParameter(new Le("TreeItem")),this.__geomParam.valueChanged.connect(()=>{this.__geom=this.__geomParam.getValue();});}__geomClicked(e){e.stopPropagation(),this.__onEvent();}activate(){this.__geom&&this.__geom.mouseDown.connect(this.__geomClicked.bind(this));}deactivate(){this.__geom&&this.__geom.mouseDown.disconnect(this.__geomClicked.bind(this));}}C.registerClass("GeomClicked",vs);class Ms extends Is{constructor(e){super(e),this.onKeyPressed=this.onKeyPressed.bind(this),this.__keyParam=this.addParameter(new xe("Key",""));}onKeyPressed(e){console.log(e.key),e.key==this.__keyParam.getValue()&&this.__onEvent();}activate(){document.addEventListener("keydown",this.onKeyPressed);}deactivate(){document.removeEventListener("keydown",this.onKeyPressed);}}C.registerClass("KeyPressedEvent",Ms);class Fs extends Is{constructor(e){super(e),this.__waitTimeParam=this.addParameter(new ue("WaitTime",1));}activate(){this.__timeoutId=window.setTimeout(()=>{delete this.__timeoutId,this.__onEvent();},1e3*this.__waitTimeParam.getValue());}deactivate(){this.__timeoutId&&window.clearTimeout(this.__timeoutId);}}C.registerClass("TimedWait",Fs);const Ts={onResize:e,...a,...R,...M,...va,...fs,...Object.freeze({__proto__:null,State:Vs,StateAction:xs,StateEvent:Is,StateMachine:Rs,SwitchState:Ss,SetCameraPositionAndTarget:Ws,SetParameterValue:Ls,GeomClicked:vs,KeyPressedEvent:Ms,TimedWait:Fs})};exports.AimOperator=Wa,exports.AssetItem=da,exports.Async=L,exports.AttrValue=l,exports.Attribute=St,exports.AudioItem=ta,exports.BackgroundImageShader=hi,exports.BaseGeom=Wt,exports.BaseGeomItem=ia,exports.BaseImage=Te,exports.BaseItem=D,exports.BaseParameter=J,exports.BillboardItem=ha,exports.BillboardShader=Ti,exports.BinReader=de,exports.BinWriter=he,exports.BooleanParameter=pe,exports.Box2=y,exports.Box3=V,exports.CalcGlobalXfoOperator=Xa,exports.Camera=ca,exports.CameraMouseAndKeyboard=La,exports.Circle=zt,exports.CloneFlags=qt,exports.CodeParameter=Ie,exports.Color=u,exports.ColorParameter=Ge,exports.Command=me,exports.Cone=Et,exports.ConvolverShader=li,exports.Cross=Ut,exports.Cuboid=Ht,exports.Cylinder=kt,exports.DataImage=we,exports.DepthMapShader=Ci,exports.Disc=Bt,exports.DualFishEyeEnvMapShader=bi,exports.DualFishEyeToLatLongBackgroundShader=pi,exports.EnvMap=Zt,exports.EnvMapShader=di,exports.EnvProjectionShader=Yi,exports.EulerAngles=p,exports.ExplodePartsOperator=fa,exports.FatLinesShader=wi,exports.FatPointsGeomDataShader=Di,exports.FatPointsSelectedShader=Oi,exports.FatPointsShader=Bi,exports.FileAudioItem=aa,exports.FileImage=it,exports.FileImage2D=st,exports.FilePathParameter=Re,exports.FlatAlphaSurfaceShader=Ui,exports.FlatSurfaceShader=zi,exports.Float32=6,exports.Frustum=I,exports.GIFImage=ot,exports.GLAudioItemsPass=ys,exports.GLBaseViewport=Gi,exports.GLBillboardsPass=Zs,exports.GLFbo=Ha,exports.GLLines=wa,exports.GLMaterial=$a,exports.GLMesh=Ka,exports.GLOpaqueGeomsPass=gs,exports.GLOverlayPass=Gs,exports.GLPass=Li,exports.GLPoints=za,exports.GLRenderTarget=ei,exports.GLRenderer=Fi,exports.GLShader=Pa,exports.GLStandardGeomsPass=ms,exports.GLTexture2D=Fa,exports.GLTransparentGeomsPass=_s,exports.GLViewport=Xi,exports.GearsOperator=xa,exports.GeomClicked=vs,exports.GeomItem=sa,exports.GeomLibrary=oa,exports.GeometryParameter=Fe,exports.Grid=Pt,exports.Group=la,exports.GrowingPacker=W,exports.HandleGeomDataShader=ts,exports.HandleShader=es,exports.ImageParameter=Ve,exports.InstanceItem=ea,exports.ItemFlags=k,exports.ItemSetParameter=ve,exports.JSON_stringify_fixedPrecision=n,exports.KeyPressedEvent=Ms,exports.LDRImage=lt,exports.LDRVideo=rt,exports.Label=ft,exports.LatLongEnvMapShader=mi,exports.LatLongEnvProjectionShader=Ki,exports.LayeredCarPaintShader=Ji,exports.Lightmap=Gt,exports.LightmapMixer=Xt,exports.Lines=Mt,exports.LinesCuboid=Jt,exports.LinesProxy=Yt,exports.LinesShader=Ei,exports.ListParameter=Se,exports.LoadFlags=jt,exports.Mat3=g,exports.Mat3Parameter=Xe,exports.Mat4=_,exports.Mat4Parameter=ye,exports.Material=Ke,exports.MaterialColorParam=Ye,exports.MaterialFloatParam=Ce,exports.MaterialLibrary=xt,exports.MaterialParameter=Rt,exports.Mesh=Ft,exports.MeshProxy=Nt,exports.MultiChoiceParameter=be,exports.NormalsShader=Hi,exports.NumberParameter=ue,exports.ObjAsset=ga,exports.OctahedralEnvMapShader=ci,exports.OctahedralEnvProjectionShader=Ni,exports.Operator=_a,exports.OperatorOutput=Za,exports.ParamFlags=K,exports.Parameter=P,exports.ParameterOwner=H,exports.PassType=Wi,exports.PistonOperator=Ra,exports.Plane=Dt,exports.PlaneType=x,exports.PointGrid=Kt,exports.Points=vt,exports.PointsProxy=Ct,exports.PointsShader=ki,exports.PostProcessing=Qi,exports.ProxyParameter=Me,exports.Quat=Z,exports.RGBA=m,exports.Ray=G,exports.Rect=wt,exports.RefCounted=T,exports.RouterOperator=Sa,exports.SAVE_FLAG_SKIP_GEOMDATA=1024,exports.SInt16=3,exports.SInt32=5,exports.SInt8=1,exports.SaveFlags=At,exports.Scene=pa,exports.ScreenQuadShader=_i,exports.ScreenSpaceShader=is,exports.SetCameraPositionAndTarget=Ws,exports.SetParameterValue=Ls,exports.Signal=S,exports.SimpleSurfaceShader=Ai,exports.Sphere=Ot,exports.SphereType=f,exports.StandardSurfaceGeomDataShader=qi,exports.StandardSurfaceSelectedGeomsShader=$i,exports.StandardSurfaceShader=ji,exports.State=Vs,exports.StateAction=xs,exports.StateEvent=Is,exports.StateMachine=Rs,exports.SterioLatLongEnvMapShader=ui,exports.StringParameter=xe,exports.StructParameter=We,exports.SwitchState=Ss,exports.SystemDesc=t,exports.TimedWait=Fs,exports.ToolIconShader=ss,exports.Torus=Qt,exports.TransparentSurfaceShader=as,exports.TreeItem=$t,exports.TreeItemParameter=Le,exports.UInt16=2,exports.UInt32=4,exports.UInt8=0,exports.UnpackHDRShader=Ea,exports.UnpackLDRAlphaImageShader=ns,exports.VLAAsset=ua,exports.VRViewport=Vi,exports.ValueGetMode=Y,exports.ValueSetMode=N,exports.Vec2=o,exports.Vec2Parameter=ge,exports.Vec3=d,exports.Vec3Parameter=_e,exports.Vec4=h,exports.Vec4Parameter=Ze,exports.Version=oe,exports.VertexAttribute=Lt,exports.VideoStreamImage2D=Vt,exports.WireShader=ls,exports.Xfo=X,exports.XfoOperatorOutput=Ga,exports.XfoParameter=fe,exports.create3DContext=Ma,exports.decodeText=v,exports.default=Ts,exports.generateShaderGeomBinding=Ya,exports.getFileFolder=O,exports.hashStr=s,exports.isObject=ne,exports.labelManager=yt,exports.loadBinfile=ee,exports.loadJSONfile=q,exports.loadTextfile=A,exports.loadXMLfile=$,exports.materialLibraryManager=It,exports.mergeDeep=le,exports.onResize=e,exports.resourceLoader=re,exports.sgFactory=C,exports.shaderLibrary=Ja,exports.typeRegistry=r;
});

/**
 * Parses an URI
 *
 * @author Steven Levithan <stevenlevithan.com> (MIT license)
 * @api private
 */

var re = /^(?:(?![^:@]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/;

var parts = [
    'source', 'protocol', 'authority', 'userInfo', 'user', 'password', 'host', 'port', 'relative', 'path', 'directory', 'file', 'query', 'anchor'
];

var parseuri = function parseuri(str) {
    var src = str,
        b = str.indexOf('['),
        e = str.indexOf(']');

    if (b != -1 && e != -1) {
        str = str.substring(0, b) + str.substring(b, e).replace(/:/g, ';') + str.substring(e, str.length);
    }

    var m = re.exec(str || ''),
        uri = {},
        i = 14;

    while (i--) {
        uri[parts[i]] = m[i] || '';
    }

    if (b != -1 && e != -1) {
        uri.source = src;
        uri.host = uri.host.substring(1, uri.host.length - 1).replace(/;/g, ':');
        uri.authority = uri.authority.replace('[', '').replace(']', '').replace(/;/g, ':');
        uri.ipv6uri = true;
    }

    return uri;
};

/**
 * Helpers.
 */

var s = 1000;
var m = s * 60;
var h = m * 60;
var d = h * 24;
var w = d * 7;
var y = d * 365.25;

/**
 * Parse or format the given `val`.
 *
 * Options:
 *
 *  - `long` verbose formatting [false]
 *
 * @param {String|Number} val
 * @param {Object} [options]
 * @throws {Error} throw an error if val is not a non-empty string or a number
 * @return {String|Number}
 * @api public
 */

var ms = function(val, options) {
  options = options || {};
  var type = typeof val;
  if (type === 'string' && val.length > 0) {
    return parse(val);
  } else if (type === 'number' && isFinite(val)) {
    return options.long ? fmtLong(val) : fmtShort(val);
  }
  throw new Error(
    'val is not a non-empty string or a valid number. val=' +
      JSON.stringify(val)
  );
};

/**
 * Parse the given `str` and return milliseconds.
 *
 * @param {String} str
 * @return {Number}
 * @api private
 */

function parse(str) {
  str = String(str);
  if (str.length > 100) {
    return;
  }
  var match = /^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(
    str
  );
  if (!match) {
    return;
  }
  var n = parseFloat(match[1]);
  var type = (match[2] || 'ms').toLowerCase();
  switch (type) {
    case 'years':
    case 'year':
    case 'yrs':
    case 'yr':
    case 'y':
      return n * y;
    case 'weeks':
    case 'week':
    case 'w':
      return n * w;
    case 'days':
    case 'day':
    case 'd':
      return n * d;
    case 'hours':
    case 'hour':
    case 'hrs':
    case 'hr':
    case 'h':
      return n * h;
    case 'minutes':
    case 'minute':
    case 'mins':
    case 'min':
    case 'm':
      return n * m;
    case 'seconds':
    case 'second':
    case 'secs':
    case 'sec':
    case 's':
      return n * s;
    case 'milliseconds':
    case 'millisecond':
    case 'msecs':
    case 'msec':
    case 'ms':
      return n;
    default:
      return undefined;
  }
}

/**
 * Short format for `ms`.
 *
 * @param {Number} ms
 * @return {String}
 * @api private
 */

function fmtShort(ms) {
  var msAbs = Math.abs(ms);
  if (msAbs >= d) {
    return Math.round(ms / d) + 'd';
  }
  if (msAbs >= h) {
    return Math.round(ms / h) + 'h';
  }
  if (msAbs >= m) {
    return Math.round(ms / m) + 'm';
  }
  if (msAbs >= s) {
    return Math.round(ms / s) + 's';
  }
  return ms + 'ms';
}

/**
 * Long format for `ms`.
 *
 * @param {Number} ms
 * @return {String}
 * @api private
 */

function fmtLong(ms) {
  var msAbs = Math.abs(ms);
  if (msAbs >= d) {
    return plural(ms, msAbs, d, 'day');
  }
  if (msAbs >= h) {
    return plural(ms, msAbs, h, 'hour');
  }
  if (msAbs >= m) {
    return plural(ms, msAbs, m, 'minute');
  }
  if (msAbs >= s) {
    return plural(ms, msAbs, s, 'second');
  }
  return ms + ' ms';
}

/**
 * Pluralization helper.
 */

function plural(ms, msAbs, n, name) {
  var isPlural = msAbs >= n * 1.5;
  return Math.round(ms / n) + ' ' + name + (isPlural ? 's' : '');
}

/**
 * This is the common logic for both the Node.js and web browser
 * implementations of `debug()`.
 */

function setup(env) {
	createDebug.debug = createDebug;
	createDebug.default = createDebug;
	createDebug.coerce = coerce;
	createDebug.disable = disable;
	createDebug.enable = enable;
	createDebug.enabled = enabled;
	createDebug.humanize = ms;

	Object.keys(env).forEach(key => {
		createDebug[key] = env[key];
	});

	/**
	* Active `debug` instances.
	*/
	createDebug.instances = [];

	/**
	* The currently active debug mode names, and names to skip.
	*/

	createDebug.names = [];
	createDebug.skips = [];

	/**
	* Map of special "%n" handling functions, for the debug "format" argument.
	*
	* Valid key names are a single, lower or upper-case letter, i.e. "n" and "N".
	*/
	createDebug.formatters = {};

	/**
	* Selects a color for a debug namespace
	* @param {String} namespace The namespace string for the for the debug instance to be colored
	* @return {Number|String} An ANSI color code for the given namespace
	* @api private
	*/
	function selectColor(namespace) {
		let hash = 0;

		for (let i = 0; i < namespace.length; i++) {
			hash = ((hash << 5) - hash) + namespace.charCodeAt(i);
			hash |= 0; // Convert to 32bit integer
		}

		return createDebug.colors[Math.abs(hash) % createDebug.colors.length];
	}
	createDebug.selectColor = selectColor;

	/**
	* Create a debugger with the given `namespace`.
	*
	* @param {String} namespace
	* @return {Function}
	* @api public
	*/
	function createDebug(namespace) {
		let prevTime;

		function debug(...args) {
			// Disabled?
			if (!debug.enabled) {
				return;
			}

			const self = debug;

			// Set `diff` timestamp
			const curr = Number(new Date());
			const ms = curr - (prevTime || curr);
			self.diff = ms;
			self.prev = prevTime;
			self.curr = curr;
			prevTime = curr;

			args[0] = createDebug.coerce(args[0]);

			if (typeof args[0] !== 'string') {
				// Anything else let's inspect with %O
				args.unshift('%O');
			}

			// Apply any `formatters` transformations
			let index = 0;
			args[0] = args[0].replace(/%([a-zA-Z%])/g, (match, format) => {
				// If we encounter an escaped % then don't increase the array index
				if (match === '%%') {
					return match;
				}
				index++;
				const formatter = createDebug.formatters[format];
				if (typeof formatter === 'function') {
					const val = args[index];
					match = formatter.call(self, val);

					// Now we need to remove `args[index]` since it's inlined in the `format`
					args.splice(index, 1);
					index--;
				}
				return match;
			});

			// Apply env-specific formatting (colors, etc.)
			createDebug.formatArgs.call(self, args);

			const logFn = self.log || createDebug.log;
			logFn.apply(self, args);
		}

		debug.namespace = namespace;
		debug.enabled = createDebug.enabled(namespace);
		debug.useColors = createDebug.useColors();
		debug.color = selectColor(namespace);
		debug.destroy = destroy;
		debug.extend = extend;
		// Debug.formatArgs = formatArgs;
		// debug.rawLog = rawLog;

		// env-specific initialization logic for debug instances
		if (typeof createDebug.init === 'function') {
			createDebug.init(debug);
		}

		createDebug.instances.push(debug);

		return debug;
	}

	function destroy() {
		const index = createDebug.instances.indexOf(this);
		if (index !== -1) {
			createDebug.instances.splice(index, 1);
			return true;
		}
		return false;
	}

	function extend(namespace, delimiter) {
		const newDebug = createDebug(this.namespace + (typeof delimiter === 'undefined' ? ':' : delimiter) + namespace);
		newDebug.log = this.log;
		return newDebug;
	}

	/**
	* Enables a debug mode by namespaces. This can include modes
	* separated by a colon and wildcards.
	*
	* @param {String} namespaces
	* @api public
	*/
	function enable(namespaces) {
		createDebug.save(namespaces);

		createDebug.names = [];
		createDebug.skips = [];

		let i;
		const split = (typeof namespaces === 'string' ? namespaces : '').split(/[\s,]+/);
		const len = split.length;

		for (i = 0; i < len; i++) {
			if (!split[i]) {
				// ignore empty strings
				continue;
			}

			namespaces = split[i].replace(/\*/g, '.*?');

			if (namespaces[0] === '-') {
				createDebug.skips.push(new RegExp('^' + namespaces.substr(1) + '$'));
			} else {
				createDebug.names.push(new RegExp('^' + namespaces + '$'));
			}
		}

		for (i = 0; i < createDebug.instances.length; i++) {
			const instance = createDebug.instances[i];
			instance.enabled = createDebug.enabled(instance.namespace);
		}
	}

	/**
	* Disable debug output.
	*
	* @return {String} namespaces
	* @api public
	*/
	function disable() {
		const namespaces = [
			...createDebug.names.map(toNamespace),
			...createDebug.skips.map(toNamespace).map(namespace => '-' + namespace)
		].join(',');
		createDebug.enable('');
		return namespaces;
	}

	/**
	* Returns true if the given mode name is enabled, false otherwise.
	*
	* @param {String} name
	* @return {Boolean}
	* @api public
	*/
	function enabled(name) {
		if (name[name.length - 1] === '*') {
			return true;
		}

		let i;
		let len;

		for (i = 0, len = createDebug.skips.length; i < len; i++) {
			if (createDebug.skips[i].test(name)) {
				return false;
			}
		}

		for (i = 0, len = createDebug.names.length; i < len; i++) {
			if (createDebug.names[i].test(name)) {
				return true;
			}
		}

		return false;
	}

	/**
	* Convert regexp to namespace
	*
	* @param {RegExp} regxep
	* @return {String} namespace
	* @api private
	*/
	function toNamespace(regexp) {
		return regexp.toString()
			.substring(2, regexp.toString().length - 2)
			.replace(/\.\*\?$/, '*');
	}

	/**
	* Coerce `val`.
	*
	* @param {Mixed} val
	* @return {Mixed}
	* @api private
	*/
	function coerce(val) {
		if (val instanceof Error) {
			return val.stack || val.message;
		}
		return val;
	}

	createDebug.enable(createDebug.load());

	return createDebug;
}

var common = setup;

var browser = _commonjsHelpers.createCommonjsModule(function (module, exports) {
/* eslint-env browser */

/**
 * This is the web browser implementation of `debug()`.
 */

exports.log = log;
exports.formatArgs = formatArgs;
exports.save = save;
exports.load = load;
exports.useColors = useColors;
exports.storage = localstorage();

/**
 * Colors.
 */

exports.colors = [
	'#0000CC',
	'#0000FF',
	'#0033CC',
	'#0033FF',
	'#0066CC',
	'#0066FF',
	'#0099CC',
	'#0099FF',
	'#00CC00',
	'#00CC33',
	'#00CC66',
	'#00CC99',
	'#00CCCC',
	'#00CCFF',
	'#3300CC',
	'#3300FF',
	'#3333CC',
	'#3333FF',
	'#3366CC',
	'#3366FF',
	'#3399CC',
	'#3399FF',
	'#33CC00',
	'#33CC33',
	'#33CC66',
	'#33CC99',
	'#33CCCC',
	'#33CCFF',
	'#6600CC',
	'#6600FF',
	'#6633CC',
	'#6633FF',
	'#66CC00',
	'#66CC33',
	'#9900CC',
	'#9900FF',
	'#9933CC',
	'#9933FF',
	'#99CC00',
	'#99CC33',
	'#CC0000',
	'#CC0033',
	'#CC0066',
	'#CC0099',
	'#CC00CC',
	'#CC00FF',
	'#CC3300',
	'#CC3333',
	'#CC3366',
	'#CC3399',
	'#CC33CC',
	'#CC33FF',
	'#CC6600',
	'#CC6633',
	'#CC9900',
	'#CC9933',
	'#CCCC00',
	'#CCCC33',
	'#FF0000',
	'#FF0033',
	'#FF0066',
	'#FF0099',
	'#FF00CC',
	'#FF00FF',
	'#FF3300',
	'#FF3333',
	'#FF3366',
	'#FF3399',
	'#FF33CC',
	'#FF33FF',
	'#FF6600',
	'#FF6633',
	'#FF9900',
	'#FF9933',
	'#FFCC00',
	'#FFCC33'
];

/**
 * Currently only WebKit-based Web Inspectors, Firefox >= v31,
 * and the Firebug extension (any Firefox version) are known
 * to support "%c" CSS customizations.
 *
 * TODO: add a `localStorage` variable to explicitly enable/disable colors
 */

// eslint-disable-next-line complexity
function useColors() {
	// NB: In an Electron preload script, document will be defined but not fully
	// initialized. Since we know we're in Chrome, we'll just detect this case
	// explicitly
	if (typeof window !== 'undefined' && window.process && (window.process.type === 'renderer' || window.process.__nwjs)) {
		return true;
	}

	// Internet Explorer and Edge do not support colors.
	if (typeof navigator !== 'undefined' && navigator.userAgent && navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/)) {
		return false;
	}

	// Is webkit? http://stackoverflow.com/a/16459606/376773
	// document is undefined in react-native: https://github.com/facebook/react-native/pull/1632
	return (typeof document !== 'undefined' && document.documentElement && document.documentElement.style && document.documentElement.style.WebkitAppearance) ||
		// Is firebug? http://stackoverflow.com/a/398120/376773
		(typeof window !== 'undefined' && window.console && (window.console.firebug || (window.console.exception && window.console.table))) ||
		// Is firefox >= v31?
		// https://developer.mozilla.org/en-US/docs/Tools/Web_Console#Styling_messages
		(typeof navigator !== 'undefined' && navigator.userAgent && navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/) && parseInt(RegExp.$1, 10) >= 31) ||
		// Double check webkit in userAgent just in case we are in a worker
		(typeof navigator !== 'undefined' && navigator.userAgent && navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/));
}

/**
 * Colorize log arguments if enabled.
 *
 * @api public
 */

function formatArgs(args) {
	args[0] = (this.useColors ? '%c' : '') +
		this.namespace +
		(this.useColors ? ' %c' : ' ') +
		args[0] +
		(this.useColors ? '%c ' : ' ') +
		'+' + module.exports.humanize(this.diff);

	if (!this.useColors) {
		return;
	}

	const c = 'color: ' + this.color;
	args.splice(1, 0, c, 'color: inherit');

	// The final "%c" is somewhat tricky, because there could be other
	// arguments passed either before or after the %c, so we need to
	// figure out the correct index to insert the CSS into
	let index = 0;
	let lastC = 0;
	args[0].replace(/%[a-zA-Z%]/g, match => {
		if (match === '%%') {
			return;
		}
		index++;
		if (match === '%c') {
			// We only are interested in the *last* %c
			// (the user may have provided their own)
			lastC = index;
		}
	});

	args.splice(lastC, 0, c);
}

/**
 * Invokes `console.log()` when available.
 * No-op when `console.log` is not a "function".
 *
 * @api public
 */
function log(...args) {
	// This hackery is required for IE8/9, where
	// the `console.log` function doesn't have 'apply'
	return typeof console === 'object' &&
		console.log &&
		console.log(...args);
}

/**
 * Save `namespaces`.
 *
 * @param {String} namespaces
 * @api private
 */
function save(namespaces) {
	try {
		if (namespaces) {
			exports.storage.setItem('debug', namespaces);
		} else {
			exports.storage.removeItem('debug');
		}
	} catch (error) {
		// Swallow
		// XXX (@Qix-) should we be logging these?
	}
}

/**
 * Load `namespaces`.
 *
 * @return {String} returns the previously persisted debug modes
 * @api private
 */
function load() {
	let r;
	try {
		r = exports.storage.getItem('debug');
	} catch (error) {
		// Swallow
		// XXX (@Qix-) should we be logging these?
	}

	// If debug isn't set in LS, and we're in Electron, try to load $DEBUG
	if (!r && typeof process !== 'undefined' && 'env' in process) {
		r = process.env.DEBUG;
	}

	return r;
}

/**
 * Localstorage attempts to return the localstorage.
 *
 * This is necessary because safari throws
 * when a user disables cookies/localstorage
 * and you attempt to access it.
 *
 * @return {LocalStorage}
 * @api private
 */

function localstorage() {
	try {
		// TVMLKit (Apple TV JS Runtime) does not have a window object, just localStorage in the global context
		// The Browser also has localStorage in the global context.
		return localStorage;
	} catch (error) {
		// Swallow
		// XXX (@Qix-) should we be logging these?
	}
}

module.exports = common(exports);

const {formatters} = module.exports;

/**
 * Map %j to `JSON.stringify()`, since no Web Inspectors do that by default.
 */

formatters.j = function (v) {
	try {
		return JSON.stringify(v);
	} catch (error) {
		return '[UnexpectedJSONParseError]: ' + error.message;
	}
};
});

/**
 * Module dependencies.
 */


var debug = browser('socket.io-client:url');

/**
 * Module exports.
 */

var url_1 = url;

/**
 * URL parser.
 *
 * @param {String} url
 * @param {Object} An object meant to mimic window.location.
 *                 Defaults to window.location.
 * @api public
 */

function url (uri, loc) {
  var obj = uri;

  // default to window.location
  loc = loc || (typeof location !== 'undefined' && location);
  if (null == uri) uri = loc.protocol + '//' + loc.host;

  // relative path support
  if ('string' === typeof uri) {
    if ('/' === uri.charAt(0)) {
      if ('/' === uri.charAt(1)) {
        uri = loc.protocol + uri;
      } else {
        uri = loc.host + uri;
      }
    }

    if (!/^(https?|wss?):\/\//.test(uri)) {
      debug('protocol-less url %s', uri);
      if ('undefined' !== typeof loc) {
        uri = loc.protocol + '//' + uri;
      } else {
        uri = 'https://' + uri;
      }
    }

    // parse
    debug('parse %s', uri);
    obj = parseuri(uri);
  }

  // make sure we treat `localhost:80` and `localhost` equally
  if (!obj.port) {
    if (/^(http|ws)$/.test(obj.protocol)) {
      obj.port = '80';
    } else if (/^(http|ws)s$/.test(obj.protocol)) {
      obj.port = '443';
    }
  }

  obj.path = obj.path || '/';

  var ipv6 = obj.host.indexOf(':') !== -1;
  var host = ipv6 ? '[' + obj.host + ']' : obj.host;

  // define unique id
  obj.id = obj.protocol + '://' + host + ':' + obj.port;
  // define href
  obj.href = obj.protocol + '://' + host + (loc && loc.port === obj.port ? '' : (':' + obj.port));

  return obj;
}

/**
 * Helpers.
 */

var s$1 = 1000;
var m$1 = s$1 * 60;
var h$1 = m$1 * 60;
var d$1 = h$1 * 24;
var y$1 = d$1 * 365.25;

/**
 * Parse or format the given `val`.
 *
 * Options:
 *
 *  - `long` verbose formatting [false]
 *
 * @param {String|Number} val
 * @param {Object} [options]
 * @throws {Error} throw an error if val is not a non-empty string or a number
 * @return {String|Number}
 * @api public
 */

var ms$1 = function(val, options) {
  options = options || {};
  var type = typeof val;
  if (type === 'string' && val.length > 0) {
    return parse$1(val);
  } else if (type === 'number' && isNaN(val) === false) {
    return options.long ? fmtLong$1(val) : fmtShort$1(val);
  }
  throw new Error(
    'val is not a non-empty string or a valid number. val=' +
      JSON.stringify(val)
  );
};

/**
 * Parse the given `str` and return milliseconds.
 *
 * @param {String} str
 * @return {Number}
 * @api private
 */

function parse$1(str) {
  str = String(str);
  if (str.length > 100) {
    return;
  }
  var match = /^((?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|years?|yrs?|y)?$/i.exec(
    str
  );
  if (!match) {
    return;
  }
  var n = parseFloat(match[1]);
  var type = (match[2] || 'ms').toLowerCase();
  switch (type) {
    case 'years':
    case 'year':
    case 'yrs':
    case 'yr':
    case 'y':
      return n * y$1;
    case 'days':
    case 'day':
    case 'd':
      return n * d$1;
    case 'hours':
    case 'hour':
    case 'hrs':
    case 'hr':
    case 'h':
      return n * h$1;
    case 'minutes':
    case 'minute':
    case 'mins':
    case 'min':
    case 'm':
      return n * m$1;
    case 'seconds':
    case 'second':
    case 'secs':
    case 'sec':
    case 's':
      return n * s$1;
    case 'milliseconds':
    case 'millisecond':
    case 'msecs':
    case 'msec':
    case 'ms':
      return n;
    default:
      return undefined;
  }
}

/**
 * Short format for `ms`.
 *
 * @param {Number} ms
 * @return {String}
 * @api private
 */

function fmtShort$1(ms) {
  if (ms >= d$1) {
    return Math.round(ms / d$1) + 'd';
  }
  if (ms >= h$1) {
    return Math.round(ms / h$1) + 'h';
  }
  if (ms >= m$1) {
    return Math.round(ms / m$1) + 'm';
  }
  if (ms >= s$1) {
    return Math.round(ms / s$1) + 's';
  }
  return ms + 'ms';
}

/**
 * Long format for `ms`.
 *
 * @param {Number} ms
 * @return {String}
 * @api private
 */

function fmtLong$1(ms) {
  return plural$1(ms, d$1, 'day') ||
    plural$1(ms, h$1, 'hour') ||
    plural$1(ms, m$1, 'minute') ||
    plural$1(ms, s$1, 'second') ||
    ms + ' ms';
}

/**
 * Pluralization helper.
 */

function plural$1(ms, n, name) {
  if (ms < n) {
    return;
  }
  if (ms < n * 1.5) {
    return Math.floor(ms / n) + ' ' + name;
  }
  return Math.ceil(ms / n) + ' ' + name + 's';
}

var debug$1 = _commonjsHelpers.createCommonjsModule(function (module, exports) {
/**
 * This is the common logic for both the Node.js and web browser
 * implementations of `debug()`.
 *
 * Expose `debug()` as the module.
 */

exports = module.exports = createDebug.debug = createDebug['default'] = createDebug;
exports.coerce = coerce;
exports.disable = disable;
exports.enable = enable;
exports.enabled = enabled;
exports.humanize = ms$1;

/**
 * Active `debug` instances.
 */
exports.instances = [];

/**
 * The currently active debug mode names, and names to skip.
 */

exports.names = [];
exports.skips = [];

/**
 * Map of special "%n" handling functions, for the debug "format" argument.
 *
 * Valid key names are a single, lower or upper-case letter, i.e. "n" and "N".
 */

exports.formatters = {};

/**
 * Select a color.
 * @param {String} namespace
 * @return {Number}
 * @api private
 */

function selectColor(namespace) {
  var hash = 0, i;

  for (i in namespace) {
    hash  = ((hash << 5) - hash) + namespace.charCodeAt(i);
    hash |= 0; // Convert to 32bit integer
  }

  return exports.colors[Math.abs(hash) % exports.colors.length];
}

/**
 * Create a debugger with the given `namespace`.
 *
 * @param {String} namespace
 * @return {Function}
 * @api public
 */

function createDebug(namespace) {

  var prevTime;

  function debug() {
    // disabled?
    if (!debug.enabled) return;

    var self = debug;

    // set `diff` timestamp
    var curr = +new Date();
    var ms = curr - (prevTime || curr);
    self.diff = ms;
    self.prev = prevTime;
    self.curr = curr;
    prevTime = curr;

    // turn the `arguments` into a proper Array
    var args = new Array(arguments.length);
    for (var i = 0; i < args.length; i++) {
      args[i] = arguments[i];
    }

    args[0] = exports.coerce(args[0]);

    if ('string' !== typeof args[0]) {
      // anything else let's inspect with %O
      args.unshift('%O');
    }

    // apply any `formatters` transformations
    var index = 0;
    args[0] = args[0].replace(/%([a-zA-Z%])/g, function(match, format) {
      // if we encounter an escaped % then don't increase the array index
      if (match === '%%') return match;
      index++;
      var formatter = exports.formatters[format];
      if ('function' === typeof formatter) {
        var val = args[index];
        match = formatter.call(self, val);

        // now we need to remove `args[index]` since it's inlined in the `format`
        args.splice(index, 1);
        index--;
      }
      return match;
    });

    // apply env-specific formatting (colors, etc.)
    exports.formatArgs.call(self, args);

    var logFn = debug.log || exports.log || console.log.bind(console);
    logFn.apply(self, args);
  }

  debug.namespace = namespace;
  debug.enabled = exports.enabled(namespace);
  debug.useColors = exports.useColors();
  debug.color = selectColor(namespace);
  debug.destroy = destroy;

  // env-specific initialization logic for debug instances
  if ('function' === typeof exports.init) {
    exports.init(debug);
  }

  exports.instances.push(debug);

  return debug;
}

function destroy () {
  var index = exports.instances.indexOf(this);
  if (index !== -1) {
    exports.instances.splice(index, 1);
    return true;
  } else {
    return false;
  }
}

/**
 * Enables a debug mode by namespaces. This can include modes
 * separated by a colon and wildcards.
 *
 * @param {String} namespaces
 * @api public
 */

function enable(namespaces) {
  exports.save(namespaces);

  exports.names = [];
  exports.skips = [];

  var i;
  var split = (typeof namespaces === 'string' ? namespaces : '').split(/[\s,]+/);
  var len = split.length;

  for (i = 0; i < len; i++) {
    if (!split[i]) continue; // ignore empty strings
    namespaces = split[i].replace(/\*/g, '.*?');
    if (namespaces[0] === '-') {
      exports.skips.push(new RegExp('^' + namespaces.substr(1) + '$'));
    } else {
      exports.names.push(new RegExp('^' + namespaces + '$'));
    }
  }

  for (i = 0; i < exports.instances.length; i++) {
    var instance = exports.instances[i];
    instance.enabled = exports.enabled(instance.namespace);
  }
}

/**
 * Disable debug output.
 *
 * @api public
 */

function disable() {
  exports.enable('');
}

/**
 * Returns true if the given mode name is enabled, false otherwise.
 *
 * @param {String} name
 * @return {Boolean}
 * @api public
 */

function enabled(name) {
  if (name[name.length - 1] === '*') {
    return true;
  }
  var i, len;
  for (i = 0, len = exports.skips.length; i < len; i++) {
    if (exports.skips[i].test(name)) {
      return false;
    }
  }
  for (i = 0, len = exports.names.length; i < len; i++) {
    if (exports.names[i].test(name)) {
      return true;
    }
  }
  return false;
}

/**
 * Coerce `val`.
 *
 * @param {Mixed} val
 * @return {Mixed}
 * @api private
 */

function coerce(val) {
  if (val instanceof Error) return val.stack || val.message;
  return val;
}
});

var browser$1 = _commonjsHelpers.createCommonjsModule(function (module, exports) {
/**
 * This is the web browser implementation of `debug()`.
 *
 * Expose `debug()` as the module.
 */

exports = module.exports = debug$1;
exports.log = log;
exports.formatArgs = formatArgs;
exports.save = save;
exports.load = load;
exports.useColors = useColors;
exports.storage = 'undefined' != typeof chrome
               && 'undefined' != typeof chrome.storage
                  ? chrome.storage.local
                  : localstorage();

/**
 * Colors.
 */

exports.colors = [
  '#0000CC', '#0000FF', '#0033CC', '#0033FF', '#0066CC', '#0066FF', '#0099CC',
  '#0099FF', '#00CC00', '#00CC33', '#00CC66', '#00CC99', '#00CCCC', '#00CCFF',
  '#3300CC', '#3300FF', '#3333CC', '#3333FF', '#3366CC', '#3366FF', '#3399CC',
  '#3399FF', '#33CC00', '#33CC33', '#33CC66', '#33CC99', '#33CCCC', '#33CCFF',
  '#6600CC', '#6600FF', '#6633CC', '#6633FF', '#66CC00', '#66CC33', '#9900CC',
  '#9900FF', '#9933CC', '#9933FF', '#99CC00', '#99CC33', '#CC0000', '#CC0033',
  '#CC0066', '#CC0099', '#CC00CC', '#CC00FF', '#CC3300', '#CC3333', '#CC3366',
  '#CC3399', '#CC33CC', '#CC33FF', '#CC6600', '#CC6633', '#CC9900', '#CC9933',
  '#CCCC00', '#CCCC33', '#FF0000', '#FF0033', '#FF0066', '#FF0099', '#FF00CC',
  '#FF00FF', '#FF3300', '#FF3333', '#FF3366', '#FF3399', '#FF33CC', '#FF33FF',
  '#FF6600', '#FF6633', '#FF9900', '#FF9933', '#FFCC00', '#FFCC33'
];

/**
 * Currently only WebKit-based Web Inspectors, Firefox >= v31,
 * and the Firebug extension (any Firefox version) are known
 * to support "%c" CSS customizations.
 *
 * TODO: add a `localStorage` variable to explicitly enable/disable colors
 */

function useColors() {
  // NB: In an Electron preload script, document will be defined but not fully
  // initialized. Since we know we're in Chrome, we'll just detect this case
  // explicitly
  if (typeof window !== 'undefined' && window.process && window.process.type === 'renderer') {
    return true;
  }

  // Internet Explorer and Edge do not support colors.
  if (typeof navigator !== 'undefined' && navigator.userAgent && navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/)) {
    return false;
  }

  // is webkit? http://stackoverflow.com/a/16459606/376773
  // document is undefined in react-native: https://github.com/facebook/react-native/pull/1632
  return (typeof document !== 'undefined' && document.documentElement && document.documentElement.style && document.documentElement.style.WebkitAppearance) ||
    // is firebug? http://stackoverflow.com/a/398120/376773
    (typeof window !== 'undefined' && window.console && (window.console.firebug || (window.console.exception && window.console.table))) ||
    // is firefox >= v31?
    // https://developer.mozilla.org/en-US/docs/Tools/Web_Console#Styling_messages
    (typeof navigator !== 'undefined' && navigator.userAgent && navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/) && parseInt(RegExp.$1, 10) >= 31) ||
    // double check webkit in userAgent just in case we are in a worker
    (typeof navigator !== 'undefined' && navigator.userAgent && navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/));
}

/**
 * Map %j to `JSON.stringify()`, since no Web Inspectors do that by default.
 */

exports.formatters.j = function(v) {
  try {
    return JSON.stringify(v);
  } catch (err) {
    return '[UnexpectedJSONParseError]: ' + err.message;
  }
};


/**
 * Colorize log arguments if enabled.
 *
 * @api public
 */

function formatArgs(args) {
  var useColors = this.useColors;

  args[0] = (useColors ? '%c' : '')
    + this.namespace
    + (useColors ? ' %c' : ' ')
    + args[0]
    + (useColors ? '%c ' : ' ')
    + '+' + exports.humanize(this.diff);

  if (!useColors) return;

  var c = 'color: ' + this.color;
  args.splice(1, 0, c, 'color: inherit');

  // the final "%c" is somewhat tricky, because there could be other
  // arguments passed either before or after the %c, so we need to
  // figure out the correct index to insert the CSS into
  var index = 0;
  var lastC = 0;
  args[0].replace(/%[a-zA-Z%]/g, function(match) {
    if ('%%' === match) return;
    index++;
    if ('%c' === match) {
      // we only are interested in the *last* %c
      // (the user may have provided their own)
      lastC = index;
    }
  });

  args.splice(lastC, 0, c);
}

/**
 * Invokes `console.log()` when available.
 * No-op when `console.log` is not a "function".
 *
 * @api public
 */

function log() {
  // this hackery is required for IE8/9, where
  // the `console.log` function doesn't have 'apply'
  return 'object' === typeof console
    && console.log
    && Function.prototype.apply.call(console.log, console, arguments);
}

/**
 * Save `namespaces`.
 *
 * @param {String} namespaces
 * @api private
 */

function save(namespaces) {
  try {
    if (null == namespaces) {
      exports.storage.removeItem('debug');
    } else {
      exports.storage.debug = namespaces;
    }
  } catch(e) {}
}

/**
 * Load `namespaces`.
 *
 * @return {String} returns the previously persisted debug modes
 * @api private
 */

function load() {
  var r;
  try {
    r = exports.storage.debug;
  } catch(e) {}

  // If debug isn't set in LS, and we're in Electron, try to load $DEBUG
  if (!r && typeof process !== 'undefined' && 'env' in process) {
    r = process.env.DEBUG;
  }

  return r;
}

/**
 * Enable namespaces listed in `localStorage.debug` initially.
 */

exports.enable(load());

/**
 * Localstorage attempts to return the localstorage.
 *
 * This is necessary because safari throws
 * when a user disables cookies/localstorage
 * and you attempt to access it.
 *
 * @return {LocalStorage}
 * @api private
 */

function localstorage() {
  try {
    return window.localStorage;
  } catch (e) {}
}
});

var componentEmitter = _commonjsHelpers.createCommonjsModule(function (module) {
/**
 * Expose `Emitter`.
 */

{
  module.exports = Emitter;
}

/**
 * Initialize a new `Emitter`.
 *
 * @api public
 */

function Emitter(obj) {
  if (obj) return mixin(obj);
}
/**
 * Mixin the emitter properties.
 *
 * @param {Object} obj
 * @return {Object}
 * @api private
 */

function mixin(obj) {
  for (var key in Emitter.prototype) {
    obj[key] = Emitter.prototype[key];
  }
  return obj;
}

/**
 * Listen on the given `event` with `fn`.
 *
 * @param {String} event
 * @param {Function} fn
 * @return {Emitter}
 * @api public
 */

Emitter.prototype.on =
Emitter.prototype.addEventListener = function(event, fn){
  this._callbacks = this._callbacks || {};
  (this._callbacks['$' + event] = this._callbacks['$' + event] || [])
    .push(fn);
  return this;
};

/**
 * Adds an `event` listener that will be invoked a single
 * time then automatically removed.
 *
 * @param {String} event
 * @param {Function} fn
 * @return {Emitter}
 * @api public
 */

Emitter.prototype.once = function(event, fn){
  function on() {
    this.off(event, on);
    fn.apply(this, arguments);
  }

  on.fn = fn;
  this.on(event, on);
  return this;
};

/**
 * Remove the given callback for `event` or all
 * registered callbacks.
 *
 * @param {String} event
 * @param {Function} fn
 * @return {Emitter}
 * @api public
 */

Emitter.prototype.off =
Emitter.prototype.removeListener =
Emitter.prototype.removeAllListeners =
Emitter.prototype.removeEventListener = function(event, fn){
  this._callbacks = this._callbacks || {};

  // all
  if (0 == arguments.length) {
    this._callbacks = {};
    return this;
  }

  // specific event
  var callbacks = this._callbacks['$' + event];
  if (!callbacks) return this;

  // remove all handlers
  if (1 == arguments.length) {
    delete this._callbacks['$' + event];
    return this;
  }

  // remove specific handler
  var cb;
  for (var i = 0; i < callbacks.length; i++) {
    cb = callbacks[i];
    if (cb === fn || cb.fn === fn) {
      callbacks.splice(i, 1);
      break;
    }
  }
  return this;
};

/**
 * Emit `event` with the given args.
 *
 * @param {String} event
 * @param {Mixed} ...
 * @return {Emitter}
 */

Emitter.prototype.emit = function(event){
  this._callbacks = this._callbacks || {};
  var args = [].slice.call(arguments, 1)
    , callbacks = this._callbacks['$' + event];

  if (callbacks) {
    callbacks = callbacks.slice(0);
    for (var i = 0, len = callbacks.length; i < len; ++i) {
      callbacks[i].apply(this, args);
    }
  }

  return this;
};

/**
 * Return array of callbacks for `event`.
 *
 * @param {String} event
 * @return {Array}
 * @api public
 */

Emitter.prototype.listeners = function(event){
  this._callbacks = this._callbacks || {};
  return this._callbacks['$' + event] || [];
};

/**
 * Check if this emitter has `event` handlers.
 *
 * @param {String} event
 * @return {Boolean}
 * @api public
 */

Emitter.prototype.hasListeners = function(event){
  return !! this.listeners(event).length;
};
});

var toString = {}.toString;

var isarray = Array.isArray || function (arr) {
  return toString.call(arr) == '[object Array]';
};

var isBuffer = isBuf;

var withNativeBuffer = typeof Buffer === 'function' && typeof Buffer.isBuffer === 'function';
var withNativeArrayBuffer = typeof ArrayBuffer === 'function';

var isView = function (obj) {
  return typeof ArrayBuffer.isView === 'function' ? ArrayBuffer.isView(obj) : (obj.buffer instanceof ArrayBuffer);
};

/**
 * Returns true if obj is a buffer or an arraybuffer.
 *
 * @api private
 */

function isBuf(obj) {
  return (withNativeBuffer && Buffer.isBuffer(obj)) ||
          (withNativeArrayBuffer && (obj instanceof ArrayBuffer || isView(obj)));
}

/*global Blob,File*/

/**
 * Module requirements
 */



var toString$1 = Object.prototype.toString;
var withNativeBlob = typeof Blob === 'function' || (typeof Blob !== 'undefined' && toString$1.call(Blob) === '[object BlobConstructor]');
var withNativeFile = typeof File === 'function' || (typeof File !== 'undefined' && toString$1.call(File) === '[object FileConstructor]');

/**
 * Replaces every Buffer | ArrayBuffer in packet with a numbered placeholder.
 * Anything with blobs or files should be fed through removeBlobs before coming
 * here.
 *
 * @param {Object} packet - socket.io event packet
 * @return {Object} with deconstructed packet and list of buffers
 * @api public
 */

var deconstructPacket = function(packet) {
  var buffers = [];
  var packetData = packet.data;
  var pack = packet;
  pack.data = _deconstructPacket(packetData, buffers);
  pack.attachments = buffers.length; // number of binary 'attachments'
  return {packet: pack, buffers: buffers};
};

function _deconstructPacket(data, buffers) {
  if (!data) return data;

  if (isBuffer(data)) {
    var placeholder = { _placeholder: true, num: buffers.length };
    buffers.push(data);
    return placeholder;
  } else if (isarray(data)) {
    var newData = new Array(data.length);
    for (var i = 0; i < data.length; i++) {
      newData[i] = _deconstructPacket(data[i], buffers);
    }
    return newData;
  } else if (typeof data === 'object' && !(data instanceof Date)) {
    var newData = {};
    for (var key in data) {
      newData[key] = _deconstructPacket(data[key], buffers);
    }
    return newData;
  }
  return data;
}

/**
 * Reconstructs a binary packet from its placeholder packet and buffers
 *
 * @param {Object} packet - event packet with placeholders
 * @param {Array} buffers - binary buffers to put in placeholder positions
 * @return {Object} reconstructed packet
 * @api public
 */

var reconstructPacket = function(packet, buffers) {
  packet.data = _reconstructPacket(packet.data, buffers);
  packet.attachments = undefined; // no longer useful
  return packet;
};

function _reconstructPacket(data, buffers) {
  if (!data) return data;

  if (data && data._placeholder) {
    return buffers[data.num]; // appropriate buffer (should be natural order anyway)
  } else if (isarray(data)) {
    for (var i = 0; i < data.length; i++) {
      data[i] = _reconstructPacket(data[i], buffers);
    }
  } else if (typeof data === 'object') {
    for (var key in data) {
      data[key] = _reconstructPacket(data[key], buffers);
    }
  }

  return data;
}

/**
 * Asynchronously removes Blobs or Files from data via
 * FileReader's readAsArrayBuffer method. Used before encoding
 * data as msgpack. Calls callback with the blobless data.
 *
 * @param {Object} data
 * @param {Function} callback
 * @api private
 */

var removeBlobs = function(data, callback) {
  function _removeBlobs(obj, curKey, containingObject) {
    if (!obj) return obj;

    // convert any blob
    if ((withNativeBlob && obj instanceof Blob) ||
        (withNativeFile && obj instanceof File)) {
      pendingBlobs++;

      // async filereader
      var fileReader = new FileReader();
      fileReader.onload = function() { // this.result == arraybuffer
        if (containingObject) {
          containingObject[curKey] = this.result;
        }
        else {
          bloblessData = this.result;
        }

        // if nothing pending its callback time
        if(! --pendingBlobs) {
          callback(bloblessData);
        }
      };

      fileReader.readAsArrayBuffer(obj); // blob -> arraybuffer
    } else if (isarray(obj)) { // handle array
      for (var i = 0; i < obj.length; i++) {
        _removeBlobs(obj[i], i, obj);
      }
    } else if (typeof obj === 'object' && !isBuffer(obj)) { // and object
      for (var key in obj) {
        _removeBlobs(obj[key], key, obj);
      }
    }
  }

  var pendingBlobs = 0;
  var bloblessData = data;
  _removeBlobs(bloblessData);
  if (!pendingBlobs) {
    callback(bloblessData);
  }
};

var binary = {
	deconstructPacket: deconstructPacket,
	reconstructPacket: reconstructPacket,
	removeBlobs: removeBlobs
};

var socket_ioParser = _commonjsHelpers.createCommonjsModule(function (module, exports) {
/**
 * Module dependencies.
 */

var debug = browser$1('socket.io-parser');





/**
 * Protocol version.
 *
 * @api public
 */

exports.protocol = 4;

/**
 * Packet types.
 *
 * @api public
 */

exports.types = [
  'CONNECT',
  'DISCONNECT',
  'EVENT',
  'ACK',
  'ERROR',
  'BINARY_EVENT',
  'BINARY_ACK'
];

/**
 * Packet type `connect`.
 *
 * @api public
 */

exports.CONNECT = 0;

/**
 * Packet type `disconnect`.
 *
 * @api public
 */

exports.DISCONNECT = 1;

/**
 * Packet type `event`.
 *
 * @api public
 */

exports.EVENT = 2;

/**
 * Packet type `ack`.
 *
 * @api public
 */

exports.ACK = 3;

/**
 * Packet type `error`.
 *
 * @api public
 */

exports.ERROR = 4;

/**
 * Packet type 'binary event'
 *
 * @api public
 */

exports.BINARY_EVENT = 5;

/**
 * Packet type `binary ack`. For acks with binary arguments.
 *
 * @api public
 */

exports.BINARY_ACK = 6;

/**
 * Encoder constructor.
 *
 * @api public
 */

exports.Encoder = Encoder;

/**
 * Decoder constructor.
 *
 * @api public
 */

exports.Decoder = Decoder;

/**
 * A socket.io Encoder instance
 *
 * @api public
 */

function Encoder() {}

var ERROR_PACKET = exports.ERROR + '"encode error"';

/**
 * Encode a packet as a single string if non-binary, or as a
 * buffer sequence, depending on packet type.
 *
 * @param {Object} obj - packet object
 * @param {Function} callback - function to handle encodings (likely engine.write)
 * @return Calls callback with Array of encodings
 * @api public
 */

Encoder.prototype.encode = function(obj, callback){
  debug('encoding packet %j', obj);

  if (exports.BINARY_EVENT === obj.type || exports.BINARY_ACK === obj.type) {
    encodeAsBinary(obj, callback);
  } else {
    var encoding = encodeAsString(obj);
    callback([encoding]);
  }
};

/**
 * Encode packet as string.
 *
 * @param {Object} packet
 * @return {String} encoded
 * @api private
 */

function encodeAsString(obj) {

  // first is type
  var str = '' + obj.type;

  // attachments if we have them
  if (exports.BINARY_EVENT === obj.type || exports.BINARY_ACK === obj.type) {
    str += obj.attachments + '-';
  }

  // if we have a namespace other than `/`
  // we append it followed by a comma `,`
  if (obj.nsp && '/' !== obj.nsp) {
    str += obj.nsp + ',';
  }

  // immediately followed by the id
  if (null != obj.id) {
    str += obj.id;
  }

  // json data
  if (null != obj.data) {
    var payload = tryStringify(obj.data);
    if (payload !== false) {
      str += payload;
    } else {
      return ERROR_PACKET;
    }
  }

  debug('encoded %j as %s', obj, str);
  return str;
}

function tryStringify(str) {
  try {
    return JSON.stringify(str);
  } catch(e){
    return false;
  }
}

/**
 * Encode packet as 'buffer sequence' by removing blobs, and
 * deconstructing packet into object with placeholders and
 * a list of buffers.
 *
 * @param {Object} packet
 * @return {Buffer} encoded
 * @api private
 */

function encodeAsBinary(obj, callback) {

  function writeEncoding(bloblessData) {
    var deconstruction = binary.deconstructPacket(bloblessData);
    var pack = encodeAsString(deconstruction.packet);
    var buffers = deconstruction.buffers;

    buffers.unshift(pack); // add packet info to beginning of data list
    callback(buffers); // write all the buffers
  }

  binary.removeBlobs(obj, writeEncoding);
}

/**
 * A socket.io Decoder instance
 *
 * @return {Object} decoder
 * @api public
 */

function Decoder() {
  this.reconstructor = null;
}

/**
 * Mix in `Emitter` with Decoder.
 */

componentEmitter(Decoder.prototype);

/**
 * Decodes an encoded packet string into packet JSON.
 *
 * @param {String} obj - encoded packet
 * @return {Object} packet
 * @api public
 */

Decoder.prototype.add = function(obj) {
  var packet;
  if (typeof obj === 'string') {
    packet = decodeString(obj);
    if (exports.BINARY_EVENT === packet.type || exports.BINARY_ACK === packet.type) { // binary packet's json
      this.reconstructor = new BinaryReconstructor(packet);

      // no attachments, labeled binary but no binary data to follow
      if (this.reconstructor.reconPack.attachments === 0) {
        this.emit('decoded', packet);
      }
    } else { // non-binary full packet
      this.emit('decoded', packet);
    }
  } else if (isBuffer(obj) || obj.base64) { // raw binary data
    if (!this.reconstructor) {
      throw new Error('got binary data when not reconstructing a packet');
    } else {
      packet = this.reconstructor.takeBinaryData(obj);
      if (packet) { // received final buffer
        this.reconstructor = null;
        this.emit('decoded', packet);
      }
    }
  } else {
    throw new Error('Unknown type: ' + obj);
  }
};

/**
 * Decode a packet String (JSON data)
 *
 * @param {String} str
 * @return {Object} packet
 * @api private
 */

function decodeString(str) {
  var i = 0;
  // look up type
  var p = {
    type: Number(str.charAt(0))
  };

  if (null == exports.types[p.type]) {
    return error('unknown packet type ' + p.type);
  }

  // look up attachments if type binary
  if (exports.BINARY_EVENT === p.type || exports.BINARY_ACK === p.type) {
    var buf = '';
    while (str.charAt(++i) !== '-') {
      buf += str.charAt(i);
      if (i == str.length) break;
    }
    if (buf != Number(buf) || str.charAt(i) !== '-') {
      throw new Error('Illegal attachments');
    }
    p.attachments = Number(buf);
  }

  // look up namespace (if any)
  if ('/' === str.charAt(i + 1)) {
    p.nsp = '';
    while (++i) {
      var c = str.charAt(i);
      if (',' === c) break;
      p.nsp += c;
      if (i === str.length) break;
    }
  } else {
    p.nsp = '/';
  }

  // look up id
  var next = str.charAt(i + 1);
  if ('' !== next && Number(next) == next) {
    p.id = '';
    while (++i) {
      var c = str.charAt(i);
      if (null == c || Number(c) != c) {
        --i;
        break;
      }
      p.id += str.charAt(i);
      if (i === str.length) break;
    }
    p.id = Number(p.id);
  }

  // look up json data
  if (str.charAt(++i)) {
    var payload = tryParse(str.substr(i));
    var isPayloadValid = payload !== false && (p.type === exports.ERROR || isarray(payload));
    if (isPayloadValid) {
      p.data = payload;
    } else {
      return error('invalid payload');
    }
  }

  debug('decoded %s as %j', str, p);
  return p;
}

function tryParse(str) {
  try {
    return JSON.parse(str);
  } catch(e){
    return false;
  }
}

/**
 * Deallocates a parser's resources
 *
 * @api public
 */

Decoder.prototype.destroy = function() {
  if (this.reconstructor) {
    this.reconstructor.finishedReconstruction();
  }
};

/**
 * A manager of a binary event's 'buffer sequence'. Should
 * be constructed whenever a packet of type BINARY_EVENT is
 * decoded.
 *
 * @param {Object} packet
 * @return {BinaryReconstructor} initialized reconstructor
 * @api private
 */

function BinaryReconstructor(packet) {
  this.reconPack = packet;
  this.buffers = [];
}

/**
 * Method to be called when binary data received from connection
 * after a BINARY_EVENT packet.
 *
 * @param {Buffer | ArrayBuffer} binData - the raw binary data received
 * @return {null | Object} returns null if more binary data is expected or
 *   a reconstructed packet object if all buffers have been received.
 * @api private
 */

BinaryReconstructor.prototype.takeBinaryData = function(binData) {
  this.buffers.push(binData);
  if (this.buffers.length === this.reconPack.attachments) { // done with buffer list
    var packet = binary.reconstructPacket(this.reconPack, this.buffers);
    this.finishedReconstruction();
    return packet;
  }
  return null;
};

/**
 * Cleans up binary packet reconstruction variables.
 *
 * @api private
 */

BinaryReconstructor.prototype.finishedReconstruction = function() {
  this.reconPack = null;
  this.buffers = [];
};

function error(msg) {
  return {
    type: exports.ERROR,
    data: 'parser error: ' + msg
  };
}
});

var hasCors = _commonjsHelpers.createCommonjsModule(function (module) {
/**
 * Module exports.
 *
 * Logic borrowed from Modernizr:
 *
 *   - https://github.com/Modernizr/Modernizr/blob/master/feature-detects/cors.js
 */

try {
  module.exports = typeof XMLHttpRequest !== 'undefined' &&
    'withCredentials' in new XMLHttpRequest();
} catch (err) {
  // if XMLHttp support is disabled in IE then it will throw
  // when trying to create
  module.exports = false;
}
});

var globalThis_browser = (function () {
  if (typeof self !== 'undefined') {
    return self;
  } else if (typeof window !== 'undefined') {
    return window;
  } else {
    return Function('return this')(); // eslint-disable-line no-new-func
  }
})();

// browser shim for xmlhttprequest module




var xmlhttprequest = function (opts) {
  var xdomain = opts.xdomain;

  // scheme must be same when usign XDomainRequest
  // http://blogs.msdn.com/b/ieinternals/archive/2010/05/13/xdomainrequest-restrictions-limitations-and-workarounds.aspx
  var xscheme = opts.xscheme;

  // XDomainRequest has a flow of not sending cookie, therefore it should be disabled as a default.
  // https://github.com/Automattic/engine.io-client/pull/217
  var enablesXDR = opts.enablesXDR;

  // XMLHttpRequest can be disabled on IE
  try {
    if ('undefined' !== typeof XMLHttpRequest && (!xdomain || hasCors)) {
      return new XMLHttpRequest();
    }
  } catch (e) { }

  // Use XDomainRequest for IE8 if enablesXDR is true
  // because loading bar keeps flashing when using jsonp-polling
  // https://github.com/yujiosaka/socke.io-ie8-loading-example
  try {
    if ('undefined' !== typeof XDomainRequest && !xscheme && enablesXDR) {
      return new XDomainRequest();
    }
  } catch (e) { }

  if (!xdomain) {
    try {
      return new globalThis_browser[['Active'].concat('Object').join('X')]('Microsoft.XMLHTTP');
    } catch (e) { }
  }
};

/**
 * Gets the keys for an object.
 *
 * @return {Array} keys
 * @api private
 */

var keys = Object.keys || function keys (obj){
  var arr = [];
  var has = Object.prototype.hasOwnProperty;

  for (var i in obj) {
    if (has.call(obj, i)) {
      arr.push(i);
    }
  }
  return arr;
};

var toString$2 = {}.toString;

var isarray$1 = Array.isArray || function (arr) {
  return toString$2.call(arr) == '[object Array]';
};

/* global Blob File */

/*
 * Module requirements.
 */



var toString$3 = Object.prototype.toString;
var withNativeBlob$1 = typeof Blob === 'function' ||
                        typeof Blob !== 'undefined' && toString$3.call(Blob) === '[object BlobConstructor]';
var withNativeFile$1 = typeof File === 'function' ||
                        typeof File !== 'undefined' && toString$3.call(File) === '[object FileConstructor]';

/**
 * Module exports.
 */

var hasBinary2 = hasBinary;

/**
 * Checks for binary data.
 *
 * Supports Buffer, ArrayBuffer, Blob and File.
 *
 * @param {Object} anything
 * @api public
 */

function hasBinary (obj) {
  if (!obj || typeof obj !== 'object') {
    return false;
  }

  if (isarray$1(obj)) {
    for (var i = 0, l = obj.length; i < l; i++) {
      if (hasBinary(obj[i])) {
        return true;
      }
    }
    return false;
  }

  if ((typeof Buffer === 'function' && Buffer.isBuffer && Buffer.isBuffer(obj)) ||
    (typeof ArrayBuffer === 'function' && obj instanceof ArrayBuffer) ||
    (withNativeBlob$1 && obj instanceof Blob) ||
    (withNativeFile$1 && obj instanceof File)
  ) {
    return true;
  }

  // see: https://github.com/Automattic/has-binary/pull/4
  if (obj.toJSON && typeof obj.toJSON === 'function' && arguments.length === 1) {
    return hasBinary(obj.toJSON(), true);
  }

  for (var key in obj) {
    if (Object.prototype.hasOwnProperty.call(obj, key) && hasBinary(obj[key])) {
      return true;
    }
  }

  return false;
}

/**
 * An abstraction for slicing an arraybuffer even when
 * ArrayBuffer.prototype.slice is not supported
 *
 * @api public
 */

var arraybuffer_slice = function(arraybuffer, start, end) {
  var bytes = arraybuffer.byteLength;
  start = start || 0;
  end = end || bytes;

  if (arraybuffer.slice) { return arraybuffer.slice(start, end); }

  if (start < 0) { start += bytes; }
  if (end < 0) { end += bytes; }
  if (end > bytes) { end = bytes; }

  if (start >= bytes || start >= end || bytes === 0) {
    return new ArrayBuffer(0);
  }

  var abv = new Uint8Array(arraybuffer);
  var result = new Uint8Array(end - start);
  for (var i = start, ii = 0; i < end; i++, ii++) {
    result[ii] = abv[i];
  }
  return result.buffer;
};

var after_1 = after;

function after(count, callback, err_cb) {
    var bail = false;
    err_cb = err_cb || noop;
    proxy.count = count;

    return (count === 0) ? callback() : proxy

    function proxy(err, result) {
        if (proxy.count <= 0) {
            throw new Error('after called too many times')
        }
        --proxy.count;

        // after first error, rest are passed to err_cb
        if (err) {
            bail = true;
            callback(err);
            // future error callbacks will go to error handler
            callback = err_cb;
        } else if (proxy.count === 0 && !bail) {
            callback(null, result);
        }
    }
}

function noop() {}

/*! https://mths.be/utf8js v2.1.2 by @mathias */

var stringFromCharCode = String.fromCharCode;

// Taken from https://mths.be/punycode
function ucs2decode(string) {
	var output = [];
	var counter = 0;
	var length = string.length;
	var value;
	var extra;
	while (counter < length) {
		value = string.charCodeAt(counter++);
		if (value >= 0xD800 && value <= 0xDBFF && counter < length) {
			// high surrogate, and there is a next character
			extra = string.charCodeAt(counter++);
			if ((extra & 0xFC00) == 0xDC00) { // low surrogate
				output.push(((value & 0x3FF) << 10) + (extra & 0x3FF) + 0x10000);
			} else {
				// unmatched surrogate; only append this code unit, in case the next
				// code unit is the high surrogate of a surrogate pair
				output.push(value);
				counter--;
			}
		} else {
			output.push(value);
		}
	}
	return output;
}

// Taken from https://mths.be/punycode
function ucs2encode(array) {
	var length = array.length;
	var index = -1;
	var value;
	var output = '';
	while (++index < length) {
		value = array[index];
		if (value > 0xFFFF) {
			value -= 0x10000;
			output += stringFromCharCode(value >>> 10 & 0x3FF | 0xD800);
			value = 0xDC00 | value & 0x3FF;
		}
		output += stringFromCharCode(value);
	}
	return output;
}

function checkScalarValue(codePoint, strict) {
	if (codePoint >= 0xD800 && codePoint <= 0xDFFF) {
		if (strict) {
			throw Error(
				'Lone surrogate U+' + codePoint.toString(16).toUpperCase() +
				' is not a scalar value'
			);
		}
		return false;
	}
	return true;
}
/*--------------------------------------------------------------------------*/

function createByte(codePoint, shift) {
	return stringFromCharCode(((codePoint >> shift) & 0x3F) | 0x80);
}

function encodeCodePoint(codePoint, strict) {
	if ((codePoint & 0xFFFFFF80) == 0) { // 1-byte sequence
		return stringFromCharCode(codePoint);
	}
	var symbol = '';
	if ((codePoint & 0xFFFFF800) == 0) { // 2-byte sequence
		symbol = stringFromCharCode(((codePoint >> 6) & 0x1F) | 0xC0);
	}
	else if ((codePoint & 0xFFFF0000) == 0) { // 3-byte sequence
		if (!checkScalarValue(codePoint, strict)) {
			codePoint = 0xFFFD;
		}
		symbol = stringFromCharCode(((codePoint >> 12) & 0x0F) | 0xE0);
		symbol += createByte(codePoint, 6);
	}
	else if ((codePoint & 0xFFE00000) == 0) { // 4-byte sequence
		symbol = stringFromCharCode(((codePoint >> 18) & 0x07) | 0xF0);
		symbol += createByte(codePoint, 12);
		symbol += createByte(codePoint, 6);
	}
	symbol += stringFromCharCode((codePoint & 0x3F) | 0x80);
	return symbol;
}

function utf8encode(string, opts) {
	opts = opts || {};
	var strict = false !== opts.strict;

	var codePoints = ucs2decode(string);
	var length = codePoints.length;
	var index = -1;
	var codePoint;
	var byteString = '';
	while (++index < length) {
		codePoint = codePoints[index];
		byteString += encodeCodePoint(codePoint, strict);
	}
	return byteString;
}

/*--------------------------------------------------------------------------*/

function readContinuationByte() {
	if (byteIndex >= byteCount) {
		throw Error('Invalid byte index');
	}

	var continuationByte = byteArray[byteIndex] & 0xFF;
	byteIndex++;

	if ((continuationByte & 0xC0) == 0x80) {
		return continuationByte & 0x3F;
	}

	// If we end up here, its not a continuation byte
	throw Error('Invalid continuation byte');
}

function decodeSymbol(strict) {
	var byte1;
	var byte2;
	var byte3;
	var byte4;
	var codePoint;

	if (byteIndex > byteCount) {
		throw Error('Invalid byte index');
	}

	if (byteIndex == byteCount) {
		return false;
	}

	// Read first byte
	byte1 = byteArray[byteIndex] & 0xFF;
	byteIndex++;

	// 1-byte sequence (no continuation bytes)
	if ((byte1 & 0x80) == 0) {
		return byte1;
	}

	// 2-byte sequence
	if ((byte1 & 0xE0) == 0xC0) {
		byte2 = readContinuationByte();
		codePoint = ((byte1 & 0x1F) << 6) | byte2;
		if (codePoint >= 0x80) {
			return codePoint;
		} else {
			throw Error('Invalid continuation byte');
		}
	}

	// 3-byte sequence (may include unpaired surrogates)
	if ((byte1 & 0xF0) == 0xE0) {
		byte2 = readContinuationByte();
		byte3 = readContinuationByte();
		codePoint = ((byte1 & 0x0F) << 12) | (byte2 << 6) | byte3;
		if (codePoint >= 0x0800) {
			return checkScalarValue(codePoint, strict) ? codePoint : 0xFFFD;
		} else {
			throw Error('Invalid continuation byte');
		}
	}

	// 4-byte sequence
	if ((byte1 & 0xF8) == 0xF0) {
		byte2 = readContinuationByte();
		byte3 = readContinuationByte();
		byte4 = readContinuationByte();
		codePoint = ((byte1 & 0x07) << 0x12) | (byte2 << 0x0C) |
			(byte3 << 0x06) | byte4;
		if (codePoint >= 0x010000 && codePoint <= 0x10FFFF) {
			return codePoint;
		}
	}

	throw Error('Invalid UTF-8 detected');
}

var byteArray;
var byteCount;
var byteIndex;
function utf8decode(byteString, opts) {
	opts = opts || {};
	var strict = false !== opts.strict;

	byteArray = ucs2decode(byteString);
	byteCount = byteArray.length;
	byteIndex = 0;
	var codePoints = [];
	var tmp;
	while ((tmp = decodeSymbol(strict)) !== false) {
		codePoints.push(tmp);
	}
	return ucs2encode(codePoints);
}

var utf8 = {
	version: '2.1.2',
	encode: utf8encode,
	decode: utf8decode
};

var base64Arraybuffer = _commonjsHelpers.createCommonjsModule(function (module, exports) {
/*
 * base64-arraybuffer
 * https://github.com/niklasvh/base64-arraybuffer
 *
 * Copyright (c) 2012 Niklas von Hertzen
 * Licensed under the MIT license.
 */
(function(){

  var chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";

  // Use a lookup table to find the index.
  var lookup = new Uint8Array(256);
  for (var i = 0; i < chars.length; i++) {
    lookup[chars.charCodeAt(i)] = i;
  }

  exports.encode = function(arraybuffer) {
    var bytes = new Uint8Array(arraybuffer),
    i, len = bytes.length, base64 = "";

    for (i = 0; i < len; i+=3) {
      base64 += chars[bytes[i] >> 2];
      base64 += chars[((bytes[i] & 3) << 4) | (bytes[i + 1] >> 4)];
      base64 += chars[((bytes[i + 1] & 15) << 2) | (bytes[i + 2] >> 6)];
      base64 += chars[bytes[i + 2] & 63];
    }

    if ((len % 3) === 2) {
      base64 = base64.substring(0, base64.length - 1) + "=";
    } else if (len % 3 === 1) {
      base64 = base64.substring(0, base64.length - 2) + "==";
    }

    return base64;
  };

  exports.decode =  function(base64) {
    var bufferLength = base64.length * 0.75,
    len = base64.length, i, p = 0,
    encoded1, encoded2, encoded3, encoded4;

    if (base64[base64.length - 1] === "=") {
      bufferLength--;
      if (base64[base64.length - 2] === "=") {
        bufferLength--;
      }
    }

    var arraybuffer = new ArrayBuffer(bufferLength),
    bytes = new Uint8Array(arraybuffer);

    for (i = 0; i < len; i+=4) {
      encoded1 = lookup[base64.charCodeAt(i)];
      encoded2 = lookup[base64.charCodeAt(i+1)];
      encoded3 = lookup[base64.charCodeAt(i+2)];
      encoded4 = lookup[base64.charCodeAt(i+3)];

      bytes[p++] = (encoded1 << 2) | (encoded2 >> 4);
      bytes[p++] = ((encoded2 & 15) << 4) | (encoded3 >> 2);
      bytes[p++] = ((encoded3 & 3) << 6) | (encoded4 & 63);
    }

    return arraybuffer;
  };
})();
});

/**
 * Create a blob builder even when vendor prefixes exist
 */

var BlobBuilder = typeof BlobBuilder !== 'undefined' ? BlobBuilder :
  typeof WebKitBlobBuilder !== 'undefined' ? WebKitBlobBuilder :
  typeof MSBlobBuilder !== 'undefined' ? MSBlobBuilder :
  typeof MozBlobBuilder !== 'undefined' ? MozBlobBuilder : 
  false;

/**
 * Check if Blob constructor is supported
 */

var blobSupported = (function() {
  try {
    var a = new Blob(['hi']);
    return a.size === 2;
  } catch(e) {
    return false;
  }
})();

/**
 * Check if Blob constructor supports ArrayBufferViews
 * Fails in Safari 6, so we need to map to ArrayBuffers there.
 */

var blobSupportsArrayBufferView = blobSupported && (function() {
  try {
    var b = new Blob([new Uint8Array([1,2])]);
    return b.size === 2;
  } catch(e) {
    return false;
  }
})();

/**
 * Check if BlobBuilder is supported
 */

var blobBuilderSupported = BlobBuilder
  && BlobBuilder.prototype.append
  && BlobBuilder.prototype.getBlob;

/**
 * Helper function that maps ArrayBufferViews to ArrayBuffers
 * Used by BlobBuilder constructor and old browsers that didn't
 * support it in the Blob constructor.
 */

function mapArrayBufferViews(ary) {
  return ary.map(function(chunk) {
    if (chunk.buffer instanceof ArrayBuffer) {
      var buf = chunk.buffer;

      // if this is a subarray, make a copy so we only
      // include the subarray region from the underlying buffer
      if (chunk.byteLength !== buf.byteLength) {
        var copy = new Uint8Array(chunk.byteLength);
        copy.set(new Uint8Array(buf, chunk.byteOffset, chunk.byteLength));
        buf = copy.buffer;
      }

      return buf;
    }

    return chunk;
  });
}

function BlobBuilderConstructor(ary, options) {
  options = options || {};

  var bb = new BlobBuilder();
  mapArrayBufferViews(ary).forEach(function(part) {
    bb.append(part);
  });

  return (options.type) ? bb.getBlob(options.type) : bb.getBlob();
}
function BlobConstructor(ary, options) {
  return new Blob(mapArrayBufferViews(ary), options || {});
}
if (typeof Blob !== 'undefined') {
  BlobBuilderConstructor.prototype = Blob.prototype;
  BlobConstructor.prototype = Blob.prototype;
}

var blob = (function() {
  if (blobSupported) {
    return blobSupportsArrayBufferView ? Blob : BlobConstructor;
  } else if (blobBuilderSupported) {
    return BlobBuilderConstructor;
  } else {
    return undefined;
  }
})();

var browser$2 = _commonjsHelpers.createCommonjsModule(function (module, exports) {
/**
 * Module dependencies.
 */







var base64encoder;
if (typeof ArrayBuffer !== 'undefined') {
  base64encoder = base64Arraybuffer;
}

/**
 * Check if we are running an android browser. That requires us to use
 * ArrayBuffer with polling transports...
 *
 * http://ghinda.net/jpeg-blob-ajax-android/
 */

var isAndroid = typeof navigator !== 'undefined' && /Android/i.test(navigator.userAgent);

/**
 * Check if we are running in PhantomJS.
 * Uploading a Blob with PhantomJS does not work correctly, as reported here:
 * https://github.com/ariya/phantomjs/issues/11395
 * @type boolean
 */
var isPhantomJS = typeof navigator !== 'undefined' && /PhantomJS/i.test(navigator.userAgent);

/**
 * When true, avoids using Blobs to encode payloads.
 * @type boolean
 */
var dontSendBlobs = isAndroid || isPhantomJS;

/**
 * Current protocol version.
 */

exports.protocol = 3;

/**
 * Packet types.
 */

var packets = exports.packets = {
    open:     0    // non-ws
  , close:    1    // non-ws
  , ping:     2
  , pong:     3
  , message:  4
  , upgrade:  5
  , noop:     6
};

var packetslist = keys(packets);

/**
 * Premade error packet.
 */

var err = { type: 'error', data: 'parser error' };

/**
 * Create a blob api even for blob builder when vendor prefixes exist
 */



/**
 * Encodes a packet.
 *
 *     <packet type id> [ <data> ]
 *
 * Example:
 *
 *     5hello world
 *     3
 *     4
 *
 * Binary is encoded in an identical principle
 *
 * @api private
 */

exports.encodePacket = function (packet, supportsBinary, utf8encode, callback) {
  if (typeof supportsBinary === 'function') {
    callback = supportsBinary;
    supportsBinary = false;
  }

  if (typeof utf8encode === 'function') {
    callback = utf8encode;
    utf8encode = null;
  }

  var data = (packet.data === undefined)
    ? undefined
    : packet.data.buffer || packet.data;

  if (typeof ArrayBuffer !== 'undefined' && data instanceof ArrayBuffer) {
    return encodeArrayBuffer(packet, supportsBinary, callback);
  } else if (typeof blob !== 'undefined' && data instanceof blob) {
    return encodeBlob(packet, supportsBinary, callback);
  }

  // might be an object with { base64: true, data: dataAsBase64String }
  if (data && data.base64) {
    return encodeBase64Object(packet, callback);
  }

  // Sending data as a utf-8 string
  var encoded = packets[packet.type];

  // data fragment is optional
  if (undefined !== packet.data) {
    encoded += utf8encode ? utf8.encode(String(packet.data), { strict: false }) : String(packet.data);
  }

  return callback('' + encoded);

};

function encodeBase64Object(packet, callback) {
  // packet data is an object { base64: true, data: dataAsBase64String }
  var message = 'b' + exports.packets[packet.type] + packet.data.data;
  return callback(message);
}

/**
 * Encode packet helpers for binary types
 */

function encodeArrayBuffer(packet, supportsBinary, callback) {
  if (!supportsBinary) {
    return exports.encodeBase64Packet(packet, callback);
  }

  var data = packet.data;
  var contentArray = new Uint8Array(data);
  var resultBuffer = new Uint8Array(1 + data.byteLength);

  resultBuffer[0] = packets[packet.type];
  for (var i = 0; i < contentArray.length; i++) {
    resultBuffer[i+1] = contentArray[i];
  }

  return callback(resultBuffer.buffer);
}

function encodeBlobAsArrayBuffer(packet, supportsBinary, callback) {
  if (!supportsBinary) {
    return exports.encodeBase64Packet(packet, callback);
  }

  var fr = new FileReader();
  fr.onload = function() {
    exports.encodePacket({ type: packet.type, data: fr.result }, supportsBinary, true, callback);
  };
  return fr.readAsArrayBuffer(packet.data);
}

function encodeBlob(packet, supportsBinary, callback) {
  if (!supportsBinary) {
    return exports.encodeBase64Packet(packet, callback);
  }

  if (dontSendBlobs) {
    return encodeBlobAsArrayBuffer(packet, supportsBinary, callback);
  }

  var length = new Uint8Array(1);
  length[0] = packets[packet.type];
  var blob$1 = new blob([length.buffer, packet.data]);

  return callback(blob$1);
}

/**
 * Encodes a packet with binary data in a base64 string
 *
 * @param {Object} packet, has `type` and `data`
 * @return {String} base64 encoded message
 */

exports.encodeBase64Packet = function(packet, callback) {
  var message = 'b' + exports.packets[packet.type];
  if (typeof blob !== 'undefined' && packet.data instanceof blob) {
    var fr = new FileReader();
    fr.onload = function() {
      var b64 = fr.result.split(',')[1];
      callback(message + b64);
    };
    return fr.readAsDataURL(packet.data);
  }

  var b64data;
  try {
    b64data = String.fromCharCode.apply(null, new Uint8Array(packet.data));
  } catch (e) {
    // iPhone Safari doesn't let you apply with typed arrays
    var typed = new Uint8Array(packet.data);
    var basic = new Array(typed.length);
    for (var i = 0; i < typed.length; i++) {
      basic[i] = typed[i];
    }
    b64data = String.fromCharCode.apply(null, basic);
  }
  message += btoa(b64data);
  return callback(message);
};

/**
 * Decodes a packet. Changes format to Blob if requested.
 *
 * @return {Object} with `type` and `data` (if any)
 * @api private
 */

exports.decodePacket = function (data, binaryType, utf8decode) {
  if (data === undefined) {
    return err;
  }
  // String data
  if (typeof data === 'string') {
    if (data.charAt(0) === 'b') {
      return exports.decodeBase64Packet(data.substr(1), binaryType);
    }

    if (utf8decode) {
      data = tryDecode(data);
      if (data === false) {
        return err;
      }
    }
    var type = data.charAt(0);

    if (Number(type) != type || !packetslist[type]) {
      return err;
    }

    if (data.length > 1) {
      return { type: packetslist[type], data: data.substring(1) };
    } else {
      return { type: packetslist[type] };
    }
  }

  var asArray = new Uint8Array(data);
  var type = asArray[0];
  var rest = arraybuffer_slice(data, 1);
  if (blob && binaryType === 'blob') {
    rest = new blob([rest]);
  }
  return { type: packetslist[type], data: rest };
};

function tryDecode(data) {
  try {
    data = utf8.decode(data, { strict: false });
  } catch (e) {
    return false;
  }
  return data;
}

/**
 * Decodes a packet encoded in a base64 string
 *
 * @param {String} base64 encoded message
 * @return {Object} with `type` and `data` (if any)
 */

exports.decodeBase64Packet = function(msg, binaryType) {
  var type = packetslist[msg.charAt(0)];
  if (!base64encoder) {
    return { type: type, data: { base64: true, data: msg.substr(1) } };
  }

  var data = base64encoder.decode(msg.substr(1));

  if (binaryType === 'blob' && blob) {
    data = new blob([data]);
  }

  return { type: type, data: data };
};

/**
 * Encodes multiple messages (payload).
 *
 *     <length>:data
 *
 * Example:
 *
 *     11:hello world2:hi
 *
 * If any contents are binary, they will be encoded as base64 strings. Base64
 * encoded strings are marked with a b before the length specifier
 *
 * @param {Array} packets
 * @api private
 */

exports.encodePayload = function (packets, supportsBinary, callback) {
  if (typeof supportsBinary === 'function') {
    callback = supportsBinary;
    supportsBinary = null;
  }

  var isBinary = hasBinary2(packets);

  if (supportsBinary && isBinary) {
    if (blob && !dontSendBlobs) {
      return exports.encodePayloadAsBlob(packets, callback);
    }

    return exports.encodePayloadAsArrayBuffer(packets, callback);
  }

  if (!packets.length) {
    return callback('0:');
  }

  function setLengthHeader(message) {
    return message.length + ':' + message;
  }

  function encodeOne(packet, doneCallback) {
    exports.encodePacket(packet, !isBinary ? false : supportsBinary, false, function(message) {
      doneCallback(null, setLengthHeader(message));
    });
  }

  map(packets, encodeOne, function(err, results) {
    return callback(results.join(''));
  });
};

/**
 * Async array map using after
 */

function map(ary, each, done) {
  var result = new Array(ary.length);
  var next = after_1(ary.length, done);

  var eachWithIndex = function(i, el, cb) {
    each(el, function(error, msg) {
      result[i] = msg;
      cb(error, result);
    });
  };

  for (var i = 0; i < ary.length; i++) {
    eachWithIndex(i, ary[i], next);
  }
}

/*
 * Decodes data when a payload is maybe expected. Possible binary contents are
 * decoded from their base64 representation
 *
 * @param {String} data, callback method
 * @api public
 */

exports.decodePayload = function (data, binaryType, callback) {
  if (typeof data !== 'string') {
    return exports.decodePayloadAsBinary(data, binaryType, callback);
  }

  if (typeof binaryType === 'function') {
    callback = binaryType;
    binaryType = null;
  }

  var packet;
  if (data === '') {
    // parser error - ignoring payload
    return callback(err, 0, 1);
  }

  var length = '', n, msg;

  for (var i = 0, l = data.length; i < l; i++) {
    var chr = data.charAt(i);

    if (chr !== ':') {
      length += chr;
      continue;
    }

    if (length === '' || (length != (n = Number(length)))) {
      // parser error - ignoring payload
      return callback(err, 0, 1);
    }

    msg = data.substr(i + 1, n);

    if (length != msg.length) {
      // parser error - ignoring payload
      return callback(err, 0, 1);
    }

    if (msg.length) {
      packet = exports.decodePacket(msg, binaryType, false);

      if (err.type === packet.type && err.data === packet.data) {
        // parser error in individual packet - ignoring payload
        return callback(err, 0, 1);
      }

      var ret = callback(packet, i + n, l);
      if (false === ret) return;
    }

    // advance cursor
    i += n;
    length = '';
  }

  if (length !== '') {
    // parser error - ignoring payload
    return callback(err, 0, 1);
  }

};

/**
 * Encodes multiple messages (payload) as binary.
 *
 * <1 = binary, 0 = string><number from 0-9><number from 0-9>[...]<number
 * 255><data>
 *
 * Example:
 * 1 3 255 1 2 3, if the binary contents are interpreted as 8 bit integers
 *
 * @param {Array} packets
 * @return {ArrayBuffer} encoded payload
 * @api private
 */

exports.encodePayloadAsArrayBuffer = function(packets, callback) {
  if (!packets.length) {
    return callback(new ArrayBuffer(0));
  }

  function encodeOne(packet, doneCallback) {
    exports.encodePacket(packet, true, true, function(data) {
      return doneCallback(null, data);
    });
  }

  map(packets, encodeOne, function(err, encodedPackets) {
    var totalLength = encodedPackets.reduce(function(acc, p) {
      var len;
      if (typeof p === 'string'){
        len = p.length;
      } else {
        len = p.byteLength;
      }
      return acc + len.toString().length + len + 2; // string/binary identifier + separator = 2
    }, 0);

    var resultArray = new Uint8Array(totalLength);

    var bufferIndex = 0;
    encodedPackets.forEach(function(p) {
      var isString = typeof p === 'string';
      var ab = p;
      if (isString) {
        var view = new Uint8Array(p.length);
        for (var i = 0; i < p.length; i++) {
          view[i] = p.charCodeAt(i);
        }
        ab = view.buffer;
      }

      if (isString) { // not true binary
        resultArray[bufferIndex++] = 0;
      } else { // true binary
        resultArray[bufferIndex++] = 1;
      }

      var lenStr = ab.byteLength.toString();
      for (var i = 0; i < lenStr.length; i++) {
        resultArray[bufferIndex++] = parseInt(lenStr[i]);
      }
      resultArray[bufferIndex++] = 255;

      var view = new Uint8Array(ab);
      for (var i = 0; i < view.length; i++) {
        resultArray[bufferIndex++] = view[i];
      }
    });

    return callback(resultArray.buffer);
  });
};

/**
 * Encode as Blob
 */

exports.encodePayloadAsBlob = function(packets, callback) {
  function encodeOne(packet, doneCallback) {
    exports.encodePacket(packet, true, true, function(encoded) {
      var binaryIdentifier = new Uint8Array(1);
      binaryIdentifier[0] = 1;
      if (typeof encoded === 'string') {
        var view = new Uint8Array(encoded.length);
        for (var i = 0; i < encoded.length; i++) {
          view[i] = encoded.charCodeAt(i);
        }
        encoded = view.buffer;
        binaryIdentifier[0] = 0;
      }

      var len = (encoded instanceof ArrayBuffer)
        ? encoded.byteLength
        : encoded.size;

      var lenStr = len.toString();
      var lengthAry = new Uint8Array(lenStr.length + 1);
      for (var i = 0; i < lenStr.length; i++) {
        lengthAry[i] = parseInt(lenStr[i]);
      }
      lengthAry[lenStr.length] = 255;

      if (blob) {
        var blob$1 = new blob([binaryIdentifier.buffer, lengthAry.buffer, encoded]);
        doneCallback(null, blob$1);
      }
    });
  }

  map(packets, encodeOne, function(err, results) {
    return callback(new blob(results));
  });
};

/*
 * Decodes data when a payload is maybe expected. Strings are decoded by
 * interpreting each byte as a key code for entries marked to start with 0. See
 * description of encodePayloadAsBinary
 *
 * @param {ArrayBuffer} data, callback method
 * @api public
 */

exports.decodePayloadAsBinary = function (data, binaryType, callback) {
  if (typeof binaryType === 'function') {
    callback = binaryType;
    binaryType = null;
  }

  var bufferTail = data;
  var buffers = [];

  while (bufferTail.byteLength > 0) {
    var tailArray = new Uint8Array(bufferTail);
    var isString = tailArray[0] === 0;
    var msgLength = '';

    for (var i = 1; ; i++) {
      if (tailArray[i] === 255) break;

      // 310 = char length of Number.MAX_VALUE
      if (msgLength.length > 310) {
        return callback(err, 0, 1);
      }

      msgLength += tailArray[i];
    }

    bufferTail = arraybuffer_slice(bufferTail, 2 + msgLength.length);
    msgLength = parseInt(msgLength);

    var msg = arraybuffer_slice(bufferTail, 0, msgLength);
    if (isString) {
      try {
        msg = String.fromCharCode.apply(null, new Uint8Array(msg));
      } catch (e) {
        // iPhone Safari doesn't let you apply to typed arrays
        var typed = new Uint8Array(msg);
        msg = '';
        for (var i = 0; i < typed.length; i++) {
          msg += String.fromCharCode(typed[i]);
        }
      }
    }

    buffers.push(msg);
    bufferTail = arraybuffer_slice(bufferTail, msgLength);
  }

  var total = buffers.length;
  buffers.forEach(function(buffer, i) {
    callback(exports.decodePacket(buffer, binaryType, true), i, total);
  });
};
});

var componentEmitter$1 = _commonjsHelpers.createCommonjsModule(function (module) {
/**
 * Expose `Emitter`.
 */

{
  module.exports = Emitter;
}

/**
 * Initialize a new `Emitter`.
 *
 * @api public
 */

function Emitter(obj) {
  if (obj) return mixin(obj);
}
/**
 * Mixin the emitter properties.
 *
 * @param {Object} obj
 * @return {Object}
 * @api private
 */

function mixin(obj) {
  for (var key in Emitter.prototype) {
    obj[key] = Emitter.prototype[key];
  }
  return obj;
}

/**
 * Listen on the given `event` with `fn`.
 *
 * @param {String} event
 * @param {Function} fn
 * @return {Emitter}
 * @api public
 */

Emitter.prototype.on =
Emitter.prototype.addEventListener = function(event, fn){
  this._callbacks = this._callbacks || {};
  (this._callbacks['$' + event] = this._callbacks['$' + event] || [])
    .push(fn);
  return this;
};

/**
 * Adds an `event` listener that will be invoked a single
 * time then automatically removed.
 *
 * @param {String} event
 * @param {Function} fn
 * @return {Emitter}
 * @api public
 */

Emitter.prototype.once = function(event, fn){
  function on() {
    this.off(event, on);
    fn.apply(this, arguments);
  }

  on.fn = fn;
  this.on(event, on);
  return this;
};

/**
 * Remove the given callback for `event` or all
 * registered callbacks.
 *
 * @param {String} event
 * @param {Function} fn
 * @return {Emitter}
 * @api public
 */

Emitter.prototype.off =
Emitter.prototype.removeListener =
Emitter.prototype.removeAllListeners =
Emitter.prototype.removeEventListener = function(event, fn){
  this._callbacks = this._callbacks || {};

  // all
  if (0 == arguments.length) {
    this._callbacks = {};
    return this;
  }

  // specific event
  var callbacks = this._callbacks['$' + event];
  if (!callbacks) return this;

  // remove all handlers
  if (1 == arguments.length) {
    delete this._callbacks['$' + event];
    return this;
  }

  // remove specific handler
  var cb;
  for (var i = 0; i < callbacks.length; i++) {
    cb = callbacks[i];
    if (cb === fn || cb.fn === fn) {
      callbacks.splice(i, 1);
      break;
    }
  }
  return this;
};

/**
 * Emit `event` with the given args.
 *
 * @param {String} event
 * @param {Mixed} ...
 * @return {Emitter}
 */

Emitter.prototype.emit = function(event){
  this._callbacks = this._callbacks || {};
  var args = [].slice.call(arguments, 1)
    , callbacks = this._callbacks['$' + event];

  if (callbacks) {
    callbacks = callbacks.slice(0);
    for (var i = 0, len = callbacks.length; i < len; ++i) {
      callbacks[i].apply(this, args);
    }
  }

  return this;
};

/**
 * Return array of callbacks for `event`.
 *
 * @param {String} event
 * @return {Array}
 * @api public
 */

Emitter.prototype.listeners = function(event){
  this._callbacks = this._callbacks || {};
  return this._callbacks['$' + event] || [];
};

/**
 * Check if this emitter has `event` handlers.
 *
 * @param {String} event
 * @return {Boolean}
 * @api public
 */

Emitter.prototype.hasListeners = function(event){
  return !! this.listeners(event).length;
};
});

/**
 * Module dependencies.
 */




/**
 * Module exports.
 */

var transport = Transport;

/**
 * Transport abstract constructor.
 *
 * @param {Object} options.
 * @api private
 */

function Transport (opts) {
  this.path = opts.path;
  this.hostname = opts.hostname;
  this.port = opts.port;
  this.secure = opts.secure;
  this.query = opts.query;
  this.timestampParam = opts.timestampParam;
  this.timestampRequests = opts.timestampRequests;
  this.readyState = '';
  this.agent = opts.agent || false;
  this.socket = opts.socket;
  this.enablesXDR = opts.enablesXDR;
  this.withCredentials = opts.withCredentials;

  // SSL options for Node.js client
  this.pfx = opts.pfx;
  this.key = opts.key;
  this.passphrase = opts.passphrase;
  this.cert = opts.cert;
  this.ca = opts.ca;
  this.ciphers = opts.ciphers;
  this.rejectUnauthorized = opts.rejectUnauthorized;
  this.forceNode = opts.forceNode;

  // results of ReactNative environment detection
  this.isReactNative = opts.isReactNative;

  // other options for Node.js client
  this.extraHeaders = opts.extraHeaders;
  this.localAddress = opts.localAddress;
}

/**
 * Mix in `Emitter`.
 */

componentEmitter$1(Transport.prototype);

/**
 * Emits an error.
 *
 * @param {String} str
 * @return {Transport} for chaining
 * @api public
 */

Transport.prototype.onError = function (msg, desc) {
  var err = new Error(msg);
  err.type = 'TransportError';
  err.description = desc;
  this.emit('error', err);
  return this;
};

/**
 * Opens the transport.
 *
 * @api public
 */

Transport.prototype.open = function () {
  if ('closed' === this.readyState || '' === this.readyState) {
    this.readyState = 'opening';
    this.doOpen();
  }

  return this;
};

/**
 * Closes the transport.
 *
 * @api private
 */

Transport.prototype.close = function () {
  if ('opening' === this.readyState || 'open' === this.readyState) {
    this.doClose();
    this.onClose();
  }

  return this;
};

/**
 * Sends multiple packets.
 *
 * @param {Array} packets
 * @api private
 */

Transport.prototype.send = function (packets) {
  if ('open' === this.readyState) {
    this.write(packets);
  } else {
    throw new Error('Transport not open');
  }
};

/**
 * Called upon open
 *
 * @api private
 */

Transport.prototype.onOpen = function () {
  this.readyState = 'open';
  this.writable = true;
  this.emit('open');
};

/**
 * Called with data.
 *
 * @param {String} data
 * @api private
 */

Transport.prototype.onData = function (data) {
  var packet = browser$2.decodePacket(data, this.socket.binaryType);
  this.onPacket(packet);
};

/**
 * Called with a decoded packet.
 */

Transport.prototype.onPacket = function (packet) {
  this.emit('packet', packet);
};

/**
 * Called upon close.
 *
 * @api private
 */

Transport.prototype.onClose = function () {
  this.readyState = 'closed';
  this.emit('close');
};

/**
 * Compiles a querystring
 * Returns string representation of the object
 *
 * @param {Object}
 * @api private
 */

var encode = function (obj) {
  var str = '';

  for (var i in obj) {
    if (obj.hasOwnProperty(i)) {
      if (str.length) str += '&';
      str += encodeURIComponent(i) + '=' + encodeURIComponent(obj[i]);
    }
  }

  return str;
};

/**
 * Parses a simple querystring into an object
 *
 * @param {String} qs
 * @api private
 */

var decode = function(qs){
  var qry = {};
  var pairs = qs.split('&');
  for (var i = 0, l = pairs.length; i < l; i++) {
    var pair = pairs[i].split('=');
    qry[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1]);
  }
  return qry;
};

var parseqs = {
	encode: encode,
	decode: decode
};

var componentInherit = function(a, b){
  var fn = function(){};
  fn.prototype = b.prototype;
  a.prototype = new fn;
  a.prototype.constructor = a;
};

var alphabet = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_'.split('')
  , length = 64
  , map = {}
  , seed = 0
  , i = 0
  , prev;

/**
 * Return a string representing the specified number.
 *
 * @param {Number} num The number to convert.
 * @returns {String} The string representation of the number.
 * @api public
 */
function encode$1(num) {
  var encoded = '';

  do {
    encoded = alphabet[num % length] + encoded;
    num = Math.floor(num / length);
  } while (num > 0);

  return encoded;
}

/**
 * Return the integer value specified by the given string.
 *
 * @param {String} str The string to convert.
 * @returns {Number} The integer value represented by the string.
 * @api public
 */
function decode$1(str) {
  var decoded = 0;

  for (i = 0; i < str.length; i++) {
    decoded = decoded * length + map[str.charAt(i)];
  }

  return decoded;
}

/**
 * Yeast: A tiny growing id generator.
 *
 * @returns {String} A unique id.
 * @api public
 */
function yeast() {
  var now = encode$1(+new Date());

  if (now !== prev) return seed = 0, prev = now;
  return now +'.'+ encode$1(seed++);
}

//
// Map each character to its index.
//
for (; i < length; i++) map[alphabet[i]] = i;

//
// Expose the `yeast`, `encode` and `decode` functions.
//
yeast.encode = encode$1;
yeast.decode = decode$1;
var yeast_1 = yeast;

/**
 * Helpers.
 */

var s$2 = 1000;
var m$2 = s$2 * 60;
var h$2 = m$2 * 60;
var d$2 = h$2 * 24;
var w$1 = d$2 * 7;
var y$2 = d$2 * 365.25;

/**
 * Parse or format the given `val`.
 *
 * Options:
 *
 *  - `long` verbose formatting [false]
 *
 * @param {String|Number} val
 * @param {Object} [options]
 * @throws {Error} throw an error if val is not a non-empty string or a number
 * @return {String|Number}
 * @api public
 */

var ms$2 = function(val, options) {
  options = options || {};
  var type = typeof val;
  if (type === 'string' && val.length > 0) {
    return parse$2(val);
  } else if (type === 'number' && isFinite(val)) {
    return options.long ? fmtLong$2(val) : fmtShort$2(val);
  }
  throw new Error(
    'val is not a non-empty string or a valid number. val=' +
      JSON.stringify(val)
  );
};

/**
 * Parse the given `str` and return milliseconds.
 *
 * @param {String} str
 * @return {Number}
 * @api private
 */

function parse$2(str) {
  str = String(str);
  if (str.length > 100) {
    return;
  }
  var match = /^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(
    str
  );
  if (!match) {
    return;
  }
  var n = parseFloat(match[1]);
  var type = (match[2] || 'ms').toLowerCase();
  switch (type) {
    case 'years':
    case 'year':
    case 'yrs':
    case 'yr':
    case 'y':
      return n * y$2;
    case 'weeks':
    case 'week':
    case 'w':
      return n * w$1;
    case 'days':
    case 'day':
    case 'd':
      return n * d$2;
    case 'hours':
    case 'hour':
    case 'hrs':
    case 'hr':
    case 'h':
      return n * h$2;
    case 'minutes':
    case 'minute':
    case 'mins':
    case 'min':
    case 'm':
      return n * m$2;
    case 'seconds':
    case 'second':
    case 'secs':
    case 'sec':
    case 's':
      return n * s$2;
    case 'milliseconds':
    case 'millisecond':
    case 'msecs':
    case 'msec':
    case 'ms':
      return n;
    default:
      return undefined;
  }
}

/**
 * Short format for `ms`.
 *
 * @param {Number} ms
 * @return {String}
 * @api private
 */

function fmtShort$2(ms) {
  var msAbs = Math.abs(ms);
  if (msAbs >= d$2) {
    return Math.round(ms / d$2) + 'd';
  }
  if (msAbs >= h$2) {
    return Math.round(ms / h$2) + 'h';
  }
  if (msAbs >= m$2) {
    return Math.round(ms / m$2) + 'm';
  }
  if (msAbs >= s$2) {
    return Math.round(ms / s$2) + 's';
  }
  return ms + 'ms';
}

/**
 * Long format for `ms`.
 *
 * @param {Number} ms
 * @return {String}
 * @api private
 */

function fmtLong$2(ms) {
  var msAbs = Math.abs(ms);
  if (msAbs >= d$2) {
    return plural$2(ms, msAbs, d$2, 'day');
  }
  if (msAbs >= h$2) {
    return plural$2(ms, msAbs, h$2, 'hour');
  }
  if (msAbs >= m$2) {
    return plural$2(ms, msAbs, m$2, 'minute');
  }
  if (msAbs >= s$2) {
    return plural$2(ms, msAbs, s$2, 'second');
  }
  return ms + ' ms';
}

/**
 * Pluralization helper.
 */

function plural$2(ms, msAbs, n, name) {
  var isPlural = msAbs >= n * 1.5;
  return Math.round(ms / n) + ' ' + name + (isPlural ? 's' : '');
}

/**
 * This is the common logic for both the Node.js and web browser
 * implementations of `debug()`.
 */

function setup$1(env) {
	createDebug.debug = createDebug;
	createDebug.default = createDebug;
	createDebug.coerce = coerce;
	createDebug.disable = disable;
	createDebug.enable = enable;
	createDebug.enabled = enabled;
	createDebug.humanize = ms$2;

	Object.keys(env).forEach(key => {
		createDebug[key] = env[key];
	});

	/**
	* Active `debug` instances.
	*/
	createDebug.instances = [];

	/**
	* The currently active debug mode names, and names to skip.
	*/

	createDebug.names = [];
	createDebug.skips = [];

	/**
	* Map of special "%n" handling functions, for the debug "format" argument.
	*
	* Valid key names are a single, lower or upper-case letter, i.e. "n" and "N".
	*/
	createDebug.formatters = {};

	/**
	* Selects a color for a debug namespace
	* @param {String} namespace The namespace string for the for the debug instance to be colored
	* @return {Number|String} An ANSI color code for the given namespace
	* @api private
	*/
	function selectColor(namespace) {
		let hash = 0;

		for (let i = 0; i < namespace.length; i++) {
			hash = ((hash << 5) - hash) + namespace.charCodeAt(i);
			hash |= 0; // Convert to 32bit integer
		}

		return createDebug.colors[Math.abs(hash) % createDebug.colors.length];
	}
	createDebug.selectColor = selectColor;

	/**
	* Create a debugger with the given `namespace`.
	*
	* @param {String} namespace
	* @return {Function}
	* @api public
	*/
	function createDebug(namespace) {
		let prevTime;

		function debug(...args) {
			// Disabled?
			if (!debug.enabled) {
				return;
			}

			const self = debug;

			// Set `diff` timestamp
			const curr = Number(new Date());
			const ms = curr - (prevTime || curr);
			self.diff = ms;
			self.prev = prevTime;
			self.curr = curr;
			prevTime = curr;

			args[0] = createDebug.coerce(args[0]);

			if (typeof args[0] !== 'string') {
				// Anything else let's inspect with %O
				args.unshift('%O');
			}

			// Apply any `formatters` transformations
			let index = 0;
			args[0] = args[0].replace(/%([a-zA-Z%])/g, (match, format) => {
				// If we encounter an escaped % then don't increase the array index
				if (match === '%%') {
					return match;
				}
				index++;
				const formatter = createDebug.formatters[format];
				if (typeof formatter === 'function') {
					const val = args[index];
					match = formatter.call(self, val);

					// Now we need to remove `args[index]` since it's inlined in the `format`
					args.splice(index, 1);
					index--;
				}
				return match;
			});

			// Apply env-specific formatting (colors, etc.)
			createDebug.formatArgs.call(self, args);

			const logFn = self.log || createDebug.log;
			logFn.apply(self, args);
		}

		debug.namespace = namespace;
		debug.enabled = createDebug.enabled(namespace);
		debug.useColors = createDebug.useColors();
		debug.color = selectColor(namespace);
		debug.destroy = destroy;
		debug.extend = extend;
		// Debug.formatArgs = formatArgs;
		// debug.rawLog = rawLog;

		// env-specific initialization logic for debug instances
		if (typeof createDebug.init === 'function') {
			createDebug.init(debug);
		}

		createDebug.instances.push(debug);

		return debug;
	}

	function destroy() {
		const index = createDebug.instances.indexOf(this);
		if (index !== -1) {
			createDebug.instances.splice(index, 1);
			return true;
		}
		return false;
	}

	function extend(namespace, delimiter) {
		const newDebug = createDebug(this.namespace + (typeof delimiter === 'undefined' ? ':' : delimiter) + namespace);
		newDebug.log = this.log;
		return newDebug;
	}

	/**
	* Enables a debug mode by namespaces. This can include modes
	* separated by a colon and wildcards.
	*
	* @param {String} namespaces
	* @api public
	*/
	function enable(namespaces) {
		createDebug.save(namespaces);

		createDebug.names = [];
		createDebug.skips = [];

		let i;
		const split = (typeof namespaces === 'string' ? namespaces : '').split(/[\s,]+/);
		const len = split.length;

		for (i = 0; i < len; i++) {
			if (!split[i]) {
				// ignore empty strings
				continue;
			}

			namespaces = split[i].replace(/\*/g, '.*?');

			if (namespaces[0] === '-') {
				createDebug.skips.push(new RegExp('^' + namespaces.substr(1) + '$'));
			} else {
				createDebug.names.push(new RegExp('^' + namespaces + '$'));
			}
		}

		for (i = 0; i < createDebug.instances.length; i++) {
			const instance = createDebug.instances[i];
			instance.enabled = createDebug.enabled(instance.namespace);
		}
	}

	/**
	* Disable debug output.
	*
	* @return {String} namespaces
	* @api public
	*/
	function disable() {
		const namespaces = [
			...createDebug.names.map(toNamespace),
			...createDebug.skips.map(toNamespace).map(namespace => '-' + namespace)
		].join(',');
		createDebug.enable('');
		return namespaces;
	}

	/**
	* Returns true if the given mode name is enabled, false otherwise.
	*
	* @param {String} name
	* @return {Boolean}
	* @api public
	*/
	function enabled(name) {
		if (name[name.length - 1] === '*') {
			return true;
		}

		let i;
		let len;

		for (i = 0, len = createDebug.skips.length; i < len; i++) {
			if (createDebug.skips[i].test(name)) {
				return false;
			}
		}

		for (i = 0, len = createDebug.names.length; i < len; i++) {
			if (createDebug.names[i].test(name)) {
				return true;
			}
		}

		return false;
	}

	/**
	* Convert regexp to namespace
	*
	* @param {RegExp} regxep
	* @return {String} namespace
	* @api private
	*/
	function toNamespace(regexp) {
		return regexp.toString()
			.substring(2, regexp.toString().length - 2)
			.replace(/\.\*\?$/, '*');
	}

	/**
	* Coerce `val`.
	*
	* @param {Mixed} val
	* @return {Mixed}
	* @api private
	*/
	function coerce(val) {
		if (val instanceof Error) {
			return val.stack || val.message;
		}
		return val;
	}

	createDebug.enable(createDebug.load());

	return createDebug;
}

var common$1 = setup$1;

var browser$3 = _commonjsHelpers.createCommonjsModule(function (module, exports) {
/* eslint-env browser */

/**
 * This is the web browser implementation of `debug()`.
 */

exports.log = log;
exports.formatArgs = formatArgs;
exports.save = save;
exports.load = load;
exports.useColors = useColors;
exports.storage = localstorage();

/**
 * Colors.
 */

exports.colors = [
	'#0000CC',
	'#0000FF',
	'#0033CC',
	'#0033FF',
	'#0066CC',
	'#0066FF',
	'#0099CC',
	'#0099FF',
	'#00CC00',
	'#00CC33',
	'#00CC66',
	'#00CC99',
	'#00CCCC',
	'#00CCFF',
	'#3300CC',
	'#3300FF',
	'#3333CC',
	'#3333FF',
	'#3366CC',
	'#3366FF',
	'#3399CC',
	'#3399FF',
	'#33CC00',
	'#33CC33',
	'#33CC66',
	'#33CC99',
	'#33CCCC',
	'#33CCFF',
	'#6600CC',
	'#6600FF',
	'#6633CC',
	'#6633FF',
	'#66CC00',
	'#66CC33',
	'#9900CC',
	'#9900FF',
	'#9933CC',
	'#9933FF',
	'#99CC00',
	'#99CC33',
	'#CC0000',
	'#CC0033',
	'#CC0066',
	'#CC0099',
	'#CC00CC',
	'#CC00FF',
	'#CC3300',
	'#CC3333',
	'#CC3366',
	'#CC3399',
	'#CC33CC',
	'#CC33FF',
	'#CC6600',
	'#CC6633',
	'#CC9900',
	'#CC9933',
	'#CCCC00',
	'#CCCC33',
	'#FF0000',
	'#FF0033',
	'#FF0066',
	'#FF0099',
	'#FF00CC',
	'#FF00FF',
	'#FF3300',
	'#FF3333',
	'#FF3366',
	'#FF3399',
	'#FF33CC',
	'#FF33FF',
	'#FF6600',
	'#FF6633',
	'#FF9900',
	'#FF9933',
	'#FFCC00',
	'#FFCC33'
];

/**
 * Currently only WebKit-based Web Inspectors, Firefox >= v31,
 * and the Firebug extension (any Firefox version) are known
 * to support "%c" CSS customizations.
 *
 * TODO: add a `localStorage` variable to explicitly enable/disable colors
 */

// eslint-disable-next-line complexity
function useColors() {
	// NB: In an Electron preload script, document will be defined but not fully
	// initialized. Since we know we're in Chrome, we'll just detect this case
	// explicitly
	if (typeof window !== 'undefined' && window.process && (window.process.type === 'renderer' || window.process.__nwjs)) {
		return true;
	}

	// Internet Explorer and Edge do not support colors.
	if (typeof navigator !== 'undefined' && navigator.userAgent && navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/)) {
		return false;
	}

	// Is webkit? http://stackoverflow.com/a/16459606/376773
	// document is undefined in react-native: https://github.com/facebook/react-native/pull/1632
	return (typeof document !== 'undefined' && document.documentElement && document.documentElement.style && document.documentElement.style.WebkitAppearance) ||
		// Is firebug? http://stackoverflow.com/a/398120/376773
		(typeof window !== 'undefined' && window.console && (window.console.firebug || (window.console.exception && window.console.table))) ||
		// Is firefox >= v31?
		// https://developer.mozilla.org/en-US/docs/Tools/Web_Console#Styling_messages
		(typeof navigator !== 'undefined' && navigator.userAgent && navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/) && parseInt(RegExp.$1, 10) >= 31) ||
		// Double check webkit in userAgent just in case we are in a worker
		(typeof navigator !== 'undefined' && navigator.userAgent && navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/));
}

/**
 * Colorize log arguments if enabled.
 *
 * @api public
 */

function formatArgs(args) {
	args[0] = (this.useColors ? '%c' : '') +
		this.namespace +
		(this.useColors ? ' %c' : ' ') +
		args[0] +
		(this.useColors ? '%c ' : ' ') +
		'+' + module.exports.humanize(this.diff);

	if (!this.useColors) {
		return;
	}

	const c = 'color: ' + this.color;
	args.splice(1, 0, c, 'color: inherit');

	// The final "%c" is somewhat tricky, because there could be other
	// arguments passed either before or after the %c, so we need to
	// figure out the correct index to insert the CSS into
	let index = 0;
	let lastC = 0;
	args[0].replace(/%[a-zA-Z%]/g, match => {
		if (match === '%%') {
			return;
		}
		index++;
		if (match === '%c') {
			// We only are interested in the *last* %c
			// (the user may have provided their own)
			lastC = index;
		}
	});

	args.splice(lastC, 0, c);
}

/**
 * Invokes `console.log()` when available.
 * No-op when `console.log` is not a "function".
 *
 * @api public
 */
function log(...args) {
	// This hackery is required for IE8/9, where
	// the `console.log` function doesn't have 'apply'
	return typeof console === 'object' &&
		console.log &&
		console.log(...args);
}

/**
 * Save `namespaces`.
 *
 * @param {String} namespaces
 * @api private
 */
function save(namespaces) {
	try {
		if (namespaces) {
			exports.storage.setItem('debug', namespaces);
		} else {
			exports.storage.removeItem('debug');
		}
	} catch (error) {
		// Swallow
		// XXX (@Qix-) should we be logging these?
	}
}

/**
 * Load `namespaces`.
 *
 * @return {String} returns the previously persisted debug modes
 * @api private
 */
function load() {
	let r;
	try {
		r = exports.storage.getItem('debug');
	} catch (error) {
		// Swallow
		// XXX (@Qix-) should we be logging these?
	}

	// If debug isn't set in LS, and we're in Electron, try to load $DEBUG
	if (!r && typeof process !== 'undefined' && 'env' in process) {
		r = process.env.DEBUG;
	}

	return r;
}

/**
 * Localstorage attempts to return the localstorage.
 *
 * This is necessary because safari throws
 * when a user disables cookies/localstorage
 * and you attempt to access it.
 *
 * @return {LocalStorage}
 * @api private
 */

function localstorage() {
	try {
		// TVMLKit (Apple TV JS Runtime) does not have a window object, just localStorage in the global context
		// The Browser also has localStorage in the global context.
		return localStorage;
	} catch (error) {
		// Swallow
		// XXX (@Qix-) should we be logging these?
	}
}

module.exports = common$1(exports);

const {formatters} = module.exports;

/**
 * Map %j to `JSON.stringify()`, since no Web Inspectors do that by default.
 */

formatters.j = function (v) {
	try {
		return JSON.stringify(v);
	} catch (error) {
		return '[UnexpectedJSONParseError]: ' + error.message;
	}
};
});

/**
 * Module dependencies.
 */






var debug$2 = browser$3('engine.io-client:polling');

/**
 * Module exports.
 */

var polling = Polling;

/**
 * Is XHR2 supported?
 */

var hasXHR2 = (function () {
  var XMLHttpRequest = xmlhttprequest;
  var xhr = new XMLHttpRequest({ xdomain: false });
  return null != xhr.responseType;
})();

/**
 * Polling interface.
 *
 * @param {Object} opts
 * @api private
 */

function Polling (opts) {
  var forceBase64 = (opts && opts.forceBase64);
  if (!hasXHR2 || forceBase64) {
    this.supportsBinary = false;
  }
  transport.call(this, opts);
}

/**
 * Inherits from Transport.
 */

componentInherit(Polling, transport);

/**
 * Transport name.
 */

Polling.prototype.name = 'polling';

/**
 * Opens the socket (triggers polling). We write a PING message to determine
 * when the transport is open.
 *
 * @api private
 */

Polling.prototype.doOpen = function () {
  this.poll();
};

/**
 * Pauses polling.
 *
 * @param {Function} callback upon buffers are flushed and transport is paused
 * @api private
 */

Polling.prototype.pause = function (onPause) {
  var self = this;

  this.readyState = 'pausing';

  function pause () {
    debug$2('paused');
    self.readyState = 'paused';
    onPause();
  }

  if (this.polling || !this.writable) {
    var total = 0;

    if (this.polling) {
      debug$2('we are currently polling - waiting to pause');
      total++;
      this.once('pollComplete', function () {
        debug$2('pre-pause polling complete');
        --total || pause();
      });
    }

    if (!this.writable) {
      debug$2('we are currently writing - waiting to pause');
      total++;
      this.once('drain', function () {
        debug$2('pre-pause writing complete');
        --total || pause();
      });
    }
  } else {
    pause();
  }
};

/**
 * Starts polling cycle.
 *
 * @api public
 */

Polling.prototype.poll = function () {
  debug$2('polling');
  this.polling = true;
  this.doPoll();
  this.emit('poll');
};

/**
 * Overloads onData to detect payloads.
 *
 * @api private
 */

Polling.prototype.onData = function (data) {
  var self = this;
  debug$2('polling got data %s', data);
  var callback = function (packet, index, total) {
    // if its the first message we consider the transport open
    if ('opening' === self.readyState) {
      self.onOpen();
    }

    // if its a close packet, we close the ongoing requests
    if ('close' === packet.type) {
      self.onClose();
      return false;
    }

    // otherwise bypass onData and handle the message
    self.onPacket(packet);
  };

  // decode payload
  browser$2.decodePayload(data, this.socket.binaryType, callback);

  // if an event did not trigger closing
  if ('closed' !== this.readyState) {
    // if we got data we're not polling
    this.polling = false;
    this.emit('pollComplete');

    if ('open' === this.readyState) {
      this.poll();
    } else {
      debug$2('ignoring poll - transport state "%s"', this.readyState);
    }
  }
};

/**
 * For polling, send a close packet.
 *
 * @api private
 */

Polling.prototype.doClose = function () {
  var self = this;

  function close () {
    debug$2('writing close packet');
    self.write([{ type: 'close' }]);
  }

  if ('open' === this.readyState) {
    debug$2('transport open - closing');
    close();
  } else {
    // in case we're trying to close while
    // handshaking is in progress (GH-164)
    debug$2('transport not open - deferring close');
    this.once('open', close);
  }
};

/**
 * Writes a packets payload.
 *
 * @param {Array} data packets
 * @param {Function} drain callback
 * @api private
 */

Polling.prototype.write = function (packets) {
  var self = this;
  this.writable = false;
  var callbackfn = function () {
    self.writable = true;
    self.emit('drain');
  };

  browser$2.encodePayload(packets, this.supportsBinary, function (data) {
    self.doWrite(data, callbackfn);
  });
};

/**
 * Generates uri for connection.
 *
 * @api private
 */

Polling.prototype.uri = function () {
  var query = this.query || {};
  var schema = this.secure ? 'https' : 'http';
  var port = '';

  // cache busting is forced
  if (false !== this.timestampRequests) {
    query[this.timestampParam] = yeast_1();
  }

  if (!this.supportsBinary && !query.sid) {
    query.b64 = 1;
  }

  query = parseqs.encode(query);

  // avoid port if default for schema
  if (this.port && (('https' === schema && Number(this.port) !== 443) ||
     ('http' === schema && Number(this.port) !== 80))) {
    port = ':' + this.port;
  }

  // prepend ? to query
  if (query.length) {
    query = '?' + query;
  }

  var ipv6 = this.hostname.indexOf(':') !== -1;
  return schema + '://' + (ipv6 ? '[' + this.hostname + ']' : this.hostname) + port + this.path + query;
};

/* global attachEvent */

/**
 * Module requirements.
 */





var debug$3 = browser$3('engine.io-client:polling-xhr');


/**
 * Module exports.
 */

var pollingXhr = XHR;
var Request_1 = Request;

/**
 * Empty function
 */

function empty () {}

/**
 * XHR Polling constructor.
 *
 * @param {Object} opts
 * @api public
 */

function XHR (opts) {
  polling.call(this, opts);
  this.requestTimeout = opts.requestTimeout;
  this.extraHeaders = opts.extraHeaders;

  if (typeof location !== 'undefined') {
    var isSSL = 'https:' === location.protocol;
    var port = location.port;

    // some user agents have empty `location.port`
    if (!port) {
      port = isSSL ? 443 : 80;
    }

    this.xd = (typeof location !== 'undefined' && opts.hostname !== location.hostname) ||
      port !== opts.port;
    this.xs = opts.secure !== isSSL;
  }
}

/**
 * Inherits from Polling.
 */

componentInherit(XHR, polling);

/**
 * XHR supports binary
 */

XHR.prototype.supportsBinary = true;

/**
 * Creates a request.
 *
 * @param {String} method
 * @api private
 */

XHR.prototype.request = function (opts) {
  opts = opts || {};
  opts.uri = this.uri();
  opts.xd = this.xd;
  opts.xs = this.xs;
  opts.agent = this.agent || false;
  opts.supportsBinary = this.supportsBinary;
  opts.enablesXDR = this.enablesXDR;
  opts.withCredentials = this.withCredentials;

  // SSL options for Node.js client
  opts.pfx = this.pfx;
  opts.key = this.key;
  opts.passphrase = this.passphrase;
  opts.cert = this.cert;
  opts.ca = this.ca;
  opts.ciphers = this.ciphers;
  opts.rejectUnauthorized = this.rejectUnauthorized;
  opts.requestTimeout = this.requestTimeout;

  // other options for Node.js client
  opts.extraHeaders = this.extraHeaders;

  return new Request(opts);
};

/**
 * Sends data.
 *
 * @param {String} data to send.
 * @param {Function} called upon flush.
 * @api private
 */

XHR.prototype.doWrite = function (data, fn) {
  var isBinary = typeof data !== 'string' && data !== undefined;
  var req = this.request({ method: 'POST', data: data, isBinary: isBinary });
  var self = this;
  req.on('success', fn);
  req.on('error', function (err) {
    self.onError('xhr post error', err);
  });
  this.sendXhr = req;
};

/**
 * Starts a poll cycle.
 *
 * @api private
 */

XHR.prototype.doPoll = function () {
  debug$3('xhr poll');
  var req = this.request();
  var self = this;
  req.on('data', function (data) {
    self.onData(data);
  });
  req.on('error', function (err) {
    self.onError('xhr poll error', err);
  });
  this.pollXhr = req;
};

/**
 * Request constructor
 *
 * @param {Object} options
 * @api public
 */

function Request (opts) {
  this.method = opts.method || 'GET';
  this.uri = opts.uri;
  this.xd = !!opts.xd;
  this.xs = !!opts.xs;
  this.async = false !== opts.async;
  this.data = undefined !== opts.data ? opts.data : null;
  this.agent = opts.agent;
  this.isBinary = opts.isBinary;
  this.supportsBinary = opts.supportsBinary;
  this.enablesXDR = opts.enablesXDR;
  this.withCredentials = opts.withCredentials;
  this.requestTimeout = opts.requestTimeout;

  // SSL options for Node.js client
  this.pfx = opts.pfx;
  this.key = opts.key;
  this.passphrase = opts.passphrase;
  this.cert = opts.cert;
  this.ca = opts.ca;
  this.ciphers = opts.ciphers;
  this.rejectUnauthorized = opts.rejectUnauthorized;

  // other options for Node.js client
  this.extraHeaders = opts.extraHeaders;

  this.create();
}

/**
 * Mix in `Emitter`.
 */

componentEmitter$1(Request.prototype);

/**
 * Creates the XHR object and sends the request.
 *
 * @api private
 */

Request.prototype.create = function () {
  var opts = { agent: this.agent, xdomain: this.xd, xscheme: this.xs, enablesXDR: this.enablesXDR };

  // SSL options for Node.js client
  opts.pfx = this.pfx;
  opts.key = this.key;
  opts.passphrase = this.passphrase;
  opts.cert = this.cert;
  opts.ca = this.ca;
  opts.ciphers = this.ciphers;
  opts.rejectUnauthorized = this.rejectUnauthorized;

  var xhr = this.xhr = new xmlhttprequest(opts);
  var self = this;

  try {
    debug$3('xhr open %s: %s', this.method, this.uri);
    xhr.open(this.method, this.uri, this.async);
    try {
      if (this.extraHeaders) {
        xhr.setDisableHeaderCheck && xhr.setDisableHeaderCheck(true);
        for (var i in this.extraHeaders) {
          if (this.extraHeaders.hasOwnProperty(i)) {
            xhr.setRequestHeader(i, this.extraHeaders[i]);
          }
        }
      }
    } catch (e) {}

    if ('POST' === this.method) {
      try {
        if (this.isBinary) {
          xhr.setRequestHeader('Content-type', 'application/octet-stream');
        } else {
          xhr.setRequestHeader('Content-type', 'text/plain;charset=UTF-8');
        }
      } catch (e) {}
    }

    try {
      xhr.setRequestHeader('Accept', '*/*');
    } catch (e) {}

    // ie6 check
    if ('withCredentials' in xhr) {
      xhr.withCredentials = this.withCredentials;
    }

    if (this.requestTimeout) {
      xhr.timeout = this.requestTimeout;
    }

    if (this.hasXDR()) {
      xhr.onload = function () {
        self.onLoad();
      };
      xhr.onerror = function () {
        self.onError(xhr.responseText);
      };
    } else {
      xhr.onreadystatechange = function () {
        if (xhr.readyState === 2) {
          try {
            var contentType = xhr.getResponseHeader('Content-Type');
            if (self.supportsBinary && contentType === 'application/octet-stream' || contentType === 'application/octet-stream; charset=UTF-8') {
              xhr.responseType = 'arraybuffer';
            }
          } catch (e) {}
        }
        if (4 !== xhr.readyState) return;
        if (200 === xhr.status || 1223 === xhr.status) {
          self.onLoad();
        } else {
          // make sure the `error` event handler that's user-set
          // does not throw in the same tick and gets caught here
          setTimeout(function () {
            self.onError(typeof xhr.status === 'number' ? xhr.status : 0);
          }, 0);
        }
      };
    }

    debug$3('xhr data %s', this.data);
    xhr.send(this.data);
  } catch (e) {
    // Need to defer since .create() is called directly fhrom the constructor
    // and thus the 'error' event can only be only bound *after* this exception
    // occurs.  Therefore, also, we cannot throw here at all.
    setTimeout(function () {
      self.onError(e);
    }, 0);
    return;
  }

  if (typeof document !== 'undefined') {
    this.index = Request.requestsCount++;
    Request.requests[this.index] = this;
  }
};

/**
 * Called upon successful response.
 *
 * @api private
 */

Request.prototype.onSuccess = function () {
  this.emit('success');
  this.cleanup();
};

/**
 * Called if we have data.
 *
 * @api private
 */

Request.prototype.onData = function (data) {
  this.emit('data', data);
  this.onSuccess();
};

/**
 * Called upon error.
 *
 * @api private
 */

Request.prototype.onError = function (err) {
  this.emit('error', err);
  this.cleanup(true);
};

/**
 * Cleans up house.
 *
 * @api private
 */

Request.prototype.cleanup = function (fromError) {
  if ('undefined' === typeof this.xhr || null === this.xhr) {
    return;
  }
  // xmlhttprequest
  if (this.hasXDR()) {
    this.xhr.onload = this.xhr.onerror = empty;
  } else {
    this.xhr.onreadystatechange = empty;
  }

  if (fromError) {
    try {
      this.xhr.abort();
    } catch (e) {}
  }

  if (typeof document !== 'undefined') {
    delete Request.requests[this.index];
  }

  this.xhr = null;
};

/**
 * Called upon load.
 *
 * @api private
 */

Request.prototype.onLoad = function () {
  var data;
  try {
    var contentType;
    try {
      contentType = this.xhr.getResponseHeader('Content-Type');
    } catch (e) {}
    if (contentType === 'application/octet-stream' || contentType === 'application/octet-stream; charset=UTF-8') {
      data = this.xhr.response || this.xhr.responseText;
    } else {
      data = this.xhr.responseText;
    }
  } catch (e) {
    this.onError(e);
  }
  if (null != data) {
    this.onData(data);
  }
};

/**
 * Check if it has XDomainRequest.
 *
 * @api private
 */

Request.prototype.hasXDR = function () {
  return typeof XDomainRequest !== 'undefined' && !this.xs && this.enablesXDR;
};

/**
 * Aborts the request.
 *
 * @api public
 */

Request.prototype.abort = function () {
  this.cleanup();
};

/**
 * Aborts pending requests when unloading the window. This is needed to prevent
 * memory leaks (e.g. when using IE) and to ensure that no spurious error is
 * emitted.
 */

Request.requestsCount = 0;
Request.requests = {};

if (typeof document !== 'undefined') {
  if (typeof attachEvent === 'function') {
    attachEvent('onunload', unloadHandler);
  } else if (typeof addEventListener === 'function') {
    var terminationEvent = 'onpagehide' in globalThis_browser ? 'pagehide' : 'unload';
    addEventListener(terminationEvent, unloadHandler, false);
  }
}

function unloadHandler () {
  for (var i in Request.requests) {
    if (Request.requests.hasOwnProperty(i)) {
      Request.requests[i].abort();
    }
  }
}
pollingXhr.Request = Request_1;

/**
 * Module requirements.
 */





/**
 * Module exports.
 */

var pollingJsonp = JSONPPolling;

/**
 * Cached regular expressions.
 */

var rNewline = /\n/g;
var rEscapedNewline = /\\n/g;

/**
 * Global JSONP callbacks.
 */

var callbacks;

/**
 * Noop.
 */

function empty$1 () { }

/**
 * JSONP Polling constructor.
 *
 * @param {Object} opts.
 * @api public
 */

function JSONPPolling (opts) {
  polling.call(this, opts);

  this.query = this.query || {};

  // define global callbacks array if not present
  // we do this here (lazily) to avoid unneeded global pollution
  if (!callbacks) {
    // we need to consider multiple engines in the same page
    callbacks = globalThis_browser.___eio = (globalThis_browser.___eio || []);
  }

  // callback identifier
  this.index = callbacks.length;

  // add callback to jsonp global
  var self = this;
  callbacks.push(function (msg) {
    self.onData(msg);
  });

  // append to query string
  this.query.j = this.index;

  // prevent spurious errors from being emitted when the window is unloaded
  if (typeof addEventListener === 'function') {
    addEventListener('beforeunload', function () {
      if (self.script) self.script.onerror = empty$1;
    }, false);
  }
}

/**
 * Inherits from Polling.
 */

componentInherit(JSONPPolling, polling);

/*
 * JSONP only supports binary as base64 encoded strings
 */

JSONPPolling.prototype.supportsBinary = false;

/**
 * Closes the socket.
 *
 * @api private
 */

JSONPPolling.prototype.doClose = function () {
  if (this.script) {
    this.script.parentNode.removeChild(this.script);
    this.script = null;
  }

  if (this.form) {
    this.form.parentNode.removeChild(this.form);
    this.form = null;
    this.iframe = null;
  }

  polling.prototype.doClose.call(this);
};

/**
 * Starts a poll cycle.
 *
 * @api private
 */

JSONPPolling.prototype.doPoll = function () {
  var self = this;
  var script = document.createElement('script');

  if (this.script) {
    this.script.parentNode.removeChild(this.script);
    this.script = null;
  }

  script.async = true;
  script.src = this.uri();
  script.onerror = function (e) {
    self.onError('jsonp poll error', e);
  };

  var insertAt = document.getElementsByTagName('script')[0];
  if (insertAt) {
    insertAt.parentNode.insertBefore(script, insertAt);
  } else {
    (document.head || document.body).appendChild(script);
  }
  this.script = script;

  var isUAgecko = 'undefined' !== typeof navigator && /gecko/i.test(navigator.userAgent);

  if (isUAgecko) {
    setTimeout(function () {
      var iframe = document.createElement('iframe');
      document.body.appendChild(iframe);
      document.body.removeChild(iframe);
    }, 100);
  }
};

/**
 * Writes with a hidden iframe.
 *
 * @param {String} data to send
 * @param {Function} called upon flush.
 * @api private
 */

JSONPPolling.prototype.doWrite = function (data, fn) {
  var self = this;

  if (!this.form) {
    var form = document.createElement('form');
    var area = document.createElement('textarea');
    var id = this.iframeId = 'eio_iframe_' + this.index;
    var iframe;

    form.className = 'socketio';
    form.style.position = 'absolute';
    form.style.top = '-1000px';
    form.style.left = '-1000px';
    form.target = id;
    form.method = 'POST';
    form.setAttribute('accept-charset', 'utf-8');
    area.name = 'd';
    form.appendChild(area);
    document.body.appendChild(form);

    this.form = form;
    this.area = area;
  }

  this.form.action = this.uri();

  function complete () {
    initIframe();
    fn();
  }

  function initIframe () {
    if (self.iframe) {
      try {
        self.form.removeChild(self.iframe);
      } catch (e) {
        self.onError('jsonp polling iframe removal error', e);
      }
    }

    try {
      // ie6 dynamic iframes with target="" support (thanks Chris Lambacher)
      var html = '<iframe src="javascript:0" name="' + self.iframeId + '">';
      iframe = document.createElement(html);
    } catch (e) {
      iframe = document.createElement('iframe');
      iframe.name = self.iframeId;
      iframe.src = 'javascript:0';
    }

    iframe.id = self.iframeId;

    self.form.appendChild(iframe);
    self.iframe = iframe;
  }

  initIframe();

  // escape \n to prevent it from being converted into \r\n by some UAs
  // double escaping is required for escaped new lines because unescaping of new lines can be done safely on server-side
  data = data.replace(rEscapedNewline, '\\\n');
  this.area.value = data.replace(rNewline, '\\n');

  try {
    this.form.submit();
  } catch (e) {}

  if (this.iframe.attachEvent) {
    this.iframe.onreadystatechange = function () {
      if (self.iframe.readyState === 'complete') {
        complete();
      }
    };
  } else {
    this.iframe.onload = complete;
  }
};

const _nodeResolve_empty = {};

const _nodeResolve_empty$1 = /*#__PURE__*/Object.freeze({
    __proto__: null,
    'default': _nodeResolve_empty
});

/**
 * Module dependencies.
 */






var debug$4 = browser$3('engine.io-client:websocket');

var BrowserWebSocket, NodeWebSocket;

if (typeof WebSocket !== 'undefined') {
  BrowserWebSocket = WebSocket;
} else if (typeof self !== 'undefined') {
  BrowserWebSocket = self.WebSocket || self.MozWebSocket;
}

if (typeof window === 'undefined') {
  try {
    NodeWebSocket = _nodeResolve_empty$1;
  } catch (e) { }
}

/**
 * Get either the `WebSocket` or `MozWebSocket` globals
 * in the browser or try to resolve WebSocket-compatible
 * interface exposed by `ws` for Node-like environment.
 */

var WebSocketImpl = BrowserWebSocket || NodeWebSocket;

/**
 * Module exports.
 */

var websocket = WS;

/**
 * WebSocket transport constructor.
 *
 * @api {Object} connection options
 * @api public
 */

function WS (opts) {
  var forceBase64 = (opts && opts.forceBase64);
  if (forceBase64) {
    this.supportsBinary = false;
  }
  this.perMessageDeflate = opts.perMessageDeflate;
  this.usingBrowserWebSocket = BrowserWebSocket && !opts.forceNode;
  this.protocols = opts.protocols;
  if (!this.usingBrowserWebSocket) {
    WebSocketImpl = NodeWebSocket;
  }
  transport.call(this, opts);
}

/**
 * Inherits from Transport.
 */

componentInherit(WS, transport);

/**
 * Transport name.
 *
 * @api public
 */

WS.prototype.name = 'websocket';

/*
 * WebSockets support binary
 */

WS.prototype.supportsBinary = true;

/**
 * Opens socket.
 *
 * @api private
 */

WS.prototype.doOpen = function () {
  if (!this.check()) {
    // let probe timeout
    return;
  }

  var uri = this.uri();
  var protocols = this.protocols;
  var opts = {
    agent: this.agent,
    perMessageDeflate: this.perMessageDeflate
  };

  // SSL options for Node.js client
  opts.pfx = this.pfx;
  opts.key = this.key;
  opts.passphrase = this.passphrase;
  opts.cert = this.cert;
  opts.ca = this.ca;
  opts.ciphers = this.ciphers;
  opts.rejectUnauthorized = this.rejectUnauthorized;
  if (this.extraHeaders) {
    opts.headers = this.extraHeaders;
  }
  if (this.localAddress) {
    opts.localAddress = this.localAddress;
  }

  try {
    this.ws =
      this.usingBrowserWebSocket && !this.isReactNative
        ? protocols
          ? new WebSocketImpl(uri, protocols)
          : new WebSocketImpl(uri)
        : new WebSocketImpl(uri, protocols, opts);
  } catch (err) {
    return this.emit('error', err);
  }

  if (this.ws.binaryType === undefined) {
    this.supportsBinary = false;
  }

  if (this.ws.supports && this.ws.supports.binary) {
    this.supportsBinary = true;
    this.ws.binaryType = 'nodebuffer';
  } else {
    this.ws.binaryType = 'arraybuffer';
  }

  this.addEventListeners();
};

/**
 * Adds event listeners to the socket
 *
 * @api private
 */

WS.prototype.addEventListeners = function () {
  var self = this;

  this.ws.onopen = function () {
    self.onOpen();
  };
  this.ws.onclose = function () {
    self.onClose();
  };
  this.ws.onmessage = function (ev) {
    self.onData(ev.data);
  };
  this.ws.onerror = function (e) {
    self.onError('websocket error', e);
  };
};

/**
 * Writes data to socket.
 *
 * @param {Array} array of packets.
 * @api private
 */

WS.prototype.write = function (packets) {
  var self = this;
  this.writable = false;

  // encodePacket efficient as it uses WS framing
  // no need for encodePayload
  var total = packets.length;
  for (var i = 0, l = total; i < l; i++) {
    (function (packet) {
      browser$2.encodePacket(packet, self.supportsBinary, function (data) {
        if (!self.usingBrowserWebSocket) {
          // always create a new object (GH-437)
          var opts = {};
          if (packet.options) {
            opts.compress = packet.options.compress;
          }

          if (self.perMessageDeflate) {
            var len = 'string' === typeof data ? Buffer.byteLength(data) : data.length;
            if (len < self.perMessageDeflate.threshold) {
              opts.compress = false;
            }
          }
        }

        // Sometimes the websocket has already been closed but the browser didn't
        // have a chance of informing us about it yet, in that case send will
        // throw an error
        try {
          if (self.usingBrowserWebSocket) {
            // TypeError is thrown when passing the second argument on Safari
            self.ws.send(data);
          } else {
            self.ws.send(data, opts);
          }
        } catch (e) {
          debug$4('websocket closed before onclose event');
        }

        --total || done();
      });
    })(packets[i]);
  }

  function done () {
    self.emit('flush');

    // fake drain
    // defer to next tick to allow Socket to clear writeBuffer
    setTimeout(function () {
      self.writable = true;
      self.emit('drain');
    }, 0);
  }
};

/**
 * Called upon close
 *
 * @api private
 */

WS.prototype.onClose = function () {
  transport.prototype.onClose.call(this);
};

/**
 * Closes socket.
 *
 * @api private
 */

WS.prototype.doClose = function () {
  if (typeof this.ws !== 'undefined') {
    this.ws.close();
  }
};

/**
 * Generates uri for connection.
 *
 * @api private
 */

WS.prototype.uri = function () {
  var query = this.query || {};
  var schema = this.secure ? 'wss' : 'ws';
  var port = '';

  // avoid port if default for schema
  if (this.port && (('wss' === schema && Number(this.port) !== 443) ||
    ('ws' === schema && Number(this.port) !== 80))) {
    port = ':' + this.port;
  }

  // append timestamp to URI
  if (this.timestampRequests) {
    query[this.timestampParam] = yeast_1();
  }

  // communicate binary support capabilities
  if (!this.supportsBinary) {
    query.b64 = 1;
  }

  query = parseqs.encode(query);

  // prepend ? to query
  if (query.length) {
    query = '?' + query;
  }

  var ipv6 = this.hostname.indexOf(':') !== -1;
  return schema + '://' + (ipv6 ? '[' + this.hostname + ']' : this.hostname) + port + this.path + query;
};

/**
 * Feature detection for WebSocket.
 *
 * @return {Boolean} whether this transport is available.
 * @api public
 */

WS.prototype.check = function () {
  return !!WebSocketImpl && !('__initialize' in WebSocketImpl && this.name === WS.prototype.name);
};

/**
 * Module dependencies
 */






/**
 * Export transports.
 */

var polling_1 = polling$1;
var websocket_1 = websocket;

/**
 * Polling transport polymorphic constructor.
 * Decides on xhr vs jsonp based on feature detection.
 *
 * @api private
 */

function polling$1 (opts) {
  var xhr;
  var xd = false;
  var xs = false;
  var jsonp = false !== opts.jsonp;

  if (typeof location !== 'undefined') {
    var isSSL = 'https:' === location.protocol;
    var port = location.port;

    // some user agents have empty `location.port`
    if (!port) {
      port = isSSL ? 443 : 80;
    }

    xd = opts.hostname !== location.hostname || port !== opts.port;
    xs = opts.secure !== isSSL;
  }

  opts.xdomain = xd;
  opts.xscheme = xs;
  xhr = new xmlhttprequest(opts);

  if ('open' in xhr && !opts.forceJSONP) {
    return new pollingXhr(opts);
  } else {
    if (!jsonp) throw new Error('JSONP disabled');
    return new pollingJsonp(opts);
  }
}

var transports = {
	polling: polling_1,
	websocket: websocket_1
};

var indexOf = [].indexOf;

var indexof = function(arr, obj){
  if (indexOf) return arr.indexOf(obj);
  for (var i = 0; i < arr.length; ++i) {
    if (arr[i] === obj) return i;
  }
  return -1;
};

/**
 * Module dependencies.
 */



var debug$5 = browser$3('engine.io-client:socket');





/**
 * Module exports.
 */

var socket = Socket;

/**
 * Socket constructor.
 *
 * @param {String|Object} uri or options
 * @param {Object} options
 * @api public
 */

function Socket (uri, opts) {
  if (!(this instanceof Socket)) return new Socket(uri, opts);

  opts = opts || {};

  if (uri && 'object' === typeof uri) {
    opts = uri;
    uri = null;
  }

  if (uri) {
    uri = parseuri(uri);
    opts.hostname = uri.host;
    opts.secure = uri.protocol === 'https' || uri.protocol === 'wss';
    opts.port = uri.port;
    if (uri.query) opts.query = uri.query;
  } else if (opts.host) {
    opts.hostname = parseuri(opts.host).host;
  }

  this.secure = null != opts.secure ? opts.secure
    : (typeof location !== 'undefined' && 'https:' === location.protocol);

  if (opts.hostname && !opts.port) {
    // if no port is specified manually, use the protocol default
    opts.port = this.secure ? '443' : '80';
  }

  this.agent = opts.agent || false;
  this.hostname = opts.hostname ||
    (typeof location !== 'undefined' ? location.hostname : 'localhost');
  this.port = opts.port || (typeof location !== 'undefined' && location.port
      ? location.port
      : (this.secure ? 443 : 80));
  this.query = opts.query || {};
  if ('string' === typeof this.query) this.query = parseqs.decode(this.query);
  this.upgrade = false !== opts.upgrade;
  this.path = (opts.path || '/engine.io').replace(/\/$/, '') + '/';
  this.forceJSONP = !!opts.forceJSONP;
  this.jsonp = false !== opts.jsonp;
  this.forceBase64 = !!opts.forceBase64;
  this.enablesXDR = !!opts.enablesXDR;
  this.withCredentials = false !== opts.withCredentials;
  this.timestampParam = opts.timestampParam || 't';
  this.timestampRequests = opts.timestampRequests;
  this.transports = opts.transports || ['polling', 'websocket'];
  this.transportOptions = opts.transportOptions || {};
  this.readyState = '';
  this.writeBuffer = [];
  this.prevBufferLen = 0;
  this.policyPort = opts.policyPort || 843;
  this.rememberUpgrade = opts.rememberUpgrade || false;
  this.binaryType = null;
  this.onlyBinaryUpgrades = opts.onlyBinaryUpgrades;
  this.perMessageDeflate = false !== opts.perMessageDeflate ? (opts.perMessageDeflate || {}) : false;

  if (true === this.perMessageDeflate) this.perMessageDeflate = {};
  if (this.perMessageDeflate && null == this.perMessageDeflate.threshold) {
    this.perMessageDeflate.threshold = 1024;
  }

  // SSL options for Node.js client
  this.pfx = opts.pfx || null;
  this.key = opts.key || null;
  this.passphrase = opts.passphrase || null;
  this.cert = opts.cert || null;
  this.ca = opts.ca || null;
  this.ciphers = opts.ciphers || null;
  this.rejectUnauthorized = opts.rejectUnauthorized === undefined ? true : opts.rejectUnauthorized;
  this.forceNode = !!opts.forceNode;

  // detect ReactNative environment
  this.isReactNative = (typeof navigator !== 'undefined' && typeof navigator.product === 'string' && navigator.product.toLowerCase() === 'reactnative');

  // other options for Node.js or ReactNative client
  if (typeof self === 'undefined' || this.isReactNative) {
    if (opts.extraHeaders && Object.keys(opts.extraHeaders).length > 0) {
      this.extraHeaders = opts.extraHeaders;
    }

    if (opts.localAddress) {
      this.localAddress = opts.localAddress;
    }
  }

  // set on handshake
  this.id = null;
  this.upgrades = null;
  this.pingInterval = null;
  this.pingTimeout = null;

  // set on heartbeat
  this.pingIntervalTimer = null;
  this.pingTimeoutTimer = null;

  this.open();
}

Socket.priorWebsocketSuccess = false;

/**
 * Mix in `Emitter`.
 */

componentEmitter$1(Socket.prototype);

/**
 * Protocol version.
 *
 * @api public
 */

Socket.protocol = browser$2.protocol; // this is an int

/**
 * Expose deps for legacy compatibility
 * and standalone browser access.
 */

Socket.Socket = Socket;
Socket.Transport = transport;
Socket.transports = transports;
Socket.parser = browser$2;

/**
 * Creates transport of the given type.
 *
 * @param {String} transport name
 * @return {Transport}
 * @api private
 */

Socket.prototype.createTransport = function (name) {
  debug$5('creating transport "%s"', name);
  var query = clone(this.query);

  // append engine.io protocol identifier
  query.EIO = browser$2.protocol;

  // transport name
  query.transport = name;

  // per-transport options
  var options = this.transportOptions[name] || {};

  // session id if we already have one
  if (this.id) query.sid = this.id;

  var transport = new transports[name]({
    query: query,
    socket: this,
    agent: options.agent || this.agent,
    hostname: options.hostname || this.hostname,
    port: options.port || this.port,
    secure: options.secure || this.secure,
    path: options.path || this.path,
    forceJSONP: options.forceJSONP || this.forceJSONP,
    jsonp: options.jsonp || this.jsonp,
    forceBase64: options.forceBase64 || this.forceBase64,
    enablesXDR: options.enablesXDR || this.enablesXDR,
    withCredentials: options.withCredentials || this.withCredentials,
    timestampRequests: options.timestampRequests || this.timestampRequests,
    timestampParam: options.timestampParam || this.timestampParam,
    policyPort: options.policyPort || this.policyPort,
    pfx: options.pfx || this.pfx,
    key: options.key || this.key,
    passphrase: options.passphrase || this.passphrase,
    cert: options.cert || this.cert,
    ca: options.ca || this.ca,
    ciphers: options.ciphers || this.ciphers,
    rejectUnauthorized: options.rejectUnauthorized || this.rejectUnauthorized,
    perMessageDeflate: options.perMessageDeflate || this.perMessageDeflate,
    extraHeaders: options.extraHeaders || this.extraHeaders,
    forceNode: options.forceNode || this.forceNode,
    localAddress: options.localAddress || this.localAddress,
    requestTimeout: options.requestTimeout || this.requestTimeout,
    protocols: options.protocols || void (0),
    isReactNative: this.isReactNative
  });

  return transport;
};

function clone (obj) {
  var o = {};
  for (var i in obj) {
    if (obj.hasOwnProperty(i)) {
      o[i] = obj[i];
    }
  }
  return o;
}

/**
 * Initializes transport to use and starts probe.
 *
 * @api private
 */
Socket.prototype.open = function () {
  var transport;
  if (this.rememberUpgrade && Socket.priorWebsocketSuccess && this.transports.indexOf('websocket') !== -1) {
    transport = 'websocket';
  } else if (0 === this.transports.length) {
    // Emit error on next tick so it can be listened to
    var self = this;
    setTimeout(function () {
      self.emit('error', 'No transports available');
    }, 0);
    return;
  } else {
    transport = this.transports[0];
  }
  this.readyState = 'opening';

  // Retry with the next transport if the transport is disabled (jsonp: false)
  try {
    transport = this.createTransport(transport);
  } catch (e) {
    this.transports.shift();
    this.open();
    return;
  }

  transport.open();
  this.setTransport(transport);
};

/**
 * Sets the current transport. Disables the existing one (if any).
 *
 * @api private
 */

Socket.prototype.setTransport = function (transport) {
  debug$5('setting transport %s', transport.name);
  var self = this;

  if (this.transport) {
    debug$5('clearing existing transport %s', this.transport.name);
    this.transport.removeAllListeners();
  }

  // set up transport
  this.transport = transport;

  // set up transport listeners
  transport
  .on('drain', function () {
    self.onDrain();
  })
  .on('packet', function (packet) {
    self.onPacket(packet);
  })
  .on('error', function (e) {
    self.onError(e);
  })
  .on('close', function () {
    self.onClose('transport close');
  });
};

/**
 * Probes a transport.
 *
 * @param {String} transport name
 * @api private
 */

Socket.prototype.probe = function (name) {
  debug$5('probing transport "%s"', name);
  var transport = this.createTransport(name, { probe: 1 });
  var failed = false;
  var self = this;

  Socket.priorWebsocketSuccess = false;

  function onTransportOpen () {
    if (self.onlyBinaryUpgrades) {
      var upgradeLosesBinary = !this.supportsBinary && self.transport.supportsBinary;
      failed = failed || upgradeLosesBinary;
    }
    if (failed) return;

    debug$5('probe transport "%s" opened', name);
    transport.send([{ type: 'ping', data: 'probe' }]);
    transport.once('packet', function (msg) {
      if (failed) return;
      if ('pong' === msg.type && 'probe' === msg.data) {
        debug$5('probe transport "%s" pong', name);
        self.upgrading = true;
        self.emit('upgrading', transport);
        if (!transport) return;
        Socket.priorWebsocketSuccess = 'websocket' === transport.name;

        debug$5('pausing current transport "%s"', self.transport.name);
        self.transport.pause(function () {
          if (failed) return;
          if ('closed' === self.readyState) return;
          debug$5('changing transport and sending upgrade packet');

          cleanup();

          self.setTransport(transport);
          transport.send([{ type: 'upgrade' }]);
          self.emit('upgrade', transport);
          transport = null;
          self.upgrading = false;
          self.flush();
        });
      } else {
        debug$5('probe transport "%s" failed', name);
        var err = new Error('probe error');
        err.transport = transport.name;
        self.emit('upgradeError', err);
      }
    });
  }

  function freezeTransport () {
    if (failed) return;

    // Any callback called by transport should be ignored since now
    failed = true;

    cleanup();

    transport.close();
    transport = null;
  }

  // Handle any error that happens while probing
  function onerror (err) {
    var error = new Error('probe error: ' + err);
    error.transport = transport.name;

    freezeTransport();

    debug$5('probe transport "%s" failed because of error: %s', name, err);

    self.emit('upgradeError', error);
  }

  function onTransportClose () {
    onerror('transport closed');
  }

  // When the socket is closed while we're probing
  function onclose () {
    onerror('socket closed');
  }

  // When the socket is upgraded while we're probing
  function onupgrade (to) {
    if (transport && to.name !== transport.name) {
      debug$5('"%s" works - aborting "%s"', to.name, transport.name);
      freezeTransport();
    }
  }

  // Remove all listeners on the transport and on self
  function cleanup () {
    transport.removeListener('open', onTransportOpen);
    transport.removeListener('error', onerror);
    transport.removeListener('close', onTransportClose);
    self.removeListener('close', onclose);
    self.removeListener('upgrading', onupgrade);
  }

  transport.once('open', onTransportOpen);
  transport.once('error', onerror);
  transport.once('close', onTransportClose);

  this.once('close', onclose);
  this.once('upgrading', onupgrade);

  transport.open();
};

/**
 * Called when connection is deemed open.
 *
 * @api public
 */

Socket.prototype.onOpen = function () {
  debug$5('socket open');
  this.readyState = 'open';
  Socket.priorWebsocketSuccess = 'websocket' === this.transport.name;
  this.emit('open');
  this.flush();

  // we check for `readyState` in case an `open`
  // listener already closed the socket
  if ('open' === this.readyState && this.upgrade && this.transport.pause) {
    debug$5('starting upgrade probes');
    for (var i = 0, l = this.upgrades.length; i < l; i++) {
      this.probe(this.upgrades[i]);
    }
  }
};

/**
 * Handles a packet.
 *
 * @api private
 */

Socket.prototype.onPacket = function (packet) {
  if ('opening' === this.readyState || 'open' === this.readyState ||
      'closing' === this.readyState) {
    debug$5('socket receive: type "%s", data "%s"', packet.type, packet.data);

    this.emit('packet', packet);

    // Socket is live - any packet counts
    this.emit('heartbeat');

    switch (packet.type) {
      case 'open':
        this.onHandshake(JSON.parse(packet.data));
        break;

      case 'pong':
        this.setPing();
        this.emit('pong');
        break;

      case 'error':
        var err = new Error('server error');
        err.code = packet.data;
        this.onError(err);
        break;

      case 'message':
        this.emit('data', packet.data);
        this.emit('message', packet.data);
        break;
    }
  } else {
    debug$5('packet received with socket readyState "%s"', this.readyState);
  }
};

/**
 * Called upon handshake completion.
 *
 * @param {Object} handshake obj
 * @api private
 */

Socket.prototype.onHandshake = function (data) {
  this.emit('handshake', data);
  this.id = data.sid;
  this.transport.query.sid = data.sid;
  this.upgrades = this.filterUpgrades(data.upgrades);
  this.pingInterval = data.pingInterval;
  this.pingTimeout = data.pingTimeout;
  this.onOpen();
  // In case open handler closes socket
  if ('closed' === this.readyState) return;
  this.setPing();

  // Prolong liveness of socket on heartbeat
  this.removeListener('heartbeat', this.onHeartbeat);
  this.on('heartbeat', this.onHeartbeat);
};

/**
 * Resets ping timeout.
 *
 * @api private
 */

Socket.prototype.onHeartbeat = function (timeout) {
  clearTimeout(this.pingTimeoutTimer);
  var self = this;
  self.pingTimeoutTimer = setTimeout(function () {
    if ('closed' === self.readyState) return;
    self.onClose('ping timeout');
  }, timeout || (self.pingInterval + self.pingTimeout));
};

/**
 * Pings server every `this.pingInterval` and expects response
 * within `this.pingTimeout` or closes connection.
 *
 * @api private
 */

Socket.prototype.setPing = function () {
  var self = this;
  clearTimeout(self.pingIntervalTimer);
  self.pingIntervalTimer = setTimeout(function () {
    debug$5('writing ping packet - expecting pong within %sms', self.pingTimeout);
    self.ping();
    self.onHeartbeat(self.pingTimeout);
  }, self.pingInterval);
};

/**
* Sends a ping packet.
*
* @api private
*/

Socket.prototype.ping = function () {
  var self = this;
  this.sendPacket('ping', function () {
    self.emit('ping');
  });
};

/**
 * Called on `drain` event
 *
 * @api private
 */

Socket.prototype.onDrain = function () {
  this.writeBuffer.splice(0, this.prevBufferLen);

  // setting prevBufferLen = 0 is very important
  // for example, when upgrading, upgrade packet is sent over,
  // and a nonzero prevBufferLen could cause problems on `drain`
  this.prevBufferLen = 0;

  if (0 === this.writeBuffer.length) {
    this.emit('drain');
  } else {
    this.flush();
  }
};

/**
 * Flush write buffers.
 *
 * @api private
 */

Socket.prototype.flush = function () {
  if ('closed' !== this.readyState && this.transport.writable &&
    !this.upgrading && this.writeBuffer.length) {
    debug$5('flushing %d packets in socket', this.writeBuffer.length);
    this.transport.send(this.writeBuffer);
    // keep track of current length of writeBuffer
    // splice writeBuffer and callbackBuffer on `drain`
    this.prevBufferLen = this.writeBuffer.length;
    this.emit('flush');
  }
};

/**
 * Sends a message.
 *
 * @param {String} message.
 * @param {Function} callback function.
 * @param {Object} options.
 * @return {Socket} for chaining.
 * @api public
 */

Socket.prototype.write =
Socket.prototype.send = function (msg, options, fn) {
  this.sendPacket('message', msg, options, fn);
  return this;
};

/**
 * Sends a packet.
 *
 * @param {String} packet type.
 * @param {String} data.
 * @param {Object} options.
 * @param {Function} callback function.
 * @api private
 */

Socket.prototype.sendPacket = function (type, data, options, fn) {
  if ('function' === typeof data) {
    fn = data;
    data = undefined;
  }

  if ('function' === typeof options) {
    fn = options;
    options = null;
  }

  if ('closing' === this.readyState || 'closed' === this.readyState) {
    return;
  }

  options = options || {};
  options.compress = false !== options.compress;

  var packet = {
    type: type,
    data: data,
    options: options
  };
  this.emit('packetCreate', packet);
  this.writeBuffer.push(packet);
  if (fn) this.once('flush', fn);
  this.flush();
};

/**
 * Closes the connection.
 *
 * @api private
 */

Socket.prototype.close = function () {
  if ('opening' === this.readyState || 'open' === this.readyState) {
    this.readyState = 'closing';

    var self = this;

    if (this.writeBuffer.length) {
      this.once('drain', function () {
        if (this.upgrading) {
          waitForUpgrade();
        } else {
          close();
        }
      });
    } else if (this.upgrading) {
      waitForUpgrade();
    } else {
      close();
    }
  }

  function close () {
    self.onClose('forced close');
    debug$5('socket closing - telling transport to close');
    self.transport.close();
  }

  function cleanupAndClose () {
    self.removeListener('upgrade', cleanupAndClose);
    self.removeListener('upgradeError', cleanupAndClose);
    close();
  }

  function waitForUpgrade () {
    // wait for upgrade to finish since we can't send packets while pausing a transport
    self.once('upgrade', cleanupAndClose);
    self.once('upgradeError', cleanupAndClose);
  }

  return this;
};

/**
 * Called upon transport error
 *
 * @api private
 */

Socket.prototype.onError = function (err) {
  debug$5('socket error %j', err);
  Socket.priorWebsocketSuccess = false;
  this.emit('error', err);
  this.onClose('transport error', err);
};

/**
 * Called upon transport close.
 *
 * @api private
 */

Socket.prototype.onClose = function (reason, desc) {
  if ('opening' === this.readyState || 'open' === this.readyState || 'closing' === this.readyState) {
    debug$5('socket close with reason: "%s"', reason);
    var self = this;

    // clear timers
    clearTimeout(this.pingIntervalTimer);
    clearTimeout(this.pingTimeoutTimer);

    // stop event from firing again for transport
    this.transport.removeAllListeners('close');

    // ensure transport won't stay open
    this.transport.close();

    // ignore further transport communication
    this.transport.removeAllListeners();

    // set ready state
    this.readyState = 'closed';

    // clear session id
    this.id = null;

    // emit close event
    this.emit('close', reason, desc);

    // clean buffers after, so users can still
    // grab the buffers on `close` event
    self.writeBuffer = [];
    self.prevBufferLen = 0;
  }
};

/**
 * Filters upgrades, returning only those matching client transports.
 *
 * @param {Array} server upgrades
 * @api private
 *
 */

Socket.prototype.filterUpgrades = function (upgrades) {
  var filteredUpgrades = [];
  for (var i = 0, j = upgrades.length; i < j; i++) {
    if (~indexof(this.transports, upgrades[i])) filteredUpgrades.push(upgrades[i]);
  }
  return filteredUpgrades;
};

var lib = socket;

/**
 * Exports parser
 *
 * @api public
 *
 */
var parser = browser$2;
lib.parser = parser;

var componentEmitter$2 = _commonjsHelpers.createCommonjsModule(function (module) {
/**
 * Expose `Emitter`.
 */

{
  module.exports = Emitter;
}

/**
 * Initialize a new `Emitter`.
 *
 * @api public
 */

function Emitter(obj) {
  if (obj) return mixin(obj);
}
/**
 * Mixin the emitter properties.
 *
 * @param {Object} obj
 * @return {Object}
 * @api private
 */

function mixin(obj) {
  for (var key in Emitter.prototype) {
    obj[key] = Emitter.prototype[key];
  }
  return obj;
}

/**
 * Listen on the given `event` with `fn`.
 *
 * @param {String} event
 * @param {Function} fn
 * @return {Emitter}
 * @api public
 */

Emitter.prototype.on =
Emitter.prototype.addEventListener = function(event, fn){
  this._callbacks = this._callbacks || {};
  (this._callbacks['$' + event] = this._callbacks['$' + event] || [])
    .push(fn);
  return this;
};

/**
 * Adds an `event` listener that will be invoked a single
 * time then automatically removed.
 *
 * @param {String} event
 * @param {Function} fn
 * @return {Emitter}
 * @api public
 */

Emitter.prototype.once = function(event, fn){
  function on() {
    this.off(event, on);
    fn.apply(this, arguments);
  }

  on.fn = fn;
  this.on(event, on);
  return this;
};

/**
 * Remove the given callback for `event` or all
 * registered callbacks.
 *
 * @param {String} event
 * @param {Function} fn
 * @return {Emitter}
 * @api public
 */

Emitter.prototype.off =
Emitter.prototype.removeListener =
Emitter.prototype.removeAllListeners =
Emitter.prototype.removeEventListener = function(event, fn){
  this._callbacks = this._callbacks || {};

  // all
  if (0 == arguments.length) {
    this._callbacks = {};
    return this;
  }

  // specific event
  var callbacks = this._callbacks['$' + event];
  if (!callbacks) return this;

  // remove all handlers
  if (1 == arguments.length) {
    delete this._callbacks['$' + event];
    return this;
  }

  // remove specific handler
  var cb;
  for (var i = 0; i < callbacks.length; i++) {
    cb = callbacks[i];
    if (cb === fn || cb.fn === fn) {
      callbacks.splice(i, 1);
      break;
    }
  }
  return this;
};

/**
 * Emit `event` with the given args.
 *
 * @param {String} event
 * @param {Mixed} ...
 * @return {Emitter}
 */

Emitter.prototype.emit = function(event){
  this._callbacks = this._callbacks || {};
  var args = [].slice.call(arguments, 1)
    , callbacks = this._callbacks['$' + event];

  if (callbacks) {
    callbacks = callbacks.slice(0);
    for (var i = 0, len = callbacks.length; i < len; ++i) {
      callbacks[i].apply(this, args);
    }
  }

  return this;
};

/**
 * Return array of callbacks for `event`.
 *
 * @param {String} event
 * @return {Array}
 * @api public
 */

Emitter.prototype.listeners = function(event){
  this._callbacks = this._callbacks || {};
  return this._callbacks['$' + event] || [];
};

/**
 * Check if this emitter has `event` handlers.
 *
 * @param {String} event
 * @return {Boolean}
 * @api public
 */

Emitter.prototype.hasListeners = function(event){
  return !! this.listeners(event).length;
};
});

var toArray_1 = toArray;

function toArray(list, index) {
    var array = [];

    index = index || 0;

    for (var i = index || 0; i < list.length; i++) {
        array[i - index] = list[i];
    }

    return array
}

/**
 * Module exports.
 */

var on_1 = on;

/**
 * Helper for subscriptions.
 *
 * @param {Object|EventEmitter} obj with `Emitter` mixin or `EventEmitter`
 * @param {String} event name
 * @param {Function} callback
 * @api public
 */

function on (obj, ev, fn) {
  obj.on(ev, fn);
  return {
    destroy: function () {
      obj.removeListener(ev, fn);
    }
  };
}

/**
 * Slice reference.
 */

var slice = [].slice;

/**
 * Bind `obj` to `fn`.
 *
 * @param {Object} obj
 * @param {Function|String} fn or string
 * @return {Function}
 * @api public
 */

var componentBind = function(obj, fn){
  if ('string' == typeof fn) fn = obj[fn];
  if ('function' != typeof fn) throw new Error('bind() requires a function');
  var args = slice.call(arguments, 2);
  return function(){
    return fn.apply(obj, args.concat(slice.call(arguments)));
  }
};

var socket$1 = _commonjsHelpers.createCommonjsModule(function (module, exports) {
/**
 * Module dependencies.
 */






var debug = browser('socket.io-client:socket');



/**
 * Module exports.
 */

module.exports = exports = Socket;

/**
 * Internal events (blacklisted).
 * These events can't be emitted by the user.
 *
 * @api private
 */

var events = {
  connect: 1,
  connect_error: 1,
  connect_timeout: 1,
  connecting: 1,
  disconnect: 1,
  error: 1,
  reconnect: 1,
  reconnect_attempt: 1,
  reconnect_failed: 1,
  reconnect_error: 1,
  reconnecting: 1,
  ping: 1,
  pong: 1
};

/**
 * Shortcut to `Emitter#emit`.
 */

var emit = componentEmitter$2.prototype.emit;

/**
 * `Socket` constructor.
 *
 * @api public
 */

function Socket (io, nsp, opts) {
  this.io = io;
  this.nsp = nsp;
  this.json = this; // compat
  this.ids = 0;
  this.acks = {};
  this.receiveBuffer = [];
  this.sendBuffer = [];
  this.connected = false;
  this.disconnected = true;
  this.flags = {};
  if (opts && opts.query) {
    this.query = opts.query;
  }
  if (this.io.autoConnect) this.open();
}

/**
 * Mix in `Emitter`.
 */

componentEmitter$2(Socket.prototype);

/**
 * Subscribe to open, close and packet events
 *
 * @api private
 */

Socket.prototype.subEvents = function () {
  if (this.subs) return;

  var io = this.io;
  this.subs = [
    on_1(io, 'open', componentBind(this, 'onopen')),
    on_1(io, 'packet', componentBind(this, 'onpacket')),
    on_1(io, 'close', componentBind(this, 'onclose'))
  ];
};

/**
 * "Opens" the socket.
 *
 * @api public
 */

Socket.prototype.open =
Socket.prototype.connect = function () {
  if (this.connected) return this;

  this.subEvents();
  this.io.open(); // ensure open
  if ('open' === this.io.readyState) this.onopen();
  this.emit('connecting');
  return this;
};

/**
 * Sends a `message` event.
 *
 * @return {Socket} self
 * @api public
 */

Socket.prototype.send = function () {
  var args = toArray_1(arguments);
  args.unshift('message');
  this.emit.apply(this, args);
  return this;
};

/**
 * Override `emit`.
 * If the event is in `events`, it's emitted normally.
 *
 * @param {String} event name
 * @return {Socket} self
 * @api public
 */

Socket.prototype.emit = function (ev) {
  if (events.hasOwnProperty(ev)) {
    emit.apply(this, arguments);
    return this;
  }

  var args = toArray_1(arguments);
  var packet = {
    type: (this.flags.binary !== undefined ? this.flags.binary : hasBinary2(args)) ? socket_ioParser.BINARY_EVENT : socket_ioParser.EVENT,
    data: args
  };

  packet.options = {};
  packet.options.compress = !this.flags || false !== this.flags.compress;

  // event ack callback
  if ('function' === typeof args[args.length - 1]) {
    debug('emitting packet with ack id %d', this.ids);
    this.acks[this.ids] = args.pop();
    packet.id = this.ids++;
  }

  if (this.connected) {
    this.packet(packet);
  } else {
    this.sendBuffer.push(packet);
  }

  this.flags = {};

  return this;
};

/**
 * Sends a packet.
 *
 * @param {Object} packet
 * @api private
 */

Socket.prototype.packet = function (packet) {
  packet.nsp = this.nsp;
  this.io.packet(packet);
};

/**
 * Called upon engine `open`.
 *
 * @api private
 */

Socket.prototype.onopen = function () {
  debug('transport is open - connecting');

  // write connect packet if necessary
  if ('/' !== this.nsp) {
    if (this.query) {
      var query = typeof this.query === 'object' ? parseqs.encode(this.query) : this.query;
      debug('sending connect packet with query %s', query);
      this.packet({type: socket_ioParser.CONNECT, query: query});
    } else {
      this.packet({type: socket_ioParser.CONNECT});
    }
  }
};

/**
 * Called upon engine `close`.
 *
 * @param {String} reason
 * @api private
 */

Socket.prototype.onclose = function (reason) {
  debug('close (%s)', reason);
  this.connected = false;
  this.disconnected = true;
  delete this.id;
  this.emit('disconnect', reason);
};

/**
 * Called with socket packet.
 *
 * @param {Object} packet
 * @api private
 */

Socket.prototype.onpacket = function (packet) {
  var sameNamespace = packet.nsp === this.nsp;
  var rootNamespaceError = packet.type === socket_ioParser.ERROR && packet.nsp === '/';

  if (!sameNamespace && !rootNamespaceError) return;

  switch (packet.type) {
    case socket_ioParser.CONNECT:
      this.onconnect();
      break;

    case socket_ioParser.EVENT:
      this.onevent(packet);
      break;

    case socket_ioParser.BINARY_EVENT:
      this.onevent(packet);
      break;

    case socket_ioParser.ACK:
      this.onack(packet);
      break;

    case socket_ioParser.BINARY_ACK:
      this.onack(packet);
      break;

    case socket_ioParser.DISCONNECT:
      this.ondisconnect();
      break;

    case socket_ioParser.ERROR:
      this.emit('error', packet.data);
      break;
  }
};

/**
 * Called upon a server event.
 *
 * @param {Object} packet
 * @api private
 */

Socket.prototype.onevent = function (packet) {
  var args = packet.data || [];
  debug('emitting event %j', args);

  if (null != packet.id) {
    debug('attaching ack callback to event');
    args.push(this.ack(packet.id));
  }

  if (this.connected) {
    emit.apply(this, args);
  } else {
    this.receiveBuffer.push(args);
  }
};

/**
 * Produces an ack callback to emit with an event.
 *
 * @api private
 */

Socket.prototype.ack = function (id) {
  var self = this;
  var sent = false;
  return function () {
    // prevent double callbacks
    if (sent) return;
    sent = true;
    var args = toArray_1(arguments);
    debug('sending ack %j', args);

    self.packet({
      type: hasBinary2(args) ? socket_ioParser.BINARY_ACK : socket_ioParser.ACK,
      id: id,
      data: args
    });
  };
};

/**
 * Called upon a server acknowlegement.
 *
 * @param {Object} packet
 * @api private
 */

Socket.prototype.onack = function (packet) {
  var ack = this.acks[packet.id];
  if ('function' === typeof ack) {
    debug('calling ack %s with %j', packet.id, packet.data);
    ack.apply(this, packet.data);
    delete this.acks[packet.id];
  } else {
    debug('bad ack %s', packet.id);
  }
};

/**
 * Called upon server connect.
 *
 * @api private
 */

Socket.prototype.onconnect = function () {
  this.connected = true;
  this.disconnected = false;
  this.emit('connect');
  this.emitBuffered();
};

/**
 * Emit buffered events (received and emitted).
 *
 * @api private
 */

Socket.prototype.emitBuffered = function () {
  var i;
  for (i = 0; i < this.receiveBuffer.length; i++) {
    emit.apply(this, this.receiveBuffer[i]);
  }
  this.receiveBuffer = [];

  for (i = 0; i < this.sendBuffer.length; i++) {
    this.packet(this.sendBuffer[i]);
  }
  this.sendBuffer = [];
};

/**
 * Called upon server disconnect.
 *
 * @api private
 */

Socket.prototype.ondisconnect = function () {
  debug('server disconnect (%s)', this.nsp);
  this.destroy();
  this.onclose('io server disconnect');
};

/**
 * Called upon forced client/server side disconnections,
 * this method ensures the manager stops tracking us and
 * that reconnections don't get triggered for this.
 *
 * @api private.
 */

Socket.prototype.destroy = function () {
  if (this.subs) {
    // clean subscriptions to avoid reconnections
    for (var i = 0; i < this.subs.length; i++) {
      this.subs[i].destroy();
    }
    this.subs = null;
  }

  this.io.destroy(this);
};

/**
 * Disconnects the socket manually.
 *
 * @return {Socket} self
 * @api public
 */

Socket.prototype.close =
Socket.prototype.disconnect = function () {
  if (this.connected) {
    debug('performing disconnect (%s)', this.nsp);
    this.packet({ type: socket_ioParser.DISCONNECT });
  }

  // remove socket from pool
  this.destroy();

  if (this.connected) {
    // fire events
    this.onclose('io client disconnect');
  }
  return this;
};

/**
 * Sets the compress flag.
 *
 * @param {Boolean} if `true`, compresses the sending data
 * @return {Socket} self
 * @api public
 */

Socket.prototype.compress = function (compress) {
  this.flags.compress = compress;
  return this;
};

/**
 * Sets the binary flag
 *
 * @param {Boolean} whether the emitted data contains binary
 * @return {Socket} self
 * @api public
 */

Socket.prototype.binary = function (binary) {
  this.flags.binary = binary;
  return this;
};
});

/**
 * Expose `Backoff`.
 */

var backo2 = Backoff;

/**
 * Initialize backoff timer with `opts`.
 *
 * - `min` initial timeout in milliseconds [100]
 * - `max` max timeout [10000]
 * - `jitter` [0]
 * - `factor` [2]
 *
 * @param {Object} opts
 * @api public
 */

function Backoff(opts) {
  opts = opts || {};
  this.ms = opts.min || 100;
  this.max = opts.max || 10000;
  this.factor = opts.factor || 2;
  this.jitter = opts.jitter > 0 && opts.jitter <= 1 ? opts.jitter : 0;
  this.attempts = 0;
}

/**
 * Return the backoff duration.
 *
 * @return {Number}
 * @api public
 */

Backoff.prototype.duration = function(){
  var ms = this.ms * Math.pow(this.factor, this.attempts++);
  if (this.jitter) {
    var rand =  Math.random();
    var deviation = Math.floor(rand * this.jitter * ms);
    ms = (Math.floor(rand * 10) & 1) == 0  ? ms - deviation : ms + deviation;
  }
  return Math.min(ms, this.max) | 0;
};

/**
 * Reset the number of attempts.
 *
 * @api public
 */

Backoff.prototype.reset = function(){
  this.attempts = 0;
};

/**
 * Set the minimum duration
 *
 * @api public
 */

Backoff.prototype.setMin = function(min){
  this.ms = min;
};

/**
 * Set the maximum duration
 *
 * @api public
 */

Backoff.prototype.setMax = function(max){
  this.max = max;
};

/**
 * Set the jitter
 *
 * @api public
 */

Backoff.prototype.setJitter = function(jitter){
  this.jitter = jitter;
};

/**
 * Module dependencies.
 */







var debug$6 = browser('socket.io-client:manager');



/**
 * IE6+ hasOwnProperty
 */

var has = Object.prototype.hasOwnProperty;

/**
 * Module exports
 */

var manager = Manager;

/**
 * `Manager` constructor.
 *
 * @param {String} engine instance or engine uri/opts
 * @param {Object} options
 * @api public
 */

function Manager (uri, opts) {
  if (!(this instanceof Manager)) return new Manager(uri, opts);
  if (uri && ('object' === typeof uri)) {
    opts = uri;
    uri = undefined;
  }
  opts = opts || {};

  opts.path = opts.path || '/socket.io';
  this.nsps = {};
  this.subs = [];
  this.opts = opts;
  this.reconnection(opts.reconnection !== false);
  this.reconnectionAttempts(opts.reconnectionAttempts || Infinity);
  this.reconnectionDelay(opts.reconnectionDelay || 1000);
  this.reconnectionDelayMax(opts.reconnectionDelayMax || 5000);
  this.randomizationFactor(opts.randomizationFactor || 0.5);
  this.backoff = new backo2({
    min: this.reconnectionDelay(),
    max: this.reconnectionDelayMax(),
    jitter: this.randomizationFactor()
  });
  this.timeout(null == opts.timeout ? 20000 : opts.timeout);
  this.readyState = 'closed';
  this.uri = uri;
  this.connecting = [];
  this.lastPing = null;
  this.encoding = false;
  this.packetBuffer = [];
  var _parser = opts.parser || socket_ioParser;
  this.encoder = new _parser.Encoder();
  this.decoder = new _parser.Decoder();
  this.autoConnect = opts.autoConnect !== false;
  if (this.autoConnect) this.open();
}

/**
 * Propagate given event to sockets and emit on `this`
 *
 * @api private
 */

Manager.prototype.emitAll = function () {
  this.emit.apply(this, arguments);
  for (var nsp in this.nsps) {
    if (has.call(this.nsps, nsp)) {
      this.nsps[nsp].emit.apply(this.nsps[nsp], arguments);
    }
  }
};

/**
 * Update `socket.id` of all sockets
 *
 * @api private
 */

Manager.prototype.updateSocketIds = function () {
  for (var nsp in this.nsps) {
    if (has.call(this.nsps, nsp)) {
      this.nsps[nsp].id = this.generateId(nsp);
    }
  }
};

/**
 * generate `socket.id` for the given `nsp`
 *
 * @param {String} nsp
 * @return {String}
 * @api private
 */

Manager.prototype.generateId = function (nsp) {
  return (nsp === '/' ? '' : (nsp + '#')) + this.engine.id;
};

/**
 * Mix in `Emitter`.
 */

componentEmitter$2(Manager.prototype);

/**
 * Sets the `reconnection` config.
 *
 * @param {Boolean} true/false if it should automatically reconnect
 * @return {Manager} self or value
 * @api public
 */

Manager.prototype.reconnection = function (v) {
  if (!arguments.length) return this._reconnection;
  this._reconnection = !!v;
  return this;
};

/**
 * Sets the reconnection attempts config.
 *
 * @param {Number} max reconnection attempts before giving up
 * @return {Manager} self or value
 * @api public
 */

Manager.prototype.reconnectionAttempts = function (v) {
  if (!arguments.length) return this._reconnectionAttempts;
  this._reconnectionAttempts = v;
  return this;
};

/**
 * Sets the delay between reconnections.
 *
 * @param {Number} delay
 * @return {Manager} self or value
 * @api public
 */

Manager.prototype.reconnectionDelay = function (v) {
  if (!arguments.length) return this._reconnectionDelay;
  this._reconnectionDelay = v;
  this.backoff && this.backoff.setMin(v);
  return this;
};

Manager.prototype.randomizationFactor = function (v) {
  if (!arguments.length) return this._randomizationFactor;
  this._randomizationFactor = v;
  this.backoff && this.backoff.setJitter(v);
  return this;
};

/**
 * Sets the maximum delay between reconnections.
 *
 * @param {Number} delay
 * @return {Manager} self or value
 * @api public
 */

Manager.prototype.reconnectionDelayMax = function (v) {
  if (!arguments.length) return this._reconnectionDelayMax;
  this._reconnectionDelayMax = v;
  this.backoff && this.backoff.setMax(v);
  return this;
};

/**
 * Sets the connection timeout. `false` to disable
 *
 * @return {Manager} self or value
 * @api public
 */

Manager.prototype.timeout = function (v) {
  if (!arguments.length) return this._timeout;
  this._timeout = v;
  return this;
};

/**
 * Starts trying to reconnect if reconnection is enabled and we have not
 * started reconnecting yet
 *
 * @api private
 */

Manager.prototype.maybeReconnectOnOpen = function () {
  // Only try to reconnect if it's the first time we're connecting
  if (!this.reconnecting && this._reconnection && this.backoff.attempts === 0) {
    // keeps reconnection from firing twice for the same reconnection loop
    this.reconnect();
  }
};

/**
 * Sets the current transport `socket`.
 *
 * @param {Function} optional, callback
 * @return {Manager} self
 * @api public
 */

Manager.prototype.open =
Manager.prototype.connect = function (fn, opts) {
  debug$6('readyState %s', this.readyState);
  if (~this.readyState.indexOf('open')) return this;

  debug$6('opening %s', this.uri);
  this.engine = lib(this.uri, this.opts);
  var socket = this.engine;
  var self = this;
  this.readyState = 'opening';
  this.skipReconnect = false;

  // emit `open`
  var openSub = on_1(socket, 'open', function () {
    self.onopen();
    fn && fn();
  });

  // emit `connect_error`
  var errorSub = on_1(socket, 'error', function (data) {
    debug$6('connect_error');
    self.cleanup();
    self.readyState = 'closed';
    self.emitAll('connect_error', data);
    if (fn) {
      var err = new Error('Connection error');
      err.data = data;
      fn(err);
    } else {
      // Only do this if there is no fn to handle the error
      self.maybeReconnectOnOpen();
    }
  });

  // emit `connect_timeout`
  if (false !== this._timeout) {
    var timeout = this._timeout;
    debug$6('connect attempt will timeout after %d', timeout);

    // set timer
    var timer = setTimeout(function () {
      debug$6('connect attempt timed out after %d', timeout);
      openSub.destroy();
      socket.close();
      socket.emit('error', 'timeout');
      self.emitAll('connect_timeout', timeout);
    }, timeout);

    this.subs.push({
      destroy: function () {
        clearTimeout(timer);
      }
    });
  }

  this.subs.push(openSub);
  this.subs.push(errorSub);

  return this;
};

/**
 * Called upon transport open.
 *
 * @api private
 */

Manager.prototype.onopen = function () {
  debug$6('open');

  // clear old subs
  this.cleanup();

  // mark as open
  this.readyState = 'open';
  this.emit('open');

  // add new subs
  var socket = this.engine;
  this.subs.push(on_1(socket, 'data', componentBind(this, 'ondata')));
  this.subs.push(on_1(socket, 'ping', componentBind(this, 'onping')));
  this.subs.push(on_1(socket, 'pong', componentBind(this, 'onpong')));
  this.subs.push(on_1(socket, 'error', componentBind(this, 'onerror')));
  this.subs.push(on_1(socket, 'close', componentBind(this, 'onclose')));
  this.subs.push(on_1(this.decoder, 'decoded', componentBind(this, 'ondecoded')));
};

/**
 * Called upon a ping.
 *
 * @api private
 */

Manager.prototype.onping = function () {
  this.lastPing = new Date();
  this.emitAll('ping');
};

/**
 * Called upon a packet.
 *
 * @api private
 */

Manager.prototype.onpong = function () {
  this.emitAll('pong', new Date() - this.lastPing);
};

/**
 * Called with data.
 *
 * @api private
 */

Manager.prototype.ondata = function (data) {
  this.decoder.add(data);
};

/**
 * Called when parser fully decodes a packet.
 *
 * @api private
 */

Manager.prototype.ondecoded = function (packet) {
  this.emit('packet', packet);
};

/**
 * Called upon socket error.
 *
 * @api private
 */

Manager.prototype.onerror = function (err) {
  debug$6('error', err);
  this.emitAll('error', err);
};

/**
 * Creates a new socket for the given `nsp`.
 *
 * @return {Socket}
 * @api public
 */

Manager.prototype.socket = function (nsp, opts) {
  var socket = this.nsps[nsp];
  if (!socket) {
    socket = new socket$1(this, nsp, opts);
    this.nsps[nsp] = socket;
    var self = this;
    socket.on('connecting', onConnecting);
    socket.on('connect', function () {
      socket.id = self.generateId(nsp);
    });

    if (this.autoConnect) {
      // manually call here since connecting event is fired before listening
      onConnecting();
    }
  }

  function onConnecting () {
    if (!~indexof(self.connecting, socket)) {
      self.connecting.push(socket);
    }
  }

  return socket;
};

/**
 * Called upon a socket close.
 *
 * @param {Socket} socket
 */

Manager.prototype.destroy = function (socket) {
  var index = indexof(this.connecting, socket);
  if (~index) this.connecting.splice(index, 1);
  if (this.connecting.length) return;

  this.close();
};

/**
 * Writes a packet.
 *
 * @param {Object} packet
 * @api private
 */

Manager.prototype.packet = function (packet) {
  debug$6('writing packet %j', packet);
  var self = this;
  if (packet.query && packet.type === 0) packet.nsp += '?' + packet.query;

  if (!self.encoding) {
    // encode, then write to engine with result
    self.encoding = true;
    this.encoder.encode(packet, function (encodedPackets) {
      for (var i = 0; i < encodedPackets.length; i++) {
        self.engine.write(encodedPackets[i], packet.options);
      }
      self.encoding = false;
      self.processPacketQueue();
    });
  } else { // add packet to the queue
    self.packetBuffer.push(packet);
  }
};

/**
 * If packet buffer is non-empty, begins encoding the
 * next packet in line.
 *
 * @api private
 */

Manager.prototype.processPacketQueue = function () {
  if (this.packetBuffer.length > 0 && !this.encoding) {
    var pack = this.packetBuffer.shift();
    this.packet(pack);
  }
};

/**
 * Clean up transport subscriptions and packet buffer.
 *
 * @api private
 */

Manager.prototype.cleanup = function () {
  debug$6('cleanup');

  var subsLength = this.subs.length;
  for (var i = 0; i < subsLength; i++) {
    var sub = this.subs.shift();
    sub.destroy();
  }

  this.packetBuffer = [];
  this.encoding = false;
  this.lastPing = null;

  this.decoder.destroy();
};

/**
 * Close the current socket.
 *
 * @api private
 */

Manager.prototype.close =
Manager.prototype.disconnect = function () {
  debug$6('disconnect');
  this.skipReconnect = true;
  this.reconnecting = false;
  if ('opening' === this.readyState) {
    // `onclose` will not fire because
    // an open event never happened
    this.cleanup();
  }
  this.backoff.reset();
  this.readyState = 'closed';
  if (this.engine) this.engine.close();
};

/**
 * Called upon engine close.
 *
 * @api private
 */

Manager.prototype.onclose = function (reason) {
  debug$6('onclose');

  this.cleanup();
  this.backoff.reset();
  this.readyState = 'closed';
  this.emit('close', reason);

  if (this._reconnection && !this.skipReconnect) {
    this.reconnect();
  }
};

/**
 * Attempt a reconnection.
 *
 * @api private
 */

Manager.prototype.reconnect = function () {
  if (this.reconnecting || this.skipReconnect) return this;

  var self = this;

  if (this.backoff.attempts >= this._reconnectionAttempts) {
    debug$6('reconnect failed');
    this.backoff.reset();
    this.emitAll('reconnect_failed');
    this.reconnecting = false;
  } else {
    var delay = this.backoff.duration();
    debug$6('will wait %dms before reconnect attempt', delay);

    this.reconnecting = true;
    var timer = setTimeout(function () {
      if (self.skipReconnect) return;

      debug$6('attempting reconnect');
      self.emitAll('reconnect_attempt', self.backoff.attempts);
      self.emitAll('reconnecting', self.backoff.attempts);

      // check again for the case socket closed in above events
      if (self.skipReconnect) return;

      self.open(function (err) {
        if (err) {
          debug$6('reconnect attempt error');
          self.reconnecting = false;
          self.reconnect();
          self.emitAll('reconnect_error', err.data);
        } else {
          debug$6('reconnect success');
          self.onreconnect();
        }
      });
    }, delay);

    this.subs.push({
      destroy: function () {
        clearTimeout(timer);
      }
    });
  }
};

/**
 * Called upon successful reconnect.
 *
 * @api private
 */

Manager.prototype.onreconnect = function () {
  var attempt = this.backoff.attempts;
  this.reconnecting = false;
  this.backoff.reset();
  this.updateSocketIds();
  this.emitAll('reconnect', attempt);
};

var lib$1 = _commonjsHelpers.createCommonjsModule(function (module, exports) {
/**
 * Module dependencies.
 */




var debug = browser('socket.io-client');

/**
 * Module exports.
 */

module.exports = exports = lookup;

/**
 * Managers cache.
 */

var cache = exports.managers = {};

/**
 * Looks up an existing `Manager` for multiplexing.
 * If the user summons:
 *
 *   `io('http://localhost/a');`
 *   `io('http://localhost/b');`
 *
 * We reuse the existing instance based on same scheme/port/host,
 * and we initialize sockets for each namespace.
 *
 * @api public
 */

function lookup (uri, opts) {
  if (typeof uri === 'object') {
    opts = uri;
    uri = undefined;
  }

  opts = opts || {};

  var parsed = url_1(uri);
  var source = parsed.source;
  var id = parsed.id;
  var path = parsed.path;
  var sameNamespace = cache[id] && path in cache[id].nsps;
  var newConnection = opts.forceNew || opts['force new connection'] ||
                      false === opts.multiplex || sameNamespace;

  var io;

  if (newConnection) {
    debug('ignoring socket cache for %s', source);
    io = manager(source, opts);
  } else {
    if (!cache[id]) {
      debug('new io instance for %s', source);
      cache[id] = manager(source, opts);
    }
    io = cache[id];
  }
  if (parsed.query && !opts.query) {
    opts.query = parsed.query;
  }
  return io.socket(parsed.path, opts);
}

/**
 * Protocol version.
 *
 * @api public
 */

exports.protocol = socket_ioParser.protocol;

/**
 * `connect`.
 *
 * @param {String} uri
 * @api public
 */

exports.connect = lookup;

/**
 * Expose constructors for standalone build.
 *
 * @api public
 */

exports.Manager = manager;
exports.Socket = socket$1;
});

// This constructor is used to store event handlers. Instantiating this is
// faster than explicitly calling `Object.create(null)` to get a "clean" empty
// object (tested with v8 v4.9).
function EventHandlers() {}
EventHandlers.prototype = Object.create(null);

function EventEmitter() {
  EventEmitter.init.call(this);
}

// nodejs oddity
// require('events') === require('events').EventEmitter
EventEmitter.EventEmitter = EventEmitter;

EventEmitter.usingDomains = false;

EventEmitter.prototype.domain = undefined;
EventEmitter.prototype._events = undefined;
EventEmitter.prototype._maxListeners = undefined;

// By default EventEmitters will print a warning if more than 10 listeners are
// added to it. This is a useful default which helps finding memory leaks.
EventEmitter.defaultMaxListeners = 10;

EventEmitter.init = function() {
  this.domain = null;

  if (!this._events || this._events === Object.getPrototypeOf(this)._events) {
    this._events = new EventHandlers();
    this._eventsCount = 0;
  }

  this._maxListeners = this._maxListeners || undefined;
};

// Obviously not all Emitters should be limited to 10. This function allows
// that to be increased. Set to zero for unlimited.
EventEmitter.prototype.setMaxListeners = function setMaxListeners(n) {
  if (typeof n !== 'number' || n < 0 || isNaN(n))
    throw new TypeError('"n" argument must be a positive number');
  this._maxListeners = n;
  return this;
};

function $getMaxListeners(that) {
  if (that._maxListeners === undefined)
    return EventEmitter.defaultMaxListeners;
  return that._maxListeners;
}

EventEmitter.prototype.getMaxListeners = function getMaxListeners() {
  return $getMaxListeners(this);
};

// These standalone emit* functions are used to optimize calling of event
// handlers for fast cases because emit() itself often has a variable number of
// arguments and can be deoptimized because of that. These functions always have
// the same number of arguments and thus do not get deoptimized, so the code
// inside them can execute faster.
function emitNone(handler, isFn, self) {
  if (isFn)
    handler.call(self);
  else {
    var len = handler.length;
    var listeners = arrayClone(handler, len);
    for (var i = 0; i < len; ++i)
      listeners[i].call(self);
  }
}
function emitOne(handler, isFn, self, arg1) {
  if (isFn)
    handler.call(self, arg1);
  else {
    var len = handler.length;
    var listeners = arrayClone(handler, len);
    for (var i = 0; i < len; ++i)
      listeners[i].call(self, arg1);
  }
}
function emitTwo(handler, isFn, self, arg1, arg2) {
  if (isFn)
    handler.call(self, arg1, arg2);
  else {
    var len = handler.length;
    var listeners = arrayClone(handler, len);
    for (var i = 0; i < len; ++i)
      listeners[i].call(self, arg1, arg2);
  }
}
function emitThree(handler, isFn, self, arg1, arg2, arg3) {
  if (isFn)
    handler.call(self, arg1, arg2, arg3);
  else {
    var len = handler.length;
    var listeners = arrayClone(handler, len);
    for (var i = 0; i < len; ++i)
      listeners[i].call(self, arg1, arg2, arg3);
  }
}

function emitMany(handler, isFn, self, args) {
  if (isFn)
    handler.apply(self, args);
  else {
    var len = handler.length;
    var listeners = arrayClone(handler, len);
    for (var i = 0; i < len; ++i)
      listeners[i].apply(self, args);
  }
}

EventEmitter.prototype.emit = function emit(type) {
  var er, handler, len, args, i, events, domain;
  var doError = (type === 'error');

  events = this._events;
  if (events)
    doError = (doError && events.error == null);
  else if (!doError)
    return false;

  domain = this.domain;

  // If there is no 'error' event listener then throw.
  if (doError) {
    er = arguments[1];
    if (domain) {
      if (!er)
        er = new Error('Uncaught, unspecified "error" event');
      er.domainEmitter = this;
      er.domain = domain;
      er.domainThrown = false;
      domain.emit('error', er);
    } else if (er instanceof Error) {
      throw er; // Unhandled 'error' event
    } else {
      // At least give some kind of context to the user
      var err = new Error('Uncaught, unspecified "error" event. (' + er + ')');
      err.context = er;
      throw err;
    }
    return false;
  }

  handler = events[type];

  if (!handler)
    return false;

  var isFn = typeof handler === 'function';
  len = arguments.length;
  switch (len) {
    // fast cases
    case 1:
      emitNone(handler, isFn, this);
      break;
    case 2:
      emitOne(handler, isFn, this, arguments[1]);
      break;
    case 3:
      emitTwo(handler, isFn, this, arguments[1], arguments[2]);
      break;
    case 4:
      emitThree(handler, isFn, this, arguments[1], arguments[2], arguments[3]);
      break;
    // slower
    default:
      args = new Array(len - 1);
      for (i = 1; i < len; i++)
        args[i - 1] = arguments[i];
      emitMany(handler, isFn, this, args);
  }

  return true;
};

function _addListener(target, type, listener, prepend) {
  var m;
  var events;
  var existing;

  if (typeof listener !== 'function')
    throw new TypeError('"listener" argument must be a function');

  events = target._events;
  if (!events) {
    events = target._events = new EventHandlers();
    target._eventsCount = 0;
  } else {
    // To avoid recursion in the case that type === "newListener"! Before
    // adding it to the listeners, first emit "newListener".
    if (events.newListener) {
      target.emit('newListener', type,
                  listener.listener ? listener.listener : listener);

      // Re-assign `events` because a newListener handler could have caused the
      // this._events to be assigned to a new object
      events = target._events;
    }
    existing = events[type];
  }

  if (!existing) {
    // Optimize the case of one listener. Don't need the extra array object.
    existing = events[type] = listener;
    ++target._eventsCount;
  } else {
    if (typeof existing === 'function') {
      // Adding the second element, need to change to array.
      existing = events[type] = prepend ? [listener, existing] :
                                          [existing, listener];
    } else {
      // If we've already got an array, just append.
      if (prepend) {
        existing.unshift(listener);
      } else {
        existing.push(listener);
      }
    }

    // Check for listener leak
    if (!existing.warned) {
      m = $getMaxListeners(target);
      if (m && m > 0 && existing.length > m) {
        existing.warned = true;
        var w = new Error('Possible EventEmitter memory leak detected. ' +
                            existing.length + ' ' + type + ' listeners added. ' +
                            'Use emitter.setMaxListeners() to increase limit');
        w.name = 'MaxListenersExceededWarning';
        w.emitter = target;
        w.type = type;
        w.count = existing.length;
        emitWarning(w);
      }
    }
  }

  return target;
}
function emitWarning(e) {
  typeof console.warn === 'function' ? console.warn(e) : console.log(e);
}
EventEmitter.prototype.addListener = function addListener(type, listener) {
  return _addListener(this, type, listener, false);
};

EventEmitter.prototype.on = EventEmitter.prototype.addListener;

EventEmitter.prototype.prependListener =
    function prependListener(type, listener) {
      return _addListener(this, type, listener, true);
    };

function _onceWrap(target, type, listener) {
  var fired = false;
  function g() {
    target.removeListener(type, g);
    if (!fired) {
      fired = true;
      listener.apply(target, arguments);
    }
  }
  g.listener = listener;
  return g;
}

EventEmitter.prototype.once = function once(type, listener) {
  if (typeof listener !== 'function')
    throw new TypeError('"listener" argument must be a function');
  this.on(type, _onceWrap(this, type, listener));
  return this;
};

EventEmitter.prototype.prependOnceListener =
    function prependOnceListener(type, listener) {
      if (typeof listener !== 'function')
        throw new TypeError('"listener" argument must be a function');
      this.prependListener(type, _onceWrap(this, type, listener));
      return this;
    };

// emits a 'removeListener' event iff the listener was removed
EventEmitter.prototype.removeListener =
    function removeListener(type, listener) {
      var list, events, position, i, originalListener;

      if (typeof listener !== 'function')
        throw new TypeError('"listener" argument must be a function');

      events = this._events;
      if (!events)
        return this;

      list = events[type];
      if (!list)
        return this;

      if (list === listener || (list.listener && list.listener === listener)) {
        if (--this._eventsCount === 0)
          this._events = new EventHandlers();
        else {
          delete events[type];
          if (events.removeListener)
            this.emit('removeListener', type, list.listener || listener);
        }
      } else if (typeof list !== 'function') {
        position = -1;

        for (i = list.length; i-- > 0;) {
          if (list[i] === listener ||
              (list[i].listener && list[i].listener === listener)) {
            originalListener = list[i].listener;
            position = i;
            break;
          }
        }

        if (position < 0)
          return this;

        if (list.length === 1) {
          list[0] = undefined;
          if (--this._eventsCount === 0) {
            this._events = new EventHandlers();
            return this;
          } else {
            delete events[type];
          }
        } else {
          spliceOne(list, position);
        }

        if (events.removeListener)
          this.emit('removeListener', type, originalListener || listener);
      }

      return this;
    };

EventEmitter.prototype.removeAllListeners =
    function removeAllListeners(type) {
      var listeners, events;

      events = this._events;
      if (!events)
        return this;

      // not listening for removeListener, no need to emit
      if (!events.removeListener) {
        if (arguments.length === 0) {
          this._events = new EventHandlers();
          this._eventsCount = 0;
        } else if (events[type]) {
          if (--this._eventsCount === 0)
            this._events = new EventHandlers();
          else
            delete events[type];
        }
        return this;
      }

      // emit removeListener for all listeners on all events
      if (arguments.length === 0) {
        var keys = Object.keys(events);
        for (var i = 0, key; i < keys.length; ++i) {
          key = keys[i];
          if (key === 'removeListener') continue;
          this.removeAllListeners(key);
        }
        this.removeAllListeners('removeListener');
        this._events = new EventHandlers();
        this._eventsCount = 0;
        return this;
      }

      listeners = events[type];

      if (typeof listeners === 'function') {
        this.removeListener(type, listeners);
      } else if (listeners) {
        // LIFO order
        do {
          this.removeListener(type, listeners[listeners.length - 1]);
        } while (listeners[0]);
      }

      return this;
    };

EventEmitter.prototype.listeners = function listeners(type) {
  var evlistener;
  var ret;
  var events = this._events;

  if (!events)
    ret = [];
  else {
    evlistener = events[type];
    if (!evlistener)
      ret = [];
    else if (typeof evlistener === 'function')
      ret = [evlistener.listener || evlistener];
    else
      ret = unwrapListeners(evlistener);
  }

  return ret;
};

EventEmitter.listenerCount = function(emitter, type) {
  if (typeof emitter.listenerCount === 'function') {
    return emitter.listenerCount(type);
  } else {
    return listenerCount.call(emitter, type);
  }
};

EventEmitter.prototype.listenerCount = listenerCount;
function listenerCount(type) {
  var events = this._events;

  if (events) {
    var evlistener = events[type];

    if (typeof evlistener === 'function') {
      return 1;
    } else if (evlistener) {
      return evlistener.length;
    }
  }

  return 0;
}

EventEmitter.prototype.eventNames = function eventNames() {
  return this._eventsCount > 0 ? Reflect.ownKeys(this._events) : [];
};

// About 1.5x faster than the two-arg version of Array#splice().
function spliceOne(list, index) {
  for (var i = index, k = i + 1, n = list.length; k < n; i += 1, k += 1)
    list[i] = list[k];
  list.pop();
}

function arrayClone(arr, i) {
  var copy = new Array(i);
  while (i--)
    copy[i] = arr[i];
  return copy;
}

function unwrapListeners(arr) {
  var ret = new Array(arr.length);
  for (var i = 0; i < ret.length; ++i) {
    ret[i] = arr[i].listener || arr[i];
  }
  return ret;
}

const events = /*#__PURE__*/Object.freeze({
    __proto__: null,
    'default': EventEmitter,
    EventEmitter: EventEmitter
});

var BuiltInEmitter = events.EventEmitter;

var socketioWildcard = function (CustomEmitter) {
  var Emitter = CustomEmitter || BuiltInEmitter;
  var emit = Emitter.prototype.emit;

  function onevent (packet) {
    var args = packet.data || [];
    if (packet.id != null) {
      args.push(this.ack(packet.id));
    }
    emit.call(this, '*', packet);
    return emit.apply(this, args)
  }

  return function (socket, next) {
    if (socket.onevent !== onevent) {
      socket.onevent = onevent;
    }
    return next ? next() : null
  }
};

const t={JOIN_ROOM:"join-room",PING_ROOM:"ping-room",LEAVE_ROOM:"leave-room"};class i$1{constructor(s,e){this.userData=s,this.socketUrl=e,this.users={},this.userStreams={},this.callbacks={},this.envIsBrowser="undefined"!=typeof window;}stopCamera(s=!0){this.stream&&(this.stream.getVideoTracks()[0].enabled=!1,s&&this.pub(i$1.actions.USER_VIDEO_STOPPED,{}));}startCamera(s=!0){this.stream&&(this.stream.getVideoTracks()[0].enabled=!0,s&&this.pub(i$1.actions.USER_VIDEO_STARTED,{}));}muteAudio(s=!0){this.stream&&(this.stream.getAudioTracks()[0].enabled=!1,s&&this.pub(i$1.actions.USER_VIDEO_STOPPED,{}));}unmuteAudio(s=!0){this.stream&&(this.stream.getAudioTracks()[0].enabled=!0,s&&this.pub(i$1.actions.USER_AUDIO_STARTED,{}));}getVideoStream(s){return this.userStreams[s]}setVideoStream(s,e){if(this.userStreams[e])return;const t=document.createElement("video");t.srcObject=s,this.userStreams[e]=t,t.onloadedmetadata=()=>{t.play();},document.body.appendChild(t);}static concatFullRoomId(s,e,t){return s+(e||"_ALL_FILES_")+(t||"_ALL_ROOMS_")}isJoiningTheSameRoom(s,e,t){return this.fullRoomId===i$1.concatFullRoomId(s,e,t)}joinRoom(o,r,a){this.projectId=o,this.fileId=r,this.roomId=a,this.fullRoomId=i$1.concatFullRoomId(this.projectId,this.fileId,this.roomId),this.leaveRoom(),this.socket=lib$1(this.socketUrl,{"sync disconnect on unload":!0,query:`userId=${this.userData.id}&roomId=${this.fullRoomId}`}),socketioWildcard(lib$1.Manager)(this.socket),this.socket.on("*",s=>{const[e,i]=s.data;e in t||this._emit(e,i.payload,i.userId);}),this.envIsBrowser&&window.addEventListener("beforeunload",()=>{this.leaveRoom();}),this.pub(t.JOIN_ROOM),this.socket.on(t.JOIN_ROOM,s=>{console.info(`${t.JOIN_ROOM}:`,s);const e=s.userData;this._addUserIfNew(e),this.pub(t.PING_ROOM);}),this.socket.on(t.LEAVE_ROOM,s=>{console.info(`${t.LEAVE_ROOM}:`,s);const e=s.userData,o=e.id;if(o in this.users)return delete this.users[o],void this._emit(i$1.actions.USER_LEFT,e);console.warn("Outgoing user was not found in room.");}),this.socket.on(t.PING_ROOM,s=>{console.info(`${t.PING_ROOM}:`,s);const e=s.userData;this._addUserIfNew(e);});}_prepareMediaStream(){return this.__streamPromise||(this.__streamPromise=new window.Promise((s,e)=>{this.stream?s():navigator.mediaDevices.getUserMedia({audio:!0,video:{width:400,height:300}}).then(e=>{this.stream=e,this.stopCamera(!1),this.muteAudio(!1),s();}).catch(s=>{e(s);});})),this.__streamPromise}leaveRoom(){this._emit(i$1.actions.LEFT_ROOM),this.users={},this.socket&&this.pub(t.LEAVE_ROOM,void 0,()=>{this.socket.close();});}_addUserIfNew(s){s.id in this.users||(this.users[s.id]=s,this._emit(i$1.actions.USER_JOINED,s));}createRoom(){return this.roomId=shortid.generate(),this.joinRoom(this.projectId,this.fileId,this.roomId),this.envIsBrowser&&window.history.pushState(null,null,`?project-id=${this.projectId}&file-id=${this.fileId}&room-id=${this.roomId}`),this.roomId}getUsers(){return this.users}getUser(s){return this.users[s]}pub(s,e,t){if(!s)throw new Error("Missing messageType");this.socket.emit(s,{userData:this.userData,userId:this.userData.id,payload:e},t);}_emit(s,e,t){const i=this.callbacks[s];i&&i.forEach(s=>s(e,t));}sub(s,e){if(!s)throw new Error("Missing messageType");if(!e)throw new Error("Missing callback");this.callbacks[s]=this.callbacks[s]||[],this.callbacks[s].push(e);return ()=>{this.callbacks[s].splice(this.callbacks[s].indexOf(e),1);}}}i$1.actions={USER_JOINED:"user-joined",USER_VIDEO_STARTED:"user-video-started",USER_VIDEO_STOPPED:"user-video-stopped",USER_AUDIO_STARTED:"user-audio-started",USER_AUDIO_STOPPED:"user-audio-stopped",USER_LEFT:"user-left",LEFT_ROOM:"left-room",TEXT_MESSAGE:"text-message",POSE_CHANGED:"pose-message",COMMAND_ADDED:"command-added",COMMAND_UPDATED:"command-updated",FILE_WITH_PROGRESS:"file-with-progress"};class o{static setSocketURL(s){this.socketUrl=s;}static getInstance(s,e,t,o){if(!this.session){if(!this.socketUrl)throw new Error("Missing #socketUrl. Call #setSocketURL first.");this.session=new i$1(s,this.socketUrl);}return this.session.isJoiningTheSameRoom(e,t,o)||this.session.joinRoom(e,t,o),this.session}static getCurrentSession(){return this.session}}class r{constructor(s){if(this.actionRegistry=s,this.__recordings={},self.origin.startsWith("https://localhost")){const e=["https://upload.wikimedia.org/wikipedia/commons/7/7c/Profile_avatar_placeholder_large.png"],t={};let i,o,r;const a=()=>{const s=(a=e.length,Math.floor(Math.random()*Math.floor(a)));var a;i={id:"_"+Math.random().toString(36).substr(2,9),picture:e[s],name:"Presenter"+Object.keys(t).length},r=[];let n={messageType:"user-joined",payload:i},c=performance.now();o=this.session.pub,this.session.pub=(s,e)=>{const t=performance.now();n.ms=t-c,r.push(n),n={messageType:s,payload:e},c=t,o.call(this.session,s,e);};},n=()=>{r.push({messageType:"user-left",payload:i}),t[i.id]=r,this.session.pub=o,this.__playRecording(t);};let c=!1;s.registerAction({path:["Sessions"],name:"Toggle Recording",callback:()=>{c?(n(),c=!1):(a(),c=!0);},availableInVR:!0}),s.registerAction({path:["Sessions"],name:"Stop Recording",callback:()=>{n();},availableInVR:!0}),s.registerAction({path:["Sessions"],name:"Save",callback:()=>{this.save(t);}});}}setSession(s){this.session=s;}setResourceLoader(s){this.resourceLoader=s;const e=s=>{this.__recordings[s.name]=s,this.actionRegistry.registerAction({path:["Sessions","Recordings"],name:s.name,callback:()=>{this.playRecording(s.name);},availableInVR:!0});};this.resourceLoader.registerResourceCallback(".rec",s=>{e(s);});}save(s){!function(s,e,t){var i=new Blob([s],{type:t});if(window.navigator.msSaveOrOpenBlob)window.navigator.msSaveOrOpenBlob(i,e);else {var o=document.createElement("a"),r=URL.createObjectURL(i);o.href=r,o.download=e,document.body.appendChild(o),o.click(),setTimeout((function(){document.body.removeChild(o),window.URL.revokeObjectURL(r);}),0);}}(JSON.stringify(s),"MyRec.rec","application/json");}__stopPlayback(){for(let s in this.__timeoutIds)clearTimeout(this.__timeoutIds[s]);this.__timeoutIds={};}__play(s,e,t){let i=0;const o=()=>{const r=e[i];this.session._emit(r.messageType,r.payload,s),i++,i<e.length?this.__timeoutIds[s]=setTimeout(o,r.ms):t();};this.__timeoutIds[s]=setTimeout(o,1e3);}__playRecording(s){this.__stopPlayback();let e=0;this.__timeoutIds={};for(let t in s)e++,this.__play(t,s[t],()=>{e--,0==e&&this.__playRecording(s);});}playRecording(s){const e=this.__recordings[s];this.resourceLoader.loadResource(e.id,s=>{const e=JSON.parse(session.decodeText(s.rec));this.__playRecording(e);});}}

const zeaCollab_esm = /*#__PURE__*/Object.freeze({
    __proto__: null,
    Session: i$1,
    SessionFactory: o,
    SessionRecorder: r
});

var zeaUx_cjs = _commonjsHelpers.createCommonjsModule(function (module, exports) {
Object.defineProperty(exports,"__esModule",{value:!0});var e=zeaEngine_cjs,t=zeaCollab_esm;const s={},i={},n=[];class o{constructor(){this.__undoStack=[],this.__redoStack=[],this.changeAdded=new e.Signal,this.changeUpdated=new e.Signal,this.changeUndone=new e.Signal,this.changeRedone=new e.Signal,this.__currChangeUpdated=this.__currChangeUpdated.bind(this);}flush(){for(const e of this.__undoStack)e.destroy();this.__undoStack=[];for(const e of this.__redoStack)e.destroy();this.__redoStack=[];}addChange(e){this.getCurrentChange()&&this.getCurrentChange().updated.disconnect(this.__currChangeUpdated),this.__undoStack.push(e),e.updated.connect(this.__currChangeUpdated);for(const e of this.__redoStack)e.destroy();this.__redoStack=[],this.changeAdded.emit(e);}getCurrentChange(){return this.__undoStack[this.__undoStack.length-1]}__currChangeUpdated(e){this.changeUpdated.emit(e);}undo(e=!0){if(this.__undoStack.length>0){const t=this.__undoStack.pop();t.undo(),e&&(this.__redoStack.push(t),this.changeUndone.emit());}}redo(){if(this.__redoStack.length>0){const e=this.__redoStack.pop();e.redo(),this.__undoStack.push(e),this.changeRedone.emit();}}constructChange(e){return new s[e]}static getChangeClassName(e){const t=n.indexOf(e.constructor);return i[t]?i[t]:(console.warn("Change not registered:",e.constructor.name),e.constructor.name)}static registerChange(e,t){-1!=n.indexOf(t)&&console.warn("Class already registered:",e);const o=n.length;n.push(t),s[e]=t,i[o]=e;}}class a{constructor(t){this.name=t||o.getChangeClassName(this),this.updated=new e.Signal;}undo(){throw new Error("Implement me")}redo(){throw new Error("Implement me")}update(e){throw new Error("Implement me")}toJSON(e){return {}}fromJSON(e,t){}changeFromJSON(e){this.update(e);}destroy(){}}class r extends e.TreeItem{constructor(e){super(e),this.captured=!1;}highlight(){}unhighlight(){}getManipulationPlane(){const t=this.getGlobalXfo();return new e.Ray(t.tr,t.ori.getZaxis())}onMouseEnter(e){this.highlight();}onMouseLeave(e){this.unhighlight();}onMouseDown(e){e.setCapture(this),e.stopPropagation(),this.captured=!0,e.viewport?this.handleMouseDown(e):e.vrviewport&&this.onVRControllerButtonDown(e);}onMouseMove(e){this.captured&&(e.stopPropagation(),e.viewport?this.handleMouseMove(e):e.vrviewport&&this.onVRPoseChanged(e));}onMouseUp(e){this.captured&&(e.releaseCapture(),e.stopPropagation(),this.captured=!1,e.viewport?this.handleMouseUp(e):e.vrviewport&&this.onVRControllerButtonUp(e));}onWheel(e){}handleMouseDown(e){this.gizmoRay=this.getManipulationPlane();const t=e.mouseRay.intersectRayPlane(this.gizmoRay);return e.grabPos=e.mouseRay.pointAtDist(t),this.onDragStart(e),!0}handleMouseMove(e){const t=e.mouseRay.intersectRayPlane(this.gizmoRay);return e.holdPos=e.mouseRay.pointAtDist(t),this.onDrag(e),!0}handleMouseUp(e){const t=e.mouseRay.intersectRayPlane(this.gizmoRay);return e.releasePos=e.mouseRay.pointAtDist(t),this.onDragEnd(e),!0}onVRControllerButtonDown(e){this.activeController=e.controller;const t=this.activeController.getTipXfo().clone(),s=this.getManipulationPlane(),i=t.tr.subtract(s.start),n=t.tr.subtract(s.dir.scale(i.dot(s.dir)));return e.grabPos=n,this.onDragStart(e),!0}onVRPoseChanged(e){if(this.activeController){const t=this.activeController.getTipXfo(),s=this.getManipulationPlane(),i=t.tr.subtract(s.start),n=t.tr.subtract(s.dir.scale(i.dot(s.dir)));return e.holdPos=n,this.onDrag(e),!0}}onVRControllerButtonUp(e){if(this.activeController==e.controller){const t=this.activeController.getTipXfo();return this.onDragEnd(e,t.tr),this.activeController=void 0,!0}}onDragStart(e){console.log("onDragStart",e);}onDrag(e){console.log("onDrag",e);}onDragEnd(e){console.log("onDragEnd",e);}}class l extends r{constructor(e){super(e);}handleMouseDown(e){this.gizmoRay=this.getManipulationPlane(),this.grabDist=e.mouseRay.intersectRayVector(this.gizmoRay)[1];const t=this.gizmoRay.pointAtDist(this.grabDist);return e.grabDist=this.grabDist,e.grabPos=t,this.onDragStart(e),!0}handleMouseMove(e){const t=e.mouseRay.intersectRayVector(this.gizmoRay)[1],s=this.gizmoRay.pointAtDist(t);e.holdDist=t,e.holdPos=s,e.value=t,e.delta=t-this.grabDist,this.onDrag(e);}handleMouseUp(e){const t=e.mouseRay.intersectRayVector(this.gizmoRay)[1],s=this.gizmoRay.pointAtDist(t);return e.releasePos=s,this.onDragEnd(e),!0}onVRControllerButtonDown(e){this.gizmoRay=this.getManipulationPlane(),this.activeController=e.controller;const t=this.activeController.getTipXfo();this.grabDist=t.tr.subtract(this.gizmoRay.start).dot(this.gizmoRay.dir);const s=this.gizmoRay.start.add(this.gizmoRay.dir.scale(this.grabDist));return e.grabPos=s,this.onDragStart(e),!0}onVRPoseChanged(e){const t=this.activeController.getTipXfo().tr.subtract(this.gizmoRay.start).dot(this.gizmoRay.dir),s=this.gizmoRay.start.add(this.gizmoRay.dir.scale(t));return e.value=t,e.holdPos=s,e.delta=t-this.grabDist,this.onDrag(e),!0}onVRControllerButtonUp(e){if(this.activeController==e.controller)return this.onDragEnd(),this.activeController=void 0,!0}}class h extends a{constructor(t,s,i=e.ValueSetMode.USER_SETVALUE){t?(super(t?t.getName()+" Changed":"ParameterValueChange"),this.__prevValue=t.getValue(),this.__param=t,this.__mode=i,null!=s&&(this.__nextValue=s,this.__param.setValue(this.__nextValue,i))):super();}undo(){this.__param&&this.__param.setValue(this.__prevValue,this.__mode);}redo(){this.__param&&this.__param.setValue(this.__nextValue,this.__mode);}update(e){if(!this.__param)return;this.__nextValue=e.value;const t=e.mode?e.mode:this.__mode;this.__param.setValue(this.__nextValue,t),this.updated.emit(e);}toJSON(e){const t={name:this.name,paramPath:this.__param.getPath()};return null!=this.__nextValue&&(this.__nextValue.toJSON?t.value=this.__nextValue.toJSON():t.value=this.__nextValue),t}fromJSON(t,s){const i=s.appData.scene.getRoot().resolvePath(t.paramPath,1);i&&i instanceof e.Parameter?(this.__param=i,this.__prevValue=this.__param.getValue(),this.__prevValue.clone?this.__nextValue=this.__prevValue.clone():this.__nextValue=this.__prevValue,this.name=t.name,null!=t.value&&this.changeFromJSON(t)):console.warn("resolvePath is unable to resolve",t.paramPath);}changeFromJSON(t){this.__param&&(this.__nextValue.fromJSON?this.__nextValue.fromJSON(t.value):this.__nextValue=t.value,this.__param.setValue(this.__nextValue,e.ValueSetMode.REMOTEUSER_SETVALUE));}}o.registerChange("ParameterValueChange",h);class c extends l{constructor(t,s,i,n){super(t),this.__color=n,this.__hilightedColor=new e.Color(1,1,1),this.colorParam=this.addParameter(new e.ColorParameter("BaseColor",n));const o=new e.Material("handle","HandleShader");o.getParameter("maintainScreenSize").setValue(1),o.replaceParameter(this.colorParam);const a=new e.Cylinder(i,s,64);a.getParameter("baseZAtZero").setValue(!0);const r=new e.Cone(4*i,10*i,64,!0),l=new e.GeomItem("handle",a,o),h=new e.GeomItem("tip",r,o),c=new e.Xfo;c.tr.set(0,0,s),r.transformVertices(c),this.addChild(l),this.addChild(h);}highlight(){this.colorParam.setValue(this.__hilightedColor);}unhighlight(){this.colorParam.setValue(this.__color);}setTargetParam(e,t=!0){if(this.param=e,t){const t=()=>{this.setGlobalXfo(e.getValue());};t(),e.valueChanged.connect(t);}}getTargetParam(){return this.param?this.param:this.getParameter("GlobalXfo")}onDragStart(e){this.grabPos=e.grabPos;const t=this.getTargetParam();this.baseXfo=t.getValue(),e.undoRedoManager&&(this.change=new h(t),e.undoRedoManager.addChange(this.change));}onDrag(e){const t=e.holdPos.subtract(this.grabPos),s=this.baseXfo.clone();s.tr.addInPlace(t),this.change?this.change.update({value:s}):this.param.setValue(s);}onDragEnd(e){this.change=null;}}class d extends r{constructor(e){super(e),this.fullXfoManipulationInVR=!0;}setTargetParam(e,t=!0){if(this.param=e,t){const t=()=>{this.setGlobalXfo(e.getValue());};t(),e.valueChanged.connect(t);}}getTargetParam(){return this.param?this.param:this.getParameter("GlobalXfo")}onDragStart(e){this.grabPos=e.grabPos;const t=this.getTargetParam();this.baseXfo=t.getValue(),e.undoRedoManager&&(this.change=new h(t),e.undoRedoManager.addChange(this.change));}onDrag(e){const t=e.holdPos.subtract(this.grabPos),s=this.baseXfo.clone();if(s.tr.addInPlace(t),this.change)this.change.update({value:s});else {this.getTargetParam().setValue(s);}}onDragEnd(e){this.change=null;}onVRControllerButtonDown(e){if(this.fullXfoManipulationInVR){this.activeController=e.controller;const t=this.activeController.getTipXfo(),s=this.getGlobalXfo();this.grabOffset=t.inverse().multiply(s);}else super.onVRControllerButtonDown(e);return !0}onVRPoseChanged(e){if(this.fullXfoManipulationInVR){const e=this.activeController.getTipXfo().multiply(this.grabOffset);if(this.change)this.change.update({value:e});else {this.getTargetParam().setValue(e);}}else super.onVRPoseChanged(e);}onVRControllerButtonUp(e){this.fullXfoManipulationInVR?this.change=null:super.onVRControllerButtonUp(e);}}class m extends r{constructor(e){super(e);}setTargetParam(e,t=!0){if(this.param=e,t){const t=()=>{this.setGlobalXfo(e.getValue());};t(),e.valueChanged.connect(t);}}getTargetParam(){return this.param?this.param:this.getParameter("GlobalXfo")}onDragStart(t){this.baseXfo=this.getGlobalXfo().clone(),this.baseXfo.sc.set(1,1,1),this.deltaXfo=new e.Xfo;const s=this.getTargetParam(),i=s.getValue();this.offsetXfo=this.baseXfo.inverse().multiply(i),this.vec0=t.grabPos.subtract(this.baseXfo.tr),this.grabCircleRadius=this.vec0.length(),this.vec0.normalizeInPlace(),t.undoRedoManager&&(this.change=new h(s),t.undoRedoManager.addChange(this.change));}onDrag(t){const s=t.holdPos.subtract(this.baseXfo.tr),i=s.length();s.normalizeInPlace();const n=i/this.grabCircleRadius;let o=this.vec0.angleTo(s)*n;if(this.vec0.cross(s).dot(this.baseXfo.ori.getZaxis())<0&&(o=-o),this.range&&(o=Math.clamp(o,this.range[0],this.range[1])),t.shiftKey){const e=Math.degToRad(22.5);o=Math.floor(o/e)*e;}this.deltaXfo.ori.setFromAxisAndAngle(new e.Vec3(0,0,1),o);const a=this.baseXfo.multiply(this.deltaXfo).multiply(this.offsetXfo);if(this.change)this.change.update({value:a});else {this.getTargetParam().setValue(a);}}onDragEnd(e){this.change=null;}}class u extends m{constructor(t,s,i,n){super(t),this.__color=n,this.__hilightedColor=new e.Color(1,1,1),this.radiusParam=this.addParameter(new e.NumberParameter("radius",s)),this.colorParam=this.addParameter(new e.ColorParameter("BaseColor",n));const o=new e.Material("handle","HandleShader");o.getParameter("maintainScreenSize").setValue(1),o.replaceParameter(this.colorParam);const a=new e.Torus(i,s,64);this.handle=new e.GeomItem("handle",a,o),this.handleXfo=new e.Xfo,this.radiusParam.valueChanged.connect(()=>{s=this.radiusParam.getValue(),a.getParameter("radius").setValue(s),a.getParameter("height").setValue(.02*s);}),this.addChild(this.handle);}highlight(){this.colorParam.setValue(this.__hilightedColor);}unhighlight(){this.colorParam.setValue(this.__color);}getBaseXfo(){return this.getParameter("GlobalXfo").getValue()}onDragStart(t){super.onDragStart(t),this.colorParam.setValue(new e.Color(1,1,1));}onDrag(e){super.onDrag(e);}onDragEnd(e){super.onDragEnd(e),this.colorParam.setValue(this.__color);}}class g extends l{constructor(t,s,i,n){super(t),this.__color=n,this.__hilightedColor=new e.Color(1,1,1),this.colorParam=this.addParameter(new e.ColorParameter("BaseColor",n));const o=new e.Material("handle","HandleShader");o.getParameter("maintainScreenSize").setValue(1),o.replaceParameter(this.colorParam);const a=new e.Cylinder(i,s-10*i,64);a.getParameter("baseZAtZero").setValue(!0);const r=new e.Cuboid(10*i,10*i,10*i),l=new e.GeomItem("handle",a,o),h=new e.GeomItem("tip",r,o),c=new e.Xfo;c.tr.set(0,0,s-10*i),r.transformVertices(c),this.addChild(l),this.addChild(h);}highlight(){this.colorParam.setValue(this.__hilightedColor);}unhighlight(){this.colorParam.setValue(this.__color);}setTargetParam(e,t=!0){if(this.param=e,t){const t=()=>{this.setGlobalXfo(e.getValue());};t(),e.valueChanged.connect(t);}}getTargetParam(){return this.param?this.param:this.getParameter("GlobalXfo")}onDragStart(e){this.grabDist=e.grabDist,this.oriXfo=this.getGlobalXfo(),this.tmplocalXfo=this.getLocalXfo();const t=this.getTargetParam();this.baseXfo=t.getValue(),e.undoRedoManager&&(this.change=new h(t),e.undoRedoManager.addChange(this.change));}onDrag(e){const t=this.baseXfo.clone(),s=e.holdDist/this.grabDist;s<1e-4||(t.sc.set(this.baseXfo.sc.x*s,this.baseXfo.sc.y*s,this.baseXfo.sc.z*s),this.tmplocalXfo.sc.set(1,1,s),this.setLocalXfo(this.tmplocalXfo),this.change?this.change.update({value:t}):this.param.setValue(t));}onDragEnd(e){this.change=null,this.tmplocalXfo.sc.set(1,1,1),this.setLocalXfo(this.tmplocalXfo);const t=this.getChildByName("tip"),s=t.getLocalXfo();s.sc.set(1,1,1),t.setLocalXfo(s);}}class p extends r{constructor(t,s,i){super(t),this.radius=s;const n=new e.Material("mask","HandleShader");n.getParameter("maintainScreenSize").setValue(1),n.getParameter("BaseColor").setValue(i);const o=new e.Sphere(s,64),a=new e.GeomItem("mask",o,n);this.addChild(a);}highlight(){}unhighlight(){}setTargetParam(e,t=!0){if(this.param=e,t){const t=()=>{this.setGlobalXfo(e.getValue());};t(),e.valueChanged.connect(t);}}getTargetParam(){return this.param?this.param:this.getParameter("GlobalXfo")}handleMouseDown(e){return !0}handleMouseMove(e){return !0}handleMouseUp(e){return !0}onDragStart(t){this.baseXfo=this.getGlobalXfo(),this.baseXfo.sc.set(1,1,1),this.deltaXfo=new e.Xfo;const s=this.getTargetParam();this.offsetXfo=this.baseXfo.inverse().multiply(s.getValue()),this.vec0=t.grabPos.subtract(this.baseXfo.tr),this.vec0.normalizeInPlace(),this.colorParam.setValue(new e.Color(1,1,1)),t.undoRedoManager&&(this.change=new ParameterValueChange(s),t.undoRedoManager.addChange(this.change));}onDrag(e){const t=e.holdPos.subtract(this.baseXfo.tr);t.normalizeInPlace();const s=this.vec0.angleTo(t)*modulator,i=this.vec0.cross(t).normalize();this.deltaXfo.ori.setFromAxisAndAngle(i,s);const n=this.baseXfo.multiply(this.deltaXfo),o=n.multiply(this.offsetXfo);if(this.change)this.change.update({value:o});else {this.getTargetParam().setValue(n);}}onDragEnd(e){this.change=null,this.colorParam.setValue(this.__color);}}class _ extends d{constructor(t,s,i,n){super(t),this.__color=i,this.__hilightedColor=new e.Color(1,1,1),this.sizeParam=this.addParameter(new e.NumberParameter("size",s)),this.colorParam=this.addParameter(new e.ColorParameter("BaseColor",i));const o=new e.Material("handle","HandleShader");o.getParameter("maintainScreenSize").setValue(1),o.replaceParameter(this.colorParam);const a=new e.Cuboid(s,s,.02*s),r=new e.Xfo;r.tr=n,a.transformVertices(r),this.handle=new e.GeomItem("handle",a,o),this.sizeParam.valueChanged.connect(()=>{s=this.sizeParam.getValue(),a.getParameter("size").setValue(s),a.getParameter("height").setValue(.02*s);}),this.addChild(this.handle);}highlight(){this.colorParam.setValue(this.__hilightedColor);}unhighlight(){this.colorParam.setValue(this.__color);}}class f extends e.TreeItem{constructor(t,s){super("XfoHandle");const i=new e.TreeItem("Translate");i.setVisible(!1),this.addChild(i);const n=new e.Color(1,.1,.1),o=new e.Color("#32CD32"),a=new e.Color("#1E90FF");n.a=.8,o.a=.8,a.a=.8;{const o=new c("linearX",t,s,n),a=new e.Xfo;a.ori.setFromAxisAndAngle(new e.Vec3(0,1,0),.5*Math.PI),o.getParameter("LocalXfo").setValue(a),i.addChild(o);}{const n=new c("linearY",t,s,o),a=new e.Xfo;a.ori.setFromAxisAndAngle(new e.Vec3(1,0,0),-.5*Math.PI),n.getParameter("LocalXfo").setValue(a),i.addChild(n);}{const e=new c("linearZ",t,s,a);i.addChild(e);}const r=.35*t;{const t=new _("planarXY",r,o,new e.Vec3(.5*r,.5*r,0)),s=new e.Xfo;t.getParameter("LocalXfo").setValue(s),i.addChild(t);}{const t=new _("planarYZ",r,n,new e.Vec3(-.5*r,.5*r,0)),s=new e.Xfo;s.ori.setFromAxisAndAngle(new e.Vec3(0,1,0),.5*Math.PI),t.getParameter("LocalXfo").setValue(s),i.addChild(t);}{const t=new _("planarXZ",r,a,new e.Vec3(.5*r,.5*r,0)),s=new e.Xfo;s.ori.setFromAxisAndAngle(new e.Vec3(1,0,0),.5*Math.PI),t.getParameter("LocalXfo").setValue(s),i.addChild(t);}const l=new e.TreeItem("Rotate");l.setVisible(!1),this.addChild(l);{const i=new p("rotation",t-s,new e.Color(1,1,1,.4));l.addChild(i);}{const i=new u("rotationX",t,s,n),o=new e.Xfo;o.ori.setFromAxisAndAngle(new e.Vec3(0,1,0),.5*Math.PI),i.getParameter("LocalXfo").setValue(o),l.addChild(i);}{const i=new u("rotationY",t,s,o),n=new e.Xfo;n.ori.setFromAxisAndAngle(new e.Vec3(1,0,0),.5*Math.PI),i.getParameter("LocalXfo").setValue(n),l.addChild(i);}{const e=new u("rotationZ",t,s,a);l.addChild(e);}const h=new e.TreeItem("Scale");h.setVisible(!1),this.addChild(h);const d=.95*t;{const t=new g("scaleX",d,s,n),i=new e.Xfo;i.ori.setFromAxisAndAngle(new e.Vec3(0,1,0),.5*Math.PI),t.getParameter("LocalXfo").setValue(i),h.addChild(t);}{const t=new g("scaleY",d,s,o),i=new e.Xfo;i.ori.setFromAxisAndAngle(new e.Vec3(1,0,0),-.5*Math.PI),t.getParameter("LocalXfo").setValue(i),h.addChild(t);}{const e=new g("scaleZ",d,s,a);h.addChild(e);}}_cleanGlobalXfo(e){const t=this.getParentItem();if(void 0!==t){const e=t.getGlobalXfo().clone();return e.sc.set(1,1,1),e.multiply(this.__localXfoParam.getValue())}return this.__localXfoParam.getValue()}showHandles(e){this.traverse(e=>{if(e!=this)return e.setVisible(!1),!1});const t=this.getChildByName(e);t&&t.setVisible(!0);}setTargetParam(e){this.param=e,this.traverse(t=>{t instanceof r&&t.setTargetParam(e,!1);});}}class v extends e.Group{constructor(t){let s,i;super(),t.selectionOutlineColor?s=t.selectionOutlineColor:(s=new e.Color("#03E3AC"),s.a=.1),t.branchSelectionOutlineColor?i=t.branchSelectionOutlineColor:(i=s.lerp(new e.Color("white"),.5),i.a=.1),this.getParameter("HighlightColor").setValue(s),this.addParameter(new e.ColorParameter("SubtreeHighlightColor",i)),this.propagatingSelectionToItems=0!=t.setItemsSelected,this.getParameter("InitialXfoMode").setValue(e.Group.INITIAL_XFO_MODES.average),this.__itemsParam.setFilterFn(t=>t instanceof e.BaseItem);}clone(e){const t=new v;return t.copyFrom(this,e),t}rebindInitialXfos(){Array.from(this.__itemsParam.getValue()).forEach((t,s)=>{t instanceof e.TreeItem&&(this.__initialXfos[s]=t.getGlobalXfo());});}__bindItem(t,s){this.propagatingSelectionToItems&&t.setSelected(this);const i={};if(t instanceof e.TreeItem){const n=this.getParameter("HighlightColor").getValue();n.a=this.getParameter("HighlightFill").getValue();const o=this.getParameter("SubtreeHighlightColor").getValue();t.addHighlight("selected"+this.getId(),n,!1),t.getChildren().forEach(t=>{t instanceof e.TreeItem&&t.addHighlight("branchselected"+this.getId(),o,!0);}),i.globalXfoChangedIndex=t.globalXfoChanged.connect(e=>{this.calculatingGroupXfo||this.propagatingXfoToItems||(this.__initialXfos[s]=t.getGlobalXfo(),this._setGlobalXfoDirty());}),this.__initialXfos[s]=t.getGlobalXfo();}this.__signalIndices[s]=i;}__unbindItem(t,s){this.propagatingSelectionToItems&&t.setSelected(!1),t instanceof e.TreeItem&&(t.removeHighlight("selected"+this.getId()),t.getChildren().forEach(t=>{t instanceof e.TreeItem&&t.removeHighlight("branchselected"+this.getId(),!0);}),t.globalXfoChanged.disconnectId(this.__signalIndices[s].globalXfoChangedIndex),this.__initialXfos.splice(s,1)),this.__signalIndices.splice(s,1);}_propagateDirtyXfoToItems(){if(this.calculatingGroupXfo)return;const t=Array.from(this.__itemsParam.getValue());if(!this.calculatingGroupXfo&&t.length>0&&this.invGroupXfo&&!this.dirty){const s=this.__globalXfoParam.getValue().multiply(this.invGroupXfo);this.propagatingXfoToItems=!0;const i=(e,t)=>{const i=e.getParameter("GlobalXfo"),n=s.multiply(t);i.setValue(n);};t.forEach((t,s)=>{t instanceof e.TreeItem&&i(t,this.__initialXfos[s]);}),this.propagatingXfoToItems=!1;}}}class C extends a{constructor(e,t,s){super("SelectionChange"),this.__selectionManager=e,this.__prevSelection=t,this.__newSelection=s;}undo(){this.__selectionManager.setSelection(this.__prevSelection,!1);}redo(){this.__selectionManager.setSelection(this.__newSelection,!1);}toJSON(e){const t=super.toJSON(e),s=[];for(const e of this.__newSelection)s.push(e.getPath());return t.itemPaths=s,t}fromJSON(e,t){super.fromJSON(e,t),this.__selectionManager=t.appData.selectionManager,this.__prevSelection=new Set(this.__selectionManager.getSelection());const s=t.appData.scene.getRoot(),i=new Set;for(const t of e.itemPaths)i.add(s.resolvePath(t,1));this.__newSelection=i,this.__selectionManager.setSelection(this.__newSelection,!1);}}o.registerChange("SelectionChange",C);class b extends a{constructor(e,t){super("Selection Visibility Change"),this.selection=e,this.state=t,this.do(this.state);}undo(){this.do(!this.state);}redo(){this.do(this.state);}do(e){for(const t of this.selection)t.getParameter("Visible").setValue(e);}}o.registerChange("ToggleSelectionVisibility",b);class I{constructor(t,s={}){if(this.appData=t,this.leadSelection=void 0,this.selectionChanged=new e.Signal,this.leadSelectionChanged=new e.Signal,this.selectionGroup=new v(s),!0===s.enableXfoHandles){const s=.1,i=.02*s;this.xfoHandle=new f(s,i),this.xfoHandle.setTargetParam(this.selectionGroup.getParameter("GlobalXfo"),!1),this.xfoHandle.setVisible(!1),this.selectionGroup.addChild(this.xfoHandle),this.handleGroup={Translate:new e.Signal,Rotate:new e.Signal,Scale:new e.Signal},this.currMode="",t.actionRegistry.registerAction({name:"Translate",path:["Edit"],callback:()=>{this.showHandles("Translate");},key:"w",activatedChanged:this.handleGroup.Translate}),t.actionRegistry.registerAction({name:"Rotate",path:["Edit"],callback:()=>{this.showHandles("Rotate");},key:"e",activatedChanged:this.handleGroup.Rotate}),t.actionRegistry.registerAction({name:"Scale",path:["Edit"],callback:()=>{this.showHandles("Scale");},key:"r",activatedChanged:this.handleGroup.Scale}),t.actionRegistry.registerAction({name:"Local",path:["Edit","Coords"],callback:()=>{this.setXfoMode(ZeaEngine.Group.INITIAL_XFO_MODES.average);},key:"k",activatedChanged:this.handleGroup.Translate}),t.actionRegistry.registerAction({name:"Global",path:["Edit","Coords"],callback:()=>{this.setXfoMode(ZeaEngine.Group.INITIAL_XFO_MODES.globalOri);},key:"l",activatedChanged:this.handleGroup.Rotate});}this.appData.renderer&&this.setRenderer(this.appData.renderer);}setRenderer(e){this.__renderer=e,this.__renderer.addTreeItem(this.selectionGroup);}setXfoMode(e){this.xfoHandle&&(this.selectionGroup.rebindInitialXfos(),this.selectionGroup.getParameter("InitialXfoMode").setValue(e));}showHandles(e){if(this.xfoHandle&&this.currMode!=e){this.currMode=e;for(const t in this.handleGroup)this.handleGroup[t].emit(e==t);this.xfoHandle.showHandles(e);}}updateHandleVisiblity(){if(!this.xfoHandle)return;const e=this.selectionGroup.getItems(),t=Array.from(e).length>0;this.xfoHandle.setVisible(t),this.__renderer.requestRedraw();}getSelection(){return this.selectionGroup.getItems()}setSelection(e,t=!0){const s=new Set(this.selectionGroup.getItems()),i=new Set(s);for(const t of e)s.has(t)||s.add(t);for(const t of s)e.has(t)||s.delete(t);if(this.selectionGroup.setItems(s),s.size>0?this.__setLeadSelection(s.values().next().value):this.__setLeadSelection(),this.updateHandleVisiblity(),t){const e=new C(this,i,s);this.appData.undoRedoManager&&this.appData.undoRedoManager.addChange(e);}}__setLeadSelection(e){this.leadSelection!=e&&(this.leadSelection=e,this.leadSelectionChanged.emit(e));}toggleItemSelection(e,t=!0){const s=new Set(this.selectionGroup.getItems()),i=new Set(s);if(t&&(1!=s.size||!s.has(e))){let t=!0;if(s.has(e)){let i=1;e.traverse(e=>{s.has(e)&&i++;}),t=i!=s.size;}t&&s.clear();}let n;s.has(e)?(s.delete(e),n=!1):(s.add(e),n=!0),this.selectionGroup.setItems(s),n&&1===s.size?this.__setLeadSelection(e):n||(1===s.size?this.__setLeadSelection(s.values().next().value):0===s.size&&this.__setLeadSelection());const o=new C(this,i,s);this.appData.undoRedoManager&&this.appData.undoRedoManager.addChange(o),this.updateHandleVisiblity(),this.selectionChanged.emit(i);}clearSelection(e=!0){const t=new Set(this.selectionGroup.getItems());if(0==t.size)return !1;let s;if(e&&(s=new Set(t)),t.clear(),this.selectionGroup.setItems(t),this.updateHandleVisiblity(),e){const e=new C(this,s,t);this.appData.undoRedoManager&&this.appData.undoRedoManager.addChange(e),this.selectionChanged.emit(t);}return !0}selectItems(e,t=!0){const s=new Set(this.selectionGroup.getItems()),i=new Set(s);t&&s.clear();for(const t of e)t.getSelected()||s.add(t);const n=new C(this,i,s);this.appData.undoRedoManager&&this.appData.undoRedoManager.addChange(n),this.selectionGroup.setItems(s),1===s.size?this.__setLeadSelection(s.values().next().value):0===s.size&&this.__setLeadSelection(),this.updateHandleVisiblity(),this.selectionChanged.emit(s);}deselectItems(e){const t=this.selectionGroup.getItems(),s=new Set(t);for(const s of e)s.getSelected()&&t.delete(selectedParam);this.selectionGroup.setItems(t);const i=new C(this,s,t);this.appData.undoRedoManager&&this.appData.undoRedoManager.addChange(i),1===t.size?this.__setLeadSelection(t.values().next().value):0===t.size&&this.__setLeadSelection(),this.updateHandleVisiblity(),this.selectionChanged.emit(t);}toggleSelectionVisiblity(){if(this.leadSelection){const e=this.selectionGroup.getItems(),t=!this.leadSelection.getVisible(),s=new b(e,t);this.appData.undoRedoManager&&this.appData.undoRedoManager.addChange(s);}}startPickingMode(e,t,s,i){console.log(e),this.__pickCB=t,this.__pickFilter=s,this.__pickCount=i,this.__picked=[];}pickingFilter(e){return this.__pickFilter(e)}pickingModeActive(){return null!=this.__pickCB}cancelPickingMode(){this.__pickCB=void 0;}pick(e){if(this.__pickCB){if(Array.isArray(e))this.__pickFilter?this.__picked=this.__picked.concat(e.filter(this.__pickFilter)):this.__picked=this.__picked.concat(e);else {if(this.__pickFilter&&!this.__pickFilter(e))return;this.__picked.push(e);}this.__picked.length==this.__pickCount&&(this.__pickCB(this.__picked),this.__pickCB=void 0);}}}const w=new e.Vec3(0,0,1);class P{constructor(t,s,i=!1){if(this.__appData=t,this.__userData=s,this.__currentUserAvatar=i,this.__treeItem=new e.TreeItem(this.__userData.id),this.__treeItem.addRef(this),this.__appData.renderer.addTreeItem(this.__treeItem),this.__avatarColor=new e.Color(.3,.3,.3),this.__hilightPointerColor=new e.Color(1.2,0,0),this.__plane=new e.Plane(1,1),this.__uiGeomIndex=-1,!this.__currentUserAvatar){let t,s;if(this.__camera=new e.Camera,this.__camera.addRef(this),this.__cameraBound=!1,this.__userData.picture&&""!=this.__userData.picture)t=new e.LDRImage("user"+this.__userData.id+"AvatarImage"),t.setImageURL(this.__userData.picture),s=new e.Disc(.5,64);else {t=new e.Label(name);const i=new e.Color(.84,.84,.84);t.getParameter("backgroundColor").setValue(i),t.getParameter("fontSize").setValue(48),t.getParameter("borderRadius").setValue(15),t.getParameter("margin").setValue(8),t.getParameter("text").setValue(this.__userData.name),s=new e.Plane(2,.5),t.labelRendered.connect(e=>{const t=e.width/e.height;s.getParameter("SizeX").setValue(.5*t);});}const i=new e.Material("user"+this.__userData.id+"AvatarImageMaterial","FlatSurfaceShader");i.getParameter("BaseColor").setValue(this.__avatarColor),i.getParameter("BaseColor").setImage(t),i.visibleInGeomDataBuffer=!1,this.__avatarImageGeomItem=new e.GeomItem("avatarImage",s,i),this.__avatarImageXfo=new e.Xfo,this.__avatarImageXfo.sc.set(.2,.2,1),this.__avatarImageXfo.ori.setFromAxisAndAngle(new e.Vec3(0,1,0),Math.PI),this.__avatarImageGeomItem.setLocalXfo(this.__avatarImageXfo),this.__avatarImageGeomItem.addRef(this);}}attachRTCStream(t){if(!this.__avatarCamGeomItem){const s=new e.VideoStreamImage2D("webcamStream");s.setVideoStream(t),this.__avatarCamMaterial=new e.Material("user"+this.__userData.id+"AvatarImageMaterial","FlatSurfaceShader"),this.__avatarCamMaterial.getParameter("BaseColor").setValue(this.__avatarColor),this.__avatarCamMaterial.getParameter("BaseColor").setImage(s),this.__avatarCamMaterial.visibleInGeomDataBuffer=!1,this.__avatarCamGeomItem=new e.GeomItem("avatarImage",this.__plane,this.__avatarCamMaterial),this.__avatarCamGeomItem.addRef(this);const i=.02;this.__avatarCamXfo=new e.Xfo,this.__avatarCamXfo.sc.set(16*i,9*i,1),this.__avatarCamXfo.tr.set(0,0,-.1*i),this.__avatarCamGeomItem.setLocalXfo(this.__avatarCamXfo);const n=t.videoWidth/t.videoHeight;this.__avatarCamXfo.sc.x=this.__avatarCamXfo.sc.y*n,this.__avatarImageGeomItem.setLocalXfo(this.__avatarCamXfo);}"CameraAndPointer"==this.__currentViewMode&&(this.__treeItem.getChild(0).removeAllChildren(),this.__treeItem.getChild(0).addChild(this.__avatarCamGeomItem,!1));}detachRTCStream(){if("CameraAndPointer"==this.__currentViewMode){this.__treeItem.getChild(0).removeAllChildren();const e=.02;this.__avatarImageXfo.sc.set(9*e,9*e,1),this.__avatarImageXfo.tr.set(0,0,-.1*e),this.__avatarImageGeomItem.setLocalXfo(this.__avatarImageXfo),this.__treeItem.getChild(0).addChild(this.__avatarImageGeomItem,!1);}}getCamera(){return this.__camera}bindCamera(){this.__cameraBound=!0;const e=this.__camera.getOwner();e&&e.traverse(e=>{e!=this.__camera&&e.setVisible(!1);});}unbindCamera(){this.__cameraBound=!1;const e=this.__camera.getOwner();e&&e.traverse(e=>{e!=this.__camera&&e.setVisible(!0);});}setCameraAndPointerRepresentation(){if(this.__treeItem.removeAllChildren(),this.__currentViewMode="CameraAndPointer",this.__currentUserAvatar)return;const t=new e.Cuboid(.32,.18,.06,!0),s=new e.Vec3(.1,.1,1);t.getVertex(0).multiplyInPlace(s),t.getVertex(1).multiplyInPlace(s),t.getVertex(2).multiplyInPlace(s),t.getVertex(3).multiplyInPlace(s),t.computeVertexNormals();const i=new e.Material("user"+this.__userData.id+"Material","SimpleSurfaceShader");i.visibleInGeomDataBuffer=!1,i.getParameter("BaseColor").setValue(this.__avatarColor);const n=new e.GeomItem("camera",t,i),o=new e.Xfo;n.setGeomOffsetXfo(o);const a=new e.Lines;a.setNumVertices(2),a.setNumSegments(1),a.setSegment(0,0,1),a.getVertex(0).set(0,0,0),a.getVertex(1).set(0,0,1),a.setBoundingBoxDirty(),this.pointerXfo=new e.Xfo,this.pointerXfo.sc.set(1,1,0),this.__pointermat=new e.Material("pointermat","LinesShader"),this.__pointermat.getParameter("Color").setValue(this.__avatarColor),this.__pointerItem=new e.GeomItem("Pointer",a,this.__pointermat),this.__pointerItem.addRef(this),this.__pointerItem.setLocalXfo(this.pointerXfo),this.__avatarCamGeomItem?n.addChild(this.__avatarCamGeomItem,!1):this.__avatarImageGeomItem&&(this.__avatarImageXfo.sc.set(.18,.18,1),this.__avatarImageXfo.tr.set(0,0,-.002),this.__avatarImageGeomItem.setLocalXfo(this.__avatarImageXfo),n.addChild(this.__avatarImageGeomItem,!1)),this.__audioItem&&n.addChild(this.__audioItem,!1),this.__treeItem.addChild(n,!1),this.__treeItem.addChild(this.__pointerItem,!1),this.__treeItem.addChild(this.__camera,!1),this.__cameraBound&&n.setVisible(!1);}updateCameraAndPointerPose(e){if(!this.__currentUserAvatar)if(e.viewXfo){if(e.focalDistance){const t=e.focalDistance/5;t>1&&e.viewXfo.sc.set(t,t,t);}this.__treeItem.getChild(0).setLocalXfo(e.viewXfo),this.pointerXfo.sc.z=0,this.__treeItem.getChild(1).setLocalXfo(this.pointerXfo);}else e.movePointer?(this.pointerXfo.tr=e.movePointer.start,this.pointerXfo.ori.setFromDirectionAndUpvector(e.movePointer.dir,w),this.pointerXfo.sc.z=e.movePointer.length,this.__treeItem.getChild(1).setLocalXfo(this.pointerXfo)):e.hilightPointer?this.__pointermat.getParameter("Color").setValue(this.__hilightPointerColor):e.unhilightPointer?this.__pointermat.getParameter("Color").setValue(this.__avatarColor):e.hidePointer&&(this.pointerXfo.sc.z=0,this.__treeItem.getChild(1).setLocalXfo(this.pointerXfo));}setVRRepresentation(t){this.__treeItem.removeAllChildren(),this.__currentViewMode="VR";const s=new e.TreeItem("hmdHolder");if(this.__audioItem&&s.addChild(this.__audioItem),this.__avatarImageGeomItem&&(this.__avatarImageXfo.sc.set(.12,.12,1),this.__avatarImageXfo.tr.set(0,-.04,-.135),this.__avatarImageGeomItem.setLocalXfo(this.__avatarImageXfo),s.addChild(this.__avatarImageGeomItem,!1)),this.__treeItem.addChild(s),this.__camera&&s.addChild(this.__camera,!1),this.__hmdGeomItem)this.__currentUserAvatar||s.addChild(this.__hmdGeomItem,!1),this.__cameraBound&&this.__hmdGeomItem.setVisible(!1);else {const i=this.__appData.scene.getResourceLoader();let n;switch(t.hmd){case"Vive":n="ZeaEngine/Vive.vla";break;case"Oculus":n="ZeaEngine/Oculus.vla";break;default:n="ZeaEngine/Vive.vla";}if(!this.__vrAsset){const t=i.resolveFilePathToId(n);t&&(this.__vrAsset=this.__appData.scene.loadCommonAssetResource(t),this.__vrAsset.geomsLoaded.connect(()=>{const t=this.__vrAsset.getMaterialLibrary(),i=t.getMaterialNames();for(const e of i){const s=t.getMaterial(e,!1);s&&(s.visibleInGeomDataBuffer=!1,s.setShaderName("SimpleSurfaceShader"));}if(!this.__currentUserAvatar){const t=this.__vrAsset.getChildByName("HMD").clone(),i=t.getLocalXfo();i.tr.set(0,-.03,-.03),i.ori.setFromAxisAndAngle(new e.Vec3(0,1,0),Math.PI),i.sc.set(.001),t.setLocalXfo(i),this.__hmdGeomItem=t,this.__hmdGeomItem.addRef(this),this.__cameraBound&&this.__hmdGeomItem.setVisible(!1),s.addChild(this.__hmdGeomItem,!1);}}));}}this.__controllerTrees=[];}updateVRPose(t){const s=t=>{if(this.__controllerTrees[t])this.__treeItem.addChild(this.__controllerTrees[t],!1);else {const s=new e.TreeItem("handleHolder"+t);s.addRef(this),this.__controllerTrees[t]=s,this.__treeItem.addChild(this.__controllerTrees[t],!1);const i=()=>{let i;0==t?i=this.__vrAsset.getChildByName("LeftController"):1==t&&(i=this.__vrAsset.getChildByName("RightController")),i||(i=this.__vrAsset.getChildByName("Controller"));const n=i.clone(),o=new e.Xfo(new e.Vec3(0,-.035,-.085),new e.Quat({setFromAxisAndAngle:[new e.Vec3(0,1,0),Math.PI]}),new e.Vec3(.001,.001,.001));n.setLocalXfo(o),s.addChild(n,!1);};this.__vrAsset.geomsLoaded.connect(()=>{i();});}};if(t.viewXfo&&this.__treeItem.getChild(0).setGlobalXfo(t.viewXfo),t.controllers)for(let e=0;e<t.controllers.length;e++)t.controllers[e]&&!this.__controllerTrees[e]&&s(e),this.__controllerTrees[e].setGlobalXfo(t.controllers[e].xfo);if(t.showUIPanel){if(!this.__uiGeomItem){const s=new e.Material("uimat","FlatSurfaceShader");s.getParameter("BaseColor").setValue(this.__avatarColor),this.__uiGeomOffsetXfo=new e.Xfo,this.__uiGeomOffsetXfo.sc.set(t.showUIPanel.size.x,t.showUIPanel.size.y,1),this.__uiGeomOffsetXfo.ori.setFromAxisAndAngle(new e.Vec3(0,1,0),Math.PI),this.__uiGeomItem=new e.GeomItem("VRControllerUI",this.__plane,s),this.__uiGeomItem.addRef(this),this.__uiGeomItem.setGeomOffsetXfo(this.__uiGeomOffsetXfo);const i=new e.Xfo;i.fromJSON(t.showUIPanel.localXfo),this.__uiGeomItem.setLocalXfo(i);}this.__uiGeomIndex=this.__controllerTrees[t.showUIPanel.controllerId].addChild(this.__uiGeomItem,!1);}else t.updateUIPanel?this.__uiGeomItem&&(this.__uiGeomOffsetXfo.sc.set(t.updateUIPanel.size.x,t.updateUIPanel.size.y,1),this.__uiGeomItem.setGeomOffsetXfo(this.__uiGeomOffsetXfo)):t.hideUIPanel&&this.__uiGeomIndex>=0&&(this.__controllerTrees[t.hideUIPanel.controllerId].removeChild(this.__uiGeomIndex),this.__uiGeomIndex=-1);}updatePose(e){switch(e.interfaceType){case"CameraAndPointer":"CameraAndPointer"!==this.__currentViewMode&&this.setCameraAndPointerRepresentation(),this.updateCameraAndPointerPose(e);break;case"Vive":case"VR":"VR"!==this.__currentViewMode&&this.setVRRepresentation(e),this.updateVRPose(e);}}destroy(){this.__appData.renderer.removeTreeItem(this.__treeItem),this.__treeItem.removeRef(this),this.__camera||this.__camera.removeRef(this);}}const T=t=>{if(null!=t){if(t instanceof e.BaseItem)return "::"+t.getPath();if(t.toJSON){const s=t.toJSON();return s.typeName=e.typeRegistry.getTypeName(t.constructor),s}if(Array.isArray(t)){const e=[];for(const s of t)e.push(T(s));return e}if("object"==typeof t){const e={};for(const s in t)e[s]=T(t[s]);return e}return t}},E=(t,s)=>{if(null!=t){if("string"==typeof t&&t.startsWith("::"))return s.getRoot().resolvePath(t,1);if(t.typeName){const s=e.typeRegistry.getType(t.typeName).create();return s.fromJSON(t),s}if(Array.isArray(t)){const e=[];for(const i of t)e.push(E(i,s));return e}if("object"==typeof t){const e={};for(const i in t)e[i]=E(t[i],s);return e}return t}};class y extends a{constructor(e,t,s){e?(super(e.getName()+" Added"),this.treeItem=e,this.owner=t,this.selectionManager=s,this.prevSelection=new Set(this.selectionManager.getSelection()),this.treeItemIndex=this.owner.addChild(this.treeItem),this.selectionManager.setSelection(new Set([this.treeItem]),!1),this.treeItem.addRef(this)):super();}undo(){if(this.treeItem instanceof e.Operator){this.treeItem.detach();}else this.treeItem instanceof e.TreeItem&&this.treeItem.traverse(t=>{if(t instanceof e.Operator){t.detach();}},!1);this.owner.removeChild(this.treeItemIndex),this.selectionManager&&this.selectionManager.setSelection(this.prevSelection,!1);}redo(){if(this.treeItem instanceof e.Operator){this.treeItem.reattach();}else subTreeItem instanceof e.TreeItem&&this.treeItem.traverse(t=>{if(t instanceof e.Operator){t.reattach();}},!1);this.owner.addChild(this.treeItem),this.selectionManager&&this.selectionManager.setSelection(new Set([this.treeItem]),!1);}toJSON(e){return {name:this.name,treeItem:this.treeItem.toJSON(e),treeItemPath:this.treeItem.getPath(),treeItemIndex:this.treeItemIndex}}fromJSON(t,s){const i=e.sgFactory.constructClass(t.treeItem.type);i?(this.name=t.name,this.treeItem=i,this.treeItem.addRef(this),this.treeItem.fromJSON(t.treeItem,s),this.treeItemIndex=this.owner.addChild(this.treeItem,!1,!1)):console.warn("resolvePath is unable to conostruct",t.treeItem);}destroy(){this.treeItem.removeRef(this);}}o.registerChange("TreeItemAddChange",y);class S extends a{constructor(t,s){if(super(),this.items=[],this.itemOwners=[],this.itemPaths=[],this.itemIndices=[],t){this.selectionManager=s.selectionManager,this.prevSelection=new Set(this.selectionManager.getSelection()),this.items=t,this.newSelection=new Set(this.prevSelection);const i=[];this.items.forEach(t=>{const s=t.getOwner(),n=s.getChildIndex(t);if(i.push(t.getName()),t.addRef(this),this.itemOwners.push(s),this.itemPaths.push(t.getPath()),this.itemIndices.push(n),this.selectionManager&&this.newSelection.has(t)&&this.newSelection.delete(t),t instanceof e.Operator){t.detach();}else t instanceof e.TreeItem&&t.traverse(t=>{if(t instanceof e.Operator){t.detach();}this.selectionManager&&this.newSelection.has(t)&&this.newSelection.delete(t);},!1);s.removeChild(n);}),this.selectionManager.setSelection(this.newSelection,!1),this.name=i+" Deleted";}}undo(){this.items.forEach((t,s)=>{if(this.itemOwners[s].insertChild(t,this.itemIndices[s],!1,!1),t instanceof e.Operator){t.reattach();}else subTreeItem instanceof e.TreeItem&&t.traverse(t=>{if(t instanceof e.Operator){t.reattach();}},!1);}),this.selectionManager&&this.selectionManager.setSelection(this.prevSelection,!1);}redo(){this.selectionManager&&this.selectionManager.setSelection(this.newSelection,!1),this.items.forEach((t,s)=>{if(this.itemOwners[s].removeChild(this.itemIndices[s]),t instanceof e.Operator){t.detach();}else subTreeItem instanceof e.TreeItem&&t.traverse(t=>{if(t instanceof e.Operator){t.detach();}},!1);});}toJSON(e){const t={name:this.name,items:[],itemPaths:this.itemPaths,itemIndices:this.itemIndices};return this.items.forEach(e=>{t.items.push(e.toJSON());}),t}fromJSON(e,t){this.name=e.name,e.itemPaths.forEach(e=>{const s=t.scene.getRoot().resolvePath(e,1);if(!s)return void console.warn("resolvePath is unable to resolve",e);const i=s.getOwner();this.itemOwners.push(i),this.itemPaths.push(s.getPath()),this.itemIndices.push(i.getChildIndex(s));});}destroy(){this.items.forEach(e=>e.removeRef(this));}}o.registerChange("TreeItemsRemoveChange",S);class M extends a{constructor(e,t){e?(console.log("TreeItemMoveChange"),super(e.getName()+" Added"),this.treeItem=e,this.oldOwner=this.treeItem.getOwner(),this.oldOwnerIndex=this.oldOwner.getChildIndex(this.treeItem),this.newOwner=t,this.newOwner.addChild(this.treeItem,!0)):super();}undo(){this.oldOwner.insertChild(this.treeItem,this.oldOwnerIndex,!0);}redo(){this.newOwner.addChild(this.treeItem,!0);}toJSON(e){return {name:this.name,treeItemPath:this.treeItem.getPath(),newOwnerPath:this.newOwner.getPath()}}fromJSON(e,t){const s=appData.scene.getRoot().resolvePath(e.treeItemPath,1);if(!s)return void console.warn("resolvePath is unable to resolve",e.treeItemPath);const i=appData.scene.getRoot().resolvePath(e.newOwnerPath,1);i?(this.name=e.name,this.treeItem=s,this.newOwner=i,this.oldOwner=this.treeItem.getOwner(),this.oldOwnerIndex=this.oldOwner.getChildIndex(this.treeItem),this.newOwner.addChild(this.treeItem,!0)):console.warn("resolvePath is unable to resolve",e.newOwnerPath);}}o.registerChange("TreeItemMoveChange",M);class D{constructor(e){}}const V=new class{constructor(){this.treeItemFactories=[],this.widgetFactories=[],this.inspectorFactories=[];}registerInpector(e,t){this.inspectorFactories.push({inspector:e,rule:t});}constructInspector(...e){const t=e[0];for(let s=this.inspectorFactories.length;s-- >0;){const i=this.inspectorFactories[s];if(i.rule(t))return new i.inspector(...e)}console.warn(`Inspector factory not found for parameter '${t.getName()}' of class '${t.constructor.name}'`);}registerTreeItemElement(e,t){this.treeItemFactories.push({treeItemElement:e,rule:t});}constructTreeItemElement(...e){const t=e[0];for(let s=this.treeItemFactories.length;s-- >0;){const i=this.treeItemFactories[s];if(i.rule(t))return new i.treeItemElement(...e)}console.warn(`Tree item factory not found for parameter '${t.getName()}' of class '${t.constructor.name}'`);}registerWidget(e,t){this.widgetFactories.push({widget:e,rule:t});}findWidgetReg(e){for(let t=this.widgetFactories.length;t-- >0;){const s=this.widgetFactories[t];if(s.rule(e))return s}}constructWidget(...e){const t=e[0];for(let s=this.widgetFactories.length;s-- >0;){const i=this.widgetFactories[s];if(i.rule(t))return new i.widget(...e)}console.warn(`Widget factory not found for parameter '${t.getName()}' of class '${t.constructor.name}'`);}};V.registerWidget(class extends D{constructor(t,s,i){super(t);const n=document.createElement("input");let o,a;n.setAttribute("id",t.getName()),n.setAttribute("type","checkbox"),n.setAttribute("tabindex",0),n.checked=t.getValue(),s.appendChild(n),t.valueChanged.connect(s=>{o||(n.checked=t.getValue(),s==e.ValueSetMode.REMOTEUSER_SETVALUE&&(n.classList.add("user-edited"),a&&clearTimeout(a),a=setTimeout(()=>{n.classList.remove("user-edited"),a=null;},1500)));}),n.addEventListener("input",()=>{o=new h(t,n.checked),i.undoRedoManager.addChange(o),o=void 0;});}},t=>t instanceof e.BooleanParameter);V.registerWidget(class extends D{constructor(t,s,i){super(t);const n=new iro.ColorPicker(s,{width:200,height:200,color:t.getValue().getAsRGBDict(),anticlockwise:!0,borderWidth:1,borderColor:"#fff"});let o,a=void 0,r=!1;t.valueChanged.connect(s=>{a||(r=!0,n.color.rgb=t.getValue().getAsRGBDict(),r=!1,s==e.ValueSetMode.REMOTEUSER_SETVALUE&&(n.el.classList.add("user-edited"),o&&clearTimeout(o),o=setTimeout(()=>{n.el.classList.remove("user-edited"),o=null;},1500)));}),n.on("input:start",()=>{console.log("input:start",t.getValue().getAsRGBDict()),a=new h(t),i.undoRedoManager.addChange(a);}),n.on("input:end",()=>{console.log("input:end"),a=void 0;}),n.on("color:change",(s,o)=>{if(r)return;const l=new e.Color;l.setFromRGBDict(n.color.rgb),a?a.update({value:l}):(a=new h(t,l),i.undoRedoManager.addChange(a));});}setParentDomElem(e){}},t=>t instanceof e.ColorParameter);V.registerWidget(class extends D{constructor(t,s,i){super(t);const n=t.getRange(),o=document.createElement("input"),a=[];if(n){a.push("mdl-slider"),a.push("mdl-js-slider"),o.className=a.join(" "),o.setAttribute("id",t.getName()),o.setAttribute("type","range"),o.setAttribute("min",0),o.setAttribute("max",200);const e=(t.getValue()-n[0])/(n[1]-n[0])*200;o.setAttribute("value",e);const s=t.getStep();s?o.setAttribute("step",s):o.setAttribute("step",1),o.setAttribute("tabindex",0);}else o.className=a.join(" "),o.setAttribute("id",t.getName()),o.setAttribute("type","number"),o.setAttribute("pattern","-?[0-9]*(.[0-9]+)?"),o.setAttribute("value",t.getValue()),o.setAttribute("tabindex",0);s.appendChild(o);let r,l=void 0;function c(e,t=6){return Number(Math.round(e+"e"+t)+"e-"+t)}t.valueChanged.connect(s=>{l||(o.value=n?(t.getValue()-n[0])/(n[1]-n[0])*200:t.getValue(),s==e.ValueSetMode.REMOTEUSER_SETVALUE&&(o.classList.add("user-edited"),r&&clearTimeout(r),r=setTimeout(()=>{o.classList.remove("user-edited"),r=null;},1500)));});const d=()=>{let e=c(o.valueAsNumber);n&&(e=n[0]+e/200*(n[1]-n[0]),e=Math.clamp(e,n[0],n[1])),l?l.update({value:e}):(l=new h(t,e),i.undoRedoManager.addChange(l));},m=()=>{l&&(t.setValueDone(),l=void 0);};o.addEventListener("input",()=>{d();}),o.addEventListener("change",m),o.addEventListener("keydown",(function(e){38!==e.which&&40!==e.which||(38===e.which&&(o.valueAsNumber=c(o.valueAsNumber+.1)),40===e.which&&(o.valueAsNumber=c(o.valueAsNumber-.1)),d(),e.preventDefault());})),o.addEventListener("focusout",m);}},t=>t instanceof e.NumberParameter);V.registerWidget(class extends D{constructor(t,s,i){super(t);const n=document.createElement("input");let o,a;n.className="mdl-textfield__input",n.setAttribute("id",t.getName()),n.setAttribute("type","text"),n.setAttribute("value",t.getValue()),n.setAttribute("tabindex",0),s.appendChild(n),t.valueChanged.connect(s=>{o||(n.value=t.getValue(),s==e.ValueSetMode.REMOTEUSER_SETVALUE&&(n.classList.add("user-edited"),a&&clearTimeout(a),a=setTimeout(()=>{n.classList.remove("user-edited"),a=null;},1500)));});const r=()=>{const e=n.value;o?o.update({value:e}):(o=new h(t,e),i.undoRedoManager.addChange(o));};n.addEventListener("input",r),n.addEventListener("change",()=>{r(),o=void 0;});}},t=>t instanceof e.StringParameter);function x(e,t=6){return Math.abs(e)<Number("1e-6")?0:Number(Math.round(e+"e"+t)+"e-"+t)}V.registerWidget(class extends D{constructor(t,s,i){super(t);const n=document.createElement("div");n.setAttribute("id",t.getName()),n.textContent=t.getValue(),n.style.width="100%";const o=Math.min(50,t.getValue().split("\n").length);n.style.height=14*Math.max(8,o+2)+"px",s.appendChild(n);const a=ace.edit(n);let r,l;a.setTheme("ace/theme/chrome"),a.session.setMode("ace/mode/javascript"),t.valueChanged.connect(s=>{r||(a.session.setValue(t.getValue()),s==e.ValueSetMode.REMOTEUSER_SETVALUE&&(n.classList.add("user-edited"),l&&clearTimeout(l),l=setTimeout(()=>{n.classList.remove("user-edited"),l=null;},1500)));});const c=()=>{(()=>{const e=a.getValue();r?r.update({value:e}):(r=new h(t,e),i.undoRedoManager.addChange(r));})(),t.setValueDone(),r=void 0;};n.addEventListener("keydown",e=>{e.ctrlKey&&"s"==e.key&&(c(),e.preventDefault()),e.stopPropagation();});}},t=>t instanceof e.CodeParameter);V.registerWidget(class extends D{constructor(t,s,i){super(t);const n=document.createElement("div");n.className="container";const o=document.createElement("ul");o.className="flex-editvalues",n.appendChild(o);const a=document.createElement("input");a.setAttribute("id",t.getName()),a.setAttribute("type","number"),a.setAttribute("pattern","-?[0-9]*(.[0-9]+)?"),a.setAttribute("value",t.getValue().x),a.setAttribute("tabindex",0),a.style.width="100%";const r=document.createElement("li");r.appendChild(a),o.appendChild(r);const l=document.createElement("input");l.setAttribute("id",t.getName()),l.setAttribute("type","number"),l.setAttribute("pattern","-?[0-9]*(.[0-9]+)?"),l.setAttribute("value",t.getValue().y),l.setAttribute("tabindex",0),l.style.width="100%";const c=document.createElement("li");c.appendChild(l),o.appendChild(c),s.appendChild(n);let d,m=void 0;t.valueChanged.connect(()=>{if(!m){const s=t.getValue();a.value=x(s.x),l.value=x(s.y),mode==e.ValueSetMode.REMOTEUSER_SETVALUE&&(n.classList.add("user-edited"),d&&clearTimeout(d),d=setTimeout(()=>{n.classList.remove("user-edited"),d=null;},1500));}});const u=()=>{const s=new e.Vec2(a.valueAsNumber,l.valueAsNumber);m?m.update({value:s}):(m=new h(t,s),i.undoRedoManager.addChange(m));},g=()=>{u(),m=void 0;};a.addEventListener("input",u),l.addEventListener("input",u),a.addEventListener("change",g),l.addEventListener("change",g);}},t=>t instanceof e.Vec2Parameter);V.registerWidget(class extends D{constructor(t,s,i){super(t);const n=document.createElement("div");n.className="container";const o=document.createElement("ul");o.className="flex-editvalues",n.appendChild(o);const a=document.createElement("input");a.setAttribute("id",t.getName()),a.setAttribute("type","number"),a.setAttribute("pattern","-?[0-9]*(.[0-9]+)?"),a.setAttribute("value",t.getValue().x),a.setAttribute("tabindex",0),a.style.width="100%";const r=document.createElement("li");r.appendChild(a),o.appendChild(r);const l=document.createElement("input");l.setAttribute("id",t.getName()),l.setAttribute("type","number"),l.setAttribute("pattern","-?[0-9]*(.[0-9]+)?"),l.setAttribute("value",t.getValue().y),l.setAttribute("tabindex",0),l.style.width="100%";const c=document.createElement("li");c.appendChild(l),o.appendChild(c);const d=document.createElement("input");d.setAttribute("id",t.getName()),d.setAttribute("type","number"),d.setAttribute("pattern","-?[0-9]*(.[0-9]+)?"),d.setAttribute("value",t.getValue().z),d.setAttribute("tabindex",0),d.style.width="100%";const m=document.createElement("li");m.appendChild(d),o.appendChild(m),s.appendChild(n);let u,g=void 0;t.valueChanged.connect(()=>{if(!g){const s=t.getValue();a.value=x(s.x),l.value=x(s.y),d.value=x(s.z),mode==e.ValueSetMode.REMOTEUSER_SETVALUE&&(n.classList.add("user-edited"),u&&clearTimeout(u),u=setTimeout(()=>{n.classList.remove("user-edited"),u=null;},1500));}});const p=()=>{const s=new e.Vec3(a.valueAsNumber,l.valueAsNumber,d.valueAsNumber);g?g.update({value:s}):(g=new h(t,s),i.undoRedoManager.addChange(g));},_=()=>{p(),g=void 0;};a.addEventListener("input",p),l.addEventListener("input",p),d.addEventListener("input",p),a.addEventListener("change",_),l.addEventListener("change",_),d.addEventListener("change",_);}},t=>t instanceof e.Vec3Parameter);V.registerWidget(class extends D{constructor(t,s,i){super(t);const n=document.createElement("div");n.className="container";const o=document.createElement("ul");o.className="flex-editvalues",n.appendChild(o);const a=document.createElement("input");a.setAttribute("id",t.getName()),a.setAttribute("type","number"),a.setAttribute("pattern","-?[0-9]*(.[0-9]+)?"),a.setAttribute("value",t.getValue().x),a.setAttribute("tabindex",0),a.style.width="100%";const r=document.createElement("li");r.appendChild(a),o.appendChild(r);const l=document.createElement("input");l.setAttribute("id",t.getName()),l.setAttribute("type","number"),l.setAttribute("pattern","-?[0-9]*(.[0-9]+)?"),l.setAttribute("value",t.getValue().y),l.setAttribute("tabindex",0),l.style.width="100%";const c=document.createElement("li");c.appendChild(l),o.appendChild(c);const d=document.createElement("input");d.setAttribute("id",t.getName()),d.setAttribute("type","number"),d.setAttribute("pattern","-?[0-9]*(.[0-9]+)?"),d.setAttribute("value",t.getValue().z),d.setAttribute("tabindex",0),d.style.width="100%";const m=document.createElement("li");m.appendChild(d),o.appendChild(m);const u=document.createElement("input");u.setAttribute("id",t.getName()),u.setAttribute("type","number"),u.setAttribute("pattern","-?[0-9]*(.[0-9]+)?"),u.setAttribute("value",t.getValue().t),u.setAttribute("tabindex",0),u.style.width="100%";const g=document.createElement("li");g.appendChild(u),o.appendChild(g),s.appendChild(n);let p,_=void 0;t.valueChanged.connect(()=>{if(!_){const s=t.getValue();a.value=x(s.x),l.value=x(s.y),d.value=x(s.z),u.value=x(s.t),mode==e.ValueSetMode.REMOTEUSER_SETVALUE&&(n.classList.add("user-edited"),p&&clearTimeout(p),p=setTimeout(()=>{n.classList.remove("user-edited"),p=null;},1500));}});const f=()=>{const s=new e.Vec4(a.valueAsNumber,l.valueAsNumber,d.valueAsNumber,u.valueAsNumber);_?_.update({value:s}):(_=new h(t,s),i.undoRedoManager.addChange(_));},v=()=>{f(),_=void 0;};a.addEventListener("input",f),l.addEventListener("input",f),d.addEventListener("input",f),u.addEventListener("input",f),a.addEventListener("change",v),l.addEventListener("change",v),d.addEventListener("change",v),u.addEventListener("change",v);}},t=>t instanceof e.Vec4Parameter);V.registerWidget(class extends D{constructor(t,s,i){super(t);const n=document.createElement("div");n.className="container";const o=document.createElement("ul");o.className="flex-editvalues",n.appendChild(o);let a,r=void 0,l=!1;const c=s=>{if(!l){function i(e,t=6){return Number(Math.round(e+"e"+t)+"e-"+t)}const o=t.getValue();p.value=i(o.m00),_.value=i(o.m01),f.value=i(o.m02),v.value=i(o.m03),C.value=i(o.m10),b.value=i(o.m11),I.value=i(o.m12),w.value=i(o.m13),P.value=i(o.m20),T.value=i(o.m21),E.value=i(o.m22),y.value=i(o.m23),S.value=i(o.m30),M.value=i(o.m31),D.value=i(o.m32),V.value=i(o.m33),s==e.ValueSetMode.REMOTEUSER_SETVALUE&&(n.classList.add("user-edited"),a&&clearTimeout(a),a=setTimeout(()=>{n.classList.remove("user-edited"),a=null;},1500));}};t.valueChanged.connect(c);const d=()=>{l=!0;const s=new e.Mat4;s.set(p.valueAsNumber,_.valueAsNumber,f.valueAsNumber,v.valueAsNumber,C.valueAsNumber,b.valueAsNumber,I.valueAsNumber,w.valueAsNumber,P.valueAsNumber,T.valueAsNumber,E.valueAsNumber,y.valueAsNumber,S.valueAsNumber,M.valueAsNumber,D.valueAsNumber,V.valueAsNumber),r?r.update({value:s}):(r=new h(t,xfo),i.undoRedoManager.addChange(r));},m=()=>{d(),r=void 0,l=!1,c();};function u(e,s,i,n){const o=document.createElement("li"),a=document.createElement("input");return a.setAttribute("id",t.getName()),a.setAttribute("type","number"),a.setAttribute("pattern","-?[0-9]*(.[0-9]+)?"),a.setAttribute("value",i),a.setAttribute("tabindex",n),a.style.width="100%",o.appendChild(a),s.appendChild(o),a.addEventListener("input",d),a.addEventListener("change",m),a}const g=t.getValue(),p=u(0,o,g.m00,0),_=u(0,o,g.m01,1),f=u(0,o,g.m02,2),v=u(0,o,g.m03,3),C=u(0,o,g.m10,4),b=u(0,o,g.m11,5),I=u(0,o,g.m12,6),w=u(0,o,g.m13,7),P=u(0,o,g.m20,8),T=u(0,o,g.m21,9),E=u(0,o,g.m22,10),y=u(0,o,g.m23,11),S=u(0,o,g.m30,12),M=u(0,o,g.m31,13),D=u(0,o,g.m32,14),V=u(0,o,g.m33,15);s.appendChild(n);}},t=>t instanceof e.Mat4Parameter);V.registerWidget(class extends D{constructor(t,s,i){super(t);const n=document.createElement("div");n.className="container";const o=document.createElement("ul");o.className="flex-editvalues",n.appendChild(o);const a=t.getValue();let r,l=void 0,c=!1;const d=s=>{if(!c){const i=t.getValue();p.value=x(i.tr.x),_.value=x(i.tr.y),f.value=x(i.tr.z),v.value=x(i.ori.x),C.value=x(i.ori.y),b.value=x(i.ori.z),I.value=x(i.ori.w),w.value=x(i.sc.x),P.value=x(i.sc.y),T.value=x(i.sc.z),s==e.ValueSetMode.REMOTEUSER_SETVALUE&&(n.classList.add("user-edited"),r&&clearTimeout(r),r=setTimeout(()=>{n.classList.remove("user-edited"),r=null;},1500));}};t.valueChanged.connect(d);const m=()=>{c=!0;const s=new e.Xfo;s.tr.set(p.valueAsNumber,_.valueAsNumber,f.valueAsNumber),s.ori.set(v.valueAsNumber,C.valueAsNumber,b.valueAsNumber,I.valueAsNumber),s.ori.normalizeInPlace(),s.sc.set(w.valueAsNumber,P.valueAsNumber,T.valueAsNumber),l?l.update({value:s}):(l=new h(t,s),i.undoRedoManager.addChange(l));},u=()=>{m(),l=void 0,c=!1,d();};function g(e,s,i,n){const o=document.createElement("li"),a=document.createElement("input");return a.setAttribute("id",t.getName()),a.setAttribute("type","number"),a.setAttribute("pattern","-?[0-9]*(.[0-9]+)?"),a.setAttribute("value",i),a.setAttribute("tabindex",n),a.style.width="100%",o.appendChild(a),s.appendChild(o),a.addEventListener("input",m),a.addEventListener("change",u),a}const p=g(0,o,a.tr.x,0),_=g(0,o,a.tr.y,1),f=g(0,o,a.tr.z,2),v=g(0,o,a.ori.x,3),C=g(0,o,a.ori.y,4),b=g(0,o,a.ori.z,5),I=g(0,o,a.ori.w,6),w=g(0,o,a.sc.x,7),P=g(0,o,a.sc.y,8),T=g(0,o,a.sc.z,9);s.appendChild(n);}},t=>t instanceof e.XfoParameter);V.registerWidget(class extends D{constructor(t,s,i){super(t);const n=document.createElement("div");n.className="container";const o=document.createElement("ul");o.className="flex-editvalues",n.appendChild(o);const a=t.getValue();let r=void 0;const l=()=>{if(!r){const e=t.getValue();e.isValid()&&(u.value=e.p0.x,g.value=e.p0.y,p.value=e.p0.z,_.value=e.p1.x,f.value=e.p1.y,v.value=e.p1.z);}};t.valueChanged.connect(l);const c=()=>{const s=new e.Box3;s.p0.set(u.valueAsNumber,g.valueAsNumber,p.valueAsNumber),s.p1.set(_.valueAsNumber,f.valueAsNumber,v.valueAsNumber),r?r.update({value:s}):(r=new h(t,s),i.undoRedoManager.addChange(r)),l();},d=()=>{c(),r=void 0;};function m(e,s,i,n){const o=document.createElement("li"),a=document.createElement("input");return a.setAttribute("id",t.getName()),a.setAttribute("type","number"),a.setAttribute("pattern","-?[0-9]*(.[0-9]+)?"),a.setAttribute("value",i),a.setAttribute("tabindex",n),a.style.width="100%",o.appendChild(a),s.appendChild(o),a.addEventListener("input",c),a.addEventListener("change",d),a}const u=m(0,o,a.p0.x,0),g=m(0,o,a.p0.y,1),p=m(0,o,a.p0.z,2),_=m(0,o,a.p1.x,3),f=m(0,o,a.p1.y,4),v=m(0,o,a.p1.z,5);s.appendChild(n);}},t=>t.getValue()instanceof e.Box3);class R extends a{constructor(e,t){e?(super(e?e.getName()+" Name Changed":"NameValueChange"),this.__prevName=e.getName(),this.__item=e,null!=t&&(this.__nextName=t,this.__item.setName(this.__nextName))):super();}undo(){this.__item&&this.__item.setName(this.__prevName);}redo(){this.__item&&this.__item.setName(this.__nextName);}update(e){this.__item&&(this.__nextName=e.value,this.__item.setName(this.__nextName),this.updated.emit(e));}toJSON(e){const t=this.__item.getPath().slice();return t.pop(),t.push(this.__prevName),{name:this.name,nextName:this.__nextName,itemPath:t}}fromJSON(t,s){const i=s.appData.scene.getRoot().resolvePath(t.itemPath,1);i&&i instanceof e.BaseItem?(this.__item=i,this.__prevName=this.__item.getName(),this.__nextName=t.nextName,this.__item.setName(this.__nextName,e.ValueSetMode.REMOTEUSER_SETVALUE),this.name=this.__item.getName()+" Changed"):console.warn("resolvePath is unable to resolve",t.itemPath);}changeFromJSON(t){this.__item&&(this.__nextName=t.value,this.__item.setName(this.__nextName,e.ValueSetMode.REMOTEUSER_SETVALUE));}}o.registerChange("NameValueChange",R);class A{constructor(t,s,i){const n=document.createElement("input");let o,a;n.className="mdl-textfield__input",n.setAttribute("type","text"),n.setAttribute("value",t.getName()),n.setAttribute("tabindex",0),s.appendChild(n),t.nameChanged.connect((s,i,r)=>{o||(n.value=t.getName(),r==e.ValueSetMode.REMOTEUSER_SETVALUE&&(n.classList.add("user-edited"),a&&clearTimeout(a),a=setTimeout(()=>{n.classList.remove("user-edited"),a=null;},1500)));});const r=()=>{const e=n.value;o?o.update({value:e}):(o=new R(t,e),i.undoRedoManager.addChange(o));};n.addEventListener("input",r),n.addEventListener("change",()=>{r(),o=void 0;});}}class X{constructor(e,t,s){this.domElement=t,this.clean(),this.appData=s,this.container=document.createElement("div"),this.container.className="container",this.domElement.appendChild(this.container),this.ul=document.createElement("ul"),this.ul.className="flex-outer",this.container.appendChild(this.ul),e&&this.setParameterOwner(e);}clean(){for(;this.domElement.firstChild;)this.domElement.removeChild(this.domElement.firstChild);}destroy(){this.clean();}getDomElement(){return this.container}setParameterOwner(e){if(this.parameterOwner=e,this.widgets=[],e)for(const t of e.getParameters())this.addParameterWidget(t);}addParameterWidget(e){const t=e.getName(),s=V.findWidgetReg(e);if(!s)return void console.warn(`Unable to display parameter '${t}', value:${e.getValue()}`);const i=document.createElement("li");this.ul.appendChild(i);const n=document.createElement("label");n.setAttribute("for",t),n.appendChild(document.createTextNode(t)),i.appendChild(n);const o=new s.widget(e,i,this.appData);this.widgets.push(o);}}class N extends D{constructor(t,s,i){super(t);const n=document.createElement("ul");n.className="list pa0";const o=document.createElement("li"),a=document.createElement("li");s.appendChild(n),n.appendChild(o),n.appendChild(a);const r=t=>{t instanceof e.BaseItem&&(this.nameWidget=new A(t,o,i)),this.parameterContainer=new X(t,a,i);},l=t.getValue();l&&r(l),t.valueChanged.connect(()=>{for(;o.firstChild;)o.removeChild(o.firstChild);for(;a.firstChild;)a.removeChild(a.firstChild);r(t.getValue());});}}V.registerWidget(N,t=>t.getValue()instanceof e.ParameterOwner);V.registerWidget(class extends N{constructor(e,t,s){let i=e.getValue();{const s=document.createElement("ul");s.style.width="100%",s.style["padding-inline-start"]="0px";{const t=document.createElement("input");t.className="mdl-textfield__input",t.setAttribute("id",e.getName()),t.setAttribute("type","text"),t.setAttribute("value",i?i.getPath():"<NONE>"),t.setAttribute("tabindex",0);const n=document.createElement("li");n.style.display="block",n.appendChild(t),s.appendChild(n);}t.appendChild(s);}super(e,t,s),e.valueChanged.connect(()=>{i||t.removeChild(void 0);});}setParentDomElem(e){}},t=>t instanceof e.ImageParameter);V.registerWidget(class extends D{constructor(t,s,i){super(t);const n=new iro.ColorPicker(s,{width:200,height:200,color:t.getValue().getAsRGBDict(),anticlockwise:!0,borderWidth:1,borderColor:"#fff"});let o=void 0,a=!1;t.valueChanged.connect(()=>{o||(a=!0,n.color.rgb=t.getValue().getAsRGBDict(),a=!1);}),n.on("input:start",()=>{o=new h(t),i.undoRedoManager.addChange(o);}),n.on("input:end",()=>{o=void 0;}),n.on("color:change",(s,r)=>{if(a)return;const l=new e.Color;l.setFromRGBDict(n.color.rgb),o?o.update({value:l}):(o=new h(t,l),i.undoRedoManager.addChange(o));});}setParentDomElem(e){}},t=>t instanceof e.MaterialColorParam);V.registerWidget(class extends D{constructor(t,s,i){super(t);const n=t.getChoices(),o=document.createElement("select");for(let e=0;e<n.length;e++){const t=n[e],s=document.createElement("option");s.appendChild(document.createTextNode(t)),o.appendChild(s);}o.selectedIndex=t.getValue(),s.appendChild(o);let a,r=!1;t.valueChanged.connect(s=>{r||(o.selectedIndex=t.getValue(),s==e.ValueSetMode.REMOTEUSER_SETVALUE&&(o.classList.add("user-edited"),a&&clearTimeout(a),a=setTimeout(()=>{o.classList.remove("user-edited"),a=null;},1500)));});o.addEventListener("change",e=>{r=!0;const s=new h(t,o.selectedIndex);i.undoRedoManager.addChange(s),t.setValueDone(),r=!1;});}},t=>t instanceof e.MultiChoiceParameter);V.registerWidget(class extends D{constructor(e,t,s){super(e);const i=e.getValue(),n=document.createElement("input");n.className="mdl-textfield__input",n.setAttribute("id",e.getName()),n.setAttribute("type","text"),n.setAttribute("value",i?i.getPath().join("/"):"<none>"),n.style["outline-color"]="grey",n.style["outline-width"]="1px",n.style["outline-style"]="solid";const o=document.createElement("button");o.appendChild(document.createTextNode("Pick")),o.addEventListener("click",t=>{s.selectionManager.startPickingMode(`Pick ${e.getName()} item.`,t=>{const i=new h(e,t[0]);s.undoRedoManager.addChange(i);},e.getFilterFn(),1);}),o.style.margin="2px",t.appendChild(n),t.appendChild(o),e.valueChanged.connect(()=>{{const t=e.getValue();n.setAttribute("value",t?t.getPath().join("/"):"<none>");}});}},t=>t instanceof e.TreeItemParameter);V.registerWidget(class extends D{constructor(t,s,i){super(t);const n=document.createElement("select");n.classList.add("itemset-items");const o=()=>{const e=Array.from(t.getValue());n.setAttribute("size",e.length+1);for(let t=0;t<e.length;t++){const s=e[t],i=document.createElement("option");i.appendChild(document.createTextNode(s.getPath())),n.appendChild(i);}};t.valueChanged.connect(()=>{for(;n.firstChild;)n.removeChild(n.firstChild);o();}),o(),n.selectedIndex=-1,n.style.width="100%";const a=document.createElement("ul");a.style.width="100%",a.style["padding-inline-start"]="0px";const r=document.createElement("li");r.style.display="block",a.appendChild(r),r.appendChild(n),s.appendChild(a),this.selectionChanged=new e.Signal,this.selectionDoubleClicked=new e.Signal;let l=-1;if(n.addEventListener("change",e=>{console.log("valueChange",n.selectedIndex),this.selectionChanged.emit(n.selectedIndex,l),l=n.selectedIndex;}),n.addEventListener("dblclick",e=>{console.log("dblclick",n.selectedIndex);const s=t.getItem(n.selectedIndex);i.selectionManager.setSelection(new Set([s])),this.selectionDoubleClicked.emit(n.selectedIndex);}),null!=t.getFilterFn()){const e=document.createElement("button");e.appendChild(document.createTextNode("Add")),e.addEventListener("click",e=>{i.selectionManager.startPickingMode("Pick a new item.",e=>{t.addItems(e);},t.getFilterFn(),1);});const s=document.createElement("button");s.appendChild(document.createTextNode("Remove")),s.addEventListener("click",e=>{t.removeItem(n.selectedIndex);});const o=document.createElement("li");o.style.display="block",e.style.margin="2px",s.style.margin="2px",o.appendChild(e),o.appendChild(s),a.appendChild(o);}}},t=>t instanceof e.ItemSetParameter);V.registerWidget(class extends D{constructor(e,t,s){super(e);const i=[],n=()=>{e.getMemberNames().forEach((t,n)=>{const o=e.getMember(t),a=V.findWidgetReg(o);if(!a)return void console.warn(`StructWidget Unable to display item '${o.getNam()}'`);const l=document.createElement("li"),h=document.createElement("label");h.setAttribute("for",t),h.appendChild(document.createTextNode(t)),l.appendChild(h);const c=new a.widget(o,l,s);i[n]=c,r.appendChild(l);});};e.valueChanged.connect(()=>{for(;r.firstChild;)r.removeChild(r.firstChild);n();});const o=document.createElement("ul");o.style.width="100%",o.style["padding-inline-start"]="0px";const a=document.createElement("li");a.style.display="block",o.appendChild(a);const r=document.createElement("ul");r.style.display="block",o.appendChild(r),n(),t.appendChild(o);}},t=>t instanceof e.StructParameter);V.registerWidget(class extends D{constructor(e,t,s){super(e);const i=[],n=()=>{Array.from(e.getValue()).forEach((t,n)=>{const o=V.findWidgetReg(t);if(!o)return void console.warn(`ListWidget Unable to display list item '${t.getNam()}'`);const a=document.createElement("li"),l=new o.widget(t,a,s);i[n]=l;const h=document.createElement("button");h.appendChild(document.createTextNode("Remove")),h.addEventListener("click",t=>{e.removeElement(n);}),h.style.margin="2px",a.appendChild(h),r.appendChild(a);});};e.valueChanged.connect(()=>{for(;r.firstChild;)r.removeChild(r.firstChild);n();});const o=document.createElement("ul");o.style.width="100%",o.style["padding-inline-start"]="0px";const a=document.createElement("li");a.style.display="block",o.appendChild(a);const r=document.createElement("ul");r.style.display="block",o.appendChild(r),n(),t.appendChild(o);{const t=document.createElement("li");t.style.display="block";const s=document.createElement("button");s.appendChild(document.createTextNode("Add")),s.addEventListener("click",t=>{e.addElement();}),s.style.margin="2px",t.appendChild(s),o.appendChild(t);}}},t=>t instanceof e.ListParameter);class L{constructor(t,s){this.userPressed=new e.Signal,this.domElement=t,this.clean(),this.userDiv=document.createElement("div"),this.userDiv.className="user-chip pa1 br2",this.domElement.appendChild(this.userDiv),this.userImage=document.createElement("img"),this.userImage.className="user-image br-100 ba b--black-10",this.userImage.alt="Avatar",this.userImage.src=s.picture,this.userImage.addEventListener("mousedown",()=>{this.userPressed.emit(this.userData),this.userImage.classList.add("user-image--selected");},!0),this.userImage.addEventListener("mouseup",()=>{this.userImage.classList.remove("user-image--selected");},!0),this.userDiv.appendChild(this.userImage),this.userToolTip=document.createElement("span"),this.userToolTip.className="tooltiptext",this.userDiv.appendChild(this.userToolTip),s&&this.setUserData(s);}setUserData(e){this.userData=e,this.userNameSpan&&(this.userNameSpan.innerHTML=e.name),this.userToolTip.innerHTML=e.name;}clean(){for(;this.domElement.firstChild;)this.domElement.removeChild(this.domElement.firstChild);}unmount(){this.clean();}}class k{constructor(t){let s,i;this.panelSide=t,0==t?(this.domElement=document.createElement("div"),this.domElement.className="SidePanel SidePanel--left overflow-auto pa2",this.handleElement=document.createElement("div"),this.handleElement.className="PanelHandler bg-center"):(this.handleElement=document.createElement("div"),this.handleElement.className="PanelHandler bg-center",this.domElement=document.createElement("div"),this.domElement.className="SidePanel SidePanel--right overflow-auto pa2"),this.domElement.style.width="0px";const n=e=>{const n=(e.clientX-s)*window.devicePixelRatio,o=0==t?i+n:i-n;o<40?(this.domElement.style.display="none",this.domElement.style.width="0px"):(this.domElement.style.display="block",this.domElement.style.width=`${o}px`);},o=e=>{document.removeEventListener("mousemove",n,!1),document.removeEventListener("mouseup",o,!1);};this.handleElement.addEventListener("mousedown",e=>{s=e.clientX,i=parseInt(document.defaultView.getComputedStyle(this.domElement).width,10)*window.devicePixelRatio,document.addEventListener("mousemove",n,!1),document.addEventListener("mouseup",o,!1);},!1);const a={},r=(e,t)=>{delete a[e.identifier];};this.handleElement.addEventListener("touchstart",t=>{t.preventDefault(),t.stopPropagation(),i=parseInt(document.defaultView.getComputedStyle(this.domElement).width,10)*window.devicePixelRatio;const n=t.changedTouches;if(1==n.length){s=n[0].clientX;for(let t=0;t<n.length;t++)o=n[t],a[o.identifier]={identifier:o.identifier,pos:new e.Vec2(o.pageX,o.pageY)};t.stopPropagation();}var o;},!1),this.handleElement.addEventListener("touchmove",e=>{const n=e.changedTouches;if(1==n.length){const o=(n[0].clientX-s)*window.devicePixelRatio,a=0==t?i+o:i-o;a<40?(this.domElement.style.display="none",this.domElement.style.width="0px"):(this.domElement.style.display="block",this.domElement.style.width=`${a}px`),e.stopPropagation();}},!1),this.handleElement.addEventListener("touchend",e=>{e.preventDefault(),e.stopPropagation();const t=e.changedTouches;for(let e=0;e<t.length;e++)r(t[e]);e.stopPropagation();},!1),this.handleElement.addEventListener("touchcancel",e=>{const t=e.changedTouches;for(let e=0;e<t.length;e++)r(t[e]);e.stopPropagation();},!1);}getPanelWidget(){return this.widget}setPanelWidget(e){if(this.widget)for(this.widget.unMount(this.domElement);this.domElement.firstChild;)this.domElement.removeChild(this.domElement.firstChild);this.widget=e,this.widget?(this.domElement.style.display="block",this.domElement.style.width=(e.getDefaultWidth?e.getDefaultWidth():300)+"px",this.widget.mount?this.widget.mount(this.domElement):this.domElement.appendChild(this.widget)):(this.domElement.style.display="none",this.domElement.style.width="0px");}mount(e){this.parentDomElement=e,0==this.panelSide?(this.parentDomElement.appendChild(this.domElement),this.parentDomElement.appendChild(this.handleElement)):(this.parentDomElement.appendChild(this.handleElement),this.parentDomElement.appendChild(this.domElement));}unMount(e){this.parentDomElement.removeChild(this.domElement);}}class G{constructor(){let e,t;this.handleElement=document.createElement("div"),this.handleElement.className="BottomPanelHandler bg-center z-1 bt",this.domElement=document.createElement("div"),this.domElement.className="BottomPanel overflow-auto pa2",this.domElement.style.height="0px",this.closedHeight=0;const s=s=>{const i=s.clientY-e;let n=t-i;n<this.closedHeight+40&&(n=this.closedHeight),this.domElement.style.height=`${n}px`;},i=e=>{document.removeEventListener("mousemove",s,!1),document.removeEventListener("mouseup",i,!1);};this.handleElement.addEventListener("mousedown",n=>{e=n.clientY,t=parseInt(document.defaultView.getComputedStyle(this.domElement).height,10),document.addEventListener("mousemove",s,!1),document.addEventListener("mouseup",i,!1);},!1);}getPanelWidget(){return this.widget}setPanelWidget(e){if(this.widget)for(this.widget.unMount(this.domElement);this.domElement.firstChild;)this.domElement.removeChild(this.domElement.firstChild);this.widget=e,this.widget?(this.domElement.style.display="block",this.domElement.style.height=(e.getDefaultHeight?e.getDefaultHeight():180)+"px",this.widget.mount?this.widget.mount(this.domElement):this.domElement.appendChild(this.widget)):(this.domElement.style.display="none",this.domElement.style.height="0px");}mount(e){this.parentDomElement=e,this.parentDomElement.appendChild(this.handleElement),this.parentDomElement.appendChild(this.domElement);}unMount(e){this.parentDomElement.removeChild(this.domElement);}}V.registerTreeItemElement(class{constructor(t,s,i,n=!1){this.treeItem=t,this.appData=s,this.options=i,this.li=document.createElement("li"),this.li.className="TreeNodesListItem",this.li.treeItem=t,this.expandBtn=document.createElement("button"),this.expandBtn.className="TreeNodesListItem__ToggleExpanded",this.li.appendChild(this.expandBtn),t instanceof e.TreeItem&&(this.toggleVisibilityBtn=document.createElement("button"),this.toggleVisibilityBtn.className="TreeNodesListItem__ToggleVisibility",this.li.appendChild(this.toggleVisibilityBtn),this.toggleVisibilityBtn.innerHTML='<i class="material-icons md-15">visibility</i>',this.toggleVisibilityBtn.addEventListener("click",()=>{const e=this.treeItem.getParameter("Visible"),t=new h(e,!e.getValue());this.appData.undoRedoManager&&this.appData.undoRedoManager.addChange(t);}),this.updateVisibilityId=this.treeItem.visibilityChanged.connect(this.updateVisibility.bind(this)),this.updateVisibility()),this.titleElement=document.createElement("span"),this.titleElement.className="TreeNodesListItem__Title",this.titleElement.textContent=t.getName();if(this.treeItem.nameChanged.connect(()=>{this.titleElement.textContent=t.getName();}),this.li.appendChild(this.titleElement),this.titleElement.addEventListener("click",e=>{s.selectionManager&&(s.selectionManager.pickingModeActive()?s.selectionManager.pick(this.treeItem):s.selectionManager.toggleItemSelection(this.treeItem,!e.ctrlKey));}),this.updateSelectedId=this.treeItem.selectedChanged.connect(this.updateSelected.bind(this)),this.updateSelected(),t instanceof e.TreeItem&&(this.updateHighlightId=this.treeItem.highlightChanged.connect(this.updateHighlight.bind(this)),this.updateHighlight()),this.ul=document.createElement("ul"),this.ul.className="TreeNodesList",this.li.appendChild(this.ul),this.childElements=[],this.expanded=!1,t instanceof e.TreeItem){if(n)this.expand();else {this.treeItem.getChildren().length>0&&this.collapse();}this.expandBtn.addEventListener("click",()=>{this.treeItem.getNumChildren()>0&&(this.expanded?this.collapse():this.expand());}),this.childAddedId=this.treeItem.childAdded.connect(this.childAdded.bind(this)),this.childRemovedId=this.treeItem.childRemoved.connect(this.childRemoved.bind(this)),this.titleElement.onmousedown=t=>{if(i.allowDragNDrop){t.stopPropagation(),t.preventDefault();const s=t.clientX,i=t.clientY;let n,o,a=s-this.li.getBoundingClientRect().left,r=i-this.li.getBoundingClientRect().top,l=!1;const h=t=>{if(!l){const e=t.clientX-s,o=t.clientY-i;Math.abs(e)>10&&Math.abs(o)>10&&(n=document.createElement("li"),n.className="TreeNodesListItem",n.classList.add("TreeNodesListItem--isHighlighted"),n.classList.add("TreeNodesListItem--isSelected"),n.classList.add("TreeNodesListItem__Dragging"),n.appendChild(this.titleElement.cloneNode(!0)),n.style.position="absolute",n.style.zIndex=1e3,document.body.append(n),l=!0);}if(l){n.style.left=t.pageX-a+"px",n.style.top=t.pageY-r+"px",n.hidden=!0;const s=document.elementFromPoint(t.clientX,t.clientY);if("TreeNodesListItem__Title"==s.className&&s.parentElement.treeItem instanceof e.TreeItem){const e=s.parentElement;o&&o!=e&&o.classList.remove("TreeNodesListItem--isHighlighted"),e==this.li?o=null:e&&o!=e&&(o=e,o.classList.add("TreeNodesListItem--isHighlighted"));}n.hidden=!1;}},c=e=>{if(n&&document.body.removeChild(n),o){const e=new M(this.treeItem,o.treeItem);this.appData.undoRedoManager&&this.appData.undoRedoManager.addChange(e);}document.removeEventListener("mousemove",h),document.removeEventListener("mouseup",c);};document.addEventListener("mousemove",h),document.addEventListener("mouseup",c);}};}this.li.ondragstart=function(){return !1};}updateVisibility(){this.treeItem.getVisible()?this.li.classList.remove("TreeNodesListItem--isHidden"):this.li.classList.add("TreeNodesListItem--isHidden");}updateSelected(){this.treeItem.getSelected()?this.li.classList.add("TreeNodesListItem--isSelected"):this.li.classList.remove("TreeNodesListItem--isSelected");}updateHighlight(){const e=this.treeItem.isHighlighted();e?this.li.classList.add("TreeNodesListItem--isHighlighted"):this.li.classList.remove("TreeNodesListItem--isHighlighted"),e&&(this.titleElement.style["border-color"]=this.treeItem.getHighlight().toHex());}childAdded(e,t){this.addChild(e,t);}childRemoved(e,t){this.expanded&&(this.li.removeChild(this.childElements[t].li),this.childElements[t].destroy(),this.childElements.splice(t,1));}addComponent(e){this.subul||(this.subul=document.createElement("ul"),this.titleElement.appendChild(this.subul));const t=document.createElement("li");t.className="TreeNodesListItem";const s=document.createElement("span");s.className="TreeNodesListItem__Title",s.textContent=e,t.appendChild(s),this.subul.appendChild(t);}addChild(e,t){if(this.expanded){const s=V.constructTreeItemElement(e,this.appData,this.options);t==this.childElements.length?this.ul.appendChild(s.li):this.ul.insertBefore(s.li,this.childElements[t].li),this.childElements.splice(t,0,s);}else this.collapse();}getChild(e){return this.childElements[e]}expand(){if(this.expanded=!0,this.ul.classList.remove("TreeNodesList--collapsed"),this.expandBtn.innerHTML='<i class="material-icons md-24">arrow_drop_down</i>',!this.childrenAlreadyCreated){this.treeItem.getChildren().forEach((e,t)=>{this.addChild(e,t);}),this.childrenAlreadyCreated=!0;}}collapse(){this.ul.classList.add("TreeNodesList--collapsed"),this.expandBtn.innerHTML='<i class="material-icons md-24">arrow_right</i>',this.expanded=!1;}destroy(){this.treeItem.selectedChanged.disconnectId(this.updateSelectedId),this.treeItem instanceof e.TreeItem&&(this.treeItem.highlightChanged.disconnectId(this.updateHighlightId),this.treeItem.visibilityChanged.disconnectId(this.updateVisibilityId),this.treeItem.childAdded.disconnectId(this.childAddedId),this.treeItem.childRemoved.disconnectId(this.childRemovedId));}},t=>t instanceof e.BaseItem);V.registerInpector(class{constructor(e,t,s){const i=document.createElement("ul");i.className="list pa0 pr3";const n=document.createElement("li"),o=document.createElement("li");t.appendChild(i),i.appendChild(n),i.appendChild(o),this.nameWidget=new A(e,n,s),this.parameterContainer=new X(e,o,s);}destroy(){this.parameterContainer.destroy();}},t=>t instanceof e.BaseItem);class O extends e.ParameterOwner{constructor(t){super(),t||console.error("App data not provided to tool"),this.appData=t,this.installChanged=new e.Signal,this.activatedChanged=new e.Signal,this.actionFinished=new e.Signal,this.__params=[],this.__installed=!1,this.__activated=!1;}getName(){return this.constructor.name}isPrimaryTool(){return !1}installed(){return this.__installed}install(e){if(this.__installed)throw new Error("Tool already installed");this.index=e,this.__installed=!0,this.installChanged.emit(!0);}uninstall(){this.__installed=!1,this.installChanged.emit(!1);}activateTool(){if(this.__activated)throw new Error("Tool already activate");this.__activated=!0,this.activatedChanged.emit(!0);}deactivateTool(){this.__activated=!1,this.activatedChanged.emit(!1);}onMouseDown(e){}onMouseMove(e){}onMouseUp(e){}onDoubleClick(e){}onWheel(e){}onKeyPressed(e,t){}onKeyDown(e,t){}onKeyUp(e,t){}onTouchStart(e){}onTouchMove(e){}onTouchEnd(e){}onTouchCancel(e){}onDoubleTap(e){}onVRControllerButtonDown(e){}onVRControllerButtonUp(e){}onVRControllerDoubleClicked(e){}onVRPoseChanged(e){}}const U={VIEWER:0,DCC:1};class H extends O{constructor(t){super(t),this.dragging=!1,this.selectionRect=new e.Rect(1,1),this.selectionRectMat=new e.Material("marker","ScreenSpaceShader"),this.selectionRectMat.getParameter("BaseColor").setValue(new e.Color("#03E3AC")),this.selectionRectXfo=new e.Xfo,this.selectionRectXfo.tr.set(.5,.5,0),this.selectionRectXfo.sc.set(0,0,0);}activateTool(){super.activateTool(),this.rectItem||(this.rectItem=new e.GeomItem("selectionRect",this.selectionRect,this.selectionRectMat),this.rectItem.getParameter("Visible").setValue(!1),this.appData.renderer.addTreeItem(this.rectItem));}deactivateTool(){super.deactivateTool(),this.selectionRectXfo.sc.set(0,0,0),this.rectItem.setGlobalXfo(this.selectionRectXfo);}onMouseDown(e){return 0==e.button&&!e.altKey&&(console.log("onMouseDown"),this.mouseDownPos=e.mousePos,this.dragging=!1,!0)}__resizeRect(t,s){const i=new e.Vec2(1/t.getWidth()*2,1/t.getHeight()*2),n=s.multiply(i);this.selectionRectXfo.sc.set(Math.abs(n.x),Math.abs(n.y),1);const o=this.mouseDownPos.subtract(s.scale(.5)).multiply(i).subtract(new e.Vec2(1,1));this.selectionRectXfo.tr.x=o.x,this.selectionRectXfo.tr.y=-o.y,this.rectItem.setGlobalXfo(this.selectionRectXfo);}onMouseMove(e){if(this.mouseDownPos){const t=this.mouseDownPos.subtract(e.mousePos);this.dragging&&this.__resizeRect(e.viewport,t),t.length()>4&&(this.dragging=!0,this.rectItem.getParameter("Visible").setValue(!0),this.__resizeRect(e.viewport,t));}return !0}onMouseUp(t){if(this.mouseDownPos){if(this.dragging){this.rectItem.getParameter("Visible").setValue(!1);const s=t.mousePos,i=new e.Vec2(Math.min(this.mouseDownPos.x,s.x),Math.min(this.mouseDownPos.y,s.y)),n=new e.Vec2(Math.max(this.mouseDownPos.x,s.x),Math.max(this.mouseDownPos.y,s.y)),o=t.viewport.getGeomItemsInRect(i,n);if(this.appData.selectionManager.pickingModeActive())this.appData.selectionManager.pick(o);else {const e=new Set([...o].filter(e=>!(e.getOwner()instanceof r)));t.shiftKey?this.appData.selectionManager.deselectItems(e):this.appData.selectionManager.selectItems(e,!t.ctrlKey),this.selectionRectXfo.sc.set(0,0,0),this.rectItem.setGlobalXfo(this.selectionRectXfo);}}else {const e=t.viewport.getGeomDataAtPos(t.mousePos);if(null==e||e.geomItem.getOwner()instanceof r)this.appData.selectionManager.clearSelection();else if(this.appData.selectionManager.pickingModeActive())this.appData.selectionManager.pick(e.geomItem);else if(t.shiftKey){const t=new Set;t.add(e.geomItem),this.appData.selectionManager.deselectItems(t);}else this.appData.selectionManager.toggleItemSelection(e.geomItem,!t.ctrlKey);}return this.mouseDownPos=void 0,!0}}onVRControllerButtonDown(e){if(1==e.button){const t=e.controller.getGeomItemAtTip();if(null!=t&&!(t.geomItem.getOwner()instanceof r))return this.appData.selectionManager.toggleItemSelection(t.geomItem),!0}}}o.registerChange("SelectionTool",H);const B=function(){return {escape:function(e){return e.replace(/([.*+?^${}()|\[\]\/\\])/g,"\\$1")},parseExtension:e,mimeType:function(t){const s=e(t).toLowerCase();return function(){const e="application/font-woff";return {woff:e,woff2:e,ttf:"application/font-truetype",eot:"application/vnd.ms-fontobject",png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg",gif:"image/gif",tiff:"image/tiff",svg:"image/svg+xml"}}()[s]||""},dataAsUrl:function(e,t){return "data:"+t+";base64,"+e},isDataUrl:function(e){return -1!==e.search(/^(data:)/)},canvasToBlob:function(e){return e.toBlob?new Promise((function(t){e.toBlob(t);})):function(e){return new Promise((function(t){const s=window.atob(e.toDataURL().split(",")[1]),i=s.length,n=new Uint8Array(i);for(let e=0;e<i;e++)n[e]=s.charCodeAt(e);t(new Blob([n],{type:"image/png"}));}))}(e)},resolveUrl:function(e,t){const s=document.implementation.createHTMLDocument(),i=s.createElement("base");s.head.appendChild(i);const n=s.createElement("a");return s.body.appendChild(n),i.href=t,n.href=e,n.href},getAndEncode:function(e){Z.impl.options.cacheBust&&(e+=(/\?/.test(e)?"&":"?")+(new Date).getTime());return new Promise((function(t){const s=new XMLHttpRequest;let i;if(s.onreadystatechange=function(){if(4!==s.readyState)return;if(200!==s.status)return void(i?t(i):n("cannot fetch resource: "+e+", status: "+s.status));const o=new FileReader;o.onloadend=function(){const e=o.result.split(/,/)[1];t(e);},o.readAsDataURL(s.response);},s.ontimeout=function(){i?t(i):n("timeout of 30000ms occured while fetching resource: "+e);},s.responseType="blob",s.timeout=3e4,s.open("GET",e,!0),s.send(),Z.impl.options.imagePlaceholder){const e=Z.impl.options.imagePlaceholder.split(/,/);e&&e[1]&&(i=e[1]);}function n(e){console.error(e),t("");}}))},uid:function(){let e=0;return function(){return "u"+("0000"+(Math.random()*Math.pow(36,4)<<0).toString(36)).slice(-4)+e++}}(),delay:function(e){return function(t){return new Promise((function(s){setTimeout((function(){s(t);}),e);}))}},asArray:function(e){const t=[],s=e.length;for(let i=0;i<s;i++)t.push(e[i]);return t},escapeXhtml:function(e){return e.replace(/#/g,"%23").replace(/\n/g,"%0A")},makeImage:function(e){return new Promise((function(t,s){const i=new Image;i.onload=function(){t(i);},i.onerror=s,i.src=e;}))},width:function(e){const s=t(e,"border-left-width"),i=t(e,"border-right-width");return e.scrollWidth+s+i},height:function(e){const s=t(e,"border-top-width"),i=t(e,"border-bottom-width");return e.scrollHeight+s+i}};function e(e){const t=/\.([^\.\/]*?)$/g.exec(e);return t?t[1]:""}function t(e,t){const s=window.getComputedStyle(e).getPropertyValue(t);return parseFloat(s.replace("px",""))}}(),F=function(){const e=/url\(['"]?([^'"]+?)['"]?\)/g;return {inlineAll:function(e,n,o){return function(){return !t(e)}()?Promise.resolve(e):Promise.resolve(e).then(s).then((function(t){let s=Promise.resolve(e);return t.forEach((function(e){s=s.then((function(t){return i(t,e,n,o)}));})),s}))},shouldProcess:t,impl:{readUrls:s,inline:i}};function t(t){return -1!==t.search(e)}function s(t){const s=[];let i;for(;null!==(i=e.exec(t));)s.push(i[1]);return s.filter((function(e){return !B.isDataUrl(e)}))}function i(e,t,s,i){return Promise.resolve(t).then((function(e){return s?B.resolveUrl(e,s):e})).then(i||B.getAndEncode).then((function(e){return B.dataAsUrl(e,B.mimeType(t))})).then((function(s){return e.replace(function(e){return new RegExp("(url\\(['\"]?)("+B.escape(e)+")(['\"]?\\))","g")}(t),"$1"+s+"$3")}))}}(),z=function(){return {resolveAll:function(){return e().then((function(e){return Promise.all(e.map((function(e){return e.resolve()})))})).then((function(e){return e.join("\n")}))},impl:{readAll:e}};function e(){return Promise.resolve(B.asArray(document.styleSheets)).then((function(e){const t=[];return e.forEach((function(e){try{B.asArray(e.cssRules||[]).forEach(t.push.bind(t));}catch(t){console.log("Error while reading CSS rules from "+e.href,t.toString());}})),t})).then((function(e){return e.filter((function(e){return e.type===CSSRule.FONT_FACE_RULE})).filter((function(e){return F.shouldProcess(e.style.getPropertyValue("src"))}))})).then((function(t){return t.map(e)}));function e(e){return {resolve:function(){const t=(e.parentStyleSheet||{}).href;return F.inlineAll(e.cssText,t)},src:function(){return e.style.getPropertyValue("src")}}}}}(),W=function(){return {inlineAll:function t(s){return s instanceof Element?function(e){const t=e.style.getPropertyValue("background");return t?F.inlineAll(t).then((function(t){e.style.setProperty("background",t,e.style.getPropertyPriority("background"));})).then((function(){return e})):Promise.resolve(e)}(s).then((function(){return s instanceof HTMLImageElement?e(s).inline():Promise.all(B.asArray(s.childNodes).map((function(e){return t(e)})))})):Promise.resolve(s)},impl:{newImage:e}};function e(e){return {inline:function(t){return B.isDataUrl(e.src)?Promise.resolve():Promise.resolve(e.src).then(t||B.getAndEncode).then((function(t){return B.dataAsUrl(t,B.mimeType(e.src))})).then((function(t){return new Promise((function(s,i){e.onload=s,e.onerror=i,e.src=t;}))}))}}}}(),J={imagePlaceholder:void 0,cacheBust:!1},Z={toSvg:K,toPng:function(e,t){return j(e,t||{}).then((function(e){return e.toDataURL()}))},toJpeg:function(e,t){return j(e,t=t||{}).then((function(e){return e.toDataURL("image/jpeg",t.quality||1)}))},toBlob:function(e,t){return j(e,t||{}).then(B.canvasToBlob)},toPixelData:function(e,t){return j(e,t||{}).then((function(t){return t.getContext("2d").getImageData(0,0,B.width(e),B.height(e)).data}))},toCanvas:function(e,t){return j(e,t||{}).then((function(e){return e}))},impl:{fontFaces:z,images:W,util:B,inliner:F,options:{}}};function K(e,t){return function(e){void 0===e.imagePlaceholder?Z.impl.options.imagePlaceholder=J.imagePlaceholder:Z.impl.options.imagePlaceholder=e.imagePlaceholder;void 0===e.cacheBust?Z.impl.options.cacheBust=J.cacheBust:Z.impl.options.cacheBust=e.cacheBust;}(t=t||{}),Promise.resolve(e).then((function(e){return function e(t,s,i){return i||!s||s(t)?Promise.resolve(t).then((function(e){return e instanceof HTMLCanvasElement?B.makeImage(e.toDataURL()):e.cloneNode(!1)})).then((function(e){return n(t,e,s)})).then((function(e){return function(e,t){return t instanceof Element?Promise.resolve().then(s).then(i).then(n).then(o).then((function(){return t})):t;function s(){var s,i;s=window.getComputedStyle(e),i=t.style,s.cssText?i.cssText=s.cssText:function(e,t){B.asArray(e).forEach((function(s){t.setProperty(s,e.getPropertyValue(s),e.getPropertyPriority(s));}));}(s,i);}function i(){[":before",":after"].forEach((function(s){!function(s){const i=window.getComputedStyle(e,s),n=i.getPropertyValue("content");if(""===n||"none"===n)return;const o=B.uid();t.className=t.className+" "+o;const a=document.createElement("style");a.appendChild(function(e,t,s){const i="."+e+":"+t,n=s.cssText?function(e){const t=e.getPropertyValue("content");return e.cssText+" content: "+t+";"}(s):function(e){return B.asArray(e).map((function(t){return t+": "+e.getPropertyValue(t)+(e.getPropertyPriority(t)?" !important":"")})).join("; ")+";"}(s);return document.createTextNode(i+"{"+n+"}")}(o,s,i)),t.appendChild(a);}(s);}));}function n(){e instanceof HTMLTextAreaElement&&(t.innerHTML=e.value),e instanceof HTMLInputElement&&t.setAttribute("value",e.value);}function o(){t instanceof SVGElement&&(t.setAttribute("xmlns","http://www.w3.org/2000/svg"),t instanceof SVGRectElement&&["width","height"].forEach((function(e){const s=t.getAttribute(e);s&&t.style.setProperty(e,s);})));}}(t,e)})):Promise.resolve();function n(t,s,i){const n=t.childNodes;return 0===n.length?Promise.resolve(s):o(s,B.asArray(n),i).then((function(){return s}));function o(t,s,i){let n=Promise.resolve();return s.forEach((function(s){n=n.then((function(){return e(s,i)})).then((function(e){e&&t.appendChild(e);}));})),n}}}(e,t.filter,!0)})).then(Y).then($).then((function(e){t.bgcolor&&(e.style.backgroundColor=t.bgcolor);t.width&&(e.style.width=t.width+"px");t.height&&(e.style.height=t.height+"px");t.style&&Object.keys(t.style).forEach((function(s){e.style[s]=t.style[s];}));return e})).then((function(s){return function(e,t,s){return Promise.resolve(e).then((function(e){return e.setAttribute("xmlns","http://www.w3.org/1999/xhtml"),(new XMLSerializer).serializeToString(e)})).then(B.escapeXhtml).then((function(e){return '<foreignObject x="0" y="0" width="100%" height="100%">'+e+"</foreignObject>"})).then((function(e){return '<svg xmlns="http://www.w3.org/2000/svg" width="'+t+'" height="'+s+'">'+e+"</svg>"})).then((function(e){return "data:image/svg+xml;charset=utf-8,"+e}))}(s,t.width||B.width(e),t.height||B.height(e))}))}function j(e,t){return K(e,t).then(B.makeImage).then(B.delay(100)).then((function(s){const i=function(e){const s=document.createElement("canvas");if(s.width=t.width||B.width(e),s.height=t.height||B.height(e),t.bgcolor){const e=s.getContext("2d");e.fillStyle=t.bgcolor,e.fillRect(0,0,s.width,s.height);}return s}(e);return i.getContext("2d").drawImage(s,0,0),i}))}function Y(e){return z.resolveAll().then((function(t){const s=document.createElement("style");return e.appendChild(s),s.appendChild(document.createTextNode(t)),e}))}function $(e){return W.inlineAll(e).then((function(){return e}))}class Q extends e.GeomItem{constructor(t,s,i){const n=new e.Material("uimat","FlatSurfaceShader");let o;n.visibleInGeomDataBuffer=!1,super("VRControllerUI",new e.Plane(1,1),n),this.appData=t,this.__vrUIDOMHolderElement=s,this.__vrUIDOMElement=i,this.__uiimage=new e.DataImage,n.getParameter("BaseColor").setValue(this.__uiimage),this.__uiGeomOffsetXfo=new e.Xfo,this.__uiGeomOffsetXfo.sc.set(0,0,1),this.__rect={width:0,height:0},this.__uiGeomOffsetXfo.ori.setFromAxisAndAngle(new e.Vec3(0,1,0),Math.PI),this.setGeomOffsetXfo(this.__uiGeomOffsetXfo);let a=[];const r=()=>{o=null;const e=a.map(e=>this.updateElemInAtlas(e));Promise.all(e).then(()=>{this.updateUIImage(),a=[];});};this.__mutationObserver=new MutationObserver(e=>{this.mainCtx?(e.some(e=>{let t=e.target;for(;t.parentNode;){if(t==this.__vrUIDOMElement)return this.renderUIToImage(),a=[],!1;if(t.classList.contains("VRUIElement")||t==this.__vrUIDOMElement){-1==a.indexOf(t)&&a.push(t);break}t=t.parentNode;}return !0}),o&&clearTimeout(o),o=setTimeout(r,50)):this.renderUIToImage();}),this.__active=!1,this.__renderRequested=!1;}activate(){this.__vrUIDOMHolderElement.style.display="block",this.__active=!0,this.__mutationObserver.observe(this.__vrUIDOMElement,{attributes:!0,characterData:!0,childList:!0,subtree:!0}),this.renderUIToImage();}deactivate(){this.__vrUIDOMHolderElement.style.display="none",this.__active=!0,this.__mutationObserver.disconnect();}updateElemInAtlas(e){return new Promise((t,s)=>{Z.toCanvas(e).then(s=>{const i=e.getBoundingClientRect();i.width*i.height!=0?(this.mainCtx.fillRect(i.x,i.y,i.width,i.height),this.mainCtx.drawImage(s,i.x,i.y),t()):t();});})}updateUIImage(){const e=this.mainCtx.getImageData(0,0,this.__rect.width,this.__rect.height);this.__uiimage.setData(this.__rect.width,this.__rect.height,new Uint8Array(e.data.buffer));}renderUIToImage(){Z.toCanvas(this.__vrUIDOMElement).then(e=>{this.mainCtx=e.getContext("2d"),this.mainCtx.fillStyle="#FFFFFF";const t=this.__vrUIDOMElement.getBoundingClientRect();if(t.width*t.height!=0){if(t.width!=this.__rect.width||t.height!=this.__rect.height){this.__rect=t;const e=7e-4;this.__uiGeomOffsetXfo.sc.set(this.__rect.width*e,this.__rect.height*e,1),this.setGeomOffsetXfo(this.__uiGeomOffsetXfo),this.appData.session.pub("pose-message",{interfaceType:"VR",updateUIPanel:{size:this.__uiGeomOffsetXfo.sc.toJSON()}});}this.updateUIImage();}});}sendMouseEvent(e,t,s){const i=new MouseEvent(e,Object.assign({target:s,view:window,bubbles:!0,cancelable:!0},t));return s.dispatchEvent(i),i}}class q extends a{constructor(e){super("HoldObjectsChange"),this.__selection=[],this.__prevXfos=[],this.__newXfos=[],e&&this.update(e);}undo(){for(let e=0;e<this.__selection.length;e++)this.__selection[e]&&this.__selection[e].setGlobalXfo(this.__prevXfos[e]);}redo(){for(let e=0;e<this.__selection.length;e++)this.__selection[e]&&this.__selection[e].setGlobalXfo(this.__newXfos[e]);}update(e){if(e.newItem)this.__selection[e.newItemId]=e.newItem,this.__prevXfos[e.newItemId]=e.newItem.getGlobalXfo();else if(e.changeXfos)for(let t=0;t<e.changeXfoIds.length;t++){const s=e.changeXfoIds[t];this.__selection[s]&&(this.__selection[s].setGlobalXfo(e.changeXfos[t]),this.__newXfos[s]=e.changeXfos[t]);}this.updated.emit(e);}toJSON(e){const t=super.toJSON(e),s=[];for(let e=0;e<this.__selection.length;e++)this.__selection[e]?s[e]=this.__selection[e].getPath():s.push(null);return t.itemPaths=s,t}fromJSON(e,t){super.fromJSON(e,t);const s=t.appData.scene.getRoot(),i=[];for(let t=0;t<e.itemPaths.length;t++){const n=e.itemPaths[t];n&&(i[t]=s.resolvePath(n,1));}this.__selection=i;}}o.registerChange("HoldObjectsChange",q);class ee extends O{constructor(e){super(e);}isPrimaryTool(){return !0}}class te extends a{constructor(e){super(e);}setParentAndXfo(e,t){this.parentItem=e;const s=this.parentItem.generateUniqueName(this.geomItem.getName());this.geomItem.setName(s),this.geomItem.setGlobalXfo(t),this.childIndex=this.parentItem.addChild(this.geomItem,!0),this.geomItem.addRef(this);}undo(){this.parentItem.removeChild(this.childIndex);}redo(){this.parentItem.addChild(this.geomItem,!1,!1);}toJSON(e){const t=super.toJSON(e);return t.parentItemPath=this.parentItem.getPath(),t.geomItemName=this.geomItem.getName(),t.geomItemXfo=this.geomItem.getParameter("LocalXfo").getValue(),t}fromJSON(t,s){const i=s.appData.scene.getRoot();this.parentItem=i.resolvePath(t.parentItemPath,1),this.geomItem.setName(this.parentItem.generateUniqueName(t.geomItemName));const n=new e.Xfo;n.fromJSON(t.geomItemXfo),this.geomItem.setLocalXfo(n),this.childIndex=this.parentItem.addChild(this.geomItem,!1);}destroy(){this.geomItem.removeRef(this);}}class se extends ee{constructor(t){super(t),this.stage=0,this.removeToolOnRightClick=!0,this.cp=this.addParameter(new e.ColorParameter("Line Color",new e.Color(.7,.2,.2)));}activateTool(){super.activateTool(),this.appData.renderer.getDiv().style.cursor="crosshair",this.appData.renderer.getXRViewport().then(t=>{this.vrControllerToolTip||(this.vrControllerToolTip=new e.Cross(.05),this.vrControllerToolTipMat=new e.Material("VRController Cross","LinesShader"),this.vrControllerToolTipMat.getParameter("Color").setValue(this.cp.getValue()),this.vrControllerToolTipMat.visibleInGeomDataBuffer=!1);const s=t=>{const s=new e.GeomItem("CreateGeomToolTip",this.vrControllerToolTip,this.vrControllerToolTipMat);t.getTipItem().removeAllChildren(),t.getTipItem().addChild(s,!1);};for(const e of t.getControllers())s(e);this.addIconToControllerId=t.controllerAdded.connect(s);});}deactivateTool(){super.deactivateTool(),this.appData.renderer.getDiv().style.cursor="pointer",this.appData.renderer.getXRViewport().then(e=>{e.controllerAdded.disconnectId(this.addIconToControllerId);});}screenPosToXfo(t,s){const i=s.calcRayFromScreenPos(t),n=new e.Ray(this.constructionPlane.tr,this.constructionPlane.ori.getZaxis()),o=i.intersectRayPlane(n);if(o>0){const e=this.constructionPlane.clone();return e.tr=i.pointAtDist(o),e}const a=s.getCamera(),r=a.getGlobalXfo().clone();return r.tr=i.pointAtDist(a.getFocalDistance()),r}createStart(e,t){this.stage=1;}createPoint(e){}createMove(e){}createRelease(e){}onMouseDown(t){if(0==this.stage){if(0==t.button){this.constructionPlane=new e.Xfo;const s=this.screenPosToXfo(t.mousePos,t.viewport);this.createStart(s,this.appData.scene.getRoot());}else 2==t.button&&this.removeToolOnRightClick&&this.appData.toolManager.removeTool(this.index);return !0}return 2!=t.button||(this.appData.undoRedoManager.undo(!1),this.stage=0,!0)}onMouseMove(e){if(this.stage>0){const t=this.screenPosToXfo(e.mousePos,e.viewport);return this.createMove(t.tr),!0}}onMouseUp(e){if(this.stage>0){const t=this.screenPosToXfo(e.mousePos,e.viewport);return this.createRelease(t.tr),!0}}onWheel(e){}onKeyPressed(e,t){}onKeyDown(e,t){}onKeyUp(e,t){}onTouchStart(e){}onTouchMove(e){}onTouchEnd(e){}onTouchCancel(e){}onVRControllerButtonDown(t){if(!this.__activeController){this.__activeController=t.controller,this.constructionPlane=new e.Xfo;const s=this.constructionPlane.clone();s.tr=this.__activeController.getTipXfo().tr,this.createStart(s,this.appData.scene.getRoot());}return !0}onVRPoseChanged(e){if(this.__activeController&&this.stage>0){const e=this.__activeController.getTipXfo();return this.createMove(e.tr),!0}}onVRControllerButtonUp(e){if(this.stage>0&&this.__activeController==e.controller){const e=this.__activeController.getTipXfo();return this.createRelease(e.tr),0==this.stage&&(this.__activeController=void 0),!0}}}class ie extends te{constructor(t,s,i,n){super("Create Line"),this.line=new e.Lines(0),this.line.setNumVertices(2),this.line.setNumSegments(1),this.line.setSegment(0,0,1);const o=new e.Material("Line","LinesShader");o.getParameter("Color").setValue(new e.Color(.7,.2,.2)),this.geomItem=new e.GeomItem("Line"),this.geomItem.setGeometry(this.line),this.geomItem.setMaterial(o),i&&o.getParameter("Color").setValue(i),n&&(this.line.lineThickness=n),t&&s&&this.setParentAndXfo(t,s);}update(e){e.p1&&(this.line.getVertex(1).setFromOther(e.p1),this.line.geomDataChanged.emit()),this.updated.emit(e);}fromJSON(t,s){if(super.fromJSON(t,s),t.color){const s=new e.Color;s.fromJSON(t.color),material.getParameter("Color").setValue(s);}t.thickness&&(this.line.lineThickness=t.thickness);}}o.registerChange("CreateLineChange",ie);class ne extends se{constructor(t){super(t),this.tp=this.addParameter(new e.NumberParameter("Line Thickness",.06,[0,.1]));}createStart(e,t){this.change=new ie(t,e),this.appData.undoRedoManager.addChange(this.change),this.xfo=e.inverse(),this.stage=1,this.length=0;}createMove(e){const t=this.xfo.transformVec3(e);this.length=t.length(),this.change.update({p1:t});}createRelease(e){0==this.length&&this.appData.undoRedoManager.undo(!1),this.stage=0,this.actionFinished.emit();}}class oe extends te{constructor(t,s){super("Create Circle",t),this.circle=new e.Circle(0,64),this.circle.lineThickness=.05;const i=new e.Material("circle","FatLinesShader");i.getParameter("Color").setValue(new e.Color(.7,.2,.2)),this.geomItem=new e.GeomItem("Circle"),this.geomItem.setGeometry(this.circle),this.geomItem.setMaterial(i),t&&s&&this.setParentAndXfo(t,s);}update(e){this.circle.getParameter("Radius").setValue(e.radius),this.updated.emit(e);}toJSON(){const e=super.toJSON();return e.radius=this.circle.getParameter("Radius").getValue(),e}changeFromJSON(e){console.log("CreateCircleChange:",e),e.radius&&this.circle.getParameter("Radius").setValue(e.radius);}}o.registerChange("CreateCircleChange",oe);class ae extends te{constructor(t,s){super("Create Rect"),this.rect=new e.Rect(0,0),this.rect.lineThickness=.05;const i=new e.Material("circle","FatLinesShader");i.getParameter("Color").setValue(new e.Color(.7,.2,.2)),this.geomItem=new e.GeomItem("Rect"),this.geomItem.setGeometry(this.rect),this.geomItem.setMaterial(i),t&&s&&this.setParentAndXfo(t,s);}update(e){if(e.baseSize&&this.rect.setSize(e.baseSize[0],e.baseSize[1]),e.tr){const t=this.geomItem.getParameter("LocalXfo").getValue();t.tr.fromJSON(e.tr),this.geomItem.getParameter("LocalXfo").setValue(t);}this.updated.emit(e);}}o.registerChange("CreateRectChange",ae);class re extends te{constructor(t,s,i,n){super("Create Freehand Line"),this.used=0,this.vertexCount=100,this.line=new e.Lines,this.line.setNumVertices(this.vertexCount),this.line.setNumSegments(this.vertexCount-1),this.line.vertices.setValue(0,new e.Vec3);const o=new e.Material("freeHandLine","FatLinesShader");this.geomItem=new e.GeomItem("freeHandLine"),this.geomItem.setGeometry(this.line),this.geomItem.setMaterial(o),i&&o.getParameter("Color").setValue(i),n&&(this.line.lineThickness=n),t&&s&&this.setParentAndXfo(t,s);}update(e){this.used++;let t=!1;this.used>=this.line.getNumSegments()&&(this.vertexCount=this.vertexCount+100,this.line.setNumVertices(this.vertexCount),this.line.setNumSegments(this.vertexCount-1),t=!0),this.line.vertices.setValue(this.used,e.point),this.line.setSegment(this.used-1,this.used-1,this.used),t?this.line.geomDataTopologyChanged.emit({indicesChanged:!0}):this.line.geomDataChanged.emit({indicesChanged:!0}),this.updated.emit(e);}toJSON(e){const t=super.toJSON(e);return t.lineThickness=this.line.lineThickness,t.color=this.geomItem.getMaterial().getParameter("Color").getValue(),t}fromJSON(t,s){t.lineThickness&&(this.line.lineThickness=t.lineThickness);const i=new e.Color(.7,.2,.2);t.color&&i.fromJSON(t.color),this.geomItem.getMaterial().getParameter("Color").setValue(i),super.fromJSON(t,s);}}o.registerChange("CreateFreehandLineChange",re);class le extends te{constructor(t,s){super("Create Sphere",t),this.sphere=new e.Sphere(0,64,32);const i=new e.Material("Sphere","SimpleSurfaceShader");this.geomItem=new e.GeomItem("Sphere"),this.geomItem.setGeometry(this.sphere),this.geomItem.setMaterial(i),t&&s&&this.setParentAndXfo(t,s);}update(e){this.sphere.radius=e.radius,this.updated.emit(e);}toJSON(){const e=super.toJSON();return e.radius=this.geomItem.getGeometry().radius,e}changeFromJSON(e){e.radius&&(this.geomItem.getGeometry().radius=e.radius);}}o.registerChange("CreateSphereChange",le);class he extends te{constructor(t,s){super("Create Cuboid"),this.cuboid=new e.Cuboid(0,0,0,!0);const i=new e.Material("Cuboid","SimpleSurfaceShader");this.geomItem=new e.GeomItem("Cuboid"),this.geomItem.setGeometry(this.cuboid),this.geomItem.setMaterial(i),t&&s&&this.setParentAndXfo(t,s);}update(e){if(e.baseSize&&this.cuboid.setBaseSize(e.baseSize[0],e.baseSize[1]),e.tr){const t=this.geomItem.getParameter("LocalXfo").getValue();t.tr.fromJSON(e.tr),this.geomItem.getParameter("LocalXfo").setValue(t);}e.height&&(this.cuboid.z=e.height),this.updated.emit(e);}}o.registerChange("CreateCuboidChange",he);class ce extends l{constructor(t,s=.5,i=.02,n=new e.Color(1,1,0)){super(t),this.lengthParam=this.addParameter(new e.NumberParameter("Length",s)),this.handleRadiusParam=this.addParameter(new e.NumberParameter("Handle Radius",i)),this.barRadiusParam=this.addParameter(new e.NumberParameter("Bar Radius",.25*i)),this.colorParam=this.addParameter(new e.ColorParameter("Color",n)),this.hilghlightColorParam=this.addParameter(new e.ColorParameter("Highlight Color",new e.Color(1,1,1))),this.handleMat=new e.Material("handle","FlatSurfaceShader"),this.handleMat.getParameter("BaseColor").setValue(this.colorParam.getValue());const o=new e.Material("topBar","FlatSurfaceShader");o.getParameter("BaseColor").setValue(new e.Color(.5,.5,.5));const a=new e.Cylinder(.25*i,1,64,2,!0,!0),r=new e.Sphere(i,64);this.handle=new e.GeomItem("handle",r,this.handleMat),this.baseBar=new e.GeomItem("baseBar",a,this.handleMat),this.topBar=new e.GeomItem("topBar",a,o),this.handleXfo=new e.Xfo,this.baseBarXfo=new e.Xfo,this.topBarXfo=new e.Xfo,this.barRadiusParam.valueChanged.connect(()=>{a.getParameter("radius").setValue(this.barRadiusParam.getValue());}),this.handleRadiusParam.valueChanged.connect(()=>{r.getParameter("radius").setValue(this.handleRadiusParam.getValue());}),this.lengthParam.valueChanged.connect(()=>{this.__updateSlider(this.value);}),this.colorParam.valueChanged.connect(()=>{this.handleMat.getParameter("BaseColor").setValue(this.colorParam.getValue());}),this.addChild(this.handle),this.addChild(this.baseBar),this.addChild(this.topBar),this.__updateSlider(0);}highlight(){this.handleMat.getParameter("BaseColor").setValue(this.hilghlightColorParam.getValue());}unhighlight(){this.handleMat.getParameter("BaseColor").setValue(this.colorParam.getValue());}setTargetParam(e){this.param=e;const t=()=>{this.__updateSlider(e.getValue());};t(),e.valueChanged.connect(t);}__updateSlider(t){this.value=t;const s=this.param&&this.param.getRange()?this.param.getRange():[0,1],i=Math.remap(t,s[0],s[1],0,1),n=this.lengthParam.getValue();this.baseBarXfo.sc.z=i*n,this.handleXfo.tr.z=i*n,this.topBarXfo.tr.z=i*n,this.topBarXfo.sc.z=(1-i)*n,this.handle.setLocalXfo(this.handleXfo,e.ValueSetMode.GENERATED_VALUE),this.baseBar.setLocalXfo(this.baseBarXfo,e.ValueSetMode.GENERATED_VALUE),this.topBar.setLocalXfo(this.topBarXfo,e.ValueSetMode.GENERATED_VALUE);}onDragStart(t){this.handleXfo.sc.x=this.handleXfo.sc.y=this.handleXfo.sc.z=1.2,this.handle.setLocalXfo(this.handleXfo,e.ValueSetMode.GENERATED_VALUE),this.param&&t.undoRedoManager&&(this.change=new h(this.param),t.undoRedoManager.addChange(this.change));}onDrag(e){const t=this.lengthParam.getValue(),s=this.param&&this.param.getRange()?this.param.getRange():[0,1],i=Math.clamp(Math.remap(e.value,0,t,s[0],s[1]),s[0],s[1]);if(!this.param)return this.__updateSlider(i),void(this.value=i);this.change?this.change.update({value:i}):this.param.setValue(i);}onDragEnd(t){this.change=null,this.handleXfo.sc.x=this.handleXfo.sc.y=this.handleXfo.sc.z=1,this.handle.setLocalXfo(this.handleXfo,e.ValueSetMode.GENERATED_VALUE);}toJSON(e,t=0){const s=super.toJSON(e,t|SAVE_FLAG_SKIP_CHILDREN);return this.param&&(s.targetParam=this.param.getPath()),s}fromJSON(e,t,s){super.fromJSON(e,t,s),e.targetParam&&t.resolvePath(e.targetParam).then(e=>{this.setTargetParam(e);});}}e.sgFactory.registerClass("SliderHandle",ce);class de extends m{constructor(t,s=1,i=1,n=.02,o=new e.Color(1,1,0)){super(t),this.arcRadiusParam=this.addParameter(new e.NumberParameter("Arc Radius",s)),this.arcAngleParam=this.addParameter(new e.NumberParameter("Arc Angle",i)),this.handleRadiusParam=this.addParameter(new e.NumberParameter("Handle Radius",n)),this.colorParam=this.addParameter(new e.ColorParameter("Color",o)),this.hilghlightColorParam=this.addParameter(new e.ColorParameter("Highlight Color",new e.Color(1,1,1))),this.handleMat=new e.Material("handleMat","HandleShader");const a=new e.Circle(s,i,64),r=new e.Sphere(n,64);this.handle=new e.GeomItem("handle",r,this.handleMat),this.arc=new e.GeomItem("arc",a,this.handleMat),this.handleXfo=new e.Xfo,this.handleGeomOffsetXfo=new e.Xfo,this.handleGeomOffsetXfo.tr.x=s,this.handle.getParameter("GeomOffsetXfo").setValue(this.handleGeomOffsetXfo),this.range=[0,i],this.arcAngleParam.valueChanged.connect(()=>{const e=this.arcAngleParam.getValue();a.getParameter("Angle").setValue(e),this.range=[0,e];}),this.arcRadiusParam.valueChanged.connect(()=>{const e=this.arcRadiusParam.getValue();a.getParameter("Radius").setValue(e),this.handleGeomOffsetXfo.tr.x=e,this.handle.getParameter("GeomOffsetXfo").setValue(this.handleGeomOffsetXfo);}),this.handleRadiusParam.valueChanged.connect(()=>{r.getParameter("radius").setValue(this.handleRadiusParam.getValue());}),this.colorParam.valueChanged.connect(()=>{this.handleMat.getParameter("BaseColor").setValue(this.colorParam.getValue());}),this.addChild(this.handle),this.addChild(this.arc),this.setTargetParam(this.handle.getParameter("GlobalXfo"),!1),this.dragStart=new e.Signal,this.dragEnd=new e.Signal;}onMouseEnter(e){e.intersectionData&&e.intersectionData.geomItem==this.handle&&this.highlight();}onMouseLeave(e){this.unhighlight();}onMouseDown(e){e.intersectionData&&e.intersectionData.geomItem==this.handle&&super.onMouseDown(e);}highlight(){this.handleMat.getParameter("BaseColor").setValue(this.hilghlightColorParam.getValue());}unhighlight(){this.handleMat.getParameter("BaseColor").setValue(this.colorParam.getValue());}getBaseXfo(){return this.handle.getParameter("GlobalXfo").getValue()}onDragStart(t){this.baseXfo=this.getGlobalXfo().clone(),this.baseXfo.sc.set(1,1,1),this.deltaXfo=new e.Xfo,this.vec0=this.getGlobalXfo().ori.getXaxis(),this.vec0.normalizeInPlace(),t.undoRedoManager&&(this.change=new h(this.param),t.undoRedoManager.addChange(this.change)),this.handleGeomOffsetXfo.sc.x=this.handleGeomOffsetXfo.sc.y=this.handleGeomOffsetXfo.sc.z=1.2,this.handle.getParameter("GeomOffsetXfo").setValue(this.handleGeomOffsetXfo),this.dragStart.emit();}onDrag(e){const t=e.holdPos.subtract(this.baseXfo.tr);t.normalizeInPlace();let s=this.vec0.angleTo(t);if(this.vec0.cross(t).dot(this.baseXfo.ori.getZaxis())<0&&(s=-s),this.range&&(s=Math.clamp(s,this.range[0],this.range[1])),e.shiftKey){const e=Math.degToRad(22.5);s=Math.floor(s/e)*e;}this.deltaXfo.ori.setFromAxisAndAngle(new Vec3(0,0,1),s);const i=this.baseXfo.multiply(this.deltaXfo);if(this.change)this.change.update({value:i});else {(this.param?this.param:this.getParameter("GlobalXfo")).setValue(i);}}onDragEnd(e){this.change=null,this.handleGeomOffsetXfo.sc.x=this.handleGeomOffsetXfo.sc.y=this.handleGeomOffsetXfo.sc.z=1,this.handle.getParameter("GeomOffsetXfo").setValue(this.handleGeomOffsetXfo),this.dragEnd.emit();}toJSON(e,t=0){const s=super.toJSON(e,t|SAVE_FLAG_SKIP_CHILDREN);return this.param&&(s.targetParam=this.param.getPath()),s}fromJSON(e,t,s){super.fromJSON(e,t,s),e.targetParam&&t.resolvePath(e.targetParam).then(e=>{this.setTargetParam(e);});}}e.sgFactory.registerClass("ArcSlider",de);class me extends HTMLElement{constructor(){super();const e=this.attachShadow({mode:"open"}),t=document.createElement("style");t.appendChild(document.createTextNode(me.css)),e.appendChild(t),this.itemContainer=document.createElement("div"),this.itemHeader=document.createElement("div"),this.itemHeader.className="TreeNodeHeader",this.itemContainer.appendChild(this.itemHeader),this.itemChildren=document.createElement("div"),this.itemChildren.className="TreeNodesList",this.itemContainer.appendChild(this.itemChildren),this.expandBtn=document.createElement("button"),this.expandBtn.className="TreeNodesListItem__ToggleExpanded",this.itemHeader.appendChild(this.expandBtn),this.expanded=!1,this.childrenAlreadyCreated=!1,this.expandBtn.addEventListener("click",()=>{this.treeItem.getNumChildren()>0&&(this.expanded?this.collapse():this.expand());}),this.titleElement=document.createElement("span"),this.titleElement.className="TreeNodesListItem__Title",this.titleElement.addEventListener("click",e=>{this.appData&&this.appData.selectionManager?this.appData.selectionManager.pickingModeActive()?this.appData.selectionManager.pick(this.treeItem):this.appData.selectionManager.toggleItemSelection(this.treeItem,!e.ctrlKey):this.treeItem.setSelected(!this.treeItem.getSelected());}),this.itemHeader.appendChild(this.titleElement),e.appendChild(this.itemContainer);}setTreeItem(t,s){this.treeItem=t,this.appData=s,this.titleElement.textContent=t.getName();this.treeItem.nameChanged.connect(()=>{this.titleElement.textContent=t.getName();}),this.updateSelectedId=this.treeItem.selectedChanged.connect(this.updateSelected.bind(this)),this.updateSelected(),t instanceof e.TreeItem&&(this.toggleVisibilityBtn=document.createElement("button"),this.toggleVisibilityBtn.className="TreeNodesListItem__ToggleVisibility",this.itemHeader.insertBefore(this.toggleVisibilityBtn,this.titleElement),this.toggleVisibilityBtn.innerHTML='<i class="material-icons-outlined md-15">visibility</i>',this.toggleVisibilityBtn.addEventListener("click",()=>{const e=this.treeItem.getParameter("Visible");if(this.appData&&this.appData.undoRedoManager){const t=new ParameterValueChange(e,!e.getValue());this.appData.undoRedoManager.addChange(t);}else e.setValue(!e.getValue());}),this.updateVisibilityId=this.treeItem.visibilityChanged.connect(this.updateVisibility.bind(this)),this.updateVisibility(),this.updateHighlightId=this.treeItem.highlightChanged.connect(this.updateHighlight.bind(this)),this.updateHighlight(),this.treeItem.getChildren().length&&this.collapse(),this.childAddedId=this.treeItem.childAdded.connect(this.childAdded.bind(this)),this.childRemovedId=this.treeItem.childRemoved.connect(this.childRemoved.bind(this)));}updateVisibility(){const e=this.treeItem.getVisible();e?this.itemContainer.classList.remove("TreeNodesListItem--isHidden"):this.itemContainer.classList.add("TreeNodesListItem--isHidden"),this.toggleVisibilityBtn.innerHTML=e?'<i class="material-icons-outlined md-15">visibility</i>':'<i class="material-icons-outlined md-15">visibility_off</i>';}updateSelected(){this.treeItem.getSelected()?this.itemContainer.classList.add("TreeNodesListItem--isSelected"):this.itemContainer.classList.remove("TreeNodesListItem--isSelected");}updateHighlight(){const t=this.treeItem.isHighlighted();if(t?this.itemContainer.classList.add("TreeNodesListItem--isHighlighted"):this.itemContainer.classList.remove("TreeNodesListItem--isHighlighted"),t){const t=this.treeItem.getHighlight(),s=t.lerp(new e.Color(.75,.75,.75,0),.5);this.titleElement.style.setProperty("border-color",t.toHex()),this.titleElement.style.setProperty("background-color",s.toHex());}else this.titleElement.style.removeProperty("border-color"),this.titleElement.style.removeProperty("background-color");}expand(){if(this.expanded=!0,this.itemChildren.classList.remove("TreeNodesList--collapsed"),this.expandBtn.innerHTML='<i class="material-icons md-24">arrow_drop_down</i>',!this.childrenAlreadyCreated){this.treeItem.getChildren().forEach((e,t)=>{this.addChild(e,t);}),this.childrenAlreadyCreated=!0;}}collapse(){this.itemChildren.classList.add("TreeNodesList--collapsed"),this.expandBtn.innerHTML='<i class="material-icons md-24">arrow_right</i>',this.expanded=!1;}addChild(e,t){if(this.expanded){const s=document.createElement("tree-item-view");s.setTreeItem(e,this.appData),t==this.itemChildren.childElementCount?this.itemChildren.appendChild(s):this.itemChildren.insertBefore(s,this.itemChildren.children[t]);}else this.collapse();}childAdded(e,t){this.addChild(e,t);}childRemoved(e,t){this.expanded&&(this.itemChildren.children[t].destroy(),this.itemChildren.removeChild(this.itemChildren.children[t]));}destroy(){this.treeItem.selectedChanged.disconnectId(this.updateSelectedId),this.treeItem instanceof e.TreeItem&&(this.treeItem.highlightChanged.disconnectId(this.updateHighlightId),this.treeItem.visibilityChanged.disconnectId(this.updateVisibilityId),this.treeItem.childAdded.disconnectId(this.childAddedId),this.treeItem.childRemoved.disconnectId(this.childRemovedId));}}me.css="\n  /* tree-view.css */\n\n  ////\n  /// From https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined\n\n  /* fallback */\n  @font-face {\n    font-family: 'Material Icons';\n    font-style: normal;\n    font-weight: 400;\n    src: url(https://fonts.gstatic.com/s/materialicons/v48/flUhRq6tzZclQEJ-Vdg-IuiaDsNc.woff2) format('woff2');\n  }\n  /* fallback */\n  @font-face {\n    font-family: 'Material Icons Outlined';\n    font-style: normal;\n    font-weight: 400;\n    src: url(https://fonts.gstatic.com/s/materialiconsoutlined/v14/gok-H7zzDkdnRel8-DQ6KAXJ69wP1tGnf4ZGhUce.woff2) format('woff2');\n  }\n\n  .material-icons {\n    font-family: 'Material Icons';\n    font-weight: normal;\n    font-style: normal;\n    font-size: 24px;\n    line-height: 1;\n    letter-spacing: normal;\n    text-transform: none;\n    display: inline-block;\n    white-space: nowrap;\n    word-wrap: normal;\n    direction: ltr;\n    -webkit-font-feature-settings: 'liga';\n    -webkit-font-smoothing: antialiased;\n  }\n\n  .material-icons-outlined {\n    font-family: 'Material Icons Outlined';\n    font-weight: normal;\n    font-style: normal;\n    font-size: 24px;\n    line-height: 1;\n    letter-spacing: normal;\n    text-transform: none;\n    display: inline-block;\n    white-space: nowrap;\n    word-wrap: normal;\n    direction: ltr;\n    -webkit-font-feature-settings: 'liga';\n    -webkit-font-smoothing: antialiased;\n  }\n  .TreeNodesList {\n    border-left: 1px dotted;\n    list-style-type: none;\n    padding: 0 0 0 15px;\n    margin: 0 0 0 10px;\n  }\n\n  .TreeNodesList--collapsed {\n    display: none;\n  }\n\n  .TreeNodesList--root {\n    border: none;\n    margin: 0;\n    padding: 0;\n    width: max-content;\n  }\n\n  .TreeNodesListItem{\n    display: flex;\n  }\n\n  .TreeNodesListItem__ToggleVisibility {\n    border: none;\n    color: #333;\n    height: 24px;\n    padding: 0;\n    width: 25px;\n  }\n\n  .TreeNodesListItem__ToggleVisibility:focus {\n    outline: none;\n  }\n\n  .TreeNodesListItem__ToggleExpanded {\n    border: none;\n    height: 24px;\n    width: 24px;\n    padding: 0;\n    background-color: #0000;\n    outline: none;\n  }\n\n  .TreeNodesListItem::before {\n    border-bottom: 1px dotted;\n    content: '';\n    display: inline-block;\n    left: -15px;\n    position: relative;\n    top: -5px;\n    width: 10px;\n  }\n\n  .TreeNodesListItem__Toggle:focus {\n    outline: none;\n  }\n\n  .TreeNodeHeader{\n    display: flex;\n    margin: 0.4em auto;\n  }\n\n  .TreeNodesListItem__Title {\n    cursor: default;\n    padding: 2px 4px;\n    border-radius: 5px;\n  }\n\n  .TreeNodesListItem__Title:hover {\n    background-color: #e1f5fe;\n  }\n  .TreeNodesListItem__Hover {\n    background-color: #e1f5fe;\n  }\n\n  .TreeNodesListItem__Dragging {\n    background-color: #e1f5fe;\n  }\n\n  .TreeNodesListItem--isSelected > .TreeNodeHeader > .TreeNodesListItem__Title {\n    background-color: #76d2bb;\n    color: #3B3B3B;\n  }\n\n  .TreeNodesListItem--isHidden > .TreeNodeHeader >  .TreeNodesListItem__Title {\n    color: #9e9e9e;\n  }\n\n  .TreeNodesListItem--isHighlighted > .TreeNodeHeader >  .TreeNodesListItem__Title {\n    border-style: solid;\n    border-width: thin;\n  }\n\n  /* Rules for sizing the icon. */\n  .material-icons-outlined.md-15,\n  .material-icons.md-15 {\n    font-size: 15px;\n  }\n  .material-icons.md-18 {\n    font-size: 18px;\n  }\n  .material-icons.md-24 {\n    font-size: 24px;\n  }\n  .material-icons.md-36 {\n    font-size: 36px;\n  }\n  .material-icons.md-48 {\n    font-size: 48px;\n  }\n\n  /* Rules for using icons as black on a light background. */\n  .material-icons.md-dark {\n    color: rgba(0, 0, 0, 0.54);\n  }\n  .material-icons.md-dark.md-inactive {\n    color: rgba(0, 0, 0, 0.26);\n  }\n\n  /* Rules for using icons as white on a dark background. */\n  .material-icons.md-light {\n    color: rgba(255, 255, 255, 1);\n  }\n  .material-icons.md-light.md-inactive {\n    color: rgba(255, 255, 255, 0.3);\n  }\n\n  ";customElements.get("tree-item-view")||customElements.define("tree-item-view",me);class ue extends HTMLElement{constructor(){super();const e=this.attachShadow({mode:"open"});this.treeContainer=document.createElement("div"),e.appendChild(this.treeContainer),this.treeItemView=document.createElement("tree-item-view");const t=new CSSStyleSheet;t.replaceSync("@font-face {\n      font-family: \"Material Icons\";\n      font-style: normal;\n      font-weight: 400;\n      src: url('https://fonts.gstatic.com/s/materialicons/v48/flUhRq6tzZclQEJ-Vdg-IuiaDsNc.woff2') format('woff');\n    }");const s=new CSSStyleSheet;s.replaceSync("@font-face {\n      font-family: \"Material Icons Outlined\";\n      font-style: normal;\n      font-weight: 400;\n      src: url('https://fonts.gstatic.com/s/materialiconsoutlined/v14/gok-H7zzDkdnRel8-DQ6KAXJ69wP1tGnf4ZGhUce.woff2') format('woff');\n    }"),document.adoptedStyleSheets=[...document.adoptedStyleSheets,t,s];}setTreeItem(e,t){this.treeItemView.setTreeItem(e,t),this.treeContainer.appendChild(this.treeItemView);}}customElements.get("scene-tree-view")||customElements.define("scene-tree-view",ue),exports.ActionRegistry=class{constructor(){this.actions=[],this.actionAdded=new e.Signal;}registerAction(e){const{name:t}=e;t?this._addAction(e):console.warn("A action is missing its name.");}_addAction(e){this.actions.push(e),this.actionAdded.emit(e);}getActions(){return this.actions}},exports.ActionTreeView=class{constructor(e){this.actionRegistry=e,this.__existingItems={};const t=document.createElement("div");document.body.appendChild(t);const s=this._addUlTo(t,"pure-menu-list");this.actionRegistry.getActions().forEach(e=>{1==e.availableInVR&&this._addMenuItem(s,e);}),this.actionRegistry.actionAdded.connect(e=>{1==e.availableInVR&&this._addMenuItem(s,e);});}_addSpanTo(e,t,s){const i=document.createElement("span");return i.className=t,s&&(i.innerHTML=s),e.appendChild(i),i}_addMenuItem(e,t){const s=document.createElement("a");s.href="#";const i="pure-menu-link VRUIElement";let n=!1;return s.className=i,s.addEventListener("mouseenter",e=>{n||(s.className=i+" HighlightedMenu");}),s.addEventListener("mouseleave",e=>{s.className=n?i+" ActionedMenu":i;}),t.activatedChanged?t.activatedChanged.connect(e=>{s.className=e?i+" ActionedMenu":i,n=e;}):(s.addEventListener("mousedown",e=>{s.className=i+" ActionedMenu";}),s.addEventListener("mouseup",e=>{s.className=i+" HighlightedMenu";})),t.callback&&s.addEventListener("click",e=>{e.preventDefault(),t.callback();}),e.appendChild(s),this._addSpanTo(s,"ActionTitle",t.name),s}_addUlTo(e,t,s){const i=document.createElement("ul");return i.className=t,s&&(i.innerHTML=s),e.appendChild(i),i}_addLiTo(e,t,s){const i=document.createElement("li");return i.className=t,s&&(i.innerHTML=s),e.appendChild(i),i}},exports.ArcSlider=de,exports.AxialRotationHandle=u,exports.Change=a,exports.CollabPanel=class{constructor(t){this.userSelected=new e.Signal,this.session=t;}mount(e){e.innerHTML='\n      <div class="ba b--light-blue br2 pa2 h4 overflow-y-auto mb2">\n        <ul id="userChips" class="list pa0 ma0"></ul>\n      </div>\n      <div class="ba b--light-blue br2 pa2 h5 overflow-y-auto mb2" id="receivedMessages"></div>\n\n      <form autocomplete="off" name="formSendMessage">\n        <div class="mb2 flex">\n          <input class="w-100 mr1" name="messageToSend" required type="text">\n          <button class="pure-button">\n            <i class="material-icons f4">send</i>\n          </button>\n        </div>\n      </form>\n\n      <div class="btn-group">\n        <button class="pure-button AudioButton" disabled id="toggleMic">\n          <i class="material-icons">mic</i>\n        </button>\n\n        <button class="pure-button CameraButton" disabled id="toggleCam">\n          <i class="material-icons">videocam</i>\n        </button>\n      </div>\n      \x3c!--\n      <form class="pure-form pure-form-aligned" name="formCreateRoom">\n        <legend>Create Room</legend>\n        <fieldset>\n          <div class="pure-control-group">\n            <label for="roomId">Room ID</label>\n            <input name="roomId" disabled type="text">\n            <button class="pure-button" disabled type="button">\n              <i class="material-icons f4">file_copy</i>\n            </button>\n          </div>\n        </fieldset>\n      </form>\n\n      <form class="pure-form pure-form-aligned" name="formJoinRoom">\n        <legend>Join Room</legend>\n        <fieldset>\n          <div class="pure-control-group">\n            <label for="roomId">Room ID</label>\n            <input name="roomId" type="text">\n          </div>\n        </fieldset>\n        <div class="flex justify-center">\n          <button class="pure-button pure-button-primary">\n            Join Room\n          </button>\n        </div>\n      </form>\n      --!>\n      <div class="btn-group tc">\n        <button class="pure-button pure-button-primary ma2" disabled>\n          Create Room\n        </button>\n        <button class="pure-button pure-button-primary ma0" disabled>\n          Join Room\n        </button>\n      </div>\n    ';const s=document.getElementById("userChips"),i=document.getElementById("receivedMessages"),n=document.getElementById("toggleMic");let o=!1;n.addEventListener("click",e=>{o?(this.session.muteAudio(),n.classList.remove("AudioButton--on"),o=!1):(this.session.unmuteAudio(),n.classList.add("AudioButton--on"),o=!0);});const a=document.getElementById("toggleCam");let r=!1;a.addEventListener("click",e=>{r?(this.session.stopCamera(),a.classList.remove("CameraButton--on"),r=!1):(this.session.startCamera(),a.classList.add("CameraButton--on"),r=!0);});const l=(e,t)=>{const s=document.createElement("p");s.innerHTML=`<strong>${e}:</strong> ${t}`,i.appendChild(s),i.scrollTop=i.scrollHeight;};document.formSendMessage.addEventListener("submit",e=>{const s=e.target;l("Me",s.messageToSend.value),this.session.pub(t.Session.actions.TEXT_MESSAGE,{text:s.messageToSend.value}),e.preventDefault(),s.reset();}),this.session.sub(t.Session.actions.TEXT_MESSAGE,(e,t)=>{const s=this.session.getUser(t);l(s.given_name,e.text);});const h={},c=e=>{const t=document.createElement("p");t.innerHTML=`<strong>(${e.name} has joined)</strong>`,i.appendChild(t),i.scrollTop=i.scrollHeight;const n=document.createElement("li");s.appendChild(n),new L(n,e).userSelected.connect(e=>{this.userSelected.emit(e);}),h[e.id]=n;},d=e=>{const t=document.createElement("p");t.innerHTML=`<strong>(${e.name} has left)</strong>`,i.appendChild(t),i.scrollTop=i.scrollHeight,s.removeChild(h[e.id]);};this.session.sub(t.Session.actions.USER_JOINED,(e,t)=>{c(e);}),this.session.sub(t.Session.actions.USER_LEFT,(e,t)=>{d(e);}),this.session.sub(t.Session.actions.LEFT_ROOM,()=>{const e=this.session.getUsers();for(const t in e)d(e[t]);i.innerHTML="";});const m=this.session.getUsers();for(const e in m)c(m[e]);}unMount(e){}},exports.CreateCircleTool=class extends se{constructor(e){super(e);}createStart(e,t){this.change=new oe(t,e),this.appData.undoRedoManager.addChange(this.change),this.xfo=e,this.stage=1,this.radius=0;}createMove(e){this.radius=e.distanceTo(this.xfo.tr),this.change.update({radius:this.radius});}createRelease(e){0==this.radius&&this.appData.undoRedoManager.undo(!1),this.change=null,this.stage=0,this.actionFinished.emit();}},exports.CreateCuboidTool=class extends se{constructor(e){super(e);}createStart(e,t){this.change=new he(t,e),this.appData.undoRedoManager.addChange(this.change),this.xfo=e,this.invxfo=e.inverse(),this.stage=1,this._height=0;}createMove(e){if(1==this.stage){const t=this.invxfo.transformVec3(e);this.change.update({baseSize:[Math.abs(t.x),Math.abs(t.y)],tr:this.xfo.tr.add(t.scale(.5))});}else {const t=this.invxfo.transformVec3(e);this.change.update({height:t.y});}}createRelease(t,s){if(1==this.stage){this.stage=2,this.pt1=t;const s=new e.Quat;s.setFromAxisAndAngle(new e.Vec3(1,0,0),.5*Math.PI),this.constructionPlane.ori=this.constructionPlane.ori.multiply(s),this.constructionPlane.tr=t,this.invxfo=this.constructionPlane.inverse();}else 2==this.stage&&(this.stage=0,this.actionFinished.emit());}},exports.CreateFreehandLineTool=class extends ne{constructor(t){super(t),this.mp=this.addParameter(new e.BooleanParameter("Modulate Thickness By Stroke Speed",!1));}createStart(e,t){const s=this.cp.getValue(),i=this.tp.getValue();this.change=new re(t,e,s,i),this.appData.undoRedoManager.addChange(this.change),this.xfo=e,this.invxfo=e.inverse(),this.stage=1,this.prevP=e.tr,this.length=0;}createMove(e){const t=this.invxfo.transformVec3(e),s=t.subtract(this.prevP).length();s>.001&&this.change.update({point:t}),this.length+=s,this.prevP=t;}createRelease(e){0==this.length&&this.appData.undoRedoManager.undo(!1),this.stage=0,this.actionFinished.emit();}},exports.CreateLineTool=ne,exports.CreateRectTool=class extends se{constructor(e){super(e);}createStart(e,t){this.change=new ae(t,e),this.appData.undoRedoManager.addChange(this.change),this.xfo=e,this.invxfo=e.inverse(),this.stage=1,this._size=0;}createMove(e){if(1==this.stage){const t=this.invxfo.transformVec3(e);this._size=Math.abs(t.x),this.change.update({baseSize:[Math.abs(t.x),Math.abs(t.y)],tr:this.xfo.tr.add(t.scale(.5))});}else {const t=this.invxfo.transformVec3(e);this.change.update({height:t.y});}}createRelease(e,t){0==this._size&&this.appData.undoRedoManager.undo(!1),this.stage=0,this.actionFinished.emit();}},exports.CreateSphereTool=class extends se{constructor(e){super(e);}createStart(e,t){this.change=new le(t,e),this.appData.undoRedoManager.addChange(this.change),this.xfo=e,this.stage=1,this.radius=0;}createMove(e){this.radius=e.distanceTo(this.xfo.tr),this.change.update({radius:this.radius});}createRelease(e){0==this.radius&&this.appData.undoRedoManager.undo(!1),this.stage=0,this.actionFinished.emit();}},exports.HandleTool=class extends O{constructor(e){super(e),this.activeHandle=void 0,this.capturedItems=[],this.mouseOverItems=[];}activateTool(){super.activateTool(),console.log("activateTool.HandleTool"),this.appData.renderer.getDiv().style.cursor="crosshair";const t=t=>{if(!this.__activated)return;const s=new e.Sphere(.015),i=new e.Material("Cross","FlatSurfaceShader");i.getParameter("BaseColor").setValue(new e.Color("#03E3AC")),i.visibleInGeomDataBuffer=!1;const n=new e.GeomItem("HandleToolTip",s,i);t.getTipItem().removeAllChildren(),t.getTipItem().addChild(n,!1);},s=e=>{for(const s of e.getControllers())t(s);this.addIconToControllerId=e.controllerAdded.connect(t);};this.appData.renderer.getXRViewport().then(e=>{s(e);});}deactivateTool(){super.deactivateTool(),this.appData.renderer.getXRViewport().then(e=>{e.controllerAdded.disconnectId(this.addIconToControllerId);});}onMouseDown(e){if(!this.activeHandle){const t=e.viewport.getGeomDataAtPos(e.mousePos);if(null==t)return;if(t.geomItem.getOwner()instanceof r)return this.activeHandle=t.geomItem.getOwner(),this.activeHandle.handleMouseDown(Object.assign(e,{intersectionData:t})),!0}}onMouseMove(e){if(this.activeHandle)return this.activeHandle.handleMouseMove(e),!0;{if(0==e.button&&1==e.buttons)return !1;const t=e.viewport.getGeomDataAtPos(e.mousePos);if(null!=t&&t.geomItem.getOwner()instanceof r){const e=t.geomItem.getOwner();return this.__highlightedHandle&&this.__highlightedHandle.unhighlight(),this.__highlightedHandle=e,this.__highlightedHandle.highlight(),!0}this.__highlightedHandle&&(this.__highlightedHandle.unhighlight(),this.__highlightedHandle=void 0);}}onMouseUp(e){if(this.activeHandle)return this.activeHandle.handleMouseUp(e),this.activeHandle=void 0,!0}onWheel(e){this.activeHandle&&this.activeHandle.onWheel(e);}onTouchStart(e){}onTouchMove(e){}onTouchEnd(e){}onTouchCancel(e){}__prepareVREvent(e){const t=e.controller.getId();e.setCapture=e=>{this.capturedItems[t]=e;},e.getCapture=()=>this.capturedItems[t],e.releaseCapture=()=>{this.capturedItems[t]=null;};}onVRControllerButtonDown(e){const t=e.controller.getId();if(this.capturedItems[t])this.__prepareVREvent(e),this.capturedItems[t].onMouseDown(e);else {const t=e.controller.getGeomItemAtTip();null!=t&&(e.intersectionData=t,e.geomItem=t.geomItem,this.__prepareVREvent(e),t.geomItem.onMouseDown(e));}}onVRPoseChanged(e){for(const t of e.controllers){const s=t.getId();if(this.capturedItems[s])this.capturedItems[s].onMouseMove(e);else {const i=t.getGeomItemAtTip();null!=i?(e.intersectionData=i,e.geomItem=i.geomItem,i.geomItem!=this.mouseOverItems[s]&&(this.mouseOverItems[s]&&this.mouseOverItems[s].onMouseLeave(e),this.mouseOverItems[s]=i.geomItem,this.mouseOverItems[s].onMouseEnter(e)),i.geomItem.onMouseMove(e)):this.mouseOverItems[s]&&(this.mouseOverItems[s].onMouseLeave(e),this.mouseOverItems[s]=null);}}}onVRControllerButtonUp(e){this.__prepareVREvent(e);const t=e.controller.getId();if(this.capturedItems[t])this.capturedItems[t].onMouseUp(e);else {const t=e.controller.getGeomItemAtTip();null!=t&&(e.intersectionData=t,e.geomItem=t.geomItem,t.geomItem.onMouseUp(e));}}},exports.InspectorContainer=class{constructor(e){this.appData=e,this.pinned=!1;}inspect(e){this.inspectedItem=e,this.domElement&&(this.inspector&&(this.inspector.destroy&&this.inspector.destroy(),this.domElement.innerHTML=""),this.inspectedItem&&(this.inspector=V.constructInspector(e,this.domElement,this.appData)));}mount(e){this.parentElement=e;const t=document.createElement("ul");t.className="list pa0 pr3";const s=document.createElement("li"),i=document.createElement("input");i.setAttribute("id","pinned"),i.setAttribute("type","checkbox"),i.setAttribute("tabindex",0),i.checked=this.pinned,i.style.margin="5px",i.addEventListener("input",()=>{this.pinned=i.checked;});const n=document.createElement("label");n.setAttribute("for","pinned"),n.appendChild(document.createTextNode("Pinned")),s.appendChild(n),s.appendChild(i),t.appendChild(s);const o=document.createElement("li");this.domElement=document.createElement("div"),o.appendChild(this.domElement),t.appendChild(o),this.parentElement.appendChild(t),this.domElement.innerHTML="",this.inspectedItem&&this.inspect(this.inspectedItem);const a=this.appData.selectionManager;this._selChangedId=a.leadSelectionChanged.connect(e=>{this.inspectedItem&&this.pinned||this.inspect(e);});}unMount(){this.appData.selectionManager.leadSelectionChanged.disconnectId(this._selChangedId),this.parentElement.innerHTML="";}},exports.LinearMovementHandle=c,exports.OpenVRUITool=class extends O{constructor(e,t){super(e),this.vrUITool=t,this.uiToolIndex=-1,this.__stayClosed=!1;}uninstall(){super.uninstall(),this.uiToolIndex>0&&this.appData.toolManager.removeToolByHandle(this.vrUITool);}onVRControllerButtonDown(e){}onVRControllerButtonUp(e){}stayClosed(){this.__stayClosed=!0;}onVRPoseChanged(e){if(this.vrUITool.installed())return;const t=e.viewXfo,s=(e,s)=>{if(!e)return !1;const i=e.getTreeItem().getGlobalXfo(),n=i.tr.subtract(t.tr);return n.normalizeInPlace(),n.angleTo(i.ori.getYaxis())<.25*Math.PI?(this.__stayClosed||(this.vrUITool.setUIControllers(this,e,s,t),this.uiToolIndex=this.appData.toolManager.pushTool(this.vrUITool)),!0):void 0};if(e.controllers.length>0){if(s(e.controllers[0],e.controllers[1]))return !0;if(s(e.controllers[1],e.controllers[0]))return !0}this.uiToolIndex=-1,this.__stayClosed=!1;}},exports.Panels=class{constructor(e,t){this.options=t||{},e&&this.mount(e);}mount(e){this.sidePanelsWrapper=document.createElement("div"),this.sidePanelsWrapper.className="PanelsWrapper flex overflow-hidden",e.appendChild(this.sidePanelsWrapper),1==this.options.leftPanel&&(this.leftPanel=new k(0),this.leftPanel.mount(this.sidePanelsWrapper)),this.centerDomElement=document.createElement("div"),this.centerDomElement.className="PanelsCenter flex-grow-1 overflow-hidden",this.centerDomElement.id="viewport",this.sidePanelsWrapper.appendChild(this.centerDomElement),1==this.options.rightPanel&&(this.rightPanel=new k(1),this.rightPanel.mount(this.sidePanelsWrapper)),1==this.options.bottomPanel&&(this.bottomPanel=new G,this.bottomPanel.mount(e));}unMount(e){}},exports.ParameterContainer=X,exports.ParameterValueChange=h,exports.PlanarMovementHandle=d,exports.PublishDialog=class{constructor(){this.__publishDialogHolder=document.createElement("div"),this.__publishDialogHolder.className="publish-dialog-bg",this.__publishDialogHolder.addEventListener("mousedown",e=>{e.target==this.__publishDialogHolder&&this.hide();});const e=document.createElement("div");e.className="publish-dialog";const t=new URLSearchParams(window.location.search),s=new URLSearchParams;t.forEach((function(e,t){t.startsWith("room-id")||s.set(t,e);})),s.set("published",!0);const i=`${window.location.origin}?${s.toString()}`,n=document.createElement("div");n.className="publicToggle",n.className="publish-dialog-toggle";const o=document.createElement("input");o.setAttribute("type","checkbox"),o.setAttribute("is","isPublicCheckbox"),o.value=i,o.addEventListener("change",e=>{l.disabled=!o.checked,r.disabled=!o.checked;}),n.appendChild(o);const a=document.createElement("label");a.className="publish-dialog-label",a.setAttribute("type","checkbox"),a.setAttribute("for","isPublicCheckbox"),a.textContent="Is Published",n.appendChild(a),e.appendChild(n);const r=document.createElement("textarea");r.className="embedcode",r.className="publish-dialog-link",r.setAttribute("rows",2),r.setAttribute("cols",30),r.setAttribute("readonly","readonly"),r.value=i,r.disabled=!0,e.appendChild(r);const l=document.createElement("textarea");l.className="embedcode",l.className="publish-dialog-embedcode",l.setAttribute("rows",5),l.setAttribute("cols",30),l.setAttribute("readonly","readonly"),l.disabled=!0,l.value=`<iframe src="${i}" width="640" height="360" frameborder="0" allow="webvr;webxr;fullscreen" allowfullscreen></iframe>`,e.appendChild(l);const h=document.createElement("button");h.appendChild(document.createTextNode("Generate SCORM Package")),h.addEventListener("click",e=>{}),h.style.margin="2px",e.appendChild(h),this.__publishDialogHolder.appendChild(e),document.body.appendChild(this.__publishDialogHolder),this.visible=!1;}show(){this.__publishDialogHolder.style.display="block",this.visible=!0;}hide(){this.__publishDialogHolder.style.display="none",this.visible=!1;}},exports.SceneTreeView=ue,exports.ScreenSpaceMovementHandle=class extends r{constructor(e){super(e);}setTargetParam(e,t=!0){if(this.param=e,t){const t=()=>{this.setGlobalXfo(e.getValue());};t(),e.valueChanged.connect(t);}}getTargetParam(){return this.param?this.param:this.getParameter("GlobalXfo")}handleMouseDown(t){this.gizmoRay=new e.Ray,this.gizmoRay.dir=t.mouseRay.dir.negate();const s=this.getTargetParam().getValue();this.gizmoRay.pos=s.tr;const i=t.mouseRay.intersectRayPlane(this.gizmoRay);return t.grabPos=t.mouseRay.pointAtDist(i),this.onDragStart(t),!0}handleMouseMove(e){const t=e.mouseRay.intersectRayPlane(this.gizmoRay);return e.holdPos=e.mouseRay.pointAtDist(t),this.onDrag(e),!0}handleMouseUp(e){const t=e.mouseRay.intersectRayPlane(this.gizmoRay);return e.releasePos=e.mouseRay.pointAtDist(t),this.onDragEnd(e),!0}onDragStart(e){this.grabPos=e.grabPos;const t=this.getTargetParam();this.baseXfo=t.getValue(),e.undoRedoManager&&(this.change=new h(t),e.undoRedoManager.addChange(this.change));}onDrag(e){const t=e.holdPos.subtract(this.grabPos),s=this.baseXfo.clone();if(s.tr.addInPlace(t),this.change)this.change.update({value:s});else {this.getTargetParam().setValue(s);}}onDragEnd(e){this.change=null;}},exports.SelectionManager=I,exports.SelectionTool=H,exports.SessionSync=class{constructor(s,i,n,a){const r={};s.sub(t.Session.actions.USER_JOINED,e=>{e.id in r||(r[e.id]={undoRedoManager:new o,avatar:new P(i,e),selectionManager:new I(i,{...a,enableXfoHandles:!1,setItemsSelected:!1})});}),s.sub(t.Session.actions.USER_LEFT,e=>{r[e.id]?(r[e.id].avatar.destroy(),delete r[e.id]):console.warn("User id not in session:",e.id);}),s.sub(t.Session.actions.USER_VIDEO_STARTED,(e,t)=>{if(!r[t])return void console.warn("User id not in session:",t);const i=s.getVideoStream(t);i&&r[t].avatar.attachRTCStream(i);}),s.sub(t.Session.actions.USER_VIDEO_STOPPED,(e,t)=>{r[t]?(console.log("USER_VIDEO_STOPPED:",t," us:",n.id),r[t].avatar&&r[t].avatar.detachRTCStream(s.getVideoStream(t))):console.warn("User id not in session:",t);}),i.toolManager.movePointer.connect(e=>{const i=e.viewport.getGeomDataAtPos(e.mousePos,e.mouseRay),n=i?i.dist:5,o={interfaceType:"CameraAndPointer",movePointer:{start:e.mouseRay.start,dir:e.mouseRay.dir,length:n}};s.pub(t.Session.actions.POSE_CHANGED,T(o));}),i.toolManager.hidePointer.connect(e=>{s.pub(t.Session.actions.POSE_CHANGED,{interfaceType:"CameraAndPointer",hidePointer:{}});}),i.toolManager.hilightPointer.connect(e=>{s.pub(t.Session.actions.POSE_CHANGED,{interfaceType:"CameraAndPointer",hilightPointer:{}});}),i.toolManager.unhilightPointer.connect(e=>{s.pub(t.Session.actions.POSE_CHANGED,T({interfaceType:"CameraAndPointer",unhilightPointer:{}}));});let l=0;i.renderer.viewChanged.connect(e=>{l++;const i="VR"==e.interfaceType;if(i&&l%2!=0)return;const n={interfaceType:e.interfaceType,viewXfo:e.viewXfo};if(e.focalDistance)n.focalDistance=e.focalDistance;else if(i){n.controllers=[];for(const t of e.controllers)n.controllers.push({xfo:t.getTreeItem().getGlobalXfo()});}s.pub(t.Session.actions.POSE_CHANGED,T(n));}),s.sub(t.Session.actions.POSE_CHANGED,(e,t)=>{if(!r[t])return void console.warn("User id not in session:",t);const s=E(e,i.scene);r[t].avatar.updatePose(s);}),s.pub(t.Session.actions.POSE_CHANGED,T({interfaceType:"CameraAndPointer",viewXfo:i.renderer.getViewport().getCamera().getGlobalXfo()}));const h=i.scene.getRoot();i.undoRedoManager.changeAdded.connect(e=>{const n={appData:i,makeRelative:e=>e,resolvePath:(e,t)=>{if(!e)throw "Path not spcecified";const s=h.resolvePath(e);s?t(s):console.warn("Path unable to be resolved:"+e);}},a={changeData:e.toJSON(n),changeClass:o.getChangeClassName(e)};s.pub(t.Session.actions.COMMAND_ADDED,a);}),i.undoRedoManager.changeUpdated.connect(e=>{const i=T(e);s.pub(t.Session.actions.COMMAND_UPDATED,i);}),s.sub(t.Session.actions.COMMAND_ADDED,(e,t)=>{if(!r[t])return void console.warn("User id not in session:",t);const s=r[t].undoRedoManager,n=s.constructChange(e.changeClass),o={appData:{selectionManager:r[t].selectionManager,scene:i.scene}};n.fromJSON(e.changeData,o),s.addChange(n);}),s.sub(t.Session.actions.COMMAND_UPDATED,(e,t)=>{if(!r[t])return void console.warn("User id not in session:",t);const s=r[t].undoRedoManager,n=E(e,i.scene);s.getCurrentChange().update(n);}),i.undoRedoManager.changeUndone.connect(()=>{s.pub("UndoRedoManager_changeUndone",{});}),s.sub("UndoRedoManager_changeUndone",(e,t)=>{r[t].undoRedoManager.undo();}),i.undoRedoManager.changeRedone.connect(()=>{s.pub("UndoRedoManager_changeRedone",{});}),s.sub("UndoRedoManager_changeRedone",(e,t)=>{r[t].undoRedoManager.redo();}),e.sgFactory.registerCallback("StateMachine",e=>{e.stateChanged.connect(t=>{s.pub("StateMachine_stateChanged",{stateMachine:e.getPath(),stateName:t});});}),s.sub("StateMachine_stateChanged",(e,t)=>{i.scene.getRoot().resolvePath(e.stateMachine,1).activateState(e.stateName);});}},exports.SliderHandle=ce,exports.ToolAction=class extends class{constructor(e,t,s=!1){this.name=e,this.path=t,this.availableInVR=s,this.callback=this.callback.bind(this);}callback(){}}{constructor(t,s,i,n,o){super(t,s,i),this.toolManager=n,this.tool=o,this.state=!1,this.activatedChanged=new e.Signal,o.installChanged.connect(e=>{this.activatedChanged.emit(e);});}callback(){if(this.tool.installed())this.toolManager.removeToolByHandle(this.tool);else {const e=this.toolManager.currTool();"VRUITool"==e.getName()?this.toolManager.insertToolBefore(this.tool,e):e.isPrimaryTool()?this.toolManager.replaceCurrentTool(this.tool):this.toolManager.pushTool(this.tool);}}},exports.ToolManager=class{constructor(t){this.__toolStack=[],this.appData=t,this.movePointer=new e.Signal,this.hilightPointer=new e.Signal,this.unhilightPointer=new e.Signal,this.hidePointer=new e.Signal,this.avatarPointerVisible=!1,this.avatarPointerHighlighted=!1;}insertTool(e,t){this.__toolStack.splice(t,0,e),e.install(t);}insertToolBefore(e,t){const s=this.__toolStack.indexOf(t)+1;return this.__toolStack.splice(s-1,0,e),e.install(s),s}insertToolAfter(e,t){const s=this.__toolStack.indexOf(t)+1;return this.__toolStack.splice(s,0,e),e.install(s),s==this.__toolStack.length&&e.activateTool(),s}getToolIndex(e){return this.__toolStack.indexOf(e)}removeTool(e){const t=this.__toolStack[e];if(this.__toolStack.splice(e,1),t.uninstall(),e==this.__toolStack.length){t.deactivateTool();const e=this.currTool();e?e.activateTool():this.appData.renderer.getDiv().style.cursor="pointer";}}removeToolByHandle(e){this.removeTool(this.getToolIndex(e));}pushTool(e){const t=this.currTool();if(t){if(e==t)return void console.warn("Tool Already Pushed on the stack:",e.constructor.name);t.deactivateTool();}return this.__toolStack.push(e),e.install(this.__toolStack.length-1),e.activateTool(),console.log("ToolManager.pushTool:",e.constructor.name),this.__toolStack.length-1}__removeCurrTool(){if(this.__toolStack.length>0){const e=this.__toolStack.pop();e.deactivateTool(),e.uninstall();}}popTool(){this.__removeCurrTool();const e=this.currTool();e&&e.activateTool();}replaceCurrentTool(e){this.__removeCurrTool(),this.__toolStack.push(e),e.install(this.__toolStack.length-1),e.activateTool();}currTool(){return this.__toolStack[this.__toolStack.length-1]}currToolName(){return this.__toolStack[this.__toolStack.length-1].getName()}bind(e){const t=e.getViewport();this.mouseDownId=t.mouseDown.connect(this.onMouseDown.bind(this)),this.mouseMoveId=t.mouseMove.connect(this.onMouseMove.bind(this)),this.mouseUpId=t.mouseUp.connect(this.onMouseUp.bind(this)),this.mouseLeaveId=t.mouseLeave.connect(this.onMouseLeave.bind(this)),this.mouseDoubleClickedId=t.mouseDoubleClicked.connect(this.onDoubleClick.bind(this)),this.mouseWheelId=t.mouseWheel.connect(this.onWheel.bind(this)),this.keyDownId=t.keyDown.connect(this.onKeyDown.bind(this)),this.keyUpId=t.keyUp.connect(this.onKeyUp.bind(this)),this.keyPressedId=t.keyPressed.connect(this.onKeyPressed.bind(this)),this.touchStartId=t.touchStart.connect(this.onTouchStart.bind(this)),this.touchMoveId=t.touchMove.connect(this.onTouchMove.bind(this)),this.touchEndId=t.touchEnd.connect(this.onTouchEnd.bind(this)),this.touchCancelId=t.touchCancel.connect(this.onTouchCancel.bind(this)),this.doubleTappedId=t.doubleTapped.connect(this.onDoubleTap.bind(this)),this.appData.renderer.getXRViewport().then(e=>{this.controllerDownId=e.controllerButtonDown.connect(this.onVRControllerButtonDown.bind(this)),this.controllerUpId=e.controllerButtonUp.connect(this.onVRControllerButtonUp.bind(this)),this.controllerDoubleClickId=e.controllerDoubleClicked.connect(this.onVRControllerDoubleClicked.bind(this)),this.onVRPoseChangedId=e.viewChanged.connect(this.onVRPoseChanged.bind(this));});}onMouseDown(e){e.undoRedoManager=this.appData.undoRedoManager,e.showPointerOnAvatar=!0;let t=this.__toolStack.length;for(;t--;){const s=this.__toolStack[t];if(s&&1==s.onMouseDown(e))break}1==e.showPointerOnAvatar?(this.avatarPointerVisible||(this.movePointer.emit(e),this.avatarPointerVisible=!0),this.avatarPointerHighlighted||(this.hilightPointer.emit(e),this.avatarPointerHighlighted=!0)):this.avatarPointerVisible&&(this.avatarPointerVisible=!1,this.hidePointer.emit());}onMouseMove(e){e.undoRedoManager=this.appData.undoRedoManager,e.showPointerOnAvatar=!0;let t=this.__toolStack.length;for(;t--;){const s=this.__toolStack[t];if(s&&1==s.onMouseMove(e))break}1==e.showPointerOnAvatar?(this.movePointer.emit(e),this.avatarPointerVisible=!0):this.avatarPointerVisible&&(this.avatarPointerVisible=!1,this.hidePointer.emit());}onMouseUp(e){e.undoRedoManager=this.appData.undoRedoManager,e.showPointerOnAvatar=!0;let t=this.__toolStack.length;for(;t--;){const s=this.__toolStack[t];if(s&&1==s.onMouseUp(e))break}1==e.showPointerOnAvatar?this.avatarPointerHighlighted&&(this.unhilightPointer.emit(e),this.avatarPointerHighlighted=!1):this.avatarPointerVisible&&(this.avatarPointerVisible=!1,this.hidePointer.emit());}onMouseLeave(e){let t=this.__toolStack.length;for(;t--;){const s=this.__toolStack[t];if(s&&s.onMouseLeave&&1==s.onMouseLeave(e))break}this.avatarPointerVisible&&(this.avatarPointerVisible=!1,this.hidePointer.emit());}onDoubleClick(e){let t=this.__toolStack.length;for(;t--;){const s=this.__toolStack[t];if(s&&1==s.onDoubleClick(e))break}}onWheel(e){e.undoRedoManager=this.appData.undoRedoManager;let t=this.__toolStack.length;for(;t--;){const s=this.__toolStack[t];if(s&&1==s.onWheel(e))break}}onKeyPressed(e,t){t.undoRedoManager=this.appData.undoRedoManager;let s=this.__toolStack.length;for(;s--;){const e=this.__toolStack[s];if(e&&1==e.onKeyPressed(t,t,viewport))break}}onKeyDown(e,t){t.undoRedoManager=this.appData.undoRedoManager;let s=this.__toolStack.length;for(;s--;){const i=this.__toolStack[s];if(i&&1==i.onKeyDown(e,t))break}}onKeyUp(e,t){t.undoRedoManager=this.appData.undoRedoManager;let s=this.__toolStack.length;for(;s--;){const i=this.__toolStack[s];if(i&&1==i.onKeyUp(e,t))break}}onTouchStart(e){e.undoRedoManager=this.appData.undoRedoManager;let t=this.__toolStack.length;for(;t--;){const s=this.__toolStack[t];if(s&&1==s.onTouchStart(e))break}}onTouchMove(e){e.undoRedoManager=this.appData.undoRedoManager;let t=this.__toolStack.length;for(;t--;){const s=this.__toolStack[t];if(s&&1==s.onTouchMove(e))break}}onTouchEnd(e){e.undoRedoManager=this.appData.undoRedoManager;let t=this.__toolStack.length;for(;t--;){const s=this.__toolStack[t];if(s&&1==s.onTouchEnd(e))break}}onTouchCancel(e){e.undoRedoManager=this.appData.undoRedoManager;let t=this.__toolStack.length;for(;t--;){const s=this.__toolStack[t];if(s&&1==s.onTouchCancel(e))break}}onDoubleTap(e){e.undoRedoManager=this.appData.undoRedoManager;let t=this.__toolStack.length;for(;t--;){const s=this.__toolStack[t];if(s&&1==s.onDoubleTap(e))break}}__prepareEvent(e){e.undoRedoManager=this.appData.undoRedoManager,e.propagating=!0,e.stopPropagation=()=>{e.propagating=!1;};}onVRControllerButtonDown(e){this.__prepareEvent(e);let t=this.__toolStack.length;for(;t--;){const s=this.__toolStack[t];if(s&&1==s.onVRControllerButtonDown(e))break;if(!e.propagating)break}}onVRControllerButtonUp(e){this.__prepareEvent(e);let t=this.__toolStack.length;for(;t--;){const s=this.__toolStack[t];if(s&&1==s.onVRControllerButtonUp(e))break;if(!e.propagating)break}}onVRControllerDoubleClicked(e){this.__prepareEvent(e);let t=this.__toolStack.length;for(;t--;){const s=this.__toolStack[t];if(s&&1==s.onVRControllerDoubleClicked(e))break;if(!e.propagating)break}}onVRPoseChanged(e){this.__prepareEvent(e);let t=this.__toolStack.length;for(;t--;){const s=this.__toolStack[t];if(s&&1==s.onVRPoseChanged(e))break;if(!e.propagating)break}}destroy(){const e=this.appData.renderer.getViewport();e.mouseDown.disconnectId(this.mouseDownId),e.mouseMove.disconnectId(this.mouseMoveId),e.mouseUp.disconnectId(this.mouseUpId),e.mouseLeave.disconnectId(this.mouseUpId),e.mouseWheel.disconnectId(this.mouseWheelId),e.keyDown.disconnectId(this.keyDownId),e.keyUp.disconnectId(this.keyUpId),e.keyPressed.disconnectId(this.keyPressedId),e.touchStart.disconnectId(this.touchStartId),e.touchMove.disconnectId(this.touchMoveId),e.touchEnd.disconnectId(this.touchEndId),e.touchCancel.disconnectId(this.touchCancelId),this.appData.renderer.getXRViewport().then(t=>{e.controllerDown.disconnectId(this.controllerDownId),e.controllerUp.disconnectId(this.controllerUpId),e.viewChanged.disconnectId(this.onVRPoseChangedId);});}},exports.TopMenuBar=class{constructor(e,t,s){this.appData=t;const i=document.createElement("div");if(i.className="HeaderWrapper pa0 bb",e.appendChild(i),s||(this.logo=document.createElement("img"),this.logo.className="Header__logo pl2",this.logo.src="./img/logo.png",i.appendChild(this.logo)),this.topMenuItems=document.createElement("div"),this.topMenuItems.id="TopMenuWrapper",this.topMenuItems.className="pure-menu pure-menu-horizontal ml3",i.appendChild(this.topMenuItems),!s&&t.currentUser){const e=document.createElement("div");i.appendChild(e),this.currentUserChip=new L(e,this.appData.currentUser);}this.__existingItems={},this.__hotkeysToActions={},this._buildTopBar(),this._addKeyListener();}_buildTopBar(){this.topMenuItems.innerHTML="";const e=this._addUlTo(this.topMenuItems,"pure-menu-list");this.appData.actionRegistry.getActions().forEach(t=>{this._addMenuItem(e,t);}),this.appData.actionRegistry.actionAdded.connect(t=>{this._addMenuItem(e,t);});}_addMenuItem(e,t){let s=e;for(let e=0;e<t.path.length;e++){const i=t.path[e];if(!this.__existingItems[i]){const e=this._addLiTo(s,"pure-menu-item");e.classList.add("pure-menu-has-children","pure-menu-allow-hover"),this._addATo(e,"pure-menu-link",i);const t=this._addUlTo(e,"pure-menu-children shadow-3");this.__existingItems[i]=t;}s=this.__existingItems[i];}const i=this._addATo(s,"pure-menu-link",null,t.callback);if(this._addSpanTo(i,"ActionTitle",t.name),this._addSpanTo(i,"ActionShortcut",this._keyComboAsText(t)),t.key||t.metaKeys){const e=t.metaKeys||{},s=(this._comboFragment(e.alt,"A")+this._comboFragment(e.control,"C")+this._comboFragment(e.shift,"S")+(t.key||"")).toLowerCase();this.__hotkeysToActions[s]=t;}t.callback&&i.addEventListener("click",e=>{e.preventDefault(),t.callback.call(t);}),t.activatedChanged&&t.activatedChanged.connect(e=>{i.className=e?"pure-menu-link ActionedMenu":"pure-menu-link";});}_addKeyListener(){let e;document.addEventListener("keypress",e=>{}),document.addEventListener("keydown",t=>{if(e)return;if(t.target instanceof HTMLInputElement)return;const s=(this._comboFragment(t.altKey,"A")+this._comboFragment(t.metaKey||t.ctrlKey,"C")+this._comboFragment(t.shiftKey,"S")+("Alt"!=t.key&&"Ctrl"!=t.key?t.key:"")).toLowerCase();if(s in this.__hotkeysToActions){this.__hotkeysToActions[s].callback(event),e=s,event.preventDefault();}}),document.addEventListener("keyup",t=>{if(e&&e in this.__hotkeysToActions){const t=this.__hotkeysToActions[e];t.hotkeyReleaseCallback&&(t.hotkeyReleaseCallback(event),event.preventDefault()),e=void 0;}});}_addSpanTo(e,t,s){const i=document.createElement("span");return i.className=t,s&&(i.innerHTML=s),e.appendChild(i),i}_addATo(e,t,s){const i=document.createElement("a");return i.href="#",i.className=t,s&&(i.innerHTML=s),e.appendChild(i),i}_addUlTo(e,t,s){const i=document.createElement("ul");return i.className=t,s&&(i.innerHTML=s),e.appendChild(i),i}_addLiTo(e,t,s){const i=document.createElement("li");return i.className=t,s&&(i.innerHTML=s),e.appendChild(i),i}_comboFragment(e,t){return e?t+"+":""}_keyComboAsText(e){const{metaKeys:t,key:s}=e;return s||t?t?(t.shift?this._comboFragment(t.shift,"Shift"):"")+(t.alt?this._comboFragment(t.alt,"Alt"):"")+(t.control?this._comboFragment(t.control,"Ctrl"):"")+s:s:""}},exports.TreeItemAddChange=y,exports.TreeItemMoveChange=M,exports.TreeItemView=me,exports.TreeItemsRemoveChange=S,exports.UndoRedoManager=o,exports.UserChip=L,exports.VIEW_TOOL_MODELS=U,exports.VRHoldObjectsTool=class extends O{constructor(e){super(e),this.__pressedButtonCount=0,this.__freeIndices=[],this.__vrControllers=[],this.__heldObjectCount=0,this.__heldGeomItems=[],this.__heldGeomItemIds=[],this.__heldGeomItemRefs=[],this.__heldGeomItemOffsets=[];}activateTool(){super.activateTool(),console.log("activateTool.VRHoldObjectsTool"),this.appData.renderer.getDiv().style.cursor="crosshair";const t=t=>{if(!this.__activated)return;const s=new e.Cross(.03),i=new e.Material("Cross","FlatSurfaceShader");i.getParameter("BaseColor").setValue(new e.Color("#03E3AC")),i.visibleInGeomDataBuffer=!1;const n=new e.GeomItem("HandleToolTip",s,i);t.getTipItem().removeAllChildren(),t.getTipItem().addChild(n,!1);};this.appData.renderer.getXRViewport().then(e=>{for(const s of e.getControllers())t(s);this.addIconToControllerId=e.controllerAdded.connect(t);});}deactivateTool(){super.deactivateTool(),this.appData.renderer.getXRViewport().then(e=>{e.controllerAdded.disconnectId(this.addIconToControllerId);});}computeGrabXfo(t){let s;if(1==t.length)s=this.__vrControllers[t[0]].getTipXfo();else if(2==t.length){const i=this.__vrControllers[t[0]].getTipXfo(),n=this.__vrControllers[t[1]].getTipXfo();i.ori.alignWith(n.ori),s=new e.Xfo,s.tr=i.tr.lerp(n.tr,.5),s.ori=i.ori.lerp(n.ori,.5);let o=n.tr.subtract(i.tr);o.normalizeInPlace();const a=s.ori.getXaxis();o.dot(a)<0&&(o=o.negate());const r=o.angleTo(a);if(r>0){const t=a.cross(o);t.normalizeInPlace();const i=new e.Quat;i.setFromAxisAndAngle(t,r),s.ori=i.multiply(s.ori);}}return s}initAction(){for(let e=0;e<this.__heldGeomItems.length;e++){const t=this.__heldGeomItems[e];if(!t)continue;const s=this.computeGrabXfo(this.__heldGeomItemRefs[e]);this.__heldGeomItemOffsets[e]=s.inverse().multiply(t.getGlobalXfo());}}onVRControllerButtonDown(e){const t=e.controller.getId();this.__vrControllers[t]=e.controller;const s=e.controller.getGeomItemAtTip();if(s){if(s.geomItem.getOwner()instanceof r)return !1;if(e.intersectionData=s,s.geomItem.onMouseDown(e,s),!e.propagating)return !1;let i=this.__heldGeomItems.indexOf(s.geomItem);if(-1==i){i=this.__heldGeomItems.length,this.__heldObjectCount++,this.__heldGeomItems.push(s.geomItem),this.__heldGeomItemRefs[i]=[t],this.__heldGeomItemIds[t]=i;const e={newItem:s.geomItem,newItemId:i};this.change?this.change.update(e):(this.change=new q(e),this.appData.undoRedoManager.addChange(this.change));}else this.__heldGeomItemIds[t]=i,this.__heldGeomItemRefs[i].push(t);return this.initAction(),!0}}onVRControllerButtonUp(e){const t=e.controller.getId();if(this.__pressedButtonCount--,void 0!==this.__heldGeomItemIds[t]){const e=this.__heldGeomItemIds[t],s=this.__heldGeomItemRefs[e];return s.splice(s.indexOf(t),1),0==s.length&&(this.__heldObjectCount--,this.__heldGeomItems[e]=void 0,this.change=void 0),this.__heldGeomItemIds[t]=void 0,this.initAction(),!0}}onVRPoseChanged(e){if(!this.change)return !1;const t=[],s=[];for(let e=0;e<this.__heldGeomItems.length;e++){if(!this.__heldGeomItems[e])continue;const i=this.computeGrabXfo(this.__heldGeomItemRefs[e]);t.push(i.multiply(this.__heldGeomItemOffsets[e])),s.push(e);}return this.change.update({changeXfos:t,changeXfoIds:s}),!0}},exports.VRUITool=class extends O{constructor(t){super(t),this.__vrUIDOMHolderElement=document.createElement("div"),this.__vrUIDOMHolderElement.className="vrUIHolder",this.__vrUIDOMElement=document.createElement("div"),this.__vrUIDOMElement.className="vrUI",document.body.appendChild(this.__vrUIDOMHolderElement),this.controllerUI=new Q(t,this.__vrUIDOMHolderElement,this.__vrUIDOMElement),this.controllerUI.addRef(this),t.renderer.addTreeItem(this.controllerUI),this.__uiLocalXfo=new e.Xfo,this.__uiLocalXfo.ori.setFromAxisAndAngle(new e.Vec3(1,0,0),-.6*Math.PI);const s=new e.Material("pointermat","LinesShader");s.visibleInGeomDataBuffer=!1,s.getParameter("Color").setValue(new e.Color(1.2,0,0));const i=new e.Lines;i.setNumVertices(2),i.setNumSegments(1),i.setSegment(0,0,1),i.getVertex(0).set(0,0,0),i.getVertex(1).set(0,0,-1),i.setBoundingBoxDirty(),this.__pointerLocalXfo=new e.Xfo,this.__pointerLocalXfo.sc.set(1,1,.1),this.__pointerLocalXfo.ori.setFromAxisAndAngle(new e.Vec3(1,0,0),-.2*Math.PI),this.__uiPointerItem=new e.GeomItem("VRControllerPointer",i,s),this.__uiPointerItem.addRef(this),this.__triggerHeld=!1;}getName(){return "VRUITool"}setUIControllers(e,t,s,i){this.openUITool=e,this.uiController=t,this.pointerController=s;const n=this.uiController.getTreeItem().getGlobalXfo();if(this.pointerController){const e=this.pointerController.getTreeItem().getGlobalXfo(),t=n.tr.subtract(i.tr),s=e.tr.subtract(i.tr);t.cross(s).dot(i.ori.getYaxis())>0?this.__uiLocalXfo.tr.set(.05,-.05,.08):this.__uiLocalXfo.tr.set(-.05,-.05,.08);}else this.__uiLocalXfo.tr.set(0,-.05,.08);this.controllerUI.setLocalXfo(this.__uiLocalXfo);}activateTool(){super.activateTool(),this.controllerUI.activate(),this.uiController&&(this.uiController.getTipItem().addChild(this.controllerUI,!1),this.pointerController&&this.pointerController.getTipItem().addChild(this.__uiPointerItem,!1),this.appData.session.pub("pose-message",{interfaceType:"VR",showUIPanel:{controllerId:this.uiController.getId(),localXfo:this.__uiLocalXfo.toJSON(),size:this.controllerUI.getGeomOffsetXfo().sc.toJSON()}}));}deactivateTool(){super.deactivateTool(),this.controllerUI.deactivate(),this.uiController&&(this.uiController.getTipItem().removeChildByHandle(this.controllerUI),this.pointerController&&this.pointerController.getTipItem().removeChildByHandle(this.__uiPointerItem),this.appData.session.pub("pose-message",{interfaceType:"VR",hideUIPanel:{controllerId:this.uiController.getId()}}));}setPointerLength(e){this.__pointerLocalXfo.sc.set(1,1,e),this.__uiPointerItem.setLocalXfo(this.__pointerLocalXfo);}calcUIIntersection(){const t=this.__uiPointerItem.getGlobalXfo(),s=t.ori.getZaxis().negate(),i=new e.Ray(t.tr,s),n=this.controllerUI.getGlobalXfo(),o=this.controllerUI.getGeomOffsetXfo().sc,a=new e.Ray(n.tr,n.ori.getZaxis().negate()),r=i.intersectRayPlane(a);if(r<=0)return void this.setPointerLength(.5);const l=t.tr.add(s.scale(r)).subtract(a.start),h=l.dot(n.ori.getXaxis())/o.x,c=l.dot(n.ori.getYaxis())/o.y;if(Math.abs(h)>.5||Math.abs(c)>.5)return void this.setPointerLength(.5);this.setPointerLength(r);const d=this.__vrUIDOMElement.getBoundingClientRect();return {clientX:Math.round(h*d.width+d.width/2),clientY:Math.round(c*-d.height+d.height/2)}}sendEventToUI(e,t){const s=this.calcUIIntersection();if(s){s.offsetX=s.pageX=s.pageX=s.screenX=s.clientX,s.offsetY=s.pageY=s.pageY=s.screenY=s.clientY;const i=document.elementFromPoint(s.clientX,s.clientY);return i!=this._element&&(this._element&&this.controllerUI.sendMouseEvent("mouseleave",Object.assign(t,s),this._element),this._element=i,this.controllerUI.sendMouseEvent("mouseenter",Object.assign(t,s),this._element)),this.controllerUI.sendMouseEvent(e,Object.assign(t,s),this._element),this._element}this._element&&(this.controllerUI.sendMouseEvent("mouseleave",Object.assign(t,s),this._element),this._element=null);}onVRControllerButtonDown(e){if(e.controller==this.pointerController){this.__triggerHeld=!0;const t=this.sendEventToUI("mousedown",{button:e.button-1});this.__triggerDownElem=t||null;}return !0}onVRControllerButtonUp(e){if(e.controller==this.pointerController){this.__triggerHeld=!1;const t=this.sendEventToUI("mouseup",{button:e.button-1});t&&this.__triggerDownElem==t&&this.sendEventToUI("click",{button:e.button-1}),this.__triggerDownElem=null;}return !0}onVRPoseChanged(e){const t=e.viewXfo;return (()=>{const e=this.uiController.getTreeItem().getGlobalXfo(),s=e.tr.subtract(t.tr);return s.normalizeInPlace(),!(s.angleTo(e.ori.getYaxis())>.5*Math.PI)||(this.appData.toolManager.removeToolByHandle(this),!1)})()&&this.sendEventToUI("mousemove",{}),!0}},exports.ViewTool=class extends O{constructor(t,s=U.VIEWER){super(t),console.log("ViewTool:",s),this.__maipulationModel=s,this.__defaultMode="orbit",this.__mode=this.__defaultMode,this.__mouseDragDelta=new e.Vec2,this.__keyboardMovement=!1,this.__keysPressed=[],this.__maxVel=.002,this.__velocity=new e.Vec3,this.__ongoingTouches={},this.__orbitRateParam=this.addParameter(new e.NumberParameter("orbitRate",1)),this.__dollySpeedParam=this.addParameter(new e.NumberParameter("dollySpeed",.02)),this.__mouseWheelDollySpeedParam=this.addParameter(new e.NumberParameter("mouseWheelDollySpeed",.002)),this.__controllerTriggersHeld=[],this.movementFinished=new e.Signal;}activateTool(){super.activateTool(),console.log("activateTool.ViewTool"),this.appData.renderer.getDiv().style.cursor="default",this.appData.renderer.getXRViewport().then(t=>{this.vrControllerToolTip||(this.vrControllerToolTip=new e.Sphere(.015),this.vrControllerToolTipMat=new e.Material("Cross","FlatSurfaceShader"),this.vrControllerToolTipMat.getParameter("BaseColor").setValue(new e.Color("#03E3AC")),this.vrControllerToolTipMat.visibleInGeomDataBuffer=!1);const s=t=>{const s=new e.GeomItem("HandleToolTip",this.vrControllerToolTip,this.vrControllerToolTipMat);t.getTipItem().removeAllChildren(),t.getTipItem().addChild(s,!1);};for(const e of t.getControllers())s(e);this.addIconToControllerId=t.controllerAdded.connect(s);});}deactivateTool(){super.deactivateTool(),this.appData.renderer.getXRViewport().then(e=>{e.controllerAdded.disconnectId(this.addIconToControllerId);});}setDefaultMode(e){this.__defaultMode=e;}look(t,s){const i=s.getCamera().getFocalDistance(),n=this.__orbitRateParam.getValue()*e.SystemDesc.isMobileDevice?-1:1;if(this.__keyboardMovement){const e=s.getCamera().getGlobalXfo();this.__mouseDownCameraXfo=e.clone(),this.__mouseDownZaxis=e.ori.getZaxis();const t=this.__mouseDownZaxis.scale(-i);this.__mouseDownCameraTarget=e.tr.add(t);}const o=this.__mouseDownCameraXfo.clone(),a=new e.Quat;a.rotateZ(t.x/s.getWidth()*Math.PI*n),o.ori=a.multiply(o.ori);const r=new e.Quat;r.rotateX(t.y/s.getHeight()*Math.PI*n),o.ori.multiplyInPlace(r),s.getCamera().setGlobalXfo(o);}orbit(t,s){const i=s.getCamera().getFocalDistance(),n=this.__orbitRateParam.getValue()*e.SystemDesc.isMobileDevice?-1:1;if(this.__keyboardMovement){const e=s.getCamera().getGlobalXfo();this.__mouseDownCameraXfo=e.clone(),this.__mouseDownZaxis=e.ori.getZaxis();const t=this.__mouseDownZaxis.scale(-i);this.__mouseDownCameraTarget=e.tr.add(t);}const o=this.__mouseDownCameraXfo.clone(),a=new e.Quat;a.rotateZ(t.x/s.getWidth()*2*Math.PI*-n),o.ori=a.multiply(o.ori);const r=new e.Quat;r.rotateX(t.y/s.getHeight()*Math.PI*-n),o.ori.multiplyInPlace(r),o.tr=this.__mouseDownCameraTarget.add(o.ori.getZaxis().scale(i)),s.getCamera().setGlobalXfo(o);}pan(t,s){const i=s.getCamera().getFocalDistance(),n=s.getCamera().getFov(),o=new e.Vec3(1,0,0),a=new e.Vec3(0,1,0),r=2*i*Math.tan(.5*n),l=r*(s.getWidth()/s.getHeight()),h=new e.Xfo;h.tr=o.scale(-t.x/s.getWidth()*l),h.tr.addInPlace(a.scale(t.y/s.getHeight()*r)),s.getCamera().setGlobalXfo(this.__mouseDownCameraXfo.multiply(h));}dolly(t,s){const i=t.x*this.__dollySpeedParam.getValue(),n=new e.Xfo;n.tr.set(0,0,i),s.getCamera().setGlobalXfo(this.__mouseDownCameraXfo.multiply(n));}panAndZoom(t,s,i){const n=i.getCamera().getFocalDistance(),o=i.getCamera().getFov(),a=new e.Vec3(1,0,0),r=new e.Vec3(0,1,0),l=2*n*Math.tan(.5*o),h=l*(i.getWidth()/i.getHeight()),c=new e.Xfo;c.tr=a.scale(-t.x/i.getWidth()*h),c.tr.addInPlace(r.scale(t.y/i.getHeight()*l));const d=s*n;i.getCamera().setFocalDistance(this.__mouseDownFocalDist+d),c.tr.z+=d,i.getCamera().setGlobalXfo(this.__mouseDownCameraXfo.multiply(c));}initDrag(e){const t=e.getCamera().getFocalDistance();this.__mouseDragDelta.set(0,0),this.__mouseDownCameraXfo=e.getCamera().getGlobalXfo().clone(),this.__mouseDownZaxis=e.getCamera().getGlobalXfo().ori.getZaxis();const s=this.__mouseDownZaxis.scale(-t);this.__mouseDownCameraTarget=e.getCamera().getGlobalXfo().tr.add(s),this.__mouseDownFocalDist=t;}aimFocus(t,s){this.__focusIntervalId&&clearInterval(this.__focusIntervalId);let i=0;const n=()=>{const o=t.getGlobalXfo(),a=t.getFocalDistance(),r=s.subtract(o.tr),l=r.normalizeInPlace(),h=new e.Quat,c=new e.Quat;{const e=o.ori.getZaxis().clone();e.z=0;const t=r.negate();t.z=0,h.setFrom2Vectors(e,t);}{const e=o.ori.getZaxis().clone(),t=r.negate();e.x=t.x,e.y=t.y,e.normalizeInPlace(),e.cross(t).dot(o.ori.getXaxis())>0?c.rotateX(e.angleTo(t)):c.rotateX(-e.angleTo(t));}const d=o.clone();d.ori=h.multiply(d.ori),d.ori.multiplyInPlace(c);const m=Math.pow(i/20,2),u=o.clone();u.ori=o.ori.lerp(d.ori,m),t.setFocalDistance(a+(l-a)*m),t.setGlobalXfo(u),i++,i<=20?this.__focusIntervalId=setTimeout(n,20):(this.__focusIntervalId=void 0,this.movementFinished.emit());};n(),this.__manipulationState="focussing";}onMouseMove(e){}onDragStart(e){this.__mouseDownPos=e.mousePos,this.initDrag(e.viewport),2==e.button?this.__mode="pan":e.ctrlKey&&2==e.button?this.__mode="dolly":e.shiftKey||2==e.button?this.__mode="look":this.__mode=this.__defaultMode;}onDrag(e){switch(this.__keyboardMovement?this.__mouseDragDelta=e.mousePos:this.__mouseDragDelta=e.mousePos.subtract(this.__mouseDownPos),this.__mode){case"orbit":this.orbit(this.__mouseDragDelta,e.viewport);break;case"look":this.look(this.__mouseDragDelta,e.viewport);break;case"pan":this.pan(this.__mouseDragDelta,e.viewport);break;case"dolly":this.dolly(this.__mouseDragDelta,e.viewport);}}onDragEnd(e){return this.movementFinished.emit(),!1}onMouseDown(e){return !(this.__maipulationModel==U.DCC&&!e.altKey)&&(this.dragging=!0,this.__mouseDownPos=e.mousePos,this.onDragStart(e),!0)}onMouseUp(e){if(this.dragging)return this.onDragEnd(e),this.dragging=!1,!0}onMouseMove(e){if(this.dragging)return this.onDrag(e),e.showPointerOnAvatar=!1,!0}onDoubleClick(e){if(e.intersectionData){const t=e.viewport.getCamera(),s=t.getGlobalXfo().tr.add(e.intersectionData.mouseRay.dir.scale(e.intersectionData.dist));this.aimFocus(t,s);}}onWheel(e){if(this.__maipulationModel==U.DCC&&!e.altKey)return !1;const t=e.viewport,s=t.getCamera().getGlobalXfo(),i=s.ori.getZaxis();this.__mouseWheelZoomIntervalId&&clearInterval(this.__mouseWheelZoomIntervalId);let n=0;const o=()=>{const a=t.getCamera().getFocalDistance(),r=this.__mouseWheelDollySpeedParam.getValue(),l=e.deltaY*r*a*.2;s.tr.addInPlace(i.scale(l)),"orbit"==this.__defaultMode&&t.getCamera().setFocalDistance(a+l),t.getCamera().setGlobalXfo(s),n++,n<5?this.__mouseWheelZoomIntervalId=setTimeout(o,20):(this.__mouseWheelZoomIntervalId=void 0,this.movementFinished.emit(),e.viewport.renderGeomDataFbo());};o();}__integrateVelocityChange(t,s){const i=new e.Xfo;i.tr=this.__velocity.normalize().scale(this.__maxVel),s.getCamera().setGlobalXfo(s.getCamera().getGlobalXfo().multiply(i));}onKeyPressed(e,t){return !1}onKeyDown(e,t){}onKeyUp(e,t){return !0}__startTouch(t,s){this.__ongoingTouches[t.identifier]={identifier:t.identifier,pos:new e.Vec2(t.pageX,t.pageY)};}__endTouch(e,t){delete this.__ongoingTouches[e.identifier];}onTouchStart(e){e.preventDefault(),e.stopPropagation(),0==Object.keys(this.__ongoingTouches).length&&(this.__manipMode=void 0);const t=e.changedTouches;for(let e=0;e<t.length;e++)this.__startTouch(t[e]);return this.initDrag(e.viewport),!0}onTouchMove(t){t.preventDefault(),t.stopPropagation();const s=t.changedTouches;if(1==s.length&&"panAndZoom"!=this.__manipMode){const i=s[0],n=new e.Vec2(i.pageX,i.pageY),o=this.__ongoingTouches[i.identifier].pos.subtract(n);return "look"==this.__defaultMode?(o.scaleInPlace(6),this.look(o,t.viewport)):this.orbit(o,t.viewport),this.__manipMode="orbit",!0}if(2==s.length){const i=s[0],n=this.__ongoingTouches[i.identifier],o=s[1],a=this.__ongoingTouches[o.identifier],r=new e.Vec2(i.pageX,i.pageY),l=new e.Vec2(o.pageX,o.pageY),h=a.pos.subtract(n.pos).length()-l.subtract(r).length(),c=r.subtract(n.pos),d=l.subtract(a.pos),m=c.add(d);return m.scaleInPlace(.5),this.panAndZoom(m,.002*h,t.viewport),this.__manipMode="panAndZoom",!0}}onTouchEnd(e){e.preventDefault(),e.stopPropagation();const t=e.changedTouches;switch(this.__manipMode){case"orbit":case"panAndZoom":this.movementFinished.emit();}for(let e=0;e<t.length;e++)this.__endTouch(t[e]);return 0==Object.keys(this.__ongoingTouches).length&&(this.__manipMode=void 0),!0}onTouchCancel(e){console.log("touchcancel.");const t=e.changedTouches;for(let e=0;e<t.length;e++)this.__endTouch(t[e]);return !0}onDoubleTap(e){const t=e.changedTouches;for(let e=0;e<t.length;e++)this.__startTouch(t[e]);if(e.intersectionData){const t=e.viewport.getCamera(),s=t.getGlobalXfo().tr.add(e.intersectionData.mouseRay.dir.scale(e.intersectionData.dist));this.aimFocus(t,s);}}__initMoveStage(e){if(1==this.__controllerTriggersHeld.length)this.__grabPos=this.__controllerTriggersHeld[0].getControllerTipStageLocalXfo().tr.clone(),this.stageXfo__GrabStart=e.getXfo().clone(),this.__invOri=this.stageXfo__GrabStart.ori.inverse();else if(2==this.__controllerTriggersHeld.length){const t=this.__controllerTriggersHeld[0].getControllerTipStageLocalXfo().tr,s=this.__controllerTriggersHeld[1].getControllerTipStageLocalXfo().tr;this.__grabDir=s.subtract(t),this.__grabPos=t.lerp(s,.5),this.__grabDir.y=0,this.__grabDist=this.__grabDir.length(),this.__grabDir.scaleInPlace(1/this.__grabDist),this.stageXfo__GrabStart=e.getXfo().clone(),this.__grab_to_stage=this.__grabPos.subtract(this.stageXfo__GrabStart.tr);}}onVRControllerButtonDown(e){if(1==e.button)return this.__controllerTriggersHeld.push(e.controller),this.__initMoveStage(e.vrviewport),!0}onVRControllerButtonUp(e){if(1!=e.button)return;const t=this.__controllerTriggersHeld.indexOf(e.controller);return this.__controllerTriggersHeld.splice(t,1),this.__initMoveStage(e.vrviewport),!0}onVRControllerDoubleClicked(e){console.log("onVRControllerDoubleClicked:",this.__controllerTriggersHeld.length);const t=e.vrviewport.getXfo().clone();t.sc.set(1,1,1),e.vrviewport.setXfo(t);}onVRPoseChanged(t){if(1==this.__controllerTriggersHeld.length){const s=this.__controllerTriggersHeld[0].getControllerTipStageLocalXfo().tr,i=new e.Xfo;i.tr=this.__grabPos.subtract(s);const n=this.stageXfo__GrabStart.multiply(i);return t.vrviewport.setXfo(n),!0}if(2==this.__controllerTriggersHeld.length){const s=this.__controllerTriggersHeld[0].getControllerTipStageLocalXfo().tr,i=this.__controllerTriggersHeld[1].getControllerTipStageLocalXfo().tr,n=s.lerp(i,.5),o=i.subtract(s);o.y=0;const a=o.length();o.scaleInPlace(1/a);const r=new e.Xfo,l=Math.max(Math.min(this.__grabDist/a,10),.1);r.sc.set(l,l,l);let h=this.__grabDir.angleTo(o);this.__grabDir.cross(o).y>0&&(h=-h),r.ori.rotateY(h);const c=r.ori.rotateVec3(this.__grabPos);r.tr.addInPlace(this.__grabPos.subtract(c));const d=this.__grabPos.scale(1-l);r.tr.addInPlace(r.ori.rotateVec3(d));const m=this.__grabPos.subtract(n).scale(l);r.tr.addInPlace(r.ori.rotateVec3(m));const u=this.stageXfo__GrabStart.multiply(r);return t.vrviewport.setXfo(u),!0}}},exports.uxFactory=V;
});

const zeaTreeItemElementCss = ":host{display:block;font-size:14px}:host,input,button,select,textarea{font-family:'Roboto', sans-serif}.wrap{opacity:0.7;cursor:default;user-select:none}.wrap.visible{opacity:1}.header{display:flex;align-items:center;margin:4px 0;position:relative;left:-7px}.arrow{display:flex;justify-content:center;align-items:center;cursor:pointer;padding:2px}.label{white-space:nowrap}.toggle{display:flex;justify-content:center;align-items:center;font-size:1.2em;margin:0 1px 0 4px}.children{padding-left:19px;border-left:1px dotted gray}zea-tree-item-element{margin-left:16px}zea-tree-item-element.has-children{margin-left:0}.zea-tree-item-label{padding:3px 5px;border-radius:4px;border:1px solid transparent;margin-left:22px;white-space:nowrap}.is-tree-item .zea-tree-item-label{margin-left:0}.highlighted .zea-tree-item-label{background-color:var(\n    --treeview-highlight-bg-color,\n    var(--color-secondary-3)\n  );border:1px solid var(--treeview-highlight-color, var(--color-secondary-1))}.selected .zea-tree-item-label{background-color:var(--treeview-highlight-color, var(--color-secondary-1));border:1px solid var(--treeview-highlight-color, var(--color-secondary-1))}";

const ZeaTreeItemElement = class {
  constructor(hostRef) {
    index$1.registerInstance(this, hostRef);
    this.label = 'Loading...';
    this.isRoot = false;
    this.isTreeItem = false;
    this.isSelected = false;
    this.isVisible = false;
    this.isHighlighted = false;
    this.isExpanded = false;
    this.childItems = [];
  }
  /**
   * Placeholder comment
   */
  treeItemChanged() {
    if (this.treeItem) {
      this.initTreeItem();
    }
  }
  /**
   * Placeholder comment
   */
  componentWillLoad() {
    if (this.treeItem) {
      this.initTreeItem();
      this.updateSelected();
      this.updateVisibility();
      this.updateHighlight();
      if (this.childItems.length)
        this.rootElement.classList.add('has-children');
      else
        this.rootElement.classList.remove('has-children');
      this.treeItem.titleElement = this.rootElement;
    }
  }
  /**
   * Placeholder comment
   */
  initTreeItem() {
    // Name
    this.label = this.treeItem.getName();
    this.nameChangedId = this.treeItem.on('nameChanged', () => {
      this.label = this.treeItem.getName();
    });
    // Selection
    this.updateSelectedId = this.treeItem.on('selectedChanged', this.updateSelected.bind(this));
    if (typeof this.treeItem.getChildren === 'function') {
      this.isTreeItem = true;
      this.childItems = [...this.treeItem.getChildren()];
      this.childAddedId = this.treeItem.on('childAdded', () => {
        this.childItems = [...this.treeItem.getChildren()];
      });
      this.childRemovedId = this.treeItem.on('childRemoved', () => {
        this.childItems = [...this.treeItem.getChildren()];
      });
      // Visibility
      this.updateVisibilityId = this.treeItem.on('visibilityChanged', this.updateVisibility.bind(this));
    }
    else {
      this.isTreeItem = false;
      this.isVisible = true;
    }
    // Highlights
    this.updateHighlightId = this.treeItem.on('highlightChanged', this.updateHighlight.bind(this));
  }
  /**
   * Placeholder comment
   */
  updateSelected() {
    if (this.treeItem && 'isSelected' in this.treeItem)
      this.isSelected = this.treeItem.isSelected();
  }
  /**
   * Placeholder comment
   */
  updateVisibility() {
    if (this.treeItem && 'isVisible' in this.treeItem) {
      this.isVisible = this.treeItem.isVisible();
    }
  }
  /**
   * Placeholder comment
   */
  updateHighlight() {
    var _a, _b;
    if (this.treeItem && 'isHighlighted' in this.treeItem) {
      this.isHighlighted = this.treeItem.isHighlighted();
      if (this.isHighlighted && 'getHighlight' in this.treeItem) {
        const highlightColor = this.treeItem.getHighlight();
        const bgColor = highlightColor.lerp(new zeaEngine_cjs.Color(0.75, 0.75, 0.75, 0), 0.5);
        console.log('this.itemContainer', this.itemContainer);
        (_a = this.itemContainer) === null || _a === void 0 ? void 0 : _a.style.setProperty('--treeview-highlight-bg-color', `${bgColor.toHex()}60` // add transparency
        );
        (_b = this.itemContainer) === null || _b === void 0 ? void 0 : _b.style.setProperty('--treeview-highlight-color', highlightColor.toHex());
      }
    }
  }
  /**
   * Placeholder comment
   */
  toggleChildren() {
    this.isExpanded = !this.isExpanded;
  }
  /**
   * Placeholder comment
   */
  onVisibilityToggleClick() {
    const visibleParam = this.treeItem.getParameter('Visible');
    if (this.appData && this.appData.undoRedoManager) {
      const change = new zeaUx_cjs.ParameterValueChange(visibleParam, !visibleParam.getValue());
      this.appData.undoRedoManager.addChange(change);
    }
    else {
      visibleParam.setValue(!visibleParam.getValue());
    }
  }
  /**
   * Placeholder comment
   * @param {any} e The event object
   */
  onLabelClick(e) {
    if (!this.appData || !this.appData.selectionManager) {
      this.treeItem.setSelected(!this.treeItem.getSelected());
      return;
    }
    if (this.appData.selectionManager.pickingModeActive()) {
      this.appData.selectionManager.pick(this.treeItem);
      return;
    }
    this.appData.selectionManager.toggleItemSelection(this.treeItem, !e.ctrlKey);
  }
  /**
   * Main render method for the component
   * @return {JSX} The generated markup
   */
  render() {
    return (index$1.h("div", { class: {
        wrap: true,
        'has-children': this.childItems.length,
        selected: this.isSelected,
        visible: this.isVisible,
        highlighted: this.isHighlighted,
        'is-tree-item': this.isTreeItem,
      }, style: { display: 'block' }, ref: (el) => (this.itemContainer = el) }, index$1.h("div", { class: "header" }, index$1.h("div", { class: "arrow", style: { display: this.childItems.length > 0 ? 'block' : 'none' }, onClick: () => this.toggleChildren() }, index$1.h("span", null, this.isExpanded ? (index$1.h("zea-icon", { name: "caret-down", size: 12 })) : (index$1.h("zea-icon", { name: "caret-forward", size: 12 })))), this.isTreeItem && (index$1.h("div", { class: "toggle", onClick: this.onVisibilityToggleClick.bind(this) }, index$1.h("zea-icon", { name: this.isVisible ? 'eye-outline' : 'eye-off-outline', ref: (el) => (this.visibilityIcon = el), size: 16 }))), index$1.h("div", { class: "zea-tree-item-label", onClick: this.onLabelClick.bind(this) }, this.label)), this.isTreeItem && (index$1.h("div", { class: "children", style: { display: this.isExpanded ? 'block' : 'none' } }, this.isExpanded &&
      this.childItems.map((child) => (index$1.h("zea-tree-item-element", { treeItem: child, appData: this.appData })))))));
  }
  get rootElement() { return index$1.getElement(this); }
  static get watchers() { return {
    "treeItem": ["treeItemChanged"]
  }; }
};
ZeaTreeItemElement.style = zeaTreeItemElementCss;

exports.zea_tree_item_element = ZeaTreeItemElement;
