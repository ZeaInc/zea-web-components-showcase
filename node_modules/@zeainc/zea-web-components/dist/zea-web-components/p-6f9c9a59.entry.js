import{r as t,h as i,a as s}from"./p-6fd09c7c.js";import{c as e}from"./p-443ca7c1.js";var n=e((function(t,i){function s(t,i){if(!s.watchedElementData){s.watchedElementData=[];const t=function(){s.watchedElementData.forEach((function(t){t.element.offsetWidth===t.offsetWidth&&t.element.offsetHeight===t.offsetHeight||(t.offsetWidth=t.element.offsetWidth,t.offsetHeight=t.element.offsetHeight,t.callback())}))};window.addEventListener("resize",t),new MutationObserver(t).observe(document.body,{attributes:!0,childList:!0,characterData:!0,subtree:!0})}s.watchedElementData.push({element:t,offsetWidth:t.offsetWidth,offsetHeight:t.offsetHeight,callback:i})}Object.defineProperty(i,"__esModule",{value:!0});const e=function(){const t=null!=(navigator.userAgent.match(/Android/i)||navigator.userAgent.match(/webOS/i)||navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/BlackBerry/i)||navigator.userAgent.match(/Pixel/i)||navigator.userAgent.match(/Windows Phone/i)),i=function(){const t=navigator.userAgent;let i,s,e,n=navigator.appName,l=""+parseFloat(navigator.appVersion),h=parseInt(navigator.appVersion,10);return-1!=(s=t.indexOf("Opera"))?(n="Opera",l=t.substring(s+6),-1!=(s=t.indexOf("Version"))&&(l=t.substring(s+8))):-1!=(s=t.indexOf("MSIE"))?(n="Microsoft Internet Explorer",l=t.substring(s+5)):-1!=(s=t.indexOf("Edge"))?(n="Edge",l=t.substring(s+4)):-1!=(s=t.indexOf("Chrome"))?(n="Chrome",l=t.substring(s+7)):-1!=(s=t.indexOf("Safari"))?(n="Safari",l=t.substring(s+7),-1!=(s=t.indexOf("Version"))&&(l=t.substring(s+8))):-1!=(s=t.indexOf("Firefox"))?(n="Firefox",l=t.substring(s+8)):(i=t.lastIndexOf(" ")+1)<(s=t.lastIndexOf("/"))&&(n=t.substring(i,s),l=t.substring(s+1),n.toLowerCase()==n.toUpperCase()&&(n=navigator.appName)),-1!=(e=l.indexOf(";"))&&(l=l.substring(0,e)),-1!=(e=l.indexOf(" "))&&(l=l.substring(0,e)),h=parseInt(""+l,10),isNaN(h)&&(l=""+parseFloat(navigator.appVersion),h=parseInt(navigator.appVersion,10)),{browserName:n,fullVersion:l,majorVersion:h,appName:navigator.appName,userAgent:navigator.userAgent}}(),s=function(){let t,i;try{t=document.createElement("canvas").getContext("webgl")}catch(t){}if(!t)return;try{i=document.createElement("canvas").getContext("webgl2")}catch(t){}const s=t.getExtension("WEBGL_debug_renderer_info"),e=t.getParameter(s.UNMASKED_VENDOR_WEBGL),n=t.getParameter(s.UNMASKED_RENDERER_WEBGL),l=t.getParameter(t.MAX_TEXTURE_SIZE);let h;return n.match(/NVIDIA/i)?h="NVidia":n.match(/AMD/i)||n.match(/Radeon/i)?h="AMD":n.match(/Intel/i)?h="Intel":n.match(/Mali/i)?h="ARM":n.match(/Adreno/i)?h="Adreno":console.warn("Unable to determine GPU vendor:",n),{vendor:e,renderer:n,gpuVendor:h,maxTextureSize:l,supportsWebGL2:null!=i}}();let e="Low";if(s)if(t)e="Low";else{const t=s.renderer.replace(/[()]/g,"").split(" ");if("NVidia"==s.gpuVendor){const i=t.indexOf("GTX");if(-1!=i){const s=t[i+1];e=s.endsWith("M")?parseInt(s.substring(0,s.length-2))>=900?"Medium":"Low":parseInt(s)>=1030?"High":"Medium"}else e=-1!=t.indexOf("TITAN")||-1!=t.indexOf("Quadro")?"High":"Low"}else if("AMD"==s.gpuVendor){const i=t.indexOf("Radeon");if(-1!=i){const s=t.indexOf("RX");if(-1!=s)if("Vega"==t[s+1])e="High";else{const i=t[s+1];let n;i.endsWith("X")?(n=parseInt(i.substring(0,i.length-2)),e="High"):n=parseInt(i),e=n>=480?"High":"Medium"}else e="Pro"==t[i+1]?parseInt(t[s+1])>=450?"Medium":"Low":"Sky"==t[i+1]&&parseInt(t[s+1])>=700?"Medium":"Low"}else e=-1!=t.indexOf("FirePro")||-1!=t.indexOf("Quadro")?"High":"Low"}else("Adreno"==s.gpuVendor||"Intel"==s.gpuVendor)&&(e="Low")}return{isMobileDevice:t,isIOSDevice:null!=(navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPod/i)),browserName:i.browserName,fullVersion:i.fullVersion,majorVersion:i.majorVersion,appName:i.appName,userAgent:i.userAgent,webGLSupported:null!=s,gpuDesc:s,deviceCategory:e}}();var n=Object.freeze({__proto__:null,SystemDesc:e});const l=Math.PI/180;Math.HALF_PI=.5*Math.PI,Math.TWO_PI=2*Math.PI,Math.radToDeg=function(t){return t/l},Math.degToRad=function(t){return t*l},Number.isNumeric=t=>!isNaN(parseFloat(t))&&isFinite(t),String.prototype.replaceAll=function(t,i){return this.replace(new RegExp(t,"g"),i)};const h=function(t){let i,s,e,n=0;if(0===t.length)return n;for(i=0,e=t.length;i<e;i++)s=t.charCodeAt(i),n=(n<<5)-n+s,n|=0;return Math.abs(n)};function o(t,i=0,s=5){return JSON.stringify(t,(function(t,i){return i&&i.toFixed?Number(i.toFixed(s)):i}),i)}String.prototype.hash=function(){return h(this)},String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")},String.prototype.ltrim=function(){return this.replace(/^\s+/,"")},String.prototype.rtrim=function(){return this.replace(/\s+$/,"")},String.prototype.lpad=function(t,i){let s=this;for(;s.length<i;)s=t+s;return s},String.prototype.rpad=function(t,i){let s=this;for(;s.length<i;)s+=t;return s},Math.randomInt=function(t,i){return t=Math.ceil(t),i=Math.floor(i),Math.floor(Math.random()*(i-t))+t},Math.lerp=(t,i,s)=>t+s*(i-t),Math.clamp=function(t,i,s){return Math.min(Math.max(t,i),s)},Math.nearestPow2=function(t){return Math.pow(2,Math.round(Math.log(t)/Math.log(2)))},Math.nearestPow10=function(t){return Math.pow(10,Math.round(Math.log10(t)/Math.log10(10)))},Math.nextPow2=function(t){let i=0;for(;t>0;)i++,t>>=1;return 1<<i},Math.fract=function(t){return 0==t?0:t<0?t>-1?-t:-t%Math.floor(-t):t<1?t:t%Math.floor(t)},Math.remap=function(t,i,s,e,n){return e+(t-i)/(s-i)*(n-e)},Math.convertFloat32ArrayToUInt16Array=function(t){const i=new Uint16Array(t.length),s=new Int32Array(t.buffer),e=t=>{let i=t>>16&32768,s=t>>12&2047;const e=t>>23&255;return e<103?i:e>142?(i|=31744,i|=(255==e?0:1)&&8388607&t,i):e<113?(s|=2048,i|=(s>>114-e)+(s>>113-e&1),i):(i|=e-112<<10|s>>1,i+=1&s,i)};for(let n=0;n<t.length;n++)i[n]=e(s[n]);return i},Math.decode16BitFloatFrom2xUInt8=t=>{const i=t[0],s=(120&i)>>3;let e=0==s?0:2048;const n=e+((7&i)<<8)+t[1];return e=0==s?1:0,(128&i?1:-1)*n*Math.pow(2,s+e-16)},Math.encode16BitFloatInto2xUInt8=t=>{c||(c=new Uint8Array(2));const i=t>=0?128:0;t=Math.abs(t);let s,e=15,n=1024;for(let i=15;i>0;i--)t<n&&(n/=2,e--);s=0==e?t/n/2:(t-n)/n;const l=Math.round(2048*s),h=l/256,o=l-256*h;return c[0]=i+8*e+h,c[1]=o,t>=2048&&(c[0]=255),c},Math.encode16BitFloat=t=>{const i=new Float32Array(1);return i[0]=t,(t=>{let i=t>>16&32768,s=t>>12&2047;const e=t>>23&255;return e<103?i:e>142?(i|=31744,i|=(255==e?0:1)&&8388607&t,i):e<113?(s|=2048,i|=(s>>114-e)+(s>>113-e&1),i):(i|=e-112<<10|s>>1,i+=1&s,i)})(new Int32Array(i.buffer)[0])},Math.decode16BitFloat=t=>{const i=(32768&t)>>15,s=(31744&t)>>10,e=1023&t;return 0==s?(i?-1:1)*Math.pow(2,-14)*(e/Math.pow(2,10)):31==s?e?NaN:1/0*(i?-1:1):(i?-1:1)*Math.pow(2,s-15)*(1+e/Math.pow(2,10))},Math.smoothStep=(t,i,s)=>{const e=Math.clamp((s-t)/(i-t),0,1);return e*e*(3-2*e)},Math.linStep=(t,i,s)=>Math.clamp((s-t)/(i-t),0,1);class a{isValid(){for(const t of this.__data)if(t==1/0||isNaN(t))return!1;return!0}static createFromFloat32Buffer(t,i){throw new Error("Not yet implemented for this type:"+this.constructor.name)}static numElements(){throw new Error("Not yet implemented for this type:"+this.constructor.name)}asArray(){return this.__data}toString(){return o(this.toJSON())}}const r=new class{constructor(){this.__types={},this.__names={},this.registerType("SInt32",5),this.registerType("UInt32",4),this.registerType("Float32",6)}registerType(t,i){this.__types[t]=i,i.name?this.__names[i.name]=t:this.__names[i]=t}getType(t){return this.__types[t]}getTypeName(t){if(this.__names[t])return this.__names[t];if(this.__names[t.name])return this.__names[t.name];throw t}};class d extends a{constructor(t=0,i=0){super(),t instanceof Float32Array||t instanceof Uint32Array||t instanceof Int32Array?this.__data=t:t instanceof ArrayBuffer?this.__data=new Float32Array(t,i,2):null!=t&&"object"==typeof t?(this.__data=new Float32Array(2),this.fromJSON(t)):(this.__data=new Float32Array(2),this.__data[0]=t,this.__data[1]=i)}get x(){return this.__data[0]}set x(t){this.__data[0]=t}get y(){return this.__data[1]}set y(t){this.__data[1]=t}set(t,i){this.__data[0]=t,this.__data[1]=i}setFromOther(t){this.x=t.x,this.y=t.y}equal(t){return this.x==t.x&&this.y==t.y}notEquals(t){return this.x!=t.x&&this.y!=t.y}approxEqual(t,i=Number.EPSILON){return Math.abs(this.x-t.x)<i&&Math.abs(this.y-t.y)<i}add(t){return new d(this.x+t.x,this.y+t.y)}addInPlace(t){this.x+=t.x,this.y+=t.y}subtract(t){return new d(this.x-t.x,this.y-t.y)}subtractInPlace(t){return this.x-=t.x,this.y-=t.y,this}scale(t){return new d(this.x*t,this.y*t)}scaleInPlace(t){this.x*=t,this.y*=t}invert(){return new d(1/this.x,1/this.y)}invertInPlace(){return this.x=1/this.x,this.y=1/this.y,this}multiply(t){return new d(this.x*t.x,this.y*t.y)}multiplyInPlace(t){this.x*=t.x,this.y*=t.y}lengthSquared(){const t=this.__data[0],i=this.__data[1];return t*t+i*i}length(){return Math.sqrt(this.lengthSquared())}distanceTo(t){const i=this.__data[0]-t.x,s=this.__data[1]-t.y;return Math.sqrt(i*i+s*s)}normalize(){const t=this.__data[0],i=this.__data[1];let s=t*t+i*i;return s<Number.EPSILON?new d:(s=1/Math.sqrt(s),new d(t*s,i*s))}normalizeInPlace(){const t=this.__data[0],i=this.__data[1];let s=t*t+i*i;s<Number.EPSILON||(s=1/Math.sqrt(s),this.set(t*s,i*s))}dot(t){return this.x*t.x+this.y*t.y}cross(t){return this.x*t.y-this.y*t.x}angleTo(t){const i=this.normalize().dot(t.normalize());return i>1?0:i<-1?Math.PI:Math.acos(i)}signedAngleTo(t){const i=this.angleTo(t);return this.cross(t)<0?-i:i}rotate(t){const i=Math.cos(t),s=Math.sin(t);return new d(this.x*i-this.y*s,this.x*s+this.y*i)}lerp(t,i){const s=this.x,e=this.y;return new d(s+i*(t.x-s),e+i*(t.y-e))}setRandomDir(t=1){const i=2*Math.random()*Math.PI;return this.__data[0]=Math.cos(i)*zScale,this.__data[1]=Math.sin(i)*zScale,this}setRandom(t=1){return this.__data[0]=Math.random()*t,this.__data[1]=Math.random()*t,this}clone(){return new d(this.__data[0],this.__data[1])}asArray(){return this.__data}static create(...t){return new d(...t)}static createFromFloat32Buffer(t,i=0){return new d(t,4*i)}static createFromFloat32Array(t){return new d(t)}static numElements(){return 2}toJSON(){return{x:this.x,y:this.y}}fromJSON(t){this.x=t.x,this.y=t.y}}r.registerType("Vec2",d);class u extends a{constructor(t=0,i=0,s=0){super(),t instanceof Float32Array||t instanceof Uint32Array?this.__data=t:t instanceof ArrayBuffer?this.__data=new Float32Array(t,i,3):null!=t&&"object"==typeof t?(this.__data=new Float32Array(3),this.fromJSON(t)):(this.__data=new Float32Array(3),this.__data[0]=t,this.__data[1]=i,this.__data[2]=s)}get x(){return this.__data[0]}set x(t){this.__data[0]=t}get y(){return this.__data[1]}set y(t){this.__data[1]=t}get z(){return this.__data[2]}set z(t){this.__data[2]=t}get xy(){return new d(this.__data[0],this.__data[1])}get yz(){return new d(this.__data[1],this.__data[2])}set(t,i,s){this.x=t,this.y=void 0!==i?i:t,this.z=void 0!==s?s:t}setDataArray(t){this.__data=t}setFromOther(t){this.x=t.x,this.y=t.y,this.z=t.z}isNull(){return Math.abs(this.x)<Number.EPSILON&&Math.abs(this.y)<Number.EPSILON&&Math.abs(this.z)<Number.EPSILON}is111(){return Math.abs(1-this.x)<Number.EPSILON&&Math.abs(1-this.y)<Number.EPSILON&&Math.abs(1-this.z)<Number.EPSILON}equal(t){return this.x==t.x&&this.y==t.y&&this.z==t.z}notEquals(t){return this.x!=t.x&&this.y!=t.y&&this.z!=t.z}approxEqual(t,i=Number.EPSILON){return Math.abs(this.x-t.x)<i&&Math.abs(this.y-t.y)<i&&Math.abs(this.z-t.z)<i}add(t){return new u(this.x+t.x,this.y+t.y,this.z+t.z)}addInPlace(t){this.x+=t.x,this.y+=t.y,this.z+=t.z}subtract(t){return new u(this.x-t.x,this.y-t.y,this.z-t.z)}subtractInPlace(t){this.x-=t.x,this.y-=t.y,this.z-=t.z}multiply(t){return new u(this.x*t.x,this.y*t.y,this.z*t.z)}multiplyInPlace(t){this.x*=t.x,this.y*=t.y,this.z*=t.z}divide(t){return new u(this.x/t.x,this.y/t.y,this.z/t.z)}divideInPlace(t){this.x/=t.x,this.y/=t.y,this.z/=t.z}scale(t){return new u(this.x*t,this.y*t,this.z*t)}scaleInPlace(t){this.x*=t,this.y*=t,this.z*=t}negate(){return new u(-this.x,-this.y,-this.z)}inverse(){return new u(1/this.x,1/this.y,1/this.z)}lengthSquared(){const t=this.__data[0],i=this.__data[1],s=this.__data[2];return t*t+i*i+s*s}length(){return Math.sqrt(this.lengthSquared())}distanceTo(t){const i=this.__data[0]-t.x,s=this.__data[1]-t.y,e=this.__data[2]-t.z;return Math.sqrt(i*i+s*s+e*e)}normalize(){let t=this.__data[0]*this.__data[0]+this.__data[1]*this.__data[1]+this.__data[2]*this.__data[2];return t<Number.EPSILON?new u:(t=1/Math.sqrt(t),new u(this.__data[0]*t,this.__data[1]*t,this.__data[2]*t))}normalizeInPlace(){let t=this.__data[0]*this.__data[0]+this.__data[1]*this.__data[1]+this.__data[2]*this.__data[2];if(t<Number.EPSILON)return;t=Math.sqrt(t);const i=1/t;return this.__data[0]*=i,this.__data[1]*=i,this.__data[2]*=i,t}resize(t){const i=this.__data[0]*this.__data[0]+this.__data[1]*this.__data[1]+this.__data[2]*this.__data[2];if(i<Number.EPSILON)return;const s=t/Math.sqrt(i);return new u(this.__data[0]*s,this.__data[1]*s,this.__data[2]*s)}resizeInPlace(t){const i=this.__data[0]*this.__data[0]+this.__data[1]*this.__data[1]+this.__data[2]*this.__data[2];if(i<Number.EPSILON)return;const s=t/Math.sqrt(i);this.__data[0]*=s,this.__data[1]*=s,this.__data[2]*=s}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}cross(t){const i=this.x,s=this.y,e=this.z,n=t.x,l=t.y,h=t.z;return new u(s*h-e*l,e*n-i*h,i*l-s*n)}angleTo(t){const i=this.dot(t);return i>1?0:Math.acos(i)}lerp(t,i){const s=this.x,e=this.y,n=this.z;return new u(s+i*(t.x-s),e+i*(t.y-e),n+i*(t.z-n))}abs(){return new u(Math.abs(this.x),Math.abs(this.y),Math.abs(this.z))}setRandomDir(t=1){const i=2*Math.random()*Math.PI,s=2*Math.random()-1,e=Math.sqrt(1-s*s)*t;return this.__data[0]=Math.cos(i)*e,this.__data[1]=Math.sin(i)*e,this.__data[2]=s*t,this}setRandom(t=1){return this.__data[0]=(Math.random()-.5)*t,this.__data[1]=(Math.random()-.5)*t,this.__data[2]=(Math.random()-.5)*t,this}clone(){return new u(this.__data[0],this.__data[1],this.__data[2])}asArray(){return this.__data}static create(...t){return new u(...t)}static createFromJSON(t){const i=new u;return i.fromJSON(t),i}static createFromFloat32Buffer(t,i=0){return new u(t,4*i)}static createFromFloat32Array(t){return new u(t)}static numElements(){return 3}toJSON(){return{x:this.x,y:this.y,z:this.z}}fromJSON(t){this.x=t.x,this.y=t.y,this.z=t.z}}r.registerType("Vec3",u);class m extends a{constructor(t=0,i=0,s=0,e=0){super(),t instanceof ArrayBuffer?this.__data=new Float32Array(t,i,4):null!=t&&"object"==typeof t?(this.__data=new Float32Array(4),this.fromJSON(t)):(this.__data=new Float32Array(4),this.__data[0]=t,this.__data[1]=i,this.__data[2]=s,this.__data[3]=e)}get x(){return this.__data[0]}set x(t){this.__data[0]=t}get y(){return this.__data[1]}set y(t){this.__data[1]=t}get z(){return this.__data[2]}set z(t){this.__data[2]=t}get t(){return this.__data[3]}set t(t){this.__data[3]=t}get xyz(){return new u(this.__data[0],this.__data[1],this.__data[2])}set(t,i,s,e){this.x=t,this.y=i,this.z=s,this.t=e}setFromOther(t){this.x=t.x,this.y=t.y,this.z=t.z,this.t=t.t}equal(t){return this.x==t.x&&this.y==t.y&&this.z==t.z&&this.t==t.t}notEquals(t){return this.x!=t.x&&this.y!=t.y&&this.z!=t.z&&this.t!=t.t}approxEqual(t,i=Number.EPSILON){return Math.abs(this.x-t.x)<i&&Math.abs(this.y-t.y)<i&&Math.abs(this.z-t.z)<i&&Math.abs(this.t-t.t)<i}add(t){return new m(this.x+t.x,this.y+t.y,this.z+t.z,this.t+t.t)}addInPlace(t){this.x+=t.x,this.y+=t.y,this.z+=t.z,this.t+=t.t}subtract(t){return new m(this.x-t.x,this.y-t.y,this.z-t.z,this.t-t.t)}subtractInPlace(t){this.x-=t.x,this.y-=t.y,this.z-=t.z,this.t-=t.t}multiply(t){return new m(this.x*t.x,this.y*t.y,this.z*t.z,this.t*t.t)}multiplyInPlace(t){this.x*=t.x,this.y*=t.y,this.z*=t.z,this.t*=t.t}divide(t){return new m(this.x/t.x,this.y/t.y,this.z/t.z,this.t/t.t)}divideInPlace(t){this.x/=t.x,this.y/=t.y,this.z/=t.z,this.t/=t.t}scale(t){return new m(this.x*t,this.y*t,this.z*t,this.t*t)}scaleInPlace(t){this.set(this.x*t,this.y*t,this.z*t,this.t*t)}length(){const t=this.__data[0],i=this.__data[1],s=this.__data[2],e=this.__data[2];return Math.sqrt(t*t+i*i+s*s+e*e)}lengthSquared(){const t=this.__data[0],i=this.__data[1],s=this.__data[2],e=this.__data[3];return t*t+i*i+s*s+e*e}normalize(){const t=this.__data[0],i=this.__data[1],s=this.__data[2],e=this.__data[3];let n=t*t+i*i+s*s+e*e;return n<Number.EPSILON?new m:(n=1/Math.sqrt(n),new m(t*n,i*n,s*n))}normalizeInPlace(){const t=this.__data[0],i=this.__data[1],s=this.__data[2],e=this.__data[3];let n=t*t+i*i+s*s+e*e;n<Number.EPSILON||(n=1/Math.sqrt(n),this.set(t*n,i*n,s*n,e*n))}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.t*b.t}cross(t){const i=this.x,s=this.y,e=this.z,n=this.t,l=t.x,h=t.y,o=t.z,a=t.t;return new m(s*o-e*h,e*a-n*o,n*l-i*a,i*h-s*l)}angleTo(t){const i=this.normalize(),s=t.normalize(),e=i.dot(s);return e>1?0:Math.acos(e)}lerp(t,i){const s=this.x,e=this.y,n=this.z;return at=this.t,new m(s+i*(t.x-s),e+i*(t.y-e),n+i*(t.z-n),at+i*(t.t-at))}random(t=1){const i=2*glMatrix.RANDOM()*Math.PI,s=2*glMatrix.RANDOM()-1,e=Math.sqrt(1-s*s)*t;return out[0]=Math.cos(i)*e,out[1]=Math.sin(i)*e,out[2]=s*t,out}clone(){return new m(this.__data[0],this.__data[1],this.__data[2],this.__data[3])}toVec3(){return new u(this.__data[0],this.__data[1],this.__data[2])}asArray(){return this.__data}static create(...t){return new u(...t)}static createFromFloat32Buffer(t,i=0){return new m(t,4*i)}static numElements(){return 4}toJSON(){return{x:this.x,y:this.y,z:this.z,t:this.t}}}r.registerType("Vec4",m);class Z extends a{constructor(t=0,i=0,s=0,e=255){super(),t instanceof Uint8Array?this.__data=t:t instanceof ArrayBuffer?this.__data=new Uint8Array(t,i,4):(this.__data=new Uint8Array(4),"string"==typeof t?t.startsWith("#")?this.setFromHex(t):this.setFromCSSColorName(t):(this.__data[0]=t,this.__data[1]=i,this.__data[2]=s,this.__data[3]=e))}get r(){return this.__data[0]}set r(t){this.__data[0]=t}get g(){return this.__data[1]}set g(t){this.__data[1]=t}get b(){return this.__data[2]}set b(t){this.__data[2]=t}get a(){return this.__data[3]}set a(t){this.__data[3]=t}set(t,i,s,e=255){this.r=t,this.g=i,this.b=s,this.a=e}setFromOther(t){this.r=t.r,this.g=t.g,this.b=t.b,this.a=t.a}setFromArray(t){this.r=t[0],this.g=t[1],this.b=t[2],this.a=4==t.length?t[3]:1}setFromHex(t){const i=function(t){const i=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return i?{r:parseInt(i[1],16),g:parseInt(i[2],16),b:parseInt(i[3],16)}:null}(t);i?this.set(i.r,i.g,i.b):console.warn("Invalid hex code:"+t)}setFromCSSColorName(t){t.startsWith("#")?this.setFromHex(t):this.setFromHex((t=>{const i={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",honeydew:"#f0fff0",hotpink:"#ff69b4","indianred ":"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgrey:"#d3d3d3",lightgreen:"#90ee90",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370d8",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#d87093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",rebeccapurple:"#663399",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"};return void 0!==i[t.toLowerCase()]&&i[t.toLowerCase()]})(t))}toHex(){function t(t){const i=t.toString(16);return 1==i.length?"0"+i:i}return"#"+t(this.r)+t(this.g)+t(this.b)}equal(t){return this.r==t.r&&this.g==t.g&&this.b==t.b&&this.a==t.a}notequals(t){return this.r!=t.r&&this.g!=t.g&&this.b!=t.b&&this.a!=t.a}approxEqual(t,i=Number.EPSILON){return Math.abs(this.r-t.r)<i&&Math.abs(this.g-t.g)<i&&Math.abs(this.b-t.b)<i&&Math.abs(this.a-t.a)<i}add(t){return new Z(this.r+t.r,this.g+t.g,this.b+t.b,this.a+t.a)}subtract(t){return new Z(this.r-t.r,this.g-t.g,this.b-t.b,this.a-t.a)}scale(t){return new Z(this.r*t,this.g*t,this.b*t,this.a*t)}scaleInPlace(t){this.r*=t,this.g*=t,this.b*=t,this.a*=t}applyGamma(t){this.set(Math.pow(this.r,t),Math.pow(this.g,t),Math.pow(this.b,t),this.a)}toLinear(t=2.2){return new Z(Math.pow(this.r,t),Math.pow(this.g,t),Math.pow(this.b,t),this.a)}toGamma(t=2.2){return new Z(Math.pow(this.r,1/t),Math.pow(this.g,1/t),Math.pow(this.b,1/t),this.a)}luminance(){return.2126*this.r+.7152*this.g+.0722*this.b}lerp(t,i){const s=this.r,e=this.g,n=this.b,l=this.a;return new Z(s+i*(t.r-s),e+i*(t.g-e),n+i*(t.b-n),l+i*(t.a-l))}static random(t=0,i=!1){return t>0?new Z(t+Math.random()*(1-t),t+Math.random()*(1-t),t+Math.random()*(1-t),i?t+Math.random()*(1-t):1):t<0?new Z(Math.random()*(1+t),Math.random()*(1+t),Math.random()*(1+t),i?Math.random()*(1+t):1):new Z(Math.random(),Math.random(),Math.random(),i?Math.random():1)}clone(){return new Z(this.__data[0],this.__data[1],this.__data[2],this.__data[3])}asArray(){return this.__data}as3ComponentArray(){return[this.__data[0],this.__data[1],this.__data[2]]}static create(...t){return new Z(...t)}static createFromFloat32Buffer(t,i=0){return new Z(t,4*i)}static numElements(){return 4}toJSON(){return{r:this.r,g:this.g,b:this.b,a:this.a}}fromJSON(t){this.r=t.r,this.g=t.g,this.b=t.b,this.a=t.a}toCSSString(){return"rgba("+Math.round(255*this.r)+", "+Math.round(255*this.g)+", "+Math.round(255*this.b)+", "+this.a+")"}}r.registerType("RGBA",Z);class p extends a{constructor(t=0,i=0,s=0,e=1){super(),t instanceof Float32Array?this.__data=t:t instanceof ArrayBuffer?this.__data=new Float32Array(t,i,4):(this.__data=new Float32Array(4),"string"==typeof t?t.startsWith("#")?this.setFromHex(t):this.setFromCSSColorName(t):(this.__data[0]=t,this.__data[1]=i,this.__data[2]=s,this.__data[3]=e))}get r(){return this.__data[0]}set r(t){this.__data[0]=t}get g(){return this.__data[1]}set g(t){this.__data[1]=t}get b(){return this.__data[2]}set b(t){this.__data[2]=t}get a(){return this.__data[3]}set a(t){this.__data[3]=t}set(t,i,s,e=1){this.r=t,this.g=i,this.b=s,this.a=e}setFromOther(t){this.r=t.r,this.g=t.g,this.b=t.b,this.a=t.a}setFromScalarArray(t){this.r=t[0],this.g=t[1],this.b=t[2],this.a=4==t.length?t[3]:1}getAsRGBArray(){return[255*this.r,255*this.g,255*this.b]}getAsRGBDict(){return{r:255*this.r,g:255*this.g,b:255*this.b}}setFromRGB(t,i,s,e){this.r=t/255,this.g=i/255,this.b=s/255,this.a=e?e/255:1}setFromRGBArray(t){this.r=t[0]/255,this.g=t[1]/255,this.b=t[2]/255,this.a=4==t.length?t[3]/255:1}setFromRGBDict(t){this.r=t.r/255,this.g=t.g/255,this.b=t.b/255,this.a=4==t.a?t.a/255:1}setFromHex(t){const i=function(t){const i=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return i?{r:parseInt(i[1],16),g:parseInt(i[2],16),b:parseInt(i[3],16)}:null}(t);i?this.setFromRGB(i.r,i.g,i.b):console.warn("Invalid hex code:"+t)}setFromCSSColorName(t){t.startsWith("#")?this.setFromHex(t):this.setFromHex((t=>{const i={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",honeydew:"#f0fff0",hotpink:"#ff69b4","indianred ":"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgrey:"#d3d3d3",lightgreen:"#90ee90",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370d8",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#d87093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",rebeccapurple:"#663399",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"};return void 0!==i[t.toLowerCase()]&&i[t.toLowerCase()]})(t))}toHex(){function t(t){const i=Math.round(255*t).toString(16);return 1==i.length?"0"+i:i}return"#"+t(this.r)+t(this.g)+t(this.b)}equal(t){return this.r==t.r&&this.g==t.g&&this.b==t.b&&this.a==t.a}notequals(t){return this.r!=t.r&&this.g!=t.g&&this.b!=t.b&&this.a!=t.a}approxEqual(t,i=Number.EPSILON){return Math.abs(this.r-t.r)<i&&Math.abs(this.g-t.g)<i&&Math.abs(this.b-t.b)<i&&Math.abs(this.a-t.a)<i}add(t){return new p(this.r+t.r,this.g+t.g,this.b+t.b,this.a+t.a)}subtract(t){return new p(this.r-t.r,this.g-t.g,this.b-t.b,this.a-t.a)}scale(t){return new p(this.r*t,this.g*t,this.b*t,this.a*t)}scaleInPlace(t){this.r*=t,this.g*=t,this.b*=t,this.a*=t}applyGamma(t){this.set(Math.pow(this.r,t),Math.pow(this.g,t),Math.pow(this.b,t),this.a)}toLinear(t=2.2){return new p(Math.pow(this.r,t),Math.pow(this.g,t),Math.pow(this.b,t),this.a)}toGamma(t=2.2){return new p(Math.pow(this.r,1/t),Math.pow(this.g,1/t),Math.pow(this.b,1/t),this.a)}luminance(){return.2126*this.r+.7152*this.g+.0722*this.b}lerp(t,i){const s=this.r,e=this.g,n=this.b,l=this.a;return new p(s+i*(t.r-s),e+i*(t.g-e),n+i*(t.b-n),l+i*(t.a-l))}static random(t=0,i=!1){return t>0?new p(t+Math.random()*(1-t),t+Math.random()*(1-t),t+Math.random()*(1-t),i?t+Math.random()*(1-t):1):t<0?new p(Math.random()*(1+t),Math.random()*(1+t),Math.random()*(1+t),i?Math.random()*(1+t):1):new p(Math.random(),Math.random(),Math.random(),i?Math.random():1)}clone(){return new p(this.__data[0],this.__data[1],this.__data[2],this.__data[3])}asArray(){return this.__data}as3ComponentArray(){return[this.__data[0],this.__data[1],this.__data[2]]}static create(...t){return new p(...t)}static createFromFloat32Buffer(t,i=0){return new p(t,4*i)}static numElements(){return 4}toJSON(){return{r:this.r,g:this.g,b:this.b,a:this.a}}fromJSON(t){this.r=t.r,this.g=t.g,this.b=t.b,this.a=t.a}toCSSString(){return"rgba("+Math.round(255*this.r)+", "+Math.round(255*this.g)+", "+Math.round(255*this.b)+", "+this.a+")"}}r.registerType("Color",p);class G extends a{constructor(t=0,i=0,s=0,e=0){if(super(),isNaN(e))switch(e){case"XYZ":this.order=0;break;case"YZX":this.order=1;break;case"ZXY":this.order=2;break;case"XZY":this.order=3;break;case"ZYX":this.order=4;break;case"YXZ":this.order=5;break;default:throw new Error("Invalid Euler Angles Order:"+e)}else this.order=e;t instanceof ArrayBuffer?this.__data=new Float32Array(t,i,4):(this.__data=new Float32Array(3),this.__data[0]=t,this.__data[1]=i,this.__data[2]=s)}get x(){return this.__data[0]}set x(t){this.__data[0]=t}get y(){return this.__data[1]}set y(t){this.__data[1]=t}get z(){return this.__data[2]}set z(t){this.__data[2]=t}set(t,i,s){this.__data[0]=t,this.__data[1]=i,this.__data[2]=s}}r.registerType("EulerAngles",G);class X extends a{constructor(t=1,i=0,s=0,e=0,n=1,l=0,h=0,o=0,a=1){super(),t instanceof ArrayBuffer?this.__data=new Float32Array(t,i,9):(this.__data=new Float32Array(9),this.set(t,i,s,e,n,l,h,o,a))}get m00(){return this.__data[0]}set m00(t){this.__data[0]=t}get m01(){return this.__data[1]}set m01(t){this.__data[1]=t}get m02(){return this.__data[2]}set m02(t){this.__data[2]=t}get m10(){return this.__data[3]}set m10(t){this.__data[3]=t}get m11(){return this.__data[4]}set m11(t){this.__data[4]=t}get m12(){return this.__data[5]}set m12(t){this.__data[5]=t}get m20(){return this.__data[6]}set m20(t){this.__data[6]=t}get m21(){return this.__data[7]}set m21(t){this.__data[7]=t}get m22(){return this.__data[8]}set m22(t){this.__data[8]=t}get xAxis(){return u.createFromFloat32Buffer(this.__data.buffer,0)}set xAxis(t){this.xAxis.set(t.x,t.y,t.z)}get yAxis(){return u.createFromFloat32Buffer(this.__data.buffer,3)}set yAxis(t){this.yAxis.set(t.x,t.y,t.z)}get zAxis(){return u.createFromFloat32Buffer(this.__data.buffer,6)}set zAxis(t){this.zAxis.set(t.x,t.y,t.z)}set(t=1,i=0,s=0,e=0,n=1,l=0,h=0,o=0,a=1){this.__data[0]=t,this.__data[1]=i,this.__data[2]=s,this.__data[3]=e,this.__data[4]=n,this.__data[5]=l,this.__data[6]=h,this.__data[7]=o,this.__data[8]=a}setIdentity(){this.set()}setFromMat(t){this.__data[0]=t.m00,this.__data[1]=t.m01,this.__data[2]=t.m02,this.__data[3]=t.m10,this.__data[4]=t.m11,this.__data[5]=t.m12,this.__data[6]=t.m20,this.__data[7]=t.m21,this.__data[8]=t.m22}setFromDirectionAndUpvector(t,i){const s=t,e=s.length();if(e<Number.EPSILON)return void this.setIdentity();s.scaleInPlace(1/e);const n=i.cross(s),l=n.length();l>Number.EPSILON&&n.scaleInPlace(1/l);const h=s.cross(n),o=h.length();o>Number.EPSILON&&h.scaleInPlace(1/o),this.set(n.x,n.y,n.z,h.x,h.y,h.z,s.x,s.y,s.z)}inverse(){const t=this.__data[0],i=this.__data[1],s=this.__data[2],e=this.__data[3],n=this.__data[4],l=this.__data[5],h=this.__data[6],o=this.__data[7],a=this.__data[8],c=a*n-l*o,r=-a*e+l*h,d=o*e-n*h,u=t*c+i*r+s*d;return u?(u=1/u,new X(c*u,(-a*i+s*o)*u,(l*i-s*n)*u,r*u,(a*t-s*h)*u,(-l*t+s*e)*u,d*u,(-o*t+i*h)*u,(n*t-i*e)*u)):(console.warn("Unable to invert Mat3"),null)}invertInPlace(){const t=this.__data[0],i=this.__data[1],s=this.__data[2],e=this.__data[3],n=this.__data[4],l=this.__data[5],h=this.__data[6],o=this.__data[7],a=this.__data[8],c=a*n-l*o,r=-a*e+l*h,d=o*e-n*h,u=t*c+i*r+s*d;return u?(u=1/u,this.set(c*u,(-a*i+s*o)*u,(l*i-s*n)*u,r*u,(a*t-s*h)*u,(-l*t+s*e)*u,d*u,(-o*t+i*h)*u,(n*t-i*e)*u),!0):(console.warn("Unable to invert Mat3"),!1)}transpose(){return X(this.__data[0],this.__data[3],this.__data[6],this.__data[1],this.__data[4],this.__data[7],this.__data[2],this.__data[5],this.__data[8])}transposeInPlace(){const t=this.__data[1],i=this.__data[2],s=this.__data[5];this.__data[1]=this.__data[3],this.__data[2]=this.__data[6],this.__data[3]=t,this.__data[5]=this.__data[7],this.__data[6]=i,this.__data[7]=s}transformVec3(t){return new u(this.__data[0]*t.x+this.__data[1]*t.y+this.__data[2]*t.z,this.__data[3]*t.x+this.__data[4]*t.y+this.__data[5]*t.z,this.__data[6]*t.x+this.__data[7]*t.y+this.__data[8]*t.z)}clone(){return new X(this.__data[0],this.__data[1],this.__data[2],this.__data[3],this.__data[4],this.__data[5],this.__data[6],this.__data[7],this.__data[8],this.__data[9])}static create(...t){return new X(...t)}static createFromFloat32Buffer(t,i=0){return new X(t,4*i)}toJSON(){return this.__data}fromJSON(t){this.__data=new Float32Array(t)}toString(){return this.toJSON().toString()}}r.registerType("Mat3",X);class y extends a{constructor(t=1,i=0,s=0,e=0,n=0,l=1,h=0,o=0,a=0,c=0,r=1,d=0,u=0,m=0,b=0,Z=1){super(),t instanceof Float32Array?this.__data=t:t instanceof ArrayBuffer?this.__data=new Float32Array(t,i,16):(this.__data=new Float32Array(16),this.set(t,i,s,e,n,l,h,o,a,c,r,d,u,m,b,Z))}get m00(){return this.__data[0]}set m00(t){this.__data[0]=t}get m01(){return this.__data[1]}set m01(t){this.__data[1]=t}get m02(){return this.__data[2]}set m02(t){this.__data[2]=t}get m03(){return this.__data[3]}set m03(t){this.__data[3]=t}get m10(){return this.__data[4]}set m10(t){this.__data[4]=t}get m11(){return this.__data[5]}set m11(t){this.__data[5]=t}get m12(){return this.__data[6]}set m12(t){this.__data[6]=t}get m13(){return this.__data[7]}set m13(t){this.__data[7]=t}get m20(){return this.__data[8]}set m20(t){this.__data[8]=t}get m21(){return this.__data[9]}set m21(t){this.__data[9]=t}get m22(){return this.__data[10]}set m22(t){this.__data[10]=t}get m23(){return this.__data[11]}set m23(t){this.__data[11]=t}get m30(){return this.__data[12]}set m30(t){this.__data[12]=t}get m31(){return this.__data[13]}set m31(t){this.__data[13]=t}get m32(){return this.__data[14]}set m32(t){this.__data[14]=t}get m33(){return this.__data[15]}set m33(t){this.__data[15]=t}get xAxis(){return u.createFromFloat32Buffer(this.__data.buffer,0)}set xAxis(t){this.xAxis.set(t.x,t.y,t.z)}get yAxis(){return u.createFromFloat32Buffer(this.__data.buffer,4)}set yAxis(t){this.yAxis.set(t.x,t.y,t.z)}get zAxis(){return u.createFromFloat32Buffer(this.__data.buffer,8)}set zAxis(t){this.zAxis.set(t.x,t.y,t.z)}get translation(){return u.createFromFloat32Buffer(this.__data.buffer,12)}set translation(t){this.translation.set(t.x,t.y,t.z)}set(t=1,i=0,s=0,e=0,n=0,l=1,h=0,o=0,a=0,c=0,r=1,d=0,u=0,m=0,b=0,Z=1){this.__data[0]=t,this.__data[1]=i,this.__data[2]=s,this.__data[3]=e,this.__data[4]=n,this.__data[5]=l,this.__data[6]=h,this.__data[7]=o,this.__data[8]=a,this.__data[9]=c,this.__data[10]=r,this.__data[11]=d,this.__data[12]=u,this.__data[13]=m,this.__data[14]=b,this.__data[15]=Z}setIdentity(){this.set()}setDataArray(t){this.__data=t}setFromMat4(t){this.__data[0]=t.m00,this.__data[1]=t.m01,this.__data[2]=t.m02,this.__data[3]=t.m03,this.__data[4]=t.m10,this.__data[5]=t.m11,this.__data[6]=t.m12,this.__data[7]=t.m13,this.__data[8]=t.m20,this.__data[9]=t.m21,this.__data[10]=t.m22,this.__data[11]=t.m23,this.__data[12]=t.m30,this.__data[13]=t.m31,this.__data[14]=t.m32,this.__data[15]=t.m33}toMat3(t){return new X(this.__data[0],this.__data[1],this.__data[2],this.__data[4],this.__data[5],this.__data[6],this.__data[8],this.__data[9],this.__data[10])}transposeInPlace(){const t=this.__data[1],i=this.__data[2],s=this.__data[3],e=this.__data[6],n=this.__data[7],l=this.__data[11];this.__data[1]=this.__data[4],this.__data[2]=this.__data[8],this.__data[3]=this.__data[12],this.__data[4]=t,this.__data[6]=this.__data[9],this.__data[7]=this.__data[13],this.__data[8]=i,this.__data[9]=e,this.__data[11]=this.__data[14],this.__data[12]=s,this.__data[13]=n,this.__data[14]=l}transpose(){return new y(this.__data[0],this.__data[4],this.__data[8],this.__data[12],this.__data[1],this.__data[5],this.__data[9],this.__data[13],this.__data[2],this.__data[6],this.__data[10],this.__data[14],this.__data[3],this.__data[7],this.__data[11],this.__data[15])}inverse(){const t=this.__data[0],i=this.__data[1],s=this.__data[2],e=this.__data[3],n=this.__data[4],l=this.__data[5],h=this.__data[6],o=this.__data[7],a=this.__data[8],c=this.__data[9],r=this.__data[10],d=this.__data[11],u=this.__data[12],m=this.__data[13],b=this.__data[14],Z=this.__data[15],p=t*l-i*n,G=t*h-s*n,X=t*o-e*n,f=i*h-s*l,V=i*o-e*l,g=s*o-e*h,R=a*m-c*u,W=a*b-r*u,I=a*Z-d*u,S=c*b-r*m,L=c*Z-d*m,x=r*Z-d*b;let v=p*x-G*L+X*S+f*I-V*W+g*R;return v?(v=1/v,new y((l*x-h*L+o*S)*v,(s*L-i*x-e*S)*v,(m*g-b*V+Z*f)*v,(r*V-c*g-d*f)*v,(h*I-n*x-o*W)*v,(t*x-s*I+e*W)*v,(b*X-u*g-Z*G)*v,(a*g-r*X+d*G)*v,(n*L-l*I+o*R)*v,(i*I-t*L-e*R)*v,(u*V-m*X+Z*p)*v,(c*X-a*V-d*p)*v,(l*W-n*S-h*R)*v,(t*S-i*W+s*R)*v,(m*G-u*f-b*p)*v,(a*f-c*G+r*p)*v)):(console.warn("Unable to invert Mat4"),null)}invertInPlace(){const t=this.__data[0],i=this.__data[1],s=this.__data[2],e=this.__data[3],n=this.__data[4],l=this.__data[5],h=this.__data[6],o=this.__data[7],a=this.__data[8],c=this.__data[9],r=this.__data[10],d=this.__data[11],u=this.__data[12],m=this.__data[13],b=this.__data[14],Z=this.__data[15],p=t*l-i*n,G=t*h-s*n,X=t*o-e*n,y=i*h-s*l,f=i*o-e*l,V=s*o-e*h,g=a*m-c*u,R=a*b-r*u,W=a*Z-d*u,I=c*b-r*m,S=c*Z-d*m,L=r*Z-d*b;let x=p*L-G*S+X*I+y*W-f*R+V*g;return x?(x=1/x,this.set((l*L-h*S+o*I)*x,(s*S-i*L-e*I)*x,(m*V-b*f+Z*y)*x,(r*f-c*V-d*y)*x,(h*W-n*L-o*R)*x,(t*L-s*W+e*R)*x,(b*X-u*V-Z*G)*x,(a*V-r*X+d*G)*x,(n*S-l*W+o*g)*x,(i*W-t*S-e*g)*x,(u*f-m*X+Z*p)*x,(c*X-a*f-d*p)*x,(l*R-n*I-h*g)*x,(t*I-i*R+s*g)*x,(m*G-u*y-b*p)*x,(a*y-c*G+r*p)*x),!0):(console.warn("Unable to invert Mat4"),!1)}setInverse(t){const i=t.__data[0],s=t.__data[1],e=t.__data[2],n=t.__data[3],l=t.__data[4],h=t.__data[5],o=t.__data[6],a=t.__data[7],c=t.__data[8],r=t.__data[9],d=t.__data[10],u=t.__data[11],m=t.__data[12],b=t.__data[13],Z=t.__data[14],p=t.__data[15],G=i*h-s*l,X=i*o-e*l,y=i*a-n*l,f=s*o-e*h,V=s*a-n*h,g=e*a-n*o,R=c*b-r*m,W=c*Z-d*m,I=c*p-u*m,S=r*Z-d*b,L=r*p-u*b,x=d*p-u*Z;let v=G*x-X*L+y*S+f*I-V*W+g*R;if(!v)throw new Error("Unable to invert Mat4");v=1/v,this.set((h*x-o*L+a*S)*v,(e*L-s*x-n*S)*v,(b*g-Z*V+p*f)*v,(d*V-r*g-u*f)*v,(o*I-l*x-a*W)*v,(i*x-e*I+n*W)*v,(Z*y-m*g-p*X)*v,(c*g-d*y+u*X)*v,(l*L-h*I+a*R)*v,(s*I-i*L-n*R)*v,(m*V-b*y+p*G)*v,(r*y-c*V-u*G)*v,(h*W-l*S-o*R)*v,(i*S-s*W+e*R)*v,(b*X-m*f-Z*G)*v,(c*f-r*X+d*G)*v)}multiply(t){const i=this.__data[0],s=this.__data[1],e=this.__data[2],n=this.__data[3],l=this.__data[4],h=this.__data[5],o=this.__data[6],a=this.__data[7],c=this.__data[8],r=this.__data[9],d=this.__data[10],u=this.__data[11],m=this.__data[12],b=this.__data[13],Z=this.__data[14],p=this.__data[15],G=t.asArray();let X=G[0],f=G[1],V=G[2],g=G[3];const R=new y;return R.m00=X*i+f*l+V*c+g*m,R.m01=X*s+f*h+V*r+g*b,R.m02=X*e+f*o+V*d+g*Z,R.m03=X*n+f*a+V*u+g*p,X=G[4],f=G[5],V=G[6],g=G[7],R.m10=X*i+f*l+V*c+g*m,R.m11=X*s+f*h+V*r+g*b,R.m12=X*e+f*o+V*d+g*Z,R.m13=X*n+f*a+V*u+g*p,X=G[8],f=G[9],V=G[10],g=G[11],R.m20=X*i+f*l+V*c+g*m,R.m21=X*s+f*h+V*r+g*b,R.m22=X*e+f*o+V*d+g*Z,R.m23=X*n+f*a+V*u+g*p,X=G[12],f=G[13],V=G[14],g=G[15],R.m30=X*i+f*l+V*c+g*m,R.m31=X*s+f*h+V*r+g*b,R.m32=X*e+f*o+V*d+g*Z,R.m33=X*n+f*a+V*u+g*p,R}multiplyInPlace(t){const i=this.asArray(),s=i[0],e=i[1],n=i[2],l=i[3],h=i[4],o=i[5],a=i[6],c=i[7],r=i[8],d=i[9],u=i[10],m=i[11],b=i[12],Z=i[13],p=i[14],G=i[15],X=t.asArray();let y=X[0],f=X[1],V=X[2],g=X[3];return this.m00=y*s+f*h+V*r+g*b,this.m01=y*e+f*o+V*d+g*Z,this.m02=y*n+f*a+V*u+g*p,this.m03=y*l+f*c+V*m+g*G,y=X[4],f=X[5],V=X[6],g=X[7],this.m10=y*s+f*h+V*r+g*b,this.m11=y*e+f*o+V*d+g*Z,this.m12=y*n+f*a+V*u+g*p,this.m13=y*l+f*c+V*m+g*G,y=X[8],f=X[9],V=X[10],g=X[11],this.m20=y*s+f*h+V*r+g*b,this.m21=y*e+f*o+V*d+g*Z,this.m22=y*n+f*a+V*u+g*p,this.m23=y*l+f*c+V*m+g*G,y=X[12],f=X[13],V=X[14],g=X[15],this.m30=y*s+f*h+V*r+g*b,this.m31=y*e+f*o+V*d+g*Z,this.m32=y*n+f*a+V*u+g*p,this.m33=y*l+f*c+V*m+g*G,this}postmultiplyInPlace(t){const i=t.asArray(),s=i[0],e=i[1],n=i[2],l=i[3],h=i[4],o=i[5],a=i[6],c=i[7],r=i[8],d=i[9],u=i[10],m=i[11],b=i[12],Z=i[13],p=i[14],G=i[15],X=this.asArray();let y=X[0],f=X[1],V=X[2],g=X[3];return this.m00=y*s+f*h+V*r+g*b,this.m01=y*e+f*o+V*d+g*Z,this.m02=y*n+f*a+V*u+g*p,this.m03=y*l+f*c+V*m+g*G,y=X[4],f=X[5],V=X[6],g=X[7],this.m10=y*s+f*h+V*r+g*b,this.m11=y*e+f*o+V*d+g*Z,this.m12=y*n+f*a+V*u+g*p,this.m13=y*l+f*c+V*m+g*G,y=X[8],f=X[9],V=X[10],g=X[11],this.m20=y*s+f*h+V*r+g*b,this.m21=y*e+f*o+V*d+g*Z,this.m22=y*n+f*a+V*u+g*p,this.m23=y*l+f*c+V*m+g*G,y=X[12],f=X[13],V=X[14],g=X[15],this.m30=y*s+f*h+V*r+g*b,this.m31=y*e+f*o+V*d+g*Z,this.m32=y*n+f*a+V*u+g*p,this.m33=y*l+f*c+V*m+g*G,this}translateInPlace(t){const i=this.__data,s=t.x,e=t.y,n=t.z;return i[12]=i[0]*s+i[4]*e+i[8]*n+i[12],i[13]=i[1]*s+i[5]*e+i[9]*n+i[13],i[14]=i[2]*s+i[6]*e+i[10]*n+i[14],i[15]=i[3]*s+i[7]*e+i[11]*n+i[15],this}setLookAt(t,i,s){const e=t.subtract(i),n=e.length();if(n<Number.EPSILON)return void this.setIdentity();e.scaleInPlace(1/n);const l=s.cross(e),h=l.length();h>Number.EPSILON&&l.scaleInPlace(1/h);const o=e.cross(l),a=o.length();a>Number.EPSILON&&o.scaleInPlace(1/a),this.set(l.x,l.y,l.z,0,o.x,o.y,o.z,0,e.x,e.y,e.z,0,t.x,t.y,t.z,1)}setRotation(t,i){const s=t.length();if(Math.abs(s)<Number.EPSILON)return null;const e=t.x/s,n=t.y/s,l=t.z/s,h=Math.sin(i),o=Math.cos(i),a=1-o,c=this.__data;return c[0]=e*e*a+o,c[1]=n*e*a+l*h,c[2]=l*e*a-n*h,c[3]=0,c[4]=e*n*a-l*h,c[5]=n*n*a+o,c[6]=l*n*a+e*h,c[7]=0,c[8]=e*l*a+n*h,c[9]=n*l*a-e*h,c[10]=l*l*a+o,c[11]=0,c[12]=0,c[13]=0,c[14]=0,c[15]=1,this}setXRotation(t){const i=Math.sin(t),s=Math.cos(t),e=this.__data;return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=s,e[6]=i,e[7]=0,e[8]=0,e[9]=-i,e[10]=s,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}setYRotation(t){const i=Math.sin(t),s=Math.cos(t),e=this.__data;return e[0]=s,e[1]=0,e[2]=-i,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=i,e[9]=0,e[10]=s,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}setZRotation(t){const i=Math.sin(t),s=Math.cos(t),e=this.__data;return e[0]=s,e[1]=i,e[2]=0,e[3]=0,e[4]=-i,e[5]=s,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}transformVec4(t){const i=this.__data,s=t.x,e=t.y,n=t.z,l=t.t;return new Vec4(i[0]*s+i[4]*e+i[8]*n+i[12]*l,i[1]*s+i[5]*e+i[9]*n+i[13]*l,i[2]*s+i[6]*e+i[10]*n+i[14]*l,i[3]*s+i[7]*e+i[11]*n+i[15]*l)}transformVec3(t){const i=this.__data,s=t.x,e=t.y,n=t.z;return new u(i[0]*s+i[4]*e+i[8]*n+i[12],i[1]*s+i[5]*e+i[9]*n+i[13],i[2]*s+i[6]*e+i[10]*n+i[14])}rotateVec3(t){const i=this.__data,s=t.x,e=t.y,n=t.z;return new u(i[0]*s+i[4]*e+i[8]*n,i[1]*s+i[5]*e+i[9]*n,i[2]*s+i[6]*e+i[10]*n)}setPerspectiveMatrix(t,i,s,e){const n=Math.tan(.5*Math.PI-.5*t),l=1/(s-e);this.set(n/i,0,0,0,0,n,0,0,0,0,(s+e)*l,-1,0,0,s*e*l*2,0)}setOrthographicMatrix(t,i,s,e,n,l){const h=1/(t-i),o=1/(s-e),a=1/(n-l);this.set(-2*h,0,0,0,0,-2*o,0,0,0,0,2*a,0,(t+i)*h,(e+s)*o,(l+n)*a,1)}setScale(t,i,s){t instanceof u?this.set(t.x,0,0,0,0,t.y,0,0,0,0,t.z,0,0,0,0,1):this.set(t,0,0,0,0,i,0,0,0,0,s,0,0,0,0,1)}setFromMat3x4Array(t){this.set(t[0],t[1],t[2],0,t[3],t[4],t[5],0,t[6],t[7],t[8],0,t[9],t[10],t[11],1)}static createFromFloat32Buffer(t,i=0){return new y(t,4*i)}clone(){return new y(this.__data[0],this.__data[1],this.__data[2],this.__data[3],this.__data[4],this.__data[5],this.__data[6],this.__data[7],this.__data[8],this.__data[9],this.__data[10],this.__data[11],this.__data[12],this.__data[13],this.__data[14],this.__data[15])}static create(...t){return new y(...t)}toJSON(){return this.__data}fromJSON(t){this.__data=new Float32Array(t)}}r.registerType("Mat4",y);class f extends a{constructor(t=0,i=0,s=0,e=1){if(super(),t instanceof ArrayBuffer)this.__data=new Float32Array(t,i,4);else if(this.__data=new Float32Array(4),"object"==typeof t){this.__data[0]=0,this.__data[1]=0,this.__data[2]=0,this.__data[3]=1;for(const i in t)Array.isArray(t[i])?this[i].call(this,...t[i]):this[i].call(this,t[i])}else this.__data[0]=t,this.__data[1]=i,this.__data[2]=s,this.__data[3]=e}get x(){return this.__data[0]}set x(t){this.__data[0]=t}get y(){return this.__data[1]}set y(t){this.__data[1]=t}get z(){return this.__data[2]}set z(t){this.__data[2]=t}get w(){return this.__data[3]}set w(t){this.__data[3]=t}set(t,i,s,e){this.__data[0]=t,this.__data[1]=i,this.__data[2]=s,this.__data[3]=e}setDataArray(t){this.__data=t}setFromOther(t){this.__data[0]=t.x,this.__data[1]=t.y,this.__data[2]=t.z,this.__data[3]=t.w}setFromEulerAngles(t){const i=new u;switch(t.order){case 0:i.set(t.x,-t.y,t.z);break;case 1:i.set(t.y,-t.z,t.x);break;case 2:i.set(t.z,-t.x,t.y);break;case 3:i.set(t.x,t.z,t.y);break;case 4:i.set(t.z,t.y,t.x);break;case 5:i.set(t.y,t.x,t.z);break;default:throw new Error("sdrty")}const s=.5*i.x,e=.5*i.y,n=.5*i.z,l=Math.cos(s),h=Math.cos(e),o=Math.cos(n),a=Math.sin(s),c=Math.sin(e),r=Math.sin(n),d=l*o,m=l*r,b=a*o,Z=a*r,p=h*b-c*m,G=h*Z+c*d,X=h*m-c*b;switch(this.w=h*d+c*Z,t.order){case 0:this.x=p,this.y=-G,this.z=X;break;case 1:this.x=X,this.y=p,this.z=-G;break;case 2:this.x=-G,this.y=X,this.z=p;break;case 3:this.x=p,this.y=X,this.z=G;break;case 4:this.x=X,this.y=G,this.z=p;break;case 5:this.x=G,this.y=p,this.z=X;break;default:throw new Error("sdrty")}}toEulerAngles(t){const i=new u;switch(t){case 0:i.set(this.z,this.x,this.y);break;case 1:i.set(this.x,this.y,this.z);break;case 2:i.set(this.y,this.z,this.x);break;case 3:i.set(this.y,-this.x,this.z);break;case 4:i.set(this.x,-this.z,this.y);break;case 5:i.set(this.z,-this.y,this.x);break;default:throw new Error("Invalid rotation order:"+t)}const s=new u,e=i.x*i.y+i.z*this.w;if(e>.49999)s.y=2*Math.atan2(i.x,this.w),s.z=.5*Math.PI,s.x=0;else if(e<-.49999)s.y=-2*Math.atan2(i.x,this.w),s.z=-.5*Math.PI,s.x=0;else{const t=i.x*i.x,n=i.z*i.z;s.y=Math.atan2(2*i.y*this.w-2*i.x*i.z,1-i.y*i.y*2-2*n),s.z=Math.asin(2*e),s.x=Math.atan2(2*i.x*this.w-2*i.y*i.z,1-2*t-2*n)}switch(t){case 0:return new G(s.y,s.z,s.x,t);case 1:return new G(s.x,s.y,s.z,t);case 2:return new G(s.z,s.x,s.y,t);case 3:return new G(-s.y,s.x,s.z,t);case 4:return new G(s.x,s.z,-s.y,t);case 5:return new G(s.z,-s.y,s.x,t)}}setFromAxisAndAngle(t,i){const s=i/2,e=t.normalize().scale(Math.sin(s));this.set(e.x,e.y,e.z,Math.cos(s))}setFromDirectionAndUpvector(t,i){const s=new X;s.setFromDirectionAndUpvector(t,i),this.setFromMat3(s)}setFrom2Vectors(t,i){t.normalize(),i.normalize();const s=t.cross(i),e=t.dot(i),n=Math.sqrt(2*(1+e));this.set(s.x/n,s.y/n,s.z/n,n/2),this.normalizeInPlace()}setFromMat3(t){const i=t.__data[0]+t.__data[4]+t.__data[8];let s;if(i>0)s=Math.sqrt(i+1),this.__data[3]=.5*s,s=.5/s,this.__data[0]=(t.__data[5]-t.__data[7])*s,this.__data[1]=(t.__data[6]-t.__data[2])*s,this.__data[2]=(t.__data[1]-t.__data[3])*s;else{let i=0;t.__data[4]>t.__data[0]&&(i=1),t.__data[8]>t.__data[3*i+i]&&(i=2);const e=(i+1)%3,n=(i+2)%3;s=Math.sqrt(t.__data[3*i+i]-t.__data[3*e+e]-t.__data[3*n+n]+1),this.__data[i]=.5*s,s=.5/s,this.__data[3]=(t.__data[3*e+n]-t.__data[3*n+e])*s,this.__data[e]=(t.__data[3*e+i]+t.__data[3*i+e])*s,this.__data[n]=(t.__data[3*n+i]+t.__data[3*i+n])*s}this.normalizeInPlace()}setFromMat4(t){const i=t.__data[0]+t.__data[5]+t.__data[10];let s;if(i>0)s=Math.sqrt(i+1),this.__data[3]=.5*s,s=.5/s,this.__data[0]=(t.__data[6]-t.__data[9])*s,this.__data[1]=(t.__data[8]-t.__data[2])*s,this.__data[2]=(t.__data[1]-t.__data[4])*s;else{let i=0;t.__data[5]>t.__data[0]&&(i=1),t.__data[10]>t.__data[4*i+i]&&(i=2);const e=(i+1)%3,n=(i+2)%3;s=Math.sqrt(t.__data[4*i+i]-t.__data[4*e+e]-t.__data[4*n+n]+1),this.__data[i]=.5*s,s=.5/s,this.__data[3]=(t.__data[4*e+n]-t.__data[4*n+e])*s,this.__data[e]=(t.__data[4*e+i]+t.__data[4*i+e])*s,this.__data[n]=(t.__data[4*n+i]+t.__data[4*i+n])*s}this.normalizeInPlace()}isIdentity(){return this.getAngle()<Number.EPSILON}getAngle(){return 2*Math.acos(this.w)}equal(t){return this.x==t.x&&this.y==t.y&&this.z==t.z&&this.w==t.w}notequals(t){return this.x!=t.x&&this.y!=t.y&&this.z!=t.z&&this.w!=t.w}approxEqual(t,i=Number.EPSILON){return Math.abs(this.x-t.x)<i&&Math.abs(this.y-t.y)<i&&Math.abs(this.z-t.z)<i&&Math.abs(this.w-t.w)<i}add(t){return new f(this.x+t.x,this.y+t.y,this.z+t.z,this.w+t.w)}addInPlace(t){this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w}subtract(t){return new f(this.x-t.x,this.y-t.y,this.z-t.z,this.w-t.w)}scale(t){return new f(this.x*t,this.y*t,this.z*t,this.w*t)}scaleInPlace(t){this.x*=t,this.y*=t,this.z*=t,this.w*=t}length(){const t=this.__data[0],i=this.__data[1],s=this.__data[2],e=this.__data[3];return Math.sqrt(t*t+i*i+s*s+e*e)}lengthSquared(){const t=this.__data[0],i=this.__data[1],s=this.__data[2],e=this.__data[3];return t*t+i*i+s*s+e*e}normalize(){const t=this.__data[0],i=this.__data[1],s=this.__data[2],e=this.__data[3];let n=t*t+i*i+s*s+e*e;return n<Number.EPSILON?new f:(n=1/Math.sqrt(n),new f(t*n,i*n,s*n))}normalizeInPlace(){const t=this.__data[0],i=this.__data[1],s=this.__data[2],e=this.__data[3];let n=t*t+i*i+s*s+e*e;n<Number.EPSILON||(n=1/Math.sqrt(n),this.set(t*n,i*n,s*n,e*n))}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w}cross(t){const i=this.x,s=this.y,e=this.z,n=this.w,l=t.x,h=t.y,o=t.z,a=t.w;return new f(s*o-e*h,e*a-n*o,n*l-i*a,i*h-s*l)}conjugate(){return new f(-this.x,-this.y,-this.z,this.w)}inverse(){return this.conjugate()}alignWith(t){this.dot(t)<0&&this.set(-this.x,-this.y,-this.z,-this.w)}multiply(t){const i=this.__data[0],s=this.__data[1],e=this.__data[2],n=this.__data[3],l=t.__data[0],h=t.__data[1],o=t.__data[2],a=t.__data[3];return new f(i*a+n*l+s*o-e*h,s*a+n*h+e*l-i*o,e*a+n*o+i*h-s*l,n*a-i*l-s*h-e*o)}multiplyInPlace(t){const i=this.__data[0],s=this.__data[1],e=this.__data[2],n=this.__data[3],l=t.__data[0],h=t.__data[1],o=t.__data[2],a=t.__data[3];this.set(i*a+n*l+s*o-e*h,s*a+n*h+e*l-i*o,e*a+n*o+i*h-s*l,n*a-i*l-s*h-e*o)}rotateVec3(t){const i=new f(t.x,t.y,t.z,0),s=this.multiply(i).multiply(this.conjugate());return new u(s.x,s.y,s.z)}rotateX(t){t*=.5;const i=this.x,s=this.y,e=this.z,n=this.w,l=Math.sin(t),h=Math.cos(t);this.x=i*h+n*l,this.y=s*h+e*l,this.z=e*h-s*l,this.w=n*h-i*l}rotateY(t){t*=.5;const i=this.x,s=this.y,e=this.z,n=this.w,l=Math.sin(t),h=Math.cos(t);this.x=i*h-e*l,this.y=s*h+n*l,this.z=e*h+i*l,this.w=n*h-s*l}rotateZ(t){t*=.5;const i=this.x,s=this.y,e=this.z,n=this.w,l=Math.sin(t),h=Math.cos(t);this.x=i*h+s*l,this.y=s*h-i*l,this.z=e*h+n*l,this.w=n*h-e*l}toMat3(){const t=this.x,i=this.y,s=this.z,e=this.w,n=t+t,l=i+i,h=s+s,o=t*n,a=i*n,c=i*l,r=s*n,d=s*l,u=s*h,m=e*n,b=e*l,Z=e*h,p=new X;return p.__data[0]=1-c-u,p.__data[3]=a-Z,p.__data[6]=r+b,p.__data[1]=a+Z,p.__data[4]=1-o-u,p.__data[7]=d-m,p.__data[2]=r-b,p.__data[5]=d+m,p.__data[8]=1-o-c,p}getXaxis(){return new u(1-2*(this.z*this.z+this.y*this.y),2*(this.x*this.y+this.z*this.w),2*(this.x*this.z-this.y*this.w))}getYaxis(){return new u(2*(this.x*this.y-this.z*this.w),1-2*(this.z*this.z+this.x*this.x),2*(this.y*this.z+this.x*this.w))}getZaxis(){const t=this.x*this.x,i=this.x*this.z,s=this.x*this.w,e=this.y*this.y,n=this.y*this.z,l=this.y*this.w;return new u,new u(2*(l+i),2*(n-s),1-2*(e+t))}mirror(t){switch(t){case 0:return new f(this.z,this.w,this.x,this.y);case 1:return new f(-this.w,this.z,this.y,-this.x);case 2:return new f(this.x,this.y,this.z,-this.w)}}toMat4(){const t=this.x,i=this.y,s=this.z,e=this.w,n=t+t,l=i+i,h=s+s,o=t*n,a=i*n,c=i*l,r=s*n,d=s*l,u=s*h,m=e*n,b=e*l,Z=e*h,p=new y;return p.__data[0]=1-c-u,p.__data[4]=a-Z,p.__data[8]=r+b,p.__data[1]=a+Z,p.__data[5]=1-o-u,p.__data[9]=d-m,p.__data[2]=r-b,p.__data[6]=d+m,p.__data[10]=1-o-c,p}lerp(t,i){const s=new f(this.x+i*(t.x-this.x),this.y+i*(t.y-this.y),this.z+i*(t.z-this.z),this.w+i*(t.w-this.w));return s.normalizeInPlace(),s}static create(...t){return new f(...t)}static createFromFloat32Buffer(t,i=0){return new f(t,4*i)}static numElements(){return 4}clone(){return new f(this.__data[0],this.__data[1],this.__data[2],this.__data[3])}toJSON(){return{x:this.x,y:this.y,z:this.z,w:this.w}}fromJSON(t){this.__data[0]=t.x,this.__data[1]=t.y,this.__data[2]=t.z,this.__data[3]=t.w,this.normalizeInPlace()}}r.registerType("Quat",f);class V{constructor(t,i){this.start=t instanceof u?t:new u,this.dir=i instanceof u?i:new u}closestPoint(t){const i=t.subtract(this.start).dot(this.dir);if(i<Number.EPSILON)return this.start;const s=i/this.dir.dot(this.dir);return this.start.add(this.dir.scale(s))}pointAtDist(t){return this.start.add(this.dir.scale(t))}intersectRayVector(t){const i=this.dir,s=t.dir,e=this.start.subtract(t.start),n=i.dot(i),l=i.dot(s),h=s.dot(s),o=i.dot(e),a=s.dot(e);if(0==n&&0==h)return this.start.distanceTo(t.start);if(0==n)return t.closestPoint(this.start);if(0==h)return this.closestPoint(t.start);const c=n*h-l*l;let r,d;return c<.001?(r=0,d=l>h?o/l:a/h):(r=(l*a-h*o)/c,d=(n*a-l*o)/c),[r,d]}intersectRayPlane(t){const i=this.start.subtract(t.start),s=t.dir.dot(this.dir),e=-t.dir.dot(i);if(Math.abs(s)<Number.PRECISION)return-1;const n=e/s;return n<-Number.PRECISION?-1:n}clone(){return new V(this.start.clone(),this.dir.clone())}static create(...t){return new V(...t)}toJSON(){return{start:this.start,dir:this.dir}}fromJSON(t){this.start.fromJSON(t.start),this.dir.fromJSON(t.dir)}toString(){return o(this.toJSON())}}r.registerType("Ray",V),new u(1,1,1);class g{constructor(t,i,s){if(t instanceof Float32Array)this.setFromFloat32Array(t);else{if(t instanceof u)this.tr=t;else{if(t instanceof f&&null==i&&null==s)return this.tr=new u,this.ori=t,void(this.sc=new u(1,1,1));this.tr=new u}this.ori=i instanceof f?i:new f,this.sc=s instanceof u?s:new u(1,1,1)}}set(t,i,s){this.tr=t,this.ori=i,s instanceof u&&(this.sc=s)}setFromOther(t){this.tr=t.tr,this.ori=t.ori,this.sc=t.sc}isIdentity(){return this.tr.isNull()&&this.ori.isIdentity()&&this.sc.is111()}setLookAt(t,i,s){const e=t.subtract(i);if(e.length()<Number.EPSILON)throw new Error("Invalid dir");this.ori.setFromDirectionAndUpvector(e,s),this.tr=t}multiply(t){let i=this.sc;return this.sc.x==this.sc.y&&this.sc.x==this.sc.z||(i=t.ori.rotateVec3(this.sc),Math.sign(i.x)!=Math.sign(this.sc.x)&&(i.x=-i.x),Math.sign(i.y)!=Math.sign(this.sc.y)&&(i.y=-i.y),Math.sign(i.z)!=Math.sign(this.sc.z)&&(i.z=-i.z)),new g(this.tr.add(this.ori.rotateVec3(i.multiply(t.tr))),this.ori.multiply(t.ori),i.multiply(t.sc))}inverse(){const t=new g;return t.ori=this.ori.inverse(),this.sc.x!=this.sc.y||this.sc.x!=this.sc.z?(t.sc=t.ori.rotateVec3(this.sc),Math.sign(t.sc.x)!=Math.sign(this.sc.x)&&(t.sc.x=-t.sc.x),Math.sign(t.sc.y)!=Math.sign(this.sc.y)&&(t.sc.y=-t.sc.y),Math.sign(t.sc.z)!=Math.sign(this.sc.z)&&(t.sc.z=-t.sc.z)):t.sc=this.sc.inverse(),t.tr=t.ori.rotateVec3(this.tr.negate().multiply(t.sc)),t}transformVec3(t){return this.tr.add(this.ori.rotateVec3(this.sc.multiply(t)))}toMat4(){const t=new y(this.sc.x,0,0,0,0,this.sc.y,0,0,0,0,this.sc.z,0,0,0,0,1),i=this.ori.toMat4(),s=new y;return s.translation=this.tr,s.multiply(i).multiply(t)}fromMat4(t){this.tr=t.translation,this.ori.setFromMat4(t)}setFromFloat32Array(t){if(7==t.length)return this.tr=new u(t.buffer,t.byteOffset),this.ori=new f(t.buffer,t.byteOffset+12),void(this.sc=new u(1,1,1));if(8!=t.length)return 10==t.length?(this.tr=new u(t.buffer,t.byteOffset),this.ori=new f(t.buffer,t.byteOffset+12),void(this.sc=new u(t.buffer,t.byteOffset+21))):void 0;{this.tr=new u(t.buffer,t.byteOffset),this.ori=new f(t.buffer,t.byteOffset+12);const i=t[7];this.sc=new u(i,i,i)}}clone(){return new g(this.tr.clone(),this.ori.clone(),this.sc.clone())}static create(...t){return new g(...t)}toJSON(){const t={tr:this.tr.toJSON(),ori:this.ori.toJSON()};return this.sc.is111()||(t.sc=this.sc.toJSON()),t}fromJSON(t){this.tr.fromJSON(t.tr),this.ori.fromJSON(t.ori),t.sc&&this.sc.fromJSON(t.sc)}toString(){return o(this.toJSON())}}r.registerType("Xfo",g);class R{constructor(t,i){this.p0=t instanceof d?t:new d(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),this.p1=i instanceof d?i:new d(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY)}set(t,i){this.p0=t,this.p1=i}reset(){this.p0.x=Number.POSITIVE_INFINITY,this.p1.x=Number.NEGATIVE_INFINITY,this.p0.y=Number.POSITIVE_INFINITY,this.p1.y=Number.NEGATIVE_INFINITY}isValid(){return this.p0.x!=Number.POSITIVE_INFINITY&&this.p1.x!=Number.NEGATIVE_INFINITY&&this.p0.y!=Number.POSITIVE_INFINITY&&this.p1.y!=Number.NEGATIVE_INFINITY}addPoint(t){(this.p0.x==Number.POSITIVE_INFINITY||t.x<this.p0.x)&&(this.p0.x=t.x),(this.p0.y==Number.POSITIVE_INFINITY||t.y<this.p0.y)&&(this.p0.y=t.y),(this.p1.y==Number.NEGATIVE_INFINITY||t.x>this.p1.x)&&(this.p1.x=t.x),(this.p1.y==Number.NEGATIVE_INFINITY||t.y>this.p1.y)&&(this.p1.y=t.y)}size(){return this.p1.subtract(this.p0)}diagonal(){return this.p1.subtract(this.p0)}center(){const t=this.p1.subtract(this.p0);return t.scaleInPlace(.5),t.addInPlace(this.p0),t}static create(...t){return new R(...t)}toJSON(){return{p0:this.p0.toJSON(),p1:this.p1.toJSON()}}toString(){return o(this.toJSON())}}r.registerType("Box2",R);class W extends a{constructor(t,i=0){super(),this.pos=t instanceof u?t:new u,this.radius=i}clone(){return new Sphere(this.pos.clone(),this.radius)}intersectsBox(t){return t.intersectsSphere(this)}static create(...t){return new Sphere(...t)}toJSON(){return{pos:this.pos.toJSON(),radius:this.radius}}toString(){return o(this.toJSON())}}r.registerType("SphereType",W);class I{constructor(t,i){t instanceof Float32Array?this.setFromFloat32Array(t):(this.p0=t instanceof u?t:new u(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),this.p1=i instanceof u?i:new u(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY))}get min(){return this.p0}get max(){return this.p1}set(t,i){this.p0=t,this.p1=i}reset(){this.p0.x=Number.POSITIVE_INFINITY,this.p1.x=Number.NEGATIVE_INFINITY,this.p0.y=Number.POSITIVE_INFINITY,this.p1.y=Number.NEGATIVE_INFINITY,this.p0.z=Number.POSITIVE_INFINITY,this.p1.z=Number.NEGATIVE_INFINITY}isValid(){return this.p0.x!=Number.POSITIVE_INFINITY&&this.p1.x!=Number.NEGATIVE_INFINITY&&this.p0.y!=Number.POSITIVE_INFINITY&&this.p1.y!=Number.NEGATIVE_INFINITY&&this.p0.z!=Number.POSITIVE_INFINITY&&this.p1.z!=Number.NEGATIVE_INFINITY}addPoint(t){t.x!=Number.POSITIVE_INFINITY&&t.x!=Number.NEGATIVE_INFINITY&&(t.x<this.p0.x&&(this.p0.x=t.x),t.x>this.p1.x&&(this.p1.x=t.x)),t.y!=Number.POSITIVE_INFINITY&&t.y!=Number.NEGATIVE_INFINITY&&(t.y<this.p0.y&&(this.p0.y=t.y),t.y>this.p1.y&&(this.p1.y=t.y)),t.z!=Number.POSITIVE_INFINITY&&t.z!=Number.NEGATIVE_INFINITY&&(t.z<this.p0.z&&(this.p0.z=t.z),t.z>this.p1.z&&(this.p1.z=t.z))}addBox3(t,i){i?(this.addPoint(i.transformVec3(t.p0)),this.addPoint(i.transformVec3(new u(t.p0.x,t.p0.y,t.p1.z))),this.addPoint(i.transformVec3(new u(t.p0.x,t.p1.y,t.p0.z))),this.addPoint(i.transformVec3(new u(t.p1.x,t.p0.y,t.p0.z))),this.addPoint(i.transformVec3(new u(t.p0.x,t.p1.y,t.p1.z))),this.addPoint(i.transformVec3(new u(t.p1.x,t.p0.y,t.p1.z))),this.addPoint(i.transformVec3(new u(t.p1.x,t.p1.y,t.p0.z))),this.addPoint(i.transformVec3(t.p1))):(this.addPoint(t.p0),this.addPoint(t.p1))}size(){return this.p1.subtract(this.p0)}diagonal(){return this.p1.subtract(this.p0)}center(){const t=this.p1.subtract(this.p0);return t.scaleInPlace(.5),t.addInPlace(this.p0),t}toMat4(){return new y(this.p1.x-this.p0.x,0,0,0,0,this.p1.y-this.p0.y,0,0,0,0,this.p1.z-this.p0.z,0,this.p0.x,this.p0.y,this.p0.z,1)}getBoundingSphere(){return new W(this.center(),.5*this.diagonal().length())}intersectsBox(t){return!(t.max.x<this.min.x||t.min.x>this.max.x||t.max.y<this.min.y||t.min.y>this.max.y||t.max.z<this.min.z||t.min.z>this.max.z)}intersectsSphere(t){return closestPoint.distanceToSquared(t.center)<=t.radius*t.radius}intersectsPlane(t){let i,s;return t.normal.x>0?(i=t.normal.x*this.min.x,s=t.normal.x*this.max.x):(i=t.normal.x*this.max.x,s=t.normal.x*this.min.x),t.normal.y>0?(i+=t.normal.y*this.min.y,s+=t.normal.y*this.max.y):(i+=t.normal.y*this.max.y,s+=t.normal.y*this.min.y),t.normal.z>0?(i+=t.normal.z*this.min.z,s+=t.normal.z*this.max.z):(i+=t.normal.z*this.max.z,s+=t.normal.z*this.min.z),i<=-t.constant&&s>=-t.constant}clone(){return new I(this.p0.clone(),this.p1.clone())}static create(...t){return new I(...t)}static sizeInBytes(){return 24}toJSON(){return{p0:this.p0.toJSON(),p1:this.p1.toJSON()}}fromJSON(t){this.p0.fromJSON(t.p0),this.p1.fromJSON(t.p1)}loadBin(t,i){this.p0.loadBin(t,i),this.p0.loadBin(t,i+12)}setFromFloat32Array(t){this.p0=new u(t.buffer,t.byteOffset),this.p1=new u(t.buffer,t.byteOffset+12)}toString(){return o(this.toJSON())}}r.registerType("Box3",I);class S extends a{constructor(t,i=0){super(),this.normal=t instanceof u?t:new u,this.w=i}set(t,i,s,e){this.normal.set(t,i,s),this.w=e}divideScalar(t){this.normal.scaleInPlace(1/t),this.w/=t}distanceToPoint(t){return t.dot(this.normal)+this.w}normalizeInPlace(){const t=1/this.normal.length();this.normal.scaleInPlace(t),this.w*=t}clone(){return new Plane(this.normal.clone(),this.w)}static create(...t){return new Plane(...t)}toJSON(){return{normal:this.normal.toJSON(),w:this.w}}toString(){return o(this.toJSON())}}r.registerType("PlaneType",S);class L{constructor(t,i,s,e,n,l){this.planes=[t||new S,i||new S,s||new S,e||new S,n||new S,l||new S]}setFromMatrix(t){const i=t,s=this.planes;s[0].set(i.m03-i.m00,i.m13-i.m10,i.m23-i.m20,i.m33-i.m30),s[1].set(i.m03+i.m00,i.m13+i.m10,i.m23+i.m20,i.m33+i.m30),s[2].set(i.m03+i.m01,i.m13+i.m11,i.m23+i.m21,i.m33+i.m31),s[3].set(i.m03-i.m01,i.m13-i.m11,i.m23-i.m21,i.m33-i.m31),s[4].set(i.m03-i.m02,i.m13-i.m12,i.m23-i.m22,i.m33-i.m32),s[5].set(i.m03+i.m02,i.m13+i.m12,i.m23+i.m22,i.m33+i.m32),s.forEach(t=>t.normalizeInPlace())}intersectsBox(t){const i=new u,s=this.planes,{min:e,max:n}=t;for(let t=0;t<6;t++){const l=s[t];if(i.x=l.normal.x>0?n.x:e.x,i.y=l.normal.y>0?n.y:e.y,i.z=l.normal.z>0?n.z:e.z,l.distanceToPoint(i)<0)return!1}return!0}toJSON(){return{p0:this.p0.toJSON(),p1:this.p1.toJSON(),p2:this.p2.toJSON(),p3:this.p3.toJSON(),p4:this.p4.toJSON(),p5:this.p5.toJSON()}}fromJSON(t){this.p0.fromJSON(t.p0),this.p1.fromJSON(t.p1),this.p2.fromJSON(t.p2),this.p3.fromJSON(t.p3),this.p4.fromJSON(t.p4),this.p5.fromJSON(t.p5)}toString(){return o(this.toJSON())}}r.registerType("Frustum",L);var x=Object.freeze({__proto__:null,UInt8:0,SInt8:1,SInt16:3,UInt16:2,SInt32:5,UInt32:4,Float32:6,hashStr:h,JSON_stringify_fixedPrecision:o,AttrValue:a,Vec2:d,Vec3:u,Vec4:m,RGBA:Z,Color:p,EulerAngles:G,Quat:f,Ray:V,Mat3:X,Mat4:y,Xfo:g,Box2:R,Box3:I,Frustum:L,PlaneType:S,SphereType:W,typeRegistry:r});class v{constructor(t=!1){this.__slots=[],this.__toggledSignal=t,this.__toggled=!1,this.__data=null,this.connect=this.connect.bind(this),this.disconnect=this.disconnect.bind(this),this.emit=this.emit.bind(this)}connect(t){if(null==t)throw new Error("a function callback must be passed to Signal.connect");if(-1!=this.__slots.indexOf(t))return void console.warn("fn '"+t.name+"' already connected to Signal.");const i=this.__slots.length;return this.__slots[i]=t,this.__toggledSignal&&this.__toggled&&(this.__data?t(...this.__data):t()),i}disconnect(t){if(null==t)throw new Error("a function callback must be passed to Signal.disconnect");const i=[];if(this.__slots.forEach((function(s,e){s===t&&i.push(e)})),0!=i.length)for(const t of i)this.__slots[t]=void 0;else console.warn("callback :"+t.name+" was not connected to this signal:"+this.__name)}disconnectId(t){if(!this.__slots[t])throw new Error("Invalid ID");this.__slots[t]=void 0}emit(...t){this.__toggledSignal&&(this.__toggled?console.warn("Toggled signals should only be fired once, or untoggled before re-firing.."):(this.__toggled=!0,this.__data=t));const i=this.__slots.length;for(let s=0;s<i;s++){const i=this.__slots[s];i&&i(...t)}}isToggled(){return this.__toggled}setToggled(t){this.__toggled=t,this.__data=void 0}getNumConnections(){return this.__slots.length}untoggle(){this.__toggled=!1,this.__data=void 0}}class Y{constructor(t=0,i=0){this.root={x:0,y:0,w:t,h:i},this.resized=new v}fit(t){if(0==t.length)return;let i=!1;this.root.w<t[0].w&&(this.root.w=t[0].w,i=!0),this.root.h<t[0].h&&(this.root.h=t[0].h,i=!0),i&&this.resized.emit(this.root.w,this.root.h),t.forEach(t=>{t.fit=this.__addBlock(t)})}__addBlock(t){const i=this.findNode(this.root,t.w,t.h);return i?this.splitNode(i,t.w,t.h):this.growNode(t.w,t.h)}addBlock(t){let i=!1;this.root.w<t.w&&(this.root.w=t.w,i=!0),this.root.h<t.h&&(this.root.h=t.h,i=!0),i&&this.resized.emit(this.root.w,this.root.h);const s=this.findNode(this.root,t.w,t.h);return s?this.splitNode(s,t.w,t.h):this.growNode(t.w,t.h)}findNode(t,i,s){return t.used?this.findNode(t.right,i,s)||this.findNode(t.down,i,s):i<=t.w&&s<=t.h?t:null}splitNode(t,i,s){return t.used=!0,t.down={x:t.x,y:t.y+s,w:t.w,h:t.h-s},t.right={x:t.x+i,y:t.y,w:t.w-i,h:s},t}growNode(t,i){const s=t<=this.root.w,e=i<=this.root.h,n=s&&this.root.w>=this.root.h+i;return e&&this.root.h>=this.root.w+t?this.growRight(t,i):n?this.growDown(t,i):e?this.growRight(t,i):s?this.growDown(t,i):null}growRight(t,i){this.root={used:!0,x:0,y:0,w:this.root.w+t,h:this.root.h,down:this.root,right:{x:this.root.w,y:0,w:t,h:this.root.h}};const s=this.findNode(this.root,t,i);let e;return s&&(e=this.splitNode(s,t,i)),this.resized.emit(this.root.w,this.root.h),e}growDown(t,i){this.root={used:!0,x:0,y:0,w:this.root.w,h:this.root.h+i,down:{x:0,y:this.root.h,w:this.root.w,h:i},right:this.root};const s=this.findNode(this.root,t,i);let e;return s&&(e=this.splitNode(s,t,i)),this.resized.emit(this.root.w,this.root.h),e}}class M{constructor(t=0){this.__asyncCount=t,this.ready=new v(!0),this.incAsyncCount=function(t=1){this.__asyncCount+=t,this.ready.setToggled(!1)}.bind(this),this.decAsyncCount=function(){this.__asyncCount>0&&(this.__asyncCount--,0==this.__asyncCount&&this.__asyncsCompleted())}.bind(this),this.__asyncsCompleted=function(){this.ready.emit()}.bind(this)}get count(){return this.__asyncCount}}const K=t=>{if(window.TextDecoder)return new TextDecoder("utf-8").decode(t);{let i="";for(let s=0;s<t.length;s++)i+=String.fromCharCode(t[s]);return i}};var C=Object.freeze({__proto__:null,GrowingPacker:Y,Async:M,Signal:v,decodeText:K});let w=0;class F{constructor(){if("RefCounted"==this.constructor.name)throw new Error("RefCounted should not be instantiated directly.");this.__id=++w,this.__refs=[],this.destructing=new v,this.__destroyed=!1}getId(){return this.__id}numRefs(){return this.__refs.length}addRef(t){if(!t)throw new Error("Error in RefCounted.addRef: Must provide a referer");return this.__refs.push(t),!0}removeRef(t){if(!t)throw new Error("Error in RefCounted.removeRef: Must provide a referer");const i=this.__refs.indexOf(t);if(-1==i)throw new Error("Error in RefCounted.removeRef: referer not found in refs list.");this.__refs.splice(i,1),0==this.__refs.length&&this.destroy()}getRefer(t){return this.__refs[t]}getRefIndex(t){return this.__refs.indexOf(t)}isDestroyed(){return this.__destroyed}destroy(){this.__destroyed=!0,this.destructing.emit(this)}}const N=new class{constructor(){this.__registeredClasses={},this.__classNames={}}registerClass(t,i){this.__registeredClasses[t]={cls:i,callbacks:[]},this.__classNames[i.name]=t}registerCallback(t,i){const s=this.__registeredClasses[t];s?s.callbacks.push(i):console.warn("Factory not registered:"+t)}getClass(t){if(this.__registeredClasses[t])return this.__registeredClasses[t].cls}getClassName(t){return this.__classNames[t.constructor.name]?this.__classNames[t.constructor.name]:t.constructor.name}isConstructing(){return this.__constructing}constructClass(t){const i=this.__registeredClasses[t];if(!i)return console.warn("Factory not registered:"+t),null;this.__constructing=!0;const s=Array.prototype.slice.call(arguments,1),e=new i.cls(...s);return this.__constructing=!1,this.invokeCallbacks(e),e}invokeCallbacks(t){if(this.__classNames[t.constructor.name]){const i=this.__registeredClasses[this.__classNames[t.constructor.name]];for(const s of i.callbacks)s(t)}}},T={NORMAL:0,OPERATOR_GETVALUE:1},J={USER_SETVALUE:0,REMOTEUSER_SETVALUE:1,USER_SETVALUE_DONE:2,OPERATOR_SETVALUE:3,OPERATOR_DIRTIED:4,COMPUTED_VALUE:4,GENERATED_VALUE:4,DATA_LOAD:4},z={USER_EDITED:2,DISABLED:4};class H{constructor(t){this.__name=t,this.__cleanerFns=[],this.__boundOps=[],this.__state=0,this.__flags=0,this.valueChanged=new v,this.nameChanged=new v,this.getName=this.getName.bind(this),this.setName=this.setName.bind(this),this.getValue=this.getValue.bind(this),this.setValue=this.setValue.bind(this)}getName(){return this.__name}setName(t){if(t!=this.__name){const i=this.__name;this.__name=t,this.nameChanged.emit(this.__name,i)}}getOwner(){return this.ownerItem}addOwner(t){this.ownerItem=t}getPath(){const t=this.getOwner();if(t&&t.getName){if(t.getPath){const i=t.getPath().slice();return i.push(this.__name),i}return[t.getName(),this.__name]}return[this.__name]}setFlag(t){this.__flags|=t}clearFlag(t){this.__flags&=~t}testFlag(t){return 0!=(this.__flags&t)}getValue(){}setValue(t){}setEnabled(t){console.warn("Deprecated Method: This method will be removed soon."),t?this.setFlag(z.DISABLED):this.clearFlag(z.DISABLED)}isEnabled(){console.warn("Deprecated Method: This method will be removed soon."),this.testFlag(z.DISABLED)}bindOperator(t){this.__boundOps.push(t),this.__state=1,this.valueChanged.emit(J.OPERATOR_DIRTIED)}unbindOperator(t){const i=this.__boundOps.indexOf(t);if(-1==i)return!1;this.__boundOps.splice(i,1),this.__state=1,this.valueChanged.emit(J.OPERATOR_DIRTIED)}setDirty(t){return-1==this.__cleanerFns.indexOf(t)&&(this.__cleanerFns.push(t),this.__state=1,this.valueChanged.emit(J.OPERATOR_DIRTIED),!0)}setDirtyFromOp(){return 0==this.__state&&(this.__state=1,this.valueChanged.emit(J.OPERATOR_DIRTIED)),!0}isDirty(){return 1==this.__state}_clean(){this.__state=2;const t=this.__cleanerFns;this.__cleanerFns=[];for(const i of t){const t=i(this.__value);null!=t&&(this.__value=t)}for(const t of this.__boundOps)t.evaluate();this.__state=0}removeCleanerFn(t){const i=this.__cleanerFns.indexOf(t);if(-1==i)return 0;this.__cleanerFns.splice(i,1)}clone(t){console.error("TOOD: implment me")}destroy(){}}class U extends H{constructor(t,i,s){super(t),this.__value=i,this.__dataType=s||i.constructor.name}getDataType(){return this.__dataType}getValue(t=T.NORMAL){return 1==this.__state&&this._clean(),this.__value}setClean(t){this.__value=t}setValue(t,i=J.USER_SETVALUE){this.__cleanerFns.length>0&&(this.__cleanerFns=[]),(t.fromJSON||this.__value!=t)&&(this.__value=t,i!=J.USER_SETVALUE&&i!=J.REMOTEUSER_SETVALUE||this.setFlag(z.USER_EDITED),i!=J.OPERATOR_SETVALUE&&this.valueChanged.emit(i))}setValueDone(){this.valueChanged.emit(J.USER_SETVALUE_DONE)}toJSON(t,i){return this.__value.toJSON?{value:this.__value.toJSON(t,i)}:{value:this.__value}}fromJSON(t,i,s){null!=t.value?(this.setFlag(z.USER_EDITED),t.value.type&&null==this.__value&&(this.__value=N.constructClass(t.value.type)),null!=this.__value&&this.__value.fromJSON?(this.__value.fromJSON(t.value,i),this.valueChanged.emit(J.DATA_LOAD)):this.setValue(t.value,J.DATA_LOAD)):console.warn("Invalid Parameter JSON")}readBinary(t,i){console.error("TODO")}clone(t){const i=this.__value;return i.clone&&(i=i.clone()),new U(this.__name,i,this.__dataType)}}let k=0;class B{constructor(){this.__id=++k,this.__params=[],this.__paramMapping={},this.__paramSignalIds={},this.parameterAdded=new v,this.parameterRemoved=new v,this.parameterValueChanged=new v}getId(){return this.__id}numParameters(){return this.__params.length}getParameters(){return this.__params}getParameterIndex(t){return this.__paramMapping[t]}getParameterByIndex(t){return this.__params[t]}hasParameter(t){return t in this.__paramMapping}getParameter(t){const i=this.__paramMapping[t];return-1==i?null:this.__params[i]}__parameterValueChanged(t,i){this.parameterValueChanged.emit(t,i)}addParameter(t){const i=t.getName();return null!=this.__paramMapping[i]&&(console.warn("Replacing Parameter:"+i),this.removeParameter(i)),this.__paramSignalIds[i]=t.valueChanged.connect(i=>this.__parameterValueChanged(t,i)),this.__params.push(t),this.__paramMapping[i]=this.__params.length-1,this.parameterAdded.emit(i),t}insertParameter(t,i){const s=t.getName();null!=this.__paramMapping[s]&&(console.warn("Replacing Parameter:"+s),this.removeParameter(s)),this.__paramSignalIds[s]=t.valueChanged.connect(i=>this.__parameterValueChanged(t,i)),this.__params.splice(i,0,t);const e={};for(let t=0;t<this.__params.length;t++)e[this.__params[t].getName()]=t;return this.__paramMapping=e,this.parameterAdded.emit(s),t}removeParameter(t){null==this.__paramMapping[t]&&console.throw("Unable to Remove Parameter:"+t);const i=this.__paramMapping[t];this.__params[this.__paramMapping[t]].valueChanged.disconnectId(this.__paramSignalIds[t]),this.__params.splice(i,1);const s={};for(let t=0;t<this.__params.length;t++)s[this.__params[t].getName()]=t;this.__paramMapping=s,this.parameterRemoved.emit(t)}replaceParameter(t){const i=t.getName(),s=this.__paramMapping[i];return this.__params[this.__paramMapping[i]].valueChanged.disconnectId(this.__paramSignalIds[i]),this.__paramSignalIds[i]=t.valueChanged.connect(i=>this.__parameterValueChanged(t,i)),this.__params[s]=t,t}toJSON(t,i){const s={};let e=0;for(const n of this.__params)if(n.testFlag(z.USER_EDITED))if(n.numRefs()>1&&0!=n.getRefIndex(this))s[n.getName()]={paramPath:t.makeRelative(n.getPath())},e++;else{const l=n.toJSON(t,i);l&&(s[n.getName()]=l,e++)}if(e>0)return{params:s}}fromJSON(t,i,s){if(t.params)for(const s in t.params){const e=t.params[s],n=this.getParameter(s);n?e.paramPath?i.resolvePath(e.paramPath,t=>{this.replaceParameter(t)},()=>{console.warn("Unable to resolve shared parameter:"+e.paramPath)}):n.fromJSON(e,i):console.warn("Param not found:"+s)}}readBinary(t,i){if(i.versions["zea-engine"].greaterOrEqualThan([0,0,3])){const s=t.loadUInt32();for(let e=0;e<s;e++){const s=t.loadStr(),e=t.loadStr();let n=this.getParameter(e);if(!n){if(n=N.constructClass(s,e),!n){console.error("Unable to construct prop:"+e+" of type:"+s);continue}this.addParameter(n)}n.readBinary(t,i)}}}toString(){return JSON.stringify(this.toJSON(),null,2)}copyFrom(t,i){let s=t.numParameters();for(;s--;){const i=t.getParameterByIndex(s),e=this.getParameter(i.getName());e?e.setValue(i.getValue(),J.OPERATOR_SETVALUE):this.addParameter(i.clone())}}destroy(){for(const t of this.__params)t.destroy();super.destroy()}}const P={USER_EDITED:2,IGNORE_BBOX:4,BIN_NODE:8,INVISIBLE:16};let E=0;class Q extends B{constructor(t){super(),null==t&&(t=N.getClassName(this)),this.__name=t,this.__path=[t],this.__ownerItem=void 0,this.__flags=0,this.__selectable=!0,this.__selected=!1,this.selectedChanged=new v,this.__metaData={},this.nameChanged=new v,E++}static getNumBaseItems(){return E}__parameterValueChanged(t,i){super.__parameterValueChanged(t,i),i!=J.USER_SETVALUE&&i!=J.REMOTEUSER_SETVALUE||this.setFlag(P.USER_EDITED)}getName(){return this.__name}setName(t,i=J.USER_SETVALUE){if(this.__name!=t){const s=this.__name;this.__name=t,this.__updatePath(),this.nameChanged.emit(t,s,i)}}__updatePath(){null==this.__ownerItem?this.__path=[this.__name]:(this.__path=this.__ownerItem.getPath().slice(),this.__path.push(this.__name))}getPath(){return this.__path}setFlag(t){this.__flags|=t}clearFlag(t){this.__flags&=~t}testFlag(t){return 0!=(this.__flags&t)}resolvePath(t,i){if(i==t.length)return this;if(">"==t[i]&&i==t.length-1)return this.getParameter(t[i+1]);const s=this.getParameter(t[i]);if(s)return s;throw new Error("Invalid path:"+t+" member not found")}getOwner(){return this.__ownerItem}setOwner(t){this.__ownerItem!==t&&(this.__ownerItem=t,this.__updatePath())}getSelectable(){return this.__selectable}setSelectable(t){return this.__selectable!=t&&(this.__selectable=t,!0)}isSelected(){return this.__selected}getSelected(){return this.__selected}setSelected(t){this.__selected=t,this.selectedChanged.emit(this.__selected)}getMetadata(t){return this.__metaData[t]}hasMetadata(t){return t in this.__metaData}setMetadata(t,i){this.__metaData[t]=i}deleteMetadata(t){delete this.__metaData[t]}toJSON(t,i){let s=super.toJSON(t,i);return!s&&this.testFlag(P.USER_EDITED)&&(s={}),s&&(s.name=this.__name,this.testFlag(P.BIN_NODE)||(s.type=N.getClassName(this))),s}fromJSON(t,i,s){t.name&&(this.__name=t.name),super.fromJSON(t,i,s),this.__flags|=P.USER_EDITED}readBinary(t,i){t.loadStr(),this.setName(t.loadStr()),super.readBinary(t,i)}clone(t){throw new Error(this.constructor.name+" does not implment its clone method")}copyFrom(t,i){super.copyFrom(t,i),this.setName(t.getName())}destroy(){super.destroy()}}const D=function(t){return t.substring(0,t.lastIndexOf("/"))+"/"},O=function(t,i,s,e){const n=new XMLHttpRequest;n.responseType=i;try{n.addEventListener("timeout",(function(){throw new Error("The request for "+t+" timed out.")})),n.addEventListener("error",(function(){throw new Error("The request for "+t+": xhr.readyState:"+n.readyState)})),n.addEventListener("abort",(function(){throw new Error("The request for "+t+": xhr.readyState:"+n.readyState)})),n.addEventListener("loadend",(function(){200==n.status?s(n):e(n.statusText)})),n.open("GET",t,!0),n.send()}catch(t){e(t)}},A=function(t,i,s){O(t,"text",t=>{i(t.responseText)},i=>{if(null==s)throw new Error("Unable to XHR File:"+t);s(i)})},_=function(t,i,s){O(t,"json",t=>{i(t.response,t)},i=>{if(null==s)throw new Error("Unable to XHR File:"+t);s(i)})},q=function(t,i,s){O(t,"document",t=>{i(t.responseXML)},i=>{if(null==s)throw new Error("Unable to XHR File:"+t);s(i)})},$=function(t,i,s){O(t,"arraybuffer",t=>{i(t.response)},i=>{if(null==s)throw new Error("Unable to XHR File:"+t);s(i)})},tt="[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0),it=tt&&"function"==typeof t.require?t.require:null;function st(t,i=null,s=!1){const e=tt?function(t,i){return Buffer.from(t,"base64").toString(i?"utf16":"utf8")}(t,s):function(t,i){const s=atob(t);if(i){const t=new Uint8Array(s.length);return Array.prototype.forEach.call(t,(t,i,e)=>{e[i]=s.charCodeAt(i)}),String.fromCharCode.apply(null,new Uint16Array(t.buffer))}return s}(t,s),n=e.indexOf("\n",10)+1,l=e.substring(n)+(i?"//# sourceMappingURL="+i:"");if(it){const t=it("worker_threads").Worker;return function(i){return new t(l,Object.assign({},i,{eval:!0}))}}const h=new Blob([l],{type:"application/javascript"}),o=URL.createObjectURL(h);return function(t){return new Worker(o,t)}}const et=st("Lyogcm9sbHVwLXBsdWdpbi13ZWItd29ya2VyLWxvYWRlciAqLwpNb2R1bGU9e0VOVklST05NRU5UOiJXT1JLRVIifTtjb25zdCBlPXt9O3ZhciB0Oyh0PWUpLnVucGFja0JyaWRnZT1mdW5jdGlvbihlKXtyZXR1cm4gZnVuY3Rpb24oZSl7dmFyIHQ9e307ZnVuY3Rpb24gcihuKXtpZih0W25dKXJldHVybiB0W25dLmV4cG9ydHM7dmFyIG89dFtuXT17aTpuLGw6ITEsZXhwb3J0czp7fX07cmV0dXJuIGVbbl0uY2FsbChvLmV4cG9ydHMsbyxvLmV4cG9ydHMsciksby5sPSEwLG8uZXhwb3J0c31yZXR1cm4gci5tPWUsci5jPXQsci5kPWZ1bmN0aW9uKGUsdCxuKXtyLm8oZSx0KXx8T2JqZWN0LmRlZmluZVByb3BlcnR5KGUsdCx7ZW51bWVyYWJsZTohMCxnZXQ6bn0pfSxyLnI9ZnVuY3Rpb24oZSl7InVuZGVmaW5lZCIhPXR5cGVvZiBTeW1ib2wmJlN5bWJvbC50b1N0cmluZ1RhZyYmT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsU3ltYm9sLnRvU3RyaW5nVGFnLHt2YWx1ZToiTW9kdWxlIn0pLE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCJfX2VzTW9kdWxlIix7dmFsdWU6ITB9KX0sci50PWZ1bmN0aW9uKGUsdCl7aWYoMSZ0JiYoZT1yKGUpKSw4JnQpcmV0dXJuIGU7aWYoNCZ0JiYib2JqZWN0Ij09dHlwZW9mIGUmJmUmJmUuX19lc01vZHVsZSlyZXR1cm4gZTt2YXIgbj1PYmplY3QuY3JlYXRlKG51bGwpO2lmKHIucihuKSxPYmplY3QuZGVmaW5lUHJvcGVydHkobiwiZGVmYXVsdCIse2VudW1lcmFibGU6ITAsdmFsdWU6ZX0pLDImdCYmInN0cmluZyIhPXR5cGVvZiBlKWZvcih2YXIgbyBpbiBlKXIuZChuLG8sZnVuY3Rpb24odCl7cmV0dXJuIGVbdF19LmJpbmQobnVsbCxvKSk7cmV0dXJuIG59LHIubj1mdW5jdGlvbihlKXt2YXIgdD1lJiZlLl9fZXNNb2R1bGU/ZnVuY3Rpb24oKXtyZXR1cm4gZS5kZWZhdWx0fTpmdW5jdGlvbigpe3JldHVybiBlfTtyZXR1cm4gci5kKHQsImEiLHQpLHR9LHIubz1mdW5jdGlvbihlLHQpe3JldHVybiBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoZSx0KX0sci5wPSIiLHIoci5zPTIpfShbZnVuY3Rpb24oZSx0LHIpe09iamVjdC5kZWZpbmVQcm9wZXJ0eSh0LCJfX2VzTW9kdWxlIix7dmFsdWU6ITB9KTtjb25zdCBvPXIoMSksaT17MDoiRVJBUl9TVUNDRVNTIiwxMDoiRVJBUl9FTkRfQVJDSElWRSIsMTE6IkVSQVJfTk9fTUVNT1JZIiwxMjoiRVJBUl9CQURfREFUQSIsMTM6IkVSQVJfQkFEX0FSQ0hJVkUiLDE0OiJFUkFSX1VOS05PV05fRk9STUFUIiwxNToiRVJBUl9FT1BFTiIsMTY6IkVSQVJfRUNSRUFURSIsMTc6IkVSQVJfRUNMT1NFIiwxODoiRVJBUl9FUkVBRCIsMTk6IkVSQVJfRVdSSVRFIiwyMDoiRVJBUl9TTUFMTF9CVUYiLDIxOiJFUkFSX1VOS05PV04iLDIyOiJFUkFSX01JU1NJTkdfUEFTU1dPUkQiLDIzOiJFUkFSX0VSRUZFUkVOQ0UiLDI0OiJFUkFSX0JBRF9QQVNTV09SRCJ9LGE9ezA6IlN1Y2Nlc3MiLDExOiJOb3QgZW5vdWdoIG1lbW9yeSIsMTI6IkFyY2hpdmUgaGVhZGVyIG9yIGRhdGEgYXJlIGRhbWFnZWQiLDEzOiJGaWxlIGlzIG5vdCBSQVIgYXJjaGl2ZSIsMTQ6IlVua25vd24gYXJjaGl2ZSBmb3JtYXQiLDE1OiJGaWxlIG9wZW4gZXJyb3IiLDE2OiJGaWxlIGNyZWF0ZSBlcnJvciIsMTc6IkZpbGUgY2xvc2UgZXJyb3IiLDE4OiJGaWxlIHJlYWQgZXJyb3IiLDE5OiJGaWxlIHdyaXRlIGVycm9yIiwyMDoiQnVmZmVyIGZvciBhcmNoaXZlIGNvbW1lbnQgaXMgdG9vIHNtYWxsLCBjb21tZW50IHRydW5jYXRlZCIsMjE6IlVua25vd24gZXJyb3IiLDIyOiJQYXNzd29yZCBmb3IgZW5jcnlwdGVkIGZpbGUgb3IgaGVhZGVyIGlzIG5vdCBzcGVjaWZpZWQiLDIzOiJDYW5ub3Qgb3BlbiBmaWxlIHNvdXJjZSBmb3IgcmVmZXJlbmNlIHJlY29yZCIsMjQ6Ildyb25nIHBhc3N3b3JkIGlzIHNwZWNpZmllZCJ9O2NsYXNzIHN7Y29uc3RydWN0b3IoZT0iIil7dGhpcy5fcGFzc3dvcmQ9ZSx0aGlzLl9hcmNoaXZlPW51bGx9Z2V0RmlsZUxpc3QoKXtsZXQgZSxbdCxyXT10aGlzLm9wZW5BcmMoITApO2lmKCJTVUNDRVNTIiE9PXQuc3RhdGUpZT1bdCxudWxsXTtlbHNle2xldCB0LG4sbz1bXTtmb3IoO1t0LG5dPXRoaXMucHJvY2Vzc05leHRGaWxlKCgpPT4hMCksIlNVQ0NFU1MiPT09dC5zdGF0ZTspby5wdXNoKG4uZmlsZUhlYWRlcik7ZT0iRVJBUl9FTkRfQVJDSElWRSIhPT10LnJlYXNvbj9bdCxudWxsXTpbe3N0YXRlOiJTVUNDRVNTIn0se2FyY0hlYWRlcjpyLGZpbGVIZWFkZXJzOm99XX1yZXR1cm4gdGhpcy5jbG9zZUFyYygpLGV9ZXh0cmFjdEFsbCgpe2xldCBlLFt0LHJdPXRoaXMub3BlbkFyYyghMSk7aWYoIlNVQ0NFU1MiIT09dC5zdGF0ZSllPVt0LG51bGxdO2Vsc2V7bGV0IHQsbixvPVtdO2Zvcig7W3Qsbl09dGhpcy5wcm9jZXNzTmV4dEZpbGUoKCk9PiExKSwiU1VDQ0VTUyI9PT10LnN0YXRlOylvLnB1c2gobik7ZT0iRVJBUl9FTkRfQVJDSElWRSIhPT10LnJlYXNvbj9bdCxudWxsXTpbe3N0YXRlOiJTVUNDRVNTIn0se2FyY0hlYWRlcjpyLGZpbGVzOm99XX1yZXR1cm4gdGhpcy5jbG9zZUFyYygpLGV9ZXh0cmFjdEZpbGVzKGUsdCl7bGV0IHIsW24sb109dGhpcy5vcGVuQXJjKCExLHQpLGk9e307Zm9yKGxldCB0PTA7dDxlLmxlbmd0aDsrK3QpaVtlW3RdXT10O2lmKCJTVUNDRVNTIiE9PW4uc3RhdGUpcj1bbixudWxsXTtlbHNle2xldCB0LG4sYT1BcnJheShlLmxlbmd0aCkuZmlsbChudWxsKSxzPTA7Zm9yKDs7KXtsZXQgcj0hMSxvPW51bGw7aWYoW3Qsbl09dGhpcy5wcm9jZXNzTmV4dEZpbGUoZT0+ZSBpbiBpPyhvPWlbZV0sITEpOihyPSEwLCEwKSksIlNVQ0NFU1MiIT09dC5zdGF0ZSlicmVhaztpZighciYmKGFbb109biwrK3M9PT1lLmxlbmd0aCkpe3QucmVhc29uPSJFUkFSX0VORF9BUkNISVZFIjticmVha319cj0iRVJBUl9FTkRfQVJDSElWRSIhPT10LnJlYXNvbj9bdCxudWxsXTpbe3N0YXRlOiJTVUNDRVNTIn0se2FyY0hlYWRlcjpvLGZpbGVzOmF9XX1yZXR1cm4gdGhpcy5jbG9zZUFyYygpLHJ9ZmlsZUNyZWF0ZWQoZSl7fWNsb3NlKGUpe3RoaXMuX2xhc3RGaWxlQ29udGVudD10aGlzLmNsb3NlRmlsZShlKX1vcGVuQXJjKGUsdCl7by5FeHQuY3VycmVudD10aGlzLHRoaXMuX2FyY2hpdmU9bmV3IG4uUmFyQXJjaGl2ZTtsZXQgcixpPXRoaXMuX2FyY2hpdmUub3Blbih0aGlzLl9maWxlUGF0aCx0fHx0aGlzLl9wYXNzd29yZCxlKTtyZXR1cm4gcj0wIT09aS5zdGF0ZS5lcnJDb2RlP1t0aGlzLmdldEZhaWxJbmZvKGkuc3RhdGUuZXJyQ29kZSxpLnN0YXRlLmVyclR5cGUpLG51bGxdOlt7c3RhdGU6IlNVQ0NFU1MifSx7Y29tbWVudDppLmNvbW1lbnQsZmxhZ3M6e3ZvbHVtZTowIT0oMSZpLmZsYWdzKSxsb2NrOjAhPSg0JmkuZmxhZ3MpLHNvbGlkOjAhPSg4JmkuZmxhZ3MpLGF1dGhJbmZvOjAhPSgzMiZpLmZsYWdzKSxyZWNvdmVyeVJlY29yZDowIT0oNjQmaS5mbGFncyksaGVhZGVyRW5jcnlwdGVkOjAhPSgxMjgmaS5mbGFncyl9fV0sby5FeHQuY3VycmVudD1udWxsLHJ9cHJvY2Vzc05leHRGaWxlKGUpe2xldCB0O28uRXh0LmN1cnJlbnQ9dGhpcztsZXQgcj10aGlzLl9hcmNoaXZlLmdldEZpbGVIZWFkZXIoKSxuPVt7c3RhdGU6IlNVQ0NFU1MifSxudWxsXTtpZigwPT09ci5zdGF0ZS5lcnJDb2RlKXtsZXQgdD1lKHIubmFtZSk7dGhpcy5fbGFzdEZpbGVDb250ZW50PW51bGw7bGV0IG89dGhpcy5fYXJjaGl2ZS5yZWFkRmlsZSh0KTswPT09by5lcnJDb2RlfHx0fHwoblswXT10aGlzLmdldEZhaWxJbmZvKG8uZXJyQ29kZSxvLmVyclR5cGUpLDIyPT09by5lcnJDb2RlP289dGhpcy5fYXJjaGl2ZS5yZWFkRmlsZSghMCk6by5lcnJDb2RlPTApLDA9PT1vLmVyckNvZGU/blsxXT10aGlzLl9sYXN0RmlsZUNvbnRlbnQ6KHIuc3RhdGUuZXJyQ29kZT1vLmVyckNvZGUsci5zdGF0ZS5lcnJUeXBlPW8uZXJyVHlwZSksdGhpcy5fbGFzdEZpbGVDb250ZW50PW51bGx9cmV0dXJuIHQ9MCE9PXIuc3RhdGUuZXJyQ29kZT9bdGhpcy5nZXRGYWlsSW5mbyhyLnN0YXRlLmVyckNvZGUsci5zdGF0ZS5lcnJUeXBlKSxudWxsXTpbe3N0YXRlOiJTVUNDRVNTIn0se2ZpbGVIZWFkZXI6e25hbWU6ci5uYW1lLGZsYWdzOntlbmNyeXB0ZWQ6MCE9KDQmci5mbGFncyksc29saWQ6MCE9KDE2JnIuZmxhZ3MpLGRpcmVjdG9yeTowIT0oMzImci5mbGFncyl9LHBhY2tTaXplOnIucGFja1NpemUsdW5wU2l6ZTpyLnVucFNpemUsY3JjOnIuY3JjLHRpbWU6ZnVuY3Rpb24oZSl7Y29uc3QgdD1bNSw2LDUsNSw0LDddO2xldCByPVtdO2ZvcihsZXQgbiBvZiB0KXIucHVzaChlJigxPDxuKS0xKSxlPj49bjtsZXQgbj1lPT5lPDEwPyIwIitlOiIiK2U7cmV0dXJuYCR7MTk4MCsocj1yLnJldmVyc2UoKSlbMF19LSR7bihyWzFdKX0tJHtuKHJbMl0pfWArYFQke24oclszXSl9OiR7bihyWzRdKX06JHtuKDIqcls1XSl9LjAwMGB9KHIudGltZSksdW5wVmVyOmAke01hdGguZmxvb3Ioci51bnBWZXIvMTApfS4ke3IudW5wVmVyJTEwfWAsbWV0aG9kOmZ1bmN0aW9uKGUpe3JldHVybns0ODoiU3RvcmluZyIsNDk6IkZhc3Rlc3QiLDUwOiJGYXN0Iiw1MToiTm9ybWFsIiw1MjoiR29vZCIsNTM6IkJlc3QifVtlXXx8IlVua25vd24ifShyLm1ldGhvZCl9LGV4dHJhY3Q6bn1dLG8uRXh0LmN1cnJlbnQ9bnVsbCx0fWNsb3NlQXJjKCl7by5FeHQuY3VycmVudD10aGlzLHRoaXMuX2FyY2hpdmUuZGVsZXRlKCksby5FeHQuY3VycmVudD1udWxsLHRoaXMuX2FyY2hpdmU9bnVsbH1nZXRGYWlsSW5mbyhlLHQpe3JldHVybntzdGF0ZToiRkFJTCIscmVhc29uOmlbZV0sbXNnOmFbZV19fX1zLl9jdXJyZW50PW51bGwsdC5FeHRyYWN0b3I9c30sZnVuY3Rpb24oZSx0LHIpe09iamVjdC5kZWZpbmVQcm9wZXJ0eSh0LCJfX2VzTW9kdWxlIix7dmFsdWU6ITB9KSx0LkV4dD17Y3VycmVudDpudWxsfX0sZnVuY3Rpb24oZSx0LHIpe09iamVjdC5kZWZpbmVQcm9wZXJ0eSh0LCJfX2VzTW9kdWxlIix7dmFsdWU6ITB9KSxmdW5jdGlvbihlKXtmb3IodmFyIHIgaW4gZSl0Lmhhc093blByb3BlcnR5KHIpfHwodFtyXT1lW3JdKX0ocigzKSk7dmFyIG49cigxKTt0LkV4dD1uLkV4dH0sZnVuY3Rpb24oZSx0LHIpe09iamVjdC5kZWZpbmVQcm9wZXJ0eSh0LCJfX2VzTW9kdWxlIix7dmFsdWU6ITB9KTtjb25zdCBuPXIoNCksbz1yKDYpO3QuY3JlYXRlRXh0cmFjdG9yRnJvbURhdGE9ZnVuY3Rpb24oZSx0PSIiKXtyZXR1cm4gbmV3IG4uRGF0YUV4dHJhY3RvcihlLHQpfSx0LmNyZWF0ZUV4dHJhY3RvckZyb21GaWxlPWZ1bmN0aW9uKGUsdD0iIixyPSIiKXtyZXR1cm4gbmV3IG8uRmlsZUV4dHJhY3RvcihlLHQscil9fSxmdW5jdGlvbihlLHQscil7T2JqZWN0LmRlZmluZVByb3BlcnR5KHQsIl9fZXNNb2R1bGUiLHt2YWx1ZTohMH0pO2NvbnN0IG89cig1KSxpPXIoMCk7dC5EYXRhRXh0cmFjdG9yPWNsYXNzIGV4dGVuZHMgaS5FeHRyYWN0b3J7Y29uc3RydWN0b3IoZSx0KXtzdXBlcih0KSx0aGlzLmRhdGFGaWxlcz17fSx0aGlzLmRhdGFGaWxlTWFwPXt9LHRoaXMuY3VycmVudEZkPTE7bGV0IHI9e2ZpbGU6bmV3IG8uRGF0YUZpbGUobmV3IFVpbnQ4QXJyYXkoZSkpLGZkOnRoaXMuY3VycmVudEZkKyt9O3RoaXMuX2ZpbGVQYXRoPSJfZGVmYXVsdFVucmFySlNfLnJhciIsdGhpcy5kYXRhRmlsZXNbdGhpcy5fZmlsZVBhdGhdPXIsdGhpcy5kYXRhRmlsZU1hcFtyLmZkXT10aGlzLl9maWxlUGF0aH1vcGVuKGUpe2xldCB0PXRoaXMuZGF0YUZpbGVzW2VdO3JldHVybiB0P3QuZmQ6MH1jcmVhdGUoZSl7bGV0IHQ9dGhpcy5jdXJyZW50RmQrKztyZXR1cm4gdGhpcy5kYXRhRmlsZXNbZV09e2ZpbGU6bmV3IG8uRGF0YUZpbGUsZmQ6dGhpcy5jdXJyZW50RmQrK30sdGhpcy5kYXRhRmlsZU1hcFt0XT1lLHR9Y2xvc2VGaWxlKGUpe2xldCB0PXRoaXMuZGF0YUZpbGVzW3RoaXMuZGF0YUZpbGVNYXBbZV1dO2lmKCF0KXJldHVybiBudWxsO2xldCByPXQuZmlsZS5yZWFkQWxsKCk7cmV0dXJuIDEhPT1lPyhkZWxldGUgdGhpcy5kYXRhRmlsZXNbdGhpcy5kYXRhRmlsZU1hcFtlXV0sZGVsZXRlIHRoaXMuZGF0YUZpbGVNYXBbZV0pOnQuZmlsZS5zZWVrKDAsIlNFVCIpLHJ9cmVhZChlLHQscil7bGV0IG89dGhpcy5kYXRhRmlsZXNbdGhpcy5kYXRhRmlsZU1hcFtlXV07aWYoIW8pcmV0dXJuLTE7bGV0IGk9by5maWxlLnJlYWQocik7cmV0dXJuIG51bGw9PT1pPy0xOihuLkhFQVBVOC5zZXQoaSx0KSxpLmJ5dGVMZW5ndGgpfXdyaXRlKGUsdCxyKXtsZXQgbz10aGlzLmRhdGFGaWxlc1t0aGlzLmRhdGFGaWxlTWFwW2VdXTtyZXR1cm4hIW8mJihvLmZpbGUud3JpdGUobi5IRUFQVTguc2xpY2UodCx0K3IpKSwhMCl9dGVsbChlKXtsZXQgdD10aGlzLmRhdGFGaWxlc1t0aGlzLmRhdGFGaWxlTWFwW2VdXTtyZXR1cm4gdD90LmZpbGUudGVsbCgpOi0xfXNlZWsoZSx0LHIpe2xldCBuPXRoaXMuZGF0YUZpbGVzW3RoaXMuZGF0YUZpbGVNYXBbZV1dO3JldHVybiEhbiYmbi5maWxlLnNlZWsodCxyKX19fSxmdW5jdGlvbihlLHQscil7T2JqZWN0LmRlZmluZVByb3BlcnR5KHQsIl9fZXNNb2R1bGUiLHt2YWx1ZTohMH0pLHQuRGF0YUZpbGU9Y2xhc3N7Y29uc3RydWN0b3IoZSl7dGhpcy5idWZmZXJzPVtdLHRoaXMucG9zPTAsdGhpcy5zaXplPTAsZSYmKHRoaXMuYnVmZmVycy5wdXNoKGUpLHRoaXMuc2l6ZT1lLmJ5dGVMZW5ndGgsdGhpcy5wb3M9MCl9cmVhZChlKXtpZih0aGlzLmZsYXR0ZW4oKSxlK3RoaXMucG9zPnRoaXMuc2l6ZSlyZXR1cm4gbnVsbDtsZXQgdD10aGlzLnBvcztyZXR1cm4gdGhpcy5wb3MrPWUsdGhpcy5idWZmZXJzWzBdLnNsaWNlKHQsdGhpcy5wb3MpfXJlYWRBbGwoKXtyZXR1cm4gdGhpcy5mbGF0dGVuKCksdGhpcy5idWZmZXJzWzBdfXdyaXRlKGUpe3JldHVybiB0aGlzLmJ1ZmZlcnMucHVzaChlKSx0aGlzLnNpemUrPWUuYnl0ZUxlbmd0aCx0aGlzLnBvcys9ZS5ieXRlTGVuZ3RoLCEwfXRlbGwoKXtyZXR1cm4gdGhpcy5wb3N9c2VlayhlLHQpe2xldCByPXRoaXMucG9zO3JldHVybiJTRVQiPT09dD9yPWU6IkNVUiI9PT10P3IrPWU6cj10aGlzLnNpemUtZSwhKHI8MHx8cj50aGlzLnNpemV8fCh0aGlzLnBvcz1yLDApKX1mbGF0dGVuKCl7aWYodGhpcy5idWZmZXJzLmxlbmd0aDw9MSlyZXR1cm47bGV0IGU9bmV3IFVpbnQ4QXJyYXkodGhpcy5zaXplKSx0PTA7Zm9yKGxldCByIG9mIHRoaXMuYnVmZmVycyllLnNldChyLHQpLHQrPXIuYnl0ZUxlbmd0aDt0aGlzLmJ1ZmZlcnM9W2VdfX19LGZ1bmN0aW9uKGUsdCxyKXsoZnVuY3Rpb24oZSl7T2JqZWN0LmRlZmluZVByb3BlcnR5KHQsIl9fZXNNb2R1bGUiLHt2YWx1ZTohMH0pO2NvbnN0IG89cigxMiksaT1yKDEzKSxhPXIoMCk7dC5GaWxlRXh0cmFjdG9yPWNsYXNzIGV4dGVuZHMgYS5FeHRyYWN0b3J7Y29uc3RydWN0b3IoZSx0LHIpe3N1cGVyKHIpLHRoaXMuX2ZpbGVQYXRoPWUsdGhpcy5maWxlTWFwPXt9LHRoaXMuX3RhcmdldD10fW9wZW4oZSl7bGV0IHQ9by5vcGVuU3luYyhlLCJyIik7cmV0dXJuIHRoaXMuZmlsZU1hcFt0XT17c2l6ZTpvLmZzdGF0U3luYyh0KS5zaXplLHBvczowLG5hbWU6ZX0sdH1jcmVhdGUoZSl7bGV0IHQ9aS5qb2luKHRoaXMuX3RhcmdldCxlKTtpLnBhcnNlKHQpLmRpci5zcGxpdCgiLyIpLnJlZHVjZSgoZSx0KT0+KGUrPXQrIi8iLG8uZXhpc3RzU3luYyhlKXx8by5ta2RpclN5bmMoZSksZSksIiIpO2xldCByPW8ub3BlblN5bmModCwidyIpO3JldHVybiB0aGlzLmZpbGVNYXBbcl09e3NpemU6MCxwb3M6MCxuYW1lOmV9LHJ9Y2xvc2VGaWxlKGUpe3JldHVybiBkZWxldGUgdGhpcy5maWxlTWFwW2VdLG8uY2xvc2VTeW5jKGUpLG51bGx9cmVhZCh0LHIsaSl7bGV0IGE9dGhpcy5maWxlTWFwW3RdLHM9bmV3IGUoaSksdT1vLnJlYWRTeW5jKHQscywwLGksYS5wb3MpO3JldHVybiBuLkhFQVBVOC5zZXQocyxyKSxhLnBvcys9dSx1fXdyaXRlKHQscixpKXtsZXQgYT10aGlzLmZpbGVNYXBbdF0scz1vLndyaXRlU3luYyh0LG5ldyBlKG4uSEVBUFU4LnN1YmFycmF5KHIscitpKSksMCxpKTtyZXR1cm4gYS5wb3MrPXMsYS5zaXplKz1zLHM9PT1pfXRlbGwoZSl7cmV0dXJuIHRoaXMuZmlsZU1hcFtlXS5wb3N9c2VlayhlLHQscil7bGV0IG49dGhpcy5maWxlTWFwW2VdLG89bi5wb3M7cmV0dXJuIlNFVCI9PT1yP289MDoiRU5EIj09PXImJihvPW4uc2l6ZSksISgobys9dCk8MHx8bz5uLnNpemV8fChuLnBvcz1vLDApKX19fSkuY2FsbCh0aGlzLHIoNykuQnVmZmVyKX0sZnVuY3Rpb24oZSx0LHIpeyhmdW5jdGlvbihlKXsKLyohCiAqIFRoZSBidWZmZXIgbW9kdWxlIGZyb20gbm9kZS5qcywgZm9yIHRoZSBicm93c2VyLgogKgogKiBAYXV0aG9yICAgRmVyb3NzIEFib3VraGFkaWplaCA8ZmVyb3NzQGZlcm9zcy5vcmc+IDxodHRwOi8vZmVyb3NzLm9yZz4KICogQGxpY2Vuc2UgIE1JVAogKi8KdmFyIG49cig5KSxvPXIoMTApLGk9cigxMSk7ZnVuY3Rpb24gYSgpe3JldHVybiB1LlRZUEVEX0FSUkFZX1NVUFBPUlQ/MjE0NzQ4MzY0NzoxMDczNzQxODIzfWZ1bmN0aW9uIHMoZSx0KXtpZihhKCk8dCl0aHJvdyBuZXcgUmFuZ2VFcnJvcigiSW52YWxpZCB0eXBlZCBhcnJheSBsZW5ndGgiKTtyZXR1cm4gdS5UWVBFRF9BUlJBWV9TVVBQT1JUPyhlPW5ldyBVaW50OEFycmF5KHQpKS5fX3Byb3RvX189dS5wcm90b3R5cGU6KG51bGw9PT1lJiYoZT1uZXcgdSh0KSksZS5sZW5ndGg9dCksZX1mdW5jdGlvbiB1KGUsdCxyKXtpZighKHUuVFlQRURfQVJSQVlfU1VQUE9SVHx8dGhpcyBpbnN0YW5jZW9mIHUpKXJldHVybiBuZXcgdShlLHQscik7aWYoIm51bWJlciI9PXR5cGVvZiBlKXtpZigic3RyaW5nIj09dHlwZW9mIHQpdGhyb3cgbmV3IEVycm9yKCJJZiBlbmNvZGluZyBpcyBzcGVjaWZpZWQgdGhlbiB0aGUgZmlyc3QgYXJndW1lbnQgbXVzdCBiZSBhIHN0cmluZyIpO3JldHVybiBmKHRoaXMsZSl9cmV0dXJuIGModGhpcyxlLHQscil9ZnVuY3Rpb24gYyhlLHQscixuKXtpZigibnVtYmVyIj09dHlwZW9mIHQpdGhyb3cgbmV3IFR5cGVFcnJvcignInZhbHVlIiBhcmd1bWVudCBtdXN0IG5vdCBiZSBhIG51bWJlcicpO3JldHVybiJ1bmRlZmluZWQiIT10eXBlb2YgQXJyYXlCdWZmZXImJnQgaW5zdGFuY2VvZiBBcnJheUJ1ZmZlcj9mdW5jdGlvbihlLHQscixuKXtpZih0LmJ5dGVMZW5ndGgscjwwfHx0LmJ5dGVMZW5ndGg8cil0aHJvdyBuZXcgUmFuZ2VFcnJvcigiJ29mZnNldCcgaXMgb3V0IG9mIGJvdW5kcyIpO2lmKHQuYnl0ZUxlbmd0aDxyKyhufHwwKSl0aHJvdyBuZXcgUmFuZ2VFcnJvcigiJ2xlbmd0aCcgaXMgb3V0IG9mIGJvdW5kcyIpO3JldHVybiB0PXZvaWQgMD09PXImJnZvaWQgMD09PW4/bmV3IFVpbnQ4QXJyYXkodCk6dm9pZCAwPT09bj9uZXcgVWludDhBcnJheSh0LHIpOm5ldyBVaW50OEFycmF5KHQscixuKSx1LlRZUEVEX0FSUkFZX1NVUFBPUlQ/KGU9dCkuX19wcm90b19fPXUucHJvdG90eXBlOmU9ZChlLHQpLGV9KGUsdCxyLG4pOiJzdHJpbmciPT10eXBlb2YgdD9mdW5jdGlvbihlLHQscil7aWYoInN0cmluZyI9PXR5cGVvZiByJiYiIiE9PXJ8fChyPSJ1dGY4IiksIXUuaXNFbmNvZGluZyhyKSl0aHJvdyBuZXcgVHlwZUVycm9yKCciZW5jb2RpbmciIG11c3QgYmUgYSB2YWxpZCBzdHJpbmcgZW5jb2RpbmcnKTt2YXIgbj0wfHAodCxyKSxvPShlPXMoZSxuKSkud3JpdGUodCxyKTtyZXR1cm4gbyE9PW4mJihlPWUuc2xpY2UoMCxvKSksZX0oZSx0LHIpOmZ1bmN0aW9uKGUsdCl7aWYodS5pc0J1ZmZlcih0KSl7dmFyIHI9MHxoKHQubGVuZ3RoKTtyZXR1cm4gMD09PShlPXMoZSxyKSkubGVuZ3RofHx0LmNvcHkoZSwwLDAsciksZX1pZih0KXtpZigidW5kZWZpbmVkIiE9dHlwZW9mIEFycmF5QnVmZmVyJiZ0LmJ1ZmZlciBpbnN0YW5jZW9mIEFycmF5QnVmZmVyfHwibGVuZ3RoImluIHQpcmV0dXJuIm51bWJlciIhPXR5cGVvZiB0Lmxlbmd0aHx8ZnVuY3Rpb24oZSl7cmV0dXJuIGUhPWV9KHQubGVuZ3RoKT9zKGUsMCk6ZChlLHQpO2lmKCJCdWZmZXIiPT09dC50eXBlJiZpKHQuZGF0YSkpcmV0dXJuIGQoZSx0LmRhdGEpfXRocm93IG5ldyBUeXBlRXJyb3IoIkZpcnN0IGFyZ3VtZW50IG11c3QgYmUgYSBzdHJpbmcsIEJ1ZmZlciwgQXJyYXlCdWZmZXIsIEFycmF5LCBvciBhcnJheS1saWtlIG9iamVjdC4iKX0oZSx0KX1mdW5jdGlvbiBsKGUpe2lmKCJudW1iZXIiIT10eXBlb2YgZSl0aHJvdyBuZXcgVHlwZUVycm9yKCcic2l6ZSIgYXJndW1lbnQgbXVzdCBiZSBhIG51bWJlcicpO2lmKGU8MCl0aHJvdyBuZXcgUmFuZ2VFcnJvcignInNpemUiIGFyZ3VtZW50IG11c3Qgbm90IGJlIG5lZ2F0aXZlJyl9ZnVuY3Rpb24gZihlLHQpe2lmKGwodCksZT1zKGUsdDwwPzA6MHxoKHQpKSwhdS5UWVBFRF9BUlJBWV9TVVBQT1JUKWZvcih2YXIgcj0wO3I8dDsrK3IpZVtyXT0wO3JldHVybiBlfWZ1bmN0aW9uIGQoZSx0KXt2YXIgcj10Lmxlbmd0aDwwPzA6MHxoKHQubGVuZ3RoKTtlPXMoZSxyKTtmb3IodmFyIG49MDtuPHI7bis9MSllW25dPTI1NSZ0W25dO3JldHVybiBlfWZ1bmN0aW9uIGgoZSl7aWYoZT49YSgpKXRocm93IG5ldyBSYW5nZUVycm9yKCJBdHRlbXB0IHRvIGFsbG9jYXRlIEJ1ZmZlciBsYXJnZXIgdGhhbiBtYXhpbXVtIHNpemU6IDB4IithKCkudG9TdHJpbmcoMTYpKyIgYnl0ZXMiKTtyZXR1cm4gMHxlfWZ1bmN0aW9uIHAoZSx0KXtpZih1LmlzQnVmZmVyKGUpKXJldHVybiBlLmxlbmd0aDtpZigidW5kZWZpbmVkIiE9dHlwZW9mIEFycmF5QnVmZmVyJiYiZnVuY3Rpb24iPT10eXBlb2YgQXJyYXlCdWZmZXIuaXNWaWV3JiYoQXJyYXlCdWZmZXIuaXNWaWV3KGUpfHxlIGluc3RhbmNlb2YgQXJyYXlCdWZmZXIpKXJldHVybiBlLmJ5dGVMZW5ndGg7InN0cmluZyIhPXR5cGVvZiBlJiYoZT0iIitlKTt2YXIgcj1lLmxlbmd0aDtpZigwPT09cilyZXR1cm4gMDtmb3IodmFyIG49ITE7Oylzd2l0Y2godCl7Y2FzZSJhc2NpaSI6Y2FzZSJsYXRpbjEiOmNhc2UiYmluYXJ5IjpyZXR1cm4gcjtjYXNlInV0ZjgiOmNhc2UidXRmLTgiOmNhc2Ugdm9pZCAwOnJldHVybiBVKGUpLmxlbmd0aDtjYXNlInVjczIiOmNhc2UidWNzLTIiOmNhc2UidXRmMTZsZSI6Y2FzZSJ1dGYtMTZsZSI6cmV0dXJuIDIqcjtjYXNlImhleCI6cmV0dXJuIHI+Pj4xO2Nhc2UiYmFzZTY0IjpyZXR1cm4geihlKS5sZW5ndGg7ZGVmYXVsdDppZihuKXJldHVybiBVKGUpLmxlbmd0aDt0PSgiIit0KS50b0xvd2VyQ2FzZSgpLG49ITB9fWZ1bmN0aW9uIG0oZSx0LHIpe3ZhciBuPWVbdF07ZVt0XT1lW3JdLGVbcl09bn1mdW5jdGlvbiB5KGUsdCxyLG4sbyl7aWYoMD09PWUubGVuZ3RoKXJldHVybi0xO2lmKCJzdHJpbmciPT10eXBlb2Ygcj8obj1yLHI9MCk6cj4yMTQ3NDgzNjQ3P3I9MjE0NzQ4MzY0NzpyPC0yMTQ3NDgzNjQ4JiYocj0tMjE0NzQ4MzY0OCkscj0rcixpc05hTihyKSYmKHI9bz8wOmUubGVuZ3RoLTEpLHI8MCYmKHI9ZS5sZW5ndGgrcikscj49ZS5sZW5ndGgpe2lmKG8pcmV0dXJuLTE7cj1lLmxlbmd0aC0xfWVsc2UgaWYocjwwKXtpZighbylyZXR1cm4tMTtyPTB9aWYoInN0cmluZyI9PXR5cGVvZiB0JiYodD11LmZyb20odCxuKSksdS5pc0J1ZmZlcih0KSlyZXR1cm4gMD09PXQubGVuZ3RoPy0xOkUoZSx0LHIsbixvKTtpZigibnVtYmVyIj09dHlwZW9mIHQpcmV0dXJuIHQmPTI1NSx1LlRZUEVEX0FSUkFZX1NVUFBPUlQmJiJmdW5jdGlvbiI9PXR5cGVvZiBVaW50OEFycmF5LnByb3RvdHlwZS5pbmRleE9mP28/VWludDhBcnJheS5wcm90b3R5cGUuaW5kZXhPZi5jYWxsKGUsdCxyKTpVaW50OEFycmF5LnByb3RvdHlwZS5sYXN0SW5kZXhPZi5jYWxsKGUsdCxyKTpFKGUsW3RdLHIsbixvKTt0aHJvdyBuZXcgVHlwZUVycm9yKCJ2YWwgbXVzdCBiZSBzdHJpbmcsIG51bWJlciBvciBCdWZmZXIiKX1mdW5jdGlvbiBFKGUsdCxyLG4sbyl7dmFyIGksYT0xLHM9ZS5sZW5ndGgsdT10Lmxlbmd0aDtpZih2b2lkIDAhPT1uJiYoInVjczIiPT09KG49U3RyaW5nKG4pLnRvTG93ZXJDYXNlKCkpfHwidWNzLTIiPT09bnx8InV0ZjE2bGUiPT09bnx8InV0Zi0xNmxlIj09PW4pKXtpZihlLmxlbmd0aDwyfHx0Lmxlbmd0aDwyKXJldHVybi0xO2E9MixzLz0yLHUvPTIsci89Mn1mdW5jdGlvbiBjKGUsdCl7cmV0dXJuIDE9PT1hP2VbdF06ZS5yZWFkVUludDE2QkUodCphKX1pZihvKXt2YXIgbD0tMTtmb3IoaT1yO2k8cztpKyspaWYoYyhlLGkpPT09Yyh0LC0xPT09bD8wOmktbCkpe2lmKC0xPT09bCYmKGw9aSksaS1sKzE9PT11KXJldHVybiBsKmF9ZWxzZS0xIT09bCYmKGktPWktbCksbD0tMX1lbHNlIGZvcihyK3U+cyYmKHI9cy11KSxpPXI7aT49MDtpLS0pe2Zvcih2YXIgZj0hMCxkPTA7ZDx1O2QrKylpZihjKGUsaStkKSE9PWModCxkKSl7Zj0hMTticmVha31pZihmKXJldHVybiBpfXJldHVybi0xfWZ1bmN0aW9uIGcoZSx0LHIsbil7cj1OdW1iZXIocil8fDA7dmFyIG89ZS5sZW5ndGgtcjtuPyhuPU51bWJlcihuKSk+byYmKG49byk6bj1vO3ZhciBpPXQubGVuZ3RoO2lmKGklMiE9MCl0aHJvdyBuZXcgVHlwZUVycm9yKCJJbnZhbGlkIGhleCBzdHJpbmciKTtuPmkvMiYmKG49aS8yKTtmb3IodmFyIGE9MDthPG47KythKXt2YXIgcz1wYXJzZUludCh0LnN1YnN0cigyKmEsMiksMTYpO2lmKGlzTmFOKHMpKXJldHVybiBhO2VbcithXT1zfXJldHVybiBhfWZ1bmN0aW9uIHYoZSx0LHIsbil7cmV0dXJuICQoVSh0LGUubGVuZ3RoLXIpLGUscixuKX1mdW5jdGlvbiB3KGUsdCxyLG4pe3JldHVybiAkKGZ1bmN0aW9uKGUpe2Zvcih2YXIgdD1bXSxyPTA7cjxlLmxlbmd0aDsrK3IpdC5wdXNoKDI1NSZlLmNoYXJDb2RlQXQocikpO3JldHVybiB0fSh0KSxlLHIsbil9ZnVuY3Rpb24gXyhlLHQscixuKXtyZXR1cm4gdyhlLHQscixuKX1mdW5jdGlvbiBiKGUsdCxyLG4pe3JldHVybiAkKHoodCksZSxyLG4pfWZ1bmN0aW9uIEEoZSx0LHIsbil7cmV0dXJuICQoZnVuY3Rpb24oZSx0KXtmb3IodmFyIHIsbixvLGk9W10sYT0wO2E8ZS5sZW5ndGgmJiEoKHQtPTIpPDApOysrYSluPShyPWUuY2hhckNvZGVBdChhKSk+Pjgsbz1yJTI1NixpLnB1c2gobyksaS5wdXNoKG4pO3JldHVybiBpfSh0LGUubGVuZ3RoLXIpLGUscixuKX1mdW5jdGlvbiBUKGUsdCxyKXtyZXR1cm4gMD09PXQmJnI9PT1lLmxlbmd0aD9uLmZyb21CeXRlQXJyYXkoZSk6bi5mcm9tQnl0ZUFycmF5KGUuc2xpY2UodCxyKSl9ZnVuY3Rpb24gUyhlLHQscil7cj1NYXRoLm1pbihlLmxlbmd0aCxyKTtmb3IodmFyIG49W10sbz10O288cjspe3ZhciBpLGEscyx1LGM9ZVtvXSxsPW51bGwsZj1jPjIzOT80OmM+MjIzPzM6Yz4xOTE/MjoxO2lmKG8rZjw9cilzd2l0Y2goZil7Y2FzZSAxOmM8MTI4JiYobD1jKTticmVhaztjYXNlIDI6MTI4PT0oMTkyJihpPWVbbysxXSkpJiYodT0oMzEmYyk8PDZ8NjMmaSk+MTI3JiYobD11KTticmVhaztjYXNlIDM6aT1lW28rMV0sYT1lW28rMl0sMTI4PT0oMTkyJmkpJiYxMjg9PSgxOTImYSkmJih1PSgxNSZjKTw8MTJ8KDYzJmkpPDw2fDYzJmEpPjIwNDcmJih1PDU1Mjk2fHx1PjU3MzQzKSYmKGw9dSk7YnJlYWs7Y2FzZSA0Omk9ZVtvKzFdLGE9ZVtvKzJdLHM9ZVtvKzNdLDEyOD09KDE5MiZpKSYmMTI4PT0oMTkyJmEpJiYxMjg9PSgxOTImcykmJih1PSgxNSZjKTw8MTh8KDYzJmkpPDwxMnwoNjMmYSk8PDZ8NjMmcyk+NjU1MzUmJnU8MTExNDExMiYmKGw9dSl9bnVsbD09PWw/KGw9NjU1MzMsZj0xKTpsPjY1NTM1JiYobC09NjU1MzYsbi5wdXNoKGw+Pj4xMCYxMDIzfDU1Mjk2KSxsPTU2MzIwfDEwMjMmbCksbi5wdXNoKGwpLG8rPWZ9cmV0dXJuIGZ1bmN0aW9uKGUpe3ZhciB0PWUubGVuZ3RoO2lmKHQ8PWspcmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUuYXBwbHkoU3RyaW5nLGUpO2Zvcih2YXIgcj0iIixuPTA7bjx0OylyKz1TdHJpbmcuZnJvbUNoYXJDb2RlLmFwcGx5KFN0cmluZyxlLnNsaWNlKG4sbis9aykpO3JldHVybiByfShuKX10LkJ1ZmZlcj11LHQuU2xvd0J1ZmZlcj1mdW5jdGlvbihlKXtyZXR1cm4rZSE9ZSYmKGU9MCksdS5hbGxvYygrZSl9LHQuSU5TUEVDVF9NQVhfQllURVM9NTAsdS5UWVBFRF9BUlJBWV9TVVBQT1JUPXZvaWQgMCE9PWUuVFlQRURfQVJSQVlfU1VQUE9SVD9lLlRZUEVEX0FSUkFZX1NVUFBPUlQ6ZnVuY3Rpb24oKXt0cnl7dmFyIGU9bmV3IFVpbnQ4QXJyYXkoMSk7cmV0dXJuIGUuX19wcm90b19fPXtfX3Byb3RvX186VWludDhBcnJheS5wcm90b3R5cGUsZm9vOmZ1bmN0aW9uKCl7cmV0dXJuIDQyfX0sNDI9PT1lLmZvbygpJiYiZnVuY3Rpb24iPT10eXBlb2YgZS5zdWJhcnJheSYmMD09PWUuc3ViYXJyYXkoMSwxKS5ieXRlTGVuZ3RofWNhdGNoKGUpe3JldHVybiExfX0oKSx0LmtNYXhMZW5ndGg9YSgpLHUucG9vbFNpemU9ODE5Mix1Ll9hdWdtZW50PWZ1bmN0aW9uKGUpe3JldHVybiBlLl9fcHJvdG9fXz11LnByb3RvdHlwZSxlfSx1LmZyb209ZnVuY3Rpb24oZSx0LHIpe3JldHVybiBjKG51bGwsZSx0LHIpfSx1LlRZUEVEX0FSUkFZX1NVUFBPUlQmJih1LnByb3RvdHlwZS5fX3Byb3RvX189VWludDhBcnJheS5wcm90b3R5cGUsdS5fX3Byb3RvX189VWludDhBcnJheSwidW5kZWZpbmVkIiE9dHlwZW9mIFN5bWJvbCYmU3ltYm9sLnNwZWNpZXMmJnVbU3ltYm9sLnNwZWNpZXNdPT09dSYmT2JqZWN0LmRlZmluZVByb3BlcnR5KHUsU3ltYm9sLnNwZWNpZXMse3ZhbHVlOm51bGwsY29uZmlndXJhYmxlOiEwfSkpLHUuYWxsb2M9ZnVuY3Rpb24oZSx0LHIpe3JldHVybiBmdW5jdGlvbihlLHQscixuKXtyZXR1cm4gbCh0KSx0PD0wP3MoZSx0KTp2b2lkIDAhPT1yPyJzdHJpbmciPT10eXBlb2Ygbj9zKGUsdCkuZmlsbChyLG4pOnMoZSx0KS5maWxsKHIpOnMoZSx0KX0obnVsbCxlLHQscil9LHUuYWxsb2NVbnNhZmU9ZnVuY3Rpb24oZSl7cmV0dXJuIGYobnVsbCxlKX0sdS5hbGxvY1Vuc2FmZVNsb3c9ZnVuY3Rpb24oZSl7cmV0dXJuIGYobnVsbCxlKX0sdS5pc0J1ZmZlcj1mdW5jdGlvbihlKXtyZXR1cm4hKG51bGw9PWV8fCFlLl9pc0J1ZmZlcil9LHUuY29tcGFyZT1mdW5jdGlvbihlLHQpe2lmKCF1LmlzQnVmZmVyKGUpfHwhdS5pc0J1ZmZlcih0KSl0aHJvdyBuZXcgVHlwZUVycm9yKCJBcmd1bWVudHMgbXVzdCBiZSBCdWZmZXJzIik7aWYoZT09PXQpcmV0dXJuIDA7Zm9yKHZhciByPWUubGVuZ3RoLG49dC5sZW5ndGgsbz0wLGk9TWF0aC5taW4ocixuKTtvPGk7KytvKWlmKGVbb10hPT10W29dKXtyPWVbb10sbj10W29dO2JyZWFrfXJldHVybiByPG4/LTE6bjxyPzE6MH0sdS5pc0VuY29kaW5nPWZ1bmN0aW9uKGUpe3N3aXRjaChTdHJpbmcoZSkudG9Mb3dlckNhc2UoKSl7Y2FzZSJoZXgiOmNhc2UidXRmOCI6Y2FzZSJ1dGYtOCI6Y2FzZSJhc2NpaSI6Y2FzZSJsYXRpbjEiOmNhc2UiYmluYXJ5IjpjYXNlImJhc2U2NCI6Y2FzZSJ1Y3MyIjpjYXNlInVjcy0yIjpjYXNlInV0ZjE2bGUiOmNhc2UidXRmLTE2bGUiOnJldHVybiEwO2RlZmF1bHQ6cmV0dXJuITF9fSx1LmNvbmNhdD1mdW5jdGlvbihlLHQpe2lmKCFpKGUpKXRocm93IG5ldyBUeXBlRXJyb3IoJyJsaXN0IiBhcmd1bWVudCBtdXN0IGJlIGFuIEFycmF5IG9mIEJ1ZmZlcnMnKTtpZigwPT09ZS5sZW5ndGgpcmV0dXJuIHUuYWxsb2MoMCk7dmFyIHI7aWYodm9pZCAwPT09dClmb3IodD0wLHI9MDtyPGUubGVuZ3RoOysrcil0Kz1lW3JdLmxlbmd0aDt2YXIgbj11LmFsbG9jVW5zYWZlKHQpLG89MDtmb3Iocj0wO3I8ZS5sZW5ndGg7KytyKXt2YXIgYT1lW3JdO2lmKCF1LmlzQnVmZmVyKGEpKXRocm93IG5ldyBUeXBlRXJyb3IoJyJsaXN0IiBhcmd1bWVudCBtdXN0IGJlIGFuIEFycmF5IG9mIEJ1ZmZlcnMnKTthLmNvcHkobixvKSxvKz1hLmxlbmd0aH1yZXR1cm4gbn0sdS5ieXRlTGVuZ3RoPXAsdS5wcm90b3R5cGUuX2lzQnVmZmVyPSEwLHUucHJvdG90eXBlLnN3YXAxNj1mdW5jdGlvbigpe3ZhciBlPXRoaXMubGVuZ3RoO2lmKGUlMiE9MCl0aHJvdyBuZXcgUmFuZ2VFcnJvcigiQnVmZmVyIHNpemUgbXVzdCBiZSBhIG11bHRpcGxlIG9mIDE2LWJpdHMiKTtmb3IodmFyIHQ9MDt0PGU7dCs9MiltKHRoaXMsdCx0KzEpO3JldHVybiB0aGlzfSx1LnByb3RvdHlwZS5zd2FwMzI9ZnVuY3Rpb24oKXt2YXIgZT10aGlzLmxlbmd0aDtpZihlJTQhPTApdGhyb3cgbmV3IFJhbmdlRXJyb3IoIkJ1ZmZlciBzaXplIG11c3QgYmUgYSBtdWx0aXBsZSBvZiAzMi1iaXRzIik7Zm9yKHZhciB0PTA7dDxlO3QrPTQpbSh0aGlzLHQsdCszKSxtKHRoaXMsdCsxLHQrMik7cmV0dXJuIHRoaXN9LHUucHJvdG90eXBlLnN3YXA2ND1mdW5jdGlvbigpe3ZhciBlPXRoaXMubGVuZ3RoO2lmKGUlOCE9MCl0aHJvdyBuZXcgUmFuZ2VFcnJvcigiQnVmZmVyIHNpemUgbXVzdCBiZSBhIG11bHRpcGxlIG9mIDY0LWJpdHMiKTtmb3IodmFyIHQ9MDt0PGU7dCs9OCltKHRoaXMsdCx0KzcpLG0odGhpcyx0KzEsdCs2KSxtKHRoaXMsdCsyLHQrNSksbSh0aGlzLHQrMyx0KzQpO3JldHVybiB0aGlzfSx1LnByb3RvdHlwZS50b1N0cmluZz1mdW5jdGlvbigpe3ZhciBlPTB8dGhpcy5sZW5ndGg7cmV0dXJuIDA9PT1lPyIiOjA9PT1hcmd1bWVudHMubGVuZ3RoP1ModGhpcywwLGUpOmZ1bmN0aW9uKGUsdCxyKXt2YXIgbj0hMTtpZigodm9pZCAwPT09dHx8dDwwKSYmKHQ9MCksdD50aGlzLmxlbmd0aClyZXR1cm4iIjtpZigodm9pZCAwPT09cnx8cj50aGlzLmxlbmd0aCkmJihyPXRoaXMubGVuZ3RoKSxyPD0wKXJldHVybiIiO2lmKChyPj4+PTApPD0odD4+Pj0wKSlyZXR1cm4iIjtmb3IoZXx8KGU9InV0ZjgiKTs7KXN3aXRjaChlKXtjYXNlImhleCI6cmV0dXJuIFIodGhpcyx0LHIpO2Nhc2UidXRmOCI6Y2FzZSJ1dGYtOCI6cmV0dXJuIFModGhpcyx0LHIpO2Nhc2UiYXNjaWkiOnJldHVybiBQKHRoaXMsdCxyKTtjYXNlImxhdGluMSI6Y2FzZSJiaW5hcnkiOnJldHVybiBEKHRoaXMsdCxyKTtjYXNlImJhc2U2NCI6cmV0dXJuIFQodGhpcyx0LHIpO2Nhc2UidWNzMiI6Y2FzZSJ1Y3MtMiI6Y2FzZSJ1dGYxNmxlIjpjYXNlInV0Zi0xNmxlIjpyZXR1cm4gTyh0aGlzLHQscik7ZGVmYXVsdDppZihuKXRocm93IG5ldyBUeXBlRXJyb3IoIlVua25vd24gZW5jb2Rpbmc6ICIrZSk7ZT0oZSsiIikudG9Mb3dlckNhc2UoKSxuPSEwfX0uYXBwbHkodGhpcyxhcmd1bWVudHMpfSx1LnByb3RvdHlwZS5lcXVhbHM9ZnVuY3Rpb24oZSl7aWYoIXUuaXNCdWZmZXIoZSkpdGhyb3cgbmV3IFR5cGVFcnJvcigiQXJndW1lbnQgbXVzdCBiZSBhIEJ1ZmZlciIpO3JldHVybiB0aGlzPT09ZXx8MD09PXUuY29tcGFyZSh0aGlzLGUpfSx1LnByb3RvdHlwZS5pbnNwZWN0PWZ1bmN0aW9uKCl7dmFyIGU9IiIscj10LklOU1BFQ1RfTUFYX0JZVEVTO3JldHVybiB0aGlzLmxlbmd0aD4wJiYoZT10aGlzLnRvU3RyaW5nKCJoZXgiLDAscikubWF0Y2goLy57Mn0vZykuam9pbigiICIpLHRoaXMubGVuZ3RoPnImJihlKz0iIC4uLiAiKSksIjxCdWZmZXIgIitlKyI+In0sdS5wcm90b3R5cGUuY29tcGFyZT1mdW5jdGlvbihlLHQscixuLG8pe2lmKCF1LmlzQnVmZmVyKGUpKXRocm93IG5ldyBUeXBlRXJyb3IoIkFyZ3VtZW50IG11c3QgYmUgYSBCdWZmZXIiKTtpZih2b2lkIDA9PT10JiYodD0wKSx2b2lkIDA9PT1yJiYocj1lP2UubGVuZ3RoOjApLHZvaWQgMD09PW4mJihuPTApLHZvaWQgMD09PW8mJihvPXRoaXMubGVuZ3RoKSx0PDB8fHI+ZS5sZW5ndGh8fG48MHx8bz50aGlzLmxlbmd0aCl0aHJvdyBuZXcgUmFuZ2VFcnJvcigib3V0IG9mIHJhbmdlIGluZGV4Iik7aWYobj49byYmdD49cilyZXR1cm4gMDtpZihuPj1vKXJldHVybi0xO2lmKHQ+PXIpcmV0dXJuIDE7aWYodGhpcz09PWUpcmV0dXJuIDA7Zm9yKHZhciBpPShvPj4+PTApLShuPj4+PTApLGE9KHI+Pj49MCktKHQ+Pj49MCkscz1NYXRoLm1pbihpLGEpLGM9dGhpcy5zbGljZShuLG8pLGw9ZS5zbGljZSh0LHIpLGY9MDtmPHM7KytmKWlmKGNbZl0hPT1sW2ZdKXtpPWNbZl0sYT1sW2ZdO2JyZWFrfXJldHVybiBpPGE/LTE6YTxpPzE6MH0sdS5wcm90b3R5cGUuaW5jbHVkZXM9ZnVuY3Rpb24oZSx0LHIpe3JldHVybi0xIT09dGhpcy5pbmRleE9mKGUsdCxyKX0sdS5wcm90b3R5cGUuaW5kZXhPZj1mdW5jdGlvbihlLHQscil7cmV0dXJuIHkodGhpcyxlLHQsciwhMCl9LHUucHJvdG90eXBlLmxhc3RJbmRleE9mPWZ1bmN0aW9uKGUsdCxyKXtyZXR1cm4geSh0aGlzLGUsdCxyLCExKX0sdS5wcm90b3R5cGUud3JpdGU9ZnVuY3Rpb24oZSx0LHIsbil7aWYodm9pZCAwPT09dCluPSJ1dGY4IixyPXRoaXMubGVuZ3RoLHQ9MDtlbHNlIGlmKHZvaWQgMD09PXImJiJzdHJpbmciPT10eXBlb2YgdCluPXQscj10aGlzLmxlbmd0aCx0PTA7ZWxzZXtpZighaXNGaW5pdGUodCkpdGhyb3cgbmV3IEVycm9yKCJCdWZmZXIud3JpdGUoc3RyaW5nLCBlbmNvZGluZywgb2Zmc2V0WywgbGVuZ3RoXSkgaXMgbm8gbG9uZ2VyIHN1cHBvcnRlZCIpO3R8PTAsaXNGaW5pdGUocik/KHJ8PTAsdm9pZCAwPT09biYmKG49InV0ZjgiKSk6KG49cixyPXZvaWQgMCl9dmFyIG89dGhpcy5sZW5ndGgtdDtpZigodm9pZCAwPT09cnx8cj5vKSYmKHI9byksZS5sZW5ndGg+MCYmKHI8MHx8dDwwKXx8dD50aGlzLmxlbmd0aCl0aHJvdyBuZXcgUmFuZ2VFcnJvcigiQXR0ZW1wdCB0byB3cml0ZSBvdXRzaWRlIGJ1ZmZlciBib3VuZHMiKTtufHwobj0idXRmOCIpO2Zvcih2YXIgaT0hMTs7KXN3aXRjaChuKXtjYXNlImhleCI6cmV0dXJuIGcodGhpcyxlLHQscik7Y2FzZSJ1dGY4IjpjYXNlInV0Zi04IjpyZXR1cm4gdih0aGlzLGUsdCxyKTtjYXNlImFzY2lpIjpyZXR1cm4gdyh0aGlzLGUsdCxyKTtjYXNlImxhdGluMSI6Y2FzZSJiaW5hcnkiOnJldHVybiBfKHRoaXMsZSx0LHIpO2Nhc2UiYmFzZTY0IjpyZXR1cm4gYih0aGlzLGUsdCxyKTtjYXNlInVjczIiOmNhc2UidWNzLTIiOmNhc2UidXRmMTZsZSI6Y2FzZSJ1dGYtMTZsZSI6cmV0dXJuIEEodGhpcyxlLHQscik7ZGVmYXVsdDppZihpKXRocm93IG5ldyBUeXBlRXJyb3IoIlVua25vd24gZW5jb2Rpbmc6ICIrbik7bj0oIiIrbikudG9Mb3dlckNhc2UoKSxpPSEwfX0sdS5wcm90b3R5cGUudG9KU09OPWZ1bmN0aW9uKCl7cmV0dXJue3R5cGU6IkJ1ZmZlciIsZGF0YTpBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbCh0aGlzLl9hcnJ8fHRoaXMsMCl9fTt2YXIgaz00MDk2O2Z1bmN0aW9uIFAoZSx0LHIpe3ZhciBuPSIiO3I9TWF0aC5taW4oZS5sZW5ndGgscik7Zm9yKHZhciBvPXQ7bzxyOysrbyluKz1TdHJpbmcuZnJvbUNoYXJDb2RlKDEyNyZlW29dKTtyZXR1cm4gbn1mdW5jdGlvbiBEKGUsdCxyKXt2YXIgbj0iIjtyPU1hdGgubWluKGUubGVuZ3RoLHIpO2Zvcih2YXIgbz10O288cjsrK28pbis9U3RyaW5nLmZyb21DaGFyQ29kZShlW29dKTtyZXR1cm4gbn1mdW5jdGlvbiBSKGUsdCxyKXt2YXIgbj1lLmxlbmd0aDsoIXR8fHQ8MCkmJih0PTApLCghcnx8cjwwfHxyPm4pJiYocj1uKTtmb3IodmFyIG89IiIsaT10O2k8cjsrK2kpbys9aihlW2ldKTtyZXR1cm4gb31mdW5jdGlvbiBPKGUsdCxyKXtmb3IodmFyIG49ZS5zbGljZSh0LHIpLG89IiIsaT0wO2k8bi5sZW5ndGg7aSs9MilvKz1TdHJpbmcuZnJvbUNoYXJDb2RlKG5baV0rMjU2Km5baSsxXSk7cmV0dXJuIG99ZnVuY3Rpb24gQyhlLHQscil7aWYoZSUxIT0wfHxlPDApdGhyb3cgbmV3IFJhbmdlRXJyb3IoIm9mZnNldCBpcyBub3QgdWludCIpO2lmKGUrdD5yKXRocm93IG5ldyBSYW5nZUVycm9yKCJUcnlpbmcgdG8gYWNjZXNzIGJleW9uZCBidWZmZXIgbGVuZ3RoIil9ZnVuY3Rpb24gTihlLHQscixuLG8saSl7aWYoIXUuaXNCdWZmZXIoZSkpdGhyb3cgbmV3IFR5cGVFcnJvcignImJ1ZmZlciIgYXJndW1lbnQgbXVzdCBiZSBhIEJ1ZmZlciBpbnN0YW5jZScpO2lmKHQ+b3x8dDxpKXRocm93IG5ldyBSYW5nZUVycm9yKCcidmFsdWUiIGFyZ3VtZW50IGlzIG91dCBvZiBib3VuZHMnKTtpZihyK24+ZS5sZW5ndGgpdGhyb3cgbmV3IFJhbmdlRXJyb3IoIkluZGV4IG91dCBvZiByYW5nZSIpfWZ1bmN0aW9uIEYoZSx0LHIsbil7dDwwJiYodD02NTUzNSt0KzEpO2Zvcih2YXIgbz0wLGk9TWF0aC5taW4oZS5sZW5ndGgtciwyKTtvPGk7KytvKWVbcitvXT0odCYyNTU8PDgqKG4/bzoxLW8pKT4+PjgqKG4/bzoxLW8pfWZ1bmN0aW9uIE0oZSx0LHIsbil7dDwwJiYodD00Mjk0OTY3Mjk1K3QrMSk7Zm9yKHZhciBvPTAsaT1NYXRoLm1pbihlLmxlbmd0aC1yLDQpO288aTsrK28pZVtyK29dPXQ+Pj44KihuP286My1vKSYyNTV9ZnVuY3Rpb24gSShlLHQscixuLG8saSl7aWYocituPmUubGVuZ3RoKXRocm93IG5ldyBSYW5nZUVycm9yKCJJbmRleCBvdXQgb2YgcmFuZ2UiKTtpZihyPDApdGhyb3cgbmV3IFJhbmdlRXJyb3IoIkluZGV4IG91dCBvZiByYW5nZSIpfWZ1bmN0aW9uIEIoZSx0LHIsbixpKXtyZXR1cm4gaXx8SShlLDAsciw0KSxvLndyaXRlKGUsdCxyLG4sMjMsNCkscis0fWZ1bmN0aW9uIEwoZSx0LHIsbixpKXtyZXR1cm4gaXx8SShlLDAsciw4KSxvLndyaXRlKGUsdCxyLG4sNTIsOCkscis4fXUucHJvdG90eXBlLnNsaWNlPWZ1bmN0aW9uKGUsdCl7dmFyIHIsbj10aGlzLmxlbmd0aDtpZigoZT1+fmUpPDA/KGUrPW4pPDAmJihlPTApOmU+biYmKGU9biksKHQ9dm9pZCAwPT09dD9uOn5+dCk8MD8odCs9bik8MCYmKHQ9MCk6dD5uJiYodD1uKSx0PGUmJih0PWUpLHUuVFlQRURfQVJSQVlfU1VQUE9SVCkocj10aGlzLnN1YmFycmF5KGUsdCkpLl9fcHJvdG9fXz11LnByb3RvdHlwZTtlbHNle3ZhciBvPXQtZTtyPW5ldyB1KG8sdm9pZCAwKTtmb3IodmFyIGk9MDtpPG87KytpKXJbaV09dGhpc1tpK2VdfXJldHVybiByfSx1LnByb3RvdHlwZS5yZWFkVUludExFPWZ1bmN0aW9uKGUsdCxyKXtlfD0wLHR8PTAscnx8QyhlLHQsdGhpcy5sZW5ndGgpO2Zvcih2YXIgbj10aGlzW2VdLG89MSxpPTA7KytpPHQmJihvKj0yNTYpOyluKz10aGlzW2UraV0qbztyZXR1cm4gbn0sdS5wcm90b3R5cGUucmVhZFVJbnRCRT1mdW5jdGlvbihlLHQscil7ZXw9MCx0fD0wLHJ8fEMoZSx0LHRoaXMubGVuZ3RoKTtmb3IodmFyIG49dGhpc1tlKy0tdF0sbz0xO3Q+MCYmKG8qPTI1Nik7KW4rPXRoaXNbZSstLXRdKm87cmV0dXJuIG59LHUucHJvdG90eXBlLnJlYWRVSW50OD1mdW5jdGlvbihlLHQpe3JldHVybiB0fHxDKGUsMSx0aGlzLmxlbmd0aCksdGhpc1tlXX0sdS5wcm90b3R5cGUucmVhZFVJbnQxNkxFPWZ1bmN0aW9uKGUsdCl7cmV0dXJuIHR8fEMoZSwyLHRoaXMubGVuZ3RoKSx0aGlzW2VdfHRoaXNbZSsxXTw8OH0sdS5wcm90b3R5cGUucmVhZFVJbnQxNkJFPWZ1bmN0aW9uKGUsdCl7cmV0dXJuIHR8fEMoZSwyLHRoaXMubGVuZ3RoKSx0aGlzW2VdPDw4fHRoaXNbZSsxXX0sdS5wcm90b3R5cGUucmVhZFVJbnQzMkxFPWZ1bmN0aW9uKGUsdCl7cmV0dXJuIHR8fEMoZSw0LHRoaXMubGVuZ3RoKSwodGhpc1tlXXx0aGlzW2UrMV08PDh8dGhpc1tlKzJdPDwxNikrMTY3NzcyMTYqdGhpc1tlKzNdfSx1LnByb3RvdHlwZS5yZWFkVUludDMyQkU9ZnVuY3Rpb24oZSx0KXtyZXR1cm4gdHx8QyhlLDQsdGhpcy5sZW5ndGgpLDE2Nzc3MjE2KnRoaXNbZV0rKHRoaXNbZSsxXTw8MTZ8dGhpc1tlKzJdPDw4fHRoaXNbZSszXSl9LHUucHJvdG90eXBlLnJlYWRJbnRMRT1mdW5jdGlvbihlLHQscil7ZXw9MCx0fD0wLHJ8fEMoZSx0LHRoaXMubGVuZ3RoKTtmb3IodmFyIG49dGhpc1tlXSxvPTEsaT0wOysraTx0JiYobyo9MjU2KTspbis9dGhpc1tlK2ldKm87cmV0dXJuIG4+PShvKj0xMjgpJiYobi09TWF0aC5wb3coMiw4KnQpKSxufSx1LnByb3RvdHlwZS5yZWFkSW50QkU9ZnVuY3Rpb24oZSx0LHIpe2V8PTAsdHw9MCxyfHxDKGUsdCx0aGlzLmxlbmd0aCk7Zm9yKHZhciBuPXQsbz0xLGk9dGhpc1tlKy0tbl07bj4wJiYobyo9MjU2KTspaSs9dGhpc1tlKy0tbl0qbztyZXR1cm4gaT49KG8qPTEyOCkmJihpLT1NYXRoLnBvdygyLDgqdCkpLGl9LHUucHJvdG90eXBlLnJlYWRJbnQ4PWZ1bmN0aW9uKGUsdCl7cmV0dXJuIHR8fEMoZSwxLHRoaXMubGVuZ3RoKSwxMjgmdGhpc1tlXT8tMSooMjU1LXRoaXNbZV0rMSk6dGhpc1tlXX0sdS5wcm90b3R5cGUucmVhZEludDE2TEU9ZnVuY3Rpb24oZSx0KXt0fHxDKGUsMix0aGlzLmxlbmd0aCk7dmFyIHI9dGhpc1tlXXx0aGlzW2UrMV08PDg7cmV0dXJuIDMyNzY4JnI/NDI5NDkwMTc2MHxyOnJ9LHUucHJvdG90eXBlLnJlYWRJbnQxNkJFPWZ1bmN0aW9uKGUsdCl7dHx8QyhlLDIsdGhpcy5sZW5ndGgpO3ZhciByPXRoaXNbZSsxXXx0aGlzW2VdPDw4O3JldHVybiAzMjc2OCZyPzQyOTQ5MDE3NjB8cjpyfSx1LnByb3RvdHlwZS5yZWFkSW50MzJMRT1mdW5jdGlvbihlLHQpe3JldHVybiB0fHxDKGUsNCx0aGlzLmxlbmd0aCksdGhpc1tlXXx0aGlzW2UrMV08PDh8dGhpc1tlKzJdPDwxNnx0aGlzW2UrM108PDI0fSx1LnByb3RvdHlwZS5yZWFkSW50MzJCRT1mdW5jdGlvbihlLHQpe3JldHVybiB0fHxDKGUsNCx0aGlzLmxlbmd0aCksdGhpc1tlXTw8MjR8dGhpc1tlKzFdPDwxNnx0aGlzW2UrMl08PDh8dGhpc1tlKzNdfSx1LnByb3RvdHlwZS5yZWFkRmxvYXRMRT1mdW5jdGlvbihlLHQpe3JldHVybiB0fHxDKGUsNCx0aGlzLmxlbmd0aCksby5yZWFkKHRoaXMsZSwhMCwyMyw0KX0sdS5wcm90b3R5cGUucmVhZEZsb2F0QkU9ZnVuY3Rpb24oZSx0KXtyZXR1cm4gdHx8QyhlLDQsdGhpcy5sZW5ndGgpLG8ucmVhZCh0aGlzLGUsITEsMjMsNCl9LHUucHJvdG90eXBlLnJlYWREb3VibGVMRT1mdW5jdGlvbihlLHQpe3JldHVybiB0fHxDKGUsOCx0aGlzLmxlbmd0aCksby5yZWFkKHRoaXMsZSwhMCw1Miw4KX0sdS5wcm90b3R5cGUucmVhZERvdWJsZUJFPWZ1bmN0aW9uKGUsdCl7cmV0dXJuIHR8fEMoZSw4LHRoaXMubGVuZ3RoKSxvLnJlYWQodGhpcyxlLCExLDUyLDgpfSx1LnByb3RvdHlwZS53cml0ZVVJbnRMRT1mdW5jdGlvbihlLHQscixuKXtlPStlLHR8PTAscnw9MCxufHxOKHRoaXMsZSx0LHIsTWF0aC5wb3coMiw4KnIpLTEsMCk7dmFyIG89MSxpPTA7Zm9yKHRoaXNbdF09MjU1JmU7KytpPHImJihvKj0yNTYpOyl0aGlzW3QraV09ZS9vJjI1NTtyZXR1cm4gdCtyfSx1LnByb3RvdHlwZS53cml0ZVVJbnRCRT1mdW5jdGlvbihlLHQscixuKXtlPStlLHR8PTAscnw9MCxufHxOKHRoaXMsZSx0LHIsTWF0aC5wb3coMiw4KnIpLTEsMCk7dmFyIG89ci0xLGk9MTtmb3IodGhpc1t0K29dPTI1NSZlOy0tbz49MCYmKGkqPTI1Nik7KXRoaXNbdCtvXT1lL2kmMjU1O3JldHVybiB0K3J9LHUucHJvdG90eXBlLndyaXRlVUludDg9ZnVuY3Rpb24oZSx0LHIpe3JldHVybiBlPStlLHR8PTAscnx8Tih0aGlzLGUsdCwxLDI1NSwwKSx1LlRZUEVEX0FSUkFZX1NVUFBPUlR8fChlPU1hdGguZmxvb3IoZSkpLHRoaXNbdF09MjU1JmUsdCsxfSx1LnByb3RvdHlwZS53cml0ZVVJbnQxNkxFPWZ1bmN0aW9uKGUsdCxyKXtyZXR1cm4gZT0rZSx0fD0wLHJ8fE4odGhpcyxlLHQsMiw2NTUzNSwwKSx1LlRZUEVEX0FSUkFZX1NVUFBPUlQ/KHRoaXNbdF09MjU1JmUsdGhpc1t0KzFdPWU+Pj44KTpGKHRoaXMsZSx0LCEwKSx0KzJ9LHUucHJvdG90eXBlLndyaXRlVUludDE2QkU9ZnVuY3Rpb24oZSx0LHIpe3JldHVybiBlPStlLHR8PTAscnx8Tih0aGlzLGUsdCwyLDY1NTM1LDApLHUuVFlQRURfQVJSQVlfU1VQUE9SVD8odGhpc1t0XT1lPj4+OCx0aGlzW3QrMV09MjU1JmUpOkYodGhpcyxlLHQsITEpLHQrMn0sdS5wcm90b3R5cGUud3JpdGVVSW50MzJMRT1mdW5jdGlvbihlLHQscil7cmV0dXJuIGU9K2UsdHw9MCxyfHxOKHRoaXMsZSx0LDQsNDI5NDk2NzI5NSwwKSx1LlRZUEVEX0FSUkFZX1NVUFBPUlQ/KHRoaXNbdCszXT1lPj4+MjQsdGhpc1t0KzJdPWU+Pj4xNix0aGlzW3QrMV09ZT4+PjgsdGhpc1t0XT0yNTUmZSk6TSh0aGlzLGUsdCwhMCksdCs0fSx1LnByb3RvdHlwZS53cml0ZVVJbnQzMkJFPWZ1bmN0aW9uKGUsdCxyKXtyZXR1cm4gZT0rZSx0fD0wLHJ8fE4odGhpcyxlLHQsNCw0Mjk0OTY3Mjk1LDApLHUuVFlQRURfQVJSQVlfU1VQUE9SVD8odGhpc1t0XT1lPj4+MjQsdGhpc1t0KzFdPWU+Pj4xNix0aGlzW3QrMl09ZT4+PjgsdGhpc1t0KzNdPTI1NSZlKTpNKHRoaXMsZSx0LCExKSx0KzR9LHUucHJvdG90eXBlLndyaXRlSW50TEU9ZnVuY3Rpb24oZSx0LHIsbil7aWYoZT0rZSx0fD0wLCFuKXt2YXIgbz1NYXRoLnBvdygyLDgqci0xKTtOKHRoaXMsZSx0LHIsby0xLC1vKX12YXIgaT0wLGE9MSxzPTA7Zm9yKHRoaXNbdF09MjU1JmU7KytpPHImJihhKj0yNTYpOyllPDAmJjA9PT1zJiYwIT09dGhpc1t0K2ktMV0mJihzPTEpLHRoaXNbdCtpXT0oZS9hPj4wKS1zJjI1NTtyZXR1cm4gdCtyfSx1LnByb3RvdHlwZS53cml0ZUludEJFPWZ1bmN0aW9uKGUsdCxyLG4pe2lmKGU9K2UsdHw9MCwhbil7dmFyIG89TWF0aC5wb3coMiw4KnItMSk7Tih0aGlzLGUsdCxyLG8tMSwtbyl9dmFyIGk9ci0xLGE9MSxzPTA7Zm9yKHRoaXNbdCtpXT0yNTUmZTstLWk+PTAmJihhKj0yNTYpOyllPDAmJjA9PT1zJiYwIT09dGhpc1t0K2krMV0mJihzPTEpLHRoaXNbdCtpXT0oZS9hPj4wKS1zJjI1NTtyZXR1cm4gdCtyfSx1LnByb3RvdHlwZS53cml0ZUludDg9ZnVuY3Rpb24oZSx0LHIpe3JldHVybiBlPStlLHR8PTAscnx8Tih0aGlzLGUsdCwxLDEyNywtMTI4KSx1LlRZUEVEX0FSUkFZX1NVUFBPUlR8fChlPU1hdGguZmxvb3IoZSkpLGU8MCYmKGU9MjU1K2UrMSksdGhpc1t0XT0yNTUmZSx0KzF9LHUucHJvdG90eXBlLndyaXRlSW50MTZMRT1mdW5jdGlvbihlLHQscil7cmV0dXJuIGU9K2UsdHw9MCxyfHxOKHRoaXMsZSx0LDIsMzI3NjcsLTMyNzY4KSx1LlRZUEVEX0FSUkFZX1NVUFBPUlQ/KHRoaXNbdF09MjU1JmUsdGhpc1t0KzFdPWU+Pj44KTpGKHRoaXMsZSx0LCEwKSx0KzJ9LHUucHJvdG90eXBlLndyaXRlSW50MTZCRT1mdW5jdGlvbihlLHQscil7cmV0dXJuIGU9K2UsdHw9MCxyfHxOKHRoaXMsZSx0LDIsMzI3NjcsLTMyNzY4KSx1LlRZUEVEX0FSUkFZX1NVUFBPUlQ/KHRoaXNbdF09ZT4+PjgsdGhpc1t0KzFdPTI1NSZlKTpGKHRoaXMsZSx0LCExKSx0KzJ9LHUucHJvdG90eXBlLndyaXRlSW50MzJMRT1mdW5jdGlvbihlLHQscil7cmV0dXJuIGU9K2UsdHw9MCxyfHxOKHRoaXMsZSx0LDQsMjE0NzQ4MzY0NywtMjE0NzQ4MzY0OCksdS5UWVBFRF9BUlJBWV9TVVBQT1JUPyh0aGlzW3RdPTI1NSZlLHRoaXNbdCsxXT1lPj4+OCx0aGlzW3QrMl09ZT4+PjE2LHRoaXNbdCszXT1lPj4+MjQpOk0odGhpcyxlLHQsITApLHQrNH0sdS5wcm90b3R5cGUud3JpdGVJbnQzMkJFPWZ1bmN0aW9uKGUsdCxyKXtyZXR1cm4gZT0rZSx0fD0wLHJ8fE4odGhpcyxlLHQsNCwyMTQ3NDgzNjQ3LC0yMTQ3NDgzNjQ4KSxlPDAmJihlPTQyOTQ5NjcyOTUrZSsxKSx1LlRZUEVEX0FSUkFZX1NVUFBPUlQ/KHRoaXNbdF09ZT4+PjI0LHRoaXNbdCsxXT1lPj4+MTYsdGhpc1t0KzJdPWU+Pj44LHRoaXNbdCszXT0yNTUmZSk6TSh0aGlzLGUsdCwhMSksdCs0fSx1LnByb3RvdHlwZS53cml0ZUZsb2F0TEU9ZnVuY3Rpb24oZSx0LHIpe3JldHVybiBCKHRoaXMsZSx0LCEwLHIpfSx1LnByb3RvdHlwZS53cml0ZUZsb2F0QkU9ZnVuY3Rpb24oZSx0LHIpe3JldHVybiBCKHRoaXMsZSx0LCExLHIpfSx1LnByb3RvdHlwZS53cml0ZURvdWJsZUxFPWZ1bmN0aW9uKGUsdCxyKXtyZXR1cm4gTCh0aGlzLGUsdCwhMCxyKX0sdS5wcm90b3R5cGUud3JpdGVEb3VibGVCRT1mdW5jdGlvbihlLHQscil7cmV0dXJuIEwodGhpcyxlLHQsITEscil9LHUucHJvdG90eXBlLmNvcHk9ZnVuY3Rpb24oZSx0LHIsbil7aWYocnx8KHI9MCksbnx8MD09PW58fChuPXRoaXMubGVuZ3RoKSx0Pj1lLmxlbmd0aCYmKHQ9ZS5sZW5ndGgpLHR8fCh0PTApLG4+MCYmbjxyJiYobj1yKSxuPT09cilyZXR1cm4gMDtpZigwPT09ZS5sZW5ndGh8fDA9PT10aGlzLmxlbmd0aClyZXR1cm4gMDtpZih0PDApdGhyb3cgbmV3IFJhbmdlRXJyb3IoInRhcmdldFN0YXJ0IG91dCBvZiBib3VuZHMiKTtpZihyPDB8fHI+PXRoaXMubGVuZ3RoKXRocm93IG5ldyBSYW5nZUVycm9yKCJzb3VyY2VTdGFydCBvdXQgb2YgYm91bmRzIik7aWYobjwwKXRocm93IG5ldyBSYW5nZUVycm9yKCJzb3VyY2VFbmQgb3V0IG9mIGJvdW5kcyIpO24+dGhpcy5sZW5ndGgmJihuPXRoaXMubGVuZ3RoKSxlLmxlbmd0aC10PG4tciYmKG49ZS5sZW5ndGgtdCtyKTt2YXIgbyxpPW4tcjtpZih0aGlzPT09ZSYmcjx0JiZ0PG4pZm9yKG89aS0xO28+PTA7LS1vKWVbbyt0XT10aGlzW28rcl07ZWxzZSBpZihpPDFlM3x8IXUuVFlQRURfQVJSQVlfU1VQUE9SVClmb3Iobz0wO288aTsrK28pZVtvK3RdPXRoaXNbbytyXTtlbHNlIFVpbnQ4QXJyYXkucHJvdG90eXBlLnNldC5jYWxsKGUsdGhpcy5zdWJhcnJheShyLHIraSksdCk7cmV0dXJuIGl9LHUucHJvdG90eXBlLmZpbGw9ZnVuY3Rpb24oZSx0LHIsbil7aWYoInN0cmluZyI9PXR5cGVvZiBlKXtpZigic3RyaW5nIj09dHlwZW9mIHQ/KG49dCx0PTAscj10aGlzLmxlbmd0aCk6InN0cmluZyI9PXR5cGVvZiByJiYobj1yLHI9dGhpcy5sZW5ndGgpLDE9PT1lLmxlbmd0aCl7dmFyIG89ZS5jaGFyQ29kZUF0KDApO288MjU2JiYoZT1vKX1pZih2b2lkIDAhPT1uJiYic3RyaW5nIiE9dHlwZW9mIG4pdGhyb3cgbmV3IFR5cGVFcnJvcigiZW5jb2RpbmcgbXVzdCBiZSBhIHN0cmluZyIpO2lmKCJzdHJpbmciPT10eXBlb2YgbiYmIXUuaXNFbmNvZGluZyhuKSl0aHJvdyBuZXcgVHlwZUVycm9yKCJVbmtub3duIGVuY29kaW5nOiAiK24pfWVsc2UibnVtYmVyIj09dHlwZW9mIGUmJihlJj0yNTUpO2lmKHQ8MHx8dGhpcy5sZW5ndGg8dHx8dGhpcy5sZW5ndGg8cil0aHJvdyBuZXcgUmFuZ2VFcnJvcigiT3V0IG9mIHJhbmdlIGluZGV4Iik7aWYocjw9dClyZXR1cm4gdGhpczt2YXIgaTtpZih0Pj4+PTAscj12b2lkIDA9PT1yP3RoaXMubGVuZ3RoOnI+Pj4wLGV8fChlPTApLCJudW1iZXIiPT10eXBlb2YgZSlmb3IoaT10O2k8cjsrK2kpdGhpc1tpXT1lO2Vsc2V7dmFyIGE9dS5pc0J1ZmZlcihlKT9lOlUobmV3IHUoZSxuKS50b1N0cmluZygpKSxzPWEubGVuZ3RoO2ZvcihpPTA7aTxyLXQ7KytpKXRoaXNbaSt0XT1hW2klc119cmV0dXJuIHRoaXN9O3ZhciB4PS9bXitcLzAtOUEtWmEtei1fXS9nO2Z1bmN0aW9uIGooZSl7cmV0dXJuIGU8MTY/IjAiK2UudG9TdHJpbmcoMTYpOmUudG9TdHJpbmcoMTYpfWZ1bmN0aW9uIFUoZSx0KXt2YXIgcjt0PXR8fDEvMDtmb3IodmFyIG49ZS5sZW5ndGgsbz1udWxsLGk9W10sYT0wO2E8bjsrK2Epe2lmKChyPWUuY2hhckNvZGVBdChhKSk+NTUyOTUmJnI8NTczNDQpe2lmKCFvKXtpZihyPjU2MzE5KXsodC09Myk+LTEmJmkucHVzaCgyMzksMTkxLDE4OSk7Y29udGludWV9aWYoYSsxPT09bil7KHQtPTMpPi0xJiZpLnB1c2goMjM5LDE5MSwxODkpO2NvbnRpbnVlfW89cjtjb250aW51ZX1pZihyPDU2MzIwKXsodC09Myk+LTEmJmkucHVzaCgyMzksMTkxLDE4OSksbz1yO2NvbnRpbnVlfXI9NjU1MzYrKG8tNTUyOTY8PDEwfHItNTYzMjApfWVsc2UgbyYmKHQtPTMpPi0xJiZpLnB1c2goMjM5LDE5MSwxODkpO2lmKG89bnVsbCxyPDEyOCl7aWYoKHQtPTEpPDApYnJlYWs7aS5wdXNoKHIpfWVsc2UgaWYocjwyMDQ4KXtpZigodC09Mik8MClicmVhaztpLnB1c2gocj4+NnwxOTIsNjMmcnwxMjgpfWVsc2UgaWYocjw2NTUzNil7aWYoKHQtPTMpPDApYnJlYWs7aS5wdXNoKHI+PjEyfDIyNCxyPj42JjYzfDEyOCw2MyZyfDEyOCl9ZWxzZXtpZighKHI8MTExNDExMikpdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIGNvZGUgcG9pbnQiKTtpZigodC09NCk8MClicmVhaztpLnB1c2gocj4+MTh8MjQwLHI+PjEyJjYzfDEyOCxyPj42JjYzfDEyOCw2MyZyfDEyOCl9fXJldHVybiBpfWZ1bmN0aW9uIHooZSl7cmV0dXJuIG4udG9CeXRlQXJyYXkoZnVuY3Rpb24oZSl7aWYoKGU9ZnVuY3Rpb24oZSl7cmV0dXJuIGUudHJpbT9lLnRyaW0oKTplLnJlcGxhY2UoL15ccyt8XHMrJC9nLCIiKX0oZSkucmVwbGFjZSh4LCIiKSkubGVuZ3RoPDIpcmV0dXJuIiI7Zm9yKDtlLmxlbmd0aCU0IT0wOyllKz0iPSI7cmV0dXJuIGV9KGUpKX1mdW5jdGlvbiAkKGUsdCxyLG4pe2Zvcih2YXIgbz0wO288biYmIShvK3I+PXQubGVuZ3RofHxvPj1lLmxlbmd0aCk7KytvKXRbbytyXT1lW29dO3JldHVybiBvfX0pLmNhbGwodGhpcyxyKDgpKX0sZnVuY3Rpb24oZSx0KXt2YXIgcjtyPWZ1bmN0aW9uKCl7cmV0dXJuIHRoaXN9KCk7dHJ5e3I9cnx8RnVuY3Rpb24oInJldHVybiB0aGlzIikoKXx8KDAsZXZhbCkoInRoaXMiKX1jYXRjaChlKXsib2JqZWN0Ij09dHlwZW9mIHdpbmRvdyYmKHI9d2luZG93KX1lLmV4cG9ydHM9cn0sZnVuY3Rpb24oZSx0LHIpe3QuYnl0ZUxlbmd0aD1mdW5jdGlvbihlKXt2YXIgdD1jKGUpLHI9dFswXSxuPXRbMV07cmV0dXJuIDMqKHIrbikvNC1ufSx0LnRvQnl0ZUFycmF5PWZ1bmN0aW9uKGUpe2Zvcih2YXIgdCxyPWMoZSksbj1yWzBdLGE9clsxXSxzPW5ldyBpKGZ1bmN0aW9uKGUsdCxyKXtyZXR1cm4gMyoodCtyKS80LXJ9KDAsbixhKSksdT0wLGw9YT4wP24tNDpuLGY9MDtmPGw7Zis9NCl0PW9bZS5jaGFyQ29kZUF0KGYpXTw8MTh8b1tlLmNoYXJDb2RlQXQoZisxKV08PDEyfG9bZS5jaGFyQ29kZUF0KGYrMildPDw2fG9bZS5jaGFyQ29kZUF0KGYrMyldLHNbdSsrXT10Pj4xNiYyNTUsc1t1KytdPXQ+PjgmMjU1LHNbdSsrXT0yNTUmdDtyZXR1cm4gMj09PWEmJih0PW9bZS5jaGFyQ29kZUF0KGYpXTw8MnxvW2UuY2hhckNvZGVBdChmKzEpXT4+NCxzW3UrK109MjU1JnQpLDE9PT1hJiYodD1vW2UuY2hhckNvZGVBdChmKV08PDEwfG9bZS5jaGFyQ29kZUF0KGYrMSldPDw0fG9bZS5jaGFyQ29kZUF0KGYrMildPj4yLHNbdSsrXT10Pj44JjI1NSxzW3UrK109MjU1JnQpLHN9LHQuZnJvbUJ5dGVBcnJheT1mdW5jdGlvbihlKXtmb3IodmFyIHQscj1lLmxlbmd0aCxvPXIlMyxpPVtdLGE9MCxzPXItbzthPHM7YSs9MTYzODMpaS5wdXNoKGYoZSxhLGErMTYzODM+cz9zOmErMTYzODMpKTtyZXR1cm4gMT09PW8/KHQ9ZVtyLTFdLGkucHVzaChuW3Q+PjJdK25bdDw8NCY2M10rIj09IikpOjI9PT1vJiYodD0oZVtyLTJdPDw4KStlW3ItMV0saS5wdXNoKG5bdD4+MTBdK25bdD4+NCY2M10rblt0PDwyJjYzXSsiPSIpKSxpLmpvaW4oIiIpfTtmb3IodmFyIG49W10sbz1bXSxpPSJ1bmRlZmluZWQiIT10eXBlb2YgVWludDhBcnJheT9VaW50OEFycmF5OkFycmF5LGE9IkFCQ0RFRkdISUpLTE1OT1BRUlNUVVZXWFlaYWJjZGVmZ2hpamtsbW5vcHFyc3R1dnd4eXowMTIzNDU2Nzg5Ky8iLHM9MCx1PWEubGVuZ3RoO3M8dTsrK3MpbltzXT1hW3NdLG9bYS5jaGFyQ29kZUF0KHMpXT1zO2Z1bmN0aW9uIGMoZSl7dmFyIHQ9ZS5sZW5ndGg7aWYodCU0PjApdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIHN0cmluZy4gTGVuZ3RoIG11c3QgYmUgYSBtdWx0aXBsZSBvZiA0Iik7dmFyIHI9ZS5pbmRleE9mKCI9Iik7cmV0dXJuLTE9PT1yJiYocj10KSxbcixyPT09dD8wOjQtciU0XX1mdW5jdGlvbiBsKGUpe3JldHVybiBuW2U+PjE4JjYzXStuW2U+PjEyJjYzXStuW2U+PjYmNjNdK25bNjMmZV19ZnVuY3Rpb24gZihlLHQscil7Zm9yKHZhciBuLG89W10saT10O2k8cjtpKz0zKW49KGVbaV08PDE2JjE2NzExNjgwKSsoZVtpKzFdPDw4JjY1MjgwKSsoMjU1JmVbaSsyXSksby5wdXNoKGwobikpO3JldHVybiBvLmpvaW4oIiIpfW9bIi0iLmNoYXJDb2RlQXQoMCldPTYyLG9bIl8iLmNoYXJDb2RlQXQoMCldPTYzfSxmdW5jdGlvbihlLHQpe3QucmVhZD1mdW5jdGlvbihlLHQscixuLG8pe3ZhciBpLGEscz04Km8tbi0xLHU9KDE8PHMpLTEsYz11Pj4xLGw9LTcsZj1yP28tMTowLGQ9cj8tMToxLGg9ZVt0K2ZdO2ZvcihmKz1kLGk9aCYoMTw8LWwpLTEsaD4+PS1sLGwrPXM7bD4wO2k9MjU2KmkrZVt0K2ZdLGYrPWQsbC09OCk7Zm9yKGE9aSYoMTw8LWwpLTEsaT4+PS1sLGwrPW47bD4wO2E9MjU2KmErZVt0K2ZdLGYrPWQsbC09OCk7aWYoMD09PWkpaT0xLWM7ZWxzZXtpZihpPT09dSlyZXR1cm4gYT9OYU46MS8wKihoPy0xOjEpO2ErPU1hdGgucG93KDIsbiksaS09Y31yZXR1cm4oaD8tMToxKSphKk1hdGgucG93KDIsaS1uKX0sdC53cml0ZT1mdW5jdGlvbihlLHQscixuLG8saSl7dmFyIGEscyx1LGM9OCppLW8tMSxsPSgxPDxjKS0xLGY9bD4+MSxkPTIzPT09bz9NYXRoLnBvdygyLC0yNCktTWF0aC5wb3coMiwtNzcpOjAsaD1uPzA6aS0xLHA9bj8xOi0xLG09dDwwfHwwPT09dCYmMS90PDA/MTowO2Zvcih0PU1hdGguYWJzKHQpLGlzTmFOKHQpfHx0PT09MS8wPyhzPWlzTmFOKHQpPzE6MCxhPWwpOihhPU1hdGguZmxvb3IoTWF0aC5sb2codCkvTWF0aC5MTjIpLHQqKHU9TWF0aC5wb3coMiwtYSkpPDEmJihhLS0sdSo9MiksKHQrPWErZj49MT9kL3U6ZCpNYXRoLnBvdygyLDEtZikpKnU+PTImJihhKyssdS89MiksYStmPj1sPyhzPTAsYT1sKTphK2Y+PTE/KHM9KHQqdS0xKSpNYXRoLnBvdygyLG8pLGErPWYpOihzPXQqTWF0aC5wb3coMixmLTEpKk1hdGgucG93KDIsbyksYT0wKSk7bz49ODtlW3IraF09MjU1JnMsaCs9cCxzLz0yNTYsby09OCk7Zm9yKGE9YTw8b3xzLGMrPW87Yz4wO2VbcitoXT0yNTUmYSxoKz1wLGEvPTI1NixjLT04KTtlW3IraC1wXXw9MTI4Km19fSxmdW5jdGlvbihlLHQpe3ZhciByPXt9LnRvU3RyaW5nO2UuZXhwb3J0cz1BcnJheS5pc0FycmF5fHxmdW5jdGlvbihlKXtyZXR1cm4iW29iamVjdCBBcnJheV0iPT1yLmNhbGwoZSl9fSxmdW5jdGlvbih0LHIpe3QuZXhwb3J0cz1lfSxmdW5jdGlvbihlLHQscil7KGZ1bmN0aW9uKGUpe2Z1bmN0aW9uIHIoZSx0KXtmb3IodmFyIHI9MCxuPWUubGVuZ3RoLTE7bj49MDtuLS0pe3ZhciBvPWVbbl07Ii4iPT09bz9lLnNwbGljZShuLDEpOiIuLiI9PT1vPyhlLnNwbGljZShuLDEpLHIrKyk6ciYmKGUuc3BsaWNlKG4sMSksci0tKX1pZih0KWZvcig7ci0tO3IpZS51bnNoaWZ0KCIuLiIpO3JldHVybiBlfXZhciBuPS9eKFwvP3wpKFtcc1xTXSo/KSgoPzpcLnsxLDJ9fFteXC9dKz98KShcLlteLlwvXSp8KSkoPzpbXC9dKikkLyxvPWZ1bmN0aW9uKGUpe3JldHVybiBuLmV4ZWMoZSkuc2xpY2UoMSl9O2Z1bmN0aW9uIGkoZSx0KXtpZihlLmZpbHRlcilyZXR1cm4gZS5maWx0ZXIodCk7Zm9yKHZhciByPVtdLG49MDtuPGUubGVuZ3RoO24rKyl0KGVbbl0sbixlKSYmci5wdXNoKGVbbl0pO3JldHVybiByfXQucmVzb2x2ZT1mdW5jdGlvbigpe2Zvcih2YXIgdD0iIixuPSExLG89YXJndW1lbnRzLmxlbmd0aC0xO28+PS0xJiYhbjtvLS0pe3ZhciBhPW8+PTA/YXJndW1lbnRzW29dOmUuY3dkKCk7aWYoInN0cmluZyIhPXR5cGVvZiBhKXRocm93IG5ldyBUeXBlRXJyb3IoIkFyZ3VtZW50cyB0byBwYXRoLnJlc29sdmUgbXVzdCBiZSBzdHJpbmdzIik7YSYmKHQ9YSsiLyIrdCxuPSIvIj09PWEuY2hhckF0KDApKX1yZXR1cm4obj8iLyI6IiIpKyh0PXIoaSh0LnNwbGl0KCIvIiksKGZ1bmN0aW9uKGUpe3JldHVybiEhZX0pKSwhbikuam9pbigiLyIpKXx8Ii4ifSx0Lm5vcm1hbGl6ZT1mdW5jdGlvbihlKXt2YXIgbj10LmlzQWJzb2x1dGUoZSksbz0iLyI9PT1hKGUsLTEpO3JldHVybihlPXIoaShlLnNwbGl0KCIvIiksKGZ1bmN0aW9uKGUpe3JldHVybiEhZX0pKSwhbikuam9pbigiLyIpKXx8bnx8KGU9Ii4iKSxlJiZvJiYoZSs9Ii8iKSwobj8iLyI6IiIpK2V9LHQuaXNBYnNvbHV0ZT1mdW5jdGlvbihlKXtyZXR1cm4iLyI9PT1lLmNoYXJBdCgwKX0sdC5qb2luPWZ1bmN0aW9uKCl7dmFyIGU9QXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLDApO3JldHVybiB0Lm5vcm1hbGl6ZShpKGUsKGZ1bmN0aW9uKGUsdCl7aWYoInN0cmluZyIhPXR5cGVvZiBlKXRocm93IG5ldyBUeXBlRXJyb3IoIkFyZ3VtZW50cyB0byBwYXRoLmpvaW4gbXVzdCBiZSBzdHJpbmdzIik7cmV0dXJuIGV9KSkuam9pbigiLyIpKX0sdC5yZWxhdGl2ZT1mdW5jdGlvbihlLHIpe2Z1bmN0aW9uIG4oZSl7Zm9yKHZhciB0PTA7dDxlLmxlbmd0aCYmIiI9PT1lW3RdO3QrKyk7Zm9yKHZhciByPWUubGVuZ3RoLTE7cj49MCYmIiI9PT1lW3JdO3ItLSk7cmV0dXJuIHQ+cj9bXTplLnNsaWNlKHQsci10KzEpfWU9dC5yZXNvbHZlKGUpLnN1YnN0cigxKSxyPXQucmVzb2x2ZShyKS5zdWJzdHIoMSk7Zm9yKHZhciBvPW4oZS5zcGxpdCgiLyIpKSxpPW4oci5zcGxpdCgiLyIpKSxhPU1hdGgubWluKG8ubGVuZ3RoLGkubGVuZ3RoKSxzPWEsdT0wO3U8YTt1KyspaWYob1t1XSE9PWlbdV0pe3M9dTticmVha312YXIgYz1bXTtmb3IodT1zO3U8by5sZW5ndGg7dSsrKWMucHVzaCgiLi4iKTtyZXR1cm4oYz1jLmNvbmNhdChpLnNsaWNlKHMpKSkuam9pbigiLyIpfSx0LnNlcD0iLyIsdC5kZWxpbWl0ZXI9IjoiLHQuZGlybmFtZT1mdW5jdGlvbihlKXt2YXIgdD1vKGUpLHI9dFswXSxuPXRbMV07cmV0dXJuIHJ8fG4/KG4mJihuPW4uc3Vic3RyKDAsbi5sZW5ndGgtMSkpLHIrbik6Ii4ifSx0LmJhc2VuYW1lPWZ1bmN0aW9uKGUsdCl7dmFyIHI9byhlKVsyXTtyZXR1cm4gdCYmci5zdWJzdHIoLTEqdC5sZW5ndGgpPT09dCYmKHI9ci5zdWJzdHIoMCxyLmxlbmd0aC10Lmxlbmd0aCkpLHJ9LHQuZXh0bmFtZT1mdW5jdGlvbihlKXtyZXR1cm4gbyhlKVszXX07dmFyIGE9ImIiPT09ImFiIi5zdWJzdHIoLTEpP2Z1bmN0aW9uKGUsdCxyKXtyZXR1cm4gZS5zdWJzdHIodCxyKX06ZnVuY3Rpb24oZSx0LHIpe3JldHVybiB0PDAmJih0PWUubGVuZ3RoK3QpLGUuc3Vic3RyKHQscil9fSkuY2FsbCh0aGlzLHIoMTQpKX0sZnVuY3Rpb24oZSx0KXt2YXIgcixuLG89ZS5leHBvcnRzPXt9O2Z1bmN0aW9uIGkoKXt0aHJvdyBuZXcgRXJyb3IoInNldFRpbWVvdXQgaGFzIG5vdCBiZWVuIGRlZmluZWQiKX1mdW5jdGlvbiBhKCl7dGhyb3cgbmV3IEVycm9yKCJjbGVhclRpbWVvdXQgaGFzIG5vdCBiZWVuIGRlZmluZWQiKX1mdW5jdGlvbiBzKGUpe2lmKHI9PT1zZXRUaW1lb3V0KXJldHVybiBzZXRUaW1lb3V0KGUsMCk7aWYoKHI9PT1pfHwhcikmJnNldFRpbWVvdXQpcmV0dXJuIHI9c2V0VGltZW91dCxzZXRUaW1lb3V0KGUsMCk7dHJ5e3JldHVybiByKGUsMCl9Y2F0Y2godCl7dHJ5e3JldHVybiByLmNhbGwobnVsbCxlLDApfWNhdGNoKHQpe3JldHVybiByLmNhbGwodGhpcyxlLDApfX19IWZ1bmN0aW9uKCl7dHJ5e3I9ImZ1bmN0aW9uIj09dHlwZW9mIHNldFRpbWVvdXQ/c2V0VGltZW91dDppfWNhdGNoKGUpe3I9aX10cnl7bj0iZnVuY3Rpb24iPT10eXBlb2YgY2xlYXJUaW1lb3V0P2NsZWFyVGltZW91dDphfWNhdGNoKGUpe249YX19KCk7dmFyIHUsYz1bXSxsPSExLGY9LTE7ZnVuY3Rpb24gZCgpe2wmJnUmJihsPSExLHUubGVuZ3RoP2M9dS5jb25jYXQoYyk6Zj0tMSxjLmxlbmd0aCYmaCgpKX1mdW5jdGlvbiBoKCl7aWYoIWwpe3ZhciBlPXMoZCk7bD0hMDtmb3IodmFyIHQ9Yy5sZW5ndGg7dDspe2Zvcih1PWMsYz1bXTsrK2Y8dDspdSYmdVtmXS5ydW4oKTtmPS0xLHQ9Yy5sZW5ndGh9dT1udWxsLGw9ITEsZnVuY3Rpb24oZSl7aWYobj09PWNsZWFyVGltZW91dClyZXR1cm4gY2xlYXJUaW1lb3V0KGUpO2lmKChuPT09YXx8IW4pJiZjbGVhclRpbWVvdXQpcmV0dXJuIG49Y2xlYXJUaW1lb3V0LGNsZWFyVGltZW91dChlKTt0cnl7bihlKX1jYXRjaCh0KXt0cnl7cmV0dXJuIG4uY2FsbChudWxsLGUpfWNhdGNoKHQpe3JldHVybiBuLmNhbGwodGhpcyxlKX19fShlKX19ZnVuY3Rpb24gcChlLHQpe3RoaXMuZnVuPWUsdGhpcy5hcnJheT10fWZ1bmN0aW9uIG0oKXt9by5uZXh0VGljaz1mdW5jdGlvbihlKXt2YXIgdD1uZXcgQXJyYXkoYXJndW1lbnRzLmxlbmd0aC0xKTtpZihhcmd1bWVudHMubGVuZ3RoPjEpZm9yKHZhciByPTE7cjxhcmd1bWVudHMubGVuZ3RoO3IrKyl0W3ItMV09YXJndW1lbnRzW3JdO2MucHVzaChuZXcgcChlLHQpKSwxIT09Yy5sZW5ndGh8fGx8fHMoaCl9LHAucHJvdG90eXBlLnJ1bj1mdW5jdGlvbigpe3RoaXMuZnVuLmFwcGx5KG51bGwsdGhpcy5hcnJheSl9LG8udGl0bGU9ImJyb3dzZXIiLG8uYnJvd3Nlcj0hMCxvLmVudj17fSxvLmFyZ3Y9W10sby52ZXJzaW9uPSIiLG8udmVyc2lvbnM9e30sby5vbj1tLG8uYWRkTGlzdGVuZXI9bSxvLm9uY2U9bSxvLm9mZj1tLG8ucmVtb3ZlTGlzdGVuZXI9bSxvLnJlbW92ZUFsbExpc3RlbmVycz1tLG8uZW1pdD1tLG8ucHJlcGVuZExpc3RlbmVyPW0sby5wcmVwZW5kT25jZUxpc3RlbmVyPW0sby5saXN0ZW5lcnM9ZnVuY3Rpb24oZSl7cmV0dXJuW119LG8uYmluZGluZz1mdW5jdGlvbihlKXt0aHJvdyBuZXcgRXJyb3IoInByb2Nlc3MuYmluZGluZyBpcyBub3Qgc3VwcG9ydGVkIil9LG8uY3dkPWZ1bmN0aW9uKCl7cmV0dXJuIi8ifSxvLmNoZGlyPWZ1bmN0aW9uKGUpe3Rocm93IG5ldyBFcnJvcigicHJvY2Vzcy5jaGRpciBpcyBub3Qgc3VwcG9ydGVkIil9LG8udW1hc2s9ZnVuY3Rpb24oKXtyZXR1cm4gMH19XSl9KHQuZnMpO2NvbnN0IHI9ZS51bnBhY2tCcmlkZ2U7bGV0IG47dmFyIG89ZnVuY3Rpb24oZSl7Y29uc3QgdD17fTtjcmVkZW50aWFscz0ib21pdCI7dmFyIG4sbz12b2lkIDAhPT10P3Q6e30saT1yLkV4dCxhPXtvcGVuOmZ1bmN0aW9uKCl7cmV0dXJuIGkuY3VycmVudC5vcGVuLmFwcGx5KGkuY3VycmVudCxhcmd1bWVudHMpfSxjbG9zZTpmdW5jdGlvbigpe3JldHVybiBpLmN1cnJlbnQuY2xvc2UuYXBwbHkoaS5jdXJyZW50LGFyZ3VtZW50cyl9LHJlYWQ6ZnVuY3Rpb24oKXtyZXR1cm4gaS5jdXJyZW50LnJlYWQuYXBwbHkoaS5jdXJyZW50LGFyZ3VtZW50cyl9LHdyaXRlOmZ1bmN0aW9uKCl7cmV0dXJuIGkuY3VycmVudC53cml0ZS5hcHBseShpLmN1cnJlbnQsYXJndW1lbnRzKX0sdGVsbDpmdW5jdGlvbigpe3JldHVybiBpLmN1cnJlbnQudGVsbC5hcHBseShpLmN1cnJlbnQsYXJndW1lbnRzKX0sc2VlazpmdW5jdGlvbigpe3JldHVybiBpLmN1cnJlbnQuc2Vlay5hcHBseShpLmN1cnJlbnQsYXJndW1lbnRzKX0sY3JlYXRlOmZ1bmN0aW9uKCl7cmV0dXJuIGkuY3VycmVudC5jcmVhdGUuYXBwbHkoaS5jdXJyZW50LGFyZ3VtZW50cyl9fSxzPXt9O2ZvcihuIGluIG8pby5oYXNPd25Qcm9wZXJ0eShuKSYmKHNbbl09b1tuXSk7by5hcmd1bWVudHM9W10sby50aGlzUHJvZ3JhbT0iLi90aGlzLnByb2dyYW0iLG8ucXVpdD1mdW5jdGlvbihlLHQpe3Rocm93IHR9LG8ucHJlUnVuPVtdLG8ucG9zdFJ1bj1bXTt2YXIgdT0hMSxjPSExLGw9ITE7aWYoby5FTlZJUk9OTUVOVCl7aWYoIldFQiI9PT1vLkVOVklST05NRU5UKXU9ITA7ZWxzZSBpZigiV09SS0VSIj09PW8uRU5WSVJPTk1FTlQpYz0hMDtlbHNlIGlmKCJOT0RFIj09PW8uRU5WSVJPTk1FTlQpbD0hMDtlbHNlIGlmKCJTSEVMTCIhPT1vLkVOVklST05NRU5UKXRocm93IG5ldyBFcnJvcigiTW9kdWxlWydFTlZJUk9OTUVOVCddIHZhbHVlIGlzIG5vdCB2YWxpZC4gbXVzdCBiZSBvbmUgb2Y6IFdFQnxXT1JLRVJ8Tk9ERXxTSEVMTC4iKX1lbHNlIHU9Im9iamVjdCI9PXR5cGVvZiB3aW5kb3csYz0iZnVuY3Rpb24iPT10eXBlb2YgaW1wb3J0U2NyaXB0cyxsPSJvYmplY3QiPT10eXBlb2YgcHJvY2VzcyYmImZ1bmN0aW9uIj09dHlwZW9mIHJlcXVpcmUmJiF1JiYhYztmb3IobiBpbih1fHxjKSYmKG8ucmVhZD1mdW5jdGlvbihlKXt2YXIgdD1uZXcgWE1MSHR0cFJlcXVlc3Q7cmV0dXJuIHQub3BlbigiR0VUIixlLCExKSx0LnNlbmQobnVsbCksdC5yZXNwb25zZVRleHR9LGMmJihvLnJlYWRCaW5hcnk9ZnVuY3Rpb24oZSl7dmFyIHQ9bmV3IFhNTEh0dHBSZXF1ZXN0O3JldHVybiB0Lm9wZW4oIkdFVCIsZSwhMSksdC5yZXNwb25zZVR5cGU9ImFycmF5YnVmZmVyIix0LnNlbmQobnVsbCksbmV3IFVpbnQ4QXJyYXkodC5yZXNwb25zZSl9KSxvLnJlYWRBc3luYz1mdW5jdGlvbihlLHQscil7dmFyIG49bmV3IFhNTEh0dHBSZXF1ZXN0O24ub3BlbigiR0VUIixlLCEwKSxuLnJlc3BvbnNlVHlwZT0iYXJyYXlidWZmZXIiLG4ub25sb2FkPWZ1bmN0aW9uKCl7MjAwPT1uLnN0YXR1c3x8MD09bi5zdGF0dXMmJm4ucmVzcG9uc2U/dChuLnJlc3BvbnNlKTpyKCl9LG4ub25lcnJvcj1yLG4uc2VuZChudWxsKX0sby5zZXRXaW5kb3dUaXRsZT1mdW5jdGlvbihlKXtkb2N1bWVudC50aXRsZT1lfSksby5wcmludD0idW5kZWZpbmVkIiE9dHlwZW9mIGNvbnNvbGU/Y29uc29sZS5sb2cuYmluZChjb25zb2xlKToidW5kZWZpbmVkIiE9dHlwZW9mIHByaW50P3ByaW50Om51bGwsby5wcmludEVycj0idW5kZWZpbmVkIiE9dHlwZW9mIHByaW50RXJyP3ByaW50RXJyOiJ1bmRlZmluZWQiIT10eXBlb2YgY29uc29sZSYmY29uc29sZS53YXJuLmJpbmQoY29uc29sZSl8fG8ucHJpbnQsby5wcmludD1vLnByaW50LG8ucHJpbnRFcnI9by5wcmludEVycixzKXMuaGFzT3duUHJvcGVydHkobikmJihvW25dPXNbbl0pO3M9dm9pZCAwO2Z1bmN0aW9uIGYoZSl7eSgheCk7dmFyIHQ9TDtyZXR1cm4gTD1MK2UrMTUmLTE2LHR9ZnVuY3Rpb24gZChlKXt5KCQpO3ZhciB0PUZbJD4+Ml0scj10K2UrMTUmLTE2O2lmKChGWyQ+PjJdPXIscj49cSkmJiFIKCkpcmV0dXJuIEZbJD4+Ml09dCwwO3JldHVybiB0fWZ1bmN0aW9uIGgoZSx0KXtyZXR1cm4gdHx8KHQ9MTYpLGU9TWF0aC5jZWlsKGUvdCkqdH1mdW5jdGlvbiBwKGUpe3N3aXRjaChlKXtjYXNlImkxIjpjYXNlImk4IjpyZXR1cm4gMTtjYXNlImkxNiI6cmV0dXJuIDI7Y2FzZSJpMzIiOnJldHVybiA0O2Nhc2UiaTY0IjpyZXR1cm4gODtjYXNlImZsb2F0IjpyZXR1cm4gNDtjYXNlImRvdWJsZSI6cmV0dXJuIDg7ZGVmYXVsdDppZigiKiI9PT1lW2UubGVuZ3RoLTFdKXJldHVybiA0O2lmKCJpIj09PWVbMF0pe3ZhciB0PXBhcnNlSW50KGUuc3Vic3RyKDEpKTtyZXR1cm4geSh0JTg9PTApLHQvOH1yZXR1cm4gMH19bmV3IEFycmF5KDApO3ZhciBtPTA7ZnVuY3Rpb24geShlLHQpe2V8fHJyKCJBc3NlcnRpb24gZmFpbGVkOiAiK3QpfWZ1bmN0aW9uIEUoZSx0LHIsbil7c3dpdGNoKCIqIj09PShyPXJ8fCJpOCIpLmNoYXJBdChyLmxlbmd0aC0xKSYmKHI9ImkzMiIpLHIpe2Nhc2UiaTEiOmNhc2UiaTgiOlJbZT4+MF09dDticmVhaztjYXNlImkxNiI6Q1tlPj4xXT10O2JyZWFrO2Nhc2UiaTMyIjpGW2U+PjJdPXQ7YnJlYWs7Y2FzZSJpNjQiOnRlbXBJNjQ9W3Q+Pj4wLCh0ZW1wRG91YmxlPXQsK25lKHRlbXBEb3VibGUpPj0xP3RlbXBEb3VibGU+MD8oMHxhZSgraWUodGVtcERvdWJsZS80Mjk0OTY3Mjk2KSw0Mjk0OTY3Mjk1KSk+Pj4wOn5+K29lKCh0ZW1wRG91YmxlLSsofn50ZW1wRG91YmxlPj4+MCkpLzQyOTQ5NjcyOTYpPj4+MDowKV0sRltlPj4yXT10ZW1wSTY0WzBdLEZbZSs0Pj4yXT10ZW1wSTY0WzFdO2JyZWFrO2Nhc2UiZmxvYXQiOklbZT4+Ml09dDticmVhaztjYXNlImRvdWJsZSI6QltlPj4zXT10O2JyZWFrO2RlZmF1bHQ6cnIoImludmFsaWQgdHlwZSBmb3Igc2V0VmFsdWU6ICIrcil9fWZ1bmN0aW9uIGcoZSx0LHIsbil7dmFyIG8saTsibnVtYmVyIj09dHlwZW9mIGU/KG89ITAsaT1lKToobz0hMSxpPWUubGVuZ3RoKTt2YXIgYSxzPSJzdHJpbmciPT10eXBlb2YgdD90Om51bGw7aWYoYT00PT1yP246WyJmdW5jdGlvbiI9PXR5cGVvZiBKdD9KdDpmLFF0LGYsZF1bdm9pZCAwPT09cj8yOnJdKE1hdGgubWF4KGkscz8xOnQubGVuZ3RoKSksbyl7dmFyIHU7Zm9yKG49YSx5KDA9PSgzJmEpKSx1PWErKC00JmkpO248dTtuKz00KUZbbj4+Ml09MDtmb3IodT1hK2k7bjx1OylSW24rKz4+MF09MDtyZXR1cm4gYX1pZigiaTgiPT09cylyZXR1cm4gZS5zdWJhcnJheXx8ZS5zbGljZT9PLnNldChlLGEpOk8uc2V0KG5ldyBVaW50OEFycmF5KGUpLGEpLGE7Zm9yKHZhciBjLGwsaCxtPTA7bTxpOyl7dmFyIGc9ZVttXTswIT09KGM9c3x8dFttXSk/KCJpNjQiPT1jJiYoYz0iaTMyIiksRShhK20sZyxjKSxoIT09YyYmKGw9cChjKSxoPWMpLG0rPWwpOm0rK31yZXR1cm4gYX1mdW5jdGlvbiB2KGUsdCl7aWYoMD09PXR8fCFlKXJldHVybiIiO2Zvcih2YXIgcixuPTAsbz0wO258PXI9T1tlK28+PjBdLCgwIT1yfHx0KSYmKG8rKywhdHx8byE9dCk7KTt0fHwodD1vKTt2YXIgaT0iIjtpZihuPDEyOCl7Zm9yKHZhciBhO3Q+MDspYT1TdHJpbmcuZnJvbUNoYXJDb2RlLmFwcGx5KFN0cmluZyxPLnN1YmFycmF5KGUsZStNYXRoLm1pbih0LDEwMjQpKSksaT1pP2krYTphLGUrPTEwMjQsdC09MTAyNDtyZXR1cm4gaX1yZXR1cm4gYihlKX12YXIgdz0idW5kZWZpbmVkIiE9dHlwZW9mIFRleHREZWNvZGVyP25ldyBUZXh0RGVjb2RlcigidXRmOCIpOnZvaWQgMDtmdW5jdGlvbiBfKGUsdCl7Zm9yKHZhciByPXQ7ZVtyXTspKytyO2lmKHItdD4xNiYmZS5zdWJhcnJheSYmdylyZXR1cm4gdy5kZWNvZGUoZS5zdWJhcnJheSh0LHIpKTtmb3IodmFyIG4sbyxpLGEscyx1PSIiOzspe2lmKCEobj1lW3QrK10pKXJldHVybiB1O2lmKDEyOCZuKWlmKG89NjMmZVt0KytdLDE5MiE9KDIyNCZuKSlpZihpPTYzJmVbdCsrXSwyMjQ9PSgyNDAmbik/bj0oMTUmbik8PDEyfG88PDZ8aTooYT02MyZlW3QrK10sMjQwPT0oMjQ4Jm4pP249KDcmbik8PDE4fG88PDEyfGk8PDZ8YToocz02MyZlW3QrK10sbj0yNDg9PSgyNTImbik/KDMmbik8PDI0fG88PDE4fGk8PDEyfGE8PDZ8czooMSZuKTw8MzB8bzw8MjR8aTw8MTh8YTw8MTJ8czw8Nnw2MyZlW3QrK10pKSxuPDY1NTM2KXUrPVN0cmluZy5mcm9tQ2hhckNvZGUobik7ZWxzZXt2YXIgYz1uLTY1NTM2O3UrPVN0cmluZy5mcm9tQ2hhckNvZGUoNTUyOTZ8Yz4+MTAsNTYzMjB8MTAyMyZjKX1lbHNlIHUrPVN0cmluZy5mcm9tQ2hhckNvZGUoKDMxJm4pPDw2fG8pO2Vsc2UgdSs9U3RyaW5nLmZyb21DaGFyQ29kZShuKX19ZnVuY3Rpb24gYihlKXtyZXR1cm4gXyhPLGUpfWZ1bmN0aW9uIEEoZSx0LHIsbil7aWYoIShuPjApKXJldHVybiAwO2Zvcih2YXIgbz1yLGk9cituLTEsYT0wO2E8ZS5sZW5ndGg7KythKXt2YXIgcz1lLmNoYXJDb2RlQXQoYSk7aWYocz49NTUyOTYmJnM8PTU3MzQzJiYocz02NTUzNisoKDEwMjMmcyk8PDEwKXwxMDIzJmUuY2hhckNvZGVBdCgrK2EpKSxzPD0xMjcpe2lmKHI+PWkpYnJlYWs7dFtyKytdPXN9ZWxzZSBpZihzPD0yMDQ3KXtpZihyKzE+PWkpYnJlYWs7dFtyKytdPTE5MnxzPj42LHRbcisrXT0xMjh8NjMmc31lbHNlIGlmKHM8PTY1NTM1KXtpZihyKzI+PWkpYnJlYWs7dFtyKytdPTIyNHxzPj4xMix0W3IrK109MTI4fHM+PjYmNjMsdFtyKytdPTEyOHw2MyZzfWVsc2UgaWYoczw9MjA5NzE1MSl7aWYociszPj1pKWJyZWFrO3RbcisrXT0yNDB8cz4+MTgsdFtyKytdPTEyOHxzPj4xMiY2Myx0W3IrK109MTI4fHM+PjYmNjMsdFtyKytdPTEyOHw2MyZzfWVsc2UgaWYoczw9NjcxMDg4NjMpe2lmKHIrND49aSlicmVhazt0W3IrK109MjQ4fHM+PjI0LHRbcisrXT0xMjh8cz4+MTgmNjMsdFtyKytdPTEyOHxzPj4xMiY2Myx0W3IrK109MTI4fHM+PjYmNjMsdFtyKytdPTEyOHw2MyZzfWVsc2V7aWYocis1Pj1pKWJyZWFrO3RbcisrXT0yNTJ8cz4+MzAsdFtyKytdPTEyOHxzPj4yNCY2Myx0W3IrK109MTI4fHM+PjE4JjYzLHRbcisrXT0xMjh8cz4+MTImNjMsdFtyKytdPTEyOHxzPj42JjYzLHRbcisrXT0xMjh8NjMmc319cmV0dXJuIHRbcl09MCxyLW99ZnVuY3Rpb24gVChlLHQscil7cmV0dXJuIEEoZSxPLHQscil9ZnVuY3Rpb24gUyhlKXtmb3IodmFyIHQ9MCxyPTA7cjxlLmxlbmd0aDsrK3Ipe3ZhciBuPWUuY2hhckNvZGVBdChyKTtuPj01NTI5NiYmbjw9NTczNDMmJihuPTY1NTM2KygoMTAyMyZuKTw8MTApfDEwMjMmZS5jaGFyQ29kZUF0KCsrcikpLG48PTEyNz8rK3Q6dCs9bjw9MjA0Nz8yOm48PTY1NTM1PzM6bjw9MjA5NzE1MT80Om48PTY3MTA4ODYzPzU6Nn1yZXR1cm4gdH0idW5kZWZpbmVkIiE9dHlwZW9mIFRleHREZWNvZGVyJiZuZXcgVGV4dERlY29kZXIoInV0Zi0xNmxlIik7ZnVuY3Rpb24gayhlKXtmb3IodmFyIHQ9MCxyPSIiOzspe3ZhciBuPUZbZSs0KnQ+PjJdO2lmKDA9PW4pcmV0dXJuIHI7aWYoKyt0LG4+PTY1NTM2KXt2YXIgbz1uLTY1NTM2O3IrPVN0cmluZy5mcm9tQ2hhckNvZGUoNTUyOTZ8bz4+MTAsNTYzMjB8MTAyMyZvKX1lbHNlIHIrPVN0cmluZy5mcm9tQ2hhckNvZGUobil9fWZ1bmN0aW9uIFAoKXt2YXIgZT1mdW5jdGlvbigpe3ZhciBlPW5ldyBFcnJvcjtpZighZS5zdGFjayl7dHJ5e3Rocm93IG5ldyBFcnJvcigwKX1jYXRjaCh0KXtlPXR9aWYoIWUuc3RhY2spcmV0dXJuIihubyBzdGFjayB0cmFjZSBhdmFpbGFibGUpIn1yZXR1cm4gZS5zdGFjay50b1N0cmluZygpfSgpO3JldHVybiBvLmV4dHJhU3RhY2tUcmFjZSYmKGUrPSJcbiIrby5leHRyYVN0YWNrVHJhY2UoKSksZS5yZXBsYWNlKC9fX1pbXHdcZF9dKy9nLChmdW5jdGlvbihlKXtyZXR1cm4gZT09ZT9lOmUrIiBbIitlKyJdIn0pKX12YXIgRCxSLE8sQyxOLEYsTSxJLEIsTCx4LGosVSx6LCQ7ZnVuY3Rpb24gVyhlLHQpe3JldHVybiBlJXQ+MCYmKGUrPXQtZSV0KSxlfWZ1bmN0aW9uIFkoZSl7by5idWZmZXI9RD1lfWZ1bmN0aW9uIFYoKXtvLkhFQVA4PVI9bmV3IEludDhBcnJheShEKSxvLkhFQVAxNj1DPW5ldyBJbnQxNkFycmF5KEQpLG8uSEVBUDMyPUY9bmV3IEludDMyQXJyYXkoRCksby5IRUFQVTg9Tz1uZXcgVWludDhBcnJheShEKSxvLkhFQVBVMTY9Tj1uZXcgVWludDE2QXJyYXkoRCksby5IRUFQVTMyPU09bmV3IFVpbnQzMkFycmF5KEQpLG8uSEVBUEYzMj1JPW5ldyBGbG9hdDMyQXJyYXkoRCksby5IRUFQRjY0PUI9bmV3IEZsb2F0NjRBcnJheShEKX1mdW5jdGlvbiBIKCl7dmFyIGU9by51c2luZ1dhc20/NjU1MzY6MTY3NzcyMTYsdD0yMTQ3NDgzNjQ4LWU7aWYoRlskPj4yXT50KXJldHVybiExO3ZhciByPXE7Zm9yKHE9TWF0aC5tYXgocSwxNjc3NzIxNik7cTxGWyQ+PjJdOylxPXE8PTUzNjg3MDkxMj9XKDIqcSxlKTpNYXRoLm1pbihXKCgzKnErMjE0NzQ4MzY0OCkvNCxlKSx0KTt2YXIgbj1vLnJlYWxsb2NCdWZmZXIocSk7cmV0dXJuIG4mJm4uYnl0ZUxlbmd0aD09cT8oWShuKSxWKCksITApOihxPXIsITEpfUw9VT0kPTAseD0hMSxvLnJlYWxsb2NCdWZmZXJ8fChvLnJlYWxsb2NCdWZmZXI9ZnVuY3Rpb24oZSl7dmFyIHQ7dHJ5e2lmKEFycmF5QnVmZmVyLnRyYW5zZmVyKXQ9QXJyYXlCdWZmZXIudHJhbnNmZXIoRCxlKTtlbHNle3ZhciByPVI7dD1uZXcgQXJyYXlCdWZmZXIoZSksbmV3IEludDhBcnJheSh0KS5zZXQocil9fWNhdGNoKGUpe3JldHVybiExfXJldHVybiEhWHQodCkmJnR9KTt0cnl7RnVuY3Rpb24ucHJvdG90eXBlLmNhbGwuYmluZChPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKEFycmF5QnVmZmVyLnByb3RvdHlwZSwiYnl0ZUxlbmd0aCIpLmdldCkobmV3IEFycmF5QnVmZmVyKDQpKX1jYXRjaChlKXsoZnVuY3Rpb24oZSl7cmV0dXJuIGUuYnl0ZUxlbmd0aH0pfXZhciBHPW8uVE9UQUxfU1RBQ0t8fDUyNDI4ODAscT1vLlRPVEFMX01FTU9SWXx8MTY3NzcyMTY7aWYocTxHJiZvLnByaW50RXJyKCJUT1RBTF9NRU1PUlkgc2hvdWxkIGJlIGxhcmdlciB0aGFuIFRPVEFMX1NUQUNLLCB3YXMgIitxKyIhIChUT1RBTF9TVEFDSz0iK0crIikiKSxvLmJ1ZmZlcj9EPW8uYnVmZmVyOigib2JqZWN0Ij09dHlwZW9mIFdlYkFzc2VtYmx5JiYiZnVuY3Rpb24iPT10eXBlb2YgV2ViQXNzZW1ibHkuTWVtb3J5PyhvLndhc21NZW1vcnk9bmV3IFdlYkFzc2VtYmx5Lk1lbW9yeSh7aW5pdGlhbDpxLzY1NTM2fSksRD1vLndhc21NZW1vcnkuYnVmZmVyKTpEPW5ldyBBcnJheUJ1ZmZlcihxKSxvLmJ1ZmZlcj1EKSxWKCksRlswXT0xNjY4NTA5MDI5LENbMV09MjU0NTksMTE1IT09T1syXXx8OTkhPT1PWzNdKXRocm93IlJ1bnRpbWUgZXJyb3I6IGV4cGVjdGVkIHRoZSBzeXN0ZW0gdG8gYmUgbGl0dGxlLWVuZGlhbiEiO2Z1bmN0aW9uIFgoZSl7Zm9yKDtlLmxlbmd0aD4wOyl7dmFyIHQ9ZS5zaGlmdCgpO2lmKCJmdW5jdGlvbiIhPXR5cGVvZiB0KXt2YXIgcj10LmZ1bmM7Im51bWJlciI9PXR5cGVvZiByP3ZvaWQgMD09PXQuYXJnP28uZHluQ2FsbF92KHIpOm8uZHluQ2FsbF92aShyLHQuYXJnKTpyKHZvaWQgMD09PXQuYXJnP251bGw6dC5hcmcpfWVsc2UgdCgpfX12YXIgSz1bXSxKPVtdLFo9W10sUT1bXSxlZT1bXSx0ZT0hMTtmdW5jdGlvbiByZShlLHQscil7Zm9yKHZhciBuPTA7bjxlLmxlbmd0aDsrK24pUlt0Kys+PjBdPWUuY2hhckNvZGVBdChuKTtyfHwoUlt0Pj4wXT0wKX12YXIgbmU9TWF0aC5hYnMsb2U9TWF0aC5jZWlsLGllPU1hdGguZmxvb3IsYWU9TWF0aC5taW4sc2U9MCx1ZT1udWxsO2Z1bmN0aW9uIGNlKGUpe3NlKyssby5tb25pdG9yUnVuRGVwZW5kZW5jaWVzJiZvLm1vbml0b3JSdW5EZXBlbmRlbmNpZXMoc2UpfWZ1bmN0aW9uIGxlKGUpe2lmKHNlLS0sby5tb25pdG9yUnVuRGVwZW5kZW5jaWVzJiZvLm1vbml0b3JSdW5EZXBlbmRlbmNpZXMoc2UpLDA9PXNlJiZ1ZSl7dmFyIHQ9dWU7dWU9bnVsbCx0KCl9fW8ucHJlbG9hZGVkSW1hZ2VzPXt9LG8ucHJlbG9hZGVkQXVkaW9zPXt9O2Z1bmN0aW9uIGZlKGUpe3JldHVybiBTdHJpbmcucHJvdG90eXBlLnN0YXJ0c1dpdGg/ZS5zdGFydHNXaXRoKCJkYXRhOmFwcGxpY2F0aW9uL29jdGV0LXN0cmVhbTtiYXNlNjQsIik6MD09PWUuaW5kZXhPZigiZGF0YTphcHBsaWNhdGlvbi9vY3RldC1zdHJlYW07YmFzZTY0LCIpfSFmdW5jdGlvbigpe3ZhciB0PSJ1bnBhY2sud2FzdCIscj0idW5wYWNrLnRlbXAuYXNtLmpzIjsiZnVuY3Rpb24iPT10eXBlb2Ygby5sb2NhdGVGaWxlJiYoZmUodCl8fCh0PW8ubG9jYXRlRmlsZSh0KSksZmUoZSl8fChlPW8ubG9jYXRlRmlsZShlKSksZmUocil8fChyPW8ubG9jYXRlRmlsZShyKSkpO3ZhciBuPXtnbG9iYWw6bnVsbCxlbnY6bnVsbCxhc20yd2FzbTp7ImY2NC1yZW0iOmZ1bmN0aW9uKGUsdCl7cmV0dXJuIGUldH0sZGVidWdnZXI6ZnVuY3Rpb24oKXt9fSxwYXJlbnQ6b30saT1udWxsO2Z1bmN0aW9uIGEoKXt0cnl7aWYoby53YXNtQmluYXJ5KXJldHVybiBuZXcgVWludDhBcnJheShvLndhc21CaW5hcnkpO2lmKG8ucmVhZEJpbmFyeSlyZXR1cm4gby5yZWFkQmluYXJ5KGUpO3Rocm93Im9uIHRoZSB3ZWIsIHdlIG5lZWQgdGhlIHdhc20gYmluYXJ5IHRvIGJlIHByZWxvYWRlZCBhbmQgc2V0IG9uIE1vZHVsZVsnd2FzbUJpbmFyeSddLiBlbWNjLnB5IHdpbGwgZG8gdGhhdCBmb3IgeW91IHdoZW4gZ2VuZXJhdGluZyBIVE1MIChidXQgbm90IEpTKSJ9Y2F0Y2goZSl7cnIoZSl9fWZ1bmN0aW9uIHModCxyLHMpe2lmKCJvYmplY3QiIT10eXBlb2YgV2ViQXNzZW1ibHkpcmV0dXJuIG8ucHJpbnRFcnIoIm5vIG5hdGl2ZSB3YXNtIHN1cHBvcnQgZGV0ZWN0ZWQiKSwhMTtpZighKG8ud2FzbU1lbW9yeSBpbnN0YW5jZW9mIFdlYkFzc2VtYmx5Lk1lbW9yeSkpcmV0dXJuIG8ucHJpbnRFcnIoIm5vIG5hdGl2ZSB3YXNtIE1lbW9yeSBpbiB1c2UiKSwhMTtmdW5jdGlvbiBsKGUsdCl7KGk9ZS5leHBvcnRzKS5tZW1vcnkmJmZ1bmN0aW9uKGUpe3ZhciB0PW8uYnVmZmVyO2UuYnl0ZUxlbmd0aDx0LmJ5dGVMZW5ndGgmJm8ucHJpbnRFcnIoInRoZSBuZXcgYnVmZmVyIGluIG1lcmdlTWVtb3J5IGlzIHNtYWxsZXIgdGhhbiB0aGUgcHJldmlvdXMgb25lLiBpbiBuYXRpdmUgd2FzbSwgd2Ugc2hvdWxkIGdyb3cgbWVtb3J5IGhlcmUiKTt2YXIgcj1uZXcgSW50OEFycmF5KHQpO25ldyBJbnQ4QXJyYXkoZSkuc2V0KHIpLFkoZSksVigpfShpLm1lbW9yeSksby5hc209aSxvLnVzaW5nV2FzbT0hMCxsZSgpfWlmKHIubWVtb3J5PW8ud2FzbU1lbW9yeSxuLmdsb2JhbD17TmFOOk5hTixJbmZpbml0eToxLzB9LG5bImdsb2JhbC5NYXRoIl09TWF0aCxuLmVudj1yLGNlKCksby5pbnN0YW50aWF0ZVdhc20pdHJ5e3JldHVybiBvLmluc3RhbnRpYXRlV2FzbShuLGwpfWNhdGNoKGUpe3JldHVybiBvLnByaW50RXJyKCJNb2R1bGUuaW5zdGFudGlhdGVXYXNtIGNhbGxiYWNrIGZhaWxlZCB3aXRoIGVycm9yOiAiK2UpLCExfWZ1bmN0aW9uIGYoZSl7bChlLmluc3RhbmNlLGUubW9kdWxlKX1mdW5jdGlvbiBkKHQpeyhvLndhc21CaW5hcnl8fCF1JiYhY3x8ImZ1bmN0aW9uIiE9dHlwZW9mIGZldGNoP25ldyBQcm9taXNlKChmdW5jdGlvbihlLHQpe2UoYSgpKX0pKTpmZXRjaChlLHtjcmVkZW50aWFsczoib21pdCJ9KS50aGVuKChmdW5jdGlvbih0KXtpZighdC5vayl0aHJvdyJmYWlsZWQgdG8gbG9hZCB3YXNtIGJpbmFyeSBmaWxlIGF0ICciK2UrIiciO3JldHVybiB0LmFycmF5QnVmZmVyKCl9KSkuY2F0Y2goKGZ1bmN0aW9uKCl7cmV0dXJuIGEoKX0pKSkudGhlbigoZnVuY3Rpb24oZSl7cmV0dXJuIFdlYkFzc2VtYmx5Lmluc3RhbnRpYXRlKGUsbil9KSkudGhlbih0KS5jYXRjaCgoZnVuY3Rpb24oZSl7by5wcmludEVycigiZmFpbGVkIHRvIGFzeW5jaHJvbm91c2x5IHByZXBhcmUgd2FzbTogIitlKSxycihlKX0pKX1yZXR1cm4gby53YXNtQmluYXJ5fHwiZnVuY3Rpb24iIT10eXBlb2YgV2ViQXNzZW1ibHkuaW5zdGFudGlhdGVTdHJlYW1pbmd8fGZlKGUpfHwiZnVuY3Rpb24iIT10eXBlb2YgZmV0Y2g/ZChmKTpXZWJBc3NlbWJseS5pbnN0YW50aWF0ZVN0cmVhbWluZyhmZXRjaChlLHtjcmVkZW50aWFsczoib21pdCJ9KSxuKS50aGVuKGYpLmNhdGNoKChmdW5jdGlvbihlKXtvLnByaW50RXJyKCJ3YXNtIHN0cmVhbWluZyBjb21waWxlIGZhaWxlZDogIitlKSxvLnByaW50RXJyKCJmYWxsaW5nIGJhY2sgdG8gQXJyYXlCdWZmZXIgaW5zdGFudGlhdGlvbiIpLGQoZil9KSkse319by5hc21QcmVsb2FkPW8uYXNtLG8ucmVhbGxvY0J1ZmZlcj1mdW5jdGlvbihlKXtyZXR1cm4gZnVuY3Rpb24oZSl7ZT1XKGUsby51c2luZ1dhc20/NjU1MzY6MTY3NzcyMTYpO3ZhciB0PW8uYnVmZmVyLmJ5dGVMZW5ndGg7aWYoby51c2luZ1dhc20pdHJ5e3JldHVybi0xIT09by53YXNtTWVtb3J5Lmdyb3coKGUtdCkvNjU1MzYpP28uYnVmZmVyPW8ud2FzbU1lbW9yeS5idWZmZXI6bnVsbH1jYXRjaChlKXtyZXR1cm4gbnVsbH19KGUpfSxvLmFzbT1mdW5jdGlvbihlLHQscil7aWYoISh0PXQpLnRhYmxlKXt2YXIgbj1vLndhc21UYWJsZVNpemU7dm9pZCAwPT09biYmKG49MTAyNCk7dmFyIGk9by53YXNtTWF4VGFibGVTaXplOyJvYmplY3QiPT10eXBlb2YgV2ViQXNzZW1ibHkmJiJmdW5jdGlvbiI9PXR5cGVvZiBXZWJBc3NlbWJseS5UYWJsZT90LnRhYmxlPXZvaWQgMCE9PWk/bmV3IFdlYkFzc2VtYmx5LlRhYmxlKHtpbml0aWFsOm4sbWF4aW11bTppLGVsZW1lbnQ6ImFueWZ1bmMifSk6bmV3IFdlYkFzc2VtYmx5LlRhYmxlKHtpbml0aWFsOm4sZWxlbWVudDoiYW55ZnVuYyJ9KTp0LnRhYmxlPW5ldyBBcnJheShuKSxvLndhc21UYWJsZT10LnRhYmxlfXZhciBhO3JldHVybiB0Lm1lbW9yeUJhc2V8fCh0Lm1lbW9yeUJhc2U9by5TVEFUSUNfQkFTRSksdC50YWJsZUJhc2V8fCh0LnRhYmxlQmFzZT0wKSwoYT1zKDAsdCkpfHxycigibm8gYmluYXJ5ZW4gbWV0aG9kIHN1Y2NlZWRlZC4gY29uc2lkZXIgZW5hYmxpbmcgbW9yZSBvcHRpb25zLCBsaWtlIGludGVycHJldGluZywgaWYgeW91IHdhbnQgdGhhdDogaHR0cHM6Ly9naXRodWIuY29tL2tyaXBrZW4vZW1zY3JpcHRlbi93aWtpL1dlYkFzc2VtYmx5I2JpbmFyeWVuLW1ldGhvZHMiKSxhfX0oKSxMPTY3OTg0LEoucHVzaCh7ZnVuYzpmdW5jdGlvbigpe0d0KCl9fSx7ZnVuYzpmdW5jdGlvbigpe0h0KCl9fSx7ZnVuYzpmdW5jdGlvbigpe1Z0KCl9fSx7ZnVuYzpmdW5jdGlvbigpe1l0KCl9fSk7by5TVEFUSUNfQkFTRT0xMDI0LG8uU1RBVElDX0JVTVA9NjY5NjAsTCs9MTY7dmFyIGRlPXtsYXN0OjAsY2F1Z2h0OltdLGluZm9zOnt9LGRlQWRqdXN0OmZ1bmN0aW9uKGUpe2lmKCFlfHxkZS5pbmZvc1tlXSlyZXR1cm4gZTtmb3IodmFyIHQgaW4gZGUuaW5mb3Mpe3ZhciByPSt0O2lmKGRlLmluZm9zW3JdLmFkanVzdGVkPT09ZSlyZXR1cm4gcn1yZXR1cm4gZX0sYWRkUmVmOmZ1bmN0aW9uKGUpe2UmJmRlLmluZm9zW2VdLnJlZmNvdW50Kyt9LGRlY1JlZjpmdW5jdGlvbihlKXtpZihlKXt2YXIgdD1kZS5pbmZvc1tlXTt5KHQucmVmY291bnQ+MCksdC5yZWZjb3VudC0tLDAhPT10LnJlZmNvdW50fHx0LnJldGhyb3dufHwodC5kZXN0cnVjdG9yJiZvLmR5bkNhbGxfdmkodC5kZXN0cnVjdG9yLGUpLGRlbGV0ZSBkZS5pbmZvc1tlXSxoZShlKSl9fSxjbGVhclJlZjpmdW5jdGlvbihlKXtlJiYoZGUuaW5mb3NbZV0ucmVmY291bnQ9MCl9fTtmdW5jdGlvbiBoZShlKXt0cnl7cmV0dXJuIEt0KGUpfWNhdGNoKGUpe319ZnVuY3Rpb24gcGUoKXt2YXIgZT1kZS5sYXN0O2lmKCFlKXJldHVybiAwfChadCgwKSwwKTt2YXIgdD1kZS5pbmZvc1tlXSxyPXQudHlwZTtpZighcilyZXR1cm4gMHwoWnQoMCksZSk7dmFyIG49QXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKTtvLl9fX2N4YV9pc19wb2ludGVyX3R5cGUocik7cGUuYnVmZmVyfHwocGUuYnVmZmVyPUp0KDQpKSxGW3BlLmJ1ZmZlcj4+Ml09ZSxlPXBlLmJ1ZmZlcjtmb3IodmFyIGk9MDtpPG4ubGVuZ3RoO2krKylpZihuW2ldJiZvLl9fX2N4YV9jYW5fY2F0Y2gobltpXSxyLGUpKXJldHVybiBlPUZbZT4+Ml0sdC5hZGp1c3RlZD1lLDB8KFp0KG5baV0pLGUpO3JldHVybiBlPUZbZT4+Ml0sMHwoWnQociksZSl9dmFyIG1lPXtFUEVSTToxLEVOT0VOVDoyLEVTUkNIOjMsRUlOVFI6NCxFSU86NSxFTlhJTzo2LEUyQklHOjcsRU5PRVhFQzo4LEVCQURGOjksRUNISUxEOjEwLEVBR0FJTjoxMSxFV09VTERCTE9DSzoxMSxFTk9NRU06MTIsRUFDQ0VTOjEzLEVGQVVMVDoxNCxFTk9UQkxLOjE1LEVCVVNZOjE2LEVFWElTVDoxNyxFWERFVjoxOCxFTk9ERVY6MTksRU5PVERJUjoyMCxFSVNESVI6MjEsRUlOVkFMOjIyLEVORklMRToyMyxFTUZJTEU6MjQsRU5PVFRZOjI1LEVUWFRCU1k6MjYsRUZCSUc6MjcsRU5PU1BDOjI4LEVTUElQRToyOSxFUk9GUzozMCxFTUxJTks6MzEsRVBJUEU6MzIsRURPTTozMyxFUkFOR0U6MzQsRU5PTVNHOjQyLEVJRFJNOjQzLEVDSFJORzo0NCxFTDJOU1lOQzo0NSxFTDNITFQ6NDYsRUwzUlNUOjQ3LEVMTlJORzo0OCxFVU5BVENIOjQ5LEVOT0NTSTo1MCxFTDJITFQ6NTEsRURFQURMSzozNSxFTk9MQ0s6MzcsRUJBREU6NTIsRUJBRFI6NTMsRVhGVUxMOjU0LEVOT0FOTzo1NSxFQkFEUlFDOjU2LEVCQURTTFQ6NTcsRURFQURMT0NLOjM1LEVCRk9OVDo1OSxFTk9TVFI6NjAsRU5PREFUQTo2MSxFVElNRTo2MixFTk9TUjo2MyxFTk9ORVQ6NjQsRU5PUEtHOjY1LEVSRU1PVEU6NjYsRU5PTElOSzo2NyxFQURWOjY4LEVTUk1OVDo2OSxFQ09NTTo3MCxFUFJPVE86NzEsRU1VTFRJSE9QOjcyLEVET1RET1Q6NzMsRUJBRE1TRzo3NCxFTk9UVU5JUTo3NixFQkFERkQ6NzcsRVJFTUNIRzo3OCxFTElCQUNDOjc5LEVMSUJCQUQ6ODAsRUxJQlNDTjo4MSxFTElCTUFYOjgyLEVMSUJFWEVDOjgzLEVOT1NZUzozOCxFTk9URU1QVFk6MzksRU5BTUVUT09MT05HOjM2LEVMT09QOjQwLEVPUE5PVFNVUFA6OTUsRVBGTk9TVVBQT1JUOjk2LEVDT05OUkVTRVQ6MTA0LEVOT0JVRlM6MTA1LEVBRk5PU1VQUE9SVDo5NyxFUFJPVE9UWVBFOjkxLEVOT1RTT0NLOjg4LEVOT1BST1RPT1BUOjkyLEVTSFVURE9XTjoxMDgsRUNPTk5SRUZVU0VEOjExMSxFQUREUklOVVNFOjk4LEVDT05OQUJPUlRFRDoxMDMsRU5FVFVOUkVBQ0g6MTAxLEVORVRET1dOOjEwMCxFVElNRURPVVQ6MTEwLEVIT1NURE9XTjoxMTIsRUhPU1RVTlJFQUNIOjExMyxFSU5QUk9HUkVTUzoxMTUsRUFMUkVBRFk6MTE0LEVERVNUQUREUlJFUTo4OSxFTVNHU0laRTo5MCxFUFJPVE9OT1NVUFBPUlQ6OTMsRVNPQ0tUTk9TVVBQT1JUOjk0LEVBRERSTk9UQVZBSUw6OTksRU5FVFJFU0VUOjEwMixFSVNDT05OOjEwNixFTk9UQ09OTjoxMDcsRVRPT01BTllSRUZTOjEwOSxFVVNFUlM6ODcsRURRVU9UOjEyMixFU1RBTEU6MTE2LEVOT1RTVVA6OTUsRU5PTUVESVVNOjEyMyxFSUxTRVE6ODQsRU9WRVJGTE9XOjc1LEVDQU5DRUxFRDoxMjUsRU5PVFJFQ09WRVJBQkxFOjEzMSxFT1dORVJERUFEOjEzMCxFU1RSUElQRTo4Nn07ZnVuY3Rpb24geWUoZSl7cmV0dXJuIG8uX19fZXJybm9fbG9jYXRpb24mJihGW28uX19fZXJybm9fbG9jYXRpb24oKT4+Ml09ZSksZX12YXIgRWU9ezA6IlN1Y2Nlc3MiLDE6Ik5vdCBzdXBlci11c2VyIiwyOiJObyBzdWNoIGZpbGUgb3IgZGlyZWN0b3J5IiwzOiJObyBzdWNoIHByb2Nlc3MiLDQ6IkludGVycnVwdGVkIHN5c3RlbSBjYWxsIiw1OiJJL08gZXJyb3IiLDY6Ik5vIHN1Y2ggZGV2aWNlIG9yIGFkZHJlc3MiLDc6IkFyZyBsaXN0IHRvbyBsb25nIiw4OiJFeGVjIGZvcm1hdCBlcnJvciIsOToiQmFkIGZpbGUgbnVtYmVyIiwxMDoiTm8gY2hpbGRyZW4iLDExOiJObyBtb3JlIHByb2Nlc3NlcyIsMTI6Ik5vdCBlbm91Z2ggY29yZSIsMTM6IlBlcm1pc3Npb24gZGVuaWVkIiwxNDoiQmFkIGFkZHJlc3MiLDE1OiJCbG9jayBkZXZpY2UgcmVxdWlyZWQiLDE2OiJNb3VudCBkZXZpY2UgYnVzeSIsMTc6IkZpbGUgZXhpc3RzIiwxODoiQ3Jvc3MtZGV2aWNlIGxpbmsiLDE5OiJObyBzdWNoIGRldmljZSIsMjA6Ik5vdCBhIGRpcmVjdG9yeSIsMjE6IklzIGEgZGlyZWN0b3J5IiwyMjoiSW52YWxpZCBhcmd1bWVudCIsMjM6IlRvbyBtYW55IG9wZW4gZmlsZXMgaW4gc3lzdGVtIiwyNDoiVG9vIG1hbnkgb3BlbiBmaWxlcyIsMjU6Ik5vdCBhIHR5cGV3cml0ZXIiLDI2OiJUZXh0IGZpbGUgYnVzeSIsMjc6IkZpbGUgdG9vIGxhcmdlIiwyODoiTm8gc3BhY2UgbGVmdCBvbiBkZXZpY2UiLDI5OiJJbGxlZ2FsIHNlZWsiLDMwOiJSZWFkIG9ubHkgZmlsZSBzeXN0ZW0iLDMxOiJUb28gbWFueSBsaW5rcyIsMzI6IkJyb2tlbiBwaXBlIiwzMzoiTWF0aCBhcmcgb3V0IG9mIGRvbWFpbiBvZiBmdW5jIiwzNDoiTWF0aCByZXN1bHQgbm90IHJlcHJlc2VudGFibGUiLDM1OiJGaWxlIGxvY2tpbmcgZGVhZGxvY2sgZXJyb3IiLDM2OiJGaWxlIG9yIHBhdGggbmFtZSB0b28gbG9uZyIsMzc6Ik5vIHJlY29yZCBsb2NrcyBhdmFpbGFibGUiLDM4OiJGdW5jdGlvbiBub3QgaW1wbGVtZW50ZWQiLDM5OiJEaXJlY3Rvcnkgbm90IGVtcHR5Iiw0MDoiVG9vIG1hbnkgc3ltYm9saWMgbGlua3MiLDQyOiJObyBtZXNzYWdlIG9mIGRlc2lyZWQgdHlwZSIsNDM6IklkZW50aWZpZXIgcmVtb3ZlZCIsNDQ6IkNoYW5uZWwgbnVtYmVyIG91dCBvZiByYW5nZSIsNDU6IkxldmVsIDIgbm90IHN5bmNocm9uaXplZCIsNDY6IkxldmVsIDMgaGFsdGVkIiw0NzoiTGV2ZWwgMyByZXNldCIsNDg6IkxpbmsgbnVtYmVyIG91dCBvZiByYW5nZSIsNDk6IlByb3RvY29sIGRyaXZlciBub3QgYXR0YWNoZWQiLDUwOiJObyBDU0kgc3RydWN0dXJlIGF2YWlsYWJsZSIsNTE6IkxldmVsIDIgaGFsdGVkIiw1MjoiSW52YWxpZCBleGNoYW5nZSIsNTM6IkludmFsaWQgcmVxdWVzdCBkZXNjcmlwdG9yIiw1NDoiRXhjaGFuZ2UgZnVsbCIsNTU6Ik5vIGFub2RlIiw1NjoiSW52YWxpZCByZXF1ZXN0IGNvZGUiLDU3OiJJbnZhbGlkIHNsb3QiLDU5OiJCYWQgZm9udCBmaWxlIGZtdCIsNjA6IkRldmljZSBub3QgYSBzdHJlYW0iLDYxOiJObyBkYXRhIChmb3Igbm8gZGVsYXkgaW8pIiw2MjoiVGltZXIgZXhwaXJlZCIsNjM6Ik91dCBvZiBzdHJlYW1zIHJlc291cmNlcyIsNjQ6Ik1hY2hpbmUgaXMgbm90IG9uIHRoZSBuZXR3b3JrIiw2NToiUGFja2FnZSBub3QgaW5zdGFsbGVkIiw2NjoiVGhlIG9iamVjdCBpcyByZW1vdGUiLDY3OiJUaGUgbGluayBoYXMgYmVlbiBzZXZlcmVkIiw2ODoiQWR2ZXJ0aXNlIGVycm9yIiw2OToiU3Jtb3VudCBlcnJvciIsNzA6IkNvbW11bmljYXRpb24gZXJyb3Igb24gc2VuZCIsNzE6IlByb3RvY29sIGVycm9yIiw3MjoiTXVsdGlob3AgYXR0ZW1wdGVkIiw3MzoiQ3Jvc3MgbW91bnQgcG9pbnQgKG5vdCByZWFsbHkgZXJyb3IpIiw3NDoiVHJ5aW5nIHRvIHJlYWQgdW5yZWFkYWJsZSBtZXNzYWdlIiw3NToiVmFsdWUgdG9vIGxhcmdlIGZvciBkZWZpbmVkIGRhdGEgdHlwZSIsNzY6IkdpdmVuIGxvZy4gbmFtZSBub3QgdW5pcXVlIiw3NzoiZi5kLiBpbnZhbGlkIGZvciB0aGlzIG9wZXJhdGlvbiIsNzg6IlJlbW90ZSBhZGRyZXNzIGNoYW5nZWQiLDc5OiJDYW4gICBhY2Nlc3MgYSBuZWVkZWQgc2hhcmVkIGxpYiIsODA6IkFjY2Vzc2luZyBhIGNvcnJ1cHRlZCBzaGFyZWQgbGliIiw4MToiLmxpYiBzZWN0aW9uIGluIGEub3V0IGNvcnJ1cHRlZCIsODI6IkF0dGVtcHRpbmcgdG8gbGluayBpbiB0b28gbWFueSBsaWJzIiw4MzoiQXR0ZW1wdGluZyB0byBleGVjIGEgc2hhcmVkIGxpYnJhcnkiLDg0OiJJbGxlZ2FsIGJ5dGUgc2VxdWVuY2UiLDg2OiJTdHJlYW1zIHBpcGUgZXJyb3IiLDg3OiJUb28gbWFueSB1c2VycyIsODg6IlNvY2tldCBvcGVyYXRpb24gb24gbm9uLXNvY2tldCIsODk6IkRlc3RpbmF0aW9uIGFkZHJlc3MgcmVxdWlyZWQiLDkwOiJNZXNzYWdlIHRvbyBsb25nIiw5MToiUHJvdG9jb2wgd3JvbmcgdHlwZSBmb3Igc29ja2V0Iiw5MjoiUHJvdG9jb2wgbm90IGF2YWlsYWJsZSIsOTM6IlVua25vd24gcHJvdG9jb2wiLDk0OiJTb2NrZXQgdHlwZSBub3Qgc3VwcG9ydGVkIiw5NToiTm90IHN1cHBvcnRlZCIsOTY6IlByb3RvY29sIGZhbWlseSBub3Qgc3VwcG9ydGVkIiw5NzoiQWRkcmVzcyBmYW1pbHkgbm90IHN1cHBvcnRlZCBieSBwcm90b2NvbCBmYW1pbHkiLDk4OiJBZGRyZXNzIGFscmVhZHkgaW4gdXNlIiw5OToiQWRkcmVzcyBub3QgYXZhaWxhYmxlIiwxMDA6Ik5ldHdvcmsgaW50ZXJmYWNlIGlzIG5vdCBjb25maWd1cmVkIiwxMDE6Ik5ldHdvcmsgaXMgdW5yZWFjaGFibGUiLDEwMjoiQ29ubmVjdGlvbiByZXNldCBieSBuZXR3b3JrIiwxMDM6IkNvbm5lY3Rpb24gYWJvcnRlZCIsMTA0OiJDb25uZWN0aW9uIHJlc2V0IGJ5IHBlZXIiLDEwNToiTm8gYnVmZmVyIHNwYWNlIGF2YWlsYWJsZSIsMTA2OiJTb2NrZXQgaXMgYWxyZWFkeSBjb25uZWN0ZWQiLDEwNzoiU29ja2V0IGlzIG5vdCBjb25uZWN0ZWQiLDEwODoiQ2FuJ3Qgc2VuZCBhZnRlciBzb2NrZXQgc2h1dGRvd24iLDEwOToiVG9vIG1hbnkgcmVmZXJlbmNlcyIsMTEwOiJDb25uZWN0aW9uIHRpbWVkIG91dCIsMTExOiJDb25uZWN0aW9uIHJlZnVzZWQiLDExMjoiSG9zdCBpcyBkb3duIiwxMTM6Ikhvc3QgaXMgdW5yZWFjaGFibGUiLDExNDoiU29ja2V0IGFscmVhZHkgY29ubmVjdGVkIiwxMTU6IkNvbm5lY3Rpb24gYWxyZWFkeSBpbiBwcm9ncmVzcyIsMTE2OiJTdGFsZSBmaWxlIGhhbmRsZSIsMTIyOiJRdW90YSBleGNlZWRlZCIsMTIzOiJObyBtZWRpdW0gKGluIHRhcGUgZHJpdmUpIiwxMjU6Ik9wZXJhdGlvbiBjYW5jZWxlZCIsMTMwOiJQcmV2aW91cyBvd25lciBkaWVkIiwxMzE6IlN0YXRlIG5vdCByZWNvdmVyYWJsZSJ9LGdlPXtzcGxpdFBhdGg6ZnVuY3Rpb24oZSl7cmV0dXJuL14oXC8/fCkoW1xzXFNdKj8pKCg/OlwuezEsMn18W15cL10rP3wpKFwuW14uXC9dKnwpKSg/OltcL10qKSQvLmV4ZWMoZSkuc2xpY2UoMSl9LG5vcm1hbGl6ZUFycmF5OmZ1bmN0aW9uKGUsdCl7Zm9yKHZhciByPTAsbj1lLmxlbmd0aC0xO24+PTA7bi0tKXt2YXIgbz1lW25dOyIuIj09PW8/ZS5zcGxpY2UobiwxKToiLi4iPT09bz8oZS5zcGxpY2UobiwxKSxyKyspOnImJihlLnNwbGljZShuLDEpLHItLSl9aWYodClmb3IoO3I7ci0tKWUudW5zaGlmdCgiLi4iKTtyZXR1cm4gZX0sbm9ybWFsaXplOmZ1bmN0aW9uKGUpe3ZhciB0PSIvIj09PWUuY2hhckF0KDApLHI9Ii8iPT09ZS5zdWJzdHIoLTEpO3JldHVybihlPWdlLm5vcm1hbGl6ZUFycmF5KGUuc3BsaXQoIi8iKS5maWx0ZXIoKGZ1bmN0aW9uKGUpe3JldHVybiEhZX0pKSwhdCkuam9pbigiLyIpKXx8dHx8KGU9Ii4iKSxlJiZyJiYoZSs9Ii8iKSwodD8iLyI6IiIpK2V9LGRpcm5hbWU6ZnVuY3Rpb24oZSl7dmFyIHQ9Z2Uuc3BsaXRQYXRoKGUpLHI9dFswXSxuPXRbMV07cmV0dXJuIHJ8fG4/KG4mJihuPW4uc3Vic3RyKDAsbi5sZW5ndGgtMSkpLHIrbik6Ii4ifSxiYXNlbmFtZTpmdW5jdGlvbihlKXtpZigiLyI9PT1lKXJldHVybiIvIjt2YXIgdD1lLmxhc3RJbmRleE9mKCIvIik7cmV0dXJuLTE9PT10P2U6ZS5zdWJzdHIodCsxKX0sZXh0bmFtZTpmdW5jdGlvbihlKXtyZXR1cm4gZ2Uuc3BsaXRQYXRoKGUpWzNdfSxqb2luOmZ1bmN0aW9uKCl7dmFyIGU9QXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLDApO3JldHVybiBnZS5ub3JtYWxpemUoZS5qb2luKCIvIikpfSxqb2luMjpmdW5jdGlvbihlLHQpe3JldHVybiBnZS5ub3JtYWxpemUoZSsiLyIrdCl9LHJlc29sdmU6ZnVuY3Rpb24oKXtmb3IodmFyIGU9IiIsdD0hMSxyPWFyZ3VtZW50cy5sZW5ndGgtMTtyPj0tMSYmIXQ7ci0tKXt2YXIgbj1yPj0wP2FyZ3VtZW50c1tyXTpUZS5jd2QoKTtpZigic3RyaW5nIiE9dHlwZW9mIG4pdGhyb3cgbmV3IFR5cGVFcnJvcigiQXJndW1lbnRzIHRvIHBhdGgucmVzb2x2ZSBtdXN0IGJlIHN0cmluZ3MiKTtpZighbilyZXR1cm4iIjtlPW4rIi8iK2UsdD0iLyI9PT1uLmNoYXJBdCgwKX1yZXR1cm4odD8iLyI6IiIpKyhlPWdlLm5vcm1hbGl6ZUFycmF5KGUuc3BsaXQoIi8iKS5maWx0ZXIoKGZ1bmN0aW9uKGUpe3JldHVybiEhZX0pKSwhdCkuam9pbigiLyIpKXx8Ii4ifSxyZWxhdGl2ZTpmdW5jdGlvbihlLHQpe2Z1bmN0aW9uIHIoZSl7Zm9yKHZhciB0PTA7dDxlLmxlbmd0aCYmIiI9PT1lW3RdO3QrKyk7Zm9yKHZhciByPWUubGVuZ3RoLTE7cj49MCYmIiI9PT1lW3JdO3ItLSk7cmV0dXJuIHQ+cj9bXTplLnNsaWNlKHQsci10KzEpfWU9Z2UucmVzb2x2ZShlKS5zdWJzdHIoMSksdD1nZS5yZXNvbHZlKHQpLnN1YnN0cigxKTtmb3IodmFyIG49cihlLnNwbGl0KCIvIikpLG89cih0LnNwbGl0KCIvIikpLGk9TWF0aC5taW4obi5sZW5ndGgsby5sZW5ndGgpLGE9aSxzPTA7czxpO3MrKylpZihuW3NdIT09b1tzXSl7YT1zO2JyZWFrfXZhciB1PVtdO2ZvcihzPWE7czxuLmxlbmd0aDtzKyspdS5wdXNoKCIuLiIpO3JldHVybih1PXUuY29uY2F0KG8uc2xpY2UoYSkpKS5qb2luKCIvIil9fSx2ZT17dHR5czpbXSxpbml0OmZ1bmN0aW9uKCl7fSxzaHV0ZG93bjpmdW5jdGlvbigpe30scmVnaXN0ZXI6ZnVuY3Rpb24oZSx0KXt2ZS50dHlzW2VdPXtpbnB1dDpbXSxvdXRwdXQ6W10sb3BzOnR9LFRlLnJlZ2lzdGVyRGV2aWNlKGUsdmUuc3RyZWFtX29wcyl9LHN0cmVhbV9vcHM6e29wZW46ZnVuY3Rpb24oZSl7dmFyIHQ9dmUudHR5c1tlLm5vZGUucmRldl07aWYoIXQpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRU5PREVWKTtlLnR0eT10LGUuc2Vla2FibGU9ITF9LGNsb3NlOmZ1bmN0aW9uKGUpe2UudHR5Lm9wcy5mbHVzaChlLnR0eSl9LGZsdXNoOmZ1bmN0aW9uKGUpe2UudHR5Lm9wcy5mbHVzaChlLnR0eSl9LHJlYWQ6ZnVuY3Rpb24oZSx0LHIsbixvKXtpZighZS50dHl8fCFlLnR0eS5vcHMuZ2V0X2NoYXIpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRU5YSU8pO2Zvcih2YXIgaT0wLGE9MDthPG47YSsrKXt2YXIgczt0cnl7cz1lLnR0eS5vcHMuZ2V0X2NoYXIoZS50dHkpfWNhdGNoKGUpe3Rocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVJTyl9aWYodm9pZCAwPT09cyYmMD09PWkpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRUFHQUlOKTtpZihudWxsPT1zKWJyZWFrO2krKyx0W3IrYV09c31yZXR1cm4gaSYmKGUubm9kZS50aW1lc3RhbXA9RGF0ZS5ub3coKSksaX0sd3JpdGU6ZnVuY3Rpb24oZSx0LHIsbixvKXtpZighZS50dHl8fCFlLnR0eS5vcHMucHV0X2NoYXIpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRU5YSU8pO2Zvcih2YXIgaT0wO2k8bjtpKyspdHJ5e2UudHR5Lm9wcy5wdXRfY2hhcihlLnR0eSx0W3IraV0pfWNhdGNoKGUpe3Rocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVJTyl9cmV0dXJuIG4mJihlLm5vZGUudGltZXN0YW1wPURhdGUubm93KCkpLGl9fSxkZWZhdWx0X3R0eV9vcHM6e2dldF9jaGFyOmZ1bmN0aW9uKGUpe2lmKCFlLmlucHV0Lmxlbmd0aCl7dmFyIHQ9bnVsbDtpZihsKXt2YXIgcj1uZXcgQnVmZmVyKDI1Niksbj0wLG89IndpbjMyIiE9cHJvY2Vzcy5wbGF0Zm9ybSxpPXByb2Nlc3Muc3RkaW4uZmQ7aWYobyl7dmFyIGE9ITE7dHJ5e2k9ZnMub3BlblN5bmMoIi9kZXYvc3RkaW4iLCJyIiksYT0hMH1jYXRjaChlKXt9fXRyeXtuPWZzLnJlYWRTeW5jKGksciwwLDI1NixudWxsKX1jYXRjaChlKXtpZigtMT09ZS50b1N0cmluZygpLmluZGV4T2YoIkVPRiIpKXRocm93IGU7bj0wfWEmJmZzLmNsb3NlU3luYyhpKSx0PW4+MD9yLnNsaWNlKDAsbikudG9TdHJpbmcoInV0Zi04Iik6bnVsbH1lbHNlInVuZGVmaW5lZCIhPXR5cGVvZiB3aW5kb3cmJiJmdW5jdGlvbiI9PXR5cGVvZiB3aW5kb3cucHJvbXB0P251bGwhPT0odD13aW5kb3cucHJvbXB0KCJJbnB1dDogIikpJiYodCs9IlxuIik6ImZ1bmN0aW9uIj09dHlwZW9mIHJlYWRsaW5lJiZudWxsIT09KHQ9cmVhZGxpbmUoKSkmJih0Kz0iXG4iKTtpZighdClyZXR1cm4gbnVsbDtlLmlucHV0PSR0KHQsITApfXJldHVybiBlLmlucHV0LnNoaWZ0KCl9LHB1dF9jaGFyOmZ1bmN0aW9uKGUsdCl7bnVsbD09PXR8fDEwPT09dD8oby5wcmludChfKGUub3V0cHV0LDApKSxlLm91dHB1dD1bXSk6MCE9dCYmZS5vdXRwdXQucHVzaCh0KX0sZmx1c2g6ZnVuY3Rpb24oZSl7ZS5vdXRwdXQmJmUub3V0cHV0Lmxlbmd0aD4wJiYoby5wcmludChfKGUub3V0cHV0LDApKSxlLm91dHB1dD1bXSl9fSxkZWZhdWx0X3R0eTFfb3BzOntwdXRfY2hhcjpmdW5jdGlvbihlLHQpe251bGw9PT10fHwxMD09PXQ/KG8ucHJpbnRFcnIoXyhlLm91dHB1dCwwKSksZS5vdXRwdXQ9W10pOjAhPXQmJmUub3V0cHV0LnB1c2godCl9LGZsdXNoOmZ1bmN0aW9uKGUpe2Uub3V0cHV0JiZlLm91dHB1dC5sZW5ndGg+MCYmKG8ucHJpbnRFcnIoXyhlLm91dHB1dCwwKSksZS5vdXRwdXQ9W10pfX19LHdlPXtvcHNfdGFibGU6bnVsbCxtb3VudDpmdW5jdGlvbihlKXtyZXR1cm4gd2UuY3JlYXRlTm9kZShudWxsLCIvIiwxNjg5NSwwKX0sY3JlYXRlTm9kZTpmdW5jdGlvbihlLHQscixuKXtpZihUZS5pc0Jsa2RldihyKXx8VGUuaXNGSUZPKHIpKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVQRVJNKTt3ZS5vcHNfdGFibGV8fCh3ZS5vcHNfdGFibGU9e2Rpcjp7bm9kZTp7Z2V0YXR0cjp3ZS5ub2RlX29wcy5nZXRhdHRyLHNldGF0dHI6d2Uubm9kZV9vcHMuc2V0YXR0cixsb29rdXA6d2Uubm9kZV9vcHMubG9va3VwLG1rbm9kOndlLm5vZGVfb3BzLm1rbm9kLHJlbmFtZTp3ZS5ub2RlX29wcy5yZW5hbWUsdW5saW5rOndlLm5vZGVfb3BzLnVubGluayxybWRpcjp3ZS5ub2RlX29wcy5ybWRpcixyZWFkZGlyOndlLm5vZGVfb3BzLnJlYWRkaXIsc3ltbGluazp3ZS5ub2RlX29wcy5zeW1saW5rfSxzdHJlYW06e2xsc2Vlazp3ZS5zdHJlYW1fb3BzLmxsc2Vla319LGZpbGU6e25vZGU6e2dldGF0dHI6d2Uubm9kZV9vcHMuZ2V0YXR0cixzZXRhdHRyOndlLm5vZGVfb3BzLnNldGF0dHJ9LHN0cmVhbTp7bGxzZWVrOndlLnN0cmVhbV9vcHMubGxzZWVrLHJlYWQ6d2Uuc3RyZWFtX29wcy5yZWFkLHdyaXRlOndlLnN0cmVhbV9vcHMud3JpdGUsYWxsb2NhdGU6d2Uuc3RyZWFtX29wcy5hbGxvY2F0ZSxtbWFwOndlLnN0cmVhbV9vcHMubW1hcCxtc3luYzp3ZS5zdHJlYW1fb3BzLm1zeW5jfX0sbGluazp7bm9kZTp7Z2V0YXR0cjp3ZS5ub2RlX29wcy5nZXRhdHRyLHNldGF0dHI6d2Uubm9kZV9vcHMuc2V0YXR0cixyZWFkbGluazp3ZS5ub2RlX29wcy5yZWFkbGlua30sc3RyZWFtOnt9fSxjaHJkZXY6e25vZGU6e2dldGF0dHI6d2Uubm9kZV9vcHMuZ2V0YXR0cixzZXRhdHRyOndlLm5vZGVfb3BzLnNldGF0dHJ9LHN0cmVhbTpUZS5jaHJkZXZfc3RyZWFtX29wc319KTt2YXIgbz1UZS5jcmVhdGVOb2RlKGUsdCxyLG4pO3JldHVybiBUZS5pc0RpcihvLm1vZGUpPyhvLm5vZGVfb3BzPXdlLm9wc190YWJsZS5kaXIubm9kZSxvLnN0cmVhbV9vcHM9d2Uub3BzX3RhYmxlLmRpci5zdHJlYW0sby5jb250ZW50cz17fSk6VGUuaXNGaWxlKG8ubW9kZSk/KG8ubm9kZV9vcHM9d2Uub3BzX3RhYmxlLmZpbGUubm9kZSxvLnN0cmVhbV9vcHM9d2Uub3BzX3RhYmxlLmZpbGUuc3RyZWFtLG8udXNlZEJ5dGVzPTAsby5jb250ZW50cz1udWxsKTpUZS5pc0xpbmsoby5tb2RlKT8oby5ub2RlX29wcz13ZS5vcHNfdGFibGUubGluay5ub2RlLG8uc3RyZWFtX29wcz13ZS5vcHNfdGFibGUubGluay5zdHJlYW0pOlRlLmlzQ2hyZGV2KG8ubW9kZSkmJihvLm5vZGVfb3BzPXdlLm9wc190YWJsZS5jaHJkZXYubm9kZSxvLnN0cmVhbV9vcHM9d2Uub3BzX3RhYmxlLmNocmRldi5zdHJlYW0pLG8udGltZXN0YW1wPURhdGUubm93KCksZSYmKGUuY29udGVudHNbdF09byksb30sZ2V0RmlsZURhdGFBc1JlZ3VsYXJBcnJheTpmdW5jdGlvbihlKXtpZihlLmNvbnRlbnRzJiZlLmNvbnRlbnRzLnN1YmFycmF5KXtmb3IodmFyIHQ9W10scj0wO3I8ZS51c2VkQnl0ZXM7KytyKXQucHVzaChlLmNvbnRlbnRzW3JdKTtyZXR1cm4gdH1yZXR1cm4gZS5jb250ZW50c30sZ2V0RmlsZURhdGFBc1R5cGVkQXJyYXk6ZnVuY3Rpb24oZSl7cmV0dXJuIGUuY29udGVudHM/ZS5jb250ZW50cy5zdWJhcnJheT9lLmNvbnRlbnRzLnN1YmFycmF5KDAsZS51c2VkQnl0ZXMpOm5ldyBVaW50OEFycmF5KGUuY29udGVudHMpOm5ldyBVaW50OEFycmF5fSxleHBhbmRGaWxlU3RvcmFnZTpmdW5jdGlvbihlLHQpe2lmKGUuY29udGVudHMmJmUuY29udGVudHMuc3ViYXJyYXkmJnQ+ZS5jb250ZW50cy5sZW5ndGgmJihlLmNvbnRlbnRzPXdlLmdldEZpbGVEYXRhQXNSZWd1bGFyQXJyYXkoZSksZS51c2VkQnl0ZXM9ZS5jb250ZW50cy5sZW5ndGgpLCFlLmNvbnRlbnRzfHxlLmNvbnRlbnRzLnN1YmFycmF5KXt2YXIgcj1lLmNvbnRlbnRzP2UuY29udGVudHMubGVuZ3RoOjA7aWYocj49dClyZXR1cm47dD1NYXRoLm1heCh0LHIqKHI8MTA0ODU3Nj8yOjEuMTI1KXwwKSwwIT1yJiYodD1NYXRoLm1heCh0LDI1NikpO3ZhciBuPWUuY29udGVudHM7cmV0dXJuIGUuY29udGVudHM9bmV3IFVpbnQ4QXJyYXkodCksdm9pZChlLnVzZWRCeXRlcz4wJiZlLmNvbnRlbnRzLnNldChuLnN1YmFycmF5KDAsZS51c2VkQnl0ZXMpLDApKX1mb3IoIWUuY29udGVudHMmJnQ+MCYmKGUuY29udGVudHM9W10pO2UuY29udGVudHMubGVuZ3RoPHQ7KWUuY29udGVudHMucHVzaCgwKX0scmVzaXplRmlsZVN0b3JhZ2U6ZnVuY3Rpb24oZSx0KXtpZihlLnVzZWRCeXRlcyE9dCl7aWYoMD09dClyZXR1cm4gZS5jb250ZW50cz1udWxsLHZvaWQoZS51c2VkQnl0ZXM9MCk7aWYoIWUuY29udGVudHN8fGUuY29udGVudHMuc3ViYXJyYXkpe3ZhciByPWUuY29udGVudHM7cmV0dXJuIGUuY29udGVudHM9bmV3IFVpbnQ4QXJyYXkobmV3IEFycmF5QnVmZmVyKHQpKSxyJiZlLmNvbnRlbnRzLnNldChyLnN1YmFycmF5KDAsTWF0aC5taW4odCxlLnVzZWRCeXRlcykpKSx2b2lkKGUudXNlZEJ5dGVzPXQpfWlmKGUuY29udGVudHN8fChlLmNvbnRlbnRzPVtdKSxlLmNvbnRlbnRzLmxlbmd0aD50KWUuY29udGVudHMubGVuZ3RoPXQ7ZWxzZSBmb3IoO2UuY29udGVudHMubGVuZ3RoPHQ7KWUuY29udGVudHMucHVzaCgwKTtlLnVzZWRCeXRlcz10fX0sbm9kZV9vcHM6e2dldGF0dHI6ZnVuY3Rpb24oZSl7dmFyIHQ9e307cmV0dXJuIHQuZGV2PVRlLmlzQ2hyZGV2KGUubW9kZSk/ZS5pZDoxLHQuaW5vPWUuaWQsdC5tb2RlPWUubW9kZSx0Lm5saW5rPTEsdC51aWQ9MCx0LmdpZD0wLHQucmRldj1lLnJkZXYsVGUuaXNEaXIoZS5tb2RlKT90LnNpemU9NDA5NjpUZS5pc0ZpbGUoZS5tb2RlKT90LnNpemU9ZS51c2VkQnl0ZXM6VGUuaXNMaW5rKGUubW9kZSk/dC5zaXplPWUubGluay5sZW5ndGg6dC5zaXplPTAsdC5hdGltZT1uZXcgRGF0ZShlLnRpbWVzdGFtcCksdC5tdGltZT1uZXcgRGF0ZShlLnRpbWVzdGFtcCksdC5jdGltZT1uZXcgRGF0ZShlLnRpbWVzdGFtcCksdC5ibGtzaXplPTQwOTYsdC5ibG9ja3M9TWF0aC5jZWlsKHQuc2l6ZS90LmJsa3NpemUpLHR9LHNldGF0dHI6ZnVuY3Rpb24oZSx0KXt2b2lkIDAhPT10Lm1vZGUmJihlLm1vZGU9dC5tb2RlKSx2b2lkIDAhPT10LnRpbWVzdGFtcCYmKGUudGltZXN0YW1wPXQudGltZXN0YW1wKSx2b2lkIDAhPT10LnNpemUmJndlLnJlc2l6ZUZpbGVTdG9yYWdlKGUsdC5zaXplKX0sbG9va3VwOmZ1bmN0aW9uKGUsdCl7dGhyb3cgVGUuZ2VuZXJpY0Vycm9yc1ttZS5FTk9FTlRdfSxta25vZDpmdW5jdGlvbihlLHQscixuKXtyZXR1cm4gd2UuY3JlYXRlTm9kZShlLHQscixuKX0scmVuYW1lOmZ1bmN0aW9uKGUsdCxyKXtpZihUZS5pc0RpcihlLm1vZGUpKXt2YXIgbjt0cnl7bj1UZS5sb29rdXBOb2RlKHQscil9Y2F0Y2goZSl7fWlmKG4pZm9yKHZhciBvIGluIG4uY29udGVudHMpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRU5PVEVNUFRZKX1kZWxldGUgZS5wYXJlbnQuY29udGVudHNbZS5uYW1lXSxlLm5hbWU9cix0LmNvbnRlbnRzW3JdPWUsZS5wYXJlbnQ9dH0sdW5saW5rOmZ1bmN0aW9uKGUsdCl7ZGVsZXRlIGUuY29udGVudHNbdF19LHJtZGlyOmZ1bmN0aW9uKGUsdCl7dmFyIHI9VGUubG9va3VwTm9kZShlLHQpO2Zvcih2YXIgbiBpbiByLmNvbnRlbnRzKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVOT1RFTVBUWSk7ZGVsZXRlIGUuY29udGVudHNbdF19LHJlYWRkaXI6ZnVuY3Rpb24oZSl7dmFyIHQ9WyIuIiwiLi4iXTtmb3IodmFyIHIgaW4gZS5jb250ZW50cyllLmNvbnRlbnRzLmhhc093blByb3BlcnR5KHIpJiZ0LnB1c2gocik7cmV0dXJuIHR9LHN5bWxpbms6ZnVuY3Rpb24oZSx0LHIpe3ZhciBuPXdlLmNyZWF0ZU5vZGUoZSx0LDQxNDcxLDApO3JldHVybiBuLmxpbms9cixufSxyZWFkbGluazpmdW5jdGlvbihlKXtpZighVGUuaXNMaW5rKGUubW9kZSkpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRUlOVkFMKTtyZXR1cm4gZS5saW5rfX0sc3RyZWFtX29wczp7cmVhZDpmdW5jdGlvbihlLHQscixuLG8pe3ZhciBpPWUubm9kZS5jb250ZW50cztpZihvPj1lLm5vZGUudXNlZEJ5dGVzKXJldHVybiAwO3ZhciBhPU1hdGgubWluKGUubm9kZS51c2VkQnl0ZXMtbyxuKTtpZih5KGE+PTApLGE+OCYmaS5zdWJhcnJheSl0LnNldChpLnN1YmFycmF5KG8sbythKSxyKTtlbHNlIGZvcih2YXIgcz0wO3M8YTtzKyspdFtyK3NdPWlbbytzXTtyZXR1cm4gYX0sd3JpdGU6ZnVuY3Rpb24oZSx0LHIsbixvLGkpe2lmKCFuKXJldHVybiAwO3ZhciBhPWUubm9kZTtpZihhLnRpbWVzdGFtcD1EYXRlLm5vdygpLHQuc3ViYXJyYXkmJighYS5jb250ZW50c3x8YS5jb250ZW50cy5zdWJhcnJheSkpe2lmKGkpcmV0dXJuIGEuY29udGVudHM9dC5zdWJhcnJheShyLHIrbiksYS51c2VkQnl0ZXM9bixuO2lmKDA9PT1hLnVzZWRCeXRlcyYmMD09PW8pcmV0dXJuIGEuY29udGVudHM9bmV3IFVpbnQ4QXJyYXkodC5zdWJhcnJheShyLHIrbikpLGEudXNlZEJ5dGVzPW4sbjtpZihvK248PWEudXNlZEJ5dGVzKXJldHVybiBhLmNvbnRlbnRzLnNldCh0LnN1YmFycmF5KHIscituKSxvKSxufWlmKHdlLmV4cGFuZEZpbGVTdG9yYWdlKGEsbytuKSxhLmNvbnRlbnRzLnN1YmFycmF5JiZ0LnN1YmFycmF5KWEuY29udGVudHMuc2V0KHQuc3ViYXJyYXkocixyK24pLG8pO2Vsc2UgZm9yKHZhciBzPTA7czxuO3MrKylhLmNvbnRlbnRzW28rc109dFtyK3NdO3JldHVybiBhLnVzZWRCeXRlcz1NYXRoLm1heChhLnVzZWRCeXRlcyxvK24pLG59LGxsc2VlazpmdW5jdGlvbihlLHQscil7dmFyIG49dDtpZigxPT09cj9uKz1lLnBvc2l0aW9uOjI9PT1yJiZUZS5pc0ZpbGUoZS5ub2RlLm1vZGUpJiYobis9ZS5ub2RlLnVzZWRCeXRlcyksbjwwKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVJTlZBTCk7cmV0dXJuIG59LGFsbG9jYXRlOmZ1bmN0aW9uKGUsdCxyKXt3ZS5leHBhbmRGaWxlU3RvcmFnZShlLm5vZGUsdCtyKSxlLm5vZGUudXNlZEJ5dGVzPU1hdGgubWF4KGUubm9kZS51c2VkQnl0ZXMsdCtyKX0sbW1hcDpmdW5jdGlvbihlLHQscixuLG8saSxhKXtpZighVGUuaXNGaWxlKGUubm9kZS5tb2RlKSl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FTk9ERVYpO3ZhciBzLHUsYz1lLm5vZGUuY29udGVudHM7aWYoMiZhfHxjLmJ1ZmZlciE9PXQmJmMuYnVmZmVyIT09dC5idWZmZXIpe2lmKChvPjB8fG8rbjxlLm5vZGUudXNlZEJ5dGVzKSYmKGM9Yy5zdWJhcnJheT9jLnN1YmFycmF5KG8sbytuKTpBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChjLG8sbytuKSksdT0hMCwhKHM9SnQobikpKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVOT01FTSk7dC5zZXQoYyxzKX1lbHNlIHU9ITEscz1jLmJ5dGVPZmZzZXQ7cmV0dXJue3B0cjpzLGFsbG9jYXRlZDp1fX0sbXN5bmM6ZnVuY3Rpb24oZSx0LHIsbixvKXtpZighVGUuaXNGaWxlKGUubm9kZS5tb2RlKSl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FTk9ERVYpO2lmKDImbylyZXR1cm4gMDt3ZS5zdHJlYW1fb3BzLndyaXRlKGUsdCwwLG4sciwhMSk7cmV0dXJuIDB9fX0sX2U9e2Riczp7fSxpbmRleGVkREI6ZnVuY3Rpb24oKXtpZigidW5kZWZpbmVkIiE9dHlwZW9mIGluZGV4ZWREQilyZXR1cm4gaW5kZXhlZERCO3ZhciBlPW51bGw7cmV0dXJuIm9iamVjdCI9PXR5cGVvZiB3aW5kb3cmJihlPXdpbmRvdy5pbmRleGVkREJ8fHdpbmRvdy5tb3pJbmRleGVkREJ8fHdpbmRvdy53ZWJraXRJbmRleGVkREJ8fHdpbmRvdy5tc0luZGV4ZWREQikseShlLCJJREJGUyB1c2VkLCBidXQgaW5kZXhlZERCIG5vdCBzdXBwb3J0ZWQiKSxlfSxEQl9WRVJTSU9OOjIxLERCX1NUT1JFX05BTUU6IkZJTEVfREFUQSIsbW91bnQ6ZnVuY3Rpb24oZSl7cmV0dXJuIHdlLm1vdW50LmFwcGx5KG51bGwsYXJndW1lbnRzKX0sc3luY2ZzOmZ1bmN0aW9uKGUsdCxyKXtfZS5nZXRMb2NhbFNldChlLChmdW5jdGlvbihuLG8pe2lmKG4pcmV0dXJuIHIobik7X2UuZ2V0UmVtb3RlU2V0KGUsKGZ1bmN0aW9uKGUsbil7aWYoZSlyZXR1cm4gcihlKTt2YXIgaT10P246byxhPXQ/bzpuO19lLnJlY29uY2lsZShpLGEscil9KSl9KSl9LGdldERCOmZ1bmN0aW9uKGUsdCl7dmFyIHIsbj1fZS5kYnNbZV07aWYobilyZXR1cm4gdChudWxsLG4pO3RyeXtyPV9lLmluZGV4ZWREQigpLm9wZW4oZSxfZS5EQl9WRVJTSU9OKX1jYXRjaChlKXtyZXR1cm4gdChlKX1pZighcilyZXR1cm4gdCgiVW5hYmxlIHRvIGNvbm5lY3QgdG8gSW5kZXhlZERCIik7ci5vbnVwZ3JhZGVuZWVkZWQ9ZnVuY3Rpb24oZSl7dmFyIHQscj1lLnRhcmdldC5yZXN1bHQsbj1lLnRhcmdldC50cmFuc2FjdGlvbjsodD1yLm9iamVjdFN0b3JlTmFtZXMuY29udGFpbnMoX2UuREJfU1RPUkVfTkFNRSk/bi5vYmplY3RTdG9yZShfZS5EQl9TVE9SRV9OQU1FKTpyLmNyZWF0ZU9iamVjdFN0b3JlKF9lLkRCX1NUT1JFX05BTUUpKS5pbmRleE5hbWVzLmNvbnRhaW5zKCJ0aW1lc3RhbXAiKXx8dC5jcmVhdGVJbmRleCgidGltZXN0YW1wIiwidGltZXN0YW1wIix7dW5pcXVlOiExfSl9LHIub25zdWNjZXNzPWZ1bmN0aW9uKCl7bj1yLnJlc3VsdCxfZS5kYnNbZV09bix0KG51bGwsbil9LHIub25lcnJvcj1mdW5jdGlvbihlKXt0KHRoaXMuZXJyb3IpLGUucHJldmVudERlZmF1bHQoKX19LGdldExvY2FsU2V0OmZ1bmN0aW9uKGUsdCl7dmFyIHI9e307ZnVuY3Rpb24gbihlKXtyZXR1cm4iLiIhPT1lJiYiLi4iIT09ZX1mdW5jdGlvbiBvKGUpe3JldHVybiBmdW5jdGlvbih0KXtyZXR1cm4gZ2Uuam9pbjIoZSx0KX19Zm9yKHZhciBpPVRlLnJlYWRkaXIoZS5tb3VudHBvaW50KS5maWx0ZXIobikubWFwKG8oZS5tb3VudHBvaW50KSk7aS5sZW5ndGg7KXt2YXIgYSxzPWkucG9wKCk7dHJ5e2E9VGUuc3RhdChzKX1jYXRjaChlKXtyZXR1cm4gdChlKX1UZS5pc0RpcihhLm1vZGUpJiZpLnB1c2guYXBwbHkoaSxUZS5yZWFkZGlyKHMpLmZpbHRlcihuKS5tYXAobyhzKSkpLHJbc109e3RpbWVzdGFtcDphLm10aW1lfX1yZXR1cm4gdChudWxsLHt0eXBlOiJsb2NhbCIsZW50cmllczpyfSl9LGdldFJlbW90ZVNldDpmdW5jdGlvbihlLHQpe3ZhciByPXt9O19lLmdldERCKGUubW91bnRwb2ludCwoZnVuY3Rpb24oZSxuKXtpZihlKXJldHVybiB0KGUpO3RyeXt2YXIgbz1uLnRyYW5zYWN0aW9uKFtfZS5EQl9TVE9SRV9OQU1FXSwicmVhZG9ubHkiKTtvLm9uZXJyb3I9ZnVuY3Rpb24oZSl7dCh0aGlzLmVycm9yKSxlLnByZXZlbnREZWZhdWx0KCl9LG8ub2JqZWN0U3RvcmUoX2UuREJfU1RPUkVfTkFNRSkuaW5kZXgoInRpbWVzdGFtcCIpLm9wZW5LZXlDdXJzb3IoKS5vbnN1Y2Nlc3M9ZnVuY3Rpb24oZSl7dmFyIG89ZS50YXJnZXQucmVzdWx0O2lmKCFvKXJldHVybiB0KG51bGwse3R5cGU6InJlbW90ZSIsZGI6bixlbnRyaWVzOnJ9KTtyW28ucHJpbWFyeUtleV09e3RpbWVzdGFtcDpvLmtleX0sby5jb250aW51ZSgpfX1jYXRjaChlKXtyZXR1cm4gdChlKX19KSl9LGxvYWRMb2NhbEVudHJ5OmZ1bmN0aW9uKGUsdCl7dmFyIHIsbjt0cnl7bj1UZS5sb29rdXBQYXRoKGUpLm5vZGUscj1UZS5zdGF0KGUpfWNhdGNoKGUpe3JldHVybiB0KGUpfXJldHVybiBUZS5pc0RpcihyLm1vZGUpP3QobnVsbCx7dGltZXN0YW1wOnIubXRpbWUsbW9kZTpyLm1vZGV9KTpUZS5pc0ZpbGUoci5tb2RlKT8obi5jb250ZW50cz13ZS5nZXRGaWxlRGF0YUFzVHlwZWRBcnJheShuKSx0KG51bGwse3RpbWVzdGFtcDpyLm10aW1lLG1vZGU6ci5tb2RlLGNvbnRlbnRzOm4uY29udGVudHN9KSk6dChuZXcgRXJyb3IoIm5vZGUgdHlwZSBub3Qgc3VwcG9ydGVkIikpfSxzdG9yZUxvY2FsRW50cnk6ZnVuY3Rpb24oZSx0LHIpe3RyeXtpZihUZS5pc0Rpcih0Lm1vZGUpKVRlLm1rZGlyKGUsdC5tb2RlKTtlbHNle2lmKCFUZS5pc0ZpbGUodC5tb2RlKSlyZXR1cm4gcihuZXcgRXJyb3IoIm5vZGUgdHlwZSBub3Qgc3VwcG9ydGVkIikpO1RlLndyaXRlRmlsZShlLHQuY29udGVudHMse2Nhbk93bjohMH0pfVRlLmNobW9kKGUsdC5tb2RlKSxUZS51dGltZShlLHQudGltZXN0YW1wLHQudGltZXN0YW1wKX1jYXRjaChlKXtyZXR1cm4gcihlKX1yKG51bGwpfSxyZW1vdmVMb2NhbEVudHJ5OmZ1bmN0aW9uKGUsdCl7dHJ5e1RlLmxvb2t1cFBhdGgoZSk7dmFyIHI9VGUuc3RhdChlKTtUZS5pc0RpcihyLm1vZGUpP1RlLnJtZGlyKGUpOlRlLmlzRmlsZShyLm1vZGUpJiZUZS51bmxpbmsoZSl9Y2F0Y2goZSl7cmV0dXJuIHQoZSl9dChudWxsKX0sbG9hZFJlbW90ZUVudHJ5OmZ1bmN0aW9uKGUsdCxyKXt2YXIgbj1lLmdldCh0KTtuLm9uc3VjY2Vzcz1mdW5jdGlvbihlKXtyKG51bGwsZS50YXJnZXQucmVzdWx0KX0sbi5vbmVycm9yPWZ1bmN0aW9uKGUpe3IodGhpcy5lcnJvciksZS5wcmV2ZW50RGVmYXVsdCgpfX0sc3RvcmVSZW1vdGVFbnRyeTpmdW5jdGlvbihlLHQscixuKXt2YXIgbz1lLnB1dChyLHQpO28ub25zdWNjZXNzPWZ1bmN0aW9uKCl7bihudWxsKX0sby5vbmVycm9yPWZ1bmN0aW9uKGUpe24odGhpcy5lcnJvciksZS5wcmV2ZW50RGVmYXVsdCgpfX0scmVtb3ZlUmVtb3RlRW50cnk6ZnVuY3Rpb24oZSx0LHIpe3ZhciBuPWUuZGVsZXRlKHQpO24ub25zdWNjZXNzPWZ1bmN0aW9uKCl7cihudWxsKX0sbi5vbmVycm9yPWZ1bmN0aW9uKGUpe3IodGhpcy5lcnJvciksZS5wcmV2ZW50RGVmYXVsdCgpfX0scmVjb25jaWxlOmZ1bmN0aW9uKGUsdCxyKXt2YXIgbj0wLG89W107T2JqZWN0LmtleXMoZS5lbnRyaWVzKS5mb3JFYWNoKChmdW5jdGlvbihyKXt2YXIgaT1lLmVudHJpZXNbcl0sYT10LmVudHJpZXNbcl07KCFhfHxpLnRpbWVzdGFtcD5hLnRpbWVzdGFtcCkmJihvLnB1c2gociksbisrKX0pKTt2YXIgaT1bXTtpZihPYmplY3Qua2V5cyh0LmVudHJpZXMpLmZvckVhY2goKGZ1bmN0aW9uKHIpe3QuZW50cmllc1tyXTtlLmVudHJpZXNbcl18fChpLnB1c2gociksbisrKX0pKSwhbilyZXR1cm4gcihudWxsKTt2YXIgYT0wLHM9KCJyZW1vdGUiPT09ZS50eXBlP2UuZGI6dC5kYikudHJhbnNhY3Rpb24oW19lLkRCX1NUT1JFX05BTUVdLCJyZWFkd3JpdGUiKSx1PXMub2JqZWN0U3RvcmUoX2UuREJfU1RPUkVfTkFNRSk7ZnVuY3Rpb24gYyhlKXtyZXR1cm4gZT9jLmVycm9yZWQ/dm9pZCAwOihjLmVycm9yZWQ9ITAscihlKSk6KythPj1uP3IobnVsbCk6dm9pZCAwfXMub25lcnJvcj1mdW5jdGlvbihlKXtjKHRoaXMuZXJyb3IpLGUucHJldmVudERlZmF1bHQoKX0sby5zb3J0KCkuZm9yRWFjaCgoZnVuY3Rpb24oZSl7ImxvY2FsIj09PXQudHlwZT9fZS5sb2FkUmVtb3RlRW50cnkodSxlLChmdW5jdGlvbih0LHIpe2lmKHQpcmV0dXJuIGModCk7X2Uuc3RvcmVMb2NhbEVudHJ5KGUscixjKX0pKTpfZS5sb2FkTG9jYWxFbnRyeShlLChmdW5jdGlvbih0LHIpe2lmKHQpcmV0dXJuIGModCk7X2Uuc3RvcmVSZW1vdGVFbnRyeSh1LGUscixjKX0pKX0pKSxpLnNvcnQoKS5yZXZlcnNlKCkuZm9yRWFjaCgoZnVuY3Rpb24oZSl7ImxvY2FsIj09PXQudHlwZT9fZS5yZW1vdmVMb2NhbEVudHJ5KGUsYyk6X2UucmVtb3ZlUmVtb3RlRW50cnkodSxlLGMpfSkpfX0sYmU9e2lzV2luZG93czohMSxzdGF0aWNJbml0OmZ1bmN0aW9uKCl7YmUuaXNXaW5kb3dzPSEhcHJvY2Vzcy5wbGF0Zm9ybS5tYXRjaCgvXndpbi8pO3ZhciBlPXByb2Nlc3MuYmluZGluZygiY29uc3RhbnRzIik7ZS5mcyYmKGU9ZS5mcyksYmUuZmxhZ3NGb3JOb2RlTWFwPXsxMDI0OmUuT19BUFBFTkQsNjQ6ZS5PX0NSRUFULDEyODplLk9fRVhDTCwwOmUuT19SRE9OTFksMjplLk9fUkRXUiw0MDk2OmUuT19TWU5DLDUxMjplLk9fVFJVTkMsMTplLk9fV1JPTkxZfX0sYnVmZmVyRnJvbTpmdW5jdGlvbihlKXtyZXR1cm4gQnVmZmVyLmFsbG9jP0J1ZmZlci5mcm9tKGUpOm5ldyBCdWZmZXIoZSl9LG1vdW50OmZ1bmN0aW9uKGUpe3JldHVybiB5KGwpLGJlLmNyZWF0ZU5vZGUobnVsbCwiLyIsYmUuZ2V0TW9kZShlLm9wdHMucm9vdCksMCl9LGNyZWF0ZU5vZGU6ZnVuY3Rpb24oZSx0LHIsbil7aWYoIVRlLmlzRGlyKHIpJiYhVGUuaXNGaWxlKHIpJiYhVGUuaXNMaW5rKHIpKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVJTlZBTCk7dmFyIG89VGUuY3JlYXRlTm9kZShlLHQscik7cmV0dXJuIG8ubm9kZV9vcHM9YmUubm9kZV9vcHMsby5zdHJlYW1fb3BzPWJlLnN0cmVhbV9vcHMsb30sZ2V0TW9kZTpmdW5jdGlvbihlKXt2YXIgdDt0cnl7dD1mcy5sc3RhdFN5bmMoZSksYmUuaXNXaW5kb3dzJiYodC5tb2RlPXQubW9kZXwoMjkyJnQubW9kZSk+PjIpfWNhdGNoKGUpe2lmKCFlLmNvZGUpdGhyb3cgZTt0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZVtlLmNvZGVdKX1yZXR1cm4gdC5tb2RlfSxyZWFsUGF0aDpmdW5jdGlvbihlKXtmb3IodmFyIHQ9W107ZS5wYXJlbnQhPT1lOyl0LnB1c2goZS5uYW1lKSxlPWUucGFyZW50O3JldHVybiB0LnB1c2goZS5tb3VudC5vcHRzLnJvb3QpLHQucmV2ZXJzZSgpLGdlLmpvaW4uYXBwbHkobnVsbCx0KX0sZmxhZ3NGb3JOb2RlOmZ1bmN0aW9uKGUpe2UmPS0yMDk3MTUzLGUmPS0yMDQ5LGUmPS0zMjc2OSxlJj0tNTI0Mjg5O3ZhciB0PTA7Zm9yKHZhciByIGluIGJlLmZsYWdzRm9yTm9kZU1hcCllJnImJih0fD1iZS5mbGFnc0Zvck5vZGVNYXBbcl0sZV49cik7aWYoZSl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FSU5WQUwpO3JldHVybiB0fSxub2RlX29wczp7Z2V0YXR0cjpmdW5jdGlvbihlKXt2YXIgdCxyPWJlLnJlYWxQYXRoKGUpO3RyeXt0PWZzLmxzdGF0U3luYyhyKX1jYXRjaChlKXtpZighZS5jb2RlKXRocm93IGU7dGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWVbZS5jb2RlXSl9cmV0dXJuIGJlLmlzV2luZG93cyYmIXQuYmxrc2l6ZSYmKHQuYmxrc2l6ZT00MDk2KSxiZS5pc1dpbmRvd3MmJiF0LmJsb2NrcyYmKHQuYmxvY2tzPSh0LnNpemUrdC5ibGtzaXplLTEpL3QuYmxrc2l6ZXwwKSx7ZGV2OnQuZGV2LGlubzp0Lmlubyxtb2RlOnQubW9kZSxubGluazp0Lm5saW5rLHVpZDp0LnVpZCxnaWQ6dC5naWQscmRldjp0LnJkZXYsc2l6ZTp0LnNpemUsYXRpbWU6dC5hdGltZSxtdGltZTp0Lm10aW1lLGN0aW1lOnQuY3RpbWUsYmxrc2l6ZTp0LmJsa3NpemUsYmxvY2tzOnQuYmxvY2tzfX0sc2V0YXR0cjpmdW5jdGlvbihlLHQpe3ZhciByPWJlLnJlYWxQYXRoKGUpO3RyeXtpZih2b2lkIDAhPT10Lm1vZGUmJihmcy5jaG1vZFN5bmMocix0Lm1vZGUpLGUubW9kZT10Lm1vZGUpLHZvaWQgMCE9PXQudGltZXN0YW1wKXt2YXIgbj1uZXcgRGF0ZSh0LnRpbWVzdGFtcCk7ZnMudXRpbWVzU3luYyhyLG4sbil9dm9pZCAwIT09dC5zaXplJiZmcy50cnVuY2F0ZVN5bmMocix0LnNpemUpfWNhdGNoKGUpe2lmKCFlLmNvZGUpdGhyb3cgZTt0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZVtlLmNvZGVdKX19LGxvb2t1cDpmdW5jdGlvbihlLHQpe3ZhciByPWdlLmpvaW4yKGJlLnJlYWxQYXRoKGUpLHQpLG49YmUuZ2V0TW9kZShyKTtyZXR1cm4gYmUuY3JlYXRlTm9kZShlLHQsbil9LG1rbm9kOmZ1bmN0aW9uKGUsdCxyLG4pe3ZhciBvPWJlLmNyZWF0ZU5vZGUoZSx0LHIsbiksaT1iZS5yZWFsUGF0aChvKTt0cnl7VGUuaXNEaXIoby5tb2RlKT9mcy5ta2RpclN5bmMoaSxvLm1vZGUpOmZzLndyaXRlRmlsZVN5bmMoaSwiIix7bW9kZTpvLm1vZGV9KX1jYXRjaChlKXtpZighZS5jb2RlKXRocm93IGU7dGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWVbZS5jb2RlXSl9cmV0dXJuIG99LHJlbmFtZTpmdW5jdGlvbihlLHQscil7dmFyIG49YmUucmVhbFBhdGgoZSksbz1nZS5qb2luMihiZS5yZWFsUGF0aCh0KSxyKTt0cnl7ZnMucmVuYW1lU3luYyhuLG8pfWNhdGNoKGUpe2lmKCFlLmNvZGUpdGhyb3cgZTt0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZVtlLmNvZGVdKX19LHVubGluazpmdW5jdGlvbihlLHQpe3ZhciByPWdlLmpvaW4yKGJlLnJlYWxQYXRoKGUpLHQpO3RyeXtmcy51bmxpbmtTeW5jKHIpfWNhdGNoKGUpe2lmKCFlLmNvZGUpdGhyb3cgZTt0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZVtlLmNvZGVdKX19LHJtZGlyOmZ1bmN0aW9uKGUsdCl7dmFyIHI9Z2Uuam9pbjIoYmUucmVhbFBhdGgoZSksdCk7dHJ5e2ZzLnJtZGlyU3luYyhyKX1jYXRjaChlKXtpZighZS5jb2RlKXRocm93IGU7dGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWVbZS5jb2RlXSl9fSxyZWFkZGlyOmZ1bmN0aW9uKGUpe3ZhciB0PWJlLnJlYWxQYXRoKGUpO3RyeXtyZXR1cm4gZnMucmVhZGRpclN5bmModCl9Y2F0Y2goZSl7aWYoIWUuY29kZSl0aHJvdyBlO3Rocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lW2UuY29kZV0pfX0sc3ltbGluazpmdW5jdGlvbihlLHQscil7dmFyIG49Z2Uuam9pbjIoYmUucmVhbFBhdGgoZSksdCk7dHJ5e2ZzLnN5bWxpbmtTeW5jKHIsbil9Y2F0Y2goZSl7aWYoIWUuY29kZSl0aHJvdyBlO3Rocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lW2UuY29kZV0pfX0scmVhZGxpbms6ZnVuY3Rpb24oZSl7dmFyIHQ9YmUucmVhbFBhdGgoZSk7dHJ5e3JldHVybiB0PWZzLnJlYWRsaW5rU3luYyh0KSx0PU5PREVKU19QQVRILnJlbGF0aXZlKE5PREVKU19QQVRILnJlc29sdmUoZS5tb3VudC5vcHRzLnJvb3QpLHQpfWNhdGNoKGUpe2lmKCFlLmNvZGUpdGhyb3cgZTt0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZVtlLmNvZGVdKX19fSxzdHJlYW1fb3BzOntvcGVuOmZ1bmN0aW9uKGUpe3ZhciB0PWJlLnJlYWxQYXRoKGUubm9kZSk7dHJ5e1RlLmlzRmlsZShlLm5vZGUubW9kZSkmJihlLm5mZD1mcy5vcGVuU3luYyh0LGJlLmZsYWdzRm9yTm9kZShlLmZsYWdzKSkpfWNhdGNoKGUpe2lmKCFlLmNvZGUpdGhyb3cgZTt0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZVtlLmNvZGVdKX19LGNsb3NlOmZ1bmN0aW9uKGUpe3RyeXtUZS5pc0ZpbGUoZS5ub2RlLm1vZGUpJiZlLm5mZCYmZnMuY2xvc2VTeW5jKGUubmZkKX1jYXRjaChlKXtpZighZS5jb2RlKXRocm93IGU7dGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWVbZS5jb2RlXSl9fSxyZWFkOmZ1bmN0aW9uKGUsdCxyLG4sbyl7aWYoMD09PW4pcmV0dXJuIDA7dHJ5e3JldHVybiBmcy5yZWFkU3luYyhlLm5mZCxiZS5idWZmZXJGcm9tKHQuYnVmZmVyKSxyLG4sbyl9Y2F0Y2goZSl7dGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWVbZS5jb2RlXSl9fSx3cml0ZTpmdW5jdGlvbihlLHQscixuLG8pe3RyeXtyZXR1cm4gZnMud3JpdGVTeW5jKGUubmZkLGJlLmJ1ZmZlckZyb20odC5idWZmZXIpLHIsbixvKX1jYXRjaChlKXt0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZVtlLmNvZGVdKX19LGxsc2VlazpmdW5jdGlvbihlLHQscil7dmFyIG49dDtpZigxPT09ciluKz1lLnBvc2l0aW9uO2Vsc2UgaWYoMj09PXImJlRlLmlzRmlsZShlLm5vZGUubW9kZSkpdHJ5e24rPWZzLmZzdGF0U3luYyhlLm5mZCkuc2l6ZX1jYXRjaChlKXt0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZVtlLmNvZGVdKX1pZihuPDApdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRUlOVkFMKTtyZXR1cm4gbn19fSxBZT17RElSX01PREU6MTY4OTUsRklMRV9NT0RFOjMzMjc5LHJlYWRlcjpudWxsLG1vdW50OmZ1bmN0aW9uKGUpe3koYyksQWUucmVhZGVyfHwoQWUucmVhZGVyPW5ldyBGaWxlUmVhZGVyU3luYyk7dmFyIHQ9QWUuY3JlYXRlTm9kZShudWxsLCIvIixBZS5ESVJfTU9ERSwwKSxyPXt9O2Z1bmN0aW9uIG4oZSl7Zm9yKHZhciBuPWUuc3BsaXQoIi8iKSxvPXQsaT0wO2k8bi5sZW5ndGgtMTtpKyspe3ZhciBhPW4uc2xpY2UoMCxpKzEpLmpvaW4oIi8iKTtyW2FdfHwoclthXT1BZS5jcmVhdGVOb2RlKG8sbltpXSxBZS5ESVJfTU9ERSwwKSksbz1yW2FdfXJldHVybiBvfWZ1bmN0aW9uIG8oZSl7dmFyIHQ9ZS5zcGxpdCgiLyIpO3JldHVybiB0W3QubGVuZ3RoLTFdfXJldHVybiBBcnJheS5wcm90b3R5cGUuZm9yRWFjaC5jYWxsKGUub3B0cy5maWxlc3x8W10sKGZ1bmN0aW9uKGUpe0FlLmNyZWF0ZU5vZGUobihlLm5hbWUpLG8oZS5uYW1lKSxBZS5GSUxFX01PREUsMCxlLGUubGFzdE1vZGlmaWVkRGF0ZSl9KSksKGUub3B0cy5ibG9ic3x8W10pLmZvckVhY2goKGZ1bmN0aW9uKGUpe0FlLmNyZWF0ZU5vZGUobihlLm5hbWUpLG8oZS5uYW1lKSxBZS5GSUxFX01PREUsMCxlLmRhdGEpfSkpLChlLm9wdHMucGFja2FnZXN8fFtdKS5mb3JFYWNoKChmdW5jdGlvbihlKXtlLm1ldGFkYXRhLmZpbGVzLmZvckVhY2goKGZ1bmN0aW9uKHQpe3ZhciByPXQuZmlsZW5hbWUuc3Vic3RyKDEpO0FlLmNyZWF0ZU5vZGUobihyKSxvKHIpLEFlLkZJTEVfTU9ERSwwLGUuYmxvYi5zbGljZSh0LnN0YXJ0LHQuZW5kKSl9KSl9KSksdH0sY3JlYXRlTm9kZTpmdW5jdGlvbihlLHQscixuLG8saSl7dmFyIGE9VGUuY3JlYXRlTm9kZShlLHQscik7cmV0dXJuIGEubW9kZT1yLGEubm9kZV9vcHM9QWUubm9kZV9vcHMsYS5zdHJlYW1fb3BzPUFlLnN0cmVhbV9vcHMsYS50aW1lc3RhbXA9KGl8fG5ldyBEYXRlKS5nZXRUaW1lKCkseShBZS5GSUxFX01PREUhPT1BZS5ESVJfTU9ERSkscj09PUFlLkZJTEVfTU9ERT8oYS5zaXplPW8uc2l6ZSxhLmNvbnRlbnRzPW8pOihhLnNpemU9NDA5NixhLmNvbnRlbnRzPXt9KSxlJiYoZS5jb250ZW50c1t0XT1hKSxhfSxub2RlX29wczp7Z2V0YXR0cjpmdW5jdGlvbihlKXtyZXR1cm57ZGV2OjEsaW5vOnZvaWQgMCxtb2RlOmUubW9kZSxubGluazoxLHVpZDowLGdpZDowLHJkZXY6dm9pZCAwLHNpemU6ZS5zaXplLGF0aW1lOm5ldyBEYXRlKGUudGltZXN0YW1wKSxtdGltZTpuZXcgRGF0ZShlLnRpbWVzdGFtcCksY3RpbWU6bmV3IERhdGUoZS50aW1lc3RhbXApLGJsa3NpemU6NDA5NixibG9ja3M6TWF0aC5jZWlsKGUuc2l6ZS80MDk2KX19LHNldGF0dHI6ZnVuY3Rpb24oZSx0KXt2b2lkIDAhPT10Lm1vZGUmJihlLm1vZGU9dC5tb2RlKSx2b2lkIDAhPT10LnRpbWVzdGFtcCYmKGUudGltZXN0YW1wPXQudGltZXN0YW1wKX0sbG9va3VwOmZ1bmN0aW9uKGUsdCl7dGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRU5PRU5UKX0sbWtub2Q6ZnVuY3Rpb24oZSx0LHIsbil7dGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRVBFUk0pfSxyZW5hbWU6ZnVuY3Rpb24oZSx0LHIpe3Rocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVQRVJNKX0sdW5saW5rOmZ1bmN0aW9uKGUsdCl7dGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRVBFUk0pfSxybWRpcjpmdW5jdGlvbihlLHQpe3Rocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVQRVJNKX0scmVhZGRpcjpmdW5jdGlvbihlKXt2YXIgdD1bIi4iLCIuLiJdO2Zvcih2YXIgciBpbiBlLmNvbnRlbnRzKWUuY29udGVudHMuaGFzT3duUHJvcGVydHkocikmJnQucHVzaChyKTtyZXR1cm4gdH0sc3ltbGluazpmdW5jdGlvbihlLHQscil7dGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRVBFUk0pfSxyZWFkbGluazpmdW5jdGlvbihlKXt0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FUEVSTSl9fSxzdHJlYW1fb3BzOntyZWFkOmZ1bmN0aW9uKGUsdCxyLG4sbyl7aWYobz49ZS5ub2RlLnNpemUpcmV0dXJuIDA7dmFyIGk9ZS5ub2RlLmNvbnRlbnRzLnNsaWNlKG8sbytuKSxhPUFlLnJlYWRlci5yZWFkQXNBcnJheUJ1ZmZlcihpKTtyZXR1cm4gdC5zZXQobmV3IFVpbnQ4QXJyYXkoYSksciksaS5zaXplfSx3cml0ZTpmdW5jdGlvbihlLHQscixuLG8pe3Rocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVJTyl9LGxsc2VlazpmdW5jdGlvbihlLHQscil7dmFyIG49dDtpZigxPT09cj9uKz1lLnBvc2l0aW9uOjI9PT1yJiZUZS5pc0ZpbGUoZS5ub2RlLm1vZGUpJiYobis9ZS5ub2RlLnNpemUpLG48MCl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FSU5WQUwpO3JldHVybiBufX19O0wrPTE2LEwrPTE2O3ZhciBUZT17cm9vdDpudWxsLG1vdW50czpbXSxkZXZpY2VzOnt9LHN0cmVhbXM6W10sbmV4dElub2RlOjEsbmFtZVRhYmxlOm51bGwsY3VycmVudFBhdGg6Ii8iLGluaXRpYWxpemVkOiExLGlnbm9yZVBlcm1pc3Npb25zOiEwLHRyYWNraW5nRGVsZWdhdGU6e30sdHJhY2tpbmc6e29wZW5GbGFnczp7UkVBRDoxLFdSSVRFOjJ9fSxFcnJub0Vycm9yOm51bGwsZ2VuZXJpY0Vycm9yczp7fSxmaWxlc3lzdGVtczpudWxsLHN5bmNGU1JlcXVlc3RzOjAsaGFuZGxlRlNFcnJvcjpmdW5jdGlvbihlKXtpZighKGUgaW5zdGFuY2VvZiBUZS5FcnJub0Vycm9yKSl0aHJvdyBlKyIgOiAiK1AoKTtyZXR1cm4geWUoZS5lcnJubyl9LGxvb2t1cFBhdGg6ZnVuY3Rpb24oZSx0KXtpZih0PXR8fHt9LCEoZT1nZS5yZXNvbHZlKFRlLmN3ZCgpLGUpKSlyZXR1cm57cGF0aDoiIixub2RlOm51bGx9O3ZhciByPXtmb2xsb3dfbW91bnQ6ITAscmVjdXJzZV9jb3VudDowfTtmb3IodmFyIG4gaW4gcil2b2lkIDA9PT10W25dJiYodFtuXT1yW25dKTtpZih0LnJlY3Vyc2VfY291bnQ+OCl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FTE9PUCk7Zm9yKHZhciBvPWdlLm5vcm1hbGl6ZUFycmF5KGUuc3BsaXQoIi8iKS5maWx0ZXIoKGZ1bmN0aW9uKGUpe3JldHVybiEhZX0pKSwhMSksaT1UZS5yb290LGE9Ii8iLHM9MDtzPG8ubGVuZ3RoO3MrKyl7dmFyIHU9cz09PW8ubGVuZ3RoLTE7aWYodSYmdC5wYXJlbnQpYnJlYWs7aWYoaT1UZS5sb29rdXBOb2RlKGksb1tzXSksYT1nZS5qb2luMihhLG9bc10pLFRlLmlzTW91bnRwb2ludChpKSYmKCF1fHx1JiZ0LmZvbGxvd19tb3VudCkmJihpPWkubW91bnRlZC5yb290KSwhdXx8dC5mb2xsb3cpZm9yKHZhciBjPTA7VGUuaXNMaW5rKGkubW9kZSk7KXt2YXIgbD1UZS5yZWFkbGluayhhKTtpZihhPWdlLnJlc29sdmUoZ2UuZGlybmFtZShhKSxsKSxpPVRlLmxvb2t1cFBhdGgoYSx7cmVjdXJzZV9jb3VudDp0LnJlY3Vyc2VfY291bnR9KS5ub2RlLGMrKz40MCl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FTE9PUCl9fXJldHVybntwYXRoOmEsbm9kZTppfX0sZ2V0UGF0aDpmdW5jdGlvbihlKXtmb3IodmFyIHQ7Oyl7aWYoVGUuaXNSb290KGUpKXt2YXIgcj1lLm1vdW50Lm1vdW50cG9pbnQ7cmV0dXJuIHQ/Ii8iIT09cltyLmxlbmd0aC0xXT9yKyIvIit0OnIrdDpyfXQ9dD9lLm5hbWUrIi8iK3Q6ZS5uYW1lLGU9ZS5wYXJlbnR9fSxoYXNoTmFtZTpmdW5jdGlvbihlLHQpe2Zvcih2YXIgcj0wLG49MDtuPHQubGVuZ3RoO24rKylyPShyPDw1KS1yK3QuY2hhckNvZGVBdChuKXwwO3JldHVybihlK3I+Pj4wKSVUZS5uYW1lVGFibGUubGVuZ3RofSxoYXNoQWRkTm9kZTpmdW5jdGlvbihlKXt2YXIgdD1UZS5oYXNoTmFtZShlLnBhcmVudC5pZCxlLm5hbWUpO2UubmFtZV9uZXh0PVRlLm5hbWVUYWJsZVt0XSxUZS5uYW1lVGFibGVbdF09ZX0saGFzaFJlbW92ZU5vZGU6ZnVuY3Rpb24oZSl7dmFyIHQ9VGUuaGFzaE5hbWUoZS5wYXJlbnQuaWQsZS5uYW1lKTtpZihUZS5uYW1lVGFibGVbdF09PT1lKVRlLm5hbWVUYWJsZVt0XT1lLm5hbWVfbmV4dDtlbHNlIGZvcih2YXIgcj1UZS5uYW1lVGFibGVbdF07cjspe2lmKHIubmFtZV9uZXh0PT09ZSl7ci5uYW1lX25leHQ9ZS5uYW1lX25leHQ7YnJlYWt9cj1yLm5hbWVfbmV4dH19LGxvb2t1cE5vZGU6ZnVuY3Rpb24oZSx0KXt2YXIgcj1UZS5tYXlMb29rdXAoZSk7aWYocil0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihyLGUpO2Zvcih2YXIgbj1UZS5oYXNoTmFtZShlLmlkLHQpLG89VGUubmFtZVRhYmxlW25dO287bz1vLm5hbWVfbmV4dCl7dmFyIGk9by5uYW1lO2lmKG8ucGFyZW50LmlkPT09ZS5pZCYmaT09PXQpcmV0dXJuIG99cmV0dXJuIFRlLmxvb2t1cChlLHQpfSxjcmVhdGVOb2RlOmZ1bmN0aW9uKGUsdCxyLG4pe2lmKCFUZS5GU05vZGUpe1RlLkZTTm9kZT1mdW5jdGlvbihlLHQscixuKXtlfHwoZT10aGlzKSx0aGlzLnBhcmVudD1lLHRoaXMubW91bnQ9ZS5tb3VudCx0aGlzLm1vdW50ZWQ9bnVsbCx0aGlzLmlkPVRlLm5leHRJbm9kZSsrLHRoaXMubmFtZT10LHRoaXMubW9kZT1yLHRoaXMubm9kZV9vcHM9e30sdGhpcy5zdHJlYW1fb3BzPXt9LHRoaXMucmRldj1ufSxUZS5GU05vZGUucHJvdG90eXBlPXt9O09iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKFRlLkZTTm9kZS5wcm90b3R5cGUse3JlYWQ6e2dldDpmdW5jdGlvbigpe3JldHVybiAzNjU9PSgzNjUmdGhpcy5tb2RlKX0sc2V0OmZ1bmN0aW9uKGUpe2U/dGhpcy5tb2RlfD0zNjU6dGhpcy5tb2RlJj0tMzY2fX0sd3JpdGU6e2dldDpmdW5jdGlvbigpe3JldHVybiAxNDY9PSgxNDYmdGhpcy5tb2RlKX0sc2V0OmZ1bmN0aW9uKGUpe2U/dGhpcy5tb2RlfD0xNDY6dGhpcy5tb2RlJj0tMTQ3fX0saXNGb2xkZXI6e2dldDpmdW5jdGlvbigpe3JldHVybiBUZS5pc0Rpcih0aGlzLm1vZGUpfX0saXNEZXZpY2U6e2dldDpmdW5jdGlvbigpe3JldHVybiBUZS5pc0NocmRldih0aGlzLm1vZGUpfX19KX12YXIgbz1uZXcgVGUuRlNOb2RlKGUsdCxyLG4pO3JldHVybiBUZS5oYXNoQWRkTm9kZShvKSxvfSxkZXN0cm95Tm9kZTpmdW5jdGlvbihlKXtUZS5oYXNoUmVtb3ZlTm9kZShlKX0saXNSb290OmZ1bmN0aW9uKGUpe3JldHVybiBlPT09ZS5wYXJlbnR9LGlzTW91bnRwb2ludDpmdW5jdGlvbihlKXtyZXR1cm4hIWUubW91bnRlZH0saXNGaWxlOmZ1bmN0aW9uKGUpe3JldHVybiAzMjc2OD09KDYxNDQwJmUpfSxpc0RpcjpmdW5jdGlvbihlKXtyZXR1cm4gMTYzODQ9PSg2MTQ0MCZlKX0saXNMaW5rOmZ1bmN0aW9uKGUpe3JldHVybiA0MDk2MD09KDYxNDQwJmUpfSxpc0NocmRldjpmdW5jdGlvbihlKXtyZXR1cm4gODE5Mj09KDYxNDQwJmUpfSxpc0Jsa2RldjpmdW5jdGlvbihlKXtyZXR1cm4gMjQ1NzY9PSg2MTQ0MCZlKX0saXNGSUZPOmZ1bmN0aW9uKGUpe3JldHVybiA0MDk2PT0oNjE0NDAmZSl9LGlzU29ja2V0OmZ1bmN0aW9uKGUpe3JldHVybiA0OTE1Mj09KDQ5MTUyJmUpfSxmbGFnTW9kZXM6e3I6MCxyczoxMDUyNjcyLCJyKyI6Mix3OjU3Nyx3eDo3MDUseHc6NzA1LCJ3KyI6NTc4LCJ3eCsiOjcwNiwieHcrIjo3MDYsYToxMDg5LGF4OjEyMTcseGE6MTIxNywiYSsiOjEwOTAsImF4KyI6MTIxOCwieGErIjoxMjE4fSxtb2RlU3RyaW5nVG9GbGFnczpmdW5jdGlvbihlKXt2YXIgdD1UZS5mbGFnTW9kZXNbZV07aWYodm9pZCAwPT09dCl0aHJvdyBuZXcgRXJyb3IoIlVua25vd24gZmlsZSBvcGVuIG1vZGU6ICIrZSk7cmV0dXJuIHR9LGZsYWdzVG9QZXJtaXNzaW9uU3RyaW5nOmZ1bmN0aW9uKGUpe3ZhciB0PVsiciIsInciLCJydyJdWzMmZV07cmV0dXJuIDUxMiZlJiYodCs9InciKSx0fSxub2RlUGVybWlzc2lvbnM6ZnVuY3Rpb24oZSx0KXtyZXR1cm4gVGUuaWdub3JlUGVybWlzc2lvbnN8fCgtMT09PXQuaW5kZXhPZigiciIpfHwyOTImZS5tb2RlKSYmKC0xPT09dC5pbmRleE9mKCJ3Iil8fDE0NiZlLm1vZGUpJiYoLTE9PT10LmluZGV4T2YoIngiKXx8NzMmZS5tb2RlKT8wOm1lLkVBQ0NFU30sbWF5TG9va3VwOmZ1bmN0aW9uKGUpe3ZhciB0PVRlLm5vZGVQZXJtaXNzaW9ucyhlLCJ4Iik7cmV0dXJuIHR8fChlLm5vZGVfb3BzLmxvb2t1cD8wOm1lLkVBQ0NFUyl9LG1heUNyZWF0ZTpmdW5jdGlvbihlLHQpe3RyeXtUZS5sb29rdXBOb2RlKGUsdCk7cmV0dXJuIG1lLkVFWElTVH1jYXRjaChlKXt9cmV0dXJuIFRlLm5vZGVQZXJtaXNzaW9ucyhlLCJ3eCIpfSxtYXlEZWxldGU6ZnVuY3Rpb24oZSx0LHIpe3ZhciBuO3RyeXtuPVRlLmxvb2t1cE5vZGUoZSx0KX1jYXRjaChlKXtyZXR1cm4gZS5lcnJub312YXIgbz1UZS5ub2RlUGVybWlzc2lvbnMoZSwid3giKTtpZihvKXJldHVybiBvO2lmKHIpe2lmKCFUZS5pc0RpcihuLm1vZGUpKXJldHVybiBtZS5FTk9URElSO2lmKFRlLmlzUm9vdChuKXx8VGUuZ2V0UGF0aChuKT09PVRlLmN3ZCgpKXJldHVybiBtZS5FQlVTWX1lbHNlIGlmKFRlLmlzRGlyKG4ubW9kZSkpcmV0dXJuIG1lLkVJU0RJUjtyZXR1cm4gMH0sbWF5T3BlbjpmdW5jdGlvbihlLHQpe3JldHVybiBlP1RlLmlzTGluayhlLm1vZGUpP21lLkVMT09QOlRlLmlzRGlyKGUubW9kZSkmJigiciIhPT1UZS5mbGFnc1RvUGVybWlzc2lvblN0cmluZyh0KXx8NTEyJnQpP21lLkVJU0RJUjpUZS5ub2RlUGVybWlzc2lvbnMoZSxUZS5mbGFnc1RvUGVybWlzc2lvblN0cmluZyh0KSk6bWUuRU5PRU5UfSxNQVhfT1BFTl9GRFM6NDA5NixuZXh0ZmQ6ZnVuY3Rpb24oZSx0KXtlPWV8fDAsdD10fHxUZS5NQVhfT1BFTl9GRFM7Zm9yKHZhciByPWU7cjw9dDtyKyspaWYoIVRlLnN0cmVhbXNbcl0pcmV0dXJuIHI7dGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRU1GSUxFKX0sZ2V0U3RyZWFtOmZ1bmN0aW9uKGUpe3JldHVybiBUZS5zdHJlYW1zW2VdfSxjcmVhdGVTdHJlYW06ZnVuY3Rpb24oZSx0LHIpe1RlLkZTU3RyZWFtfHwoVGUuRlNTdHJlYW09ZnVuY3Rpb24oKXt9LFRlLkZTU3RyZWFtLnByb3RvdHlwZT17fSxPYmplY3QuZGVmaW5lUHJvcGVydGllcyhUZS5GU1N0cmVhbS5wcm90b3R5cGUse29iamVjdDp7Z2V0OmZ1bmN0aW9uKCl7cmV0dXJuIHRoaXMubm9kZX0sc2V0OmZ1bmN0aW9uKGUpe3RoaXMubm9kZT1lfX0saXNSZWFkOntnZXQ6ZnVuY3Rpb24oKXtyZXR1cm4gMSE9KDIwOTcxNTUmdGhpcy5mbGFncyl9fSxpc1dyaXRlOntnZXQ6ZnVuY3Rpb24oKXtyZXR1cm4gMCE9KDIwOTcxNTUmdGhpcy5mbGFncyl9fSxpc0FwcGVuZDp7Z2V0OmZ1bmN0aW9uKCl7cmV0dXJuIDEwMjQmdGhpcy5mbGFnc319fSkpO3ZhciBuPW5ldyBUZS5GU1N0cmVhbTtmb3IodmFyIG8gaW4gZSluW29dPWVbb107ZT1uO3ZhciBpPVRlLm5leHRmZCh0LHIpO3JldHVybiBlLmZkPWksVGUuc3RyZWFtc1tpXT1lLGV9LGNsb3NlU3RyZWFtOmZ1bmN0aW9uKGUpe1RlLnN0cmVhbXNbZV09bnVsbH0sY2hyZGV2X3N0cmVhbV9vcHM6e29wZW46ZnVuY3Rpb24oZSl7dmFyIHQ9VGUuZ2V0RGV2aWNlKGUubm9kZS5yZGV2KTtlLnN0cmVhbV9vcHM9dC5zdHJlYW1fb3BzLGUuc3RyZWFtX29wcy5vcGVuJiZlLnN0cmVhbV9vcHMub3BlbihlKX0sbGxzZWVrOmZ1bmN0aW9uKCl7dGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRVNQSVBFKX19LG1ham9yOmZ1bmN0aW9uKGUpe3JldHVybiBlPj44fSxtaW5vcjpmdW5jdGlvbihlKXtyZXR1cm4gMjU1JmV9LG1ha2VkZXY6ZnVuY3Rpb24oZSx0KXtyZXR1cm4gZTw8OHx0fSxyZWdpc3RlckRldmljZTpmdW5jdGlvbihlLHQpe1RlLmRldmljZXNbZV09e3N0cmVhbV9vcHM6dH19LGdldERldmljZTpmdW5jdGlvbihlKXtyZXR1cm4gVGUuZGV2aWNlc1tlXX0sZ2V0TW91bnRzOmZ1bmN0aW9uKGUpe2Zvcih2YXIgdD1bXSxyPVtlXTtyLmxlbmd0aDspe3ZhciBuPXIucG9wKCk7dC5wdXNoKG4pLHIucHVzaC5hcHBseShyLG4ubW91bnRzKX1yZXR1cm4gdH0sc3luY2ZzOmZ1bmN0aW9uKGUsdCl7ImZ1bmN0aW9uIj09dHlwZW9mIGUmJih0PWUsZT0hMSksVGUuc3luY0ZTUmVxdWVzdHMrKyxUZS5zeW5jRlNSZXF1ZXN0cz4xJiZjb25zb2xlLmxvZygid2FybmluZzogIitUZS5zeW5jRlNSZXF1ZXN0cysiIEZTLnN5bmNmcyBvcGVyYXRpb25zIGluIGZsaWdodCBhdCBvbmNlLCBwcm9iYWJseSBqdXN0IGRvaW5nIGV4dHJhIHdvcmsiKTt2YXIgcj1UZS5nZXRNb3VudHMoVGUucm9vdC5tb3VudCksbj0wO2Z1bmN0aW9uIG8oZSl7cmV0dXJuIHkoVGUuc3luY0ZTUmVxdWVzdHM+MCksVGUuc3luY0ZTUmVxdWVzdHMtLSx0KGUpfWZ1bmN0aW9uIGkoZSl7aWYoZSlyZXR1cm4gaS5lcnJvcmVkP3ZvaWQgMDooaS5lcnJvcmVkPSEwLG8oZSkpOysrbj49ci5sZW5ndGgmJm8obnVsbCl9ci5mb3JFYWNoKChmdW5jdGlvbih0KXtpZighdC50eXBlLnN5bmNmcylyZXR1cm4gaShudWxsKTt0LnR5cGUuc3luY2ZzKHQsZSxpKX0pKX0sbW91bnQ6ZnVuY3Rpb24oZSx0LHIpe3ZhciBuLG89Ii8iPT09cixpPSFyO2lmKG8mJlRlLnJvb3QpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRUJVU1kpO2lmKCFvJiYhaSl7dmFyIGE9VGUubG9va3VwUGF0aChyLHtmb2xsb3dfbW91bnQ6ITF9KTtpZihyPWEucGF0aCxuPWEubm9kZSxUZS5pc01vdW50cG9pbnQobikpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRUJVU1kpO2lmKCFUZS5pc0RpcihuLm1vZGUpKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVOT1RESVIpfXZhciBzPXt0eXBlOmUsb3B0czp0LG1vdW50cG9pbnQ6cixtb3VudHM6W119LHU9ZS5tb3VudChzKTtyZXR1cm4gdS5tb3VudD1zLHMucm9vdD11LG8/VGUucm9vdD11Om4mJihuLm1vdW50ZWQ9cyxuLm1vdW50JiZuLm1vdW50Lm1vdW50cy5wdXNoKHMpKSx1fSx1bm1vdW50OmZ1bmN0aW9uKGUpe3ZhciB0PVRlLmxvb2t1cFBhdGgoZSx7Zm9sbG93X21vdW50OiExfSk7aWYoIVRlLmlzTW91bnRwb2ludCh0Lm5vZGUpKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVJTlZBTCk7dmFyIHI9dC5ub2RlLG49ci5tb3VudGVkLG89VGUuZ2V0TW91bnRzKG4pO09iamVjdC5rZXlzKFRlLm5hbWVUYWJsZSkuZm9yRWFjaCgoZnVuY3Rpb24oZSl7Zm9yKHZhciB0PVRlLm5hbWVUYWJsZVtlXTt0Oyl7dmFyIHI9dC5uYW1lX25leHQ7LTEhPT1vLmluZGV4T2YodC5tb3VudCkmJlRlLmRlc3Ryb3lOb2RlKHQpLHQ9cn19KSksci5tb3VudGVkPW51bGw7dmFyIGk9ci5tb3VudC5tb3VudHMuaW5kZXhPZihuKTt5KC0xIT09aSksci5tb3VudC5tb3VudHMuc3BsaWNlKGksMSl9LGxvb2t1cDpmdW5jdGlvbihlLHQpe3JldHVybiBlLm5vZGVfb3BzLmxvb2t1cChlLHQpfSxta25vZDpmdW5jdGlvbihlLHQscil7dmFyIG49VGUubG9va3VwUGF0aChlLHtwYXJlbnQ6ITB9KS5ub2RlLG89Z2UuYmFzZW5hbWUoZSk7aWYoIW98fCIuIj09PW98fCIuLiI9PT1vKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVJTlZBTCk7dmFyIGk9VGUubWF5Q3JlYXRlKG4sbyk7aWYoaSl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihpKTtpZighbi5ub2RlX29wcy5ta25vZCl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FUEVSTSk7cmV0dXJuIG4ubm9kZV9vcHMubWtub2QobixvLHQscil9LGNyZWF0ZTpmdW5jdGlvbihlLHQpe3JldHVybiB0PXZvaWQgMCE9PXQ/dDo0MzgsdCY9NDA5NSx0fD0zMjc2OCxUZS5ta25vZChlLHQsMCl9LG1rZGlyOmZ1bmN0aW9uKGUsdCl7cmV0dXJuIHQ9dm9pZCAwIT09dD90OjUxMSx0Jj0xMDIzLHR8PTE2Mzg0LFRlLm1rbm9kKGUsdCwwKX0sbWtkaXJUcmVlOmZ1bmN0aW9uKGUsdCl7Zm9yKHZhciByPWUuc3BsaXQoIi8iKSxuPSIiLG89MDtvPHIubGVuZ3RoOysrbylpZihyW29dKXtuKz0iLyIrcltvXTt0cnl7VGUubWtkaXIobix0KX1jYXRjaChlKXtpZihlLmVycm5vIT1tZS5FRVhJU1QpdGhyb3cgZX19fSxta2RldjpmdW5jdGlvbihlLHQscil7cmV0dXJuIHZvaWQgMD09PXImJihyPXQsdD00MzgpLHR8PTgxOTIsVGUubWtub2QoZSx0LHIpfSxzeW1saW5rOmZ1bmN0aW9uKGUsdCl7aWYoIWdlLnJlc29sdmUoZSkpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRU5PRU5UKTt2YXIgcj1UZS5sb29rdXBQYXRoKHQse3BhcmVudDohMH0pLm5vZGU7aWYoIXIpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRU5PRU5UKTt2YXIgbj1nZS5iYXNlbmFtZSh0KSxvPVRlLm1heUNyZWF0ZShyLG4pO2lmKG8pdGhyb3cgbmV3IFRlLkVycm5vRXJyb3Iobyk7aWYoIXIubm9kZV9vcHMuc3ltbGluayl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FUEVSTSk7cmV0dXJuIHIubm9kZV9vcHMuc3ltbGluayhyLG4sZSl9LHJlbmFtZTpmdW5jdGlvbihlLHQpe3ZhciByLG4sbz1nZS5kaXJuYW1lKGUpLGk9Z2UuZGlybmFtZSh0KSxhPWdlLmJhc2VuYW1lKGUpLHM9Z2UuYmFzZW5hbWUodCk7dHJ5e3I9VGUubG9va3VwUGF0aChlLHtwYXJlbnQ6ITB9KS5ub2RlLG49VGUubG9va3VwUGF0aCh0LHtwYXJlbnQ6ITB9KS5ub2RlfWNhdGNoKGUpe3Rocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVCVVNZKX1pZighcnx8IW4pdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRU5PRU5UKTtpZihyLm1vdW50IT09bi5tb3VudCl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FWERFVik7dmFyIHUsYz1UZS5sb29rdXBOb2RlKHIsYSksbD1nZS5yZWxhdGl2ZShlLGkpO2lmKCIuIiE9PWwuY2hhckF0KDApKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVJTlZBTCk7aWYoIi4iIT09KGw9Z2UucmVsYXRpdmUodCxvKSkuY2hhckF0KDApKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVOT1RFTVBUWSk7dHJ5e3U9VGUubG9va3VwTm9kZShuLHMpfWNhdGNoKGUpe31pZihjIT09dSl7dmFyIGY9VGUuaXNEaXIoYy5tb2RlKSxkPVRlLm1heURlbGV0ZShyLGEsZik7aWYoZCl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihkKTtpZihkPXU/VGUubWF5RGVsZXRlKG4scyxmKTpUZS5tYXlDcmVhdGUobixzKSl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihkKTtpZighci5ub2RlX29wcy5yZW5hbWUpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRVBFUk0pO2lmKFRlLmlzTW91bnRwb2ludChjKXx8dSYmVGUuaXNNb3VudHBvaW50KHUpKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVCVVNZKTtpZihuIT09ciYmKGQ9VGUubm9kZVBlcm1pc3Npb25zKHIsInciKSkpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IoZCk7dHJ5e1RlLnRyYWNraW5nRGVsZWdhdGUud2lsbE1vdmVQYXRoJiZUZS50cmFja2luZ0RlbGVnYXRlLndpbGxNb3ZlUGF0aChlLHQpfWNhdGNoKHIpe2NvbnNvbGUubG9nKCJGUy50cmFja2luZ0RlbGVnYXRlWyd3aWxsTW92ZVBhdGgnXSgnIitlKyInLCAnIit0KyInKSB0aHJldyBhbiBleGNlcHRpb246ICIrci5tZXNzYWdlKX1UZS5oYXNoUmVtb3ZlTm9kZShjKTt0cnl7ci5ub2RlX29wcy5yZW5hbWUoYyxuLHMpfWNhdGNoKGUpe3Rocm93IGV9ZmluYWxseXtUZS5oYXNoQWRkTm9kZShjKX10cnl7VGUudHJhY2tpbmdEZWxlZ2F0ZS5vbk1vdmVQYXRoJiZUZS50cmFja2luZ0RlbGVnYXRlLm9uTW92ZVBhdGgoZSx0KX1jYXRjaChyKXtjb25zb2xlLmxvZygiRlMudHJhY2tpbmdEZWxlZ2F0ZVsnb25Nb3ZlUGF0aCddKCciK2UrIicsICciK3QrIicpIHRocmV3IGFuIGV4Y2VwdGlvbjogIityLm1lc3NhZ2UpfX19LHJtZGlyOmZ1bmN0aW9uKGUpe3ZhciB0PVRlLmxvb2t1cFBhdGgoZSx7cGFyZW50OiEwfSkubm9kZSxyPWdlLmJhc2VuYW1lKGUpLG49VGUubG9va3VwTm9kZSh0LHIpLG89VGUubWF5RGVsZXRlKHQsciwhMCk7aWYobyl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihvKTtpZighdC5ub2RlX29wcy5ybWRpcil0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FUEVSTSk7aWYoVGUuaXNNb3VudHBvaW50KG4pKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVCVVNZKTt0cnl7VGUudHJhY2tpbmdEZWxlZ2F0ZS53aWxsRGVsZXRlUGF0aCYmVGUudHJhY2tpbmdEZWxlZ2F0ZS53aWxsRGVsZXRlUGF0aChlKX1jYXRjaCh0KXtjb25zb2xlLmxvZygiRlMudHJhY2tpbmdEZWxlZ2F0ZVsnd2lsbERlbGV0ZVBhdGgnXSgnIitlKyInKSB0aHJldyBhbiBleGNlcHRpb246ICIrdC5tZXNzYWdlKX10Lm5vZGVfb3BzLnJtZGlyKHQsciksVGUuZGVzdHJveU5vZGUobik7dHJ5e1RlLnRyYWNraW5nRGVsZWdhdGUub25EZWxldGVQYXRoJiZUZS50cmFja2luZ0RlbGVnYXRlLm9uRGVsZXRlUGF0aChlKX1jYXRjaCh0KXtjb25zb2xlLmxvZygiRlMudHJhY2tpbmdEZWxlZ2F0ZVsnb25EZWxldGVQYXRoJ10oJyIrZSsiJykgdGhyZXcgYW4gZXhjZXB0aW9uOiAiK3QubWVzc2FnZSl9fSxyZWFkZGlyOmZ1bmN0aW9uKGUpe3ZhciB0PVRlLmxvb2t1cFBhdGgoZSx7Zm9sbG93OiEwfSkubm9kZTtpZighdC5ub2RlX29wcy5yZWFkZGlyKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVOT1RESVIpO3JldHVybiB0Lm5vZGVfb3BzLnJlYWRkaXIodCl9LHVubGluazpmdW5jdGlvbihlKXt2YXIgdD1UZS5sb29rdXBQYXRoKGUse3BhcmVudDohMH0pLm5vZGUscj1nZS5iYXNlbmFtZShlKSxuPVRlLmxvb2t1cE5vZGUodCxyKSxvPVRlLm1heURlbGV0ZSh0LHIsITEpO2lmKG8pdGhyb3cgbmV3IFRlLkVycm5vRXJyb3Iobyk7aWYoIXQubm9kZV9vcHMudW5saW5rKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVQRVJNKTtpZihUZS5pc01vdW50cG9pbnQobikpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRUJVU1kpO3RyeXtUZS50cmFja2luZ0RlbGVnYXRlLndpbGxEZWxldGVQYXRoJiZUZS50cmFja2luZ0RlbGVnYXRlLndpbGxEZWxldGVQYXRoKGUpfWNhdGNoKHQpe2NvbnNvbGUubG9nKCJGUy50cmFja2luZ0RlbGVnYXRlWyd3aWxsRGVsZXRlUGF0aCddKCciK2UrIicpIHRocmV3IGFuIGV4Y2VwdGlvbjogIit0Lm1lc3NhZ2UpfXQubm9kZV9vcHMudW5saW5rKHQsciksVGUuZGVzdHJveU5vZGUobik7dHJ5e1RlLnRyYWNraW5nRGVsZWdhdGUub25EZWxldGVQYXRoJiZUZS50cmFja2luZ0RlbGVnYXRlLm9uRGVsZXRlUGF0aChlKX1jYXRjaCh0KXtjb25zb2xlLmxvZygiRlMudHJhY2tpbmdEZWxlZ2F0ZVsnb25EZWxldGVQYXRoJ10oJyIrZSsiJykgdGhyZXcgYW4gZXhjZXB0aW9uOiAiK3QubWVzc2FnZSl9fSxyZWFkbGluazpmdW5jdGlvbihlKXt2YXIgdD1UZS5sb29rdXBQYXRoKGUpLm5vZGU7aWYoIXQpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRU5PRU5UKTtpZighdC5ub2RlX29wcy5yZWFkbGluayl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FSU5WQUwpO3JldHVybiBnZS5yZXNvbHZlKFRlLmdldFBhdGgodC5wYXJlbnQpLHQubm9kZV9vcHMucmVhZGxpbmsodCkpfSxzdGF0OmZ1bmN0aW9uKGUsdCl7dmFyIHI9VGUubG9va3VwUGF0aChlLHtmb2xsb3c6IXR9KS5ub2RlO2lmKCFyKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVOT0VOVCk7aWYoIXIubm9kZV9vcHMuZ2V0YXR0cil0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FUEVSTSk7cmV0dXJuIHIubm9kZV9vcHMuZ2V0YXR0cihyKX0sbHN0YXQ6ZnVuY3Rpb24oZSl7cmV0dXJuIFRlLnN0YXQoZSwhMCl9LGNobW9kOmZ1bmN0aW9uKGUsdCxyKXt2YXIgbjsic3RyaW5nIj09dHlwZW9mIGU/bj1UZS5sb29rdXBQYXRoKGUse2ZvbGxvdzohcn0pLm5vZGU6bj1lO2lmKCFuLm5vZGVfb3BzLnNldGF0dHIpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRVBFUk0pO24ubm9kZV9vcHMuc2V0YXR0cihuLHttb2RlOjQwOTUmdHwtNDA5NiZuLm1vZGUsdGltZXN0YW1wOkRhdGUubm93KCl9KX0sbGNobW9kOmZ1bmN0aW9uKGUsdCl7VGUuY2htb2QoZSx0LCEwKX0sZmNobW9kOmZ1bmN0aW9uKGUsdCl7dmFyIHI9VGUuZ2V0U3RyZWFtKGUpO2lmKCFyKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVCQURGKTtUZS5jaG1vZChyLm5vZGUsdCl9LGNob3duOmZ1bmN0aW9uKGUsdCxyLG4pe3ZhciBvOyJzdHJpbmciPT10eXBlb2YgZT9vPVRlLmxvb2t1cFBhdGgoZSx7Zm9sbG93OiFufSkubm9kZTpvPWU7aWYoIW8ubm9kZV9vcHMuc2V0YXR0cil0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FUEVSTSk7by5ub2RlX29wcy5zZXRhdHRyKG8se3RpbWVzdGFtcDpEYXRlLm5vdygpfSl9LGxjaG93bjpmdW5jdGlvbihlLHQscil7VGUuY2hvd24oZSx0LHIsITApfSxmY2hvd246ZnVuY3Rpb24oZSx0LHIpe3ZhciBuPVRlLmdldFN0cmVhbShlKTtpZighbil0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FQkFERik7VGUuY2hvd24obi5ub2RlLHQscil9LHRydW5jYXRlOmZ1bmN0aW9uKGUsdCl7aWYodDwwKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVJTlZBTCk7dmFyIHI7InN0cmluZyI9PXR5cGVvZiBlP3I9VGUubG9va3VwUGF0aChlLHtmb2xsb3c6ITB9KS5ub2RlOnI9ZTtpZighci5ub2RlX29wcy5zZXRhdHRyKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVQRVJNKTtpZihUZS5pc0RpcihyLm1vZGUpKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVJU0RJUik7aWYoIVRlLmlzRmlsZShyLm1vZGUpKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVJTlZBTCk7dmFyIG49VGUubm9kZVBlcm1pc3Npb25zKHIsInciKTtpZihuKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG4pO3Iubm9kZV9vcHMuc2V0YXR0cihyLHtzaXplOnQsdGltZXN0YW1wOkRhdGUubm93KCl9KX0sZnRydW5jYXRlOmZ1bmN0aW9uKGUsdCl7dmFyIHI9VGUuZ2V0U3RyZWFtKGUpO2lmKCFyKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVCQURGKTtpZigwPT0oMjA5NzE1NSZyLmZsYWdzKSl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FSU5WQUwpO1RlLnRydW5jYXRlKHIubm9kZSx0KX0sdXRpbWU6ZnVuY3Rpb24oZSx0LHIpe3ZhciBuPVRlLmxvb2t1cFBhdGgoZSx7Zm9sbG93OiEwfSkubm9kZTtuLm5vZGVfb3BzLnNldGF0dHIobix7dGltZXN0YW1wOk1hdGgubWF4KHQscil9KX0sb3BlbjpmdW5jdGlvbihlLHQscixuLGkpe2lmKCIiPT09ZSl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FTk9FTlQpO3ZhciBhO2lmKHI9dm9pZCAwPT09cj80Mzg6cixyPTY0Jih0PSJzdHJpbmciPT10eXBlb2YgdD9UZS5tb2RlU3RyaW5nVG9GbGFncyh0KTp0KT80MDk1JnJ8MzI3Njg6MCwib2JqZWN0Ij09dHlwZW9mIGUpYT1lO2Vsc2V7ZT1nZS5ub3JtYWxpemUoZSk7dHJ5e2E9VGUubG9va3VwUGF0aChlLHtmb2xsb3c6ISgxMzEwNzImdCl9KS5ub2RlfWNhdGNoKGUpe319dmFyIHM9ITE7aWYoNjQmdClpZihhKXtpZigxMjgmdCl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FRVhJU1QpfWVsc2UgYT1UZS5ta25vZChlLHIsMCkscz0hMDtpZighYSl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FTk9FTlQpO2lmKFRlLmlzQ2hyZGV2KGEubW9kZSkmJih0Jj0tNTEzKSw2NTUzNiZ0JiYhVGUuaXNEaXIoYS5tb2RlKSl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FTk9URElSKTtpZighcyl7dmFyIHU9VGUubWF5T3BlbihhLHQpO2lmKHUpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IodSl9NTEyJnQmJlRlLnRydW5jYXRlKGEsMCksdCY9LTY0MTt2YXIgYz1UZS5jcmVhdGVTdHJlYW0oe25vZGU6YSxwYXRoOlRlLmdldFBhdGgoYSksZmxhZ3M6dCxzZWVrYWJsZTohMCxwb3NpdGlvbjowLHN0cmVhbV9vcHM6YS5zdHJlYW1fb3BzLHVuZ290dGVuOltdLGVycm9yOiExfSxuLGkpO2Muc3RyZWFtX29wcy5vcGVuJiZjLnN0cmVhbV9vcHMub3BlbihjKSwhby5sb2dSZWFkRmlsZXN8fDEmdHx8KFRlLnJlYWRGaWxlc3x8KFRlLnJlYWRGaWxlcz17fSksZSBpbiBUZS5yZWFkRmlsZXN8fChUZS5yZWFkRmlsZXNbZV09MSxvLnByaW50RXJyKCJyZWFkIGZpbGU6ICIrZSkpKTt0cnl7aWYoVGUudHJhY2tpbmdEZWxlZ2F0ZS5vbk9wZW5GaWxlKXt2YXIgbD0wOzEhPSgyMDk3MTU1JnQpJiYobHw9VGUudHJhY2tpbmcub3BlbkZsYWdzLlJFQUQpLDAhPSgyMDk3MTU1JnQpJiYobHw9VGUudHJhY2tpbmcub3BlbkZsYWdzLldSSVRFKSxUZS50cmFja2luZ0RlbGVnYXRlLm9uT3BlbkZpbGUoZSxsKX19Y2F0Y2godCl7Y29uc29sZS5sb2coIkZTLnRyYWNraW5nRGVsZWdhdGVbJ29uT3BlbkZpbGUnXSgnIitlKyInLCBmbGFncykgdGhyZXcgYW4gZXhjZXB0aW9uOiAiK3QubWVzc2FnZSl9cmV0dXJuIGN9LGNsb3NlOmZ1bmN0aW9uKGUpe2lmKFRlLmlzQ2xvc2VkKGUpKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVCQURGKTtlLmdldGRlbnRzJiYoZS5nZXRkZW50cz1udWxsKTt0cnl7ZS5zdHJlYW1fb3BzLmNsb3NlJiZlLnN0cmVhbV9vcHMuY2xvc2UoZSl9Y2F0Y2goZSl7dGhyb3cgZX1maW5hbGx5e1RlLmNsb3NlU3RyZWFtKGUuZmQpfWUuZmQ9bnVsbH0saXNDbG9zZWQ6ZnVuY3Rpb24oZSl7cmV0dXJuIG51bGw9PT1lLmZkfSxsbHNlZWs6ZnVuY3Rpb24oZSx0LHIpe2lmKFRlLmlzQ2xvc2VkKGUpKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVCQURGKTtpZighZS5zZWVrYWJsZXx8IWUuc3RyZWFtX29wcy5sbHNlZWspdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRVNQSVBFKTtyZXR1cm4gZS5wb3NpdGlvbj1lLnN0cmVhbV9vcHMubGxzZWVrKGUsdCxyKSxlLnVuZ290dGVuPVtdLGUucG9zaXRpb259LHJlYWQ6ZnVuY3Rpb24oZSx0LHIsbixvKXtpZihuPDB8fG88MCl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FSU5WQUwpO2lmKFRlLmlzQ2xvc2VkKGUpKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVCQURGKTtpZigxPT0oMjA5NzE1NSZlLmZsYWdzKSl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FQkFERik7aWYoVGUuaXNEaXIoZS5ub2RlLm1vZGUpKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVJU0RJUik7aWYoIWUuc3RyZWFtX29wcy5yZWFkKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVJTlZBTCk7dmFyIGk9dm9pZCAwIT09bztpZihpKXtpZighZS5zZWVrYWJsZSl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FU1BJUEUpfWVsc2Ugbz1lLnBvc2l0aW9uO3ZhciBhPWUuc3RyZWFtX29wcy5yZWFkKGUsdCxyLG4sbyk7cmV0dXJuIGl8fChlLnBvc2l0aW9uKz1hKSxhfSx3cml0ZTpmdW5jdGlvbihlLHQscixuLG8saSl7aWYobjwwfHxvPDApdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRUlOVkFMKTtpZihUZS5pc0Nsb3NlZChlKSl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FQkFERik7aWYoMD09KDIwOTcxNTUmZS5mbGFncykpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRUJBREYpO2lmKFRlLmlzRGlyKGUubm9kZS5tb2RlKSl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FSVNESVIpO2lmKCFlLnN0cmVhbV9vcHMud3JpdGUpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRUlOVkFMKTsxMDI0JmUuZmxhZ3MmJlRlLmxsc2VlayhlLDAsMik7dmFyIGE9dm9pZCAwIT09bztpZihhKXtpZighZS5zZWVrYWJsZSl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FU1BJUEUpfWVsc2Ugbz1lLnBvc2l0aW9uO3ZhciBzPWUuc3RyZWFtX29wcy53cml0ZShlLHQscixuLG8saSk7YXx8KGUucG9zaXRpb24rPXMpO3RyeXtlLnBhdGgmJlRlLnRyYWNraW5nRGVsZWdhdGUub25Xcml0ZVRvRmlsZSYmVGUudHJhY2tpbmdEZWxlZ2F0ZS5vbldyaXRlVG9GaWxlKGUucGF0aCl9Y2F0Y2goZSl7Y29uc29sZS5sb2coIkZTLnRyYWNraW5nRGVsZWdhdGVbJ29uV3JpdGVUb0ZpbGUnXSgnIitwYXRoKyInKSB0aHJldyBhbiBleGNlcHRpb246ICIrZS5tZXNzYWdlKX1yZXR1cm4gc30sYWxsb2NhdGU6ZnVuY3Rpb24oZSx0LHIpe2lmKFRlLmlzQ2xvc2VkKGUpKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVCQURGKTtpZih0PDB8fHI8PTApdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRUlOVkFMKTtpZigwPT0oMjA5NzE1NSZlLmZsYWdzKSl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FQkFERik7aWYoIVRlLmlzRmlsZShlLm5vZGUubW9kZSkmJiFUZS5pc0RpcihlLm5vZGUubW9kZSkpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRU5PREVWKTtpZighZS5zdHJlYW1fb3BzLmFsbG9jYXRlKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVPUE5PVFNVUFApO2Uuc3RyZWFtX29wcy5hbGxvY2F0ZShlLHQscil9LG1tYXA6ZnVuY3Rpb24oZSx0LHIsbixvLGksYSl7aWYoMT09KDIwOTcxNTUmZS5mbGFncykpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRUFDQ0VTKTtpZighZS5zdHJlYW1fb3BzLm1tYXApdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRU5PREVWKTtyZXR1cm4gZS5zdHJlYW1fb3BzLm1tYXAoZSx0LHIsbixvLGksYSl9LG1zeW5jOmZ1bmN0aW9uKGUsdCxyLG4sbyl7cmV0dXJuIGUmJmUuc3RyZWFtX29wcy5tc3luYz9lLnN0cmVhbV9vcHMubXN5bmMoZSx0LHIsbixvKTowfSxtdW5tYXA6ZnVuY3Rpb24oZSl7cmV0dXJuIDB9LGlvY3RsOmZ1bmN0aW9uKGUsdCxyKXtpZighZS5zdHJlYW1fb3BzLmlvY3RsKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVOT1RUWSk7cmV0dXJuIGUuc3RyZWFtX29wcy5pb2N0bChlLHQscil9LHJlYWRGaWxlOmZ1bmN0aW9uKGUsdCl7aWYoKHQ9dHx8e30pLmZsYWdzPXQuZmxhZ3N8fCJyIix0LmVuY29kaW5nPXQuZW5jb2Rpbmd8fCJiaW5hcnkiLCJ1dGY4IiE9PXQuZW5jb2RpbmcmJiJiaW5hcnkiIT09dC5lbmNvZGluZyl0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgZW5jb2RpbmcgdHlwZSAiJyt0LmVuY29kaW5nKyciJyk7dmFyIHIsbj1UZS5vcGVuKGUsdC5mbGFncyksbz1UZS5zdGF0KGUpLnNpemUsaT1uZXcgVWludDhBcnJheShvKTtyZXR1cm4gVGUucmVhZChuLGksMCxvLDApLCJ1dGY4Ij09PXQuZW5jb2Rpbmc/cj1fKGksMCk6ImJpbmFyeSI9PT10LmVuY29kaW5nJiYocj1pKSxUZS5jbG9zZShuKSxyfSx3cml0ZUZpbGU6ZnVuY3Rpb24oZSx0LHIpeyhyPXJ8fHt9KS5mbGFncz1yLmZsYWdzfHwidyI7dmFyIG49VGUub3BlbihlLHIuZmxhZ3Msci5tb2RlKTtpZigic3RyaW5nIj09dHlwZW9mIHQpe3ZhciBvPW5ldyBVaW50OEFycmF5KFModCkrMSksaT1BKHQsbywwLG8ubGVuZ3RoKTtUZS53cml0ZShuLG8sMCxpLHZvaWQgMCxyLmNhbk93bil9ZWxzZXtpZighQXJyYXlCdWZmZXIuaXNWaWV3KHQpKXRocm93IG5ldyBFcnJvcigiVW5zdXBwb3J0ZWQgZGF0YSB0eXBlIik7VGUud3JpdGUobix0LDAsdC5ieXRlTGVuZ3RoLHZvaWQgMCxyLmNhbk93bil9VGUuY2xvc2Uobil9LGN3ZDpmdW5jdGlvbigpe3JldHVybiBUZS5jdXJyZW50UGF0aH0sY2hkaXI6ZnVuY3Rpb24oZSl7dmFyIHQ9VGUubG9va3VwUGF0aChlLHtmb2xsb3c6ITB9KTtpZihudWxsPT09dC5ub2RlKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG1lLkVOT0VOVCk7aWYoIVRlLmlzRGlyKHQubm9kZS5tb2RlKSl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FTk9URElSKTt2YXIgcj1UZS5ub2RlUGVybWlzc2lvbnModC5ub2RlLCJ4Iik7aWYocil0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihyKTtUZS5jdXJyZW50UGF0aD10LnBhdGh9LGNyZWF0ZURlZmF1bHREaXJlY3RvcmllczpmdW5jdGlvbigpe1RlLm1rZGlyKCIvdG1wIiksVGUubWtkaXIoIi9ob21lIiksVGUubWtkaXIoIi9ob21lL3dlYl91c2VyIil9LGNyZWF0ZURlZmF1bHREZXZpY2VzOmZ1bmN0aW9uKCl7dmFyIGU7aWYoVGUubWtkaXIoIi9kZXYiKSxUZS5yZWdpc3RlckRldmljZShUZS5tYWtlZGV2KDEsMykse3JlYWQ6ZnVuY3Rpb24oKXtyZXR1cm4gMH0sd3JpdGU6ZnVuY3Rpb24oZSx0LHIsbixvKXtyZXR1cm4gbn19KSxUZS5ta2RldigiL2Rldi9udWxsIixUZS5tYWtlZGV2KDEsMykpLHZlLnJlZ2lzdGVyKFRlLm1ha2VkZXYoNSwwKSx2ZS5kZWZhdWx0X3R0eV9vcHMpLHZlLnJlZ2lzdGVyKFRlLm1ha2VkZXYoNiwwKSx2ZS5kZWZhdWx0X3R0eTFfb3BzKSxUZS5ta2RldigiL2Rldi90dHkiLFRlLm1ha2VkZXYoNSwwKSksVGUubWtkZXYoIi9kZXYvdHR5MSIsVGUubWFrZWRldig2LDApKSwidW5kZWZpbmVkIiE9dHlwZW9mIGNyeXB0byl7dmFyIHQ9bmV3IFVpbnQ4QXJyYXkoMSk7ZT1mdW5jdGlvbigpe3JldHVybiBjcnlwdG8uZ2V0UmFuZG9tVmFsdWVzKHQpLHRbMF19fWVsc2UgZT1sP2Z1bmN0aW9uKCl7cmV0dXJuIHJlcXVpcmUoImNyeXB0byIpLnJhbmRvbUJ5dGVzKDEpWzBdfTpmdW5jdGlvbigpe3JldHVybiAyNTYqTWF0aC5yYW5kb20oKXwwfTtUZS5jcmVhdGVEZXZpY2UoIi9kZXYiLCJyYW5kb20iLGUpLFRlLmNyZWF0ZURldmljZSgiL2RldiIsInVyYW5kb20iLGUpLFRlLm1rZGlyKCIvZGV2L3NobSIpLFRlLm1rZGlyKCIvZGV2L3NobS90bXAiKX0sY3JlYXRlU3BlY2lhbERpcmVjdG9yaWVzOmZ1bmN0aW9uKCl7VGUubWtkaXIoIi9wcm9jIiksVGUubWtkaXIoIi9wcm9jL3NlbGYiKSxUZS5ta2RpcigiL3Byb2Mvc2VsZi9mZCIpLFRlLm1vdW50KHttb3VudDpmdW5jdGlvbigpe3ZhciBlPVRlLmNyZWF0ZU5vZGUoIi9wcm9jL3NlbGYiLCJmZCIsMTY4OTUsNzMpO3JldHVybiBlLm5vZGVfb3BzPXtsb29rdXA6ZnVuY3Rpb24oZSx0KXt2YXIgcj0rdCxuPVRlLmdldFN0cmVhbShyKTtpZighbil0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FQkFERik7dmFyIG89e3BhcmVudDpudWxsLG1vdW50Onttb3VudHBvaW50OiJmYWtlIn0sbm9kZV9vcHM6e3JlYWRsaW5rOmZ1bmN0aW9uKCl7cmV0dXJuIG4ucGF0aH19fTtyZXR1cm4gby5wYXJlbnQ9byxvfX0sZX19LHt9LCIvcHJvYy9zZWxmL2ZkIil9LGNyZWF0ZVN0YW5kYXJkU3RyZWFtczpmdW5jdGlvbigpe28uc3RkaW4/VGUuY3JlYXRlRGV2aWNlKCIvZGV2Iiwic3RkaW4iLG8uc3RkaW4pOlRlLnN5bWxpbmsoIi9kZXYvdHR5IiwiL2Rldi9zdGRpbiIpLG8uc3Rkb3V0P1RlLmNyZWF0ZURldmljZSgiL2RldiIsInN0ZG91dCIsbnVsbCxvLnN0ZG91dCk6VGUuc3ltbGluaygiL2Rldi90dHkiLCIvZGV2L3N0ZG91dCIpLG8uc3RkZXJyP1RlLmNyZWF0ZURldmljZSgiL2RldiIsInN0ZGVyciIsbnVsbCxvLnN0ZGVycik6VGUuc3ltbGluaygiL2Rldi90dHkxIiwiL2Rldi9zdGRlcnIiKTt2YXIgZT1UZS5vcGVuKCIvZGV2L3N0ZGluIiwiciIpO3koMD09PWUuZmQsImludmFsaWQgaGFuZGxlIGZvciBzdGRpbiAoIitlLmZkKyIpIik7dmFyIHQ9VGUub3BlbigiL2Rldi9zdGRvdXQiLCJ3Iik7eSgxPT09dC5mZCwiaW52YWxpZCBoYW5kbGUgZm9yIHN0ZG91dCAoIit0LmZkKyIpIik7dmFyIHI9VGUub3BlbigiL2Rldi9zdGRlcnIiLCJ3Iik7eSgyPT09ci5mZCwiaW52YWxpZCBoYW5kbGUgZm9yIHN0ZGVyciAoIityLmZkKyIpIil9LGVuc3VyZUVycm5vRXJyb3I6ZnVuY3Rpb24oKXtUZS5FcnJub0Vycm9yfHwoVGUuRXJybm9FcnJvcj1mdW5jdGlvbihlLHQpe3RoaXMubm9kZT10LHRoaXMuc2V0RXJybm89ZnVuY3Rpb24oZSl7Zm9yKHZhciB0IGluIHRoaXMuZXJybm89ZSxtZSlpZihtZVt0XT09PWUpe3RoaXMuY29kZT10O2JyZWFrfX0sdGhpcy5zZXRFcnJubyhlKSx0aGlzLm1lc3NhZ2U9RWVbZV0sdGhpcy5zdGFjayYmT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsInN0YWNrIix7dmFsdWU6KG5ldyBFcnJvcikuc3RhY2ssd3JpdGFibGU6ITB9KX0sVGUuRXJybm9FcnJvci5wcm90b3R5cGU9bmV3IEVycm9yLFRlLkVycm5vRXJyb3IucHJvdG90eXBlLmNvbnN0cnVjdG9yPVRlLkVycm5vRXJyb3IsW21lLkVOT0VOVF0uZm9yRWFjaCgoZnVuY3Rpb24oZSl7VGUuZ2VuZXJpY0Vycm9yc1tlXT1uZXcgVGUuRXJybm9FcnJvcihlKSxUZS5nZW5lcmljRXJyb3JzW2VdLnN0YWNrPSI8Z2VuZXJpYyBlcnJvciwgbm8gc3RhY2s+In0pKSl9LHN0YXRpY0luaXQ6ZnVuY3Rpb24oKXtUZS5lbnN1cmVFcnJub0Vycm9yKCksVGUubmFtZVRhYmxlPW5ldyBBcnJheSg0MDk2KSxUZS5tb3VudCh3ZSx7fSwiLyIpLFRlLmNyZWF0ZURlZmF1bHREaXJlY3RvcmllcygpLFRlLmNyZWF0ZURlZmF1bHREZXZpY2VzKCksVGUuY3JlYXRlU3BlY2lhbERpcmVjdG9yaWVzKCksVGUuZmlsZXN5c3RlbXM9e01FTUZTOndlLElEQkZTOl9lLE5PREVGUzpiZSxXT1JLRVJGUzpBZX19LGluaXQ6ZnVuY3Rpb24oZSx0LHIpe3koIVRlLmluaXQuaW5pdGlhbGl6ZWQsIkZTLmluaXQgd2FzIHByZXZpb3VzbHkgY2FsbGVkLiBJZiB5b3Ugd2FudCB0byBpbml0aWFsaXplIGxhdGVyIHdpdGggY3VzdG9tIHBhcmFtZXRlcnMsIHJlbW92ZSBhbnkgZWFybGllciBjYWxscyAobm90ZSB0aGF0IG9uZSBpcyBhdXRvbWF0aWNhbGx5IGFkZGVkIHRvIHRoZSBnZW5lcmF0ZWQgY29kZSkiKSxUZS5pbml0LmluaXRpYWxpemVkPSEwLFRlLmVuc3VyZUVycm5vRXJyb3IoKSxvLnN0ZGluPWV8fG8uc3RkaW4sby5zdGRvdXQ9dHx8by5zdGRvdXQsby5zdGRlcnI9cnx8by5zdGRlcnIsVGUuY3JlYXRlU3RhbmRhcmRTdHJlYW1zKCl9LHF1aXQ6ZnVuY3Rpb24oKXtUZS5pbml0LmluaXRpYWxpemVkPSExO3ZhciBlPW8uX2ZmbHVzaDtlJiZlKDApO2Zvcih2YXIgdD0wO3Q8VGUuc3RyZWFtcy5sZW5ndGg7dCsrKXt2YXIgcj1UZS5zdHJlYW1zW3RdO3ImJlRlLmNsb3NlKHIpfX0sZ2V0TW9kZTpmdW5jdGlvbihlLHQpe3ZhciByPTA7cmV0dXJuIGUmJihyfD0zNjUpLHQmJihyfD0xNDYpLHJ9LGpvaW5QYXRoOmZ1bmN0aW9uKGUsdCl7dmFyIHI9Z2Uuam9pbi5hcHBseShudWxsLGUpO3JldHVybiB0JiYiLyI9PXJbMF0mJihyPXIuc3Vic3RyKDEpKSxyfSxhYnNvbHV0ZVBhdGg6ZnVuY3Rpb24oZSx0KXtyZXR1cm4gZ2UucmVzb2x2ZSh0LGUpfSxzdGFuZGFyZGl6ZVBhdGg6ZnVuY3Rpb24oZSl7cmV0dXJuIGdlLm5vcm1hbGl6ZShlKX0sZmluZE9iamVjdDpmdW5jdGlvbihlLHQpe3ZhciByPVRlLmFuYWx5emVQYXRoKGUsdCk7cmV0dXJuIHIuZXhpc3RzP3Iub2JqZWN0Oih5ZShyLmVycm9yKSxudWxsKX0sYW5hbHl6ZVBhdGg6ZnVuY3Rpb24oZSx0KXt0cnl7ZT0obj1UZS5sb29rdXBQYXRoKGUse2ZvbGxvdzohdH0pKS5wYXRofWNhdGNoKGUpe312YXIgcj17aXNSb290OiExLGV4aXN0czohMSxlcnJvcjowLG5hbWU6bnVsbCxwYXRoOm51bGwsb2JqZWN0Om51bGwscGFyZW50RXhpc3RzOiExLHBhcmVudFBhdGg6bnVsbCxwYXJlbnRPYmplY3Q6bnVsbH07dHJ5e3ZhciBuPVRlLmxvb2t1cFBhdGgoZSx7cGFyZW50OiEwfSk7ci5wYXJlbnRFeGlzdHM9ITAsci5wYXJlbnRQYXRoPW4ucGF0aCxyLnBhcmVudE9iamVjdD1uLm5vZGUsci5uYW1lPWdlLmJhc2VuYW1lKGUpLG49VGUubG9va3VwUGF0aChlLHtmb2xsb3c6IXR9KSxyLmV4aXN0cz0hMCxyLnBhdGg9bi5wYXRoLHIub2JqZWN0PW4ubm9kZSxyLm5hbWU9bi5ub2RlLm5hbWUsci5pc1Jvb3Q9Ii8iPT09bi5wYXRofWNhdGNoKGUpe3IuZXJyb3I9ZS5lcnJub31yZXR1cm4gcn0sY3JlYXRlRm9sZGVyOmZ1bmN0aW9uKGUsdCxyLG4pe3ZhciBvPWdlLmpvaW4yKCJzdHJpbmciPT10eXBlb2YgZT9lOlRlLmdldFBhdGgoZSksdCksaT1UZS5nZXRNb2RlKHIsbik7cmV0dXJuIFRlLm1rZGlyKG8saSl9LGNyZWF0ZVBhdGg6ZnVuY3Rpb24oZSx0LHIsbil7ZT0ic3RyaW5nIj09dHlwZW9mIGU/ZTpUZS5nZXRQYXRoKGUpO2Zvcih2YXIgbz10LnNwbGl0KCIvIikucmV2ZXJzZSgpO28ubGVuZ3RoOyl7dmFyIGk9by5wb3AoKTtpZihpKXt2YXIgYT1nZS5qb2luMihlLGkpO3RyeXtUZS5ta2RpcihhKX1jYXRjaChlKXt9ZT1hfX1yZXR1cm4gYX0sY3JlYXRlRmlsZTpmdW5jdGlvbihlLHQscixuLG8pe3ZhciBpPWdlLmpvaW4yKCJzdHJpbmciPT10eXBlb2YgZT9lOlRlLmdldFBhdGgoZSksdCksYT1UZS5nZXRNb2RlKG4sbyk7cmV0dXJuIFRlLmNyZWF0ZShpLGEpfSxjcmVhdGVEYXRhRmlsZTpmdW5jdGlvbihlLHQscixuLG8saSl7dmFyIGE9dD9nZS5qb2luMigic3RyaW5nIj09dHlwZW9mIGU/ZTpUZS5nZXRQYXRoKGUpLHQpOmUscz1UZS5nZXRNb2RlKG4sbyksdT1UZS5jcmVhdGUoYSxzKTtpZihyKXtpZigic3RyaW5nIj09dHlwZW9mIHIpe2Zvcih2YXIgYz1uZXcgQXJyYXkoci5sZW5ndGgpLGw9MCxmPXIubGVuZ3RoO2w8ZjsrK2wpY1tsXT1yLmNoYXJDb2RlQXQobCk7cj1jfVRlLmNobW9kKHUsMTQ2fHMpO3ZhciBkPVRlLm9wZW4odSwidyIpO1RlLndyaXRlKGQsciwwLHIubGVuZ3RoLDAsaSksVGUuY2xvc2UoZCksVGUuY2htb2QodSxzKX1yZXR1cm4gdX0sY3JlYXRlRGV2aWNlOmZ1bmN0aW9uKGUsdCxyLG4pe3ZhciBvPWdlLmpvaW4yKCJzdHJpbmciPT10eXBlb2YgZT9lOlRlLmdldFBhdGgoZSksdCksaT1UZS5nZXRNb2RlKCEhciwhIW4pO1RlLmNyZWF0ZURldmljZS5tYWpvcnx8KFRlLmNyZWF0ZURldmljZS5tYWpvcj02NCk7dmFyIGE9VGUubWFrZWRldihUZS5jcmVhdGVEZXZpY2UubWFqb3IrKywwKTtyZXR1cm4gVGUucmVnaXN0ZXJEZXZpY2UoYSx7b3BlbjpmdW5jdGlvbihlKXtlLnNlZWthYmxlPSExfSxjbG9zZTpmdW5jdGlvbihlKXtuJiZuLmJ1ZmZlciYmbi5idWZmZXIubGVuZ3RoJiZuKDEwKX0scmVhZDpmdW5jdGlvbihlLHQsbixvLGkpe2Zvcih2YXIgYT0wLHM9MDtzPG87cysrKXt2YXIgdTt0cnl7dT1yKCl9Y2F0Y2goZSl7dGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRUlPKX1pZih2b2lkIDA9PT11JiYwPT09YSl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FQUdBSU4pO2lmKG51bGw9PXUpYnJlYWs7YSsrLHRbbitzXT11fXJldHVybiBhJiYoZS5ub2RlLnRpbWVzdGFtcD1EYXRlLm5vdygpKSxhfSx3cml0ZTpmdW5jdGlvbihlLHQscixvLGkpe2Zvcih2YXIgYT0wO2E8bzthKyspdHJ5e24odFtyK2FdKX1jYXRjaChlKXt0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FSU8pfXJldHVybiBvJiYoZS5ub2RlLnRpbWVzdGFtcD1EYXRlLm5vdygpKSxhfX0pLFRlLm1rZGV2KG8saSxhKX0sY3JlYXRlTGluazpmdW5jdGlvbihlLHQscixuLG8pe3ZhciBpPWdlLmpvaW4yKCJzdHJpbmciPT10eXBlb2YgZT9lOlRlLmdldFBhdGgoZSksdCk7cmV0dXJuIFRlLnN5bWxpbmsocixpKX0sZm9yY2VMb2FkRmlsZTpmdW5jdGlvbihlKXtpZihlLmlzRGV2aWNlfHxlLmlzRm9sZGVyfHxlLmxpbmt8fGUuY29udGVudHMpcmV0dXJuITA7dmFyIHQ9ITA7aWYoInVuZGVmaW5lZCIhPXR5cGVvZiBYTUxIdHRwUmVxdWVzdCl0aHJvdyBuZXcgRXJyb3IoIkxhenkgbG9hZGluZyBzaG91bGQgaGF2ZSBiZWVuIHBlcmZvcm1lZCAoY29udGVudHMgc2V0KSBpbiBjcmVhdGVMYXp5RmlsZSwgYnV0IGl0IHdhcyBub3QuIExhenkgbG9hZGluZyBvbmx5IHdvcmtzIGluIHdlYiB3b3JrZXJzLiBVc2UgLS1lbWJlZC1maWxlIG9yIC0tcHJlbG9hZC1maWxlIGluIGVtY2Mgb24gdGhlIG1haW4gdGhyZWFkLiIpO2lmKCFvLnJlYWQpdGhyb3cgbmV3IEVycm9yKCJDYW5ub3QgbG9hZCB3aXRob3V0IHJlYWQoKSBvciBYTUxIdHRwUmVxdWVzdC4iKTt0cnl7ZS5jb250ZW50cz0kdChvLnJlYWQoZS51cmwpLCEwKSxlLnVzZWRCeXRlcz1lLmNvbnRlbnRzLmxlbmd0aH1jYXRjaChlKXt0PSExfXJldHVybiB0fHx5ZShtZS5FSU8pLHR9LGNyZWF0ZUxhenlGaWxlOmZ1bmN0aW9uKGUsdCxyLG4sbyl7ZnVuY3Rpb24gaSgpe3RoaXMubGVuZ3RoS25vd249ITEsdGhpcy5jaHVua3M9W119aWYoaS5wcm90b3R5cGUuZ2V0PWZ1bmN0aW9uKGUpe2lmKCEoZT50aGlzLmxlbmd0aC0xfHxlPDApKXt2YXIgdD1lJXRoaXMuY2h1bmtTaXplLHI9ZS90aGlzLmNodW5rU2l6ZXwwO3JldHVybiB0aGlzLmdldHRlcihyKVt0XX19LGkucHJvdG90eXBlLnNldERhdGFHZXR0ZXI9ZnVuY3Rpb24oZSl7dGhpcy5nZXR0ZXI9ZX0saS5wcm90b3R5cGUuY2FjaGVMZW5ndGg9ZnVuY3Rpb24oKXt2YXIgZT1uZXcgWE1MSHR0cFJlcXVlc3Q7aWYoZS5vcGVuKCJIRUFEIixyLCExKSxlLnNlbmQobnVsbCksIShlLnN0YXR1cz49MjAwJiZlLnN0YXR1czwzMDB8fDMwND09PWUuc3RhdHVzKSl0aHJvdyBuZXcgRXJyb3IoIkNvdWxkbid0IGxvYWQgIityKyIuIFN0YXR1czogIitlLnN0YXR1cyk7dmFyIHQsbj1OdW1iZXIoZS5nZXRSZXNwb25zZUhlYWRlcigiQ29udGVudC1sZW5ndGgiKSksbz0odD1lLmdldFJlc3BvbnNlSGVhZGVyKCJBY2NlcHQtUmFuZ2VzIikpJiYiYnl0ZXMiPT09dCxpPSh0PWUuZ2V0UmVzcG9uc2VIZWFkZXIoIkNvbnRlbnQtRW5jb2RpbmciKSkmJiJnemlwIj09PXQsYT0xMDQ4NTc2O298fChhPW4pO3ZhciBzPXRoaXM7cy5zZXREYXRhR2V0dGVyKChmdW5jdGlvbihlKXt2YXIgdD1lKmEsbz0oZSsxKSphLTE7aWYobz1NYXRoLm1pbihvLG4tMSksdm9pZCAwPT09cy5jaHVua3NbZV0mJihzLmNodW5rc1tlXT1mdW5jdGlvbihlLHQpe2lmKGU+dCl0aHJvdyBuZXcgRXJyb3IoImludmFsaWQgcmFuZ2UgKCIrZSsiLCAiK3QrIikgb3Igbm8gYnl0ZXMgcmVxdWVzdGVkISIpO2lmKHQ+bi0xKXRocm93IG5ldyBFcnJvcigib25seSAiK24rIiBieXRlcyBhdmFpbGFibGUhIHByb2dyYW1tZXIgZXJyb3IhIik7dmFyIG89bmV3IFhNTEh0dHBSZXF1ZXN0O2lmKG8ub3BlbigiR0VUIixyLCExKSxuIT09YSYmby5zZXRSZXF1ZXN0SGVhZGVyKCJSYW5nZSIsImJ5dGVzPSIrZSsiLSIrdCksInVuZGVmaW5lZCIhPXR5cGVvZiBVaW50OEFycmF5JiYoby5yZXNwb25zZVR5cGU9ImFycmF5YnVmZmVyIiksby5vdmVycmlkZU1pbWVUeXBlJiZvLm92ZXJyaWRlTWltZVR5cGUoInRleHQvcGxhaW47IGNoYXJzZXQ9eC11c2VyLWRlZmluZWQiKSxvLnNlbmQobnVsbCksIShvLnN0YXR1cz49MjAwJiZvLnN0YXR1czwzMDB8fDMwND09PW8uc3RhdHVzKSl0aHJvdyBuZXcgRXJyb3IoIkNvdWxkbid0IGxvYWQgIityKyIuIFN0YXR1czogIitvLnN0YXR1cyk7cmV0dXJuIHZvaWQgMCE9PW8ucmVzcG9uc2U/bmV3IFVpbnQ4QXJyYXkoby5yZXNwb25zZXx8W10pOiR0KG8ucmVzcG9uc2VUZXh0fHwiIiwhMCl9KHQsbykpLHZvaWQgMD09PXMuY2h1bmtzW2VdKXRocm93IG5ldyBFcnJvcigiZG9YSFIgZmFpbGVkISIpO3JldHVybiBzLmNodW5rc1tlXX0pKSwhaSYmbnx8KGE9bj0xLG49dGhpcy5nZXR0ZXIoMCkubGVuZ3RoLGE9bixjb25zb2xlLmxvZygiTGF6eUZpbGVzIG9uIGd6aXAgZm9yY2VzIGRvd25sb2FkIG9mIHRoZSB3aG9sZSBmaWxlIHdoZW4gbGVuZ3RoIGlzIGFjY2Vzc2VkIikpLHRoaXMuX2xlbmd0aD1uLHRoaXMuX2NodW5rU2l6ZT1hLHRoaXMubGVuZ3RoS25vd249ITB9LCJ1bmRlZmluZWQiIT10eXBlb2YgWE1MSHR0cFJlcXVlc3Qpe2lmKCFjKXRocm93IkNhbm5vdCBkbyBzeW5jaHJvbm91cyBiaW5hcnkgWEhScyBvdXRzaWRlIHdlYndvcmtlcnMgaW4gbW9kZXJuIGJyb3dzZXJzLiBVc2UgLS1lbWJlZC1maWxlIG9yIC0tcHJlbG9hZC1maWxlIGluIGVtY2MiO3ZhciBhPW5ldyBpO09iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGEse2xlbmd0aDp7Z2V0OmZ1bmN0aW9uKCl7cmV0dXJuIHRoaXMubGVuZ3RoS25vd258fHRoaXMuY2FjaGVMZW5ndGgoKSx0aGlzLl9sZW5ndGh9fSxjaHVua1NpemU6e2dldDpmdW5jdGlvbigpe3JldHVybiB0aGlzLmxlbmd0aEtub3dufHx0aGlzLmNhY2hlTGVuZ3RoKCksdGhpcy5fY2h1bmtTaXplfX19KTt2YXIgcz17aXNEZXZpY2U6ITEsY29udGVudHM6YX19ZWxzZSBzPXtpc0RldmljZTohMSx1cmw6cn07dmFyIHU9VGUuY3JlYXRlRmlsZShlLHQscyxuLG8pO3MuY29udGVudHM/dS5jb250ZW50cz1zLmNvbnRlbnRzOnMudXJsJiYodS5jb250ZW50cz1udWxsLHUudXJsPXMudXJsKSxPYmplY3QuZGVmaW5lUHJvcGVydGllcyh1LHt1c2VkQnl0ZXM6e2dldDpmdW5jdGlvbigpe3JldHVybiB0aGlzLmNvbnRlbnRzLmxlbmd0aH19fSk7dmFyIGw9e307cmV0dXJuIE9iamVjdC5rZXlzKHUuc3RyZWFtX29wcykuZm9yRWFjaCgoZnVuY3Rpb24oZSl7dmFyIHQ9dS5zdHJlYW1fb3BzW2VdO2xbZV09ZnVuY3Rpb24oKXtpZighVGUuZm9yY2VMb2FkRmlsZSh1KSl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FSU8pO3JldHVybiB0LmFwcGx5KG51bGwsYXJndW1lbnRzKX19KSksbC5yZWFkPWZ1bmN0aW9uKGUsdCxyLG4sbyl7aWYoIVRlLmZvcmNlTG9hZEZpbGUodSkpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRUlPKTt2YXIgaT1lLm5vZGUuY29udGVudHM7aWYobz49aS5sZW5ndGgpcmV0dXJuIDA7dmFyIGE9TWF0aC5taW4oaS5sZW5ndGgtbyxuKTtpZih5KGE+PTApLGkuc2xpY2UpZm9yKHZhciBzPTA7czxhO3MrKyl0W3Irc109aVtvK3NdO2Vsc2UgZm9yKHM9MDtzPGE7cysrKXRbcitzXT1pLmdldChvK3MpO3JldHVybiBhfSx1LnN0cmVhbV9vcHM9bCx1fSxjcmVhdGVQcmVsb2FkZWRGaWxlOmZ1bmN0aW9uKGUsdCxyLG4saSxhLHMsdSxjLGwpe0Jyb3dzZXIuaW5pdCgpO3ZhciBmPXQ/Z2UucmVzb2x2ZShnZS5qb2luMihlLHQpKTplO2Z1bmN0aW9uIGQocil7ZnVuY3Rpb24gZChyKXtsJiZsKCksdXx8VGUuY3JlYXRlRGF0YUZpbGUoZSx0LHIsbixpLGMpLGEmJmEoKSxsZSgpfXZhciBoPSExO28ucHJlbG9hZFBsdWdpbnMuZm9yRWFjaCgoZnVuY3Rpb24oZSl7aHx8ZS5jYW5IYW5kbGUoZikmJihlLmhhbmRsZShyLGYsZCwoZnVuY3Rpb24oKXtzJiZzKCksbGUoKX0pKSxoPSEwKX0pKSxofHxkKHIpfWNlKCksInN0cmluZyI9PXR5cGVvZiByP0Jyb3dzZXIuYXN5bmNMb2FkKHIsKGZ1bmN0aW9uKGUpe2QoZSl9KSxzKTpkKHIpfSxpbmRleGVkREI6ZnVuY3Rpb24oKXtyZXR1cm4gd2luZG93LmluZGV4ZWREQnx8d2luZG93Lm1vekluZGV4ZWREQnx8d2luZG93LndlYmtpdEluZGV4ZWREQnx8d2luZG93Lm1zSW5kZXhlZERCfSxEQl9OQU1FOmZ1bmN0aW9uKCl7cmV0dXJuIkVNX0ZTXyIrd2luZG93LmxvY2F0aW9uLnBhdGhuYW1lfSxEQl9WRVJTSU9OOjIwLERCX1NUT1JFX05BTUU6IkZJTEVfREFUQSIsc2F2ZUZpbGVzVG9EQjpmdW5jdGlvbihlLHQscil7dD10fHxmdW5jdGlvbigpe30scj1yfHxmdW5jdGlvbigpe307dmFyIG49VGUuaW5kZXhlZERCKCk7dHJ5e3ZhciBvPW4ub3BlbihUZS5EQl9OQU1FKCksVGUuREJfVkVSU0lPTil9Y2F0Y2goZSl7cmV0dXJuIHIoZSl9by5vbnVwZ3JhZGVuZWVkZWQ9ZnVuY3Rpb24oKXtjb25zb2xlLmxvZygiY3JlYXRpbmcgZGIiKSxvLnJlc3VsdC5jcmVhdGVPYmplY3RTdG9yZShUZS5EQl9TVE9SRV9OQU1FKX0sby5vbnN1Y2Nlc3M9ZnVuY3Rpb24oKXt2YXIgbj1vLnJlc3VsdC50cmFuc2FjdGlvbihbVGUuREJfU1RPUkVfTkFNRV0sInJlYWR3cml0ZSIpLGk9bi5vYmplY3RTdG9yZShUZS5EQl9TVE9SRV9OQU1FKSxhPTAscz0wLHU9ZS5sZW5ndGg7ZnVuY3Rpb24gYygpezA9PXM/dCgpOnIoKX1lLmZvckVhY2goKGZ1bmN0aW9uKGUpe3ZhciB0PWkucHV0KFRlLmFuYWx5emVQYXRoKGUpLm9iamVjdC5jb250ZW50cyxlKTt0Lm9uc3VjY2Vzcz1mdW5jdGlvbigpeysrYStzPT11JiZjKCl9LHQub25lcnJvcj1mdW5jdGlvbigpe3MrKyxhK3M9PXUmJmMoKX19KSksbi5vbmVycm9yPXJ9LG8ub25lcnJvcj1yfSxsb2FkRmlsZXNGcm9tREI6ZnVuY3Rpb24oZSx0LHIpe3Q9dHx8ZnVuY3Rpb24oKXt9LHI9cnx8ZnVuY3Rpb24oKXt9O3ZhciBuPVRlLmluZGV4ZWREQigpO3RyeXt2YXIgbz1uLm9wZW4oVGUuREJfTkFNRSgpLFRlLkRCX1ZFUlNJT04pfWNhdGNoKGUpe3JldHVybiByKGUpfW8ub251cGdyYWRlbmVlZGVkPXIsby5vbnN1Y2Nlc3M9ZnVuY3Rpb24oKXt2YXIgbj1vLnJlc3VsdDt0cnl7dmFyIGk9bi50cmFuc2FjdGlvbihbVGUuREJfU1RPUkVfTkFNRV0sInJlYWRvbmx5Iil9Y2F0Y2goZSl7cmV0dXJuIHZvaWQgcihlKX12YXIgYT1pLm9iamVjdFN0b3JlKFRlLkRCX1NUT1JFX05BTUUpLHM9MCx1PTAsYz1lLmxlbmd0aDtmdW5jdGlvbiBsKCl7MD09dT90KCk6cigpfWUuZm9yRWFjaCgoZnVuY3Rpb24oZSl7dmFyIHQ9YS5nZXQoZSk7dC5vbnN1Y2Nlc3M9ZnVuY3Rpb24oKXtUZS5hbmFseXplUGF0aChlKS5leGlzdHMmJlRlLnVubGluayhlKSxUZS5jcmVhdGVEYXRhRmlsZShnZS5kaXJuYW1lKGUpLGdlLmJhc2VuYW1lKGUpLHQucmVzdWx0LCEwLCEwLCEwKSwrK3MrdT09YyYmbCgpfSx0Lm9uZXJyb3I9ZnVuY3Rpb24oKXt1Kysscyt1PT1jJiZsKCl9fSkpLGkub25lcnJvcj1yfSxvLm9uZXJyb3I9cn19LFNlPXtERUZBVUxUX1BPTExNQVNLOjUsbWFwcGluZ3M6e30sdW1hc2s6NTExLGNhbGN1bGF0ZUF0OmZ1bmN0aW9uKGUsdCl7aWYoIi8iIT09dFswXSl7dmFyIHI7aWYoLTEwMD09PWUpcj1UZS5jd2QoKTtlbHNle3ZhciBuPVRlLmdldFN0cmVhbShlKTtpZighbil0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FQkFERik7cj1uLnBhdGh9dD1nZS5qb2luMihyLHQpfXJldHVybiB0fSxkb1N0YXQ6ZnVuY3Rpb24oZSx0LHIpe3RyeXt2YXIgbj1lKHQpfWNhdGNoKGUpe2lmKGUmJmUubm9kZSYmZ2Uubm9ybWFsaXplKHQpIT09Z2Uubm9ybWFsaXplKFRlLmdldFBhdGgoZS5ub2RlKSkpcmV0dXJuLW1lLkVOT1RESVI7dGhyb3cgZX1yZXR1cm4gRltyPj4yXT1uLmRldixGW3IrND4+Ml09MCxGW3IrOD4+Ml09bi5pbm8sRltyKzEyPj4yXT1uLm1vZGUsRltyKzE2Pj4yXT1uLm5saW5rLEZbcisyMD4+Ml09bi51aWQsRltyKzI0Pj4yXT1uLmdpZCxGW3IrMjg+PjJdPW4ucmRldixGW3IrMzI+PjJdPTAsRltyKzM2Pj4yXT1uLnNpemUsRltyKzQwPj4yXT00MDk2LEZbcis0ND4+Ml09bi5ibG9ja3MsRltyKzQ4Pj4yXT1uLmF0aW1lLmdldFRpbWUoKS8xZTN8MCxGW3IrNTI+PjJdPTAsRltyKzU2Pj4yXT1uLm10aW1lLmdldFRpbWUoKS8xZTN8MCxGW3IrNjA+PjJdPTAsRltyKzY0Pj4yXT1uLmN0aW1lLmdldFRpbWUoKS8xZTN8MCxGW3IrNjg+PjJdPTAsRltyKzcyPj4yXT1uLmlubywwfSxkb01zeW5jOmZ1bmN0aW9uKGUsdCxyLG4pe3ZhciBvPW5ldyBVaW50OEFycmF5KE8uc3ViYXJyYXkoZSxlK3IpKTtUZS5tc3luYyh0LG8sMCxyLG4pfSxkb01rZGlyOmZ1bmN0aW9uKGUsdCl7cmV0dXJuIi8iPT09KGU9Z2Uubm9ybWFsaXplKGUpKVtlLmxlbmd0aC0xXSYmKGU9ZS5zdWJzdHIoMCxlLmxlbmd0aC0xKSksVGUubWtkaXIoZSx0LDApLDB9LGRvTWtub2Q6ZnVuY3Rpb24oZSx0LHIpe3N3aXRjaCg2MTQ0MCZ0KXtjYXNlIDMyNzY4OmNhc2UgODE5MjpjYXNlIDI0NTc2OmNhc2UgNDA5NjpjYXNlIDQ5MTUyOmJyZWFrO2RlZmF1bHQ6cmV0dXJuLW1lLkVJTlZBTH1yZXR1cm4gVGUubWtub2QoZSx0LHIpLDB9LGRvUmVhZGxpbms6ZnVuY3Rpb24oZSx0LHIpe2lmKHI8PTApcmV0dXJuLW1lLkVJTlZBTDt2YXIgbj1UZS5yZWFkbGluayhlKSxvPU1hdGgubWluKHIsUyhuKSksaT1SW3Qrb107cmV0dXJuIFQobix0LHIrMSksUlt0K29dPWksb30sZG9BY2Nlc3M6ZnVuY3Rpb24oZSx0KXtpZigtOCZ0KXJldHVybi1tZS5FSU5WQUw7dmFyIHI7cj1UZS5sb29rdXBQYXRoKGUse2ZvbGxvdzohMH0pLm5vZGU7dmFyIG49IiI7cmV0dXJuIDQmdCYmKG4rPSJyIiksMiZ0JiYobis9InciKSwxJnQmJihuKz0ieCIpLG4mJlRlLm5vZGVQZXJtaXNzaW9ucyhyLG4pPy1tZS5FQUNDRVM6MH0sZG9EdXA6ZnVuY3Rpb24oZSx0LHIpe3ZhciBuPVRlLmdldFN0cmVhbShyKTtyZXR1cm4gbiYmVGUuY2xvc2UobiksVGUub3BlbihlLHQsMCxyLHIpLmZkfSxkb1JlYWR2OmZ1bmN0aW9uKGUsdCxyLG4pe2Zvcih2YXIgbz0wLGk9MDtpPHI7aSsrKXt2YXIgYT1GW3QrOCppPj4yXSxzPUZbdCsoOCppKzQpPj4yXSx1PVRlLnJlYWQoZSxSLGEscyxuKTtpZih1PDApcmV0dXJuLTE7aWYobys9dSx1PHMpYnJlYWt9cmV0dXJuIG99LGRvV3JpdGV2OmZ1bmN0aW9uKGUsdCxyLG4pe2Zvcih2YXIgbz0wLGk9MDtpPHI7aSsrKXt2YXIgYT1GW3QrOCppPj4yXSxzPUZbdCsoOCppKzQpPj4yXSx1PVRlLndyaXRlKGUsUixhLHMsbik7aWYodTwwKXJldHVybi0xO28rPXV9cmV0dXJuIG99LHZhcmFyZ3M6MCxnZXQ6ZnVuY3Rpb24oZSl7cmV0dXJuIFNlLnZhcmFyZ3MrPTQsRltTZS52YXJhcmdzLTQ+PjJdfSxnZXRTdHI6ZnVuY3Rpb24oKXtyZXR1cm4gdihTZS5nZXQoKSl9LGdldFN0cmVhbUZyb21GRDpmdW5jdGlvbigpe3ZhciBlPVRlLmdldFN0cmVhbShTZS5nZXQoKSk7aWYoIWUpdGhyb3cgbmV3IFRlLkVycm5vRXJyb3IobWUuRUJBREYpO3JldHVybiBlfSxnZXRTb2NrZXRGcm9tRkQ6ZnVuY3Rpb24oKXt2YXIgZT1TT0NLRlMuZ2V0U29ja2V0KFNlLmdldCgpKTtpZighZSl0aHJvdyBuZXcgVGUuRXJybm9FcnJvcihtZS5FQkFERik7cmV0dXJuIGV9LGdldFNvY2tldEFkZHJlc3M6ZnVuY3Rpb24oZSl7dmFyIHQ9U2UuZ2V0KCkscj1TZS5nZXQoKTtpZihlJiYwPT09dClyZXR1cm4gbnVsbDt2YXIgbj1fX3JlYWRfc29ja2FkZHIodCxyKTtpZihuLmVycm5vKXRocm93IG5ldyBUZS5FcnJub0Vycm9yKG4uZXJybm8pO3JldHVybiBuLmFkZHI9RE5TLmxvb2t1cF9hZGRyKG4uYWRkcil8fG4uYWRkcixufSxnZXQ2NDpmdW5jdGlvbigpe3ZhciBlPVNlLmdldCgpLHQ9U2UuZ2V0KCk7cmV0dXJuIHkoZT49MD8wPT09dDotMT09PXQpLGV9LGdldFplcm86ZnVuY3Rpb24oKXt5KDA9PT1TZS5nZXQoKSl9fTt2YXIga2U9NDI7dmFyIFBlPXt9O2Z1bmN0aW9uIERlKGUpe2Zvcig7ZS5sZW5ndGg7KXt2YXIgdD1lLnBvcCgpO2UucG9wKCkodCl9fWZ1bmN0aW9uIFJlKGUpe3JldHVybiB0aGlzLmZyb21XaXJlVHlwZShNW2U+PjJdKX12YXIgT2U9e30sQ2U9e30sTmU9e307ZnVuY3Rpb24gRmUoZSl7aWYodm9pZCAwPT09ZSlyZXR1cm4iX3Vua25vd24iO3ZhciB0PShlPWUucmVwbGFjZSgvW15hLXpBLVowLTlfXS9nLCIkIikpLmNoYXJDb2RlQXQoMCk7cmV0dXJuIHQ+PTQ4JiZ0PD01Nz8iXyIrZTplfWZ1bmN0aW9uIE1lKGUsdCl7cmV0dXJuIGU9RmUoZSksbmV3IEZ1bmN0aW9uKCJib2R5IiwicmV0dXJuIGZ1bmN0aW9uICIrZSsnKCkge1xuICAgICJ1c2Ugc3RyaWN0IjsgICAgcmV0dXJuIGJvZHkuYXBwbHkodGhpcywgYXJndW1lbnRzKTtcbn07XG4nKSh0KX1mdW5jdGlvbiBJZShlLHQpe3ZhciByPU1lKHQsKGZ1bmN0aW9uKGUpe3RoaXMubmFtZT10LHRoaXMubWVzc2FnZT1lO3ZhciByPW5ldyBFcnJvcihlKS5zdGFjazt2b2lkIDAhPT1yJiYodGhpcy5zdGFjaz10aGlzLnRvU3RyaW5nKCkrIlxuIityLnJlcGxhY2UoL15FcnJvcig6W15cbl0qKT9cbi8sIiIpKX0pKTtyZXR1cm4gci5wcm90b3R5cGU9T2JqZWN0LmNyZWF0ZShlLnByb3RvdHlwZSksci5wcm90b3R5cGUuY29uc3RydWN0b3I9cixyLnByb3RvdHlwZS50b1N0cmluZz1mdW5jdGlvbigpe3JldHVybiB2b2lkIDA9PT10aGlzLm1lc3NhZ2U/dGhpcy5uYW1lOnRoaXMubmFtZSsiOiAiK3RoaXMubWVzc2FnZX0scn12YXIgQmU9dm9pZCAwO2Z1bmN0aW9uIExlKGUpe3Rocm93IG5ldyBCZShlKX1mdW5jdGlvbiB4ZShlLHQscil7ZnVuY3Rpb24gbih0KXt2YXIgbj1yKHQpO24ubGVuZ3RoIT09ZS5sZW5ndGgmJkxlKCJNaXNtYXRjaGVkIHR5cGUgY29udmVydGVyIGNvdW50Iik7Zm9yKHZhciBvPTA7bzxlLmxlbmd0aDsrK28pWWUoZVtvXSxuW29dKX1lLmZvckVhY2goKGZ1bmN0aW9uKGUpe05lW2VdPXR9KSk7dmFyIG89bmV3IEFycmF5KHQubGVuZ3RoKSxpPVtdLGE9MDt0LmZvckVhY2goKGZ1bmN0aW9uKGUsdCl7Q2UuaGFzT3duUHJvcGVydHkoZSk/b1t0XT1DZVtlXTooaS5wdXNoKGUpLE9lLmhhc093blByb3BlcnR5KGUpfHwoT2VbZV09W10pLE9lW2VdLnB1c2goKGZ1bmN0aW9uKCl7b1t0XT1DZVtlXSwrK2E9PT1pLmxlbmd0aCYmbihvKX0pKSl9KSksMD09PWkubGVuZ3RoJiZuKG8pfWZ1bmN0aW9uIGplKGUpe3N3aXRjaChlKXtjYXNlIDE6cmV0dXJuIDA7Y2FzZSAyOnJldHVybiAxO2Nhc2UgNDpyZXR1cm4gMjtjYXNlIDg6cmV0dXJuIDM7ZGVmYXVsdDp0aHJvdyBuZXcgVHlwZUVycm9yKCJVbmtub3duIHR5cGUgc2l6ZTogIitlKX19dmFyIFVlPXZvaWQgMDtmdW5jdGlvbiB6ZShlKXtmb3IodmFyIHQ9IiIscj1lO09bcl07KXQrPVVlW09bcisrXV07cmV0dXJuIHR9dmFyICRlPXZvaWQgMDtmdW5jdGlvbiBXZShlKXt0aHJvdyBuZXcgJGUoZSl9ZnVuY3Rpb24gWWUoZSx0LHIpe2lmKHI9cnx8e30sISgiYXJnUGFja0FkdmFuY2UiaW4gdCkpdGhyb3cgbmV3IFR5cGVFcnJvcigicmVnaXN0ZXJUeXBlIHJlZ2lzdGVyZWRJbnN0YW5jZSByZXF1aXJlcyBhcmdQYWNrQWR2YW5jZSIpO3ZhciBuPXQubmFtZTtpZihlfHxXZSgndHlwZSAiJytuKyciIG11c3QgaGF2ZSBhIHBvc2l0aXZlIGludGVnZXIgdHlwZWlkIHBvaW50ZXInKSxDZS5oYXNPd25Qcm9wZXJ0eShlKSl7aWYoci5pZ25vcmVEdXBsaWNhdGVSZWdpc3RyYXRpb25zKXJldHVybjtXZSgiQ2Fubm90IHJlZ2lzdGVyIHR5cGUgJyIrbisiJyB0d2ljZSIpfWlmKENlW2VdPXQsZGVsZXRlIE5lW2VdLE9lLmhhc093blByb3BlcnR5KGUpKXt2YXIgbz1PZVtlXTtkZWxldGUgT2VbZV0sby5mb3JFYWNoKChmdW5jdGlvbihlKXtlKCl9KSl9fWZ1bmN0aW9uIFZlKGUpe2lmKCEodGhpcyBpbnN0YW5jZW9mIGV0KSlyZXR1cm4hMTtpZighKGUgaW5zdGFuY2VvZiBldCkpcmV0dXJuITE7Zm9yKHZhciB0PXRoaXMuJCQucHRyVHlwZS5yZWdpc3RlcmVkQ2xhc3Mscj10aGlzLiQkLnB0cixuPWUuJCQucHRyVHlwZS5yZWdpc3RlcmVkQ2xhc3Msbz1lLiQkLnB0cjt0LmJhc2VDbGFzczspcj10LnVwY2FzdChyKSx0PXQuYmFzZUNsYXNzO2Zvcig7bi5iYXNlQ2xhc3M7KW89bi51cGNhc3Qobyksbj1uLmJhc2VDbGFzcztyZXR1cm4gdD09PW4mJnI9PT1vfWZ1bmN0aW9uIEhlKGUpe1dlKGUuJCQucHRyVHlwZS5yZWdpc3RlcmVkQ2xhc3MubmFtZSsiIGluc3RhbmNlIGFscmVhZHkgZGVsZXRlZCIpfWZ1bmN0aW9uIEdlKCl7aWYodGhpcy4kJC5wdHJ8fEhlKHRoaXMpLHRoaXMuJCQucHJlc2VydmVQb2ludGVyT25EZWxldGUpcmV0dXJuIHRoaXMuJCQuY291bnQudmFsdWUrPTEsdGhpczt2YXIgZSx0PU9iamVjdC5jcmVhdGUoT2JqZWN0LmdldFByb3RvdHlwZU9mKHRoaXMpLHskJDp7dmFsdWU6KGU9dGhpcy4kJCx7Y291bnQ6ZS5jb3VudCxkZWxldGVTY2hlZHVsZWQ6ZS5kZWxldGVTY2hlZHVsZWQscHJlc2VydmVQb2ludGVyT25EZWxldGU6ZS5wcmVzZXJ2ZVBvaW50ZXJPbkRlbGV0ZSxwdHI6ZS5wdHIscHRyVHlwZTplLnB0clR5cGUsc21hcnRQdHI6ZS5zbWFydFB0cixzbWFydFB0clR5cGU6ZS5zbWFydFB0clR5cGV9KX19KTtyZXR1cm4gdC4kJC5jb3VudC52YWx1ZSs9MSx0LiQkLmRlbGV0ZVNjaGVkdWxlZD0hMSx0fWZ1bmN0aW9uIHFlKCl7dmFyIGU7dGhpcy4kJC5wdHJ8fEhlKHRoaXMpLHRoaXMuJCQuZGVsZXRlU2NoZWR1bGVkJiYhdGhpcy4kJC5wcmVzZXJ2ZVBvaW50ZXJPbkRlbGV0ZSYmV2UoIk9iamVjdCBhbHJlYWR5IHNjaGVkdWxlZCBmb3IgZGVsZXRpb24iKSx0aGlzLiQkLmNvdW50LnZhbHVlLT0xLDA9PT10aGlzLiQkLmNvdW50LnZhbHVlJiYoKGU9dGhpcy4kJCkuc21hcnRQdHI/ZS5zbWFydFB0clR5cGUucmF3RGVzdHJ1Y3RvcihlLnNtYXJ0UHRyKTplLnB0clR5cGUucmVnaXN0ZXJlZENsYXNzLnJhd0Rlc3RydWN0b3IoZS5wdHIpKSx0aGlzLiQkLnByZXNlcnZlUG9pbnRlck9uRGVsZXRlfHwodGhpcy4kJC5zbWFydFB0cj12b2lkIDAsdGhpcy4kJC5wdHI9dm9pZCAwKX1mdW5jdGlvbiBYZSgpe3JldHVybiF0aGlzLiQkLnB0cn12YXIgS2U9dm9pZCAwLEplPVtdO2Z1bmN0aW9uIFplKCl7Zm9yKDtKZS5sZW5ndGg7KXt2YXIgZT1KZS5wb3AoKTtlLiQkLmRlbGV0ZVNjaGVkdWxlZD0hMSxlLmRlbGV0ZSgpfX1mdW5jdGlvbiBRZSgpe3JldHVybiB0aGlzLiQkLnB0cnx8SGUodGhpcyksdGhpcy4kJC5kZWxldGVTY2hlZHVsZWQmJiF0aGlzLiQkLnByZXNlcnZlUG9pbnRlck9uRGVsZXRlJiZXZSgiT2JqZWN0IGFscmVhZHkgc2NoZWR1bGVkIGZvciBkZWxldGlvbiIpLEplLnB1c2godGhpcyksMT09PUplLmxlbmd0aCYmS2UmJktlKFplKSx0aGlzLiQkLmRlbGV0ZVNjaGVkdWxlZD0hMCx0aGlzfWZ1bmN0aW9uIGV0KCl7fXZhciB0dD17fTtmdW5jdGlvbiBydChlLHQscil7aWYodm9pZCAwPT09ZVt0XS5vdmVybG9hZFRhYmxlKXt2YXIgbj1lW3RdO2VbdF09ZnVuY3Rpb24oKXtyZXR1cm4gZVt0XS5vdmVybG9hZFRhYmxlLmhhc093blByb3BlcnR5KGFyZ3VtZW50cy5sZW5ndGgpfHxXZSgiRnVuY3Rpb24gJyIrcisiJyBjYWxsZWQgd2l0aCBhbiBpbnZhbGlkIG51bWJlciBvZiBhcmd1bWVudHMgKCIrYXJndW1lbnRzLmxlbmd0aCsiKSAtIGV4cGVjdHMgb25lIG9mICgiK2VbdF0ub3ZlcmxvYWRUYWJsZSsiKSEiKSxlW3RdLm92ZXJsb2FkVGFibGVbYXJndW1lbnRzLmxlbmd0aF0uYXBwbHkodGhpcyxhcmd1bWVudHMpfSxlW3RdLm92ZXJsb2FkVGFibGU9W10sZVt0XS5vdmVybG9hZFRhYmxlW24uYXJnQ291bnRdPW59fWZ1bmN0aW9uIG50KGUsdCxyLG4sbyxpLGEscyl7dGhpcy5uYW1lPWUsdGhpcy5jb25zdHJ1Y3Rvcj10LHRoaXMuaW5zdGFuY2VQcm90b3R5cGU9cix0aGlzLnJhd0Rlc3RydWN0b3I9bix0aGlzLmJhc2VDbGFzcz1vLHRoaXMuZ2V0QWN0dWFsVHlwZT1pLHRoaXMudXBjYXN0PWEsdGhpcy5kb3duY2FzdD1zLHRoaXMucHVyZVZpcnR1YWxGdW5jdGlvbnM9W119ZnVuY3Rpb24gb3QoZSx0LHIpe2Zvcig7dCE9PXI7KXQudXBjYXN0fHxXZSgiRXhwZWN0ZWQgbnVsbCBvciBpbnN0YW5jZSBvZiAiK3IubmFtZSsiLCBnb3QgYW4gaW5zdGFuY2Ugb2YgIit0Lm5hbWUpLGU9dC51cGNhc3QoZSksdD10LmJhc2VDbGFzcztyZXR1cm4gZX1mdW5jdGlvbiBpdChlLHQpe2lmKG51bGw9PT10KXJldHVybiB0aGlzLmlzUmVmZXJlbmNlJiZXZSgibnVsbCBpcyBub3QgYSB2YWxpZCAiK3RoaXMubmFtZSksMDt0LiQkfHxXZSgnQ2Fubm90IHBhc3MgIicrT3QodCkrJyIgYXMgYSAnK3RoaXMubmFtZSksdC4kJC5wdHJ8fFdlKCJDYW5ub3QgcGFzcyBkZWxldGVkIG9iamVjdCBhcyBhIHBvaW50ZXIgb2YgdHlwZSAiK3RoaXMubmFtZSk7dmFyIHI9dC4kJC5wdHJUeXBlLnJlZ2lzdGVyZWRDbGFzcztyZXR1cm4gb3QodC4kJC5wdHIscix0aGlzLnJlZ2lzdGVyZWRDbGFzcyl9ZnVuY3Rpb24gYXQoZSx0KXt2YXIgcjtpZihudWxsPT09dClyZXR1cm4gdGhpcy5pc1JlZmVyZW5jZSYmV2UoIm51bGwgaXMgbm90IGEgdmFsaWQgIit0aGlzLm5hbWUpLHRoaXMuaXNTbWFydFBvaW50ZXI/KHI9dGhpcy5yYXdDb25zdHJ1Y3RvcigpLG51bGwhPT1lJiZlLnB1c2godGhpcy5yYXdEZXN0cnVjdG9yLHIpLHIpOjA7dC4kJHx8V2UoJ0Nhbm5vdCBwYXNzICInK090KHQpKyciIGFzIGEgJyt0aGlzLm5hbWUpLHQuJCQucHRyfHxXZSgiQ2Fubm90IHBhc3MgZGVsZXRlZCBvYmplY3QgYXMgYSBwb2ludGVyIG9mIHR5cGUgIit0aGlzLm5hbWUpLCF0aGlzLmlzQ29uc3QmJnQuJCQucHRyVHlwZS5pc0NvbnN0JiZXZSgiQ2Fubm90IGNvbnZlcnQgYXJndW1lbnQgb2YgdHlwZSAiKyh0LiQkLnNtYXJ0UHRyVHlwZT90LiQkLnNtYXJ0UHRyVHlwZS5uYW1lOnQuJCQucHRyVHlwZS5uYW1lKSsiIHRvIHBhcmFtZXRlciB0eXBlICIrdGhpcy5uYW1lKTt2YXIgbj10LiQkLnB0clR5cGUucmVnaXN0ZXJlZENsYXNzO2lmKHI9b3QodC4kJC5wdHIsbix0aGlzLnJlZ2lzdGVyZWRDbGFzcyksdGhpcy5pc1NtYXJ0UG9pbnRlcilzd2l0Y2godm9pZCAwPT09dC4kJC5zbWFydFB0ciYmV2UoIlBhc3NpbmcgcmF3IHBvaW50ZXIgdG8gc21hcnQgcG9pbnRlciBpcyBpbGxlZ2FsIiksdGhpcy5zaGFyaW5nUG9saWN5KXtjYXNlIDA6dC4kJC5zbWFydFB0clR5cGU9PT10aGlzP3I9dC4kJC5zbWFydFB0cjpXZSgiQ2Fubm90IGNvbnZlcnQgYXJndW1lbnQgb2YgdHlwZSAiKyh0LiQkLnNtYXJ0UHRyVHlwZT90LiQkLnNtYXJ0UHRyVHlwZS5uYW1lOnQuJCQucHRyVHlwZS5uYW1lKSsiIHRvIHBhcmFtZXRlciB0eXBlICIrdGhpcy5uYW1lKTticmVhaztjYXNlIDE6cj10LiQkLnNtYXJ0UHRyO2JyZWFrO2Nhc2UgMjppZih0LiQkLnNtYXJ0UHRyVHlwZT09PXRoaXMpcj10LiQkLnNtYXJ0UHRyO2Vsc2V7dmFyIG89dC5jbG9uZSgpO3I9dGhpcy5yYXdTaGFyZShyLFJ0KChmdW5jdGlvbigpe28uZGVsZXRlKCl9KSkpLG51bGwhPT1lJiZlLnB1c2godGhpcy5yYXdEZXN0cnVjdG9yLHIpfWJyZWFrO2RlZmF1bHQ6V2UoIlVuc3VwcG9ydGluZyBzaGFyaW5nIHBvbGljeSIpfXJldHVybiByfWZ1bmN0aW9uIHN0KGUsdCl7aWYobnVsbD09PXQpcmV0dXJuIHRoaXMuaXNSZWZlcmVuY2UmJldlKCJudWxsIGlzIG5vdCBhIHZhbGlkICIrdGhpcy5uYW1lKSwwO3QuJCR8fFdlKCdDYW5ub3QgcGFzcyAiJytPdCh0KSsnIiBhcyBhICcrdGhpcy5uYW1lKSx0LiQkLnB0cnx8V2UoIkNhbm5vdCBwYXNzIGRlbGV0ZWQgb2JqZWN0IGFzIGEgcG9pbnRlciBvZiB0eXBlICIrdGhpcy5uYW1lKSx0LiQkLnB0clR5cGUuaXNDb25zdCYmV2UoIkNhbm5vdCBjb252ZXJ0IGFyZ3VtZW50IG9mIHR5cGUgIit0LiQkLnB0clR5cGUubmFtZSsiIHRvIHBhcmFtZXRlciB0eXBlICIrdGhpcy5uYW1lKTt2YXIgcj10LiQkLnB0clR5cGUucmVnaXN0ZXJlZENsYXNzO3JldHVybiBvdCh0LiQkLnB0cixyLHRoaXMucmVnaXN0ZXJlZENsYXNzKX1mdW5jdGlvbiB1dChlKXtyZXR1cm4gdGhpcy5yYXdHZXRQb2ludGVlJiYoZT10aGlzLnJhd0dldFBvaW50ZWUoZSkpLGV9ZnVuY3Rpb24gY3QoZSl7dGhpcy5yYXdEZXN0cnVjdG9yJiZ0aGlzLnJhd0Rlc3RydWN0b3IoZSl9ZnVuY3Rpb24gbHQoZSl7bnVsbCE9PWUmJmUuZGVsZXRlKCl9ZnVuY3Rpb24gZnQoKXtyZXR1cm4gT2JqZWN0LmtleXMocHQpLmxlbmd0aH1mdW5jdGlvbiBkdCgpe3ZhciBlPVtdO2Zvcih2YXIgdCBpbiBwdClwdC5oYXNPd25Qcm9wZXJ0eSh0KSYmZS5wdXNoKHB0W3RdKTtyZXR1cm4gZX1mdW5jdGlvbiBodChlKXtLZT1lLEplLmxlbmd0aCYmS2UmJktlKFplKX12YXIgcHQ9e307ZnVuY3Rpb24gbXQoZSx0KXtyZXR1cm4gdD1mdW5jdGlvbihlLHQpe2Zvcih2b2lkIDA9PT10JiZXZSgicHRyIHNob3VsZCBub3QgYmUgdW5kZWZpbmVkIik7ZS5iYXNlQ2xhc3M7KXQ9ZS51cGNhc3QodCksZT1lLmJhc2VDbGFzcztyZXR1cm4gdH0oZSx0KSxwdFt0XX1mdW5jdGlvbiB5dChlLHQpe3JldHVybiB0LnB0clR5cGUmJnQucHRyfHxMZSgibWFrZUNsYXNzSGFuZGxlIHJlcXVpcmVzIHB0ciBhbmQgcHRyVHlwZSIpLCEhdC5zbWFydFB0clR5cGUhPT0hIXQuc21hcnRQdHImJkxlKCJCb3RoIHNtYXJ0UHRyVHlwZSBhbmQgc21hcnRQdHIgbXVzdCBiZSBzcGVjaWZpZWQiKSx0LmNvdW50PXt2YWx1ZToxfSxPYmplY3QuY3JlYXRlKGUseyQkOnt2YWx1ZTp0fX0pfWZ1bmN0aW9uIEV0KGUpe3ZhciB0PXRoaXMuZ2V0UG9pbnRlZShlKTtpZighdClyZXR1cm4gdGhpcy5kZXN0cnVjdG9yKGUpLG51bGw7dmFyIHI9bXQodGhpcy5yZWdpc3RlcmVkQ2xhc3MsdCk7aWYodm9pZCAwIT09cil7aWYoMD09PXIuJCQuY291bnQudmFsdWUpcmV0dXJuIHIuJCQucHRyPXQsci4kJC5zbWFydFB0cj1lLHIuY2xvbmUoKTt2YXIgbj1yLmNsb25lKCk7cmV0dXJuIHRoaXMuZGVzdHJ1Y3RvcihlKSxufWZ1bmN0aW9uIG8oKXtyZXR1cm4gdGhpcy5pc1NtYXJ0UG9pbnRlcj95dCh0aGlzLnJlZ2lzdGVyZWRDbGFzcy5pbnN0YW5jZVByb3RvdHlwZSx7cHRyVHlwZTp0aGlzLnBvaW50ZWVUeXBlLHB0cjp0LHNtYXJ0UHRyVHlwZTp0aGlzLHNtYXJ0UHRyOmV9KTp5dCh0aGlzLnJlZ2lzdGVyZWRDbGFzcy5pbnN0YW5jZVByb3RvdHlwZSx7cHRyVHlwZTp0aGlzLHB0cjplfSl9dmFyIGksYT10aGlzLnJlZ2lzdGVyZWRDbGFzcy5nZXRBY3R1YWxUeXBlKHQpLHM9dHRbYV07aWYoIXMpcmV0dXJuIG8uY2FsbCh0aGlzKTtpPXRoaXMuaXNDb25zdD9zLmNvbnN0UG9pbnRlclR5cGU6cy5wb2ludGVyVHlwZTt2YXIgdT1mdW5jdGlvbiBlKHQscixuKXtpZihyPT09bilyZXR1cm4gdDtpZih2b2lkIDA9PT1uLmJhc2VDbGFzcylyZXR1cm4gbnVsbDt2YXIgbz1lKHQscixuLmJhc2VDbGFzcyk7cmV0dXJuIG51bGw9PT1vP251bGw6bi5kb3duY2FzdChvKX0odCx0aGlzLnJlZ2lzdGVyZWRDbGFzcyxpLnJlZ2lzdGVyZWRDbGFzcyk7cmV0dXJuIG51bGw9PT11P28uY2FsbCh0aGlzKTp0aGlzLmlzU21hcnRQb2ludGVyP3l0KGkucmVnaXN0ZXJlZENsYXNzLmluc3RhbmNlUHJvdG90eXBlLHtwdHJUeXBlOmkscHRyOnUsc21hcnRQdHJUeXBlOnRoaXMsc21hcnRQdHI6ZX0pOnl0KGkucmVnaXN0ZXJlZENsYXNzLmluc3RhbmNlUHJvdG90eXBlLHtwdHJUeXBlOmkscHRyOnV9KX1mdW5jdGlvbiBndChlLHQscixuLG8saSxhLHMsdSxjLGwpe3RoaXMubmFtZT1lLHRoaXMucmVnaXN0ZXJlZENsYXNzPXQsdGhpcy5pc1JlZmVyZW5jZT1yLHRoaXMuaXNDb25zdD1uLHRoaXMuaXNTbWFydFBvaW50ZXI9byx0aGlzLnBvaW50ZWVUeXBlPWksdGhpcy5zaGFyaW5nUG9saWN5PWEsdGhpcy5yYXdHZXRQb2ludGVlPXMsdGhpcy5yYXdDb25zdHJ1Y3Rvcj11LHRoaXMucmF3U2hhcmU9Yyx0aGlzLnJhd0Rlc3RydWN0b3I9bCxvfHx2b2lkIDAhPT10LmJhc2VDbGFzcz90aGlzLnRvV2lyZVR5cGU9YXQ6bj8odGhpcy50b1dpcmVUeXBlPWl0LHRoaXMuZGVzdHJ1Y3RvckZ1bmN0aW9uPW51bGwpOih0aGlzLnRvV2lyZVR5cGU9c3QsdGhpcy5kZXN0cnVjdG9yRnVuY3Rpb249bnVsbCl9ZnVuY3Rpb24gdnQoZSx0KXt2YXIgcjtpZihlPXplKGUpLHZvaWQgMCE9PW9bIkZVTkNUSU9OX1RBQkxFXyIrZV0pcj1vWyJGVU5DVElPTl9UQUJMRV8iK2VdW3RdO2Vsc2UgaWYoInVuZGVmaW5lZCIhPXR5cGVvZiBGVU5DVElPTl9UQUJMRSlyPUZVTkNUSU9OX1RBQkxFW3RdO2Vsc2V7dmFyIG49by5hc21bImR5bkNhbGxfIitlXTt2b2lkIDA9PT1uJiZ2b2lkIDA9PT0obj1vLmFzbVsiZHluQ2FsbF8iK2UucmVwbGFjZSgvZi9nLCJkIildKSYmV2UoIk5vIGR5bkNhbGwgaW52b2tlciBmb3Igc2lnbmF0dXJlOiAiK2UpLHI9ZnVuY3Rpb24ocil7Zm9yKHZhciBuPVtdLG89MTtvPGUubGVuZ3RoOysrbyluLnB1c2goImEiK28pO3ZhciBpPSJyZXR1cm4gZnVuY3Rpb24gIisoImR5bkNhbGxfIitlKyJfIit0KSsiKCIrbi5qb2luKCIsICIpKyIpIHtcbiI7cmV0dXJuIGkrPSIgICAgcmV0dXJuIGR5bkNhbGwocmF3RnVuY3Rpb24iKyhuLmxlbmd0aD8iLCAiOiIiKStuLmpvaW4oIiwgIikrIik7XG4iLGkrPSJ9O1xuIixuZXcgRnVuY3Rpb24oImR5bkNhbGwiLCJyYXdGdW5jdGlvbiIsaSkocix0KX0obil9cmV0dXJuImZ1bmN0aW9uIiE9dHlwZW9mIHImJldlKCJ1bmtub3duIGZ1bmN0aW9uIHBvaW50ZXIgd2l0aCBzaWduYXR1cmUgIitlKyI6ICIrdCkscn12YXIgd3Q9dm9pZCAwO2Z1bmN0aW9uIF90KGUpe3ZhciB0PXF0KGUpLHI9emUodCk7cmV0dXJuIEt0KHQpLHJ9ZnVuY3Rpb24gYnQoZSx0KXt2YXIgcj1bXSxuPXt9O3Rocm93IHQuZm9yRWFjaCgoZnVuY3Rpb24gZSh0KXtuW3RdfHxDZVt0XXx8KE5lW3RdP05lW3RdLmZvckVhY2goZSk6KHIucHVzaCh0KSxuW3RdPSEwKSl9KSksbmV3IHd0KGUrIjogIityLm1hcChfdCkuam9pbihbIiwgIl0pKX1mdW5jdGlvbiBBdChlLHQpe2Zvcih2YXIgcj1bXSxuPTA7bjxlO24rKylyLnB1c2goRlsodD4+Mikrbl0pO3JldHVybiByfWZ1bmN0aW9uIFR0KGUsdCxyLG4sbyl7dmFyIGk9dC5sZW5ndGg7aTwyJiZXZSgiYXJnVHlwZXMgYXJyYXkgc2l6ZSBtaXNtYXRjaCEgTXVzdCBhdCBsZWFzdCBnZXQgcmV0dXJuIHZhbHVlIGFuZCAndGhpcycgdHlwZXMhIik7Zm9yKHZhciBhPW51bGwhPT10WzFdJiZudWxsIT09cixzPSExLHU9MTt1PHQubGVuZ3RoOysrdSlpZihudWxsIT09dFt1XSYmdm9pZCAwPT09dFt1XS5kZXN0cnVjdG9yRnVuY3Rpb24pe3M9ITA7YnJlYWt9dmFyIGM9InZvaWQiIT09dFswXS5uYW1lLGw9IiIsZj0iIjtmb3IodT0wO3U8aS0yOysrdSlsKz0oMCE9PXU/IiwgIjoiIikrImFyZyIrdSxmKz0oMCE9PXU/IiwgIjoiIikrImFyZyIrdSsiV2lyZWQiO3ZhciBkPSJyZXR1cm4gZnVuY3Rpb24gIitGZShlKSsiKCIrbCsiKSB7XG5pZiAoYXJndW1lbnRzLmxlbmd0aCAhPT0gIisoaS0yKSsiKSB7XG50aHJvd0JpbmRpbmdFcnJvcignZnVuY3Rpb24gIitlKyIgY2FsbGVkIHdpdGggJyArIGFyZ3VtZW50cy5sZW5ndGggKyAnIGFyZ3VtZW50cywgZXhwZWN0ZWQgIisoaS0yKSsiIGFyZ3MhJyk7XG59XG4iO3MmJihkKz0idmFyIGRlc3RydWN0b3JzID0gW107XG4iKTt2YXIgaD1zPyJkZXN0cnVjdG9ycyI6Im51bGwiLHA9WyJ0aHJvd0JpbmRpbmdFcnJvciIsImludm9rZXIiLCJmbiIsInJ1bkRlc3RydWN0b3JzIiwicmV0VHlwZSIsImNsYXNzUGFyYW0iXSxtPVtXZSxuLG8sRGUsdFswXSx0WzFdXTthJiYoZCs9InZhciB0aGlzV2lyZWQgPSBjbGFzc1BhcmFtLnRvV2lyZVR5cGUoIitoKyIsIHRoaXMpO1xuIik7Zm9yKHU9MDt1PGktMjsrK3UpZCs9InZhciBhcmciK3UrIldpcmVkID0gYXJnVHlwZSIrdSsiLnRvV2lyZVR5cGUoIitoKyIsIGFyZyIrdSsiKTsgLy8gIit0W3UrMl0ubmFtZSsiXG4iLHAucHVzaCgiYXJnVHlwZSIrdSksbS5wdXNoKHRbdSsyXSk7aWYoYSYmKGY9InRoaXNXaXJlZCIrKGYubGVuZ3RoPjA/IiwgIjoiIikrZiksZCs9KGM/InZhciBydiA9ICI6IiIpKyJpbnZva2VyKGZuIisoZi5sZW5ndGg+MD8iLCAiOiIiKStmKyIpO1xuIixzKWQrPSJydW5EZXN0cnVjdG9ycyhkZXN0cnVjdG9ycyk7XG4iO2Vsc2UgZm9yKHU9YT8xOjI7dTx0Lmxlbmd0aDsrK3Upe3ZhciB5PTE9PT11PyJ0aGlzV2lyZWQiOiJhcmciKyh1LTIpKyJXaXJlZCI7bnVsbCE9PXRbdV0uZGVzdHJ1Y3RvckZ1bmN0aW9uJiYoZCs9eSsiX2R0b3IoIit5KyIpOyAvLyAiK3RbdV0ubmFtZSsiXG4iLHAucHVzaCh5KyJfZHRvciIpLG0ucHVzaCh0W3VdLmRlc3RydWN0b3JGdW5jdGlvbikpfXJldHVybiBjJiYoZCs9InZhciByZXQgPSByZXRUeXBlLmZyb21XaXJlVHlwZShydik7XG5yZXR1cm4gcmV0O1xuIiksZCs9In1cbiIscC5wdXNoKGQpLGZ1bmN0aW9uKGUsdCl7aWYoIShlIGluc3RhbmNlb2YgRnVuY3Rpb24pKXRocm93IG5ldyBUeXBlRXJyb3IoIm5ld18gY2FsbGVkIHdpdGggY29uc3RydWN0b3IgdHlwZSAiK3R5cGVvZiBlKyIgd2hpY2ggaXMgbm90IGEgZnVuY3Rpb24iKTt2YXIgcj1NZShlLm5hbWV8fCJ1bmtub3duRnVuY3Rpb25OYW1lIiwoZnVuY3Rpb24oKXt9KSk7ci5wcm90b3R5cGU9ZS5wcm90b3R5cGU7dmFyIG49bmV3IHIsbz1lLmFwcGx5KG4sdCk7cmV0dXJuIG8gaW5zdGFuY2VvZiBPYmplY3Q/bzpufShGdW5jdGlvbixwKS5hcHBseShudWxsLG0pfXZhciBTdD1bXSxrdD1be30se3ZhbHVlOnZvaWQgMH0se3ZhbHVlOm51bGx9LHt2YWx1ZTohMH0se3ZhbHVlOiExfV07ZnVuY3Rpb24gUHQoKXtmb3IodmFyIGU9MCx0PTU7dDxrdC5sZW5ndGg7Kyt0KXZvaWQgMCE9PWt0W3RdJiYrK2U7cmV0dXJuIGV9ZnVuY3Rpb24gRHQoKXtmb3IodmFyIGU9NTtlPGt0Lmxlbmd0aDsrK2UpaWYodm9pZCAwIT09a3RbZV0pcmV0dXJuIGt0W2VdO3JldHVybiBudWxsfWZ1bmN0aW9uIFJ0KGUpe3N3aXRjaChlKXtjYXNlIHZvaWQgMDpyZXR1cm4gMTtjYXNlIG51bGw6cmV0dXJuIDI7Y2FzZSEwOnJldHVybiAzO2Nhc2UhMTpyZXR1cm4gNDtkZWZhdWx0OnZhciB0PVN0Lmxlbmd0aD9TdC5wb3AoKTprdC5sZW5ndGg7cmV0dXJuIGt0W3RdPXtyZWZjb3VudDoxLHZhbHVlOmV9LHR9fWZ1bmN0aW9uIE90KGUpe2lmKG51bGw9PT1lKXJldHVybiJudWxsIjt2YXIgdD10eXBlb2YgZTtyZXR1cm4ib2JqZWN0Ij09PXR8fCJhcnJheSI9PT10fHwiZnVuY3Rpb24iPT09dD9lLnRvU3RyaW5nKCk6IiIrZX1mdW5jdGlvbiBDdChlLHQpe3N3aXRjaCh0KXtjYXNlIDI6cmV0dXJuIGZ1bmN0aW9uKGUpe3JldHVybiB0aGlzLmZyb21XaXJlVHlwZShJW2U+PjJdKX07Y2FzZSAzOnJldHVybiBmdW5jdGlvbihlKXtyZXR1cm4gdGhpcy5mcm9tV2lyZVR5cGUoQltlPj4zXSl9O2RlZmF1bHQ6dGhyb3cgbmV3IFR5cGVFcnJvcigiVW5rbm93biBmbG9hdCB0eXBlOiAiK2UpfX1mdW5jdGlvbiBOdChlLHQscil7c3dpdGNoKHQpe2Nhc2UgMDpyZXR1cm4gcj9mdW5jdGlvbihlKXtyZXR1cm4gUltlXX06ZnVuY3Rpb24oZSl7cmV0dXJuIE9bZV19O2Nhc2UgMTpyZXR1cm4gcj9mdW5jdGlvbihlKXtyZXR1cm4gQ1tlPj4xXX06ZnVuY3Rpb24oZSl7cmV0dXJuIE5bZT4+MV19O2Nhc2UgMjpyZXR1cm4gcj9mdW5jdGlvbihlKXtyZXR1cm4gRltlPj4yXX06ZnVuY3Rpb24oZSl7cmV0dXJuIE1bZT4+Ml19O2RlZmF1bHQ6dGhyb3cgbmV3IFR5cGVFcnJvcigiVW5rbm93biBpbnRlZ2VyIHR5cGU6ICIrZSl9fXZhciBGdD1MKz0xNjt2YXIgTXQ9e307dmFyIEl0PUwrPTE2O0wrPTQ4O2coJHQoIkdNVCIpLCJpOCIsMik7dmFyIEJ0PUwsTHQ9TCs9MTYseHQ9TCs9MTY7ZnVuY3Rpb24ganQoKXtpZighanQuY2FsbGVkKXtqdC5jYWxsZWQ9ITAsRlt4dD4+Ml09NjAqKG5ldyBEYXRlKS5nZXRUaW1lem9uZU9mZnNldCgpO3ZhciBlPW5ldyBEYXRlKDJlMywwLDEpLHQ9bmV3IERhdGUoMmUzLDYsMSk7RltMdD4+Ml09TnVtYmVyKGUuZ2V0VGltZXpvbmVPZmZzZXQoKSE9dC5nZXRUaW1lem9uZU9mZnNldCgpKTt2YXIgcj1hKGUpLG49YSh0KSxvPWcoJHQociksImk4IiwwKSxpPWcoJHQobiksImk4IiwwKTt0LmdldFRpbWV6b25lT2Zmc2V0KCk8ZS5nZXRUaW1lem9uZU9mZnNldCgpPyhGW0J0Pj4yXT1vLEZbQnQrND4+Ml09aSk6KEZbQnQ+PjJdPWksRltCdCs0Pj4yXT1vKX1mdW5jdGlvbiBhKGUpe3ZhciB0PWUudG9UaW1lU3RyaW5nKCkubWF0Y2goL1woKFtBLVphLXogXSspXCkkLyk7cmV0dXJuIHQ/dFsxXToiR01UIn19TCs9MTY7dmFyIFV0PXt9O3ZhciB6dD0xO2Z1bmN0aW9uICR0KGUsdCxyKXt2YXIgbj1yPjA/cjpTKGUpKzEsbz1uZXcgQXJyYXkobiksaT1BKGUsbywwLG8ubGVuZ3RoKTtyZXR1cm4gdCYmKG8ubGVuZ3RoPWkpLG99VGUuc3RhdGljSW5pdCgpLEoudW5zaGlmdCgoZnVuY3Rpb24oKXtvLm5vRlNJbml0fHxUZS5pbml0LmluaXRpYWxpemVkfHxUZS5pbml0KCl9KSksWi5wdXNoKChmdW5jdGlvbigpe1RlLmlnbm9yZVBlcm1pc3Npb25zPSExfSkpLFEucHVzaCgoZnVuY3Rpb24oKXtUZS5xdWl0KCl9KSksSi51bnNoaWZ0KChmdW5jdGlvbigpe3ZlLmluaXQoKX0pKSxRLnB1c2goKGZ1bmN0aW9uKCl7dmUuc2h1dGRvd24oKX0pKSxCZT1vLkludGVybmFsRXJyb3I9SWUoRXJyb3IsIkludGVybmFsRXJyb3IiKSxmdW5jdGlvbigpe2Zvcih2YXIgZT1uZXcgQXJyYXkoMjU2KSx0PTA7dDwyNTY7Kyt0KWVbdF09U3RyaW5nLmZyb21DaGFyQ29kZSh0KTtVZT1lfSgpLCRlPW8uQmluZGluZ0Vycm9yPUllKEVycm9yLCJCaW5kaW5nRXJyb3IiKSxldC5wcm90b3R5cGUuaXNBbGlhc09mPVZlLGV0LnByb3RvdHlwZS5jbG9uZT1HZSxldC5wcm90b3R5cGUuZGVsZXRlPXFlLGV0LnByb3RvdHlwZS5pc0RlbGV0ZWQ9WGUsZXQucHJvdG90eXBlLmRlbGV0ZUxhdGVyPVFlLGd0LnByb3RvdHlwZS5nZXRQb2ludGVlPXV0LGd0LnByb3RvdHlwZS5kZXN0cnVjdG9yPWN0LGd0LnByb3RvdHlwZS5hcmdQYWNrQWR2YW5jZT04LGd0LnByb3RvdHlwZS5yZWFkVmFsdWVGcm9tUG9pbnRlcj1SZSxndC5wcm90b3R5cGUuZGVsZXRlT2JqZWN0PWx0LGd0LnByb3RvdHlwZS5mcm9tV2lyZVR5cGU9RXQsby5nZXRJbmhlcml0ZWRJbnN0YW5jZUNvdW50PWZ0LG8uZ2V0TGl2ZUluaGVyaXRlZEluc3RhbmNlcz1kdCxvLmZsdXNoUGVuZGluZ0RlbGV0ZXM9WmUsby5zZXREZWxheUZ1bmN0aW9uPWh0LHd0PW8uVW5ib3VuZFR5cGVFcnJvcj1JZShFcnJvciwiVW5ib3VuZFR5cGVFcnJvciIpLG8uY291bnRfZW12YWxfaGFuZGxlcz1QdCxvLmdldF9maXJzdF9lbXZhbD1EdCxmdW5jdGlvbiBlKHQpe3ZhciByLG47ZS5jYWxsZWQ/KG49RltGdD4+Ml0scj1GW24+PjJdKTooZS5jYWxsZWQ9ITAsTXQuVVNFUj1NdC5MT0dOQU1FPSJ3ZWJfdXNlciIsTXQuUEFUSD0iLyIsTXQuUFdEPSIvIixNdC5IT01FPSIvaG9tZS93ZWJfdXNlciIsTXQuTEFORz0iQy5VVEYtOCIsTXQuXz1vLnRoaXNQcm9ncmFtLHI9ZigxMDI0KSxuPWYoMjU2KSxGW24+PjJdPXIsRltGdD4+Ml09bik7dmFyIGk9W10sYT0wO2Zvcih2YXIgcyBpbiB0KWlmKCJzdHJpbmciPT10eXBlb2YgdFtzXSl7dmFyIHU9cysiPSIrdFtzXTtpLnB1c2godSksYSs9dS5sZW5ndGh9aWYoYT4xMDI0KXRocm93IG5ldyBFcnJvcigiRW52aXJvbm1lbnQgc2l6ZSBleGNlZWRlZCBUT1RBTF9FTlZfU0laRSEiKTtmb3IodmFyIGM9MDtjPGkubGVuZ3RoO2MrKyl7cmUodT1pW2NdLHIpLEZbbis0KmM+PjJdPXIscis9dS5sZW5ndGgrMX1GW24rNCppLmxlbmd0aD4+Ml09MH0oTXQpLCQ9Zig0KSxqPVU9aChMKSx6PWgoaitHKSxGWyQ+PjJdPXoseD0hMCxvLndhc21UYWJsZVNpemU9MzE2LG8ud2FzbU1heFRhYmxlU2l6ZT0zMTYsby5hc21HbG9iYWxBcmc9e30sby5hc21MaWJyYXJ5QXJnPXthYm9ydDpycixlbmxhcmdlTWVtb3J5OkgsZ2V0VG90YWxNZW1vcnk6ZnVuY3Rpb24oKXtyZXR1cm4gcX0sYWJvcnRPbkNhbm5vdEdyb3dNZW1vcnk6ZnVuY3Rpb24oKXtycigiQ2Fubm90IGVubGFyZ2UgbWVtb3J5IGFycmF5cy4gRWl0aGVyICgxKSBjb21waWxlIHdpdGggIC1zIFRPVEFMX01FTU9SWT1YICB3aXRoIFggaGlnaGVyIHRoYW4gdGhlIGN1cnJlbnQgdmFsdWUgIitxKyIsICgyKSBjb21waWxlIHdpdGggIC1zIEFMTE9XX01FTU9SWV9HUk9XVEg9MSAgd2hpY2ggYWxsb3dzIGluY3JlYXNpbmcgdGhlIHNpemUgYXQgcnVudGltZSwgb3IgKDMpIGlmIHlvdSB3YW50IG1hbGxvYyB0byByZXR1cm4gTlVMTCAoMCkgaW5zdGVhZCBvZiB0aGlzIGFib3J0LCBjb21waWxlIHdpdGggIC1zIEFCT1JUSU5HX01BTExPQz0wICIpfSxpbnZva2VfaTpmdW5jdGlvbihlKXt0cnl7cmV0dXJuIG8uZHluQ2FsbF9pKGUpfWNhdGNoKGUpe2lmKCJudW1iZXIiIT10eXBlb2YgZSYmImxvbmdqbXAiIT09ZSl0aHJvdyBlO28uc2V0VGhyZXcoMSwwKX19LGludm9rZV9paTpmdW5jdGlvbihlLHQpe3RyeXtyZXR1cm4gby5keW5DYWxsX2lpKGUsdCl9Y2F0Y2goZSl7aWYoIm51bWJlciIhPXR5cGVvZiBlJiYibG9uZ2ptcCIhPT1lKXRocm93IGU7by5zZXRUaHJldygxLDApfX0saW52b2tlX2lpaTpmdW5jdGlvbihlLHQscil7dHJ5e3JldHVybiBvLmR5bkNhbGxfaWlpKGUsdCxyKX1jYXRjaChlKXtpZigibnVtYmVyIiE9dHlwZW9mIGUmJiJsb25nam1wIiE9PWUpdGhyb3cgZTtvLnNldFRocmV3KDEsMCl9fSxpbnZva2VfaWlpaTpmdW5jdGlvbihlLHQscixuKXt0cnl7cmV0dXJuIG8uZHluQ2FsbF9paWlpKGUsdCxyLG4pfWNhdGNoKGUpe2lmKCJudW1iZXIiIT10eXBlb2YgZSYmImxvbmdqbXAiIT09ZSl0aHJvdyBlO28uc2V0VGhyZXcoMSwwKX19LGludm9rZV9paWlpaTpmdW5jdGlvbihlLHQscixuLGkpe3RyeXtyZXR1cm4gby5keW5DYWxsX2lpaWlpKGUsdCxyLG4saSl9Y2F0Y2goZSl7aWYoIm51bWJlciIhPXR5cGVvZiBlJiYibG9uZ2ptcCIhPT1lKXRocm93IGU7by5zZXRUaHJldygxLDApfX0saW52b2tlX2lpaWlpaWk6ZnVuY3Rpb24oZSx0LHIsbixpLGEscyl7dHJ5e3JldHVybiBvLmR5bkNhbGxfaWlpaWlpaShlLHQscixuLGksYSxzKX1jYXRjaChlKXtpZigibnVtYmVyIiE9dHlwZW9mIGUmJiJsb25nam1wIiE9PWUpdGhyb3cgZTtvLnNldFRocmV3KDEsMCl9fSxpbnZva2VfaWlpaWlpaWlpaTpmdW5jdGlvbihlLHQscixuLGksYSxzLHUsYyxsKXt0cnl7cmV0dXJuIG8uZHluQ2FsbF9paWlpaWlpaWlpKGUsdCxyLG4saSxhLHMsdSxjLGwpfWNhdGNoKGUpe2lmKCJudW1iZXIiIT10eXBlb2YgZSYmImxvbmdqbXAiIT09ZSl0aHJvdyBlO28uc2V0VGhyZXcoMSwwKX19LGludm9rZV9paWlpaWlqaWk6ZnVuY3Rpb24oZSx0LHIsbixpLGEscyx1LGMsbCl7dHJ5e3JldHVybiBvLmR5bkNhbGxfaWlpaWlpamlpKGUsdCxyLG4saSxhLHMsdSxjLGwpfWNhdGNoKGUpe2lmKCJudW1iZXIiIT10eXBlb2YgZSYmImxvbmdqbXAiIT09ZSl0aHJvdyBlO28uc2V0VGhyZXcoMSwwKX19LGludm9rZV9pamo6ZnVuY3Rpb24oZSx0LHIsbixpKXt0cnl7cmV0dXJuIG8uZHluQ2FsbF9pamooZSx0LHIsbixpKX1jYXRjaChlKXtpZigibnVtYmVyIiE9dHlwZW9mIGUmJiJsb25nam1wIiE9PWUpdGhyb3cgZTtvLnNldFRocmV3KDEsMCl9fSxpbnZva2Vfamk6ZnVuY3Rpb24oZSx0KXt0cnl7cmV0dXJuIG8uZHluQ2FsbF9qaShlLHQpfWNhdGNoKGUpe2lmKCJudW1iZXIiIT10eXBlb2YgZSYmImxvbmdqbXAiIT09ZSl0aHJvdyBlO28uc2V0VGhyZXcoMSwwKX19LGludm9rZV92OmZ1bmN0aW9uKGUpe3RyeXtvLmR5bkNhbGxfdihlKX1jYXRjaChlKXtpZigibnVtYmVyIiE9dHlwZW9mIGUmJiJsb25nam1wIiE9PWUpdGhyb3cgZTtvLnNldFRocmV3KDEsMCl9fSxpbnZva2Vfdmk6ZnVuY3Rpb24oZSx0KXt0cnl7by5keW5DYWxsX3ZpKGUsdCl9Y2F0Y2goZSl7aWYoIm51bWJlciIhPXR5cGVvZiBlJiYibG9uZ2ptcCIhPT1lKXRocm93IGU7by5zZXRUaHJldygxLDApfX0saW52b2tlX3ZpaTpmdW5jdGlvbihlLHQscil7dHJ5e28uZHluQ2FsbF92aWkoZSx0LHIpfWNhdGNoKGUpe2lmKCJudW1iZXIiIT10eXBlb2YgZSYmImxvbmdqbXAiIT09ZSl0aHJvdyBlO28uc2V0VGhyZXcoMSwwKX19LGludm9rZV92aWlpOmZ1bmN0aW9uKGUsdCxyLG4pe3RyeXtvLmR5bkNhbGxfdmlpaShlLHQscixuKX1jYXRjaChlKXtpZigibnVtYmVyIiE9dHlwZW9mIGUmJiJsb25nam1wIiE9PWUpdGhyb3cgZTtvLnNldFRocmV3KDEsMCl9fSxpbnZva2VfdmlpaWk6ZnVuY3Rpb24oZSx0LHIsbixpKXt0cnl7by5keW5DYWxsX3ZpaWlpKGUsdCxyLG4saSl9Y2F0Y2goZSl7aWYoIm51bWJlciIhPXR5cGVvZiBlJiYibG9uZ2ptcCIhPT1lKXRocm93IGU7by5zZXRUaHJldygxLDApfX0saW52b2tlX3ZpaWlpaTpmdW5jdGlvbihlLHQscixuLGksYSl7dHJ5e28uZHluQ2FsbF92aWlpaWkoZSx0LHIsbixpLGEpfWNhdGNoKGUpe2lmKCJudW1iZXIiIT10eXBlb2YgZSYmImxvbmdqbXAiIT09ZSl0aHJvdyBlO28uc2V0VGhyZXcoMSwwKX19LGludm9rZV92aWlpaWlpOmZ1bmN0aW9uKGUsdCxyLG4saSxhLHMpe3RyeXtvLmR5bkNhbGxfdmlpaWlpaShlLHQscixuLGksYSxzKX1jYXRjaChlKXtpZigibnVtYmVyIiE9dHlwZW9mIGUmJiJsb25nam1wIiE9PWUpdGhyb3cgZTtvLnNldFRocmV3KDEsMCl9fSxpbnZva2VfdmlpaWlpaWlpaTpmdW5jdGlvbihlLHQscixuLGksYSxzLHUsYyxsKXt0cnl7by5keW5DYWxsX3ZpaWlpaWlpaWkoZSx0LHIsbixpLGEscyx1LGMsbCl9Y2F0Y2goZSl7aWYoIm51bWJlciIhPXR5cGVvZiBlJiYibG9uZ2ptcCIhPT1lKXRocm93IGU7by5zZXRUaHJldygxLDApfX0saW52b2tlX3ZpaWlpaWlpaWlpOmZ1bmN0aW9uKGUsdCxyLG4saSxhLHMsdSxjLGwsZil7dHJ5e28uZHluQ2FsbF92aWlpaWlpaWlpaShlLHQscixuLGksYSxzLHUsYyxsLGYpfWNhdGNoKGUpe2lmKCJudW1iZXIiIT10eXBlb2YgZSYmImxvbmdqbXAiIT09ZSl0aHJvdyBlO28uc2V0VGhyZXcoMSwwKX19LGludm9rZV92aWo6ZnVuY3Rpb24oZSx0LHIsbil7dHJ5e28uZHluQ2FsbF92aWooZSx0LHIsbil9Y2F0Y2goZSl7aWYoIm51bWJlciIhPXR5cGVvZiBlJiYibG9uZ2ptcCIhPT1lKXRocm93IGU7by5zZXRUaHJldygxLDApfX0saW52b2tlX3Zpamk6ZnVuY3Rpb24oZSx0LHIsbixpKXt0cnl7by5keW5DYWxsX3ZpamkoZSx0LHIsbixpKX1jYXRjaChlKXtpZigibnVtYmVyIiE9dHlwZW9mIGUmJiJsb25nam1wIiE9PWUpdGhyb3cgZTtvLnNldFRocmV3KDEsMCl9fSxfX19jeGFfYWxsb2NhdGVfZXhjZXB0aW9uOmZ1bmN0aW9uKGUpe3JldHVybiBKdChlKX0sX19fY3hhX2JlZ2luX2NhdGNoOmZ1bmN0aW9uKGUpe3ZhciB0PWRlLmluZm9zW2VdO3JldHVybiB0JiYhdC5jYXVnaHQmJih0LmNhdWdodD0hMCksdCYmKHQucmV0aHJvd249ITEpLGRlLmNhdWdodC5wdXNoKGUpLGRlLmFkZFJlZihkZS5kZUFkanVzdChlKSksZX0sX19fY3hhX2VuZF9jYXRjaDpmdW5jdGlvbigpe28uc2V0VGhyZXcoMCk7dmFyIGU9ZGUuY2F1Z2h0LnBvcCgpO2UmJihkZS5kZWNSZWYoZGUuZGVBZGp1c3QoZSkpLGRlLmxhc3Q9MCl9LF9fX2N4YV9maW5kX21hdGNoaW5nX2NhdGNoXzI6ZnVuY3Rpb24oKXtyZXR1cm4gcGUuYXBwbHkobnVsbCxhcmd1bWVudHMpfSxfX19jeGFfZmluZF9tYXRjaGluZ19jYXRjaF8zOmZ1bmN0aW9uKCl7cmV0dXJuIHBlLmFwcGx5KG51bGwsYXJndW1lbnRzKX0sX19fY3hhX2ZpbmRfbWF0Y2hpbmdfY2F0Y2hfNDpmdW5jdGlvbigpe3JldHVybiBwZS5hcHBseShudWxsLGFyZ3VtZW50cyl9LF9fX2N4YV9mcmVlX2V4Y2VwdGlvbjpoZSxfX19jeGFfdGhyb3c6ZnVuY3Rpb24oZSx0LHIpe3Rocm93IGRlLmluZm9zW2VdPXtwdHI6ZSxhZGp1c3RlZDplLHR5cGU6dCxkZXN0cnVjdG9yOnIscmVmY291bnQ6MCxjYXVnaHQ6ITEscmV0aHJvd246ITF9LGRlLmxhc3Q9ZSxlfSxfX19sb2NrOmZ1bmN0aW9uKCl7fSxfX19tYXBfZmlsZTpmdW5jdGlvbihlLHQpe3JldHVybiB5ZShtZS5FUEVSTSksLTF9LF9fX3Jlc3VtZUV4Y2VwdGlvbjpmdW5jdGlvbihlKXt0aHJvdyBkZS5sYXN0fHwoZGUubGFzdD1lKSxlfSxfX19zZXRFcnJObzp5ZSxfX19zeXNjYWxsMTQwOmZ1bmN0aW9uKGUsdCl7U2UudmFyYXJncz10O3RyeXt2YXIgcj1TZS5nZXRTdHJlYW1Gcm9tRkQoKSxuPShTZS5nZXQoKSxTZS5nZXQoKSksbz1TZS5nZXQoKSxpPVNlLmdldCgpLGE9bjtyZXR1cm4gVGUubGxzZWVrKHIsYSxpKSxGW28+PjJdPXIucG9zaXRpb24sci5nZXRkZW50cyYmMD09PWEmJjA9PT1pJiYoci5nZXRkZW50cz1udWxsKSwwfWNhdGNoKGUpe3JldHVybiB2b2lkIDAhPT1UZSYmZSBpbnN0YW5jZW9mIFRlLkVycm5vRXJyb3J8fHJyKGUpLC1lLmVycm5vfX0sX19fc3lzY2FsbDE0NTpmdW5jdGlvbihlLHQpe1NlLnZhcmFyZ3M9dDt0cnl7dmFyIHI9U2UuZ2V0U3RyZWFtRnJvbUZEKCksbj1TZS5nZXQoKSxvPVNlLmdldCgpO3JldHVybiBTZS5kb1JlYWR2KHIsbixvKX1jYXRjaChlKXtyZXR1cm4gdm9pZCAwIT09VGUmJmUgaW5zdGFuY2VvZiBUZS5FcnJub0Vycm9yfHxycihlKSwtZS5lcnJub319LF9fX3N5c2NhbGwxNDY6ZnVuY3Rpb24oZSx0KXtTZS52YXJhcmdzPXQ7dHJ5e3ZhciByPVNlLmdldFN0cmVhbUZyb21GRCgpLG49U2UuZ2V0KCksbz1TZS5nZXQoKTtyZXR1cm4gU2UuZG9Xcml0ZXYocixuLG8pfWNhdGNoKGUpe3JldHVybiB2b2lkIDAhPT1UZSYmZSBpbnN0YW5jZW9mIFRlLkVycm5vRXJyb3J8fHJyKGUpLC1lLmVycm5vfX0sX19fc3lzY2FsbDE4MzpmdW5jdGlvbihlLHQpe1NlLnZhcmFyZ3M9dDt0cnl7dmFyIHI9U2UuZ2V0KCksbj1TZS5nZXQoKTtpZigwPT09bilyZXR1cm4tbWUuRUlOVkFMO3ZhciBvPVRlLmN3ZCgpO3JldHVybiBuPFMobykrMT8tbWUuRVJBTkdFOihUKG8scixuKSxyKX1jYXRjaChlKXtyZXR1cm4gdm9pZCAwIT09VGUmJmUgaW5zdGFuY2VvZiBUZS5FcnJub0Vycm9yfHxycihlKSwtZS5lcnJub319LF9fX3N5c2NhbGwxOTg6ZnVuY3Rpb24oZSx0KXtTZS52YXJhcmdzPXQ7dHJ5e3ZhciByPVNlLmdldFN0cigpLG49U2UuZ2V0KCksbz1TZS5nZXQoKTtyZXR1cm4gVGUuY2hvd24ocixuLG8pLDB9Y2F0Y2goZSl7cmV0dXJuIHZvaWQgMCE9PVRlJiZlIGluc3RhbmNlb2YgVGUuRXJybm9FcnJvcnx8cnIoZSksLWUuZXJybm99fSxfX19zeXNjYWxsMjA6ZnVuY3Rpb24oZSx0KXtTZS52YXJhcmdzPXQ7dHJ5e3JldHVybiBrZX1jYXRjaChlKXtyZXR1cm4gdm9pZCAwIT09VGUmJmUgaW5zdGFuY2VvZiBUZS5FcnJub0Vycm9yfHxycihlKSwtZS5lcnJub319LF9fX3N5c2NhbGw2OmZ1bmN0aW9uKGUsdCl7U2UudmFyYXJncz10O3RyeXt2YXIgcj1TZS5nZXRTdHJlYW1Gcm9tRkQoKTtyZXR1cm4gVGUuY2xvc2UociksMH1jYXRjaChlKXtyZXR1cm4gdm9pZCAwIT09VGUmJmUgaW5zdGFuY2VvZiBUZS5FcnJub0Vycm9yfHxycihlKSwtZS5lcnJub319LF9fX3N5c2NhbGw2MDpmdW5jdGlvbihlLHQpe1NlLnZhcmFyZ3M9dDt0cnl7dmFyIHI9U2UuZ2V0KCksbj1TZS51bWFzaztyZXR1cm4gU2UudW1hc2s9cixufWNhdGNoKGUpe3JldHVybiB2b2lkIDAhPT1UZSYmZSBpbnN0YW5jZW9mIFRlLkVycm5vRXJyb3J8fHJyKGUpLC1lLmVycm5vfX0sX19fc3lzY2FsbDgzOmZ1bmN0aW9uKGUsdCl7U2UudmFyYXJncz10O3RyeXt2YXIgcj1TZS5nZXRTdHIoKSxuPVNlLmdldFN0cigpO3JldHVybiBUZS5zeW1saW5rKHIsbiksMH1jYXRjaChlKXtyZXR1cm4gdm9pZCAwIT09VGUmJmUgaW5zdGFuY2VvZiBUZS5FcnJub0Vycm9yfHxycihlKSwtZS5lcnJub319LF9fX3N5c2NhbGw5MTpmdW5jdGlvbihlLHQpe1NlLnZhcmFyZ3M9dDt0cnl7dmFyIHI9U2UuZ2V0KCksbj1TZS5nZXQoKSxvPVNlLm1hcHBpbmdzW3JdO2lmKCFvKXJldHVybiAwO2lmKG49PT1vLmxlbil7dmFyIGk9VGUuZ2V0U3RyZWFtKG8uZmQpO1NlLmRvTXN5bmMocixpLG4sby5mbGFncyksVGUubXVubWFwKGkpLFNlLm1hcHBpbmdzW3JdPW51bGwsby5hbGxvY2F0ZWQmJkt0KG8ubWFsbG9jKX1yZXR1cm4gMH1jYXRjaChlKXtyZXR1cm4gdm9pZCAwIT09VGUmJmUgaW5zdGFuY2VvZiBUZS5FcnJub0Vycm9yfHxycihlKSwtZS5lcnJub319LF9fX3VubG9jazpmdW5jdGlvbigpe30sX19lbWJpbmRfZmluYWxpemVfdmFsdWVfb2JqZWN0OmZ1bmN0aW9uKGUpe3ZhciB0PVBlW2VdO2RlbGV0ZSBQZVtlXTt2YXIgcj10LnJhd0NvbnN0cnVjdG9yLG49dC5yYXdEZXN0cnVjdG9yLG89dC5maWVsZHM7eGUoW2VdLG8ubWFwKChmdW5jdGlvbihlKXtyZXR1cm4gZS5nZXR0ZXJSZXR1cm5UeXBlfSkpLmNvbmNhdChvLm1hcCgoZnVuY3Rpb24oZSl7cmV0dXJuIGUuc2V0dGVyQXJndW1lbnRUeXBlfSkpKSwoZnVuY3Rpb24oZSl7dmFyIGk9e307cmV0dXJuIG8uZm9yRWFjaCgoZnVuY3Rpb24odCxyKXt2YXIgbj10LmZpZWxkTmFtZSxhPWVbcl0scz10LmdldHRlcix1PXQuZ2V0dGVyQ29udGV4dCxjPWVbcitvLmxlbmd0aF0sbD10LnNldHRlcixmPXQuc2V0dGVyQ29udGV4dDtpW25dPXtyZWFkOmZ1bmN0aW9uKGUpe3JldHVybiBhLmZyb21XaXJlVHlwZShzKHUsZSkpfSx3cml0ZTpmdW5jdGlvbihlLHQpe3ZhciByPVtdO2woZixlLGMudG9XaXJlVHlwZShyLHQpKSxEZShyKX19fSkpLFt7bmFtZTp0Lm5hbWUsZnJvbVdpcmVUeXBlOmZ1bmN0aW9uKGUpe3ZhciB0PXt9O2Zvcih2YXIgciBpbiBpKXRbcl09aVtyXS5yZWFkKGUpO3JldHVybiBuKGUpLHR9LHRvV2lyZVR5cGU6ZnVuY3Rpb24oZSx0KXtmb3IodmFyIG8gaW4gaSlpZighKG8gaW4gdCkpdGhyb3cgbmV3IFR5cGVFcnJvcigiTWlzc2luZyBmaWVsZCIpO3ZhciBhPXIoKTtmb3IobyBpbiBpKWlbb10ud3JpdGUoYSx0W29dKTtyZXR1cm4gbnVsbCE9PWUmJmUucHVzaChuLGEpLGF9LGFyZ1BhY2tBZHZhbmNlOjgscmVhZFZhbHVlRnJvbVBvaW50ZXI6UmUsZGVzdHJ1Y3RvckZ1bmN0aW9uOm59XX0pKX0sX19lbWJpbmRfcmVnaXN0ZXJfYm9vbDpmdW5jdGlvbihlLHQscixuLG8pe3ZhciBpPWplKHIpO1llKGUse25hbWU6dD16ZSh0KSxmcm9tV2lyZVR5cGU6ZnVuY3Rpb24oZSl7cmV0dXJuISFlfSx0b1dpcmVUeXBlOmZ1bmN0aW9uKGUsdCl7cmV0dXJuIHQ/bjpvfSxhcmdQYWNrQWR2YW5jZTo4LHJlYWRWYWx1ZUZyb21Qb2ludGVyOmZ1bmN0aW9uKGUpe3ZhciBuO2lmKDE9PT1yKW49UjtlbHNlIGlmKDI9PT1yKW49QztlbHNle2lmKDQhPT1yKXRocm93IG5ldyBUeXBlRXJyb3IoIlVua25vd24gYm9vbGVhbiB0eXBlIHNpemU6ICIrdCk7bj1GfXJldHVybiB0aGlzLmZyb21XaXJlVHlwZShuW2U+PmldKX0sZGVzdHJ1Y3RvckZ1bmN0aW9uOm51bGx9KX0sX19lbWJpbmRfcmVnaXN0ZXJfY2xhc3M6ZnVuY3Rpb24oZSx0LHIsbixpLGEscyx1LGMsbCxmLGQsaCl7Zj16ZShmKSxhPXZ0KGksYSksdSYmKHU9dnQocyx1KSksbCYmKGw9dnQoYyxsKSksaD12dChkLGgpO3ZhciBwPUZlKGYpOyFmdW5jdGlvbihlLHQscil7by5oYXNPd25Qcm9wZXJ0eShlKT8oKHZvaWQgMD09PXJ8fHZvaWQgMCE9PW9bZV0ub3ZlcmxvYWRUYWJsZSYmdm9pZCAwIT09b1tlXS5vdmVybG9hZFRhYmxlW3JdKSYmV2UoIkNhbm5vdCByZWdpc3RlciBwdWJsaWMgbmFtZSAnIitlKyInIHR3aWNlIikscnQobyxlLGUpLG8uaGFzT3duUHJvcGVydHkocikmJldlKCJDYW5ub3QgcmVnaXN0ZXIgbXVsdGlwbGUgb3ZlcmxvYWRzIG9mIGEgZnVuY3Rpb24gd2l0aCB0aGUgc2FtZSBudW1iZXIgb2YgYXJndW1lbnRzICgiK3IrIikhIiksb1tlXS5vdmVybG9hZFRhYmxlW3JdPXQpOihvW2VdPXQsdm9pZCAwIT09ciYmKG9bZV0ubnVtQXJndW1lbnRzPXIpKX0ocCwoZnVuY3Rpb24oKXtidCgiQ2Fubm90IGNvbnN0cnVjdCAiK2YrIiBkdWUgdG8gdW5ib3VuZCB0eXBlcyIsW25dKX0pKSx4ZShbZSx0LHJdLG4/W25dOltdLChmdW5jdGlvbih0KXt2YXIgcixpO3Q9dFswXSxpPW4/KHI9dC5yZWdpc3RlcmVkQ2xhc3MpLmluc3RhbmNlUHJvdG90eXBlOmV0LnByb3RvdHlwZTt2YXIgcz1NZShwLChmdW5jdGlvbigpe2lmKE9iamVjdC5nZXRQcm90b3R5cGVPZih0aGlzKSE9PWMpdGhyb3cgbmV3ICRlKCJVc2UgJ25ldycgdG8gY29uc3RydWN0ICIrZik7aWYodm9pZCAwPT09ZC5jb25zdHJ1Y3Rvcl9ib2R5KXRocm93IG5ldyAkZShmKyIgaGFzIG5vIGFjY2Vzc2libGUgY29uc3RydWN0b3IiKTt2YXIgZT1kLmNvbnN0cnVjdG9yX2JvZHlbYXJndW1lbnRzLmxlbmd0aF07aWYodm9pZCAwPT09ZSl0aHJvdyBuZXcgJGUoIlRyaWVkIHRvIGludm9rZSBjdG9yIG9mICIrZisiIHdpdGggaW52YWxpZCBudW1iZXIgb2YgcGFyYW1ldGVycyAoIithcmd1bWVudHMubGVuZ3RoKyIpIC0gZXhwZWN0ZWQgKCIrT2JqZWN0LmtleXMoZC5jb25zdHJ1Y3Rvcl9ib2R5KS50b1N0cmluZygpKyIpIHBhcmFtZXRlcnMgaW5zdGVhZCEiKTtyZXR1cm4gZS5hcHBseSh0aGlzLGFyZ3VtZW50cyl9KSksYz1PYmplY3QuY3JlYXRlKGkse2NvbnN0cnVjdG9yOnt2YWx1ZTpzfX0pO3MucHJvdG90eXBlPWM7dmFyIGQ9bmV3IG50KGYscyxjLGgscixhLHUsbCksbT1uZXcgZ3QoZixkLCEwLCExLCExKSx5PW5ldyBndChmKyIqIixkLCExLCExLCExKSxFPW5ldyBndChmKyIgY29uc3QqIixkLCExLCEwLCExKTtyZXR1cm4gdHRbZV09e3BvaW50ZXJUeXBlOnksY29uc3RQb2ludGVyVHlwZTpFfSxmdW5jdGlvbihlLHQscil7by5oYXNPd25Qcm9wZXJ0eShlKXx8TGUoIlJlcGxhY2luZyBub25leGlzdGFudCBwdWJsaWMgc3ltYm9sIiksdm9pZCAwIT09b1tlXS5vdmVybG9hZFRhYmxlJiZ2b2lkIDAhPT1yP29bZV0ub3ZlcmxvYWRUYWJsZVtyXT10OihvW2VdPXQsb1tlXS5hcmdDb3VudD1yKX0ocCxzKSxbbSx5LEVdfSkpfSxfX2VtYmluZF9yZWdpc3Rlcl9jbGFzc19jb25zdHJ1Y3RvcjpmdW5jdGlvbihlLHQscixuLG8saSl7dmFyIGE9QXQodCxyKTtvPXZ0KG4sbykseGUoW10sW2VdLChmdW5jdGlvbihlKXt2YXIgcj0iY29uc3RydWN0b3IgIisoZT1lWzBdKS5uYW1lO2lmKHZvaWQgMD09PWUucmVnaXN0ZXJlZENsYXNzLmNvbnN0cnVjdG9yX2JvZHkmJihlLnJlZ2lzdGVyZWRDbGFzcy5jb25zdHJ1Y3Rvcl9ib2R5PVtdKSx2b2lkIDAhPT1lLnJlZ2lzdGVyZWRDbGFzcy5jb25zdHJ1Y3Rvcl9ib2R5W3QtMV0pdGhyb3cgbmV3ICRlKCJDYW5ub3QgcmVnaXN0ZXIgbXVsdGlwbGUgY29uc3RydWN0b3JzIHdpdGggaWRlbnRpY2FsIG51bWJlciBvZiBwYXJhbWV0ZXJzICgiKyh0LTEpKyIpIGZvciBjbGFzcyAnIitlLm5hbWUrIichIE92ZXJsb2FkIHJlc29sdXRpb24gaXMgY3VycmVudGx5IG9ubHkgcGVyZm9ybWVkIHVzaW5nIHRoZSBwYXJhbWV0ZXIgY291bnQsIG5vdCBhY3R1YWwgdHlwZSBpbmZvISIpO3JldHVybiBlLnJlZ2lzdGVyZWRDbGFzcy5jb25zdHJ1Y3Rvcl9ib2R5W3QtMV09ZnVuY3Rpb24oKXtidCgiQ2Fubm90IGNvbnN0cnVjdCAiK2UubmFtZSsiIGR1ZSB0byB1bmJvdW5kIHR5cGVzIixhKX0seGUoW10sYSwoZnVuY3Rpb24obil7cmV0dXJuIGUucmVnaXN0ZXJlZENsYXNzLmNvbnN0cnVjdG9yX2JvZHlbdC0xXT1mdW5jdGlvbigpe2FyZ3VtZW50cy5sZW5ndGghPT10LTEmJldlKHIrIiBjYWxsZWQgd2l0aCAiK2FyZ3VtZW50cy5sZW5ndGgrIiBhcmd1bWVudHMsIGV4cGVjdGVkICIrKHQtMSkpO3ZhciBlPVtdLGE9bmV3IEFycmF5KHQpO2FbMF09aTtmb3IodmFyIHM9MTtzPHQ7KytzKWFbc109bltzXS50b1dpcmVUeXBlKGUsYXJndW1lbnRzW3MtMV0pO3ZhciB1PW8uYXBwbHkobnVsbCxhKTtyZXR1cm4gRGUoZSksblswXS5mcm9tV2lyZVR5cGUodSl9LFtdfSkpLFtdfSkpfSxfX2VtYmluZF9yZWdpc3Rlcl9jbGFzc19mdW5jdGlvbjpmdW5jdGlvbihlLHQscixuLG8saSxhLHMpe3ZhciB1PUF0KHIsbik7dD16ZSh0KSxpPXZ0KG8saSkseGUoW10sW2VdLChmdW5jdGlvbihlKXt2YXIgbj0oZT1lWzBdKS5uYW1lKyIuIit0O2Z1bmN0aW9uIG8oKXtidCgiQ2Fubm90IGNhbGwgIituKyIgZHVlIHRvIHVuYm91bmQgdHlwZXMiLHUpfXMmJmUucmVnaXN0ZXJlZENsYXNzLnB1cmVWaXJ0dWFsRnVuY3Rpb25zLnB1c2godCk7dmFyIGM9ZS5yZWdpc3RlcmVkQ2xhc3MuaW5zdGFuY2VQcm90b3R5cGUsbD1jW3RdO3JldHVybiB2b2lkIDA9PT1sfHx2b2lkIDA9PT1sLm92ZXJsb2FkVGFibGUmJmwuY2xhc3NOYW1lIT09ZS5uYW1lJiZsLmFyZ0NvdW50PT09ci0yPyhvLmFyZ0NvdW50PXItMixvLmNsYXNzTmFtZT1lLm5hbWUsY1t0XT1vKToocnQoYyx0LG4pLGNbdF0ub3ZlcmxvYWRUYWJsZVtyLTJdPW8pLHhlKFtdLHUsKGZ1bmN0aW9uKG8pe3ZhciBzPVR0KG4sbyxlLGksYSk7cmV0dXJuIHZvaWQgMD09PWNbdF0ub3ZlcmxvYWRUYWJsZT8ocy5hcmdDb3VudD1yLTIsY1t0XT1zKTpjW3RdLm92ZXJsb2FkVGFibGVbci0yXT1zLFtdfSkpLFtdfSkpfSxfX2VtYmluZF9yZWdpc3Rlcl9lbXZhbDpmdW5jdGlvbihlLHQpe1llKGUse25hbWU6dD16ZSh0KSxmcm9tV2lyZVR5cGU6ZnVuY3Rpb24oZSl7dmFyIHQ9a3RbZV0udmFsdWU7cmV0dXJuIGZ1bmN0aW9uKGUpe2U+NCYmMD09LS1rdFtlXS5yZWZjb3VudCYmKGt0W2VdPXZvaWQgMCxTdC5wdXNoKGUpKX0oZSksdH0sdG9XaXJlVHlwZTpmdW5jdGlvbihlLHQpe3JldHVybiBSdCh0KX0sYXJnUGFja0FkdmFuY2U6OCxyZWFkVmFsdWVGcm9tUG9pbnRlcjpSZSxkZXN0cnVjdG9yRnVuY3Rpb246bnVsbH0pfSxfX2VtYmluZF9yZWdpc3Rlcl9mbG9hdDpmdW5jdGlvbihlLHQscil7dmFyIG49amUocik7WWUoZSx7bmFtZTp0PXplKHQpLGZyb21XaXJlVHlwZTpmdW5jdGlvbihlKXtyZXR1cm4gZX0sdG9XaXJlVHlwZTpmdW5jdGlvbihlLHQpe2lmKCJudW1iZXIiIT10eXBlb2YgdCYmImJvb2xlYW4iIT10eXBlb2YgdCl0aHJvdyBuZXcgVHlwZUVycm9yKCdDYW5ub3QgY29udmVydCAiJytPdCh0KSsnIiB0byAnK3RoaXMubmFtZSk7cmV0dXJuIHR9LGFyZ1BhY2tBZHZhbmNlOjgscmVhZFZhbHVlRnJvbVBvaW50ZXI6Q3QodCxuKSxkZXN0cnVjdG9yRnVuY3Rpb246bnVsbH0pfSxfX2VtYmluZF9yZWdpc3Rlcl9pbnRlZ2VyOmZ1bmN0aW9uKGUsdCxyLG4sbyl7dD16ZSh0KSwtMT09PW8mJihvPTQyOTQ5NjcyOTUpO3ZhciBpPWplKHIpLGE9ZnVuY3Rpb24oZSl7cmV0dXJuIGV9O2lmKDA9PT1uKXt2YXIgcz0zMi04KnI7YT1mdW5jdGlvbihlKXtyZXR1cm4gZTw8cz4+PnN9fXZhciB1PS0xIT10LmluZGV4T2YoInVuc2lnbmVkIik7WWUoZSx7bmFtZTp0LGZyb21XaXJlVHlwZTphLHRvV2lyZVR5cGU6ZnVuY3Rpb24oZSxyKXtpZigibnVtYmVyIiE9dHlwZW9mIHImJiJib29sZWFuIiE9dHlwZW9mIHIpdGhyb3cgbmV3IFR5cGVFcnJvcignQ2Fubm90IGNvbnZlcnQgIicrT3QocikrJyIgdG8gJyt0aGlzLm5hbWUpO2lmKHI8bnx8cj5vKXRocm93IG5ldyBUeXBlRXJyb3IoJ1Bhc3NpbmcgYSBudW1iZXIgIicrT3QocikrJyIgZnJvbSBKUyBzaWRlIHRvIEMvQysrIHNpZGUgdG8gYW4gYXJndW1lbnQgb2YgdHlwZSAiJyt0KyciLCB3aGljaCBpcyBvdXRzaWRlIHRoZSB2YWxpZCByYW5nZSBbJytuKyIsICIrbysiXSEiKTtyZXR1cm4gdT9yPj4+MDowfHJ9LGFyZ1BhY2tBZHZhbmNlOjgscmVhZFZhbHVlRnJvbVBvaW50ZXI6TnQodCxpLDAhPT1uKSxkZXN0cnVjdG9yRnVuY3Rpb246bnVsbH0pfSxfX2VtYmluZF9yZWdpc3Rlcl9tZW1vcnlfdmlldzpmdW5jdGlvbihlLHQscil7dmFyIG49W0ludDhBcnJheSxVaW50OEFycmF5LEludDE2QXJyYXksVWludDE2QXJyYXksSW50MzJBcnJheSxVaW50MzJBcnJheSxGbG9hdDMyQXJyYXksRmxvYXQ2NEFycmF5XVt0XTtmdW5jdGlvbiBvKGUpe3ZhciB0PU0scj10W2U+Pj0yXSxvPXRbZSsxXTtyZXR1cm4gbmV3IG4odC5idWZmZXIsbyxyKX1ZZShlLHtuYW1lOnI9emUociksZnJvbVdpcmVUeXBlOm8sYXJnUGFja0FkdmFuY2U6OCxyZWFkVmFsdWVGcm9tUG9pbnRlcjpvfSx7aWdub3JlRHVwbGljYXRlUmVnaXN0cmF0aW9uczohMH0pfSxfX2VtYmluZF9yZWdpc3Rlcl9zdGRfc3RyaW5nOmZ1bmN0aW9uKGUsdCl7WWUoZSx7bmFtZTp0PXplKHQpLGZyb21XaXJlVHlwZTpmdW5jdGlvbihlKXtmb3IodmFyIHQ9TVtlPj4yXSxyPW5ldyBBcnJheSh0KSxuPTA7bjx0OysrbilyW25dPVN0cmluZy5mcm9tQ2hhckNvZGUoT1tlKzQrbl0pO3JldHVybiBLdChlKSxyLmpvaW4oIiIpfSx0b1dpcmVUeXBlOmZ1bmN0aW9uKGUsdCl7ZnVuY3Rpb24gcihlLHQpe3JldHVybiBlW3RdfXZhciBuO3QgaW5zdGFuY2VvZiBBcnJheUJ1ZmZlciYmKHQ9bmV3IFVpbnQ4QXJyYXkodCkpLHQgaW5zdGFuY2VvZiBVaW50OEFycmF5fHx0IGluc3RhbmNlb2YgVWludDhDbGFtcGVkQXJyYXl8fHQgaW5zdGFuY2VvZiBJbnQ4QXJyYXk/bj1yOiJzdHJpbmciPT10eXBlb2YgdD9uPWZ1bmN0aW9uKGUsdCl7cmV0dXJuIGUuY2hhckNvZGVBdCh0KX06V2UoIkNhbm5vdCBwYXNzIG5vbi1zdHJpbmcgdG8gc3RkOjpzdHJpbmciKTt2YXIgbz10Lmxlbmd0aCxpPUp0KDQrbyk7TVtpPj4yXT1vO2Zvcih2YXIgYT0wO2E8bzsrK2Epe3ZhciBzPW4odCxhKTtzPjI1NSYmKEt0KGkpLFdlKCJTdHJpbmcgaGFzIFVURi0xNiBjb2RlIHVuaXRzIHRoYXQgZG8gbm90IGZpdCBpbiA4IGJpdHMiKSksT1tpKzQrYV09c31yZXR1cm4gbnVsbCE9PWUmJmUucHVzaChLdCxpKSxpfSxhcmdQYWNrQWR2YW5jZTo4LHJlYWRWYWx1ZUZyb21Qb2ludGVyOlJlLGRlc3RydWN0b3JGdW5jdGlvbjpmdW5jdGlvbihlKXtLdChlKX19KX0sX19lbWJpbmRfcmVnaXN0ZXJfc3RkX3dzdHJpbmc6ZnVuY3Rpb24oZSx0LHIpe3ZhciBuLG87cj16ZShyKSwyPT09dD8obj1mdW5jdGlvbigpe3JldHVybiBOfSxvPTEpOjQ9PT10JiYobj1mdW5jdGlvbigpe3JldHVybiBNfSxvPTIpLFllKGUse25hbWU6cixmcm9tV2lyZVR5cGU6ZnVuY3Rpb24oZSl7Zm9yKHZhciB0PW4oKSxyPU1bZT4+Ml0saT1uZXcgQXJyYXkociksYT1lKzQ+Pm8scz0wO3M8cjsrK3MpaVtzXT1TdHJpbmcuZnJvbUNoYXJDb2RlKHRbYStzXSk7cmV0dXJuIEt0KGUpLGkuam9pbigiIil9LHRvV2lyZVR5cGU6ZnVuY3Rpb24oZSxyKXt2YXIgaT1uKCksYT1yLmxlbmd0aCxzPUp0KDQrYSp0KTtNW3M+PjJdPWE7Zm9yKHZhciB1PXMrND4+byxjPTA7YzxhOysrYylpW3UrY109ci5jaGFyQ29kZUF0KGMpO3JldHVybiBudWxsIT09ZSYmZS5wdXNoKEt0LHMpLHN9LGFyZ1BhY2tBZHZhbmNlOjgscmVhZFZhbHVlRnJvbVBvaW50ZXI6UmUsZGVzdHJ1Y3RvckZ1bmN0aW9uOmZ1bmN0aW9uKGUpe0t0KGUpfX0pfSxfX2VtYmluZF9yZWdpc3Rlcl92YWx1ZV9vYmplY3Q6ZnVuY3Rpb24oZSx0LHIsbixvLGkpe1BlW2VdPXtuYW1lOnplKHQpLHJhd0NvbnN0cnVjdG9yOnZ0KHIsbikscmF3RGVzdHJ1Y3Rvcjp2dChvLGkpLGZpZWxkczpbXX19LF9fZW1iaW5kX3JlZ2lzdGVyX3ZhbHVlX29iamVjdF9maWVsZDpmdW5jdGlvbihlLHQscixuLG8saSxhLHMsdSxjKXtQZVtlXS5maWVsZHMucHVzaCh7ZmllbGROYW1lOnplKHQpLGdldHRlclJldHVyblR5cGU6cixnZXR0ZXI6dnQobixvKSxnZXR0ZXJDb250ZXh0Omksc2V0dGVyQXJndW1lbnRUeXBlOmEsc2V0dGVyOnZ0KHMsdSksc2V0dGVyQ29udGV4dDpjfSl9LF9fZW1iaW5kX3JlZ2lzdGVyX3ZvaWQ6ZnVuY3Rpb24oZSx0KXtZZShlLHtpc1ZvaWQ6ITAsbmFtZTp0PXplKHQpLGFyZ1BhY2tBZHZhbmNlOjAsZnJvbVdpcmVUeXBlOmZ1bmN0aW9uKCl7fSx0b1dpcmVUeXBlOmZ1bmN0aW9uKGUsdCl7fX0pfSxfYWJvcnQ6ZnVuY3Rpb24oKXtvLmFib3J0KCl9LF9lbXNjcmlwdGVuX21lbWNweV9iaWc6ZnVuY3Rpb24oZSx0LHIpe3JldHVybiBPLnNldChPLnN1YmFycmF5KHQsdCtyKSxlKSxlfSxfZ2V0ZW52OmZ1bmN0aW9uIGUodCl7cmV0dXJuIDA9PT10PzA6KHQ9dih0KSxNdC5oYXNPd25Qcm9wZXJ0eSh0KT8oZS5yZXQmJkt0KGUucmV0KSxlLnJldD0ocj1NdFt0XSxuPVMocikrMSwobz1KdChuKSkmJkEocixSLG8sbiksbykpOjApO3ZhciByLG4sb30sX2dldGdybmFtOmZ1bmN0aW9uKCl7by5wcmludEVycigibWlzc2luZyBmdW5jdGlvbjogZ2V0Z3JuYW0iKSxycigtMSl9LF9nZXRwd25hbTpmdW5jdGlvbigpe3Rocm93ImdldHB3bmFtOiBUT0RPIn0sX2pzQ2xvc2U6ZnVuY3Rpb24oKXtyZXR1cm4gYS5jbG9zZS5hcHBseShudWxsLGFyZ3VtZW50cyl9LF9qc0NyZWF0ZTpmdW5jdGlvbihlKXtyZXR1cm4gYS5jcmVhdGUuY2FsbChudWxsLGsoZSkpfSxfanNPcGVuOmZ1bmN0aW9uKGUpe3JldHVybiBhLm9wZW4uY2FsbChudWxsLGsoZSkpfSxfanNSZWFkOmZ1bmN0aW9uKCl7cmV0dXJuIGEucmVhZC5hcHBseShudWxsLGFyZ3VtZW50cyl9LF9qc1NlZWs6ZnVuY3Rpb24oZSx0LHIpe3JldHVybiBhLnNlZWsuY2FsbChudWxsLGUsdCxiKHIpKX0sX2pzVGVsbDpmdW5jdGlvbigpe3JldHVybiBhLnRlbGwuYXBwbHkobnVsbCxhcmd1bWVudHMpfSxfanNXcml0ZTpmdW5jdGlvbigpe3JldHVybiBhLndyaXRlLmFwcGx5KG51bGwsYXJndW1lbnRzKX0sX2xsdm1fZWhfdHlwZWlkX2ZvcjpmdW5jdGlvbihlKXtyZXR1cm4gZX0sX2xvY2FsdGltZTpmdW5jdGlvbihlKXtyZXR1cm4gZnVuY3Rpb24oZSx0KXtqdCgpO3ZhciByPW5ldyBEYXRlKDFlMypGW2U+PjJdKTtGW3Q+PjJdPXIuZ2V0U2Vjb25kcygpLEZbdCs0Pj4yXT1yLmdldE1pbnV0ZXMoKSxGW3QrOD4+Ml09ci5nZXRIb3VycygpLEZbdCsxMj4+Ml09ci5nZXREYXRlKCksRlt0KzE2Pj4yXT1yLmdldE1vbnRoKCksRlt0KzIwPj4yXT1yLmdldEZ1bGxZZWFyKCktMTkwMCxGW3QrMjQ+PjJdPXIuZ2V0RGF5KCk7dmFyIG49bmV3IERhdGUoci5nZXRGdWxsWWVhcigpLDAsMSksbz0oci5nZXRUaW1lKCktbi5nZXRUaW1lKCkpLzg2NGU1fDA7Rlt0KzI4Pj4yXT1vLEZbdCszNj4+Ml09LTYwKnIuZ2V0VGltZXpvbmVPZmZzZXQoKTt2YXIgaT1uZXcgRGF0ZSgyZTMsNiwxKS5nZXRUaW1lem9uZU9mZnNldCgpLGE9bi5nZXRUaW1lem9uZU9mZnNldCgpLHM9MHwoaSE9YSYmci5nZXRUaW1lem9uZU9mZnNldCgpPT1NYXRoLm1pbihhLGkpKTtGW3QrMzI+PjJdPXM7dmFyIHU9RltCdCsocz80OjApPj4yXTtyZXR1cm4gRlt0KzQwPj4yXT11LHR9KGUsSXQpfSxfbWt0aW1lOmZ1bmN0aW9uKGUpe2p0KCk7dmFyIHQ9bmV3IERhdGUoRltlKzIwPj4yXSsxOTAwLEZbZSsxNj4+Ml0sRltlKzEyPj4yXSxGW2UrOD4+Ml0sRltlKzQ+PjJdLEZbZT4+Ml0sMCkscj1GW2UrMzI+PjJdLG49dC5nZXRUaW1lem9uZU9mZnNldCgpLG89bmV3IERhdGUodC5nZXRGdWxsWWVhcigpLDAsMSksaT1uZXcgRGF0ZSgyZTMsNiwxKS5nZXRUaW1lem9uZU9mZnNldCgpLGE9by5nZXRUaW1lem9uZU9mZnNldCgpLHM9TWF0aC5taW4oYSxpKTtpZihyPDApRltlKzMyPj4yXT1OdW1iZXIoaSE9YSYmcz09bik7ZWxzZSBpZihyPjAhPShzPT1uKSl7dmFyIHU9TWF0aC5tYXgoYSxpKSxjPXI+MD9zOnU7dC5zZXRUaW1lKHQuZ2V0VGltZSgpKzZlNCooYy1uKSl9RltlKzI0Pj4yXT10LmdldERheSgpO3ZhciBsPSh0LmdldFRpbWUoKS1vLmdldFRpbWUoKSkvODY0ZTV8MDtyZXR1cm4gRltlKzI4Pj4yXT1sLHQuZ2V0VGltZSgpLzFlM3wwfSxfcHRocmVhZF9nZXRzcGVjaWZpYzpmdW5jdGlvbihlKXtyZXR1cm4gVXRbZV18fDB9LF9wdGhyZWFkX2tleV9jcmVhdGU6ZnVuY3Rpb24oZSx0KXtyZXR1cm4gMD09ZT9tZS5FSU5WQUw6KEZbZT4+Ml09enQsVXRbenRdPTAsenQrKywwKX0sX3B0aHJlYWRfb25jZTpmdW5jdGlvbiBlKHQscil7ZS5zZWVufHwoZS5zZWVuPXt9KSx0IGluIGUuc2Vlbnx8KG8uZHluQ2FsbF92KHIpLGUuc2Vlblt0XT0xKX0sX3B0aHJlYWRfc2V0c3BlY2lmaWM6ZnVuY3Rpb24oZSx0KXtyZXR1cm4gZSBpbiBVdD8oVXRbZV09dCwwKTptZS5FSU5WQUx9LF90aW1lOmZ1bmN0aW9uKGUpe3ZhciB0PURhdGUubm93KCkvMWUzfDA7cmV0dXJuIGUmJihGW2U+PjJdPXQpLHR9LERZTkFNSUNUT1BfUFRSOiQsU1RBQ0tUT1A6VX07dmFyIFd0PW8uYXNtKG8uYXNtR2xvYmFsQXJnLG8uYXNtTGlicmFyeUFyZyxEKTtvLmFzbT1XdDt2YXIgWXQ9by5fX0dMT0JBTF9fc3ViX0lfYmluZF9jcHA9ZnVuY3Rpb24oKXtyZXR1cm4gby5hc20uX19HTE9CQUxfX3N1Yl9JX2JpbmRfY3BwLmFwcGx5KG51bGwsYXJndW1lbnRzKX0sVnQ9by5fX0dMT0JBTF9fc3ViX0lfYnJpZGdlX2NwcD1mdW5jdGlvbigpe3JldHVybiBvLmFzbS5fX0dMT0JBTF9fc3ViX0lfYnJpZGdlX2NwcC5hcHBseShudWxsLGFyZ3VtZW50cyl9LEh0PW8uX19HTE9CQUxfX3N1Yl9JX2NyY19jcHA9ZnVuY3Rpb24oKXtyZXR1cm4gby5hc20uX19HTE9CQUxfX3N1Yl9JX2NyY19jcHAuYXBwbHkobnVsbCxhcmd1bWVudHMpfSxHdD1vLl9fR0xPQkFMX19zdWJfSV9nbG9iYWxfY3BwPWZ1bmN0aW9uKCl7cmV0dXJuIG8uYXNtLl9fR0xPQkFMX19zdWJfSV9nbG9iYWxfY3BwLmFwcGx5KG51bGwsYXJndW1lbnRzKX0scXQ9KG8uX19fY3hhX2Nhbl9jYXRjaD1mdW5jdGlvbigpe3JldHVybiBvLmFzbS5fX19jeGFfY2FuX2NhdGNoLmFwcGx5KG51bGwsYXJndW1lbnRzKX0sby5fX19jeGFfaXNfcG9pbnRlcl90eXBlPWZ1bmN0aW9uKCl7cmV0dXJuIG8uYXNtLl9fX2N4YV9pc19wb2ludGVyX3R5cGUuYXBwbHkobnVsbCxhcmd1bWVudHMpfSxvLl9fX2Vycm5vX2xvY2F0aW9uPWZ1bmN0aW9uKCl7cmV0dXJuIG8uYXNtLl9fX2Vycm5vX2xvY2F0aW9uLmFwcGx5KG51bGwsYXJndW1lbnRzKX0sby5fX19nZXRUeXBlTmFtZT1mdW5jdGlvbigpe3JldHVybiBvLmFzbS5fX19nZXRUeXBlTmFtZS5hcHBseShudWxsLGFyZ3VtZW50cyl9KSxYdD1vLl9lbXNjcmlwdGVuX3JlcGxhY2VfbWVtb3J5PWZ1bmN0aW9uKCl7cmV0dXJuIG8uYXNtLl9lbXNjcmlwdGVuX3JlcGxhY2VfbWVtb3J5LmFwcGx5KG51bGwsYXJndW1lbnRzKX0sS3Q9by5fZnJlZT1mdW5jdGlvbigpe3JldHVybiBvLmFzbS5fZnJlZS5hcHBseShudWxsLGFyZ3VtZW50cyl9LEp0PW8uX21hbGxvYz1mdW5jdGlvbigpe3JldHVybiBvLmFzbS5fbWFsbG9jLmFwcGx5KG51bGwsYXJndW1lbnRzKX0sWnQ9by5zZXRUZW1wUmV0MD1mdW5jdGlvbigpe3JldHVybiBvLmFzbS5zZXRUZW1wUmV0MC5hcHBseShudWxsLGFyZ3VtZW50cyl9LFF0PShvLnNldFRocmV3PWZ1bmN0aW9uKCl7cmV0dXJuIG8uYXNtLnNldFRocmV3LmFwcGx5KG51bGwsYXJndW1lbnRzKX0sby5zdGFja0FsbG9jPWZ1bmN0aW9uKCl7cmV0dXJuIG8uYXNtLnN0YWNrQWxsb2MuYXBwbHkobnVsbCxhcmd1bWVudHMpfSk7by5keW5DYWxsX2RpaT1mdW5jdGlvbigpe3JldHVybiBvLmFzbS5keW5DYWxsX2RpaS5hcHBseShudWxsLGFyZ3VtZW50cyl9LG8uZHluQ2FsbF9pPWZ1bmN0aW9uKCl7cmV0dXJuIG8uYXNtLmR5bkNhbGxfaS5hcHBseShudWxsLGFyZ3VtZW50cyl9LG8uZHluQ2FsbF9paT1mdW5jdGlvbigpe3JldHVybiBvLmFzbS5keW5DYWxsX2lpLmFwcGx5KG51bGwsYXJndW1lbnRzKX0sby5keW5DYWxsX2lpaT1mdW5jdGlvbigpe3JldHVybiBvLmFzbS5keW5DYWxsX2lpaS5hcHBseShudWxsLGFyZ3VtZW50cyl9LG8uZHluQ2FsbF9paWlpPWZ1bmN0aW9uKCl7cmV0dXJuIG8uYXNtLmR5bkNhbGxfaWlpaS5hcHBseShudWxsLGFyZ3VtZW50cyl9LG8uZHluQ2FsbF9paWlpaT1mdW5jdGlvbigpe3JldHVybiBvLmFzbS5keW5DYWxsX2lpaWlpLmFwcGx5KG51bGwsYXJndW1lbnRzKX0sby5keW5DYWxsX2lpaWlpaT1mdW5jdGlvbigpe3JldHVybiBvLmFzbS5keW5DYWxsX2lpaWlpaS5hcHBseShudWxsLGFyZ3VtZW50cyl9LG8uZHluQ2FsbF9paWlpaWlpPWZ1bmN0aW9uKCl7cmV0dXJuIG8uYXNtLmR5bkNhbGxfaWlpaWlpaS5hcHBseShudWxsLGFyZ3VtZW50cyl9LG8uZHluQ2FsbF9paWlpaWlpaWlpPWZ1bmN0aW9uKCl7cmV0dXJuIG8uYXNtLmR5bkNhbGxfaWlpaWlpaWlpaS5hcHBseShudWxsLGFyZ3VtZW50cyl9LG8uZHluQ2FsbF9paWlpaWlqaWk9ZnVuY3Rpb24oKXtyZXR1cm4gby5hc20uZHluQ2FsbF9paWlpaWlqaWkuYXBwbHkobnVsbCxhcmd1bWVudHMpfSxvLmR5bkNhbGxfaWpqPWZ1bmN0aW9uKCl7cmV0dXJuIG8uYXNtLmR5bkNhbGxfaWpqLmFwcGx5KG51bGwsYXJndW1lbnRzKX0sby5keW5DYWxsX2ppPWZ1bmN0aW9uKCl7cmV0dXJuIG8uYXNtLmR5bkNhbGxfamkuYXBwbHkobnVsbCxhcmd1bWVudHMpfSxvLmR5bkNhbGxfdj1mdW5jdGlvbigpe3JldHVybiBvLmFzbS5keW5DYWxsX3YuYXBwbHkobnVsbCxhcmd1bWVudHMpfSxvLmR5bkNhbGxfdmk9ZnVuY3Rpb24oKXtyZXR1cm4gby5hc20uZHluQ2FsbF92aS5hcHBseShudWxsLGFyZ3VtZW50cyl9LG8uZHluQ2FsbF92aWk9ZnVuY3Rpb24oKXtyZXR1cm4gby5hc20uZHluQ2FsbF92aWkuYXBwbHkobnVsbCxhcmd1bWVudHMpfSxvLmR5bkNhbGxfdmlpZD1mdW5jdGlvbigpe3JldHVybiBvLmFzbS5keW5DYWxsX3ZpaWQuYXBwbHkobnVsbCxhcmd1bWVudHMpfSxvLmR5bkNhbGxfdmlpaT1mdW5jdGlvbigpe3JldHVybiBvLmFzbS5keW5DYWxsX3ZpaWkuYXBwbHkobnVsbCxhcmd1bWVudHMpfSxvLmR5bkNhbGxfdmlpaWk9ZnVuY3Rpb24oKXtyZXR1cm4gby5hc20uZHluQ2FsbF92aWlpaS5hcHBseShudWxsLGFyZ3VtZW50cyl9LG8uZHluQ2FsbF92aWlpaWk9ZnVuY3Rpb24oKXtyZXR1cm4gby5hc20uZHluQ2FsbF92aWlpaWkuYXBwbHkobnVsbCxhcmd1bWVudHMpfSxvLmR5bkNhbGxfdmlpaWlpaT1mdW5jdGlvbigpe3JldHVybiBvLmFzbS5keW5DYWxsX3ZpaWlpaWkuYXBwbHkobnVsbCxhcmd1bWVudHMpfSxvLmR5bkNhbGxfdmlpaWlpaWlpaT1mdW5jdGlvbigpe3JldHVybiBvLmFzbS5keW5DYWxsX3ZpaWlpaWlpaWkuYXBwbHkobnVsbCxhcmd1bWVudHMpfSxvLmR5bkNhbGxfdmlpaWlpaWlpaWk9ZnVuY3Rpb24oKXtyZXR1cm4gby5hc20uZHluQ2FsbF92aWlpaWlpaWlpaS5hcHBseShudWxsLGFyZ3VtZW50cyl9LG8uZHluQ2FsbF92aWo9ZnVuY3Rpb24oKXtyZXR1cm4gby5hc20uZHluQ2FsbF92aWouYXBwbHkobnVsbCxhcmd1bWVudHMpfSxvLmR5bkNhbGxfdmlqaT1mdW5jdGlvbigpe3JldHVybiBvLmFzbS5keW5DYWxsX3ZpamkuYXBwbHkobnVsbCxhcmd1bWVudHMpfTtmdW5jdGlvbiBlcihlKXt0aGlzLm5hbWU9IkV4aXRTdGF0dXMiLHRoaXMubWVzc2FnZT0iUHJvZ3JhbSB0ZXJtaW5hdGVkIHdpdGggZXhpdCgiK2UrIikiLHRoaXMuc3RhdHVzPWV9ZnVuY3Rpb24gdHIoZSl7ZnVuY3Rpb24gdCgpe28uY2FsbGVkUnVufHwoby5jYWxsZWRSdW49ITAsbXx8KHRlfHwodGU9ITAsWChKKSksWChaKSxvLm9uUnVudGltZUluaXRpYWxpemVkJiZvLm9uUnVudGltZUluaXRpYWxpemVkKCksZnVuY3Rpb24oKXtpZihvLnBvc3RSdW4pZm9yKCJmdW5jdGlvbiI9PXR5cGVvZiBvLnBvc3RSdW4mJihvLnBvc3RSdW49W28ucG9zdFJ1bl0pO28ucG9zdFJ1bi5sZW5ndGg7KWU9by5wb3N0UnVuLnNoaWZ0KCksZWUudW5zaGlmdChlKTt2YXIgZTtYKGVlKX0oKSkpfXNlPjB8fCghZnVuY3Rpb24oKXtpZihvLnByZVJ1bilmb3IoImZ1bmN0aW9uIj09dHlwZW9mIG8ucHJlUnVuJiYoby5wcmVSdW49W28ucHJlUnVuXSk7by5wcmVSdW4ubGVuZ3RoOyllPW8ucHJlUnVuLnNoaWZ0KCksSy51bnNoaWZ0KGUpO3ZhciBlO1goSyl9KCksc2U+MHx8by5jYWxsZWRSdW58fChvLnNldFN0YXR1cz8oby5zZXRTdGF0dXMoIlJ1bm5pbmcuLi4iKSxzZXRUaW1lb3V0KChmdW5jdGlvbigpe3NldFRpbWVvdXQoKGZ1bmN0aW9uKCl7by5zZXRTdGF0dXMoIiIpfSksMSksdCgpfSksMSkpOnQoKSkpfWZ1bmN0aW9uIHJyKGUpe3Rocm93IG8ub25BYm9ydCYmby5vbkFib3J0KGUpLHZvaWQgMCE9PWU/KG8ucHJpbnQoZSksby5wcmludEVycihlKSxlPUpTT04uc3RyaW5naWZ5KGUpKTplPSIiLG09ITAsImFib3J0KCIrZSsiKS4gQnVpbGQgd2l0aCAtcyBBU1NFUlRJT05TPTEgZm9yIG1vcmUgaW5mby4ifWlmKG8uYXNtPVd0LGVyLnByb3RvdHlwZT1uZXcgRXJyb3IsZXIucHJvdG90eXBlLmNvbnN0cnVjdG9yPWVyLHVlPWZ1bmN0aW9uIGUoKXtvLmNhbGxlZFJ1bnx8dHIoKSxvLmNhbGxlZFJ1bnx8KHVlPWUpfSxvLnJ1bj10cixvLmV4aXQ9ZnVuY3Rpb24oZSx0KXt0JiZvLm5vRXhpdFJ1bnRpbWUmJjA9PT1lfHwoby5ub0V4aXRSdW50aW1lfHwobT0hMCxVPXZvaWQgMCxYKFEpLG8ub25FeGl0JiZvLm9uRXhpdChlKSksbCYmcHJvY2Vzcy5leGl0KGUpLG8ucXVpdChlLG5ldyBlcihlKSkpfSxvLmFib3J0PXJyLG8ucHJlSW5pdClmb3IoImZ1bmN0aW9uIj09dHlwZW9mIG8ucHJlSW5pdCYmKG8ucHJlSW5pdD1bby5wcmVJbml0XSk7by5wcmVJbml0Lmxlbmd0aD4wOylvLnByZUluaXQucG9wKCkoKTtyZXR1cm4gby5ub0V4aXRSdW50aW1lPSEwLHRyKCksdH07ZnVuY3Rpb24gaSh7cmVzb3VyY2VJZDplLHVybDp0fSl7cmV0dXJuIG5ldyBQcm9taXNlKChmdW5jdGlvbihlLG8pe2lmKCFyKXRocm93IG5ldyBFcnJvcigidW5wYWNrQnJpZGdlIG5vdCBkZXRlY3RlZCIpO2lmKCFuKXRocm93IG5ldyBFcnJvcigidW5wYWNrIG5vdCBkZXRlY3RlZCIpOyhmdW5jdGlvbihlKXtyZXR1cm4gZmV0Y2gobmV3IFJlcXVlc3QoZSkpLnRoZW4oZT0+e2lmKGUub2spcmV0dXJuIGUuYXJyYXlCdWZmZXIoKTt0aHJvdyBuZXcgRXJyb3IoIjQwNCBFcnJvcjogRmlsZSBub3QgZm91bmQuIil9KS50aGVuKGU9PnIuY3JlYXRlRXh0cmFjdG9yRnJvbURhdGEoZSkpfSkodCkudGhlbih0PT57ZSh0LmV4dHJhY3RBbGwoKSl9LGU9PntvKGUpfSl9KSl9ZnVuY3Rpb24gYShlLHQpe2NvbnN0W3Isbl09dDtpZigiRkFJTCI9PXIuc3RhdGUpe2NvbnN0IHQ9e3R5cGU6IkVSUk9SIixyZWFzb246ci5yZWFzb24sbXNnOnIubXNnLHJlc291cmNlSWQ6ZS5kYXRhLnJlc291cmNlSWQsdXJsOmUuZGF0YS51cmx9O3JldHVybiB2b2lkIHNlbGYucG9zdE1lc3NhZ2UodCl9Y29uc3Qgbz17dHlwZToiRklOSVNIRUQiLHJlc291cmNlSWQ6ZS5kYXRhLnJlc291cmNlSWQsZW50cmllczp7fX0saT1bXTtpZihuJiZuLmZpbGVzKWZvcihjb25zdCBlIG9mIG4uZmlsZXMpby5lbnRyaWVzW2UuZmlsZUhlYWRlci5uYW1lXT1lLmV4dHJhY3RbMV0saS5wdXNoKGUuZXh0cmFjdFsxXS5idWZmZXIpO3NlbGYucG9zdE1lc3NhZ2UobyxpKX1vbm1lc3NhZ2U9ZnVuY3Rpb24oZSl7aWYoImluaXQiPT1lLmRhdGEudHlwZSluPW8oZS5kYXRhLndhc21VcmwpLG4ub25SdW50aW1lSW5pdGlhbGl6ZWQ9KCk9PnBvc3RNZXNzYWdlKHt0eXBlOiJXQVNNX0xPQURFRCJ9KTtlbHNlIGlmKCJmZXRjaCI9PWUuZGF0YS50eXBlKWkoZS5kYXRhKS50aGVuKHQ9PnthKGUsdCl9LHQ9Pntjb25zdCByPXt0eXBlOiJFUlJPUiIscmVzb3VyY2VJZDplLmRhdGEucmVzb3VyY2VJZCx1cmw6ZS5kYXRhLnVybH07c2VsZi5wb3N0TWVzc2FnZShyKX0pO2Vsc2UgaWYoInVucGFjayI9PWUuZGF0YS50eXBlKXtjb25zdHtidWZmZXI6dH09ZS5kYXRhO2lmKCFyKXRocm93IG5ldyBFcnJvcigidW5wYWNrQnJpZGdlIG5vdCBkZXRlY3RlZCIpO2lmKCFuKXRocm93IG5ldyBFcnJvcigidW5wYWNrIG5vdCBkZXRlY3RlZCIpO2NvbnN0IG89ci5jcmVhdGVFeHRyYWN0b3JGcm9tRGF0YSh0KS5leHRyYWN0QWxsKCk7YShlLG8pfX07Cgo=",null,!1);function nt(t){return t&&"object"==typeof t&&!Array.isArray(t)}function lt(t,...i){if(!i.length)return t;const s=i.shift();if(nt(t)&&nt(s))for(const i in s)nt(s[i])?(t[i]||Object.assign(t,{[i]:{}}),lt(t[i],s[i])):Object.assign(t,{[i]:s[i]});return lt(t,...i)}const ht=new class{constructor(){let t;this.loaded=new v,this.progressIncremented=new v,this.allResourcesLoaded=new v,this.fileUpdated=new v,this.__totalWork=0,this.__totalWorkByCategory={},this.__doneWork=0,this.__doneWorkByCategory={},this.__resourceRegisterCallbacks={},this.__callbacks={},this.__resources={},this.__resourcesTreeEntities={},this.__resourcesTree={children:{}},this.__workers=[],this.__nextWorker=0;const i=document.getElementsByTagName("script");for(let s=0;s<i.length;s++){const e=i[s];if(e.src.includes("zea-engine")){const i=e.src.split("/");i.pop(),i.pop(),t=i.join("/");break}}t||(t="https://unpkg.com/@zeainc/zea-engine@0.1.3"),this.wasmUrl=t+"/public-resources/unpack.wasm",this.addResourceURL("ZeaEngine/Vive.vla",t+"/public-resources/Vive.vla"),this.addResourceURL("ZeaEngine/Oculus.vla",t+"/public-resources/Oculus.vla")}getRootFolder(){return this.__resourcesTree}registerResourceCallback(t,i){this.__resourceRegisterCallbacks[t]=i;for(const s in this.__resources){const e=this.__resources[s];e.name.includes(t)&&i(e)}}__applyCallbacks(t){const i=t=>{for(const i in this.__resourceRegisterCallbacks)t.name.includes(i)&&this.__resourceRegisterCallbacks[i](t)};for(const s in t){const e=t[s];e.url&&i(e)}}__buildTree(t){const i=s=>{if(this.__resourcesTreeEntities[s])return;const e=t[s];e.id=s,"folder"!==e.type&&"dependency"!==e.type||(e.children={}),e.parent&&(this.__resourcesTreeEntities[e.parent]||i(e.parent)),(e.parent?this.__resourcesTreeEntities[e.parent]:this.__resourcesTree).children[e.name]=e,this.__resourcesTreeEntities[s]=e};for(const s in t)i(s)}setResources(t){this.__resources=Object.assign(this.__resources,t),this.__buildTree(t),this.__applyCallbacks(t)}addResourceURL(t,i){const s=t.split("/"),e=s.pop();if(!i){let e=window.location.href.split("#")[0];e=e.split("?")[0],(e.endsWith(".html")||e.endsWith(".html"))&&(e=e.substring(0,e.lastIndexOf("/"))+"/");const n=e;if("."==s[0])s.shift();else if(".."==s[0]){item=item.substring(3);const t=n.split("/");t.pop(),t.pop(),n=t.join("/")+"/"}i=n+t}let n;const l={};for(const t of s){const i=h(t);i in this.__resources||(this.__resources[i]={name:t,type:"folder",parent:n},l[i]=this.__resources[i]),n=i}const o=h(e),a={name:e,url:i,parent:n,id:o};this.__resources[o]=a,l[o]=a,this.__buildTree(l),this.__applyCallbacks(l)}updateFile(t){const i=!(t.id in this.__resources);if(this.__resources[t.id]=t,i){console.log("New file added");const i={};i[t.id]=t,this.__buildTree(i)}this.fileUpdated.emit(t.id)}freeData(t){}__getWorker(){return this.__nextWorker=(this.__nextWorker+1)%3,null==this.__workers[this.__nextWorker]&&(this.__workers[this.__nextWorker]=(()=>new Promise(t=>{const i=new et;i.postMessage({type:"init",wasmUrl:this.wasmUrl}),i.onmessage=s=>{if("WASM_LOADED"===s.data.type)t(i);else if("FINISHED"===s.data.type)this.addWorkDone(s.data.resourceId,1),this.__onFinishedReceiveFileData(s.data);else if("ERROR"===s.data.type){const t=s.data,i=this.__resources[t.resourceId];console.error("Unable to load Resource:",i?i.name:t.resourceId," With url:",t.url)}}}))()),this.__workers[this.__nextWorker]}__terminateWorkers(){for(const t of this.__workers)t.terminate();this.__workers=[]}getFilepath(t){let i=this.__resources[t];const s=[i.name];for(;i.parent;)i=this.__resources[i.parent],s.splice(0,0,i.name);return s.join("/")}resourceAvailable(t){return t.indexOf(".")>0?(console.warn("Deprecation warning for resourceAvailable. Value should be a file id, not a path."),null!=this.resolveFilepath(t)):t in this.__resources}getFile(t){return this.__resources[t]}resolveFilePathToId(t){if(!t)return void console.warn("Invalid file path:",t);const i=this.resolveFilepath(t);return i?i.id:void 0}resolveFilepath(t){const i=t.split("/");"."!=i[0]&&""!=i[0]||i.shift();let s=this.__resourcesTree;for(const e of i){if(!(e in s.children))return console.warn("Unable to resolve key:"+e+" of path:"+t),null;s=s.children[e]}return s}resolveFile(t){return console.warn("Deprecation warning for resolveFile. Use resolveFilepath."),this.resolveFilepath(t)}resolveURL(t){console.warn("Deprecation warning for resolveURL. Use resolveFilepath.");const i=this.resolveFilepath(t);if(i)return i.url}addWork(t,i){this.__totalWork+=i,this.progressIncremented.emit(this.__doneWork/this.__totalWork*100)}addWorkDone(t,i){if(this.__doneWork+=i,this.progressIncremented.emit(this.__doneWork/this.__totalWork*100),this.__doneWork>this.__totalWork)throw new Error("Mismatch between work loaded and work done.");this.__doneWork==this.__totalWork&&this.allResourcesLoaded.emit()}loadResource(t,i,s=!0){const e=this.getFile(t);if(!e)throw new Error("Invalid resource Id:'"+t+"' not found in Resources:"+JSON.stringify(this.__resources,null,2));this.loadUrl(t,e.url,i,s)}loadURL(t,i,s,e=!0){return console.warn("Please call loadUrl instead,"),this.loadUrl(t,i,s,e)}loadUrl(t,i,s,e=!0){e&&this.addWork(t,3),t in this.__callbacks||(this.__callbacks[t]=[]),this.__callbacks[t].push(s),fetch(i).then(t=>function(t){if(!t.ok)throw new Error(`HTTP ${t.status} - ${t.statusText}`);return t}(t)&&t.arrayBuffer()).then(i=>{this.__getWorker().then(s=>{s.postMessage({type:"unpack",resourceId:t,buffer:i})})})}unpackBuffer(t,i,s,e=!0){return new Promise(n=>{e&&this.addWork(t,3),t in this.__callbacks||(this.__callbacks[t]=[]),s&&this.__callbacks[t].push(s),this.__callbacks[t].push(t=>{n(t)}),this.__getWorker().then(s=>{s.postMessage({type:"unpack",resourceId:t,buffer:i},[i])})})}__onFinishedReceiveFileData(t){const i=t.resourceId;this.addWorkDone(i,1);const s=this.__callbacks[i];if(s){for(const i of s)i(t.entries);delete this.__callbacks[i]}this.loaded.emit(i),this.addWorkDone(i,1)}suspend(){this.__terminateWorkers()}traverse(t){const i=t=>{for(const i in t.children)s(t.children[i])},s=s=>{if(0==t(s))return!1;s.children&&i(s)};i(this.__resourcesTree)}};class ot{constructor(t){if(t){const i=t.split("-"),s=i[0].split(".");this.major=parseInt(s[0]),this.minor=parseInt(s[1]),this.patch=parseInt(s[2]),2==i.length&&(this.branch=i[1])}else this.major=0,this.minor=0,this.patch=0}equals(t){return!(this.patch==t[2]&&this.minor==t[1]&&this.major==t[0])}lessThan(t){return!(this.major>=t[0]||this.minor>=t[1]||this.patch>=t[2])}greaterThan(t){return this.major>t[0]||this.minor>t[1]||this.patch>t[2]}greaterOrEqualThan(t){return!(this.major<t[0]||!(this.major>t[0])&&(this.minor<t[1]||!(this.minor>t[1])&&this.patch<t[2]))}}class ct{constructor(t,i=0,s=!0){this.__data=t,this.__byteOffset=i,this.__dataView=new DataView(this.__data),this.__isMobileDevice=s,this.utf8decoder=new TextDecoder}get isMobileDevice(){return this.__isMobileDevice}get data(){return this.__data}get byteLength(){return this.__dataView.byteLength}get remainingByteLength(){return this.__dataView.byteLength-this.__byteOffset}pos(){return this.__byteOffset}seek(t){this.__byteOffset=t}advance(t){this.__byteOffset+=t}loadUInt8(){const t=this.__dataView.getUint8(this.__byteOffset);return this.__byteOffset+=1,t}loadUInt16(){const t=this.__dataView.getUint16(this.__byteOffset,!0);return this.__byteOffset+=2,t}loadUInt32(){const t=this.__dataView.getUint32(this.__byteOffset,!0);return this.__byteOffset+=4,t}loadSInt32(){const t=this.__dataView.getInt32(this.__byteOffset,!0);return this.__byteOffset+=4,t}loadFloat16(){const t=this.loadUInt16();return Math.decode16BitFloat(t)}loadUFloat16(){const t=this.loadFloat16();return t<0?2048-t:t}loadFloat16From2xUInt8(){const t=this.__dataView.getFloat16(this.__byteOffset,!0);return this.__byteOffset+=2,t}loadUInt32From2xUFloat16(){return this.loadUFloat16()+4096*this.loadUFloat16()}loadSInt32From2xFloat16(){return this.loadFloat16()+2048*this.loadFloat16()}loadFloat32(){const t=this.__dataView.getFloat32(this.__byteOffset,!0);return this.__byteOffset+=4,t}loadUInt8Array(t,i=!1){null==t&&(t=this.loadUInt32());const s=new Uint8Array(this.__data,this.__byteOffset,t);return this.__byteOffset+=t,s}loadUInt16Array(t,i=!1){if(null==t&&(t=this.loadUInt32()),0==t)return new Uint16Array;let s;if(this.readPadd(2),this.__isMobileDevice){s=new Uint16Array(t);for(let i=0;i<t;i++)s[i]=this.__dataView.getUint16(this.__byteOffset,!0),this.__byteOffset+=2}else s=new Uint16Array(this.__data,this.__byteOffset,t),this.__byteOffset+=2*t;return s}loadUInt32Array(t,i=!1){if(null==t&&(t=this.loadUInt32()),0==t)return new Uint32Array;let s;if(this.readPadd(4),this.__isMobileDevice){s=new Uint32Array(t);for(let i=0;i<t;i++)s[i]=this.__dataView.getUint32(this.__byteOffset,!0),this.__byteOffset+=4}else s=new Uint32Array(this.__data,this.__byteOffset,t),this.__byteOffset+=4*t;return s}loadFloat32Array(t,i=!1){if(null==t&&(t=this.loadUInt32()),0==t)return new Float32Array;let s;if(this.readPadd(4),this.__isMobileDevice){s=new Float32Array(t);for(let i=0;i<t;i++)s[i]=this.__dataView.getFloat32(this.__byteOffset,!0),this.__byteOffset+=4}else s=new Float32Array(this.__data,this.__byteOffset,t),this.__byteOffset+=4*t;return s}loadStr(){const t=this.loadUInt32(),i=new Uint8Array(this.__data,this.__byteOffset,t);return this.__byteOffset+=t,this.utf8decoder.decode(i)}loadStrArray(){const t=this.loadUInt32(),i=[];for(let s=0;s<t;s++)i[s]=this.loadStr();return i}loadSInt32Vec2(){const t=this.loadSInt32(),i=this.loadSInt32();return new d(t,i)}loadUInt32Vec2(){const t=this.loadUInt32(),i=this.loadUInt32();return new d(t,i)}loadFloat16Vec2(){const t=this.loadFloat16(),i=this.loadFloat16();return new d(t,i)}loadFloat32Vec2(){const t=this.loadFloat32(),i=this.loadFloat32();return new d(t,i)}loadFloat16Vec3(){const t=this.loadFloat16(),i=this.loadFloat16(),s=this.loadFloat16();return new u(t,i,s)}loadFloat32Vec3(){const t=this.loadFloat32(),i=this.loadFloat32(),s=this.loadFloat32();return new u(t,i,s)}loadFloat16Quat(){const t=this.loadFloat16(),i=this.loadFloat16(),s=this.loadFloat16(),e=this.loadFloat16();return new f(t,i,s,e)}loadFloat32Quat(){const t=this.loadFloat32(),i=this.loadFloat32(),s=this.loadFloat32(),e=this.loadFloat32();return new f(t,i,s,e)}loadRGBFloat32Color(){const t=this.loadFloat32(),i=this.loadFloat32(),s=this.loadFloat32();return new p(t,i,s)}loadRGBAFloat32Color(){const t=this.loadFloat32(),i=this.loadFloat32(),s=this.loadFloat32(),e=this.loadFloat32();return new p(t,i,s,e)}loadRGBUInt8Color(){const t=this.loadUInt8(),i=this.loadUInt8(),s=this.loadUInt8();return new p(t/255,i/255,s/255)}loadRGBAUInt8Color(){const t=this.loadUInt8(),i=this.loadUInt8(),s=this.loadUInt8(),e=this.loadUInt8();return new p(t/255,i/255,s/255,e/255)}loadBox2(){return new R(this.loadFloat32Vec2(),this.loadFloat32Vec2())}loadBox3(){return new I(this.loadFloat32Vec3(),this.loadFloat32Vec3())}readPadd(t){const i=this.__byteOffset%t;0!=i&&(this.__byteOffset+=t-i)}}class rt{constructor(t=0){this.__data=new ArrayBuffer(t),this.__byteOffset=0,this.__reserved=t,this.__dataView=new DataView(this.__data)}pos(){return this.__byteOffset}seek(t){this.__byteOffset=t}seekEnd(){this.__byteOffset=this.__reserved}getBuffer(){return this.__data.byteLength==this.__byteOffset?this.__data:new Uint8Array(this.__data).slice(0,this.__byteOffset).buffer}__grow(){const t=2*(this.__reserved>0?this.__reserved:1),i=new ArrayBuffer(t),s=new Uint8Array(i),e=new Uint8Array(this.__data);s.set(e),this.__data=i,this.__dataView=new DataView(this.__data),this.__reserved=t}__reserve(t){this.__byteOffset+t>this.__reserved&&this.__grow()}__offset(t){this.__byteOffset+=t,this.__byteOffset>this.__reserved&&this.__grow()}writeUInt8(t){this.__reserve(1),this.__dataView.setUint8(this.__byteOffset,t),this.__offset(1)}writeUInt16(t){this.__reserve(2),this.__dataView.setUint16(this.__byteOffset,t,!0),this.__offset(2)}writeUInt32(t){this.__reserve(4),this.__dataView.setUint32(this.__byteOffset,t,!0),this.__offset(4)}writeSInt32(t){this.__reserve(4),this.__dataView.setInt32(this.__byteOffset,t,!0),this.__offset(4)}writeFloat16(t){const i=Math.encode16BitFloat(t);this.writeUInt16(i)}writeFloat32(t){this.__reserve(4),this.__dataView.setFloat32(this.__byteOffset,t,!0),this.__offset(4)}writeUInt8Array(t,i=!0){const s=t.size?t.size:t.length;this.__reserve(s+(i?4:0)),i&&this.writeUInt32(s);for(let i=0;i<s;i++)this.writeUInt8(t[i])}writeUInt16Array(t,i=!0){const s=t.size?t.size:t.length;this.__reserve(2*s+(i?4:0)),i&&this.writeUInt32(s);for(let i=0;i<s;i++)this.writeUInt16(t[i])}writeUInt32Array(t,i=!0){const s=t.size?t.size:t.length;this.__reserve(4*s+(i?4:0)),i&&this.writeUInt32(s);for(let i=0;i<s;i++)this.writeUInt32(t[i])}writeFloat32Array(t,i=!0){const s=t.size?t.size:t.length;this.__reserve(4*s+(i?4:0)),i&&this.writeUInt32(s);for(let i=0;i<s;i++)this.writeFloat32(t[i])}writeStr(t,i=!0){const s=value.length;this.__reserve(4*s+(i?4:0)),i&&this.writeUInt32(s);for(let t=0;t<s;t++)this.writeFloat32(value.charCodeAt(t))}writeSInt32Vec2(t){this.writeSInt32(t.x),this.writeSInt32(t.y)}writeUInt32Vec2(t){this.writeUInt32(t.x),this.writeUInt32(t.y)}writeFloat16Vec2(t){this.writeFloat16(t.x),this.writeFloat16(t.y)}writeFloat32Vec2(t){this.writeFloat32(t.x),this.writeFloat32(t.y)}writeFloat16Vec3(t){this.writeFloat16(t.x),this.writeFloat16(t.y),this.writeFloat16(t.z)}writeFloat32Vec3(t){this.writeFloat32(t.x),this.writeFloat32(t.y),this.writeFloat32(t.z)}writeFloat16Quat(t){this.writeFloat16(t.x),this.writeFloat16(t.y),this.writeFloat16(t.z),this.writeFloat16(t.w)}writeFloat32Quat(t){this.writeFloat32(t.x),this.writeFloat32(t.y),this.writeFloat32(t.z),this.writeFloat32(t.w)}writeRGBFloat32Color(t){this.writeFloat32(t.r),this.writeFloat32(t.g),this.writeFloat32(t.b)}writeRGBAFloat32Color(t){this.writeFloat32(t.r),this.writeFloat32(t.g),this.writeFloat32(t.b),this.writeFloat32(t.a)}writeRGBUInt8Color(t){this.writeUInt8(t.r),this.writeUInt8(t.g),this.writeUInt8(t.b)}writeRGBAUInt8Color(t){this.writeUInt8(t.r),this.writeUInt8(t.g),this.writeUInt8(t.b),this.writeUInt8(t.a)}writeBox2(t){this.writeFloat32Vec2(t.p0),this.writeFloat32Vec2(t.p1)}writeBox3(t){this.writeFloat32Vec3(t.p0),this.writeFloat32Vec3(t.p1)}writePadd(t){const i=t-this.__byteOffset;this.__reserve(i),this.__offset(i)}writeAlignment(t){const i=this.__byteOffset%t;0!=i&&(this.__reserve(t-i),this.__offset(t-i))}}class dt{constructor(t,i){this.__name=t,this.__cb=i,this.__flags=0}getName(){return this.__name}getOwner(){return this.__ownerItem}setOwner(t){this.__ownerItem!==t&&(this.__ownerItem=t)}getPath(){if(this.__ownerItem){if(this.__ownerItem.getPath){const t=this.__ownerItem.getPath().slice();return t.push(this.__name),t}return[this.__ownerItem.getName(),this.__name]}return[this.__name]}setEnabled(t){t?this.__flags&=-5:this.__flags|=-5}isEnabled(){}invoke(){this.__cb()}}class ut extends U{constructor(t,i=0,s,e){super(t,i,"Number"),s&&!Array.isArray(s)&&console.error("Range value must be an array of 2 numbers."),this.__range=s,this.__step=e}setValue(t,i){i==J.USER_SETVALUE&&(this.__range&&(t=Math.clamp(t,this.__range[0],this.__range[1])),this.__step&&(t=Math.round(t/this.__step)*this.__step)),super.setValue(t,i)}getValue(t){return super.getValue(t)}getRange(){return this.__range}setRange(t){return this.__range=t,this}getStep(){return this.__step}setStep(t){return this.__step=t,this}toJSON(t,i){const s=super.toJSON(t,i);return this.__range&&(s.range=this.__range),this.__step&&(s.step=this.__step),s}fromJSON(t,i,s){super.fromJSON(t,i,s),t.range&&(this.__range=t.range),t.step&&(this.__step=t.step)}readBinary(t,i){const s=t.loadFloat32();this.setValue(s,J.DATA_LOAD)}clone(t){const i=new ut(this.__name,this.__value);return i.__range=this.__range,i.__step=this.__step,i}}N.registerClass("NumberParameter",ut),N.registerClass("Property_SInt32",ut),N.registerClass("Property_UInt32",ut),N.registerClass("Property_Float32",ut);class mt extends ut{constructor(t,i,s){super(t,i,[0,s.length],1),this.choices=s}getChoices(){return this.choices}setValue(t,i){super.setValue("string"==typeof t?this.choices.indexOf(t):t,i)}}class bt extends U{constructor(t,i){super(t,i,"Boolean")}clone(t){return new bt(this.__name,this.__value)}}N.registerClass("BooleanParameter",bt);class Zt extends U{constructor(t,i,s){super(t,i||new d,"Vec2"),this.__range=s}getRange(){return this.__range}__setRange(t){this.__range=t,this.rangeChanged.emit()}clone(t){return new Zt(this.__name,this.__value.clone())}}class pt extends U{constructor(t,i,s){super(t,i||new u,"Vec3")}clone(t){return new pt(this.__name,this.__value.clone())}}class Gt extends U{constructor(t,i){super(t,i||new m,"Vec4")}clone(t){return new Gt(this.__name,this.__value.clone())}}class Xt extends U{constructor(t,i){super(t,i||new p,"Color")}readBinary(t,i){const s=t.loadRGBAFloat32Color();s.applyGamma(2.2),this.setValue(s,J.DATA_LOAD)}clone(t){return new Xt(this.__name,this.__value.clone())}}N.registerClass("ColorParameter",Xt);class yt extends U{constructor(t,i){super(t,i||new X,"Mat3")}clone(t){return new yt(this.__name,this.__value.clone())}}class ft extends U{constructor(t,i){super(t,i||new y,"Mat4")}clone(t){return new ft(this.__name,this.__value.clone())}}class Vt extends U{constructor(t,i){super(t,i||new g,"Xfo")}clone(t){return new Vt(this.__name,this.__value.clone())}}class gt extends U{constructor(t,i){super(t,i,"BaseImage"),this.valueParameterValueChanged=new v}toJSON(t,i){const s=super.toJSON(t,i);return this.__value&&(s.imageType=this.__value.constructor.name),s}fromJSON(t,i,s){return t.imageType&&(this.__value=N.constructClass(t.imageType)),super.fromJSON(t,i,s)}clone(t){return new gt(this.__name,this.__value)}}class Rt extends U{constructor(t,i=""){super(t,i,"String"),this.multiLine=!1}setMultiLine(t){this.multiLine=t}getMultiLine(){return this.multiLine}readBinary(t,i){const s=t.loadStr();this.setValue(s,J.DATA_LOAD)}clone(t){return new Rt(this.__name,this.__value)}}N.registerClass("StringParameter",Rt),N.registerClass("Property_String",Rt);class Wt extends Rt{constructor(t,i=""){super(t,i,"String"),this.lang="js"}setLanguage(t){this.lang=t}getLanguage(){return this.lang}clone(t){return new Wt(this.__name,this.__value)}}N.registerClass("CodeParameter",Wt);class It extends U{constructor(t,i){super(t,"","FilePath"),this.fileUpdated=new v,i&&this.setSupportedExts(i)}setSupportedExts(t){this.__reextensions=new RegExp("\\.("+t+")$","i")}getFilepath(){return this.__file?ht.getFilepath(this.__file.id):""}setFilepath(t,i){const s=ht.resolveFilePathToId(t);s?this.setValue(s,i):console.warn("Resource unavailable:"+t)}getFilename(){if(this.__file)return this.__file.name}getExt(){const t=this.getFilename(),i=t.lastIndexOf(".");if(-1!=i)return t.substring(i).toLowerCase()}getStem(){const t=this.getFilename();if(t){const i=t.split(".");return 2==i.length?i[0]:t}}getFileFolder(){if(this.__file)return this.__file.parent?ht.getFile(this.__file.parent):ht.getRootFolder()}getFileFolderPath(){const t=this.getFilepath();if(t)return t.substring(0,t.lastIndexOf("/"))+"/"}getFile(){return this.__file}getFileDesc(){return this.__file}setUrl(t,i,s=J.USER_SETVALUE){const e=t.split("/");i||(i=e[e.length-1]),this.__value=i,this.__file={id:t,name:i,url:t},s!=J.USER_SETVALUE&&s!=J.REMOTEUSER_SETVALUE||(this.__flags|=z.USER_EDITED),this.valueChanged.emit(s)}getUrl(){return this.__file?this.__file.url:void 0}setDirty(t){throw new Error("Cannot drive a filepath param from an oporator")}setValue(t,i=J.USER_SETVALUE){if(null==t)throw new Error("Invalid value for setValue.");if(t.indexOf(".")>0)return console.warn("Deprecation warning for setValue. setValue should now only take a file id, not a path."),this.setFilepath(t,i);if(t==this.__value)return;const s=t;if(!ht.resourceAvailable(s))return void console.warn("Resource unavailable:"+s);const e=ht.getFile(s);if(this.__reextensions&&!this.__reextensions.test(e.name))return console.warn("Unsupported file type:"+e.name),!1;this.__value=t,this.__file=e,ht.fileUpdated.connect(t=>{t==this.__value&&(this.__file=ht.getFile(this.__value),this.fileUpdated.emit())}),i==J.USER_SETVALUE&&(this.__flags|=z.USER_EDITED),this.valueChanged.emit(i)}toJSON(t,i){if(0==(this.__flags&z.USER_EDITED))return;const s={};return this.__file&&(s.value=this.__file.id,s.filepath=ht.getFilepath(this.__file.id)),s}fromJSON(t,i,s){if(t.value){if(t.value.indexOf(".")>0)return void this.setFilepath(t.value,J.DATA_LOAD);if(ht.resourceAvailable(t.value))return this.setValue(t.value,J.DATA_LOAD),void(this.__flags|=z.USER_EDITED)}if(t.filepath){const i=ht.resolveFilePathToId(t.filepath);if(i)return void this.setValue(i,J.DATA_LOAD);console.warn("Resource unavailable:"+t.filepath)}}clone(t){const i=new It(this.__name);return i.__file=this.__file,i}destroy(){super.destroy()}}class St extends U{constructor(t,i){super(t,[]),this.__dataType=i,this.elementAdded=new v,this.elementRemoved=new v}__filter(t){return!0}getCount(){return this.__value.length}getElement(t){return this.__value[t]}setElement(t,i){this.__value[t]=i,this.valueChanged.emit(J.USER_SETVALUE)}addElement(t){if(null==t)t=new this.__dataType;else if(!this.__filter(t))return;return this.__value.push(t),this.__flags|=z.USER_EDITED,this.elementAdded.emit(t,this.__value.length-1),this.valueChanged.emit(J.USER_SETVALUE),t}removeElement(t){const i=this.__value[t];this.__value.splice(t,1),this.__flags|=z.USER_EDITED,this.elementRemoved.emit(i,t),this.valueChanged.emit(J.USER_SETVALUE)}insertElement(t,i){this.__filter(i)&&(this.__value.splice(t,0,i),this.__flags|=z.USER_EDITED,this.elementAdded.emit(i,t),this.valueChanged.emit(J.USER_SETVALUE))}toJSON(t,i){if(0==(this.__flags&z.USER_EDITED))return;const s=[];for(const e of this.__value)s.push("string"==typeof this.__dataType?e:e.toJSON(t,i));return{items:s}}fromJSON(t,i,s){if(null!=t.items){this.__flags|=z.USER_EDITED,this.__value=[];for(let s=0;s<t.items.length;s++){let e;"string"==typeof this.__dataType?e=t.items[s]:(e=new this.__dataType,e.fromJSON(t.items[s],i)),this.__value.push(e),this.elementAdded.emit(e,this.__value.length-1)}this.valueChanged.emit(J.DATA_LOAD)}else console.warn("Invalid Parameter JSON")}clone(t){const i=this.__value.slice(0),s=new St(this.__name,this.__dataType);return s.setValue(i),s}destroy(){for(let t=0;t<this.__value.length;t++)this.__value[t]instanceof U&&this.__value[t].destroy(),this.removeElement(t)}}class Lt extends U{constructor(t){super(t,{},"Struct"),this.__members=[]}_addMember(t){return this.__value[t.getName()]=t.getValue(),t.valueChanged.connect(()=>{this.__value[t.getName()]=t.getValue()}),this.__members.push(t),this.__flags|=z.USER_EDITED,this.valueChanged.emit(),t}getParameter(t){for(const i of this.__members)if(i.getName()==t)return i}getMember(t){return this.getParameter(t)}getMemberNames(){const t=[];for(let i=0;i<this.__members.length;i++){const s=this.__members[i];null!=s&&(t[i]=s.getName())}return t}toJSON(t,i){if(0==(this.__flags&z.USER_EDITED))return;const s=[];for(const e of this.__members)s.push(e.toJSON(t,i));return{members:s}}fromJSON(t,i,s){if(null!=t.members){this.__flags|=z.USER_EDITED;for(let s=0;s<t.members.length;s++)t.members[s]&&this.__members[s].fromJSON(t.members[s],i)}else console.warn("Invalid Parameter JSON")}destroy(){super.destroy();for(const t of this.__members)t.destroy()}}class xt extends U{constructor(t,i){super(t,void 0,"TreeItem"),this.__filterFn=i,this.treeItemGlobalXfoChanged=new v}setOwner(t){this.__owner=t}getOwner(){return this.__owner}setFilterFn(){this.__filterFn=filterFn}getFilterFn(){return this.__filterFn}setValue(t,i=J.USER_SETVALUE){if(this.__filterFn&&!this.__filterFn(t))return!1;this.__value!==t&&(this.__value&&this.__value.globalXfoChanged.disconnect(this.treeItemGlobalXfoChanged.emit),this.__value=t,this.__value&&this.__value.globalXfoChanged.connect(this.treeItemGlobalXfoChanged.emit),i!=J.USER_SETVALUE&&i!=J.REMOTEUSER_SETVALUE||(this.__flags|=z.USER_EDITED),this.valueChanged.emit(i))}toJSON(t,i){if(0!=(this.__flags&z.USER_EDITED))return{value:t.makeRelative(this.__value.getPath())}}fromJSON(t,i,s){null!=t.value?(i.resolvePath(t.value,t=>{this.setValue(t)},()=>{console.warn("Unable to resolve tree item parameter value:"+pj.paramPath)}),this.__flags|=z.USER_EDITED):console.warn("Invalid Parameter JSON")}clone(t){return new xt(this.__name,this.__filterFn)}destroy(){this.__value&&this.__value.parameterValueChanged.disconnect(this.valueParameterValueChanged.emit)}}class vt extends U{constructor(t,i){super(t,void 0,"BaseItem"),this.__items=new Set,this.__filterFn=i,this.itemAdded=new v,this.itemRemoved=new v}setFilterFn(t){this.__filterFn=t}getFilterFn(){return this.__filterFn}getItem(t){return Array.from(this.__items)[t]}addItem(t,i=!0){if(this.__filterFn&&!this.__filterFn(t))return console.warn("ItemSet __filterFn rejecting item:",t.getPath()),!1;this.__items.add(t);const s=Array.from(this.__items).indexOf(t);return this.itemAdded.emit(t,s),i&&this.valueChanged.emit(),s}addItems(t,i=!0){t.forEach(t=>this.addItem(t,!1)),i&&this.valueChanged.emit()}removeItem(t,i=!0){const s=Array.from(this.__items)[t];return this.__items.delete(s),this.itemRemoved.emit(s,t),i&&this.valueChanged.emit(),s}setItems(t,i=!0){for(let i=this.__items.length-1;i>=0;i--){const s=this.__items[i];t.has(s)||this.removeItem(s,!1)}for(const i of t)this.__items.has(i)||this.addItem(i,!1);i&&this.valueChanged.emit()}clearItems(t=!0){this.__items.clear(),t&&this.valueChanged.emit()}getNumItems(){return Array.from(this.__items).length}getValue(){return this.__items}toJSON(t,i){return{}}fromJSON(t,i,s){}clone(t){return new vt(this.__name,this.__filterFn)}}class Yt extends U{constructor(t,i){super(t,void 0,i.getDataType()),this.setSourceParameter(i)}setSourceParameter(t){this.sourceParameter=t,this.sourceParameter.valueChanged.connect(this.__proxyValueChanged.bind(this))}__proxyValueChanged(t){this.valueChanged.emit(t)}getDataType(){return this.sourceParameter.getDataType()}setValue(t,i){}getValue(t){return this.sourceParameter.getValue(t)}toJSON(t,i){const s=super.toJSON(t,i);return this.sourceParameter&&(s.sourceParameter=this.sourceParameter.getPath()),s}fromJSON(t,i,s){super.fromJSON(t,i,s),t.sourceParameter&&i.resolvePath(t.sourceParameter,t=>{this.setSourceParameter(t)},()=>{console.warn("Error loading Proxy Param: '"+this.getName()+"'. Unable to connect to:"+t.sourceParameter)}),t.range&&(this.sourceParameter=t.range),t.step&&(this.__step=t.step)}clone(t,i){const s=new Yt(this.__name,this.__value);return this.sourceParameter&&this.connectToClonedSourceParam(i),s}connectToClonedSourceParam(t){t.resolveClonedItem(this.sourceParameter,t=>{clonedParam.setSourceParameter(t)},()=>{console.warn("Error cloning Proxy Param: '"+this.getName()+"'. Unable to connect to:"+j.sourceParameter)})}}N.registerClass("ProxyParameter",Yt);class Mt extends U{constructor(t,i){super(t,void 0,"Geometry"),this.boundingBoxDirtied=new v,this.setValue(i)}setValue(t,i=J.USER_SETVALUE){this.__value!==t&&(this.__value&&this.__value.boundingBoxDirtied.disconnect(this.boundingBoxDirtied.emit),this.__value=t,this.__value&&this.__value.boundingBoxDirtied.connect(this.boundingBoxDirtied.emit),i!=J.USER_SETVALUE&&i!=J.REMOTEUSER_SETVALUE||(this.__flags|=z.USER_EDITED),i!=J.OPERATOR_SETVALUE&&this.valueChanged.emit(i))}toJSON(t,i){return super.toJSON(t,i)}fromJSON(t,i,s){return super.fromJSON(t,i,s)}clone(t){return new Mt(this.__name,this.__value)}destroy(){this.__value&&this.__value.boundingBoxDirtied.disconnect(this.boundingBoxDirtied.emit)}}class Kt extends Q{constructor(t){super(t),this.width=0,this.height=0,this.format="RGB",this.type="UNSIGNED_BYTE",this.addParameter(new bt("AlphaFromLuminance",!1)),this.addParameter(new bt("Invert",!1)),this.addParameter(new bt("FlipY",!1)),this.updated=this.parameterValueChanged,this.loaded=new v(!0)}isLoaded(){return!0}getMapping(){return this.__mapping}setMapping(t){this.__mapping=t}isStream(){return!1}isStreamAtlas(){return this.__streamAtlas}getParams(){return{type:this.type,format:this.format,width:this.width,height:this.height,flipY:this.getParameter("FlipY").getValue(),invert:this.getParameter("Invert").getValue(),alphaFromLuminance:this.getParameter("AlphaFromLuminance").getValue()}}}class Ct extends ut{constructor(t,i,s){super(t,i,s),this.textureConnected=new v,this.textureDisconnected=new v}getImage(){return this.__image}setImage(t,i=0){const s=()=>{this.textureDisconnected.emit()};t?(null!=this.__image&&this.__image!==t&&s(),this.__image=t,this.textureConnected.emit(),this.valueChanged.emit(i)):null!=this.__image&&(s(),this.__image=void 0,this.textureDisconnected.emit())}setValue(t){t instanceof Kt?this.setImage(t):(null!=this.__image&&this.setImage(void 0),super.setValue(t))}readBinary(t,i){super.readBinary(t,i);const s=t.loadStr();""!=s&&(console.log("Load Texture"),this.setImage(i.materialLibrary.getImage(s)))}clone(t){return new Ct(this.__name,this.__value.clone())}}N.registerClass("MaterialFloatParam",Ct);class wt extends Xt{constructor(t,i){super(t,i),this.textureConnected=new v,this.textureDisconnected=new v,this.__imageUpdated=this.__imageUpdated.bind(this)}getImage(){return this.__image}__imageUpdated(){this.valueChanged.emit()}setImage(t,i=0){const s=()=>{this.__image.loaded.disconnect(this.__imageUpdated),this.__image.updated.disconnect(this.__imageUpdated),this.__image=null,this.textureDisconnected.emit()};t?(null!=this.__image&&this.__image!==t&&s(),this.__image=t,this.__image.updated.connect(this.__imageUpdated),this.textureConnected.emit(),this.valueChanged.emit(i)):null!=this.__image&&(s(),this.__image=void 0,this.textureDisconnected.emit())}setValue(t){t instanceof Kt?this.setImage(t):(null!=this.__image&&this.setImage(void 0),super.setValue(t))}readBinary(t,i){super.readBinary(t,i);const s=t.loadStr();""!=s&&this.setImage(i.materialLibrary.getImage(s))}clone(t){return new wt(this.__name,this.__value.clone())}}N.registerClass("MaterialColorParam",wt);const Ft=(t,i,s,e)=>"boolean"==typeof i||!1===i||!0===i?new U(t,i,"Boolean"):"string"==typeof i?new U(t,i,"String"):Number.isNumeric(i)?e?new Ct(t,i,s):new ut(t,i,s):i instanceof d?new Zt(t,i):i instanceof u?new pt(t,i):i instanceof p?e?new wt(t,i):new Xt(t,i):new U(t,i);class Nt extends Q{constructor(t,i){super(t),this.shaderNameChanged=new v,this.visibleInGeomDataBuffer=!0,i&&this.setShaderName(i)}getShaderName(){return this.__shaderName}setShaderName(t){if(this.__shaderName==t)return;const i=N.getClass(t);if(!i)throw new Error("Error setting Shader. Shader not found:"+t);const s=i.getParamDeclarations(),e={};for(const t of s){let i=this.getParameter(t.name);i||(i=this.addParameter(Ft(t.name,t.defaultValue,t.range,0!=t.texturable))),e[t.name]=!0}for(const t of this.__params)e[t.getName()]||this.removeParameter(t.getName());this.__shaderName=t,this.shaderNameChanged.emit(this.__shaderName)}removeAllTextures(){for(const t of this.__params)t.getImage&&t.getImage()&&t.setImage(void 0)}getParamTextures(){const t={};for(const i of this.__params)i.getImage&&i.getImage()&&(t[i.getName()]=i.getImage());return t}__makeParameterTexturable(t){makeParameterTexturable(t)}isTransparent(){const t=this.getParameter("Opacity");if(t&&(t.getValue()<.99||t.getImage()))return!0;const i=this.getParameter("BaseColor");return!(!i||!i.getImage()||"RGBA"!=i.getImage().format)}getShaderClass(){return N.getClass(this.getShaderName())}modifyParams(t,i){i&&this.setShaderName(i);for(const i in t){const s=this.getParameter(i);s&&(t[i]instanceof U?this.replaceParameter(t[i]):s.setValue(t[i]))}}toJSON(t,i=0){return super.toJSON(t,i)}fromJSON(t,i={},s=0){t.shader?(this.setShaderName(t.shader),super.fromJSON(t,i,s)):console.warn("Invalid Material JSON")}readBinary(t,i){let s=t.loadStr();if("StandardMaterial"==s&&(s="StandardSurfaceShader"),"TransparentMaterial"==s&&(s="TransparentSurfaceShader"),this.setShaderName(s),i.versions["zea-engine"].lessThan([0,0,3])){this.setName(t.loadStr());const s=t.loadUInt32();for(let n=0;n<s;n++){const s=(e=t.loadStr()).charAt(0).toUpperCase()+e.slice(1);let n;"MaterialColorParam"==t.loadStr()?(n=t.loadRGBAFloat32Color(),n.applyGamma(2.2)):n=t.loadFloat32();const l=t.loadStr();let h=this.getParameter(s);h?h.setValue(n):h=this.addParameter(Ft(s,n)),""!=l&&h.setImage&&(i.materialLibrary.hasImage(l)?h.setImage(i.materialLibrary.getImage(l)):console.warn("Missing Texture:"+l))}}else super.readBinary(t,i);var e}clone(t){const i=new Nt;return i.copyFrom(this,t),i}copyFrom(t,i){super.copyFrom(t,i),this.setShaderName(t.getShaderName());for(const i of t.getParameters()){const s=t.getParameter(i.getName());i.getImage||this.__makeParameterTexturable(s)}}destroy(){this.removeAllTextures(),super.destroy()}}class Tt extends Kt{constructor(t){super(),null==t&&(t=this.constructor.name),this.__name=t,this.format="RGBA",this.type="UNSIGNED_BYTE",this.__loaded=!1,this.width=1,this.height=1}isLoaded(){return this.__loaded}getName(){return this.__name}isStream(){return!1}setData(t,i,s){this.width=t,this.height=i,this.__data=s,this.__loaded?this.updated.emit():(this.__loaded=!0,this.loaded.emit())}getParams(){const t=super.getParams();return t.data=this.__data,t}}function Jt(t){this.data=t,this.pos=0}function zt(t){this.stream=new Jt(t),this.output={}}N.registerClass("DataImage2D",Tt),N.registerClass("DataImage",Tt),Jt.prototype.readByte=function(){return this.data[this.pos++]},Jt.prototype.peekByte=function(){return this.data[this.pos]},Jt.prototype.readBytes=function(t){for(var i=new Array(t),s=0;s<t;s++)i[s]=this.readByte();return i},Jt.prototype.peekBytes=function(t){for(var i=new Array(t),s=0;s<t;s++)i[s]=this.data[this.pos+s];return i},Jt.prototype.readString=function(t){for(var i="",s=0;s<t;s++)i+=String.fromCharCode(this.readByte());return i},Jt.prototype.readBitArray=function(){for(var t=[],i=this.readByte(),s=7;s>=0;s--)t.push(!!(i&1<<s));return t},Jt.prototype.readUnsigned=function(t){var i=this.readBytes(2);return t?(i[1]<<8)+i[0]:(i[0]<<8)+i[1]},zt.prototype.parse=function(t){return this.parseParts(this.output,t),this.output},zt.prototype.parseParts=function(t,i){for(var s=0;s<i.length;s++)this.parsePart(t,i[s])},zt.prototype.parsePart=function(t,i){var s,e=i.label;if(!i.requires||i.requires(this.stream,this.output,t))if(i.loop){for(var n=[];i.loop(this.stream);){var l={};this.parseParts(l,i.parts),n.push(l)}t[e]=n}else i.parts?(this.parseParts(s={},i.parts),t[e]=s):i.parser?(s=i.parser(this.stream,this.output,t),i.skip||(t[e]=s)):i.bits&&(t[e]=this.parseBits(i.bits))},zt.prototype.parseBits=function(t){var i={},s=this.stream.readBitArray();for(var e in t){var n=t[e];i[e]=n.length?s.slice(n.index,n.index+n.length).reduce((function(t,i){return 2*t+i}),0):s[n.index]}return i};var Ht=function(t){return function(i){return i.readBytes(t)}},Ut=function(t){return function(i){return i.readString(t)}},kt=function(t){return function(i){return i.readUnsigned(t)}},Bt=function(t,i){return function(s,e,n){for(var l=i(s,e,n),h=new Array(l),o=0;o<l;o++)h[o]=s.readBytes(t);return h}},Pt={label:"blocks",parser:function(t){for(var i=[],s=t.readByte();0!==s;s=t.readByte())i=i.concat(t.readBytes(s));return i}},Et={label:"gce",requires:function(t){var i=t.peekBytes(2);return 33===i[0]&&249===i[1]},parts:[{label:"codes",parser:Ht(2),skip:!0},{label:"byteSize",parser:function(t){return t.readByte()}},{label:"extras",bits:{future:{index:0,length:3},disposal:{index:3,length:3},userInput:{index:6},transparentColorGiven:{index:7}}},{label:"delay",parser:kt(!0)},{label:"transparentColorIndex",parser:function(t){return t.readByte()}},{label:"terminator",parser:function(t){return t.readByte()},skip:!0}]},Qt={label:"image",requires:function(t){return 44===t.peekByte()},parts:[{label:"code",parser:function(t){return t.readByte()},skip:!0},{label:"descriptor",parts:[{label:"left",parser:kt(!0)},{label:"top",parser:kt(!0)},{label:"width",parser:kt(!0)},{label:"height",parser:kt(!0)},{label:"lct",bits:{exists:{index:0},interlaced:{index:1},sort:{index:2},future:{index:3,length:2},size:{index:5,length:3}}}]},{label:"lct",requires:function(t,i,s){return s.descriptor.lct.exists},parser:Bt(3,(function(t,i,s){return Math.pow(2,s.descriptor.lct.size+1)}))},{label:"data",parts:[{label:"minCodeSize",parser:function(t){return t.readByte()}},Pt]}]},jt={label:"text",requires:function(t){var i=t.peekBytes(2);return 33===i[0]&&1===i[1]},parts:[{label:"codes",parser:Ht(2),skip:!0},{label:"blockSize",parser:function(t){return t.readByte()}},{label:"preData",parser:function(t,i,s){return t.readBytes(s.text.blockSize)}},Pt]},Dt={label:"frames",parts:[Et,{label:"application",requires:function(t){var i=t.peekBytes(2);return 33===i[0]&&255===i[1]},parts:[{label:"codes",parser:Ht(2),skip:!0},{label:"blockSize",parser:function(t){return t.readByte()}},{label:"id",parser:function(t,i,s){return t.readString(s.blockSize)}},Pt]},{label:"comment",requires:function(t){var i=t.peekBytes(2);return 33===i[0]&&254===i[1]},parts:[{label:"codes",parser:Ht(2),skip:!0},Pt]},Qt,jt],loop:function(t){var i=t.peekByte();return 33===i||44===i}},Ot=[{label:"header",parts:[{label:"signature",parser:Ut(3)},{label:"version",parser:Ut(3)}]},{label:"lsd",parts:[{label:"width",parser:kt(!0)},{label:"height",parser:kt(!0)},{label:"gct",bits:{exists:{index:0},resolution:{index:1,length:3},sort:{index:4},size:{index:5,length:3}}},{label:"backgroundColorIndex",parser:function(t){return t.readByte()}},{label:"pixelAspectRatio",parser:function(t){return t.readByte()}}]},{label:"gct",requires:function(t,i){return i.lsd.gct.exists},parser:Bt(3,(function(t,i){return Math.pow(2,i.lsd.gct.size+1)}))},Dt];function At(t){var i=new zt(new Uint8Array(t));this.raw=i.parse(Ot),this.raw.hasImages=!1;for(var s=0;s<this.raw.frames.length;s++)if(this.raw.frames[s].image){this.raw.hasImages=!0;break}}At.prototype.decompressFrame=function(t,i){if(t>=this.raw.frames.length)return null;var s=this.raw.frames[t];if(s.image){var e=function(t,i,s){var e,n,l,h,o,a,c,r,d,u,m,b,Z,p,G,X,y=s,f=new Array(s),V=new Array(4096),g=new Array(4096),R=new Array(4097);for(o=1+(n=1<<(b=t)),e=n+2,c=-1,l=(1<<(h=b+1))-1,d=0;d<n;d++)V[d]=0,g[d]=d;for(m=r=Z=p=X=G=0,u=0;u<y;){if(0===p){if(r<h){m+=i[G]<<r,r+=8,G++;continue}if(d=m&l,m>>=h,r-=h,d>e||d==o)break;if(d==n){l=(1<<(h=b+1))-1,e=n+2,c=-1;continue}if(-1==c){R[p++]=g[d],c=d,Z=d;continue}for(a=d,d==e&&(R[p++]=Z,d=c);d>n;)R[p++]=g[d],d=V[d];R[p++]=Z=255&g[d],e<4096&&(V[e]=c,g[e]=Z,0==(++e&l)&&e<4096&&(h++,l+=e)),c=a}p--,f[X++]=R[p],u++}for(u=X;u<y;u++)f[u]=0;return f}(s.image.data.minCodeSize,s.image.data.blocks,s.image.descriptor.width*s.image.descriptor.height);s.image.descriptor.lct.interlaced&&(e=function(t,i){for(var s=new Array(t.length),e=t.length/i,n=function(e,n){var l=t.slice(n*i,(n+1)*i);s.splice.apply(s,[e*i,i].concat(l))},l=[0,4,2,1],h=[8,8,4,2],o=0,a=0;a<4;a++)for(var c=l[a];c<e;c+=h[a])n(c,o),o++;return s}(e,s.image.descriptor.width));var n={pixels:e,dims:{top:s.image.descriptor.top,left:s.image.descriptor.left,width:s.image.descriptor.width,height:s.image.descriptor.height}};return n.colorTable=s.image.descriptor.lct&&s.image.descriptor.lct.exists?s.image.lct:this.raw.gct,s.gce&&(n.delay=10*(s.gce.delay||10),n.disposalType=s.gce.extras.disposal,s.gce.extras.transparentColorGiven&&(n.transparentIndex=s.gce.transparentColorIndex)),i&&(n.patch=function(t){for(var i=t.pixels.length,s=new Uint8ClampedArray(4*i),e=0;e<i;e++){var n=4*e,l=t.pixels[e],h=t.colorTable[l];s[n]=h[0],s[n+1]=h[1],s[n+2]=h[2],s[n+3]=l!==t.transparentIndex?255:0}return s}(n)),n}return null},At.prototype.decompressFrames=function(t){for(var i=[],s=0;s<this.raw.frames.length;s++)this.raw.frames[s].image&&i.push(this.decompressFrame(s,t));return i};const _t={},qt={},$t=-1!==navigator.userAgent.indexOf("Chrome");class ti extends Kt{constructor(t,i="",s={}){i.constructor==Object&&(s=i),null!=t&&-1!=t.lastIndexOf(".")&&(console.warn("Deprecated signature. Please provide a name and filepath to the image constructor"),t=t.substring(t.lastIndexOf("/")+1,t.lastIndexOf("."))),super(t,s),this.__loaded=!1;const e=this.addParameter(new It("FilePath"));e.valueChanged.connect(()=>{if(this.loaded.untoggle(),this.getName()==N.getClassName(this)){const t=e.getStem(),i=t.substring(t.length-1);isNaN(i)?this.setName(t):this.setName(t.substring(0,t.length-1))}const t=e.getFileDesc();t&&this.__loadData(t)}),i&&""!=i&&e.setFilepath(i)}static __imageDataLibrary(){return _t}static registerLoader(t,i){qt[t]=i}static constructLoader(t,i){for(const s of qt)if(new RegExp("\\.("+s+")$","i").test(t.name)){const e=new qt[s](i);if(e)return e.getParameter("FilePath").setValue(t.id),e}}__loadData(t){const i=this.getParameter("FilePath").getExt();if(".jpg"==i||".png"==i||".webp"==i)this.__loadLDRImage(t,i);else if(".mp4"==i||".ogg"==i)this.__loadLDRVideo(t);else if(".vlh"==i)this.__loadVLH(t);else if(".gif"==i)this.__loadGIF(t);else{if(".svg"!=i)throw new Error("Unsupported file type. Check the ext:"+t);console.warn("SVG Image not yet supported")}}__loadLDRImage(t,i){let s;".jpg"==i?this.format="RGB":".png"==i&&(this.format="RGBA"),this.type="UNSIGNED_BYTE";const n=()=>{this.getDOMElement=()=>s,this.width=s.width,this.height=s.height,this.__data=s,this.__loaded=!0,this.loaded.emit()};if(t.id in _t)s=_t[t.id],s.complete?n():s.addEventListener("load",n);else{ht.addWork(t.id,1);const i=this.addParameter(new ut("PreferredSize",-1));let l=t.url;if(t.assets&&Object.keys(t.assets).length>0){const s={maxSize:e.gpuDesc.maxTextureSize},n=i.getValue();-1==n?t.assets.reduce&&(s.prefSize=t.assets.reduce.w):s.prefSize=n;const h=function(t,i){if(i=i.filter(t=>null!==t),$t){const t=i.filter(t=>"webp"===t.format);t.length>1&&(i=t)}else i=i.filter(t=>"webp"!==t.format);if(t.maxSize&&(i=i.filter(i=>i.w<=t.maxSize)),t.filter){const s=i.filter(i=>-1!==i.url.indexOf(t.filter));s.length>1&&(i=s)}if(t.prefSize&&(i=i.map(i=>Object.assign({score:Math.abs(t.prefSize-i.w)},i))).sort((t,i)=>t.score>i.score?1:t.score<i.score?-1:0),i.length>0)return i[0]}(s,Object.values(t.assets));h&&(console.log("Selected image:"+t.name+" format:"+h.format+" :"+h.w+"x"+h.h+" url:"+h.url),l=h.url)}else console.warn("Images not processed for this file:"+t.name);s=new Image,s.crossOrigin="anonymous",s.src=l,s.addEventListener("load",n),s.addEventListener("load",()=>{ht.addWorkDone(t.id,1)}),_t[t.id]=s}}__removeVideoParams(){this.getParameterIndex("spatializeAudio")&&(this.removeParameter(this.getParameterIndex("Loop")),this.removeParameter(this.getParameterIndex("spatializeAudio")),this.removeParameter(this.getParameterIndex("Gain")),this.removeParameter(this.getParameterIndex("refDistance")),this.removeParameter(this.getParameterIndex("maxDistance")),this.removeParameter(this.getParameterIndex("rolloffFactor")),this.removeParameter(this.getParameterIndex("coneInnerAngle")),this.removeParameter(this.getParameterIndex("coneOuterAngle")),this.removeParameter(this.getParameterIndex("coneOuterGain")))}__loadLDRVideo(t){this.format="RGB",this.type="UNSIGNED_BYTE",ht.addWork(t.id,1);const i=this.addParameter(new bt("Mute",!0)),s=this.addParameter(new bt("Loop",!0)),e=document.createElement("video");e.style.display="none",e.preload="auto",e.crossOrigin="anonymous",this.getAudioSource=()=>e,document.body.appendChild(e),e.addEventListener("loadedmetadata",()=>{e.muted=i.getValue(),i.valueChanged.connect(()=>{e.muted=i.getValue()}),e.loop=s.getValue(),s.valueChanged.connect(()=>{e.loop=s.getValue()}),this.width=e.videoHeight,this.height=e.videoWidth,this.__data=e,this.__loaded=!0,ht.addWorkDone(t.id,1),this.loaded.emit(e),e.play().then(()=>{let t=0;const i=()=>{if(e.paused||e.ended)return;const s=Math.floor(29.97*e.currentTime);t!=s&&(this.updated.emit(),t=s),setTimeout(i,20)};i()},t=>{console.log("Autoplay was prevented.",t,t.message)})},!1),e.src=t.url}__loadVLH(t){this.type="FLOAT";let i=new p(1,1,1,1);this.setHDRTint=t=>{i=t},this.getHDRTint=()=>i,ht.loadUrl(t.id,t.url,t=>{let i,s;for(const e in t)e.endsWith(".jpg")?i=t[e]:e.endsWith(".bin")&&(s=t[e]);const e=new Blob([i.buffer]),n=new Image;n.onload=()=>{this.width=n.width,this.height=n.height,this.__data={ldr:n,cdm:s},this.__loaded?this.updated.emit():(this.__loaded=!0,this.loaded.emit())},n.src=URL.createObjectURL(e)})}__loadGIF(t){let i,s,e;this.format="RGBA",this.type="UNSIGNED_BYTE",this.__streamAtlas=!0,this.addParameter(new Gt("StreamAtlasDesc",new m)),this.addParameter(new ut("StreamAtlasIndex",0)),this.getParameter("StreamAtlasIndex").setRange([0,1]),this.getFrameDelay=()=>20,this.play=()=>{e.then(()=>{i=!0,s&&s()})},this.stop=()=>{i=!1},t.id in _t?e=_t[t.id]:(e=new Promise((i,s)=>{if(ht.addWork(t.id,1),t.assets&&t.assets.atlas){const s=new Image;return s.crossOrigin="anonymous",s.src=t.assets.atlas.url,void s.addEventListener("load",()=>{i({width:t.assets.atlas.width,height:t.assets.atlas.height,atlasSize:t.assets.atlas.atlasSize,frameDelays:t.assets.atlas.frameDelays,frameRange:[0,t.assets.atlas.frameDelays.length],imageData:s}),ht.addWorkDone(t.id,1)})}$(t.url,s=>{console.warn("Unpacking Gif client side:"+t.name);const e=performance.now(),n=new At(s).decompressFrames(!0),l=Math.sqrt(n.length),h=[l,l];Math.fract(l)>0&&(h[0]=Math.floor(h[0]+1),h[1]=Math.fract(l)>.5?Math.floor(h[1]+1):Math.floor(h[1]));const o=n[0].dims.width,a=n[0].dims.height,c=document.createElement("canvas"),r=c.getContext("2d"),d=document.createElement("canvas"),u=d.getContext("2d");d.width=o,d.height=a;const m=document.createElement("canvas"),b=m.getContext("2d");let Z;m.width=h[0]*o,m.height=h[1]*a;const p=[],G=(t,i)=>{const s=t.dims;p.push(t.delay/10),Z&&s.width==Z.width&&s.height==Z.height||(c.width=s.width,c.height=s.height,Z=r.createImageData(s.width,s.height)),Z.data.set(t.patch),r.putImageData(Z,0,0),2==t.disposalType&&u.clearRect(0,0,d.width,d.height),u.drawImage(c,s.left,s.top),b.drawImage(d,i%h[0]*o,Math.floor(i/h[0])*a)};for(let t=0;t<n.length;t++)G(n[t],t);ht.addWorkDone(t.id,1);const X=b.getImageData(0,0,m.width,m.height),y=performance.now()-e;console.log(`Decode GIF '${t.name}' time:`+y),i({width:m.width,height:m.height,atlasSize:h,frameRange:[0,n.length],frameDelays:p,imageData:X})},i=>{console.warn("Unable to Load URL:"+i+":"+t.url),s()})}),_t[t.id]=e),e.then(t=>{this.width=t.width,this.height=t.height,this.getParameter("StreamAtlasDesc").setValue(new m(t.atlasSize[0],t.atlasSize[1],0,0)),this.getParameter("StreamAtlasIndex").setRange(t.frameRange),this.__data=t.imageData,this.getFrameDelay=i=>10*t.frameDelays[i];const e=this.getParameter("StreamAtlasIndex"),n=e.getRange()[1];let l=0;s=()=>{e.setValue(l),i&&setTimeout(s,this.getFrameDelay(l)),l=(l+1)%n},i&&s(),this.__loaded=!0,this.loaded.emit()})}getFilepath(){return this.getParameter("FilePath").getValue()}isStream(){return!1}isLoaded(){return this.__loaded}getParams(){const t=super.getParams();return this.__loaded&&(t.data=this.__data),t}toJSON(t,i){}fromJSON(t,i,s){}readBinary(t,i){this.setName(t.loadStr());let s=t.loadStr();if("string"==typeof s&&""!=s){if(i.lod>=0){const t=s.lastIndexOf(".");if(-1!=t){const e=s.substring(0,t)+i.lod+s.substring(t);ht.resolveFilepath(e)&&(s=e)}}this.getParameter("FilePath").setFilepath(s)}}}class ii extends ti{constructor(t,i={}){console.warn("FileImage2D is becoming deprecated in favor of simple FileImage"),super(t,i)}}N.registerClass("FileImage2D",ti),N.registerClass("FileImage",ti);const si=-1!==navigator.userAgent.indexOf("Chrome");class ei extends ti{constructor(t,i,s){super(t,i,s),this.type="UNSIGNED_BYTE",this.addParameter(new ut("PreferredSize",-1)),this.__crossOrigin="anonymous"}setCrossOrigin(t){this.__crossOrigin=t}__loadData(t){".png"==this.getParameter("FilePath").getExt()&&(this.format="RGBA");let i=t.url;if(t.assets&&Object.keys(t.assets).length>0){const s={maxSize:e.gpuDesc.maxTextureSize},n=this.getParameter("PreferredSize").getValue();-1==n?t.assets.reduce&&(s.prefSize=t.assets.reduce.w):s.prefSize=n;const l=function(t,i){if(i=i.filter(t=>null!==t),si){const t=i.filter(t=>"webp"===t.format);t.length>1&&(i=t)}else i=i.filter(t=>"webp"!==t.format);if(t.maxSize&&(i=i.filter(i=>i.w<=t.maxSize)),t.filter){const s=i.filter(i=>-1!==i.url.indexOf(t.filter));s.length>1&&(i=s)}if(t.prefSize&&(i=i.map(i=>Object.assign({score:Math.abs(t.prefSize-i.w)},i))).sort((t,i)=>t.score>i.score?1:t.score<i.score?-1:0),i.length>0)return i[0]}(s,Object.values(t.assets));l&&(console.log("Selected image:"+t.name+" format:"+l.format+" :"+l.w+"x"+l.h+" url:"+l.url),i=l.url)}else console.warn("Images not processed for this file:"+t.name);this.setImageURL(i,"RGB")}setImageURL(t,i="RGB"){if(!i){const s=t.lastIndexOf(".");-1!=s&&".png"==t.substring(s).toLowerCase()&&(i="RGBA")}let s;this.format=i,this.__loaded=!1;const e=()=>{this.getDOMElement=()=>s,this.width=s.width,this.height=s.height,this.__data=s,this.__loaded=!0,this.loaded.emit()},n=ti.__imageDataLibrary();t in n?(s=n[t],s.complete?e():s.addEventListener("load",e)):(s=new Image,s.crossOrigin=this.__crossOrigin,s.src=t,s.addEventListener("load",e),n[t]=s)}}ti.registerLoader("jpg|jpeg|png",ei),N.registerClass("LDRImage",ei);class ni extends ti{constructor(t,i,s){super(t,i,s),this.format="RGB",this.type="UNSIGNED_BYTE",this.addParameter(new bt("Mute",!1)),this.addParameter(new bt("Loop",!0)),this.addParameter(new ut("Gain",2)).setRange([0,5]),this.addParameter(new bt("SpatializeAudio",!0)),this.addParameter(new ut("refDistance",2)),this.addParameter(new ut("maxDistance",1e4)),this.addParameter(new ut("rolloffFactor",1)),this.addParameter(new ut("coneInnerAngle",360)),this.addParameter(new ut("coneOuterAngle",0)),this.addParameter(new ut("coneOuterGain",1))}__loadData(t){ht.addWork(t.id,1);const i=document.createElement("video");i.style.display="none",i.preload="auto",i.crossOrigin="anonymous",this.getAudioSource=()=>i,document.body.appendChild(i),i.addEventListener("loadedmetadata",()=>{const s=this.getParameter("Mute");i.muted=s.getValue(),s.valueChanged.connect(()=>{i.muted=s.getValue()});const e=this.getParameter("Loop");i.loop=e.getValue(),e.valueChanged.connect(()=>{i.loop=e.getValue()}),this.width=i.videoHeight,this.height=i.videoWidth,this.__data=i,this.__loaded=!0,ht.addWorkDone(t.id,1),this.loaded.emit(i);let n=0;const l=()=>{if(i.paused||i.ended)return;const t=Math.floor(29.97*i.currentTime);n!=t&&(this.updated.emit(),n=t),setTimeout(l,20)};l()},!1),i.src=t.url;const s=i.play();void 0!==s&&s.then(()=>{console.log("Autoplay started!")}).catch(()=>{console.log("Autoplay was prevented.")})}}ti.registerLoader("mp4|ogg",ni),N.registerClass("LDRVideo",ni);class li extends ti{constructor(t,i="",s={}){super(t,i,s),this.format="RGBA",this.type="UNSIGNED_BYTE",this.__streamAtlas=!0,this.getParameter("FilePath").setSupportedExts("gif"),this.addParameter(new Gt("StreamAtlasDesc")),this.addParameter(new ut("StreamAtlasIndex",0));const e=this.getParameter("StreamAtlasIndex");let n;e.setRange([0,1]);let l=0;const h=t=>{e.setValue(l),n&&setTimeout(()=>h(t),this.getFrameDelay(l)),l=(l+1)%t};this.play=()=>{this.__resourcePromise.then(()=>{n=!0;const t=e.getRange()[1];h(t)})},this.stop=()=>{n=!1}}getFrameDelay(t){return 10*this.__unpackedData.frameDelays[t]}__loadData(t){const i=ti.__imageDataLibrary();t.id in i?this.__resourcePromise=i[t.id]:(this.__resourcePromise=new Promise((i,s)=>{if(ht.addWork(t.id,1),t.assets&&t.assets.atlas){const s=new Image;return s.crossOrigin="anonymous",s.src=t.assets.atlas.url,void s.addEventListener("load",()=>{i({width:t.assets.atlas.width,height:t.assets.atlas.height,atlasSize:t.assets.atlas.atlasSize,frameDelays:t.assets.atlas.frameDelays,frameRange:[0,t.assets.atlas.frameDelays.length],imageData:s}),ht.addWorkDone(t.id,1)})}$(t.url,s=>{console.warn("Unpacking Gif client side:"+t.name);const e=performance.now(),n=new At(s).decompressFrames(!0),l=Math.sqrt(n.length),h=[l,l];Math.fract(l)>0&&(h[0]=Math.floor(h[0]+1),h[1]=Math.fract(l)>.5?Math.floor(h[1]+1):Math.floor(h[1]));const o=n[0].dims.width,a=n[0].dims.height,c=document.createElement("canvas"),r=c.getContext("2d"),d=document.createElement("canvas"),u=d.getContext("2d");d.width=o,d.height=a;const m=document.createElement("canvas"),b=m.getContext("2d");let Z;m.width=h[0]*o,m.height=h[1]*a;const p=[],G=(t,i)=>{const s=t.dims;p.push(t.delay/10),Z&&s.width==Z.width&&s.height==Z.height||(c.width=s.width,c.height=s.height,Z=r.createImageData(s.width,s.height)),Z.data.set(t.patch),r.putImageData(Z,0,0),2==t.disposalType&&u.clearRect(0,0,d.width,d.height),u.drawImage(c,s.left,s.top),b.drawImage(d,i%h[0]*o,Math.floor(i/h[0])*a)};for(let t=0;t<n.length;t++)G(n[t],t);ht.addWorkDone(t.id,1);const X=b.getImageData(0,0,m.width,m.height),y=performance.now()-e;console.log(`Decode GIF '${t.name}' time:`+y),i({width:m.width,height:m.height,atlasSize:h,frameRange:[0,n.length],frameDelays:p,imageData:X})},i=>{console.warn("Unable to Load URL:"+i+":"+t.url),s()})}),i[t.id]=this.__resourcePromise),this.__resourcePromise.then(t=>{this.width=t.width,this.height=t.height,this.getParameter("StreamAtlasDesc").setValue(new m(t.atlasSize[0],t.atlasSize[1],0,0)),this.getParameter("StreamAtlasIndex").setRange(t.frameRange),this.__unpackedData=t,this.__data=t.imageData,this.__loaded=!0,this.loaded.emit()})}}ti.registerLoader("gif",li),N.registerClass("GIFImage",li);class hi extends Kt{constructor(t,i={}){let s;null!=t&&-1!=t.lastIndexOf(".")&&(s=t,t=t.substring(t.lastIndexOf("/")+1,t.lastIndexOf("."))),super(t,i),this.__loaded=!1,this.__exposure=1,this.__ambientLightFactor=0,this.__hdrtint=new p(1,1,1,1),this.__stream="stream"in i&&i.stream,this.type="FLOAT";const e=this.addParameter(new It("FilePath"));e.valueChanged.connect(()=>{if(this.loaded.untoggle(),this.getName()==N.getClassName(this)){const t=e.getStem(),i=t.substring(t.length-1);isNaN(i)?this.setName(t):this.setName(t.substring(0,t.length-1))}const t=e.getValue(),i=e.getFile();this.__loadVLH(t,i)}),s&&this.getParameter("FilePath").setFilepath(s)}getDOMElement(){return this.__domElement}getResourcePath(){return this.getParameter("FilePath").getValue()}__decodeData(t){const i=t.cdm,s=new Blob([t.ldr.buffer]),e=new Image;e.onload=()=>{this.width=e.width,this.height=e.height,this.__data={ldr:e,cdm:i},this.__loaded?this.updated.emit():(this.__loaded=!0,this.loaded.emit())},e.src=URL.createObjectURL(s)}__loadVLH(t,i){this.type="FLOAT",ht.loadUrl(t,i.url,t=>{if(!t.ldr||!t.cdm)for(const i in t)i.endsWith(".jpg")?(t.ldr=t[i],delete t[i]):i.endsWith(".bin")&&(t.cdm=t[i],delete t[i]);this.__decodeData(t)})}isStream(){return!1}isLoaded(){return this.__loaded}getParams(){const t=super.getParams();return this.__loaded&&(t.data=this.__data,t.exposure=this.__exposure),t}setHDRTint(t){this.__hdrtint=t}getHDRTint(){return this.__hdrtint}toJSON(t,i){}fromJSON(t,i,s){}readBinary(t,i){this.setName(t.loadStr());const s=t.loadStr();if("string"==typeof s&&""!=s){if(i.lod>=0){const t=s.lastIndexOf(".");if(-1!=t){const e=s.substring(0,t)+i.lod+s.substring(t);ht.resourceAvailable(e)&&(s=e)}}this.getParameter("FilePath").setValue(s)}}}N.registerClass("VLHImage",hi);const oi=(t,i)=>i<t?0:1;function ai(t){return t.dot(new d(1,1))}function ci(t){return new d(Math.abs(t.x),Math.abs(t.y))}function ri(t,i){return new d(Math.max(t.x,i),Math.max(t.y,i))}class di extends hi{constructor(t,i={}){super(t,i),this.mapping=2}__decodeData(t){super.__decodeData(t);const i=t.samples;i&&(this.__sampleSets=window.TextDecoder?JSON.parse(new TextDecoder("utf-8").decode(i)):JSON.parse(K(i)),this.__sampleSets.luminanceThumbnail&&(this.__thumbSize=Math.sqrt(this.__sampleSets.luminanceThumbnail.length)))}getSampleSets(){return this.__sampleSets}uvToDir(t){switch(this.mapping){case 1:return function(t){const i=Math.PI*(2*t-1),s=void 0*Math.PI;return new u(sin(s)*sin(i),-sin(s)*cos(i),cos(s))}(t);case 2:return function(t){const i=function(t){return new d(2*oi(0,t.x)-1,2*oi(0,t.y)-1)}(t=t.scale(2).subtract(new d(1,1))),s=ai(ci(t)),e=s*Math.PI*.5;if(e<=0)return new u(0,0,1);if(Math.abs(e-Math.PI)<1e-6)return new u(0,0,-1);s>1&&(t=ci(d(t.y,t.x)).negate().add(new d(1,1)).multiply(i),s=ai(ci(t)));const n=Math.abs(t.x)/s*Math.HALF_PI,l=Math.sin(n),h=Math.cos(n),o=Math.sin(e),a=Math.cos(e);return new u(l*i.x*o,h*i.y*o,a)}(t)}}dirToUv(t){switch(this.mapping){case 1:return function(t){const i=Math.acos(t.z),s=Math.atan2(t.x,-t.y);return new d((1+s/Math.PI)/2,i/Math.PI)}(t);case 2:return function(t){const i=function(t){return new u(Math.abs(t.x),Math.abs(t.y),Math.abs(t.z))}(t),s=function(t){return new u(2*oi(0,t.x)-1,2*oi(0,t.y)-1,2*oi(0,t.z)-1)}(t),e=new d(i.x,i.y);let n=ri(e,1e-20);const l=Math.atan2(n.x,n.y)/Math.HALF_PI;n=ri(new d(i.z,e.length()),1e-20);const h=Math.atan2(n.y,n.x)/Math.HALF_PI;let o=new d(s.x*l,s.y*(1-l));if(o.scaleInPlace(h),t.z<0){const t=new d(o.y,o.x),i=new d(s.x,s.y);o=i.subtract(ci(t).multiply(i))}return o.scale(.5).add(new d(.5,.5))}(t)}}uvToLuminance(t){const i=Math.floor(t.y*this.__thumbSize)*this.__thumbSize+Math.floor(t.x*this.__thumbSize);return this.__sampleSets.luminanceThumbnail[i]}dirToLuminance(t){return this.uvToLuminance(this.dirToUv(t))}}N.registerClass("EnvMap",di);class ui extends F{constructor(t,i,s,e){super(),this.atlasSize=s,this.image=new hi("Lightmap",{stream:e}),this.image.getParameter("FilePath").setFilepath(t),this.image.setHDRTint(i.getParameter("LightmapTint").getValue()),this.__stream=e}get width(){return this.atlasSize[0]}get height(){return this.atlasSize[1]}isStream(){return this.__stream}loadResource(t){this.image.loadResource(t)}fromJSON(t){this.__atlasSize=t.atlasSize}}class mi extends F{constructor(t){super(),this.atlasSize=t,this.__images=[],this.__weights=[],this.__stream=!1,this.lightmapAdded=new v,this.lightmapResourceChanged=new v,this.lightmapWeightChanged=new v}get width(){return this.atlasSize[0]}get height(){return this.atlasSize[1]}isStream(){return this.__stream}loadResource(t,i,s,e=!1){this.__images[t]?(this.__images[t].loadResource(i),this.lightmapResourceChanged.emit(t,s),s&&(this.__weights[t]=s,this.lightmapWeightChanged.emit(t,s))):(this.__images[t]=new FileImage(i,{stream:e}),this.__weights[t]=s||1,this.lightmapAdded.emit(t)),this.__stream|=e}setWeight(t,i){this.__weights[t]=i,this.lightmapWeightChanged.emit(t,i)}numSubImages(){return this.__images.length}getSubImage(t){return this.__images[t]}getSubImageWeight(t){return this.__weights[t]}fromJSON(t){this.__atlasSize=t.atlasSize}}const bi=new class{constructor(){this.__labelLibraries={},this.labelLibraryLoaded=new v;const t=function(){const t=window.navigator,i=["language","browserLanguage","systemLanguage","userLanguage"];let s,e;if(Array.isArray(t.languages))for(s=0;s<t.languages.length;s++)if(e=t.languages[s],e&&e.length)return e;for(s=0;s<i.length;s++)if(e=t[i[s]],e&&e.length)return e;return null}();t.startsWith("en")?this.__language="En":t.startsWith("es")?this.__language="Es":t.startsWith("fr")?this.__language="Fr":(t.startsWith("gb")||t.startsWith("de"))&&(this.__language="Gb"),this.__foundLabelLibraries={},ht.registerResourceCallback(".labels",t=>{const i=t.name.split(".")[0];this.__foundLabelLibraries[i]=t,A(t.url,t=>{this.__labelLibraries[i]=JSON.parse(t),this.labelLibraryLoaded.emit(i)})}),window.XLSX&&ht.registerResourceCallback(".xlsx",t=>{const i=t.name.split(".")[0];this.__foundLabelLibraries[i]=t,$(t.url,t=>{const s=new Uint8Array(t),e=XLSX.read(s,{type:"array"}),n={};e.SheetNames.forEach((function(t){XLSX.utils.sheet_to_row_object_array(e.Sheets[t]).forEach((function(t){const i=t.Identifier;delete t.Identifier,n[i]=t}))})),this.__labelLibraries[i]=n,this.labelLibraryLoaded.emit(i)})})}isLibraryFound(t){return t in this.__foundLabelLibraries}isLibraryLoaded(t){return t in this.__labelLibraries}getLabelText(t,i){const s=this.__labelLibraries[t];if(!s)throw new Error("LabelLibrary: '"+t+"' not found in LabelManager. Found: ["+Object.keys(this.__labelLibraries)+"]");const e=s[i];if(!e)throw new Error("Label: '"+i+"' not found in LabelLibrary: '"+t+"'. Found: ["+Object.keys(s)+"]");const n=e[this.__language];if(!n){if(e.En)return e.En;throw new Error("labelText: '"+language+"' not found in Label. Found: ["+Object.keys(e)+"]")}return n}setLabelText(t,i,s){let e=this.__labelLibraries[t];e||(e={},this.__labelLibraries[t]=e);let n=e[i];n||(n={},e[i]=n),n[this.__language]=s}setLanguage(t){this.__language=t}};class Zi extends Tt{constructor(t,i){super(t),this.__canvasElem=document.createElement("canvas");const s=this.addParameter(new Rt("library"));this.addParameter(new Rt("text","")),this.addParameter(new Xt("fontColor",new p(0,0,0))),this.addParameter(new ut("margin",11)),this.addParameter(new ut("borderWidth",2)),this.addParameter(new ut("borderRadius",11)),this.addParameter(new bt("outline",!1)),this.addParameter(new bt("outlineColor",new p(0,0,0))),this.addParameter(new bt("background",!0)),this.addParameter(new Xt("backgroundColor",new p("#FBC02D"))),this.addParameter(new bt("fillBackground",!0)),this.addParameter(new bt("strokeBackgroundOutline",!0)),this.addParameter(new ut("fontSize",22)),this.addParameter(new Rt("font","Helvetica")),this.nameChanged.connect(()=>{this.loadLabelData()}),i&&s.setValue(i),this.__requestedRerender=!1,this.__needsRender=!1,this.labelRendered=new v,this.loadLabelData()}__parameterValueChanged(t,i){this.__requestedRerender||(this.__requestedRerender=!0,this.loadLabelData())}loadLabelData(){Promise.all([(()=>new Promise(t=>{const i=this.getParameter("library").getValue();if(""==i)return void t();if(!bi.isLibraryFound(i))return console.warn("Label Libary not found:",i),void t();const s=()=>{try{const t=this.getName(),s=bi.getLabelText(i,t);this.getParameter("text").setValue(s)}catch(t){console.warn(t)}t()};bi.isLibraryLoaded(i)?s():bi.labelLibraryLoaded.connect(t=>{t==i&&s()})}))(),(()=>new Promise(t=>{if(null!=document.fonts){const i=this.getParameter("font").getValue(),s=this.getParameter("fontSize").getValue();document.fonts.load(s+'px "'+i+'"').then(()=>{t()})}else t()}))()]).then(()=>{this.__requestedRerender=!1,this.__needsRender=!0,this.__loaded?this.updated.emit():(this.__loaded=!0,this.loaded.emit())})}renderLabelToImage(){const t=this.__canvasElem.getContext("2d",{alpha:!0});let i=this.getParameter("text").getValue();""==i&&(i=this.getName());const s=this.getParameter("font").getValue(),e=this.getParameter("fontColor").getValue(),n=this.getParameter("fontSize").getValue(),l=this.getParameter("margin").getValue(),h=this.getParameter("borderWidth").getValue(),o=this.getParameter("borderRadius").getValue(),a=this.getParameter("outline").getValue(),c=this.getParameter("outlineColor").getValue(),r=this.getParameter("background").getValue(),d=this.getParameter("backgroundColor").getValue(),u=this.getParameter("fillBackground").getValue(),m=this.getParameter("strokeBackgroundOutline").getValue(),b=l+h,Z=i.split("\n");t.font=n+'px "'+s+'"';let p=0;Z.forEach(i=>{p=Math.max(t.measureText(i).width,p)});const G=n;this.width=Math.ceil(p+2*b),this.height=Math.ceil(G*Z.length+2*b),t.canvas.width=this.width,t.canvas.height=this.height,this.__canvasElem.width=this.width,this.__canvasElem.height=this.height,t.fillStyle="rgba(0, 0, 0, 0.0)",t.fillRect(0,0,this.width,this.height),r&&(t.fillStyle=d.toHex(),t.strokeStyle=c.toHex(),function(t,i,s,e,n,l,h,o,a){if(void 0===o&&(o=!0),void 0===l&&(l=5),"number"==typeof l)l={tl:l,tr:l,br:l,bl:l};else{const t={tl:0,tr:0,br:0,bl:0};for(const i in t)l[i]=l[i]||t[i]}t.beginPath(),t.moveTo(i+l.tl,s),t.lineTo(i+e-l.tr,s),t.quadraticCurveTo(i+e,s,i+e,s+l.tr),t.lineTo(i+e,s+n-l.br),t.quadraticCurveTo(i+e,s+n,i+e-l.br,s+n),t.lineTo(i+l.bl,s+n),t.quadraticCurveTo(i,s+n,i,s+n-l.bl),t.lineTo(i,s+l.tl),t.quadraticCurveTo(i,s,i+l.tl,s),t.closePath(),h&&t.fill(),o&&(t.lineWidth=a,t.stroke())}(t,h,h,this.width-2*h,this.height-2*h,o,u,m,h)),t.font=n+'px "'+s+'"',t.textAlign="left",t.fillStyle=e.toHex(),t.textBaseline="hanging",Z.forEach((i,s)=>{t.fillText(i,b,b+s*G)}),a&&(t.strokeStyle=c.toHex(),t.lineWidth=1.5,t.strokeText(i,b,b)),this.__data=t.getImageData(0,0,this.width,this.height),this.__needsRender=!1,this.labelRendered.emit({width:this.width,height:this.height,data:this.__data})}getParams(){return this.__needsRender&&this.renderLabelToImage(),super.getParams()}toJSON(t,i){return super.toJSON(t,i)}fromJSON(t,i,s){super.fromJSON(t,i,s),this.__getLabelText()}}N.registerClass("Label",Zi);class pi extends Kt{constructor(){super(),this.__loaded=!1}connectWebcam(t,i,s=!1){const e={width:t,height:i,frameRate:{ideal:60,max:60}};e.facingMode=s?{exact:"environment"}:{facingMode:"user"};const n=document.createElement("video");n.style.display="none",n.preload="auto",n.crossOrigin="anonymous",document.body.appendChild(n),navigator.mediaDevices.getUserMedia({audio:!1,video:e}).then(t=>{n.srcObject=t,n.onloadedmetadata=()=>{n.play(),this.width=n.videoWidth,this.height=n.videoHeight,console.log("Webcam:["+this.width+", "+this.height+"]"),this.__data=n,this.__loaded=!0,this.loaded.emit(n);let t=0;const i=()=>{if(n.paused||n.ended)return;const s=Math.floor(60*n.currentTime);t!=s&&(this.updated.emit(),t=s),setTimeout(i,20)};i()}}).catch((function(){}))}setVideoStream(t){this.__loaded=!1,this.width=t.videoWidth,this.height=t.videoHeight,this.start(),this.__data=t,this.__loaded=!0,this.loaded.emit(t)}stop(){clearInterval(this.__intervalId)}start(){this.__intervalId=setInterval(()=>{this.updated.emit()},20)}isLoaded(){return this.__loaded}getParams(){return{type:this.type,format:this.format,width:this.width,height:this.height,data:this.__data,flipY:this.getParameter("FlipY").getValue()}}}N.registerClass("VideoStreamImage2D",pi);class Gi{constructor(t="MaterialLibrary"){this.__name=t,this.lod=0,e.isMobileDevice&&(this.lod=1),this.loaded=new v,this.clear()}clear(){this.__images={},this.__materials={Default:new Nt("Default","SimpleSurfaceShader")}}getPath(){return[this.__name]}getNumMaterials(){return Object.keys(this.__materials).length}getMaterials(){return Object.values(this.__materials)}getMaterialNames(){const t=[];for(const i in this.__materials)t.push(i);return t}hasMaterial(t){return t in this.__materials}addMaterial(t){t.setOwner(this),this.__materials[t.getName()]=t}getMaterial(t,i=!0){const s=this.__materials[t];if(!s&&i)throw new Error("Material:"+t+" not found in library:"+this.getMaterialNames());return s}hasImage(t){return t in this.__images}addImage(t){t.setOwner(this),this.__images[t.getName()]=t}getImage(t,i=!0){const s=this.__images[t];if(!s&&i)throw new Error("Image:"+t+" not found in library:"+this.getImageNames());return s}getImageNames(){const t=[];for(const i in this.__images)t.push(i);return t}load(t){const i=new XMLHttpRequest;i.open("GET",t,!0),i.ontimeout=()=>{throw new Error("The request for "+t+" timed out.")},i.onload=()=>{4===i.readyState&&(200===i.status?this.fromJSON(JSON.parse(i.responseText)):console.warn(i.statusText))},i.send(null)}toJSON(t={},i=0){return{numMaterials:this.geoms.length()}}fromJSON(t,i={},s=0){i.lod=this.lod;for(const i in t.textures)new ti(i).fromJSON(t.textures[i]),this.__images[i]=texture;for(const i in t.materials){const s=new Nt(i);s.fromJSON(t.materials[i]),this.addMaterial(s)}}readBinary(t,i={}){this.name=t.loadStr(),i.lod=this.lod,i.materialLibrary=this;const s=t.loadUInt32();for(let e=0;e<s;e++){const s=t.loadStr(),e=N.constructClass(s,void 0);e.readBinary(t,i),this.__images[e.getName()]=e}const e=t.loadUInt32();if(e>0){const s=t.loadUInt32Array(e);for(let n=0;n<e;n++){const e=new Nt("");t.seek(s[n]),e.readBinary(t,i,this.__images),this.addMaterial(e)}}this.loaded.emit()}toString(){return JSON.stringify(this.toJSON(),null,2)}}const Xi=new class{constructor(){this.__materialLibraries={},this.materialLibraryLoaded=new v,ht.registerResourceCallback(".matlib",t=>{A(t.url,i=>{const s=t.name.split(".")[0],e=JSON.parse(i),n=new Gi(s);n.fromJSON(e),this.__materialLibraries[s]=n,this.materialLibraryLoaded.emit(n)})})}getMaterialLibraryNames(){const t=[];for(const i in this.__materialLibraries)t.push(i);return t}hasMaterialLibrary(t){return t in this.__materialLibraries}getMaterialLibrary(t){const i=this.__materialLibraries[t];return i||console.warn("MaterialLibrary:"+t+" not found in MaterialLibraryManager. Found: ["+this.getMaterialLibraryNames()+"]"),i}resolveMaterialFromPath(t){const i=this.getMaterialLibrary(t[0]);if(i)return i.getMaterial(t[1])}};class yi extends U{constructor(t,i){super(t,i,"Material"),this.valueParameterValueChanged=new v}setValue(t,i=J.USER_SETVALUE){this.__value!==t&&(this.__value&&this.__value.parameterValueChanged.disconnect(this.valueParameterValueChanged.emit),this.__value=t,this.__value&&this.__value.parameterValueChanged.connect(this.valueParameterValueChanged.emit),i!=J.USER_SETVALUE&&i!=J.REMOTEUSER_SETVALUE||(this.__flags|=z.USER_EDITED),i!=J.OPERATOR_SETVALUE&&this.valueChanged.emit(i))}toJSON(t,i){if(0!=(this.__flags&z.USER_EDITED))return{value:this.__value.getPath()}}fromJSON(t,i,s){if(null==t.value)return void console.warn("Invalid Parameter JSON");const e=Xi.resolveMaterialFromPath(t.value);e&&this.setValue(e),this.__flags|=z.USER_EDITED}clone(t){return new yi(this.__name,this.__value)}destroy(){this.__value&&this.__value.parameterValueChanged.disconnect(this.valueParameterValueChanged.emit)}}class fi{constructor(t,i,s){if(this.__dataType=t,this.normalized=!1,null!=t.numElements)this.__dimension=this.__dataType.numElements();else switch(t){case 6:case 4:case 5:this.__dimension=1;break;default:throw new Error("Invalid data type for attribute:"+t)}var e;this.__defaultElementValue=null!=s?s:Number.MAX_VALUE,(e=i)&&void 0!==e.byteLength?this.__data=i:(this.__data=new Float32Array(i*this.__dimension),this.initRange(0))}resize(t){const i=this.__data.length,s=t*this.__dimension,e=new Float32Array(s);for(let t=0;t<Math.min(this.__data.length,s);t++)e[t]=this.__data[t];this.__data.length<s&&(this.__data=e),this.initRange(i)}initRange(t){for(let i=t;i<this.__data.length;i++)this.__data[i]=this.__defaultElementValue}getCount(){return this.__data.length/this.__dimension}get length(){return this.__data.length/this.__dimension}get dataType(){return this.__dataType}get data(){return this.__data}set data(t){this.__data=t}get numElements(){return this.__dimension}getFloat32Value(t){return this.__data[t]}setFloat32Value(t,i){this.__data[t]=i}getValueRef(t){const i=this.__dimension;if(t>=this.__data.length/i)throw new Error("Invalid vertex index:"+t+". Num Vertices:"+this.__data.length/3);return this.__dataType.createFromFloat32Buffer(this.__data.buffer,t*i)}setValue(t,i){const s=this.__dimension;if(t>=this.__data.length/s)throw new Error("Invalid vertex index:"+t+". Num Vertices:"+this.__data.length/3);this.__dataType.createFromFloat32Buffer(this.__data.buffer,t*s).setFromOther(i)}toJSON(t,i){return{data:Array.from(this.__data),dataType:r.getTypeName(this.__dataType),defaultValue:this.__defaultElementValue,length:this.__data.length/this.__dimension}}fromJSON(t){this.__data=Float32Array.from(t.data)}toString(){return JSON.stringify(this.toJSON(),null,2)}}class Vi extends B{constructor(){super(),this.__boundingBox=new I,this.__boundingBoxDirty=!0,this.__vertexAttributes=new Map,this.__metaData=new Map,this.addVertexAttribute("positions",u,0),this.boundingBoxDirtied=new v,this.geomDataChanged=new v,this.geomDataTopologyChanged=new v}setDebugName(t){this.__name=t}addVertexAttribute(t,i,s){let e;var n;return e=(n=s)&&void 0!==n.byteLength?new fi(i,s):new fi(i,null!=this.vertices?this.vertices.length:0,s),this.__vertexAttributes.set(t,e),e}hasVertexAttribute(t){return this.__vertexAttributes.has(t)}getVertexAttribute(t){return this.__vertexAttributes.get(t)}getVertexAttributes(t){const i={};for(const[t,s]of this.__vertexAttributes.entries())i[t]=s;return i}get vertices(){return this.__vertexAttributes.get("positions")}numVertices(){return this.vertices.length}getNumVertices(){return this.vertices.length}setNumVertices(t){this.__vertexAttributes.forEach(i=>i.resize(t))}getVertex(t){return u.createFromFloat32Buffer(this.vertices.data.buffer,3*t)}setVertex(t,i){return u.createFromFloat32Buffer(this.vertices.data.buffer,3*t).setFromOther(i)}moveVertices(t){const i=this.vertices;for(let s=0;s<i.length;s++)i.getValueRef(s).addInPlace(t);this.setBoundingBoxDirty()}transformVertices(t){const i=this.vertices;for(let s=0;s<i.length;s++){const e=i.getValueRef(s),n=t.transformVec3(e);e.set(n.x,n.y,n.z)}this.setBoundingBoxDirty()}get boundingBox(){return this.__boundingBoxDirty&&this.updateBoundingBox(),this.__boundingBox}setBoundingBoxDirty(){this.__boundingBoxDirty=!0,this.boundingBoxDirtied.emit()}updateBoundingBox(){const t=this.vertices,i=new I,s=t.length;for(let e=0;e<s;e++)i.addPoint(t.getValueRef(e));this.__boundingBox=i,this.__boundingBoxDirty=!1}getMetadata(t){return this.__metaData.get(t)}hasMetadata(t){return this.__metaData.has(t)}setMetadata(t,i){this.__metaData.set(t,i)}deleteMetadata(t){this.__metaData.delete(t)}genBuffers(t){const i={};for(const[t,s]of this.__vertexAttributes)i[t]={values:s.data,count:s.size,dataType:s.dataType,normalized:s.normalized};return{numVertices:this.numVertices(),attrBuffers:i}}freeBuffers(){}loadBaseGeomBinary(t){this.name=t.loadStr();const i=t.loadUInt8();this.debugColor=t.loadRGBFloat32Color();const s=t.loadUInt32();this.__boundingBox.set(t.loadFloat32Vec3(),t.loadFloat32Vec3()),this.setNumVertices(s);const e=this.vertices;let n,l;2&i&&(n=this.getVertexAttribute("normals"),n||(n=this.addVertexAttribute("normals",u,0))),4&i&&(l=this.getVertexAttribute("texCoords"),l||(l=this.addVertexAttribute("texCoords",d,0)));const h=(t,i,s,n)=>{for(let l=t[0];l<t[1];l++){const t=new u(n[3*l+0]/255,n[3*l+1]/255,n[3*l+2]/255);t.multiplyInPlace(s),t.addInPlace(i),e.setValue(l,t)}},o=(t,i,s,e)=>{s.isNull()&&s.set(1,1,1);for(let l=t[0];l<t[1];l++){const t=new u(e[3*l+0]/255,e[3*l+1]/255,e[3*l+2]/255);t.multiplyInPlace(s),t.addInPlace(i),t.normalizeInPlace(),n.setValue(l,t)}},a=(t,i,s,e)=>{for(let n=t[0];n<t[1];n++){const t=new d(e[2*n+0]/255,e[2*n+1]/255);t.multiplyInPlace(s),t.addInPlace(i),l.setValue(n,t)}},c=t.loadUInt32();if(1==c){{const i=this.__boundingBox,e=t.loadUInt8Array(3*s);h([0,s],i.p0,i.diagonal(),e)}if(n){const i=new I(t.loadFloat32Vec3(),t.loadFloat32Vec3()),e=t.loadUInt8Array(3*s);o([0,s],i.p0,i.diagonal(),e),n.loadSplitValues(t)}if(l){const i=new R(t.loadFloat32Vec2(),t.loadFloat32Vec2()),e=t.loadUInt8Array(2*s);a([0,s],i.p0,i.diagonal(),e),l.loadSplitValues(t)}}else{const i=[];let e=0;for(let s=0;s<c;s++){const s=t.loadUInt32(),h={range:[e,e+s],bbox:new I(t.loadFloat32Vec3(),t.loadFloat32Vec3())};n&&(h.normalsRange=new I(t.loadFloat32Vec3(),t.loadFloat32Vec3())),l&&(h.texCoordsRange=new R(t.loadFloat32Vec2(),t.loadFloat32Vec2())),i.push(h),e+=s}const r=t.loadUInt8Array(3*s);let d,u;n&&(d=t.loadUInt8Array(3*s)),l&&(u=t.loadUInt8Array(2*s));for(let t=0;t<c;t++){{const s=i[t].bbox;h(i[t].range,s.p0,s.diagonal(),r)}if(n){const s=i[t].normalsRange;o(i[t].range,s.p0,s.diagonal(),d)}if(l){const s=i[t].texCoordsRange;a(i[t].range,s.p0,s.diagonal(),u)}}n&&n.loadSplitValues(t),l&&l.loadSplitValues(t)}}toJSON(t,i){let s=super.toJSON(t,i);if(s||(s={}),s.type=N.getClassName(this),!(1024&i)){const e={};for(const[s,n]of this.__vertexAttributes.entries())e[s]=n.toJSON(t,i);s.vertexAttributes=e}return s}fromJSON(t,i,s){super.fromJSON(t,i,s);for(const i in t.vertexAttributes){let s=this.__vertexAttributes.get(i);const e=t.vertexAttributes[i];if(!s){const t=r.getType(e.dataType);s=new VertexAttribute(this,t,0,e.defaultScalarValue),this.__vertexAttributes.set(i,s)}s.fromJSON(e)}}toString(){return JSON.stringify(this.toJSON(),null,2)}}class gi extends fi{constructor(t,i,s,e){super(i,s,e),this.__geom=t,this.__splits={},this.__splitValues=[]}getFaceVertexValueRef(t,i){const s=this.__geom.getFaceVertexIndex(t,i);return s in this.__splits&&t in this.__splits[s]?this.__splitValues[this.__splits[s][t]]:this.getValueRef(s)}setFaceVertexValue(t,i,s){const e=this.__geom.getFaceVertexIndex(t,i);this.setFaceVertexValue_ByVertexIndex(t,e,s)}setFaceVertexValue_ByVertexIndex(t,i,s){const e=this.getValueRef(i);if(e.isValid())if(e.approxEqual(s));else{if(i in this.__splits){const e=this.__splits[i];for(const i in e){const n=e[i];if(this.__splitValues[n].approxEqual(s))return void(e[t]=n)}if(t in this.__splits[i])return void this.__splitValues[this.__splits[i][t]].setFromOther(s)}else this.__splits[i]={};this.__splits[i][t]=this.__splitValues.length,this.__splitValues.push(s)}else e.setFromOther(s)}setSplitVertexValue(t,i,s){if(t in this.__splits||(this.__splits[t]={}),i in this.__splits[t]){if(this.__splitValues[this.__splits[t][i]].approxEqual(s))return;console.warn("Face Vertex Already Split with different value")}this.__splits[t][i]=this.__splitValues.length,this.__splitValues.push(s)}setSplitVertexValues(t,i,s){t in this.__splits||(this.__splits[t]={});const e=this.__splitValues.length;this.__splitValues.push(s);for(const s of i)this.__splits[t][s]=e}getSplits(){return this.__splits}getSplitCount(){let t=0;for(const i in this.__splits)t+=Object.keys(this.__splits[i]).length;return t}generateSplitValues(t,i){if(0==i)return this.__data;const s=this.length,e=this.length+i,n=this.__dataType.numElements?this.__dataType.numElements():1,l=new Float32Array(e*n);for(let t=0;t<this.__data.length;t++)l[t]=this.__data[t];for(const i in t){const e=t[i];for(const t in e){const h=s+e[t];if(i in this.__splits&&t in this.__splits[i]){const s=this.__splits[i][t];6==this.__dataType?l[h*n]=this.__splitValues[s]:this.__dataType.createFromFloat32Buffer(l.buffer,h*n).setFromOther(this.__splitValues[s])}else{const t=parseInt(i);for(let i=0;i<n;i++)t*n+i>this.__data.length&&console.log("Error remapping src:"+t*n+i),h*n+i>l.length&&console.log("Error remapping tgt:"+h*n+i),l[h*n+i]=this.__data[t*n+i]}}}return l}toJSON(t,i){const s=super.toJSON(t,i);return s.splits=this.__splits,s.splitValues=this.__splitValues,s}fromJSON(t,i,s){super.fromJSON(t,i,s),this.__splits=t.splits,this.__splitValues=[];for(const i of t.splitValues)this.__splitValues.push(this.__dataType.createFromJSON(i))}loadSplitValues(t){const i=t.loadUInt32Array();if(0==i.length)return;let s=0,e=0;for(;;){const t=i[s++],n=i[s++],l={};for(let t=0;t<n;t++){const t=i[s++],n=i[s++];l[t]=n,n>=e&&(e=n+1)}if(this.__splits[t]=l,s>=i.length)break}const n=this.__numFloat32Elements,l=t.loadFloat32Array(e*n);this.__splitValues=[];for(let t=0;t<e;t++){const i=this.__dataType.createFromFloat32Array(l.slice(t*n,t*n+n));this.__splitValues.push(i)}}}class Ri extends Vi{constructor(){super()}loadBin(t){this.name=t.loadStr();const i=t.loadUInt32();this.__boundingBox.set(t.loadFloat32Vec3(),t.loadFloat32Vec3()),this.setNumVertices(i);const s=this.vertices;if(i<256){const e=this.__boundingBox.toMat4(),n=t.loadUInt8Array(3*i);for(let t=0;t<i;t++){const i=new Vec3(n[3*t+0]/255,n[3*t+1]/255,n[3*t+2]/255);s.setValue(t,e.transformVec3(i))}}else{const e=t.loadUInt32(),n=[];for(let i=0;i<e;i++){const i=t.loadUInt32Vec2(),s=t.loadFloat32Vec3(),e=t.loadFloat32Vec3();n.push({range:i,bbox:new Box3(s,e)})}const l=t.loadUInt8Array(3*i);for(let t=0;t<e;t++){const i=n[t].bbox.toMat4();for(let e=n[t].range.x;e<n[t].range.y;e++){const t=new Vec3(l[3*e+0]/255,l[3*e+1]/255,l[3*e+2]/255);s.setValue(e,i.transformVec3(t))}}}}readBinary(t,i){super.loadBaseGeomBinary(t),this.geomDataChanged.emit()}}class Wi extends Vi{constructor(){super(),this.__indices=new Uint32Array,this.__segmentAttributes=new Map,this.lineThickness=0}getIndices(){return this.__indices}getNumSegments(){return this.__indices.length/2}setNumSegments(t){const i=new Uint32Array(2*t);this.__indices=i}setSegment(t,i,s){if(t>=this.__indices.length/2)throw new Error("Invalid line index:"+t+". Num Segments:"+this.__indices.length/2);this.__indices[2*t+0]=i,this.__indices[2*t+1]=s}getSegmentVertexIndex(t,i){if(t<this.numLines)return this.__indices[2*t+i]}addSegmentAttribute(t,i,s){const e=new Attribute(i,null!=s?s:this.polygonCount);return this.__segmentAttributes.set(t,e),e}hasSegmentAttribute(t){return this.__segmentAttributes.has(t)}getSegmentAttribute(t){return this.__segmentAttributes.get(t)}genBuffers(){const t=super.genBuffers();let i;return t.numVertices<Math.pow(2,8)?(i=new Uint8Array(this.__indices.length),this.__indices.forEach((t,s)=>{i[s]=t})):t.numVertices<Math.pow(2,16)?(i=new Uint16Array(this.__indices.length),this.__indices.forEach((t,s)=>{i[s]=t})):i=this.__indices,t.indices=i,t}readBinary(t,i){super.loadBaseGeomBinary(t),this.setNumSegments(t.loadUInt32());const s=t.loadUInt8();1==s?this.__indices=t.loadUInt8Array():2==s?this.__indices=t.loadUInt16Array():4==s&&(this.__indices=t.loadUInt32Array()),this.geomDataChanged.emit()}toJSON(t,i){const s=super.toJSON(t,i);return 1024&i||(s.indices=Array.from(this.__indices)),s}fromJSON(t,i,s){super.fromJSON(t,i,s),this.__indices=Uint32Array.from(t.indices)}}class Ii extends Vi{constructor(){super(),this.init()}init(){this.__faceCounts=[],this.__faceVertexCounts=new Uint8Array,this.__faceOffsets=new Uint32Array,this.__faceVertexIndices=new Uint32Array,this.__numPopulatedFaceVertexIndices=0,this.__faceAttributes=new Map,this.__edgeAttributes=new Map,this.__logTopologyWarnings=!1,this.edgeVerts=void 0,this.vertexEdges=void 0,this.numEdges=0,this.edgeFlags=new Uint32Array,this.edgeAngles=new Float32Array}getFaceVertexIndices(){return this.__faceVertexIndices}getFaceCounts(){return this.__faceCounts}clear(){this.__faceVertexIndices=void 0,this.__faceCounts=[],this.__numPopulatedFaceVertexIndices=0}setFaceCounts(t){if(this.__numPopulatedFaceVertexIndices)throw new Error("Cannot set face counts on a mesh that is already populated. Please call 'clear' before re-building the mesh.");this.__faceCounts=t;let i=0,s=0,e=3;for(const t of this.__faceCounts)i+=t,s+=t*e,e++;this.__faceVertexCounts=new Uint8Array(i),this.__faceOffsets=new Uint32Array(i),this.__faceVertexIndices=new Uint32Array(s);for(const t of this.__faceAttributes)t.resize(i)}setFaceVertexIndices(t){const i=Array.prototype.slice.call(arguments,1),s=this.__numPopulatedFaceVertexIndices;for(let t=0;t<i.length;t++)this.__faceVertexIndices[s+t]=i[t];this.__faceVertexCounts[t]=i.length-3,this.__faceOffsets[t]=s,this.__numPopulatedFaceVertexIndices+=i.length}getFaceVertexIndices(t){const i=[],s=this.__faceOffsets[t],e=this.__faceVertexCounts[t]+3;for(let t=0;t<e;t++)i.push(this.__faceVertexIndices[s+t]);return i}getFaceVertexIndex(t,i){return this.__faceVertexIndices[this.__faceOffsets[t]+i]}getNumFaces(){return this.__faceVertexCounts.length}addVertexAttribute(t,i,s){const e=new gi(this,i,null!=this.vertices?this.vertices.length:0,s);return this.__vertexAttributes.set(t,e),e}addFaceAttribute(t,i,s){const e=new fi(i,null!=s?s:this.getNumFaces());return this.__faceAttributes.set(t,e),e}hasFaceAttribute(t){return this.__faceAttributes.has(t)}getFaceAttribute(t){return this.__faceAttributes.get(t)}addEdgeAttribute(t,i,s){const e=new fi(i,null!=s?s:this.getNumEdges());return this.__edgeAttributes.set(t,e),e}hasEdgeAttribute(t){return this.__edgeAttributes.has(t)}getEdgeAttribute(t){return this.__edgeAttributes.get(t)}genTopologyInfo(){const t={};this.vertexEdges=[],this.edgeFaces=[],this.edgeVerts=[],this.faceEdges=[],this.numEdges=0;const i=(i,s)=>{let e=i,n=s;if(n<e){const t=e;e=n,n=t}const l=e+">"+n;if(l in t)return t[l];const h=this.vertices.getValueRef(e),o=this.vertices.getValueRef(n).subtract(h),a={edgeIndex:this.edgeFaces.length/2,edgeVec:o};return t[l]=a,this.edgeFaces.push(-1),this.edgeFaces.push(-1),this.edgeVerts.push(e),this.edgeVerts.push(n),this.numEdges++,a},s=(t,s,e)=>{const n=i(t,s).edgeIndex;if(s<t){const t=2*n+0;this.__logTopologyWarnings&&-1!=this.edgeFaces[t]&&console.warn("Edge poly 0 already set. Mesh is non-manifold."),this.edgeFaces[t]=e}else{const t=2*n+1;this.__logTopologyWarnings&&-1!=this.edgeFaces[t]&&console.warn("Edge poly 1 already set. Mesh is non-manifold."),this.edgeFaces[t]=e}e in this.faceEdges||(this.faceEdges[e]=[]),this.faceEdges[e].push(n),null==this.vertexEdges[t]&&(this.vertexEdges[t]=new Set),null==this.vertexEdges[s]&&(this.vertexEdges[s]=new Set),this.vertexEdges[t].add(n),this.vertexEdges[s].add(n)},e=this.getNumFaces();for(let t=0;t<e;t++){const i=this.getFaceVertexIndices(t);for(let e=0;e<i.length;e++)s(i[e],i[(e+1)%i.length],t)}}computeFaceNormals(){const t=this.vertices,i=this.addFaceAttribute("normals",u),s=this.getNumFaces();for(let e=0;e<s;e++){const s=this.getFaceVertexIndices(e),n=t.getValueRef(s[0]);let l=t.getValueRef(s[1]);const h=new u;for(let i=2;i<s.length;i++){const e=t.getValueRef(s[i]),o=l.subtract(n),a=e.subtract(n);h.addInPlace(o.cross(a).normalize()),l=e}h.lengthSquared(),i.setValue(e,h.normalize())}}generateEdgeFlags(){null==this.vertexEdges&&this.genTopologyInfo(),this.hasFaceAttribute("normals")||this.computeFaceNormals();const t=this.vertices,i=this.getFaceAttribute("normals");this.edgeVecs=[],this.edgeAngles=new Float32Array(this.numEdges);for(let s=0;s<this.edgeFaces.length;s+=2){const e=this.edgeVerts[s],n=t.getValueRef(this.edgeVerts[s+1]).subtract(t.getValueRef(e));n.normalizeInPlace(),this.edgeVecs.push(n);const l=this.edgeFaces[s],h=this.edgeFaces[s+1];if(-1==l||-1==h){this.edgeAngles[s/2]=2*Math.PI;continue}const o=i.getValueRef(l),a=i.getValueRef(h);this.edgeAngles[s/2]=o.angleTo(a)}}computeVertexNormals(t=1){this.generateEdgeFlags();const i=this.getFaceAttribute("normals"),s=this.addVertexAttribute("normals",u),e=i.data.buffer,n=t=>new u(e,12*t),l=s.data,h=(t,i)=>{l[3*t+0]=i.x,l[3*t+1]=i.y,l[3*t+2]=i.z},o=(t,i)=>{let s,e;const n=this.faceEdges[t];for(const t of n)(this.edgeVerts[2*t]==i||this.edgeVerts[2*t+1]==i)&&(s?e=this.edgeVecs[t]:s=this.edgeVecs[t]);return[s,e]};for(let i=0;i<this.vertexEdges.length;i++){if(null==this.vertexEdges[i])continue;const e=this.vertexEdges[i],l=[],a=t=>{let i=!1;for(const s of l)if(i=-1!=s.indexOf(t),i)break;i||l.push([t])};for(const i of e){const s=this.edgeFaces[2*i],e=this.edgeFaces[2*i+1];if(-1!=s&&-1==e&&this.edgeAngles[i]<t){let t=-1,i=-1;for(let n=0;n<l.length;n++)-1==t&&-1!=l[n].indexOf(s)&&(t=n),-1==i&&-1!=l[n].indexOf(e)&&(i=n);-1==t&&-1==i?l.push([s,e]):-1!=t&&-1!=i?t!=i&&(l[t]=l[t].concat(l[i]),l.splice(i,1)):(-1==t&&l[i].push(s),-1==i&&l[t].push(e))}else-1!=s&&a(s),-1!=e&&a(e)}l.sort((t,i)=>t.length<i.length?1:t.length>i.length?-1:0);let c=!0;for(const t of l){const e=new u;for(const s of t){const t=o(s,i),l=t[0].angleTo(t[1]);e.addInPlace(n(s).scale(l))}e.normalizeInPlace(),c?(h(i,e),c=!1):s.setSplitVertexValues(i,t,e)}}return s}computeNumTriangles(){let t=3,i=0;for(const s of this.__faceCounts)i+=s*(t-2),t++;return i}generateTriangulatedIndices(t,i,s){const e=this.computeNumTriangles();let n;n=t<Math.pow(2,8)?new Uint8Array(3*e):t<Math.pow(2,16)?new Uint16Array(3*e):new Uint32Array(3*e);let l=0;const h=function(t,e){t in s&&e in s[t]&&(t=i+s[t][e]),n[l]=t,l++},o=this.getNumFaces();for(let t=0;t<o;t++){const i=this.getFaceVertexIndices(t);for(let s=0;s<i.length;s++)s>=3&&(h(i[0],t),h(i[s-1],t)),h(i[s],t)}return n}computeHardEdgesIndices(t=1){const i=[],s=t=>{i.push(this.edgeVerts[t]),i.push(this.edgeVerts[t+1])};for(let i=0;i<this.edgeFlags.length;i+=2)this.edgeAngles[i/2]>t&&s(i);return i}getWireframeIndices(){return indices}genBuffers(t){const i={};let s=0;for(const[,t]of this.__vertexAttributes){const e=t.getSplits();for(const t in e){t in i||(i[t]={});const n=e[t];for(const e in n){const n=parseInt(e);n in i[t]||(i[t][n]=s,s++)}}}const e=this.vertices.length,n=e+s;let l;t&&0==t.includeIndices||(l=this.generateTriangulatedIndices(n,e,i));const h={};for(const[t,e]of this.__vertexAttributes){let n;n=0==s?e.data:e.generateSplitValues(i,s);const l=e.numElements;h[t]={values:n,count:n.length/l,dimension:l,normalized:"normals"==t,dataType:e.dataType}}const o={numVertices:this.numVertices(),numRenderVerts:n,indices:l,attrBuffers:h};if(t&&t.includeVertexNeighbors){null==this.vertexEdges&&this.genTopologyInfo();let t=0;for(let i=0;i<this.vertexEdges.length;i++)this.vertexEdges[i]&&(t+=this.vertexEdges[i].size);const i=new Uint32Array(2*this.vertexEdges.length+t),s=t=>{for(let i=0;i<t.length;i++){const s=t[i];for(let e=0;e<i;e++){const n=t[e];if(-1!=s[0]&&s[0]==n[1]){i!=e+1&&(t.splice(i,1),t.splice(e+1,0,s));break}if(-1!=s[1]&&s[1]==n[0]){t.splice(i,1),t.splice(e,0,s);break}}}},e=t=>{if(!(-1!=t[0][0]&&-1!=t[t.length-1][1]||-1==t[0][0]&&-1==t[t.length-1][1]))throw new Error("If fan starts with -1, it must also end with -1");for(let i=0;i<t.length;i++){const s=t[i];if((-1==s[0]||-1==s[1])&&0!=i&&i!=t.length-1)throw new Error("-1 only allowed at the beginning and end of a fan.");if(-1!=s[0]){let e=i-1;if(e<0&&(e+=t.length),s[0]!=t[e][1])throw new Error("Faces are not sequential")}if(-1!=s[1]&&s[1]!=t[(i+1)%t.length][0])throw new Error("Faces are not sequential")}};let n=2*this.vertexEdges.length;for(let t=0;t<this.vertexEdges.length;t++){if(null==this.vertexEdges[t])continue;const l=this.vertexEdges[t],h=[];for(const i of l){const s=this.edgeVerts[2*i],e=this.edgeVerts[2*i+1];let n,l=this.edgeFaces[2*i],o=this.edgeFaces[2*i+1];if(s==t)n=e;else{if(e!=t)throw new Error("Invalid topology");{n=s;const t=l;l=o,o=t}}h.push([l,o,n])}s(h),e(h);let o=0;(-1!=h[0][0]||-1!=h[h.length-1][1])&&(o+=1),i[2*t]=n,i[2*t+1]=l.size+(o<<8);for(const t of h)i[n]=t[2],n++}o.vertexNeighbors=i}return o}freeBuffers(){super.freeBuffers(),this.init()}readBinary(t,i){super.loadBaseGeomBinary(t),this.setFaceCounts(t.loadUInt32Array()),this.__faceVertexCounts=t.loadUInt8Array(this.__faceVertexCounts.length);const s=t.loadSInt32Vec2(),e=t.loadUInt8();let n;1==e?n=t.loadUInt8Array():2==e?n=t.loadUInt16Array():4==e&&(n=t.loadUInt32Array());const l=this.getNumFaces();let h=0,o=0;for(let t=0;t<l;t++){const i=this.__faceVertexCounts[t]+3;this.__faceOffsets[t]=h;for(let e=0;e<i;e++){const i=h+e,l=n[i]+s.x;if(0==t)this.__faceVertexIndices[i]=l;else{let s=this.__faceOffsets[t-1];s+=e<o?e:o-1,this.__faceVertexIndices[i]=this.__faceVertexIndices[s]+l}}h+=i,o=i}this.__numPopulatedFaceVertexIndices=h;const a=t.loadUInt32();if(a>0){const i=this.vertices,s=this.addVertexAttribute("lightmapCoords",d);for(let e=0;e<a;e++){const e=new g(t.loadFloat32Vec3(),t.loadFloat32Quat()),n=t.loadFloat32(),l=t.loadFloat32Vec2(),h=t.loadSInt32Vec2(),o=t.loadUInt8();let a;a=1==o?t.loadUInt8Array():2==o?t.loadUInt16Array():t.loadUInt32Array();let c=0;for(const t of a){let o=t+h.x;o+=c,c=o;const a=this.getFaceVertexIndices(o);for(const t of a){const h=i.getValueRef(t),a=e.transformVec3(h),c=new d(a.x,a.z);c.scaleInPlace(n),c.addInPlace(l),s.setFaceVertexValue_ByVertexIndex(o,t,c)}}}}this.hasVertexAttribute("normals")||this.computeVertexNormals(),this.geomDataChanged.emit()}toJSON(t,i){const s=super.toJSON(t,i);return 1024&i||(s.faceCounts=Array.from(this.__faceCounts),s.faceVertexIndices=Array.from(this.__faceVertexIndices)),s}fromJSON(t,i,s){super.fromJSON(t,i,s),t.faceCounts&&(this.__faceCounts=Uint32Array.from(t.faceCounts)),t.faceVertexIndices&&(this.__faceVertexIndices=Uint32Array.from(t.faceVertexIndices))}}class Si extends F{constructor(t){if(super(),this.name=t.name,this.__buffers=t.geomBuffers,this.__buffers.attrBuffers)for(const t in this.__buffers.attrBuffers){const i=this.__buffers.attrBuffers[t],s=r.getType(i.dataType);i.dataType=s}this.boundingBox=new I,this.boundingBox.p0.__data=t.bbox.p0.__data,this.boundingBox.p1.__data=t.bbox.p1.__data,this.__metaData=new Map,this.boundingBoxDirtied=new v,this.geomDataChanged=new v,this.geomDataTopologyChanged=new v}genBuffers(){return this.__buffers}freeBuffers(){if(this.__buffers.indices&&delete this.__buffers.indices,this.__buffers.attrBuffers){for(const t in this.__buffers.attrBuffers)delete this.__buffers.attrBuffers[t];delete this.__buffers.attrBuffers}}getMetadata(t){return this.__metaData.get(t)}hasMetadata(t){return this.__metaData.has(t)}setMetadata(t,i){this.__metaData.set(t,i)}}class Li extends Si{constructor(t){super(t)}}class xi extends Si{constructor(t){super(t)}}class vi extends Si{constructor(t){super(t)}}class Yi extends Ri{constructor(t=1,i=1,s=1,e=1,n=!1){if(super(),isNaN(t)||isNaN(i)||isNaN(s)||isNaN(e))throw new Error("Invalid geom args");this.__x=t,this.__y=i,this.__xDivisions=s,this.__yDivisions=e,n&&this.addVertexAttribute("texCoords",d),this.__rebuild()}get x(){return console.warn("getter is deprectated. Please use 'getX'"),this.getX()}set x(t){console.warn("getter is deprectated. Please use 'setX'"),this.setX(t)}get y(){return console.warn("getter is deprectated. Please use 'getY'"),this.getY()}set y(t){console.warn("getter is deprectated. Please use 'setY'"),this.setY(t)}getX(){return this.__x}setX(t){this.__x=t,this.__resize()}getY(){return this.__y}setY(t){this.__y=t,this.__resize()}setSize(t,i){this.__x=t,this.__y=i,this.__resize()}__rebuild(){this.setNumVertices(this.__xDivisions*this.__yDivisions);const t=this.getVertexAttribute("texCoords");if(t)for(let i=0;i<this.__yDivisions;i++){const s=i/(this.__yDivisions-1);for(let e=0;e<this.__xDivisions;e++){const n=e/(this.__xDivisions-1);t.getValueRef(i*this.__xDivisions+e).set(n,s)}}this.__resize()}__resize(){for(let t=0;t<this.__yDivisions;t++){const i=(t/(this.__yDivisions-1)-.5)*this.__y;for(let s=0;s<this.__xDivisions;s++){const e=(s/(this.__xDivisions-1)-.5)*this.__x;this.getVertex(t*this.__xDivisions+s).set(e,i,0)}}this.setBoundingBoxDirty()}toJSON(){const t=super.toJSON();return t.x=this.__x,t.y=this.__y,t.xDivisions=this.__xDivisions,t.yDivisions=this.__yDivisions,t}}class Mi extends Wi{constructor(t=1,i=1){if(super(),isNaN(t)||isNaN(i))throw new Error("Invalid geom args");this.__x=this.addParameter(new ut("x",t)),this.__x.valueChanged.connect(this.__resize.bind(this)),this.__y=this.addParameter(new ut("y",i)),this.__y.valueChanged.connect(this.__resize.bind(this)),this.__rebuild()}get x(){return this.__x.getValue()}set x(t){this.__x.setValue(t)}get y(){return this.__y.getValue()}set y(t){this.__y.setValue(t)}setSize(t,i){this.__x.setValue(t,-1),this.__y.setValue(i,-1),this.__resize()}__rebuild(){this.setNumVertices(4),this.setNumSegments(4),this.setSegment(0,0,1),this.setSegment(1,1,2),this.setSegment(2,2,3),this.setSegment(3,3,0),this.__resize(-1),this.geomDataTopologyChanged.emit()}__resize(t){const i=this.__x.getValue(),s=this.__y.getValue();this.getVertex(0).set(-.5*i,-.5*s,0),this.getVertex(1).set(.5*i,-.5*s,0),this.getVertex(2).set(.5*i,.5*s,0),this.getVertex(3).set(-.5*i,.5*s,0),this.setBoundingBoxDirty(),-1!=t&&this.geomDataChanged.emit()}toJSON(){const t=super.toJSON();return t.x=this.__x,t.y=this.__y,t}}N.registerClass("Rect",Mi);class Ki extends Wi{constructor(t=1,i=2*Math.PI,s=32){if(super(),isNaN(t)||isNaN(s))throw new Error("Invalid geom args");this.__radius=this.addParameter(new ut("Radius",t)),this.__angle=this.addParameter(new ut("Angle",i)),this.__numSegments=this.addParameter(new ut("NumSegments",s>=3?s:3,[3,200],1)),this.__radius.valueChanged.connect(this.__resize.bind(this)),this.__angle.valueChanged.connect(this.__rebuild.bind(this)),this.__numSegments.valueChanged.connect(this.__rebuild.bind(this)),this.__rebuild()}__rebuild(){const t=this.__numSegments.getValue();this.setNumVertices(t);const i=this.__angle.getValue()<2*Math.PI;this.setNumSegments(i?t-1:t);for(let s=0;s<(i?t-1:t);s++)this.setSegment(s,s,(s+1)%t);this.__resize(-1),this.geomDataTopologyChanged.emit()}__resize(t){const i=this.__radius.getValue(),s=this.__numSegments.getValue(),e=this.__angle.getValue()/s;for(let t=0;t<s;t++)this.getVertex(t).set(Math.cos(e*t)*i,Math.sin(e*t)*i,0);this.setBoundingBoxDirty(),-1!=t&&this.geomDataChanged.emit()}}N.registerClass("Circle",Ki);class Ci extends Wi{constructor(t=1){if(super(),isNaN(t))throw new Error("Invalid geom args");this.__sizeParam=this.addParameter(new ut("size",t)),this.__rebuild(),this.__sizeParam.valueChanged.connect(()=>{this.__resize()})}get size(){return this.__size}set size(t){this.__size=t,this.__resize()}__rebuild(){this.setNumVertices(6),this.setNumSegments(3),this.setSegment(0,0,1),this.setSegment(1,2,3),this.setSegment(2,4,5),this.__resize()}__resize(){const t=this.__sizeParam.getValue();this.getVertex(0).set(-.5*t,0,0),this.getVertex(1).set(.5*t,0,0),this.getVertex(2).set(0,.5*t,0),this.getVertex(3).set(0,-.5*t,0),this.getVertex(4).set(0,0,.5*t),this.getVertex(5).set(0,0,-.5*t),this.setBoundingBoxDirty()}}N.registerClass("Cross",Ci);class wi extends Wi{constructor(t=1,i=1,s=1,e=!1){super(),this.__x=this.addParameter(new ut("x",t)),this.__x.valueChanged.connect(this.__resize.bind(this)),this.__y=this.addParameter(new ut("y",i)),this.__y.valueChanged.connect(this.__resize.bind(this)),this.__z=this.addParameter(new ut("z",s)),this.__z.valueChanged.connect(this.__resize.bind(this)),this.__baseZAtZero=this.addParameter(new ut("BaseZAtZero",e)),this.__baseZAtZero.valueChanged.connect(this.__rebuild.bind(this)),this.__rebuild()}__rebuild(){this.setNumVertices(8),this.setNumSegments(12),this.setSegment(0,0,1),this.setSegment(1,1,2),this.setSegment(2,2,3),this.setSegment(3,3,0),this.setSegment(4,4,5),this.setSegment(5,5,6),this.setSegment(6,6,7),this.setSegment(7,7,4),this.setSegment(8,0,4),this.setSegment(9,1,5),this.setSegment(10,2,6),this.setSegment(11,3,7),this.__resize(-1),this.geomDataTopologyChanged.emit()}__resize(t){const i=this.__x.getValue(),s=this.__y.getValue(),e=this.__z.getValue(),n=this.__baseZAtZero.getValue();let l=.5;n&&(l=1),this.getVertex(0).set(.5*i,-.5*s,l*e),this.getVertex(1).set(.5*i,.5*s,l*e),this.getVertex(2).set(-.5*i,.5*s,l*e),this.getVertex(3).set(-.5*i,-.5*s,l*e),l=-.5,n&&(l=0),this.getVertex(4).set(.5*i,-.5*s,l*e),this.getVertex(5).set(.5*i,.5*s,l*e),this.getVertex(6).set(-.5*i,.5*s,l*e),this.getVertex(7).set(-.5*i,-.5*s,l*e),this.setBoundingBoxDirty(),-1!=t&&this.geomDataChanged.emit()}toJSON(){const t=super.toJSON();return t.size=this.__size,t}}N.registerClass("LinesCuboid",wi);class Fi extends Wi{constructor(t=1,i=1,s=10,e=10,n=!1){if(super(),isNaN(t)||isNaN(i)||isNaN(s)||isNaN(e))throw new Error("Invalid geom args");this.__xParam=this.addParameter(new ut("x",t)),this.__yParam=this.addParameter(new ut("y",i)),this.__xDivisionsParam=this.addParameter(new ut("xDivisions",s)),this.__yDivisionsParam=this.addParameter(new ut("yDivisions",e)),this.__skipCenterLinesParam=this.addParameter(new bt("skipCenterLines",n)),this.__rebuild()}get sizeX(){return this.__x}set sizeX(t){this.__x=t,this.__resize()}get sizeY(){return this.__y}set sizeY(t){this.__y=t,this.__resize()}get divisionsX(){return this.__xDivisions}set divisionsX(t){this.__xDivisions=t,this.__rebuild()}get divisionsY(){return this.__yDivisions}set divisionsY(t){this.__yDivisions=t,this.__rebuild()}setSize(t,i){this.__x=t,this.__y=i,this.__resize()}__rebuild(){const t=this.__xDivisionsParam.getValue(),i=this.__yDivisionsParam.getValue(),s=this.__skipCenterLinesParam.getValue()&&t%2==0&&i%2==0;this.setNumVertices(2*(t+i+2-(s?1:0))),this.setNumSegments(t+i+2-(s?1:0));let e=0;for(let i=0;i<=t;i++)s&&i==t/2||(this.setSegment(e,2*e,2*e+1),e++);for(let n=0;n<=i;n++)s&&n==t/2||(this.setSegment(e,2*e,2*e+1),e++);this.__resize()}__resize(){const t=this.__xDivisionsParam.getValue(),i=this.__yDivisionsParam.getValue(),s=this.__xParam.getValue(),e=this.__yParam.getValue(),n=this.__skipCenterLinesParam.getValue()&&t%2==0&&i%2==0;let l=0;for(let i=0;i<=t;i++){if(n&&i==t/2)continue;const h=2*l+1,o=(i/t-.5)*s;this.getVertex(2*l).set(o,-.5*e,0),this.getVertex(h).set(o,.5*e,0),l++}for(let h=0;h<=i;h++){if(n&&h==t/2)continue;const o=2*l+1,a=(h/i-.5)*e;this.getVertex(2*l).set(-.5*s,a,0),this.getVertex(o).set(.5*s,a,0),l++}this.setBoundingBoxDirty()}toJSON(){const t=super.toJSON();return t.x=this.__x,t.z=this.__y,t.xDivisions=this.__xDivisions,t.yDivisions=this.__yDivisions,t}}N.registerClass("Grid",Fi);class Ni extends Ii{constructor(t=.5,i=1,s=32,e=!0){if(super(),isNaN(t)||isNaN(i)||isNaN(s))throw new Error("Invalid geom args");this.__radiusParam=this.addParameter(new ut("radius",t)),this.__heightParam=this.addParameter(new ut("height",i)),this.__detailParam=this.addParameter(new ut("detail",s>=3?s:3,[3,200],1)),this.__capParam=this.addParameter(new bt("cap",e)),this.addVertexAttribute("texCoords",d),this.addVertexAttribute("normals",u),this.__rebuild();const n=()=>{this.__resize()},l=()=>{this.__rebuild()};this.__radiusParam.valueChanged.connect(n),this.__heightParam.valueChanged.connect(n),this.__detailParam.valueChanged.connect(l),this.__capParam.valueChanged.connect(l)}get radius(){return this.__radiusParam.getValue()}set radius(t){this.__radiusParam.setValue(t),this.__resize()}get height(){return this.__heightParam.getValue()}set height(t){this.__heightParam.setValue(t),this.__resize()}get detail(){return this.__detailParam.getValue()}set detail(t){this.__detailParam.setValue(t),this.__rebuild()}get cap(){return this.__capParam.getValue()}set cap(t){this.__capParam.setValue(t),this.__rebuild()}__rebuild(){this.clear();const t=this.__detailParam.getValue(),i=this.__radiusParam.getValue(),s=this.__heightParam.getValue(),e=this.__capParam.getValue();let n=t+1;e&&(n+=1),this.setNumVertices(n);const l=t,h=t+1;this.getVertex(l).set(0,0,s);for(let s=0;s<t;s++){const e=s/t*2*Math.PI;this.getVertex(s).set(i*Math.cos(e),i*Math.sin(e),0)}e&&this.getVertex(h).set(0,0,0),this.setFaceCounts([t+(e?t:0)]);for(let i=0;i<t;i++)this.setFaceVertexIndices(i,(i+1)%t,i,l);if(e)for(let i=0;i<t;i++)this.setFaceVertexIndices(t+i,i,(i+1)%t,h);const o=this.getVertexAttribute("normals");let a;const c=s;Math.abs(s)<1e-12&&(a=s<0?-1e-12:1e-12),a=i/c;let r=0;for(let i=0;i<t;i++){const s=(i+1)/t*2*Math.PI,e=i/t*2*Math.PI,n=.5*(s+e);o.setFaceVertexValue(r,0,new u(Math.cos(s),a,Math.sin(s)).normalize()),o.setFaceVertexValue(r,1,new u(Math.cos(e),a,Math.sin(e)).normalize()),o.setFaceVertexValue(r,2,new u(Math.cos(n),a,Math.sin(n)).normalize()),r++}if(e){const i=new u(0,-1,0);for(let s=0;s<t;s++)o.setFaceVertexValue(r,0,i),o.setFaceVertexValue(r,1,i),o.setFaceVertexValue(r,2,i),r++}const m=this.getVertexAttribute("texCoords");r=0;for(let i=0;i<t;i++)m.setFaceVertexValue(r,0,new d((i+1)/t,0)),m.setFaceVertexValue(r,1,new d(i/t,0)),m.setFaceVertexValue(r,2,new d((i+.5)/t,1));if(e)for(let i=0;i<t;i++)m.setFaceVertexValue(r,0,new d(i/t,0)),m.setFaceVertexValue(r,1,new d((i+1)/t,0)),m.setFaceVertexValue(r,2,new d((i+.5)/t,1)),r++;this.setBoundingBoxDirty()}__resize(){const t=this.__detailParam.getValue(),i=this.__radiusParam.getValue(),s=this.__heightParam.getValue(),e=(this.__capParam.getValue(),t),n=t+1;this.getVertex(e).set(0,0,s);for(let s=0;s<t;s++){const e=s/t*2*Math.PI;this.getVertex(s).set(i*Math.cos(e),i*Math.sin(e),0)}this.__cap&&this.getVertex(n).set(0,0,0),this.setBoundingBoxDirty()}}N.registerClass("Cone",Ni);class Ti extends Ii{constructor(t=1,i=1,s=1,e=!1){if(super(),isNaN(t)||isNaN(i)||isNaN(s))throw new Error("Invalid geom args");this.__xParam=this.addParameter(new ut("x",t)),this.__yParam=this.addParameter(new ut("y",i)),this.__zParam=this.addParameter(new ut("z",s)),this.__baseZAtZeroParam=this.addParameter(new bt("baseZAtZero",e)),this.setFaceCounts([0,6]),this.setFaceVertexIndices(0,0,1,2,3),this.setFaceVertexIndices(1,7,6,5,4),this.setFaceVertexIndices(2,1,0,4,5),this.setFaceVertexIndices(3,3,2,6,7),this.setFaceVertexIndices(4,0,3,7,4),this.setFaceVertexIndices(5,2,1,5,6),this.setNumVertices(8),this.addVertexAttribute("texCoords",d),this.addVertexAttribute("normals",u),this.__rebuild();const n=()=>{this.__resize()};this.__xParam.valueChanged.connect(n),this.__yParam.valueChanged.connect(n),this.__zParam.valueChanged.connect(n),this.__baseZAtZeroParam.valueChanged.connect(n)}setSize(t,i,s){this.__xParam.setValue(t),this.__yParam.setValue(i),this.__zParam.setValue(s)}setBaseSize(t,i){this.__xParam.setValue(t),this.__yParam.setValue(i)}__rebuild(){const t=this.getVertexAttribute("normals");for(let i=0;i<6;i++){let s;switch(i){case 0:s=new u(0,0,1);break;case 1:s=new u(0,0,-1);break;case 2:s=new u(1,0,0);break;case 3:s=new u(-1,0,0);break;case 4:s=new u(0,1,0);break;case 5:s=new u(0,-1,0)}t.setFaceVertexValue(i,0,s),t.setFaceVertexValue(i,1,s),t.setFaceVertexValue(i,2,s),t.setFaceVertexValue(i,3,s)}const i=this.getVertexAttribute("texCoords");for(let t=0;t<6;t++)i.setFaceVertexValue(t,0,new d(0,0)),i.setFaceVertexValue(t,1,new d(1,0)),i.setFaceVertexValue(t,2,new d(1,1)),i.setFaceVertexValue(t,3,new d(0,1));this.__resize()}__resize(t){const i=this.__xParam.getValue(),s=this.__yParam.getValue(),e=this.__zParam.getValue(),n=this.__baseZAtZeroParam.getValue();let l=.5;n&&(l=1),this.getVertex(0).set(.5*i,-.5*s,l*e),this.getVertex(1).set(.5*i,.5*s,l*e),this.getVertex(2).set(-.5*i,.5*s,l*e),this.getVertex(3).set(-.5*i,-.5*s,l*e),l=-.5,n&&(l=0),this.getVertex(4).set(.5*i,-.5*s,l*e),this.getVertex(5).set(.5*i,.5*s,l*e),this.getVertex(6).set(-.5*i,.5*s,l*e),this.getVertex(7).set(-.5*i,-.5*s,l*e),this.setBoundingBoxDirty(),this.geomDataChanged.emit()}toJSON(){const t=super.toJSON();return t.x=this.__x,t.y=this.__y,t.z=this.__z,t}}N.registerClass("Cuboid",Ti);class Ji extends Ii{constructor(t=.5,i=1,s=32,e=2,n=!0,l=!1){if(super(),isNaN(t)||isNaN(i)||isNaN(s)||isNaN(e))throw new Error("Invalid geom args");this.__radiusParam=this.addParameter(new ut("radius",t)),this.__heightParam=this.addParameter(new ut("height",i)),this.__sidesParam=this.addParameter(new ut("sides",s>=3?s:3,[3,200],1)),this.__loopsParam=this.addParameter(new ut("loops",e>=2?e:2,[1,200],1)),this.__capsParam=this.addParameter(new bt("caps",n)),this.__baseZAtZeroParam=this.addParameter(new bt("baseZAtZero",l)),this.addVertexAttribute("texCoords",d),this.addVertexAttribute("normals",u),this.__rebuild();const h=()=>{this.__resize()},o=()=>{this.__rebuild()};this.__radiusParam.valueChanged.connect(h),this.__heightParam.valueChanged.connect(h),this.__sidesParam.valueChanged.connect(o),this.__loopsParam.valueChanged.connect(o),this.__capsParam.valueChanged.connect(o),this.__baseZAtZeroParam.valueChanged.connect(h)}__rebuild(){this.clear(),this.__radiusParam.getValue();const t=this.__sidesParam.getValue(),i=this.__loopsParam.getValue(),s=(this.__heightParam.getValue(),this.__capsParam.getValue());this.__baseZAtZeroParam.getValue();let e=t*i;s&&(e+=2),this.setNumVertices(e),this.setFaceCounts(s?[2*t,t]:[0,t]);let n=0;for(let s=0;s<i-1;s++)for(let i=0;i<t;i++)this.setFaceVertexIndices(n++,t*s+(i+1)%t,t*s+i,t*(s+1)+i,t*(s+1)+(i+1)%t);if(s){for(let i=0;i<t;i++)this.setFaceVertexIndices(n++,e-1,i,(i+1)%t);for(let s=0;s<t;s++)this.setFaceVertexIndices(n++,t*(i-1)+s,e-2,t*(i-1)+(s+1)%t)}const l=this.getVertexAttribute("normals");n=0;for(let s=0;s<i-1;s++)for(let i=0;i<t;i++){let s=i/t*2*Math.PI;const e=new u(Math.sin(s),Math.cos(s),0);l.setFaceVertexValue(n,0,e),l.setFaceVertexValue(n,1,e),s=(i+1)/t*2*Math.PI;const h=new u(Math.sin(s),Math.cos(s),0);l.setFaceVertexValue(n,2,h),l.setFaceVertexValue(n,3,h),n++}if(s){const i=new u(0,0,-1);for(let s=0;s<t;s++)l.setFaceVertexValue(n,0,i),l.setFaceVertexValue(n,1,i),l.setFaceVertexValue(n,2,i),n++;i.set(0,0,1);for(let s=0;s<t;s++)l.setFaceVertexValue(n,0,i),l.setFaceVertexValue(n,1,i),l.setFaceVertexValue(n,2,i),n++}const h=this.getVertexAttribute("texCoords");n=0;for(let i=0;i<t;i++)h.setFaceVertexValue(n,0,new d((i+1)/t,0)),h.setFaceVertexValue(n,2,new d((i+1)/t,1)),h.setFaceVertexValue(n,1,new d(i/t,0)),h.setFaceVertexValue(n,3,new d(i/t,1)),n++;if(s){for(let i=0;i<t;i++)h.setFaceVertexValue(n,0,new d(i/t,0)),h.setFaceVertexValue(n,1,new d((i+1)/t,0)),h.setFaceVertexValue(n,2,new d((i+.5)/t,1)),n++;for(let i=0;i<t;i++)h.setFaceVertexValue(n,0,new d(i/t,0)),h.setFaceVertexValue(n,1,new d((i+1)/t,0)),h.setFaceVertexValue(n,2,new d((i+.5)/t,1)),n++}this.geomDataTopologyChanged.emit(),this.__resize()}__resize(){const t=this.__sidesParam.getValue(),i=this.__loopsParam.getValue(),s=this.__radiusParam.getValue(),e=this.__heightParam.getValue(),n=this.__capsParam.getValue(),l=this.__baseZAtZeroParam.getValue();let h=t*i;n&&(h+=2);let o=0,a=.5;l&&(a=0);for(let n=0;n<i;n++){const l=n/(i-1)*e-e*a;for(let i=0;i<t;i++){const e=i/t*2*Math.PI;this.getVertex(o).set(Math.sin(e)*s,Math.cos(e)*s,l),o++}}n&&(this.getVertex(h-1).set(0,0,e*(l?0:-.5)),this.getVertex(h-2).set(0,0,e*(l?1:.5))),this.setBoundingBoxDirty(),this.geomDataChanged.emit()}}N.registerClass("Cylinder",Ji);class zi extends Ii{constructor(t=.5,i=32){if(super(),isNaN(t)||isNaN(i))throw new Error("Invalid geom args");this.__radiusParam=this.addParameter(new ut("radius",t)),this.__sidesParam=this.addParameter(new ut("sides",i>=3?i:3,[3,200],1)),this.addVertexAttribute("texCoords",d),this.addVertexAttribute("normals",u),this.__rebuild()}get radius(){return this.__radius}set radius(t){this.__radius=t,this.__resize()}set sides(t){this.__sides=t>=3?t:3,this.__rebuild()}__rebuild(){const t=this.__sidesParam.getValue();this.setNumVertices(t+1),this.setFaceCounts([t]),this.getVertex(0).set(0,0,0);for(let i=0;i<t;i++)this.setFaceVertexIndices(i,0,i%t+1,(i+1)%t+1);const i=this.getVertexAttribute("normals"),s=new u(0,0,1);i.setValue(0,s);for(let e=0;e<t;e++)i.setValue(e+1,s);const e=this.getVertexAttribute("texCoords");e.getValueRef(0).set(.5,.5);for(let i=0;i<t;i++){const s=i/t*2*Math.PI;e.getValueRef(i+1).set(.5*Math.sin(s)+.5,.5*Math.cos(s)+.5)}this.setBoundingBoxDirty(),this.__resize()}__resize(){const t=this.__sidesParam.getValue(),i=this.__radiusParam.getValue();for(let s=0;s<t;s++){const e=s/t*2*Math.PI;this.getVertex(s+1).set(Math.sin(e)*i,Math.cos(e)*i,0)}this.setBoundingBoxDirty()}toJSON(){const t=super.toJSON();return t.radius=this.__radius,t}}N.registerClass("Disc",zi);class Hi extends Ii{constructor(t=1,i=1,s=1,e=1,n=!0,l=!0){if(super(),isNaN(t)||isNaN(i)||isNaN(s)||isNaN(e))throw new Error("Invalid geom args");this.__sizeXParam=this.addParameter(new ut("SizeX",t)),this.__sizeYParam=this.addParameter(new ut("SizeY",i)),this.__detailXParam=this.addParameter(new ut("DetailX",s)),this.__detailYParam=this.addParameter(new ut("DetailY",e)),n&&this.addVertexAttribute("normals",u),l&&this.addVertexAttribute("texCoords",d),this.__rebuild(),this.__sizeXParam.valueChanged.connect(this.__resize.bind(this)),this.__sizeYParam.valueChanged.connect(this.__resize.bind(this)),this.__detailXParam.valueChanged.connect(this.__rebuild.bind(this)),this.__detailYParam.valueChanged.connect(this.__rebuild.bind(this))}__rebuild(){const t=this.__detailXParam.getValue(),i=this.__detailYParam.getValue();this.setNumVertices((t+1)*(i+1)),this.setFaceCounts([0,t*i]);let s=0;for(let e=0;e<i;e++)for(let i=0;i<t;i++)this.setFaceVertexIndices(s,(t+1)*(e+1)+i,(t+1)*(e+1)+(i+1),(t+1)*e+(i+1),(t+1)*e+i),s+=1;let e=0;const n=this.getVertexAttribute("normals");if(n)for(let s=0;s<=i;s++)for(let i=0;i<=t;i++)n.getValueRef(e).set(0,0,1),e++;e=0;const l=this.getVertexAttribute("texCoords");if(l)for(let s=0;s<=i;s++){const n=s/i;for(let i=0;i<=t;i++){const s=i/t;l.getValueRef(e).set(s,n),e++}}this.__resize(!1),this.geomDataTopologyChanged.emit()}__resize(t=!0){const i=this.__sizeXParam.getValue(),s=this.__sizeYParam.getValue(),e=this.__detailXParam.getValue(),n=this.__detailYParam.getValue();let l=0;for(let t=0;t<=n;t++){const h=(t/n-.5)*s;for(let t=0;t<=e;t++){const s=(t/e-.5)*i;this.getVertex(l).set(s,h,0),l++}}this.setBoundingBoxDirty(),t&&this.geomDataChanged.emit()}}class Ui extends Ii{constructor(t=1,i=12,s=12){if(super(),isNaN(t)||isNaN(i)||isNaN(s))throw new Error("Invalid geom args");this.__radiusParam=this.addParameter(new ut("radius",t)),this.__sidesParam=this.addParameter(new ut("sides",i>=3?i:3,[3,200],1)),this.__loopsParam=this.addParameter(new ut("loops",s>=3?s:3,[3,200],1)),this.addVertexAttribute("texCoords",d),this.addVertexAttribute("normals",u),this.__rebuild();const e=()=>{this.__rebuild()};this.__radiusParam.valueChanged.connect(()=>{this.__resize()}),this.__sidesParam.valueChanged.connect(e),this.__loopsParam.valueChanged.connect(e)}__rebuild(){const t=this.__radiusParam.getValue(),i=this.__sidesParam.getValue(),s=this.__loopsParam.getValue(),e=2+i*s,n=2*i,l=i*s;this.setNumVertices(e),this.setFaceCounts([n,l]);const h=this.getVertexAttribute("normals"),o=new u(0,0,1);let a=0;this.getVertex(a).set(0,0,t),h.getValueRef(a).set(0,0,1),a++;for(let e=0;e<s;e++){const n=(e+1)/(s+1)*Math.PI;for(let s=0;s<i;s++){const e=s/i*2*Math.PI;o.set(Math.sin(n)*Math.cos(e),Math.sin(n)*Math.sin(e),Math.cos(n)),this.getVertex(a).setFromOther(o.scale(t)),h.getValueRef(a).setFromOther(o),a++}}this.getVertex(a).set(0,0,-t),h.getValueRef(a).set(0,0,-1),a++;const c=this.getVertexAttribute("texCoords");let r=0;for(let t=0;t<i;t++){this.setFaceVertexIndices(r,0,(t+1)%i+1,t+1);const e=new d(.5,0),n=new d(1-(t+1)/i,0),l=new d(1-t/i,1/(s+1));c.setFaceVertexValue(r,0,e),c.setFaceVertexValue(r,1,n),c.setFaceVertexValue(r,2,l),r++}for(let t=0;t<i;t++){this.setFaceVertexIndices(r,e-1,i*(s-1)+t+1,i*(s-1)+(t+1)%i+1);const n=new d(1-t/i,s/(s+1)),l=new d(1-(t+1)/i,s/(s+1)),h=new d(.5,1);c.setFaceVertexValue(r,0,n),c.setFaceVertexValue(r,1,l),c.setFaceVertexValue(r,2,h),r++}for(let t=0;t<s-1;t++)for(let e=0;e<i;e++)this.setFaceVertexIndices(r,i*t+e+1,i*t+(e+1)%i+1,i*(t+1)+(e+1)%i+1,i*(t+1)+e+1),c.setFaceVertexValue(r,0,new d(t/s,e/s)),c.setFaceVertexValue(r,1,new d(t/s,(e+1)/s)),c.setFaceVertexValue(r,2,new d((t+1)/s,(e+1)/s)),c.setFaceVertexValue(r,3,new d((t+1)/s,e/s)),r++;this.setBoundingBoxDirty(),this.geomDataTopologyChanged.emit()}__resize(){const t=this.__radiusParam.getValue(),i=this.__sidesParam.getValue(),s=this.__loopsParam.getValue();let e=0;const n=new u(0,0,1);this.getVertex(e).set(0,0,t),e++;for(let l=0;l<s;l++){const h=(l+1)/(s+1)*Math.PI;for(let s=0;s<i;s++){const l=s/i*2*Math.PI;n.set(Math.sin(h)*Math.cos(l),Math.sin(h)*Math.sin(l),Math.cos(h)),this.getVertex(e).setFromOther(n.scale(t)),e++}}this.getVertex(e).set(0,0,-t),e++,this.setBoundingBoxDirty(),this.geomDataChanged.emit()}}N.registerClass("Sphere",Ui);class ki extends Ii{constructor(t=.5,i=1,s=32){if(super(),isNaN(t)||isNaN(i)||isNaN(s))throw new Error("Invalid geom args");this.__innerRadius=t,this.__outerRadius=i,this.__detail=s>=3?s:3,this.addVertexAttribute("texCoords",d),this.addVertexAttribute("normals",u),this.__rebuild()}get innerRadius(){return this.__innerRadius}set innerRadius(t){this.__innerRadius=t,this.__resize()}get outerRadius(){return this.__outerRadius}set outerRadius(t){this.__outerRadius=t,this.__resize()}get detail(){return this.__detail}set detail(t){this.__detail=t>=3?t:3,this.__rebuild()}__rebuild(){const t=this.__detail,i=2*this.__detail;this.setNumVertices(t*i),this.setFaceCounts([0,t*i]);const s=this.getVertexAttribute("normals");let e=0;for(let n=0;n<i;n++){const l=n/i*2*Math.PI,h=Math.cos(l),o=Math.sin(l);for(let i=0;i<t;i++){const n=i/t*2*Math.PI,l=Math.sin(n),a=Math.cos(n),c=this.__outerRadius+a*this.__innerRadius;this.getVertex(e).set(h*c,o*c,this.__innerRadius*l),s.getValueRef(e).set(h*a,o*a,l),e++}}const n=this.getVertexAttribute("texCoords");let l=0;for(let s=0;s<i;s++)for(let e=0;e<t;e++){const h=(s+1)%i,o=(e+1)%t;this.setFaceVertexIndices(l,t*s+e,t*s+o,t*h+o,t*h+e),n.setFaceVertexValue(l,0,new d(s/i,e/i)),n.setFaceVertexValue(l,1,new d(s/i,(e+1)/i)),n.setFaceVertexValue(l,2,new d((s+1)/i,(e+1)/i)),n.setFaceVertexValue(l,3,new d((s+1)/i,e/i)),l++}this.setBoundingBoxDirty()}__resize(){const t=this.__detail,i=2*this.__detail;for(let s=0;s<i;s++){const e=s/i*2*Math.PI,n=Math.cos(e),l=Math.sin(e);for(let i=0;i<t;i++){const s=i/t*2*Math.PI,e=Math.sin(s),h=Math.cos(s),o=this.__outerRadius+h*this.__innerRadius;this.getVertex(0).set(n*o,l*o,this.__innerRadius*e),index++}}this.setBoundingBoxDirty()}toJSON(){const t=super.toJSON();return t.x=this.__x,t.y=this.__y,t.z=this.__z,t}}const Bi={SAVE_FLAG_SKIP_CHILDREN:1},Pi={LOAD_FLAG_LOADING_BIN_TREE_VALUES:16},Ei={CLONE_FLAG_INSTANCED_TREE:1};class Qi extends Q{constructor(t){super(t),this.__visibleCounter=1,this.__visible=!0,this.__highlightMapping={},this.__highlights=[],this.__childItems=[],this.__childItemsSignalIds=[],this.__childItemsMapping={},this.__components=[],this.__componentMapping={},this.mouseDown=new v,this.mouseUp=new v,this.mouseMove=new v,this.mouseEnter=new v,this.mouseLeave=new v,this.__visibleParam=this.addParameter(new bt("Visible",!0)),this.__localXfoParam=this.addParameter(new Vt("LocalXfo",new g)),this.__globalXfoParam=this.addParameter(new Vt("GlobalXfo",new g)),this.__boundingBoxParam=this.addParameter(new U("BoundingBox",new I)),this.parentChanged=this.ownerChanged,this.childAdded=new v,this.childRemoved=new v,this.highlightChanged=new v,this.visibilityChanged=new v,this.localXfoChanged=this.__localXfoParam.valueChanged,this.globalXfoChanged=this.__globalXfoParam.valueChanged,this.boundingChanged=this.__boundingBoxParam.valueChanged,this._cleanGlobalXfo=this._cleanGlobalXfo.bind(this),this._setGlobalXfoDirty=this._setGlobalXfoDirty.bind(this),this._setBoundingBoxDirty=this._setBoundingBoxDirty.bind(this),this._cleanBoundingBox=this._cleanBoundingBox.bind(this),this.__localXfoParam.valueChanged.connect(this._setGlobalXfoDirty);const i=()=>{const t=this.__globalXfoParam.getValue();return void 0!==this.__ownerItem?this.__ownerItem.getGlobalXfo().inverse().multiply(t):t};this.__globalXfoParam.valueChanged.connect(t=>{t!=J.OPERATOR_DIRTIED&&this.__localXfoParam.setDirty(i),this._setBoundingBoxDirty()}),this.__visibleParam.valueChanged.connect(()=>{this.__visibleCounter+=this.__visibleParam.getValue()?1:-1,this.__updateVisiblity()})}static get SaveFlags(){return Bi}static get LoadFlags(){return Pi}static get CloneFlags(){return Ei}static getSelectionOutlineColor(){return selectionOutlineColor}static setSelectionOutlineColor(t){selectionOutlineColor=t}static getBranchSelectionOutlineColor(){return branchSelectionOutlineColor}static setBranchSelectionOutlineColor(t){branchSelectionOutlineColor=t}_childFlagsChanged(t){0!=(t&z.USER_EDITED)&&this.setFlag(P.USER_EDITED)}setFlag(t){super.setFlag(t),this.__ownerItem&&this.__ownerItem._childFlagsChanged(t)}setOwner(t){if(this.__ownerItem){this.__ownerItem.globalXfoChanged.disconnect(this._setGlobalXfoDirty),this.__ownerItem.getVisible()||this.__visibleCounter++;const t=this.__ownerItem.getChildIndex(this);t>=0&&this.__ownerItem.__unbindChild(t,this)}super.setOwner(t),this._setGlobalXfoDirty(),this.__ownerItem&&(this.setSelectable(this.__ownerItem.getSelectable(),!0),this.__ownerItem.getVisible()||this.__visibleCounter--,this.__ownerItem.globalXfoChanged.connect(this._setGlobalXfoDirty)),this.__updateVisiblity()}__updatePath(){super.__updatePath();for(const t of this.__childItems)t&&t.__updatePath();for(const t of this.__components)t&&t.__updatePath()}getParentItem(){return this.getOwner()}setParentItem(t){this.setOwner(t)}getLocalXfo(){return this.__localXfoParam.getValue()}setLocalXfo(t,i){this.__localXfoParam.setValue(t,i)}getGlobalXfo(t){return this.__globalXfoParam.getValue(t)}setGlobalXfo(t,i){const s=this.getOwner();if(s){const e=s.getGlobalXfo().inverse().multiply(t);this.__localXfoParam.setValue(e,i)}else this.__globalXfoParam.setValue(t,i)}_cleanGlobalXfo(t){const i=this.getParentItem(),s=this.__localXfoParam.getValue();return void 0!==i?i.getGlobalXfo().multiply(s):s}_setGlobalXfoDirty(){this.__globalXfoParam.setDirty(this._cleanGlobalXfo)}getVisible(){return this.__visibleCounter>0}setVisible(t){this.__visibleParam.setValue(t)}propagateVisiblity(t){this.__visibleCounter+=t,this.__updateVisiblity()}__updateVisiblity(){const t=this.__visibleCounter>0;if(t!=this.__visible){this.__visible=t;for(const t of this.__childItems)t instanceof Qi&&t.propagateVisiblity(this.__visible?1:-1);return this.visibilityChanged.emit(t),!0}return!1}addHighlight(t,i,s=!1){if(t in this.__highlightMapping){const i=this.__highlights.indexOf(t);this.__highlights.splice(i,1)}this.__highlights.push(t),this.__highlightMapping[t]=i,this.highlightChanged.emit(),s&&this.__childItems.forEach(e=>{e instanceof Qi&&e.addHighlight(t,i,s)})}removeHighlight(t,i=!1){if(t in this.__highlightMapping){const i=this.__highlights.indexOf(t);this.__highlights.splice(i,1),delete this.__highlightMapping[t],this.highlightChanged.emit()}i&&this.__childItems.forEach(s=>{s instanceof Qi&&s.removeHighlight(t,i)})}getHighlight(){if(this.__highlights.length>0)return this.__highlightMapping[this.__highlights[this.__highlights.length-1]]}isHighlighted(){return this.__highlights.length>0}get boundingBox(){return console.warn("getter is deprectated. Please use 'getBoundingBox'"),this.getBoundingBox()}getBoundingBox(){return this.__boundingBoxParam.getValue()}_cleanBoundingBox(t){return t.reset(),this.__childItems.forEach(i=>{i instanceof Qi&&i.getVisible()&&!i.testFlag(P.IGNORE_BBOX)&&t.addBox3(i.getBoundingBox())}),t}_childBBoxChanged(){this._setBoundingBoxDirty()}_setBoundingBoxDirty(){this.__boundingBoxParam&&this.__boundingBoxParam.setDirty(this._cleanBoundingBox)}getChildren(){return this.__childItems}numChildren(){return console.warn("Deprecated method. Please use getNumChildren"),this.__childItems.length}getNumChildren(){return this.__childItems.length}generateUniqueName(t){if(!(t in this.__childItemsMapping))return t;let i=1;t.length>4&&!Number.isNaN(parseInt(t.substring(t.length-4)))?i=parseInt(t.substr(t.length-4)):t.length>3&&!Number.isNaN(parseInt(t.substring(t.length-3)))?i=parseInt(t.substr(t.length-3)):t.length>2&&!Number.isNaN(parseInt(t.substring(t.length-2)))&&(i=parseInt(t.substr(t.length-2)));const s=[];for(const t of this.__childItems)t&&s.push(t.getName());let e=t;for(;;){let n=""+i;for(;n.length<2;)n="0"+n;if(e=t+n,-1==s.indexOf(e))break;i++}return e}__updateMapping(t){for(let i=t;i<this.__childItems.length;i++)this.__childItemsMapping[this.__childItems[i].getName()]=i}insertChild(t,i,s=!1,e=!0){if(t.getName()in this.__childItemsMapping){if(!e)throw new Error("Item '"+t.getName()+"' is already a child of :"+this.getPath());t.setName(this.generateUniqueName(t.getName()))}if(!(t instanceof Q))throw new Error("Object is is not a tree item :"+t.constructor.name);const n={};let l;return n.nameChangedId=t.nameChanged.connect((t,i)=>{const s=this.__childItemsMapping[i];delete this.__childItemsMapping[i],this.__childItemsMapping[t]=s}),t instanceof Qi&&(s&&(l=this.getGlobalXfo().inverse().multiply(t.getGlobalXfo())),n.bboxChangedId=t.boundingChanged.connect(()=>{this._setBoundingBoxDirty()}),n.visChangedId=t.visibilityChanged.connect(this._setBoundingBoxDirty)),this.__childItems.splice(i,0,t),this.__childItemsSignalIds.splice(i,0,n),this.__childItemsMapping[t.getName()]=i,this.__updateMapping(i),t.setOwner(this),t instanceof Qi&&(s&&t.setLocalXfo(l),this._setBoundingBoxDirty()),t.testFlag(P.USER_EDITED)&&this.setFlag(P.USER_EDITED),this.childAdded.emit(t,i),t}addChild(t,i=!0,s=!0){const e=this.__childItems.length;return this.insertChild(t,e,i,s),e}getChild(t){return this.__childItems[t]}getChildByName(t){const i=this.__childItemsMapping[t];return null!=i?this.__childItems[i]:null}getChildNames(){const t=[];for(let i=0;i<this.__childItems.length;i++){const s=this.__childItems[i];null!=s&&(t[i]=s.getName())}return t}__unbindChild(t,i){const s=this.__childItemsSignalIds[t];i.nameChanged.disconnectId(s.nameChangedId),i instanceof Qi&&(i.boundingChanged.disconnectId(s.bboxChangedId),i.visibilityChanged.disconnectId(s.visChangedId)),this.__childItems.splice(t,1),this.__childItemsSignalIds.splice(t,1),delete this.__childItemsMapping[i.getName()],this.__updateMapping(t),i instanceof Qi&&this._setBoundingBoxDirty(),this.childRemoved.emit(i,t)}removeChild(t){const i=this.__childItems[t];i&&(this.__unbindChild(t,i),i.setOwner(void 0))}removeChildByName(t){const i=this.__childItemsMapping[t];return null!=i?this.removeChild(i):null}removeChildByHandle(t){console.warn("Deprecated method. Please use removeChild");const i=this.__childItems.indexOf(t);if(-1==i)throw new Error("Error in removeChildByHandle. Child not found:"+t.getName());this.removeChild(i)}removeAllChildren(){let t=this.__childItems.length;for(;t--;)this.removeChild(t);this._setBoundingBoxDirty()}getChildIndex(t){return this.__childItems.indexOf(t)}indexOfChild(t){return console.warn("Deprecated method. Please use getChildIndex"),this.getChildIndex(t)}addComponent(t){this.__components.push(t),this.__componentMapping[t.getName()]=this.__components.length-1,t.setOwner(this)}removeComponent(t){const i=this.__componentMapping[t];if(null==i)throw new Error("Component not found:"+t);const s=this.__components[i];s.setOwner(void 0),this.__components.splice(i,1);const e={};for(let t=0;t<this.__components.length;t++)e[this.__components[t].getName()]=t;return this.__componentMapping=e,s}hasComponent(t){return t in this.__componentMapping}getComponent(t){if(t in this.__componentMapping)return this.__components[this.__componentMapping[t]];console.log("No component named '"+t+"' found.")}resolvePath(t,i=0){if("string"==typeof t&&(t=t.split("/")),0==i)if("."==t[0]||t[0]==this.__name)i++;else if(".."==t[0])return this.__ownerItem.resolvePath(t,i+1);if(i==t.length)return this;if(">"==t[i]&&i==t.length-2&&this.hasComponent(t[i+1]))return this.getComponent(t[i+1]).resolvePath(t,i+2);const s=this.getChildByName(t[i]);if(null==s){if(this.hasComponent(t[i])){const s=this.getComponent(t[i]);return i==t.length?s:s.resolvePath(t,i+1)}return this.getParameter(t[i])||null}return s.resolvePath(t,i+1)}traverse(t,i=!0){const s=(t,i)=>{const s=t.getChildren();for(const t of s)t&&e(t,i+1)},e=(i,e)=>{if(0==t(i,e))return!1;s(i,e)};i?e(this,1):s(this,0)}onMouseDown(t){this.mouseDown.emit(t),t.propagating&&this.__ownerItem&&this.__ownerItem.onMouseDown(t)}onMouseUp(t){this.mouseUp.emit(t),t.propagating&&this.__ownerItem&&this.__ownerItem.onMouseUp(t)}onMouseMove(t){this.mouseMove.emit(t),t.propagating&&this.__ownerItem&&this.__ownerItem.onMouseMove(t)}onMouseEnter(t){this.mouseEnter.emit(t),t.propagating&&this.__ownerItem&&this.__ownerItem.onMouseEnter(t)}onMouseLeave(t){this.mouseLeave.emit(t),t.propagating&&this.__ownerItem&&this.__ownerItem.onMouseLeave(t)}onWheel(t){t.propagating&&this.__ownerItem&&this.__ownerItem.onWheel(t)}toJSON(t,i){if(!this.testFlag(P.USER_EDITED))return;const s=super.toJSON(t,i),e=[];for(const s of this.__components)e.push(s.toJSON(t,i));if(e.length>0&&(s.components=e),!(i&Bi.SAVE_FLAG_SKIP_CHILDREN)){const e={};for(const s of this.__childItems)if(s){const n=s.toJSON(t,i);n&&(e[s.getName()]=n)}Object.keys(e).length>0&&(s?s.children=e:s={name:this.__name,children:e})}return s}fromJSON(t,i,s){if(super.fromJSON(t,i,s),i.numTreeItems++,this.setFlag(P.USER_EDITED),null!=t.children){const e=t.children;if(Array.isArray(e))for(const t of e){let e=this.getChildByName(t.name);e?e.fromJSON(t,i,s):t.type&&(e=N.constructClass(t.type),e&&(e.fromJSON(t,i,s),this.addChild(e,!1,!1)))}else for(const t in e){const n=e[t];let l=this.getChildByName(t);l?l.fromJSON(n,i,s):n.type&&(l=N.constructClass(n.type),l&&(l.fromJSON(n,i,s),this.addChild(l,!1,!1)))}}if(t.components)for(const s of t.components){const t=N.constructClass(s.type?s.type:s.name);t&&(t.fromJSON(s,i),this.addComponent(t))}}readBinary(t,i){super.readBinary(t,i),i.numTreeItems++;const s=t.loadUInt8();if(4&s){const i=new g;i.tr=t.loadFloat32Vec3(),i.ori=t.loadFloat32Quat(),i.sc.set(t.loadFloat32()),this.__localXfoParam.setValue(i,J.DATA_LOAD)}8&s&&this.__boundingBoxParam.setValue(new I(t.loadFloat32Vec3(),t.loadFloat32Vec3()),J.DATA_LOAD);const e=t.loadUInt32();if(e>0){const s=t.loadUInt32Array(e);for(let n=0;n<e;n++){t.seek(s[n]);let e=t.loadStr();if(e.startsWith("N")&&e.endsWith("E")){const t=e.indexOf("podium");-1!=t&&(e=parseInt(e[t+7])?e.substring(t+8,e.length-1):e.substring(t+7,e.length-1)),-1!=e.indexOf("livenurbs")&&(e=e.substring(e.indexOf("CAD"),e.length-1))}const l=N.constructClass(e);if(l)t.seek(s[n]),l.readBinary(t,i),l.setFlag(P.BIN_NODE),this.addChild(l,!1,!1);else{const i=t.loadStr();console.warn("Unable to construct child:"+i+" of type:"+e)}}}}clone(t){const i=new Qi;return i.copyFrom(this,t),i}copyFrom(t,i){super.copyFrom(t,i),t.getChildren().forEach(t=>{t&&this.addChild(t.clone(i),!1,!1)})}destroy(){this.removeAllChildren(),super.destroy()}}N.registerClass("TreeItem",Qi);class ji extends Qi{constructor(t){super(t)}setSrcTree(t,i){if(this.__srcTree=t,0==this.__srcTree.getNumChildren()){const t=this.__srcTree.clone(i);t.setLocalXfo(new g,J.DATA_LOAD),this.addChild(t,!1)}else this.__srcTree.getChildren().forEach(t=>{const s=t.clone(i);this.addChild(s,!1)})}getSrcTree(){return this.__srcTree}readBinary(t,i={}){super.readBinary(t,i);const s=t.loadStrArray();i.resolvePath(s,t=>{this.setSrcTree(t,i)})}toJSON(t={},i=0){return super.toJSON(t,i)}fromJSON(t,i={},s=0,e){}}N.registerClass("InstanceItem",ji);class Di extends Qi{constructor(t){super(t),this.__loaded=!1,this.audioSourceCreated=new v;const i=this.addParameter(new It("FilePath"));let s,e;const n=()=>{s=window.ZeaAudioaudioCtx.createBufferSource(),s.buffer=e,s.loop=a.getValue(),s.muted=o.getValue(),s.start(0),this.audioSourceCreated.emit(s)};i.valueChanged.connect(()=>{const t=new XMLHttpRequest;t.open("GET",i.getURL(),!0),t.responseType="arraybuffer",t.onload=()=>{window.ZeaAudioaudioCtx.decodeAudioData(t.response,t=>{e=t,this.__loaded=!0,this.loaded.emit(!0),l.getValue()&&n()},t=>{console.log("Error with decoding audio data"+t.err)})},t.send()});const l=this.addParameter(new bt("Autoplay",!1)),h=this.addParameter(new ut("PlayState",0));h.valueChanged.connect(t=>{if(t!=J.CUSTOM)switch(h.getValue()){case 0:this.__loaded&&s&&(s.stop(0),s=void 0);break;case 1:this.__loaded&&n()}}),this.isPlaying=()=>0!=h.getValue(),this.play=()=>{h.setValue(1,J.CUSTOM)},this.stop=()=>{h.setValue(0,J.CUSTOM)},this.pause=()=>{h.setValue(0,J.CUSTOM)},this.getAudioSource=()=>s;const o=this.addParameter(new bt("Mute",!1));this.addParameter(new ut("Gain",1)).setRange([0,5]);const a=this.addParameter(new bt("Loop",!1));this.addParameter(new bt("SpatializeAudio",!0)),this.addParameter(new ut("refDistance",2)),this.addParameter(new ut("maxDistance",1e4)),this.addParameter(new ut("rolloffFactor",1)),this.addParameter(new ut("coneInnerAngle",360)),this.addParameter(new ut("coneOuterAngle",0)),this.addParameter(new ut("coneOuterGain",1)),o.valueChanged.connect(()=>{s&&(s.muted=o.getValue())}),a.valueChanged.connect(()=>{s&&(s.loop=a.getValue())}),this.mute=t=>{o.setValue(t,J.CUSTOM)},this.loaded=new v(!0),this.loaded.setToggled(!1)}isLoaded(){return this.__loaded}setAudioStream(){this.__loaded=!0,this.loaded.emit(),this.audioSourceCreated.emit(audioSource)}}class Oi extends Di{constructor(t){}}class Ai extends Qi{constructor(t){super(t),this.overlay=!1,this.__cutAway=!1,this.__cutAwayVector=!1,this.__cutAwayDist=!1,this.cutAwayChanged=new v,this.__layers=[]}setOverlay(t){this.overlay=t}isOverlay(){return this.overlay}addLayer(t){this.__layers.push(t)}getLayers(){return this.__layers}isCutawayEnabled(){return this.__cutAway}setCutawayEnabled(t){this.__cutAway=t,this.cutAwayChanged.emit()}getCutVector(){return this.__cutAwayVector}setCutVector(t){this.__cutAwayVector=t,this.cutAwayChanged.emit()}getCutDist(){return this.__cutAwayDist}setCutDist(t){this.__cutAwayDist=t,this.cutAwayChanged.emit()}readBinary(t,i){if(super.readBinary(t,i),i.versions["zea-engine"].greaterOrEqualThan([0,0,4])){const s=t.loadStr();let e=i.assetItem.getMaterialLibrary().getMaterial(s,!1);if(e||(e=new Nt(s,"SimpleSurfaceShader"),e.getParameter("BaseColor").setValue(p.random(.25),J.DATA_LOAD),i.assetItem.getMaterialLibrary().addMaterial(e)),this.setMaterial(e,J.DATA_LOAD),this.__layers=t.loadStrArray(),this.__layers.length>0)for(const t of this.__layers)i.addGeomToLayer(this,t)}}}class _i extends Ai{constructor(t,i,s){super(t),this.__geomParam=this.insertParameter(new Mt("geometry"),0),this.__geomParam.valueChanged.connect(this._setBoundingBoxDirty.bind(this)),this.__geomParam.boundingBoxDirtied.connect(this._setBoundingBoxDirty.bind(this)),this.__materialParam=this.insertParameter(new yi("Material"),1),this.__paramMapping.material=this.getParameterIndex(this.__materialParam),this.__lightmapCoordOffset=new d,this.__geomOffsetXfoParam=this.addParameter(new Vt("GeomOffsetXfo")),this.__geomMatParam=this.addParameter(new ft("GeomMat")),this.__cleanGeomMat=this.__cleanGeomMat.bind(this),this.__globalXfoParam.valueChanged.connect(()=>{this.__geomMatParam.setDirty(this.__cleanGeomMat)}),this.__geomOffsetXfoParam.valueChanged.connect(()=>{this.__geomMatParam.setDirty(this.__cleanGeomMat)}),this.geomXfoChanged=this.__geomMatParam.valueChanged,this.materialAssigned=this.__materialParam.valueChanged,this.geomAssigned=this.__geomParam.valueChanged,i&&this.setGeometry(i,J.DATA_LOAD),s&&this.setMaterial(s,J.DATA_LOAD)}__cleanGeomMat(){const t=this.__globalXfoParam.getValue().toMat4(),i=this.__geomOffsetXfoParam.getValue().toMat4();return t.multiply(i)}getGeometry(){return this.__geomParam.getValue()}setGeometry(t,i){this.__geomParam.setValue(t,i)}getGeom(){return console.warn("getGeom is deprectated. Please use 'getGeometry'"),this.getGeometry()}setGeom(t){return console.warn("setGeom is deprectated. Please use 'setGeometry'"),this.setGeometry(t)}getMaterial(){return this.__materialParam.getValue()}setMaterial(t,i){this.__materialParam.setValue(t,i)}_cleanBoundingBox(t){t=super._cleanBoundingBox(t);const i=this.getGeometry();return i&&t.addBox3(i.boundingBox,this.getGeomMat4()),t}getGeomOffsetXfo(){return this.__geomOffsetXfoParam.getValue()}setGeomOffsetXfo(t){this.__geomOffsetXfoParam.setValue(t)}getGeomMat4(){return this.__geomMatParam.getValue()}getLightmapName(){return this.__lightmapName}getLightmapCoordsOffset(){return this.__lightmapCoordOffset}applyAssetLightmapSettings(t,i){this.__lightmap=t,this.__lightmapCoordOffset.addInPlace(i)}toJSON(t,i){return super.toJSON(t,i)}fromJSON(t,i){super.fromJSON(t,i),i.numGeomItems++}readBinary(t,i){super.readBinary(t,i),i.numGeomItems++,this.__lightmapName=i.assetItem.getName();const s=t.loadUInt8(),e=t.loadUInt32(),n=i.assetItem.getGeometryLibrary(),l=n.getGeom(e);if(l)this.setGeometry(l,J.DATA_LOAD);else{this.geomIndex=e;const t=t=>{if(e>=t[0]&&e<t[1]){const t=n.getGeom(e);t?this.setGeometry(t,J.DATA_LOAD):console.warn("Geom not loaded:",this.getName()),n.rangeLoaded.disconnectId(i)}},i=n.rangeLoaded.connect(t)}if(4&s&&this.__geomOffsetXfoParam.setValue(new g(t.loadFloat32Vec3(),t.loadFloat32Quat(),t.loadFloat32Vec3())),i.versions["zea-engine"].lessThan([0,0,4]))if(8&s){const s=i.assetItem.getMaterialLibrary(),e=t.loadStr();let n=s.getMaterial(e);n||(console.warn("Geom :'"+this.name+"' Material not found:"+e),n=s.getMaterial("Default")),this.setMaterial(n,J.DATA_LOAD)}else this.setMaterial(i.assetItem.getMaterialLibrary().getMaterial("Default"),J.DATA_LOAD);this.__lightmapCoordOffset=t.loadFloat32Vec2()}toString(){return JSON.stringify(this.toJSON(),null,2)}clone(t){const i=new _i;return i.copyFrom(this,t),i}copyFrom(t,i){if(super.copyFrom(t,i),this.__lightmapCoordOffset=t.__lightmapCoordOffset,!t.getGeometry()&&-1!=t.geomIndex){const s=i.assetItem.getGeometryLibrary(),e=t.geomIndex,n=t=>{if(e>=t[0]&&e<t[1]){const t=s.getGeom(e);t?this.setGeometry(t,J.DATA_LOAD):console.warn("Geom not loaded:",this.getName()),s.rangeLoaded.disconnectId(l)}},l=s.rangeLoaded.connect(n)}this.__geomMatParam.setDirty(this.__cleanGeomMat)}destroy(){super.destroy()}}N.registerClass("GeomItem",_i);const qi={manual:0,first:1,average:2,globalOri:3};class $i extends Qi{constructor(t){super(t),this.setFlag(P.USER_EDITED),this.calculatingGroupXfo=!1,this.dirty=!1,this.invGroupXfo=void 0,this.__initialXfos=[],this.__signalIndices=[];let i=0;this.__itemsParam=this.insertParameter(new vt("Items",t=>t instanceof Qi),i++),this.__itemsParam.itemAdded.connect((t,i)=>{this.__bindItem(t,i)}),this.__itemsParam.itemRemoved.connect((t,i)=>{this.__unbindItem(t,i)}),this.__itemsParam.valueChanged.connect(()=>{this.calcGroupXfo(),this._setBoundingBoxDirty()}),this.__initialXfoModeParam=this.insertParameter(new mt("InitialXfoMode",qi.average,["manual","first","average","global"]),i++),this.__initialXfoModeParam.valueChanged.connect(()=>{this.calcGroupXfo()}),this.__highlightedParam=this.insertParameter(new bt("Highlighted",!1),i++),this.__highlightedParam.valueChanged.connect(()=>{this.__updateHighlight()}),this.__updateHighlight=this.__updateHighlight.bind(this),this.insertParameter(new Xt("HighlightColor",new p(.5,.5,1)),i++).valueChanged.connect(this.__updateHighlight),this.insertParameter(new ut("HighlightFill",0,[0,1]),i++).valueChanged.connect(this.__updateHighlight),this.__materialParam=this.insertParameter(new yi("Material"),i++),this.__materialParam.valueChanged.connect(()=>{this.__updateMaterial()}),this.__updateCutaway=this.__updateCutaway.bind(this),this.insertParameter(new bt("CutAwayEnabled",!1),i++).valueChanged.connect(this.__updateCutaway),this.insertParameter(new pt("CutVector",new u(1,0,0)),i++).valueChanged.connect(this.__updateCutaway),this.insertParameter(new ut("CutDist",0),i++).valueChanged.connect(this.__updateCutaway),this.__globalXfoParam.valueChanged.connect(()=>{this.calculatingGroupXfo||this._propagateDirtyXfoToItems()})}static get INITIAL_XFO_MODES(){return qi}__updateVisiblity(){if(super.__updateVisiblity()){const t=this.getVisible();return Array.from(this.__itemsParam.getValue()).forEach(i=>{i instanceof Qi&&i.propagateVisiblity(t?1:-1)}),!0}return!1}__updateHighlight(){let t,i=!1;(this.getParameter("Highlighted").getValue()||this.isSelected())&&(i=!0,t=this.getParameter("HighlightColor").getValue(),t.a=this.getParameter("HighlightFill").getValue());const s="groupItemHighlight"+this.getId();Array.from(this.__itemsParam.getValue()).forEach(e=>{e instanceof Qi&&(i?e.addHighlight(s,t,!0):e.removeHighlight(s,!0))})}setSelected(t){super.setSelected(t),this.__updateHighlight()}_setGlobalXfoDirty(){super._setGlobalXfoDirty()}calcGroupXfo(){const t=Array.from(this.__itemsParam.getValue());if(0==t.length)return new g;this.calculatingGroupXfo=!0;const i=this.__initialXfoModeParam.getValue();let s;if(i==qi.manual)return this.invGroupXfo=this.getGlobalXfo().inverse(),void(this.calculatingGroupXfo=!1);if(i==qi.first)s=this.__initialXfos[0];else if(i==qi.average){s=new g,s.ori.set(0,0,0,0);let i=0;t.forEach((t,e)=>{t instanceof Qi&&(s.tr.addInPlace(this.__initialXfos[e].tr),s.ori.addInPlace(this.__initialXfos[e].ori),i++)}),s.tr.scaleInPlace(1/i),s.ori.normalizeInPlace()}else{if(i!=qi.globalOri)throw new Error("Invalid mode.");{s=new g;let i=0;t.forEach((t,e)=>{t instanceof Qi&&(s.tr.addInPlace(this.__initialXfos[e].tr),i++)}),s.tr.scaleInPlace(1/i)}}this.setGlobalXfo(s,J.GENERATED_VALUE);const e=this.getGlobalXfo();this.invGroupXfo=e.inverse(),this.calculatingGroupXfo=!1}_propagateDirtyXfoToItems(){if(this.calculatingGroupXfo)return;const t=Array.from(this.__itemsParam.getValue());if(!this.calculatingGroupXfo&&t.length>0&&this.invGroupXfo&&!this.dirty){let i;this.dirty=!0,this.propagatingXfoToItems=!0;const s=(t,s)=>{const e=t.getParameter("GlobalXfo");e.setDirty(()=>{if(!i){const t=this.__globalXfoParam.getValue();i=t.multiply(this.invGroupXfo),this.dirty=!1}const t=i.multiply(s);e.setClean(t)})};t.forEach((t,i)=>{t instanceof Qi&&s(t,this.__initialXfos[i])}),this.propagatingXfoToItems=!1}}__updateMaterial(){const t=this.getParameter("Material").getValue();Array.from(this.__itemsParam.getValue()).forEach(i=>{i.traverse(i=>{if(i instanceof Qi&&i.hasParameter("Material")){const s=i.getParameter("Material");if(t){const i=s.getValue();i!=t&&(s.__backupMaterial=i,s.setValue(t,J.GENERATED_VALUE))}else s.__backupMaterial&&s.setValue(s.__backupMaterial,J.GENERATED_VALUE)}},!1)})}__updateCutaway(){const t=this.getParameter("CutAwayEnabled").getValue(),i=this.getParameter("CutVector").getValue(),s=this.getParameter("CutDist").getValue();Array.from(this.__itemsParam.getValue()).forEach(e=>{e.traverse(e=>{e instanceof Ai&&(e.setCutawayEnabled(t),e.setCutVector(i),e.setCutDist(s))},!0)})}setPaths(t){this.clearItems(!1);const i=this.getOwner();if(null==i)return void console.warn("Group does not have an owner and so cannot resolve paths:",this.getName());const s=[];t.forEach(t=>{const e=i.resolvePath(t);e?s.push(e):console.warn("Path does not resolve to an Item:",t," group:",this.getName())}),this.setItems(s)}resolveItems(t){this.setPaths(t)}__bindItem(t,i){if(!(t instanceof Qi))return;const s={};s.mouseDownIndex=t.mouseDown.connect(t=>{this.onMouseDown(t)}),s.mouseUpIndex=t.mouseUp.connect(t=>{this.onMouseUp(t)}),s.mouseMoveIndex=t.mouseMove.connect(t=>{this.onMouseMove(t)}),s.mouseEnterIndex=t.mouseEnter.connect(t=>{this.onMouseEnter(t)}),s.mouseLeaveIndex=t.mouseLeave.connect(t=>{this.onMouseLeave(t)});const e=this.getParameter("Material").getValue();if(e&&t.traverse(t=>{if(t instanceof Qi&&t.hasParameter("Material")){const i=t.getParameter("Material");if(e){const t=i.getValue();t!=e&&(i.__backupMaterial=t,i.setValue(e,J.GENERATED_VALUE))}}},!0),t instanceof Qi&&this.getParameter("Highlighted").getValue()){const i=this.getParameter("HighlightColor").getValue();i.a=this.getParameter("HighlightFill").getValue(),t.addHighlight("groupItemHighlight"+this.getId(),i,!0)}const n=this.getParameter("CutAwayEnabled").getValue();if(n){const i=this.getParameter("CutVector").getValue(),s=this.getParameter("CutDist").getValue();t.traverse(t=>{t instanceof Ai&&(t.setCutawayEnabled(n),t.setCutVector(i),t.setCutDist(s))},!0)}this.getVisible()||t.propagateVisiblity(-1);const l=()=>{const t=this.__initialXfoModeParam.getValue();t==qi.first&&0==i?this.calcGroupXfo():t!=qi.average&&t!=qi.globalOri||this.calcGroupXfo()};s.globalXfoChangedIndex=t.globalXfoChanged.connect(()=>{this.propagatingXfoToItems||(this.__initialXfos[i]=t.getGlobalXfo(),l())}),this.__initialXfos[i]=t.getGlobalXfo(),s.bboxChangedIndex=t.boundingChanged.connect(this._setBoundingBoxDirty),this.__signalIndices[i]=s,l()}__unbindItem(t,i){if(!(t instanceof Qi))return;t.removeHighlight("branchselected"+this.getId(),!0),this.getParameter("Highlighted").getValue()&&t.removeHighlight("groupItemHighlight"+this.getId(),!0),this.getVisible()||t.propagateVisiblity(1),t.traverse(t=>{t instanceof Ai&&t.setCutawayEnabled(!1)},!0);const s=this.__signalIndices[i];t.mouseDown.disconnectId(s.mouseDownIndex),t.mouseUp.disconnectId(s.mouseUpIndex),t.mouseMove.disconnectId(s.mouseMoveIndex),t.mouseEnter.disconnectId(s.mouseEnterIndex),t.mouseLeave.disconnectId(s.mouseLeaveIndex),t.globalXfoChanged.disconnectId(s.globalXfoChangedIndex),t.boundingChanged.disconnectId(s.bboxChangedIndex),this.__signalIndices.splice(i,1),this.__initialXfos.splice(i,1)}addItem(t,i=!0){t?this.__itemsParam.addItem(t,i):console.warn("Error adding item to group. Item is null")}removeItem(t,i=!0){this.__itemsParam.removeItem(t,i)}clearItems(t=!0){const i=Array.from(this.__itemsParam.getValue());for(let t=i.length-1;t>=0;t--)this.__unbindItem(i[t],t);this.__signalIndices=[],this.__initialXfos=[],this.__itemsParam.clearItems(t)}getItems(){return this.__itemsParam.getValue()}setItems(t){this.clearItems(!1),this.__itemsParam.setItems(t)}_cleanBoundingBox(t){const i=super._cleanBoundingBox(t);return Array.from(this.__itemsParam.getValue()).forEach(t=>{t instanceof Qi&&t.getVisible()&&!t.testFlag(P.IGNORE_BBOX)&&i.addBox3(t.getBoundingBox())}),i}onMouseDown(t){super.onMouseDown(t)}onMouseUp(t){super.onMouseUp(t)}onMouseMove(t){super.onMouseMove(t)}toJSON(t,i){const s=super.toJSON(t,i),e=Array.from(this.__itemsParam.getValue()),n=[];return e.forEach(i=>{const s=i.getPath();n.push(t?t.makeRelative(s):s)}),s.treeItems=n,s}fromJSON(t,i,s){if(super.fromJSON(t,i,s),this.setFlag(P.USER_EDITED),!t.treeItems)return void console.warn("Invalid Parameter JSON");let e=t.treeItems.length;const n=t=>{i.resolvePath(t,t=>{this.addItem(t),e--,0==e&&(this.calculatingGroupXfo=!0,this.calcGroupXfo(),this.calculatingGroupXfo=!1)},()=>{console.warn("Group: '"+this.getName()+"'. Unable to load item:"+t)})};for(const i of t.treeItems)n(i)}clone(t){const i=new $i;return i.copyFrom(this,t),i}copyFrom(t,i){super.copyFrom(t,i)}destroy(){super.destroy()}}N.registerClass("Group",$i);const ts=st("Lyogcm9sbHVwLXBsdWdpbi13ZWItd29ya2VyLWxvYWRlciAqLwpjb25zdCB0PU1hdGguUEkvMTgwO01hdGguSEFMRl9QST0uNSpNYXRoLlBJLE1hdGguVFdPX1BJPTIqTWF0aC5QSTtNYXRoLnJhZFRvRGVnPWZ1bmN0aW9uKGUpe3JldHVybiBlL3R9LE1hdGguZGVnVG9SYWQ9ZnVuY3Rpb24oZSl7cmV0dXJuIGUqdH0sTnVtYmVyLmlzTnVtZXJpYz10PT4haXNOYU4ocGFyc2VGbG9hdCh0KSkmJmlzRmluaXRlKHQpLFN0cmluZy5wcm90b3R5cGUucmVwbGFjZUFsbD1mdW5jdGlvbih0LGUpe3JldHVybiB0aGlzLnJlcGxhY2UobmV3IFJlZ0V4cCh0LCJnIiksZSl9O2Z1bmN0aW9uIGUodCxlPTAscz01KXtyZXR1cm4gSlNPTi5zdHJpbmdpZnkodCwoZnVuY3Rpb24odCxlKXtyZXR1cm4gZSYmZS50b0ZpeGVkP051bWJlcihlLnRvRml4ZWQocykpOmV9KSxlKX1TdHJpbmcucHJvdG90eXBlLmhhc2g9ZnVuY3Rpb24oKXtyZXR1cm4gZnVuY3Rpb24odCl7bGV0IGUscyxhLGk9MDtpZigwPT09dC5sZW5ndGgpcmV0dXJuIGk7Zm9yKGU9MCxhPXQubGVuZ3RoO2U8YTtlKyspcz10LmNoYXJDb2RlQXQoZSksaT0oaTw8NSktaStzLGl8PTA7cmV0dXJuIE1hdGguYWJzKGkpfSh0aGlzKX0sU3RyaW5nLnByb3RvdHlwZS50cmltPWZ1bmN0aW9uKCl7cmV0dXJuIHRoaXMucmVwbGFjZSgvXlxzK3xccyskL2csIiIpfSxTdHJpbmcucHJvdG90eXBlLmx0cmltPWZ1bmN0aW9uKCl7cmV0dXJuIHRoaXMucmVwbGFjZSgvXlxzKy8sIiIpfSxTdHJpbmcucHJvdG90eXBlLnJ0cmltPWZ1bmN0aW9uKCl7cmV0dXJuIHRoaXMucmVwbGFjZSgvXHMrJC8sIiIpfSxTdHJpbmcucHJvdG90eXBlLmxwYWQ9ZnVuY3Rpb24odCxlKXtsZXQgcz10aGlzO2Zvcig7cy5sZW5ndGg8ZTspcz10K3M7cmV0dXJuIHN9LFN0cmluZy5wcm90b3R5cGUucnBhZD1mdW5jdGlvbih0LGUpe2xldCBzPXRoaXM7Zm9yKDtzLmxlbmd0aDxlOylzKz10O3JldHVybiBzfSxNYXRoLnJhbmRvbUludD1mdW5jdGlvbih0LGUpe3JldHVybiB0PU1hdGguY2VpbCh0KSxlPU1hdGguZmxvb3IoZSksTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpKihlLXQpKSt0fSxNYXRoLmxlcnA9KHQsZSxzKT0+dCtzKihlLXQpLE1hdGguY2xhbXA9ZnVuY3Rpb24odCxlLHMpe3JldHVybiBNYXRoLm1pbihNYXRoLm1heCh0LGUpLHMpfSxNYXRoLm5lYXJlc3RQb3cyPWZ1bmN0aW9uKHQpe3JldHVybiBNYXRoLnBvdygyLE1hdGgucm91bmQoTWF0aC5sb2codCkvTWF0aC5sb2coMikpKX0sTWF0aC5uZWFyZXN0UG93MTA9ZnVuY3Rpb24odCl7cmV0dXJuIE1hdGgucG93KDEwLE1hdGgucm91bmQoTWF0aC5sb2cxMCh0KS9NYXRoLmxvZzEwKDEwKSkpfSxNYXRoLm5leHRQb3cyPWZ1bmN0aW9uKHQpe2xldCBlPTA7Zm9yKDt0PjA7KWUrKyx0Pj49MTtyZXR1cm4gMTw8ZX0sTWF0aC5mcmFjdD1mdW5jdGlvbih0KXtyZXR1cm4gMD09dD8wOnQ8MD90Pi0xPy10Oi10JU1hdGguZmxvb3IoLXQpOnQ8MT90OnQlTWF0aC5mbG9vcih0KX0sTWF0aC5yZW1hcD1mdW5jdGlvbih0LGUscyxhLGkpe3JldHVybiBhKyh0LWUpLyhzLWUpKihpLWEpfSxNYXRoLmNvbnZlcnRGbG9hdDMyQXJyYXlUb1VJbnQxNkFycmF5PWZ1bmN0aW9uKHQpe2NvbnN0IGU9bmV3IFVpbnQxNkFycmF5KHQubGVuZ3RoKSxzPW5ldyBJbnQzMkFycmF5KHQuYnVmZmVyKSxhPXQ9PntsZXQgZT10Pj4xNiYzMjc2OCxzPXQ+PjEyJjIwNDc7Y29uc3QgYT10Pj4yMyYyNTU7cmV0dXJuIGE8MTAzP2U6YT4xNDI/KGV8PTMxNzQ0LGV8PSgyNTU9PWE/MDoxKSYmODM4ODYwNyZ0LGUpOmE8MTEzPyhzfD0yMDQ4LGV8PShzPj4xMTQtYSkrKHM+PjExMy1hJjEpLGUpOihlfD1hLTExMjw8MTB8cz4+MSxlKz0xJnMsZSl9O2ZvcihsZXQgaT0wO2k8dC5sZW5ndGg7aSsrKWVbaV09YShzW2ldKTtyZXR1cm4gZX0sTWF0aC5kZWNvZGUxNkJpdEZsb2F0RnJvbTJ4VUludDg9dD0+e2NvbnN0IGU9dFswXSxzPSgxMjAmZSk+PjM7bGV0IGE9MD09cz8wOjIwNDg7Y29uc3QgaT1hKygoNyZlKTw8OCkrdFsxXTtyZXR1cm4gYT0wPT1zPzE6MCwoMTI4JmU/MTotMSkqaSpNYXRoLnBvdygyLHMrYS0xNil9LE1hdGguZW5jb2RlMTZCaXRGbG9hdEludG8yeFVJbnQ4PXQ9PntjfHwoYz1uZXcgVWludDhBcnJheSgyKSk7Y29uc3QgZT10Pj0wPzEyODowO3Q9TWF0aC5hYnModCk7bGV0IHMsYT0xNSxpPTEwMjQ7Zm9yKGxldCBlPTE1O2U+MDtlLS0pdDxpJiYoaS89MixhLS0pO3M9MD09YT90L2kvMjoodC1pKS9pO2NvbnN0IHI9TWF0aC5yb3VuZCgyMDQ4KnMpLG49ci8yNTYsaD1yLTI1NipuO3JldHVybiBjWzBdPWUrOCphK24sY1sxXT1oLHQ+PTIwNDgmJihjWzBdPTI1NSksY30sTWF0aC5lbmNvZGUxNkJpdEZsb2F0PXQ9Pntjb25zdCBlPW5ldyBGbG9hdDMyQXJyYXkoMSk7ZVswXT10O3JldHVybih0PT57bGV0IGU9dD4+MTYmMzI3Njgscz10Pj4xMiYyMDQ3O2NvbnN0IGE9dD4+MjMmMjU1O3JldHVybiBhPDEwMz9lOmE+MTQyPyhlfD0zMTc0NCxlfD0oMjU1PT1hPzA6MSkmJjgzODg2MDcmdCxlKTphPDExMz8oc3w9MjA0OCxlfD0ocz4+MTE0LWEpKyhzPj4xMTMtYSYxKSxlKTooZXw9YS0xMTI8PDEwfHM+PjEsZSs9MSZzLGUpfSkobmV3IEludDMyQXJyYXkoZS5idWZmZXIpWzBdKX0sTWF0aC5kZWNvZGUxNkJpdEZsb2F0PXQ9Pntjb25zdCBlPSgzMjc2OCZ0KT4+MTUscz0oMzE3NDQmdCk+PjEwLGE9MTAyMyZ0O3JldHVybiAwPT1zPyhlPy0xOjEpKk1hdGgucG93KDIsLTE0KSooYS9NYXRoLnBvdygyLDEwKSk6MzE9PXM/YT9OYU46MS8wKihlPy0xOjEpOihlPy0xOjEpKk1hdGgucG93KDIscy0xNSkqKDErYS9NYXRoLnBvdygyLDEwKSl9LE1hdGguc21vb3RoU3RlcD0odCxlLHMpPT57Y29uc3QgYT1NYXRoLmNsYW1wKChzLXQpLyhlLXQpLDAsMSk7cmV0dXJuIGEqYSooMy0yKmEpfSxNYXRoLmxpblN0ZXA9KHQsZSxzKT0+TWF0aC5jbGFtcCgocy10KS8oZS10KSwwLDEpO2NsYXNzIHN7aXNWYWxpZCgpe2Zvcihjb25zdCB0IG9mIHRoaXMuX19kYXRhKWlmKHQ9PTEvMHx8aXNOYU4odCkpcmV0dXJuITE7cmV0dXJuITB9c3RhdGljIGNyZWF0ZUZyb21GbG9hdDMyQnVmZmVyKHQsZSl7dGhyb3cgbmV3IEVycm9yKCJOb3QgeWV0IGltcGxlbWVudGVkIGZvciB0aGlzIHR5cGU6Iit0aGlzLmNvbnN0cnVjdG9yLm5hbWUpfXN0YXRpYyBudW1FbGVtZW50cygpe3Rocm93IG5ldyBFcnJvcigiTm90IHlldCBpbXBsZW1lbnRlZCBmb3IgdGhpcyB0eXBlOiIrdGhpcy5jb25zdHJ1Y3Rvci5uYW1lKX1hc0FycmF5KCl7cmV0dXJuIHRoaXMuX19kYXRhfXRvU3RyaW5nKCl7cmV0dXJuIGUodGhpcy50b0pTT04oKSl9fWNvbnN0IGE9bmV3IGNsYXNze2NvbnN0cnVjdG9yKCl7dGhpcy5fX3R5cGVzPXt9LHRoaXMuX19uYW1lcz17fSx0aGlzLnJlZ2lzdGVyVHlwZSgiU0ludDMyIiw1KSx0aGlzLnJlZ2lzdGVyVHlwZSgiVUludDMyIiw0KSx0aGlzLnJlZ2lzdGVyVHlwZSgiRmxvYXQzMiIsNil9cmVnaXN0ZXJUeXBlKHQsZSl7dGhpcy5fX3R5cGVzW3RdPWUsZS5uYW1lP3RoaXMuX19uYW1lc1tlLm5hbWVdPXQ6dGhpcy5fX25hbWVzW2VdPXR9Z2V0VHlwZSh0KXtyZXR1cm4gdGhpcy5fX3R5cGVzW3RdfWdldFR5cGVOYW1lKHQpe2lmKHRoaXMuX19uYW1lc1t0XSlyZXR1cm4gdGhpcy5fX25hbWVzW3RdO2lmKHRoaXMuX19uYW1lc1t0Lm5hbWVdKXJldHVybiB0aGlzLl9fbmFtZXNbdC5uYW1lXTt0aHJvdyB0fX07Y2xhc3MgaSBleHRlbmRzIHN7Y29uc3RydWN0b3IodD0wLGU9MCl7aWYoc3VwZXIoKSx0IGluc3RhbmNlb2YgRmxvYXQzMkFycmF5fHx0IGluc3RhbmNlb2YgVWludDMyQXJyYXl8fHQgaW5zdGFuY2VvZiBJbnQzMkFycmF5KXRoaXMuX19kYXRhPXQ7ZWxzZSBpZih0IGluc3RhbmNlb2YgQXJyYXlCdWZmZXIpe2NvbnN0IHM9dCxhPWU7dGhpcy5fX2RhdGE9bmV3IEZsb2F0MzJBcnJheShzLGEsMil9ZWxzZSBudWxsIT10JiYib2JqZWN0Ij09dHlwZW9mIHQ/KHRoaXMuX19kYXRhPW5ldyBGbG9hdDMyQXJyYXkoMiksdGhpcy5mcm9tSlNPTih0KSk6KHRoaXMuX19kYXRhPW5ldyBGbG9hdDMyQXJyYXkoMiksdGhpcy5fX2RhdGFbMF09dCx0aGlzLl9fZGF0YVsxXT1lKX1nZXQgeCgpe3JldHVybiB0aGlzLl9fZGF0YVswXX1zZXQgeCh0KXt0aGlzLl9fZGF0YVswXT10fWdldCB5KCl7cmV0dXJuIHRoaXMuX19kYXRhWzFdfXNldCB5KHQpe3RoaXMuX19kYXRhWzFdPXR9c2V0KHQsZSl7dGhpcy5fX2RhdGFbMF09dCx0aGlzLl9fZGF0YVsxXT1lfXNldEZyb21PdGhlcih0KXt0aGlzLng9dC54LHRoaXMueT10Lnl9ZXF1YWwodCl7cmV0dXJuIHRoaXMueD09dC54JiZ0aGlzLnk9PXQueX1ub3RFcXVhbHModCl7cmV0dXJuIHRoaXMueCE9dC54JiZ0aGlzLnkhPXQueX1hcHByb3hFcXVhbCh0LGU9TnVtYmVyLkVQU0lMT04pe3JldHVybiBNYXRoLmFicyh0aGlzLngtdC54KTxlJiZNYXRoLmFicyh0aGlzLnktdC55KTxlfWFkZCh0KXtyZXR1cm4gbmV3IGkodGhpcy54K3QueCx0aGlzLnkrdC55KX1hZGRJblBsYWNlKHQpe3RoaXMueCs9dC54LHRoaXMueSs9dC55fXN1YnRyYWN0KHQpe3JldHVybiBuZXcgaSh0aGlzLngtdC54LHRoaXMueS10LnkpfXN1YnRyYWN0SW5QbGFjZSh0KXtyZXR1cm4gdGhpcy54LT10LngsdGhpcy55LT10LnksdGhpc31zY2FsZSh0KXtyZXR1cm4gbmV3IGkodGhpcy54KnQsdGhpcy55KnQpfXNjYWxlSW5QbGFjZSh0KXt0aGlzLngqPXQsdGhpcy55Kj10fWludmVydCgpe3JldHVybiBuZXcgaSgxL3RoaXMueCwxL3RoaXMueSl9aW52ZXJ0SW5QbGFjZSgpe3JldHVybiB0aGlzLng9MS90aGlzLngsdGhpcy55PTEvdGhpcy55LHRoaXN9bXVsdGlwbHkodCl7cmV0dXJuIG5ldyBpKHRoaXMueCp0LngsdGhpcy55KnQueSl9bXVsdGlwbHlJblBsYWNlKHQpe3RoaXMueCo9dC54LHRoaXMueSo9dC55fWxlbmd0aFNxdWFyZWQoKXtjb25zdCB0PXRoaXMuX19kYXRhWzBdLGU9dGhpcy5fX2RhdGFbMV07cmV0dXJuIHQqdCtlKmV9bGVuZ3RoKCl7cmV0dXJuIE1hdGguc3FydCh0aGlzLmxlbmd0aFNxdWFyZWQoKSl9ZGlzdGFuY2VUbyh0KXtjb25zdCBlPXRoaXMuX19kYXRhWzBdLXQueCxzPXRoaXMuX19kYXRhWzFdLXQueTtyZXR1cm4gTWF0aC5zcXJ0KGUqZStzKnMpfW5vcm1hbGl6ZSgpe2NvbnN0IHQ9dGhpcy5fX2RhdGFbMF0sZT10aGlzLl9fZGF0YVsxXTtsZXQgcz10KnQrZSplO3JldHVybiBzPE51bWJlci5FUFNJTE9OP25ldyBpOihzPTEvTWF0aC5zcXJ0KHMpLG5ldyBpKHQqcyxlKnMpKX1ub3JtYWxpemVJblBsYWNlKCl7Y29uc3QgdD10aGlzLl9fZGF0YVswXSxlPXRoaXMuX19kYXRhWzFdO2xldCBzPXQqdCtlKmU7czxOdW1iZXIuRVBTSUxPTnx8KHM9MS9NYXRoLnNxcnQocyksdGhpcy5zZXQodCpzLGUqcykpfWRvdCh0KXtyZXR1cm4gdGhpcy54KnQueCt0aGlzLnkqdC55fWNyb3NzKHQpe3JldHVybiB0aGlzLngqdC55LXRoaXMueSp0Lnh9YW5nbGVUbyh0KXtjb25zdCBlPXRoaXMubm9ybWFsaXplKCkuZG90KHQubm9ybWFsaXplKCkpO3JldHVybiBlPjE/MDplPC0xP01hdGguUEk6TWF0aC5hY29zKGUpfXNpZ25lZEFuZ2xlVG8odCl7Y29uc3QgZT10aGlzLmFuZ2xlVG8odCk7cmV0dXJuIHRoaXMuY3Jvc3ModCk8MD8tZTplfXJvdGF0ZSh0KXtjb25zdCBlPU1hdGguY29zKHQpLHM9TWF0aC5zaW4odCk7cmV0dXJuIG5ldyBpKHRoaXMueCplLXRoaXMueSpzLHRoaXMueCpzK3RoaXMueSplKX1sZXJwKHQsZSl7Y29uc3Qgcz10aGlzLngsYT10aGlzLnk7cmV0dXJuIG5ldyBpKHMrZSoodC54LXMpLGErZSoodC55LWEpKX1zZXRSYW5kb21EaXIodD0xKXtjb25zdCBlPTIqTWF0aC5yYW5kb20oKSpNYXRoLlBJO3JldHVybiB0aGlzLl9fZGF0YVswXT1NYXRoLmNvcyhlKSp6U2NhbGUsdGhpcy5fX2RhdGFbMV09TWF0aC5zaW4oZSkqelNjYWxlLHRoaXN9c2V0UmFuZG9tKHQ9MSl7cmV0dXJuIHRoaXMuX19kYXRhWzBdPU1hdGgucmFuZG9tKCkqdCx0aGlzLl9fZGF0YVsxXT1NYXRoLnJhbmRvbSgpKnQsdGhpc31jbG9uZSgpe3JldHVybiBuZXcgaSh0aGlzLl9fZGF0YVswXSx0aGlzLl9fZGF0YVsxXSl9YXNBcnJheSgpe3JldHVybiB0aGlzLl9fZGF0YX1zdGF0aWMgY3JlYXRlKC4uLnQpe3JldHVybiBuZXcgaSguLi50KX1zdGF0aWMgY3JlYXRlRnJvbUZsb2F0MzJCdWZmZXIodCxlPTApe3JldHVybiBuZXcgaSh0LDQqZSl9c3RhdGljIGNyZWF0ZUZyb21GbG9hdDMyQXJyYXkodCl7cmV0dXJuIG5ldyBpKHQpfXN0YXRpYyBudW1FbGVtZW50cygpe3JldHVybiAyfXRvSlNPTigpe3JldHVybnt4OnRoaXMueCx5OnRoaXMueX19ZnJvbUpTT04odCl7dGhpcy54PXQueCx0aGlzLnk9dC55fX1hLnJlZ2lzdGVyVHlwZSgiVmVjMiIsaSk7Y2xhc3MgciBleHRlbmRzIHN7Y29uc3RydWN0b3IodD0wLGU9MCxzPTApe2lmKHN1cGVyKCksdCBpbnN0YW5jZW9mIEZsb2F0MzJBcnJheXx8dCBpbnN0YW5jZW9mIFVpbnQzMkFycmF5KXRoaXMuX19kYXRhPXQ7ZWxzZSBpZih0IGluc3RhbmNlb2YgQXJyYXlCdWZmZXIpe2NvbnN0IHM9dCxhPWU7dGhpcy5fX2RhdGE9bmV3IEZsb2F0MzJBcnJheShzLGEsMyl9ZWxzZSBudWxsIT10JiYib2JqZWN0Ij09dHlwZW9mIHQ/KHRoaXMuX19kYXRhPW5ldyBGbG9hdDMyQXJyYXkoMyksdGhpcy5mcm9tSlNPTih0KSk6KHRoaXMuX19kYXRhPW5ldyBGbG9hdDMyQXJyYXkoMyksdGhpcy5fX2RhdGFbMF09dCx0aGlzLl9fZGF0YVsxXT1lLHRoaXMuX19kYXRhWzJdPXMpfWdldCB4KCl7cmV0dXJuIHRoaXMuX19kYXRhWzBdfXNldCB4KHQpe3RoaXMuX19kYXRhWzBdPXR9Z2V0IHkoKXtyZXR1cm4gdGhpcy5fX2RhdGFbMV19c2V0IHkodCl7dGhpcy5fX2RhdGFbMV09dH1nZXQgeigpe3JldHVybiB0aGlzLl9fZGF0YVsyXX1zZXQgeih0KXt0aGlzLl9fZGF0YVsyXT10fWdldCB4eSgpe3JldHVybiBuZXcgaSh0aGlzLl9fZGF0YVswXSx0aGlzLl9fZGF0YVsxXSl9Z2V0IHl6KCl7cmV0dXJuIG5ldyBpKHRoaXMuX19kYXRhWzFdLHRoaXMuX19kYXRhWzJdKX1zZXQodCxlLHMpe3RoaXMueD10LHRoaXMueT12b2lkIDAhPT1lP2U6dCx0aGlzLno9dm9pZCAwIT09cz9zOnR9c2V0RGF0YUFycmF5KHQpe3RoaXMuX19kYXRhPXR9c2V0RnJvbU90aGVyKHQpe3RoaXMueD10LngsdGhpcy55PXQueSx0aGlzLno9dC56fWlzTnVsbCgpe3JldHVybiBNYXRoLmFicyh0aGlzLngpPE51bWJlci5FUFNJTE9OJiZNYXRoLmFicyh0aGlzLnkpPE51bWJlci5FUFNJTE9OJiZNYXRoLmFicyh0aGlzLnopPE51bWJlci5FUFNJTE9OfWlzMTExKCl7cmV0dXJuIE1hdGguYWJzKDEtdGhpcy54KTxOdW1iZXIuRVBTSUxPTiYmTWF0aC5hYnMoMS10aGlzLnkpPE51bWJlci5FUFNJTE9OJiZNYXRoLmFicygxLXRoaXMueik8TnVtYmVyLkVQU0lMT059ZXF1YWwodCl7cmV0dXJuIHRoaXMueD09dC54JiZ0aGlzLnk9PXQueSYmdGhpcy56PT10Lnp9bm90RXF1YWxzKHQpe3JldHVybiB0aGlzLnghPXQueCYmdGhpcy55IT10LnkmJnRoaXMueiE9dC56fWFwcHJveEVxdWFsKHQsZT1OdW1iZXIuRVBTSUxPTil7cmV0dXJuIE1hdGguYWJzKHRoaXMueC10LngpPGUmJk1hdGguYWJzKHRoaXMueS10LnkpPGUmJk1hdGguYWJzKHRoaXMuei10LnopPGV9YWRkKHQpe3JldHVybiBuZXcgcih0aGlzLngrdC54LHRoaXMueSt0LnksdGhpcy56K3Queil9YWRkSW5QbGFjZSh0KXt0aGlzLngrPXQueCx0aGlzLnkrPXQueSx0aGlzLnorPXQuen1zdWJ0cmFjdCh0KXtyZXR1cm4gbmV3IHIodGhpcy54LXQueCx0aGlzLnktdC55LHRoaXMuei10LnopfXN1YnRyYWN0SW5QbGFjZSh0KXt0aGlzLngtPXQueCx0aGlzLnktPXQueSx0aGlzLnotPXQuen1tdWx0aXBseSh0KXtyZXR1cm4gbmV3IHIodGhpcy54KnQueCx0aGlzLnkqdC55LHRoaXMueip0LnopfW11bHRpcGx5SW5QbGFjZSh0KXt0aGlzLngqPXQueCx0aGlzLnkqPXQueSx0aGlzLnoqPXQuen1kaXZpZGUodCl7cmV0dXJuIG5ldyByKHRoaXMueC90LngsdGhpcy55L3QueSx0aGlzLnovdC56KX1kaXZpZGVJblBsYWNlKHQpe3RoaXMueC89dC54LHRoaXMueS89dC55LHRoaXMuei89dC56fXNjYWxlKHQpe3JldHVybiBuZXcgcih0aGlzLngqdCx0aGlzLnkqdCx0aGlzLnoqdCl9c2NhbGVJblBsYWNlKHQpe3RoaXMueCo9dCx0aGlzLnkqPXQsdGhpcy56Kj10fW5lZ2F0ZSgpe3JldHVybiBuZXcgcigtdGhpcy54LC10aGlzLnksLXRoaXMueil9aW52ZXJzZSgpe3JldHVybiBuZXcgcigxL3RoaXMueCwxL3RoaXMueSwxL3RoaXMueil9bGVuZ3RoU3F1YXJlZCgpe2NvbnN0IHQ9dGhpcy5fX2RhdGFbMF0sZT10aGlzLl9fZGF0YVsxXSxzPXRoaXMuX19kYXRhWzJdO3JldHVybiB0KnQrZSplK3Mqc31sZW5ndGgoKXtyZXR1cm4gTWF0aC5zcXJ0KHRoaXMubGVuZ3RoU3F1YXJlZCgpKX1kaXN0YW5jZVRvKHQpe2NvbnN0IGU9dGhpcy5fX2RhdGFbMF0tdC54LHM9dGhpcy5fX2RhdGFbMV0tdC55LGE9dGhpcy5fX2RhdGFbMl0tdC56O3JldHVybiBNYXRoLnNxcnQoZSplK3MqcythKmEpfW5vcm1hbGl6ZSgpe2xldCB0PXRoaXMuX19kYXRhWzBdKnRoaXMuX19kYXRhWzBdK3RoaXMuX19kYXRhWzFdKnRoaXMuX19kYXRhWzFdK3RoaXMuX19kYXRhWzJdKnRoaXMuX19kYXRhWzJdO3JldHVybiB0PE51bWJlci5FUFNJTE9OP25ldyByOih0PTEvTWF0aC5zcXJ0KHQpLG5ldyByKHRoaXMuX19kYXRhWzBdKnQsdGhpcy5fX2RhdGFbMV0qdCx0aGlzLl9fZGF0YVsyXSp0KSl9bm9ybWFsaXplSW5QbGFjZSgpe2xldCB0PXRoaXMuX19kYXRhWzBdKnRoaXMuX19kYXRhWzBdK3RoaXMuX19kYXRhWzFdKnRoaXMuX19kYXRhWzFdK3RoaXMuX19kYXRhWzJdKnRoaXMuX19kYXRhWzJdO2lmKHQ8TnVtYmVyLkVQU0lMT04pcmV0dXJuO3Q9TWF0aC5zcXJ0KHQpO2NvbnN0IGU9MS90O3JldHVybiB0aGlzLl9fZGF0YVswXSo9ZSx0aGlzLl9fZGF0YVsxXSo9ZSx0aGlzLl9fZGF0YVsyXSo9ZSx0fXJlc2l6ZSh0KXtjb25zdCBlPXRoaXMuX19kYXRhWzBdKnRoaXMuX19kYXRhWzBdK3RoaXMuX19kYXRhWzFdKnRoaXMuX19kYXRhWzFdK3RoaXMuX19kYXRhWzJdKnRoaXMuX19kYXRhWzJdO2lmKGU8TnVtYmVyLkVQU0lMT04pcmV0dXJuO2NvbnN0IHM9dC9NYXRoLnNxcnQoZSk7cmV0dXJuIG5ldyByKHRoaXMuX19kYXRhWzBdKnMsdGhpcy5fX2RhdGFbMV0qcyx0aGlzLl9fZGF0YVsyXSpzKX1yZXNpemVJblBsYWNlKHQpe2NvbnN0IGU9dGhpcy5fX2RhdGFbMF0qdGhpcy5fX2RhdGFbMF0rdGhpcy5fX2RhdGFbMV0qdGhpcy5fX2RhdGFbMV0rdGhpcy5fX2RhdGFbMl0qdGhpcy5fX2RhdGFbMl07aWYoZTxOdW1iZXIuRVBTSUxPTilyZXR1cm47Y29uc3Qgcz10L01hdGguc3FydChlKTt0aGlzLl9fZGF0YVswXSo9cyx0aGlzLl9fZGF0YVsxXSo9cyx0aGlzLl9fZGF0YVsyXSo9c31kb3QodCl7cmV0dXJuIHRoaXMueCp0LngrdGhpcy55KnQueSt0aGlzLnoqdC56fWNyb3NzKHQpe2NvbnN0IGU9dGhpcy54LHM9dGhpcy55LGE9dGhpcy56LGk9dC54LG49dC55LGg9dC56O3JldHVybiBuZXcgcihzKmgtYSpuLGEqaS1lKmgsZSpuLXMqaSl9YW5nbGVUbyh0KXtjb25zdCBlPXRoaXMuZG90KHQpO3JldHVybiBlPjE/MDpNYXRoLmFjb3MoZSl9bGVycCh0LGUpe2NvbnN0IHM9dGhpcy54LGE9dGhpcy55LGk9dGhpcy56O3JldHVybiBuZXcgcihzK2UqKHQueC1zKSxhK2UqKHQueS1hKSxpK2UqKHQuei1pKSl9YWJzKCl7cmV0dXJuIG5ldyByKE1hdGguYWJzKHRoaXMueCksTWF0aC5hYnModGhpcy55KSxNYXRoLmFicyh0aGlzLnopKX1zZXRSYW5kb21EaXIodD0xKXtjb25zdCBlPTIqTWF0aC5yYW5kb20oKSpNYXRoLlBJLHM9MipNYXRoLnJhbmRvbSgpLTEsYT1NYXRoLnNxcnQoMS1zKnMpKnQ7cmV0dXJuIHRoaXMuX19kYXRhWzBdPU1hdGguY29zKGUpKmEsdGhpcy5fX2RhdGFbMV09TWF0aC5zaW4oZSkqYSx0aGlzLl9fZGF0YVsyXT1zKnQsdGhpc31zZXRSYW5kb20odD0xKXtyZXR1cm4gdGhpcy5fX2RhdGFbMF09KE1hdGgucmFuZG9tKCktLjUpKnQsdGhpcy5fX2RhdGFbMV09KE1hdGgucmFuZG9tKCktLjUpKnQsdGhpcy5fX2RhdGFbMl09KE1hdGgucmFuZG9tKCktLjUpKnQsdGhpc31jbG9uZSgpe3JldHVybiBuZXcgcih0aGlzLl9fZGF0YVswXSx0aGlzLl9fZGF0YVsxXSx0aGlzLl9fZGF0YVsyXSl9YXNBcnJheSgpe3JldHVybiB0aGlzLl9fZGF0YX1zdGF0aWMgY3JlYXRlKC4uLnQpe3JldHVybiBuZXcgciguLi50KX1zdGF0aWMgY3JlYXRlRnJvbUpTT04odCl7Y29uc3QgZT1uZXcgcjtyZXR1cm4gZS5mcm9tSlNPTih0KSxlfXN0YXRpYyBjcmVhdGVGcm9tRmxvYXQzMkJ1ZmZlcih0LGU9MCl7cmV0dXJuIG5ldyByKHQsNCplKX1zdGF0aWMgY3JlYXRlRnJvbUZsb2F0MzJBcnJheSh0KXtyZXR1cm4gbmV3IHIodCl9c3RhdGljIG51bUVsZW1lbnRzKCl7cmV0dXJuIDN9dG9KU09OKCl7cmV0dXJue3g6dGhpcy54LHk6dGhpcy55LHo6dGhpcy56fX1mcm9tSlNPTih0KXt0aGlzLng9dC54LHRoaXMueT10LnksdGhpcy56PXQuen19YS5yZWdpc3RlclR5cGUoIlZlYzMiLHIpO2NsYXNzIG4gZXh0ZW5kcyBze2NvbnN0cnVjdG9yKHQ9MCxlPTAscz0wLGE9MCl7aWYoc3VwZXIoKSx0IGluc3RhbmNlb2YgQXJyYXlCdWZmZXIpe2NvbnN0IHM9dCxhPWU7dGhpcy5fX2RhdGE9bmV3IEZsb2F0MzJBcnJheShzLGEsNCl9ZWxzZSBudWxsIT10JiYib2JqZWN0Ij09dHlwZW9mIHQ/KHRoaXMuX19kYXRhPW5ldyBGbG9hdDMyQXJyYXkoNCksdGhpcy5mcm9tSlNPTih0KSk6KHRoaXMuX19kYXRhPW5ldyBGbG9hdDMyQXJyYXkoNCksdGhpcy5fX2RhdGFbMF09dCx0aGlzLl9fZGF0YVsxXT1lLHRoaXMuX19kYXRhWzJdPXMsdGhpcy5fX2RhdGFbM109YSl9Z2V0IHgoKXtyZXR1cm4gdGhpcy5fX2RhdGFbMF19c2V0IHgodCl7dGhpcy5fX2RhdGFbMF09dH1nZXQgeSgpe3JldHVybiB0aGlzLl9fZGF0YVsxXX1zZXQgeSh0KXt0aGlzLl9fZGF0YVsxXT10fWdldCB6KCl7cmV0dXJuIHRoaXMuX19kYXRhWzJdfXNldCB6KHQpe3RoaXMuX19kYXRhWzJdPXR9Z2V0IHQoKXtyZXR1cm4gdGhpcy5fX2RhdGFbM119c2V0IHQodCl7dGhpcy5fX2RhdGFbM109dH1nZXQgeHl6KCl7cmV0dXJuIG5ldyByKHRoaXMuX19kYXRhWzBdLHRoaXMuX19kYXRhWzFdLHRoaXMuX19kYXRhWzJdKX1zZXQodCxlLHMsYSl7dGhpcy54PXQsdGhpcy55PWUsdGhpcy56PXMsdGhpcy50PWF9c2V0RnJvbU90aGVyKHQpe3RoaXMueD10LngsdGhpcy55PXQueSx0aGlzLno9dC56LHRoaXMudD10LnR9ZXF1YWwodCl7cmV0dXJuIHRoaXMueD09dC54JiZ0aGlzLnk9PXQueSYmdGhpcy56PT10LnomJnRoaXMudD09dC50fW5vdEVxdWFscyh0KXtyZXR1cm4gdGhpcy54IT10LngmJnRoaXMueSE9dC55JiZ0aGlzLnohPXQueiYmdGhpcy50IT10LnR9YXBwcm94RXF1YWwodCxlPU51bWJlci5FUFNJTE9OKXtyZXR1cm4gTWF0aC5hYnModGhpcy54LXQueCk8ZSYmTWF0aC5hYnModGhpcy55LXQueSk8ZSYmTWF0aC5hYnModGhpcy56LXQueik8ZSYmTWF0aC5hYnModGhpcy50LXQudCk8ZX1hZGQodCl7cmV0dXJuIG5ldyBuKHRoaXMueCt0LngsdGhpcy55K3QueSx0aGlzLnordC56LHRoaXMudCt0LnQpfWFkZEluUGxhY2UodCl7dGhpcy54Kz10LngsdGhpcy55Kz10LnksdGhpcy56Kz10LnosdGhpcy50Kz10LnR9c3VidHJhY3QodCl7cmV0dXJuIG5ldyBuKHRoaXMueC10LngsdGhpcy55LXQueSx0aGlzLnotdC56LHRoaXMudC10LnQpfXN1YnRyYWN0SW5QbGFjZSh0KXt0aGlzLngtPXQueCx0aGlzLnktPXQueSx0aGlzLnotPXQueix0aGlzLnQtPXQudH1tdWx0aXBseSh0KXtyZXR1cm4gbmV3IG4odGhpcy54KnQueCx0aGlzLnkqdC55LHRoaXMueip0LnosdGhpcy50KnQudCl9bXVsdGlwbHlJblBsYWNlKHQpe3RoaXMueCo9dC54LHRoaXMueSo9dC55LHRoaXMueio9dC56LHRoaXMudCo9dC50fWRpdmlkZSh0KXtyZXR1cm4gbmV3IG4odGhpcy54L3QueCx0aGlzLnkvdC55LHRoaXMuei90LnosdGhpcy50L3QudCl9ZGl2aWRlSW5QbGFjZSh0KXt0aGlzLngvPXQueCx0aGlzLnkvPXQueSx0aGlzLnovPXQueix0aGlzLnQvPXQudH1zY2FsZSh0KXtyZXR1cm4gbmV3IG4odGhpcy54KnQsdGhpcy55KnQsdGhpcy56KnQsdGhpcy50KnQpfXNjYWxlSW5QbGFjZSh0KXt0aGlzLnNldCh0aGlzLngqdCx0aGlzLnkqdCx0aGlzLnoqdCx0aGlzLnQqdCl9bGVuZ3RoKCl7Y29uc3QgdD10aGlzLl9fZGF0YVswXSxlPXRoaXMuX19kYXRhWzFdLHM9dGhpcy5fX2RhdGFbMl0sYT10aGlzLl9fZGF0YVsyXTtyZXR1cm4gTWF0aC5zcXJ0KHQqdCtlKmUrcypzK2EqYSl9bGVuZ3RoU3F1YXJlZCgpe2NvbnN0IHQ9dGhpcy5fX2RhdGFbMF0sZT10aGlzLl9fZGF0YVsxXSxzPXRoaXMuX19kYXRhWzJdLGE9dGhpcy5fX2RhdGFbM107cmV0dXJuIHQqdCtlKmUrcypzK2EqYX1ub3JtYWxpemUoKXtjb25zdCB0PXRoaXMuX19kYXRhWzBdLGU9dGhpcy5fX2RhdGFbMV0scz10aGlzLl9fZGF0YVsyXSxhPXRoaXMuX19kYXRhWzNdO2xldCBpPXQqdCtlKmUrcypzK2EqYTtyZXR1cm4gaTxOdW1iZXIuRVBTSUxPTj9uZXcgbjooaT0xL01hdGguc3FydChpKSxuZXcgbih0KmksZSppLHMqaSkpfW5vcm1hbGl6ZUluUGxhY2UoKXtjb25zdCB0PXRoaXMuX19kYXRhWzBdLGU9dGhpcy5fX2RhdGFbMV0scz10aGlzLl9fZGF0YVsyXSxhPXRoaXMuX19kYXRhWzNdO2xldCBpPXQqdCtlKmUrcypzK2EqYTtpPE51bWJlci5FUFNJTE9OfHwoaT0xL01hdGguc3FydChpKSx0aGlzLnNldCh0KmksZSppLHMqaSxhKmkpKX1kb3QodCl7cmV0dXJuIHRoaXMueCp0LngrdGhpcy55KnQueSt0aGlzLnoqdC56K3RoaXMudCpiLnR9Y3Jvc3ModCl7Y29uc3QgZT10aGlzLngscz10aGlzLnksYT10aGlzLnosaT10aGlzLnQscj10LngsaD10Lnksbz10LnosXz10LnQ7cmV0dXJuIG5ldyBuKHMqby1hKmgsYSpfLWkqbyxpKnItZSpfLGUqaC1zKnIpfWFuZ2xlVG8odCl7Y29uc3QgZT10aGlzLm5vcm1hbGl6ZSgpLHM9dC5ub3JtYWxpemUoKSxhPWUuZG90KHMpO3JldHVybiBhPjE/MDpNYXRoLmFjb3MoYSl9bGVycCh0LGUpe2NvbnN0IHM9dGhpcy54LGE9dGhpcy55LGk9dGhpcy56O3JldHVybiBhdD10aGlzLnQsbmV3IG4ocytlKih0LngtcyksYStlKih0LnktYSksaStlKih0LnotaSksYXQrZSoodC50LWF0KSl9cmFuZG9tKHQ9MSl7Y29uc3QgZT0yKmdsTWF0cml4LlJBTkRPTSgpKk1hdGguUEkscz0yKmdsTWF0cml4LlJBTkRPTSgpLTEsYT1NYXRoLnNxcnQoMS1zKnMpKnQ7cmV0dXJuIG91dFswXT1NYXRoLmNvcyhlKSphLG91dFsxXT1NYXRoLnNpbihlKSphLG91dFsyXT1zKnQsb3V0fWNsb25lKCl7cmV0dXJuIG5ldyBuKHRoaXMuX19kYXRhWzBdLHRoaXMuX19kYXRhWzFdLHRoaXMuX19kYXRhWzJdLHRoaXMuX19kYXRhWzNdKX10b1ZlYzMoKXtyZXR1cm4gbmV3IHIodGhpcy5fX2RhdGFbMF0sdGhpcy5fX2RhdGFbMV0sdGhpcy5fX2RhdGFbMl0pfWFzQXJyYXkoKXtyZXR1cm4gdGhpcy5fX2RhdGF9c3RhdGljIGNyZWF0ZSguLi50KXtyZXR1cm4gbmV3IHIoLi4udCl9c3RhdGljIGNyZWF0ZUZyb21GbG9hdDMyQnVmZmVyKHQsZT0wKXtyZXR1cm4gbmV3IG4odCw0KmUpfXN0YXRpYyBudW1FbGVtZW50cygpe3JldHVybiA0fXRvSlNPTigpe3JldHVybnt4OnRoaXMueCx5OnRoaXMueSx6OnRoaXMueix0OnRoaXMudH19fWEucmVnaXN0ZXJUeXBlKCJWZWM0IixuKTtjbGFzcyBoIGV4dGVuZHMgc3tjb25zdHJ1Y3Rvcih0PTAsZT0wLHM9MCxhPTI1NSl7aWYoc3VwZXIoKSx0IGluc3RhbmNlb2YgVWludDhBcnJheSl0aGlzLl9fZGF0YT10O2Vsc2UgaWYodCBpbnN0YW5jZW9mIEFycmF5QnVmZmVyKXtjb25zdCBzPXQsYT1lO3RoaXMuX19kYXRhPW5ldyBVaW50OEFycmF5KHMsYSw0KX1lbHNlIHRoaXMuX19kYXRhPW5ldyBVaW50OEFycmF5KDQpLCJzdHJpbmciPT10eXBlb2YgdD90LnN0YXJ0c1dpdGgoIiMiKT90aGlzLnNldEZyb21IZXgodCk6dGhpcy5zZXRGcm9tQ1NTQ29sb3JOYW1lKHQpOih0aGlzLl9fZGF0YVswXT10LHRoaXMuX19kYXRhWzFdPWUsdGhpcy5fX2RhdGFbMl09cyx0aGlzLl9fZGF0YVszXT1hKX1nZXQgcigpe3JldHVybiB0aGlzLl9fZGF0YVswXX1zZXQgcih0KXt0aGlzLl9fZGF0YVswXT10fWdldCBnKCl7cmV0dXJuIHRoaXMuX19kYXRhWzFdfXNldCBnKHQpe3RoaXMuX19kYXRhWzFdPXR9Z2V0IGIoKXtyZXR1cm4gdGhpcy5fX2RhdGFbMl19c2V0IGIodCl7dGhpcy5fX2RhdGFbMl09dH1nZXQgYSgpe3JldHVybiB0aGlzLl9fZGF0YVszXX1zZXQgYSh0KXt0aGlzLl9fZGF0YVszXT10fXNldCh0LGUscyxhPTI1NSl7dGhpcy5yPXQsdGhpcy5nPWUsdGhpcy5iPXMsdGhpcy5hPWF9c2V0RnJvbU90aGVyKHQpe3RoaXMucj10LnIsdGhpcy5nPXQuZyx0aGlzLmI9dC5iLHRoaXMuYT10LmF9c2V0RnJvbUFycmF5KHQpe3RoaXMucj10WzBdLHRoaXMuZz10WzFdLHRoaXMuYj10WzJdLHRoaXMuYT00PT10Lmxlbmd0aD90WzNdOjF9c2V0RnJvbUhleCh0KXtjb25zdCBlPWZ1bmN0aW9uKHQpe2NvbnN0IGU9L14jPyhbYS1mXGRdezJ9KShbYS1mXGRdezJ9KShbYS1mXGRdezJ9KSQvaS5leGVjKHQpO3JldHVybiBlP3tyOnBhcnNlSW50KGVbMV0sMTYpLGc6cGFyc2VJbnQoZVsyXSwxNiksYjpwYXJzZUludChlWzNdLDE2KX06bnVsbH0odCk7ZT90aGlzLnNldChlLnIsZS5nLGUuYik6Y29uc29sZS53YXJuKCJJbnZhbGlkIGhleCBjb2RlOiIrdCl9c2V0RnJvbUNTU0NvbG9yTmFtZSh0KXt0LnN0YXJ0c1dpdGgoIiMiKT90aGlzLnNldEZyb21IZXgodCk6dGhpcy5zZXRGcm9tSGV4KCh0PT57Y29uc3QgZT17YWxpY2VibHVlOiIjZjBmOGZmIixhbnRpcXVld2hpdGU6IiNmYWViZDciLGFxdWE6IiMwMGZmZmYiLGFxdWFtYXJpbmU6IiM3ZmZmZDQiLGF6dXJlOiIjZjBmZmZmIixiZWlnZToiI2Y1ZjVkYyIsYmlzcXVlOiIjZmZlNGM0IixibGFjazoiIzAwMDAwMCIsYmxhbmNoZWRhbG1vbmQ6IiNmZmViY2QiLGJsdWU6IiMwMDAwZmYiLGJsdWV2aW9sZXQ6IiM4YTJiZTIiLGJyb3duOiIjYTUyYTJhIixidXJseXdvb2Q6IiNkZWI4ODciLGNhZGV0Ymx1ZToiIzVmOWVhMCIsY2hhcnRyZXVzZToiIzdmZmYwMCIsY2hvY29sYXRlOiIjZDI2OTFlIixjb3JhbDoiI2ZmN2Y1MCIsY29ybmZsb3dlcmJsdWU6IiM2NDk1ZWQiLGNvcm5zaWxrOiIjZmZmOGRjIixjcmltc29uOiIjZGMxNDNjIixjeWFuOiIjMDBmZmZmIixkYXJrYmx1ZToiIzAwMDA4YiIsZGFya2N5YW46IiMwMDhiOGIiLGRhcmtnb2xkZW5yb2Q6IiNiODg2MGIiLGRhcmtncmF5OiIjYTlhOWE5IixkYXJrZ3JlZW46IiMwMDY0MDAiLGRhcmtraGFraToiI2JkYjc2YiIsZGFya21hZ2VudGE6IiM4YjAwOGIiLGRhcmtvbGl2ZWdyZWVuOiIjNTU2YjJmIixkYXJrb3JhbmdlOiIjZmY4YzAwIixkYXJrb3JjaGlkOiIjOTkzMmNjIixkYXJrcmVkOiIjOGIwMDAwIixkYXJrc2FsbW9uOiIjZTk5NjdhIixkYXJrc2VhZ3JlZW46IiM4ZmJjOGYiLGRhcmtzbGF0ZWJsdWU6IiM0ODNkOGIiLGRhcmtzbGF0ZWdyYXk6IiMyZjRmNGYiLGRhcmt0dXJxdW9pc2U6IiMwMGNlZDEiLGRhcmt2aW9sZXQ6IiM5NDAwZDMiLGRlZXBwaW5rOiIjZmYxNDkzIixkZWVwc2t5Ymx1ZToiIzAwYmZmZiIsZGltZ3JheToiIzY5Njk2OSIsZG9kZ2VyYmx1ZToiIzFlOTBmZiIsZmlyZWJyaWNrOiIjYjIyMjIyIixmbG9yYWx3aGl0ZToiI2ZmZmFmMCIsZm9yZXN0Z3JlZW46IiMyMjhiMjIiLGZ1Y2hzaWE6IiNmZjAwZmYiLGdhaW5zYm9ybzoiI2RjZGNkYyIsZ2hvc3R3aGl0ZToiI2Y4ZjhmZiIsZ29sZDoiI2ZmZDcwMCIsZ29sZGVucm9kOiIjZGFhNTIwIixncmF5OiIjODA4MDgwIixncmVlbjoiIzAwODAwMCIsZ3JlZW55ZWxsb3c6IiNhZGZmMmYiLGhvbmV5ZGV3OiIjZjBmZmYwIixob3RwaW5rOiIjZmY2OWI0IiwiaW5kaWFucmVkICI6IiNjZDVjNWMiLGluZGlnbzoiIzRiMDA4MiIsaXZvcnk6IiNmZmZmZjAiLGtoYWtpOiIjZjBlNjhjIixsYXZlbmRlcjoiI2U2ZTZmYSIsbGF2ZW5kZXJibHVzaDoiI2ZmZjBmNSIsbGF3bmdyZWVuOiIjN2NmYzAwIixsZW1vbmNoaWZmb246IiNmZmZhY2QiLGxpZ2h0Ymx1ZToiI2FkZDhlNiIsbGlnaHRjb3JhbDoiI2YwODA4MCIsbGlnaHRjeWFuOiIjZTBmZmZmIixsaWdodGdvbGRlbnJvZHllbGxvdzoiI2ZhZmFkMiIsbGlnaHRncmV5OiIjZDNkM2QzIixsaWdodGdyZWVuOiIjOTBlZTkwIixsaWdodHBpbms6IiNmZmI2YzEiLGxpZ2h0c2FsbW9uOiIjZmZhMDdhIixsaWdodHNlYWdyZWVuOiIjMjBiMmFhIixsaWdodHNreWJsdWU6IiM4N2NlZmEiLGxpZ2h0c2xhdGVncmF5OiIjNzc4ODk5IixsaWdodHN0ZWVsYmx1ZToiI2IwYzRkZSIsbGlnaHR5ZWxsb3c6IiNmZmZmZTAiLGxpbWU6IiMwMGZmMDAiLGxpbWVncmVlbjoiIzMyY2QzMiIsbGluZW46IiNmYWYwZTYiLG1hZ2VudGE6IiNmZjAwZmYiLG1hcm9vbjoiIzgwMDAwMCIsbWVkaXVtYXF1YW1hcmluZToiIzY2Y2RhYSIsbWVkaXVtYmx1ZToiIzAwMDBjZCIsbWVkaXVtb3JjaGlkOiIjYmE1NWQzIixtZWRpdW1wdXJwbGU6IiM5MzcwZDgiLG1lZGl1bXNlYWdyZWVuOiIjM2NiMzcxIixtZWRpdW1zbGF0ZWJsdWU6IiM3YjY4ZWUiLG1lZGl1bXNwcmluZ2dyZWVuOiIjMDBmYTlhIixtZWRpdW10dXJxdW9pc2U6IiM0OGQxY2MiLG1lZGl1bXZpb2xldHJlZDoiI2M3MTU4NSIsbWlkbmlnaHRibHVlOiIjMTkxOTcwIixtaW50Y3JlYW06IiNmNWZmZmEiLG1pc3R5cm9zZToiI2ZmZTRlMSIsbW9jY2FzaW46IiNmZmU0YjUiLG5hdmFqb3doaXRlOiIjZmZkZWFkIixuYXZ5OiIjMDAwMDgwIixvbGRsYWNlOiIjZmRmNWU2IixvbGl2ZToiIzgwODAwMCIsb2xpdmVkcmFiOiIjNmI4ZTIzIixvcmFuZ2U6IiNmZmE1MDAiLG9yYW5nZXJlZDoiI2ZmNDUwMCIsb3JjaGlkOiIjZGE3MGQ2IixwYWxlZ29sZGVucm9kOiIjZWVlOGFhIixwYWxlZ3JlZW46IiM5OGZiOTgiLHBhbGV0dXJxdW9pc2U6IiNhZmVlZWUiLHBhbGV2aW9sZXRyZWQ6IiNkODcwOTMiLHBhcGF5YXdoaXA6IiNmZmVmZDUiLHBlYWNocHVmZjoiI2ZmZGFiOSIscGVydToiI2NkODUzZiIscGluazoiI2ZmYzBjYiIscGx1bToiI2RkYTBkZCIscG93ZGVyYmx1ZToiI2IwZTBlNiIscHVycGxlOiIjODAwMDgwIixyZWJlY2NhcHVycGxlOiIjNjYzMzk5IixyZWQ6IiNmZjAwMDAiLHJvc3licm93bjoiI2JjOGY4ZiIscm95YWxibHVlOiIjNDE2OWUxIixzYWRkbGVicm93bjoiIzhiNDUxMyIsc2FsbW9uOiIjZmE4MDcyIixzYW5keWJyb3duOiIjZjRhNDYwIixzZWFncmVlbjoiIzJlOGI1NyIsc2Vhc2hlbGw6IiNmZmY1ZWUiLHNpZW5uYToiI2EwNTIyZCIsc2lsdmVyOiIjYzBjMGMwIixza3libHVlOiIjODdjZWViIixzbGF0ZWJsdWU6IiM2YTVhY2QiLHNsYXRlZ3JheToiIzcwODA5MCIsc25vdzoiI2ZmZmFmYSIsc3ByaW5nZ3JlZW46IiMwMGZmN2YiLHN0ZWVsYmx1ZToiIzQ2ODJiNCIsdGFuOiIjZDJiNDhjIix0ZWFsOiIjMDA4MDgwIix0aGlzdGxlOiIjZDhiZmQ4Iix0b21hdG86IiNmZjYzNDciLHR1cnF1b2lzZToiIzQwZTBkMCIsdmlvbGV0OiIjZWU4MmVlIix3aGVhdDoiI2Y1ZGViMyIsd2hpdGU6IiNmZmZmZmYiLHdoaXRlc21va2U6IiNmNWY1ZjUiLHllbGxvdzoiI2ZmZmYwMCIseWVsbG93Z3JlZW46IiM5YWNkMzIifTtyZXR1cm4gdm9pZCAwIT09ZVt0LnRvTG93ZXJDYXNlKCldJiZlW3QudG9Mb3dlckNhc2UoKV19KSh0KSl9dG9IZXgoKXtmdW5jdGlvbiB0KHQpe2NvbnN0IGU9dC50b1N0cmluZygxNik7cmV0dXJuIDE9PWUubGVuZ3RoPyIwIitlOmV9cmV0dXJuIiMiK3QodGhpcy5yKSt0KHRoaXMuZykrdCh0aGlzLmIpfWVxdWFsKHQpe3JldHVybiB0aGlzLnI9PXQuciYmdGhpcy5nPT10LmcmJnRoaXMuYj09dC5iJiZ0aGlzLmE9PXQuYX1ub3RlcXVhbHModCl7cmV0dXJuIHRoaXMuciE9dC5yJiZ0aGlzLmchPXQuZyYmdGhpcy5iIT10LmImJnRoaXMuYSE9dC5hfWFwcHJveEVxdWFsKHQsZT1OdW1iZXIuRVBTSUxPTil7cmV0dXJuIE1hdGguYWJzKHRoaXMuci10LnIpPGUmJk1hdGguYWJzKHRoaXMuZy10LmcpPGUmJk1hdGguYWJzKHRoaXMuYi10LmIpPGUmJk1hdGguYWJzKHRoaXMuYS10LmEpPGV9YWRkKHQpe3JldHVybiBuZXcgaCh0aGlzLnIrdC5yLHRoaXMuZyt0LmcsdGhpcy5iK3QuYix0aGlzLmErdC5hKX1zdWJ0cmFjdCh0KXtyZXR1cm4gbmV3IGgodGhpcy5yLXQucix0aGlzLmctdC5nLHRoaXMuYi10LmIsdGhpcy5hLXQuYSl9c2NhbGUodCl7cmV0dXJuIG5ldyBoKHRoaXMucip0LHRoaXMuZyp0LHRoaXMuYip0LHRoaXMuYSp0KX1zY2FsZUluUGxhY2UodCl7dGhpcy5yKj10LHRoaXMuZyo9dCx0aGlzLmIqPXQsdGhpcy5hKj10fWFwcGx5R2FtbWEodCl7dGhpcy5zZXQoTWF0aC5wb3codGhpcy5yLHQpLE1hdGgucG93KHRoaXMuZyx0KSxNYXRoLnBvdyh0aGlzLmIsdCksdGhpcy5hKX10b0xpbmVhcih0PTIuMil7cmV0dXJuIG5ldyBoKE1hdGgucG93KHRoaXMucix0KSxNYXRoLnBvdyh0aGlzLmcsdCksTWF0aC5wb3codGhpcy5iLHQpLHRoaXMuYSl9dG9HYW1tYSh0PTIuMil7cmV0dXJuIG5ldyBoKE1hdGgucG93KHRoaXMuciwxL3QpLE1hdGgucG93KHRoaXMuZywxL3QpLE1hdGgucG93KHRoaXMuYiwxL3QpLHRoaXMuYSl9bHVtaW5hbmNlKCl7cmV0dXJuLjIxMjYqdGhpcy5yKy43MTUyKnRoaXMuZysuMDcyMip0aGlzLmJ9bGVycCh0LGUpe2NvbnN0IHM9dGhpcy5yLGE9dGhpcy5nLGk9dGhpcy5iLHI9dGhpcy5hO3JldHVybiBuZXcgaChzK2UqKHQuci1zKSxhK2UqKHQuZy1hKSxpK2UqKHQuYi1pKSxyK2UqKHQuYS1yKSl9c3RhdGljIHJhbmRvbSh0PTAsZT0hMSl7cmV0dXJuIHQ+MD9uZXcgaCh0K01hdGgucmFuZG9tKCkqKDEtdCksdCtNYXRoLnJhbmRvbSgpKigxLXQpLHQrTWF0aC5yYW5kb20oKSooMS10KSxlP3QrTWF0aC5yYW5kb20oKSooMS10KToxKTp0PDA/bmV3IGgoTWF0aC5yYW5kb20oKSooMSt0KSxNYXRoLnJhbmRvbSgpKigxK3QpLE1hdGgucmFuZG9tKCkqKDErdCksZT9NYXRoLnJhbmRvbSgpKigxK3QpOjEpOm5ldyBoKE1hdGgucmFuZG9tKCksTWF0aC5yYW5kb20oKSxNYXRoLnJhbmRvbSgpLGU/TWF0aC5yYW5kb20oKToxKX1jbG9uZSgpe3JldHVybiBuZXcgaCh0aGlzLl9fZGF0YVswXSx0aGlzLl9fZGF0YVsxXSx0aGlzLl9fZGF0YVsyXSx0aGlzLl9fZGF0YVszXSl9YXNBcnJheSgpe3JldHVybiB0aGlzLl9fZGF0YX1hczNDb21wb25lbnRBcnJheSgpe3JldHVyblt0aGlzLl9fZGF0YVswXSx0aGlzLl9fZGF0YVsxXSx0aGlzLl9fZGF0YVsyXV19c3RhdGljIGNyZWF0ZSguLi50KXtyZXR1cm4gbmV3IGgoLi4udCl9c3RhdGljIGNyZWF0ZUZyb21GbG9hdDMyQnVmZmVyKHQsZT0wKXtyZXR1cm4gbmV3IGgodCw0KmUpfXN0YXRpYyBudW1FbGVtZW50cygpe3JldHVybiA0fXRvSlNPTigpe3JldHVybntyOnRoaXMucixnOnRoaXMuZyxiOnRoaXMuYixhOnRoaXMuYX19ZnJvbUpTT04odCl7dGhpcy5yPXQucix0aGlzLmc9dC5nLHRoaXMuYj10LmIsdGhpcy5hPXQuYX10b0NTU1N0cmluZygpe3JldHVybiJyZ2JhKCIrTWF0aC5yb3VuZCgyNTUqdGhpcy5yKSsiLCAiK01hdGgucm91bmQoMjU1KnRoaXMuZykrIiwgIitNYXRoLnJvdW5kKDI1NSp0aGlzLmIpKyIsICIrdGhpcy5hKyIpIn19YS5yZWdpc3RlclR5cGUoIlJHQkEiLGgpO2NsYXNzIG8gZXh0ZW5kcyBze2NvbnN0cnVjdG9yKHQ9MCxlPTAscz0wLGE9MSl7aWYoc3VwZXIoKSx0IGluc3RhbmNlb2YgRmxvYXQzMkFycmF5KXRoaXMuX19kYXRhPXQ7ZWxzZSBpZih0IGluc3RhbmNlb2YgQXJyYXlCdWZmZXIpe2NvbnN0IHM9dCxhPWU7dGhpcy5fX2RhdGE9bmV3IEZsb2F0MzJBcnJheShzLGEsNCl9ZWxzZSB0aGlzLl9fZGF0YT1uZXcgRmxvYXQzMkFycmF5KDQpLCJzdHJpbmciPT10eXBlb2YgdD90LnN0YXJ0c1dpdGgoIiMiKT90aGlzLnNldEZyb21IZXgodCk6dGhpcy5zZXRGcm9tQ1NTQ29sb3JOYW1lKHQpOih0aGlzLl9fZGF0YVswXT10LHRoaXMuX19kYXRhWzFdPWUsdGhpcy5fX2RhdGFbMl09cyx0aGlzLl9fZGF0YVszXT1hKX1nZXQgcigpe3JldHVybiB0aGlzLl9fZGF0YVswXX1zZXQgcih0KXt0aGlzLl9fZGF0YVswXT10fWdldCBnKCl7cmV0dXJuIHRoaXMuX19kYXRhWzFdfXNldCBnKHQpe3RoaXMuX19kYXRhWzFdPXR9Z2V0IGIoKXtyZXR1cm4gdGhpcy5fX2RhdGFbMl19c2V0IGIodCl7dGhpcy5fX2RhdGFbMl09dH1nZXQgYSgpe3JldHVybiB0aGlzLl9fZGF0YVszXX1zZXQgYSh0KXt0aGlzLl9fZGF0YVszXT10fXNldCh0LGUscyxhPTEpe3RoaXMucj10LHRoaXMuZz1lLHRoaXMuYj1zLHRoaXMuYT1hfXNldEZyb21PdGhlcih0KXt0aGlzLnI9dC5yLHRoaXMuZz10LmcsdGhpcy5iPXQuYix0aGlzLmE9dC5hfXNldEZyb21TY2FsYXJBcnJheSh0KXt0aGlzLnI9dFswXSx0aGlzLmc9dFsxXSx0aGlzLmI9dFsyXSx0aGlzLmE9ND09dC5sZW5ndGg/dFszXToxfWdldEFzUkdCQXJyYXkoKXtyZXR1cm5bMjU1KnRoaXMuciwyNTUqdGhpcy5nLDI1NSp0aGlzLmJdfWdldEFzUkdCRGljdCgpe3JldHVybntyOjI1NSp0aGlzLnIsZzoyNTUqdGhpcy5nLGI6MjU1KnRoaXMuYn19c2V0RnJvbVJHQih0LGUscyxhKXt0aGlzLnI9dC8yNTUsdGhpcy5nPWUvMjU1LHRoaXMuYj1zLzI1NSx0aGlzLmE9YT9hLzI1NToxfXNldEZyb21SR0JBcnJheSh0KXt0aGlzLnI9dFswXS8yNTUsdGhpcy5nPXRbMV0vMjU1LHRoaXMuYj10WzJdLzI1NSx0aGlzLmE9ND09dC5sZW5ndGg/dFszXS8yNTU6MX1zZXRGcm9tUkdCRGljdCh0KXt0aGlzLnI9dC5yLzI1NSx0aGlzLmc9dC5nLzI1NSx0aGlzLmI9dC5iLzI1NSx0aGlzLmE9ND09dC5hP3QuYS8yNTU6MX1zZXRGcm9tSGV4KHQpe2NvbnN0IGU9ZnVuY3Rpb24odCl7Y29uc3QgZT0vXiM/KFthLWZcZF17Mn0pKFthLWZcZF17Mn0pKFthLWZcZF17Mn0pJC9pLmV4ZWModCk7cmV0dXJuIGU/e3I6cGFyc2VJbnQoZVsxXSwxNiksZzpwYXJzZUludChlWzJdLDE2KSxiOnBhcnNlSW50KGVbM10sMTYpfTpudWxsfSh0KTtlP3RoaXMuc2V0RnJvbVJHQihlLnIsZS5nLGUuYik6Y29uc29sZS53YXJuKCJJbnZhbGlkIGhleCBjb2RlOiIrdCl9c2V0RnJvbUNTU0NvbG9yTmFtZSh0KXt0LnN0YXJ0c1dpdGgoIiMiKT90aGlzLnNldEZyb21IZXgodCk6dGhpcy5zZXRGcm9tSGV4KCh0PT57Y29uc3QgZT17YWxpY2VibHVlOiIjZjBmOGZmIixhbnRpcXVld2hpdGU6IiNmYWViZDciLGFxdWE6IiMwMGZmZmYiLGFxdWFtYXJpbmU6IiM3ZmZmZDQiLGF6dXJlOiIjZjBmZmZmIixiZWlnZToiI2Y1ZjVkYyIsYmlzcXVlOiIjZmZlNGM0IixibGFjazoiIzAwMDAwMCIsYmxhbmNoZWRhbG1vbmQ6IiNmZmViY2QiLGJsdWU6IiMwMDAwZmYiLGJsdWV2aW9sZXQ6IiM4YTJiZTIiLGJyb3duOiIjYTUyYTJhIixidXJseXdvb2Q6IiNkZWI4ODciLGNhZGV0Ymx1ZToiIzVmOWVhMCIsY2hhcnRyZXVzZToiIzdmZmYwMCIsY2hvY29sYXRlOiIjZDI2OTFlIixjb3JhbDoiI2ZmN2Y1MCIsY29ybmZsb3dlcmJsdWU6IiM2NDk1ZWQiLGNvcm5zaWxrOiIjZmZmOGRjIixjcmltc29uOiIjZGMxNDNjIixjeWFuOiIjMDBmZmZmIixkYXJrYmx1ZToiIzAwMDA4YiIsZGFya2N5YW46IiMwMDhiOGIiLGRhcmtnb2xkZW5yb2Q6IiNiODg2MGIiLGRhcmtncmF5OiIjYTlhOWE5IixkYXJrZ3JlZW46IiMwMDY0MDAiLGRhcmtraGFraToiI2JkYjc2YiIsZGFya21hZ2VudGE6IiM4YjAwOGIiLGRhcmtvbGl2ZWdyZWVuOiIjNTU2YjJmIixkYXJrb3JhbmdlOiIjZmY4YzAwIixkYXJrb3JjaGlkOiIjOTkzMmNjIixkYXJrcmVkOiIjOGIwMDAwIixkYXJrc2FsbW9uOiIjZTk5NjdhIixkYXJrc2VhZ3JlZW46IiM4ZmJjOGYiLGRhcmtzbGF0ZWJsdWU6IiM0ODNkOGIiLGRhcmtzbGF0ZWdyYXk6IiMyZjRmNGYiLGRhcmt0dXJxdW9pc2U6IiMwMGNlZDEiLGRhcmt2aW9sZXQ6IiM5NDAwZDMiLGRlZXBwaW5rOiIjZmYxNDkzIixkZWVwc2t5Ymx1ZToiIzAwYmZmZiIsZGltZ3JheToiIzY5Njk2OSIsZG9kZ2VyYmx1ZToiIzFlOTBmZiIsZmlyZWJyaWNrOiIjYjIyMjIyIixmbG9yYWx3aGl0ZToiI2ZmZmFmMCIsZm9yZXN0Z3JlZW46IiMyMjhiMjIiLGZ1Y2hzaWE6IiNmZjAwZmYiLGdhaW5zYm9ybzoiI2RjZGNkYyIsZ2hvc3R3aGl0ZToiI2Y4ZjhmZiIsZ29sZDoiI2ZmZDcwMCIsZ29sZGVucm9kOiIjZGFhNTIwIixncmF5OiIjODA4MDgwIixncmVlbjoiIzAwODAwMCIsZ3JlZW55ZWxsb3c6IiNhZGZmMmYiLGhvbmV5ZGV3OiIjZjBmZmYwIixob3RwaW5rOiIjZmY2OWI0IiwiaW5kaWFucmVkICI6IiNjZDVjNWMiLGluZGlnbzoiIzRiMDA4MiIsaXZvcnk6IiNmZmZmZjAiLGtoYWtpOiIjZjBlNjhjIixsYXZlbmRlcjoiI2U2ZTZmYSIsbGF2ZW5kZXJibHVzaDoiI2ZmZjBmNSIsbGF3bmdyZWVuOiIjN2NmYzAwIixsZW1vbmNoaWZmb246IiNmZmZhY2QiLGxpZ2h0Ymx1ZToiI2FkZDhlNiIsbGlnaHRjb3JhbDoiI2YwODA4MCIsbGlnaHRjeWFuOiIjZTBmZmZmIixsaWdodGdvbGRlbnJvZHllbGxvdzoiI2ZhZmFkMiIsbGlnaHRncmV5OiIjZDNkM2QzIixsaWdodGdyZWVuOiIjOTBlZTkwIixsaWdodHBpbms6IiNmZmI2YzEiLGxpZ2h0c2FsbW9uOiIjZmZhMDdhIixsaWdodHNlYWdyZWVuOiIjMjBiMmFhIixsaWdodHNreWJsdWU6IiM4N2NlZmEiLGxpZ2h0c2xhdGVncmF5OiIjNzc4ODk5IixsaWdodHN0ZWVsYmx1ZToiI2IwYzRkZSIsbGlnaHR5ZWxsb3c6IiNmZmZmZTAiLGxpbWU6IiMwMGZmMDAiLGxpbWVncmVlbjoiIzMyY2QzMiIsbGluZW46IiNmYWYwZTYiLG1hZ2VudGE6IiNmZjAwZmYiLG1hcm9vbjoiIzgwMDAwMCIsbWVkaXVtYXF1YW1hcmluZToiIzY2Y2RhYSIsbWVkaXVtYmx1ZToiIzAwMDBjZCIsbWVkaXVtb3JjaGlkOiIjYmE1NWQzIixtZWRpdW1wdXJwbGU6IiM5MzcwZDgiLG1lZGl1bXNlYWdyZWVuOiIjM2NiMzcxIixtZWRpdW1zbGF0ZWJsdWU6IiM3YjY4ZWUiLG1lZGl1bXNwcmluZ2dyZWVuOiIjMDBmYTlhIixtZWRpdW10dXJxdW9pc2U6IiM0OGQxY2MiLG1lZGl1bXZpb2xldHJlZDoiI2M3MTU4NSIsbWlkbmlnaHRibHVlOiIjMTkxOTcwIixtaW50Y3JlYW06IiNmNWZmZmEiLG1pc3R5cm9zZToiI2ZmZTRlMSIsbW9jY2FzaW46IiNmZmU0YjUiLG5hdmFqb3doaXRlOiIjZmZkZWFkIixuYXZ5OiIjMDAwMDgwIixvbGRsYWNlOiIjZmRmNWU2IixvbGl2ZToiIzgwODAwMCIsb2xpdmVkcmFiOiIjNmI4ZTIzIixvcmFuZ2U6IiNmZmE1MDAiLG9yYW5nZXJlZDoiI2ZmNDUwMCIsb3JjaGlkOiIjZGE3MGQ2IixwYWxlZ29sZGVucm9kOiIjZWVlOGFhIixwYWxlZ3JlZW46IiM5OGZiOTgiLHBhbGV0dXJxdW9pc2U6IiNhZmVlZWUiLHBhbGV2aW9sZXRyZWQ6IiNkODcwOTMiLHBhcGF5YXdoaXA6IiNmZmVmZDUiLHBlYWNocHVmZjoiI2ZmZGFiOSIscGVydToiI2NkODUzZiIscGluazoiI2ZmYzBjYiIscGx1bToiI2RkYTBkZCIscG93ZGVyYmx1ZToiI2IwZTBlNiIscHVycGxlOiIjODAwMDgwIixyZWJlY2NhcHVycGxlOiIjNjYzMzk5IixyZWQ6IiNmZjAwMDAiLHJvc3licm93bjoiI2JjOGY4ZiIscm95YWxibHVlOiIjNDE2OWUxIixzYWRkbGVicm93bjoiIzhiNDUxMyIsc2FsbW9uOiIjZmE4MDcyIixzYW5keWJyb3duOiIjZjRhNDYwIixzZWFncmVlbjoiIzJlOGI1NyIsc2Vhc2hlbGw6IiNmZmY1ZWUiLHNpZW5uYToiI2EwNTIyZCIsc2lsdmVyOiIjYzBjMGMwIixza3libHVlOiIjODdjZWViIixzbGF0ZWJsdWU6IiM2YTVhY2QiLHNsYXRlZ3JheToiIzcwODA5MCIsc25vdzoiI2ZmZmFmYSIsc3ByaW5nZ3JlZW46IiMwMGZmN2YiLHN0ZWVsYmx1ZToiIzQ2ODJiNCIsdGFuOiIjZDJiNDhjIix0ZWFsOiIjMDA4MDgwIix0aGlzdGxlOiIjZDhiZmQ4Iix0b21hdG86IiNmZjYzNDciLHR1cnF1b2lzZToiIzQwZTBkMCIsdmlvbGV0OiIjZWU4MmVlIix3aGVhdDoiI2Y1ZGViMyIsd2hpdGU6IiNmZmZmZmYiLHdoaXRlc21va2U6IiNmNWY1ZjUiLHllbGxvdzoiI2ZmZmYwMCIseWVsbG93Z3JlZW46IiM5YWNkMzIifTtyZXR1cm4gdm9pZCAwIT09ZVt0LnRvTG93ZXJDYXNlKCldJiZlW3QudG9Mb3dlckNhc2UoKV19KSh0KSl9dG9IZXgoKXtmdW5jdGlvbiB0KHQpe2NvbnN0IGU9TWF0aC5yb3VuZCgyNTUqdCkudG9TdHJpbmcoMTYpO3JldHVybiAxPT1lLmxlbmd0aD8iMCIrZTplfXJldHVybiIjIit0KHRoaXMucikrdCh0aGlzLmcpK3QodGhpcy5iKX1lcXVhbCh0KXtyZXR1cm4gdGhpcy5yPT10LnImJnRoaXMuZz09dC5nJiZ0aGlzLmI9PXQuYiYmdGhpcy5hPT10LmF9bm90ZXF1YWxzKHQpe3JldHVybiB0aGlzLnIhPXQuciYmdGhpcy5nIT10LmcmJnRoaXMuYiE9dC5iJiZ0aGlzLmEhPXQuYX1hcHByb3hFcXVhbCh0LGU9TnVtYmVyLkVQU0lMT04pe3JldHVybiBNYXRoLmFicyh0aGlzLnItdC5yKTxlJiZNYXRoLmFicyh0aGlzLmctdC5nKTxlJiZNYXRoLmFicyh0aGlzLmItdC5iKTxlJiZNYXRoLmFicyh0aGlzLmEtdC5hKTxlfWFkZCh0KXtyZXR1cm4gbmV3IG8odGhpcy5yK3Qucix0aGlzLmcrdC5nLHRoaXMuYit0LmIsdGhpcy5hK3QuYSl9c3VidHJhY3QodCl7cmV0dXJuIG5ldyBvKHRoaXMuci10LnIsdGhpcy5nLXQuZyx0aGlzLmItdC5iLHRoaXMuYS10LmEpfXNjYWxlKHQpe3JldHVybiBuZXcgbyh0aGlzLnIqdCx0aGlzLmcqdCx0aGlzLmIqdCx0aGlzLmEqdCl9c2NhbGVJblBsYWNlKHQpe3RoaXMucio9dCx0aGlzLmcqPXQsdGhpcy5iKj10LHRoaXMuYSo9dH1hcHBseUdhbW1hKHQpe3RoaXMuc2V0KE1hdGgucG93KHRoaXMucix0KSxNYXRoLnBvdyh0aGlzLmcsdCksTWF0aC5wb3codGhpcy5iLHQpLHRoaXMuYSl9dG9MaW5lYXIodD0yLjIpe3JldHVybiBuZXcgbyhNYXRoLnBvdyh0aGlzLnIsdCksTWF0aC5wb3codGhpcy5nLHQpLE1hdGgucG93KHRoaXMuYix0KSx0aGlzLmEpfXRvR2FtbWEodD0yLjIpe3JldHVybiBuZXcgbyhNYXRoLnBvdyh0aGlzLnIsMS90KSxNYXRoLnBvdyh0aGlzLmcsMS90KSxNYXRoLnBvdyh0aGlzLmIsMS90KSx0aGlzLmEpfWx1bWluYW5jZSgpe3JldHVybi4yMTI2KnRoaXMucisuNzE1Mip0aGlzLmcrLjA3MjIqdGhpcy5ifWxlcnAodCxlKXtjb25zdCBzPXRoaXMucixhPXRoaXMuZyxpPXRoaXMuYixyPXRoaXMuYTtyZXR1cm4gbmV3IG8ocytlKih0LnItcyksYStlKih0LmctYSksaStlKih0LmItaSkscitlKih0LmEtcikpfXN0YXRpYyByYW5kb20odD0wLGU9ITEpe3JldHVybiB0PjA/bmV3IG8odCtNYXRoLnJhbmRvbSgpKigxLXQpLHQrTWF0aC5yYW5kb20oKSooMS10KSx0K01hdGgucmFuZG9tKCkqKDEtdCksZT90K01hdGgucmFuZG9tKCkqKDEtdCk6MSk6dDwwP25ldyBvKE1hdGgucmFuZG9tKCkqKDErdCksTWF0aC5yYW5kb20oKSooMSt0KSxNYXRoLnJhbmRvbSgpKigxK3QpLGU/TWF0aC5yYW5kb20oKSooMSt0KToxKTpuZXcgbyhNYXRoLnJhbmRvbSgpLE1hdGgucmFuZG9tKCksTWF0aC5yYW5kb20oKSxlP01hdGgucmFuZG9tKCk6MSl9Y2xvbmUoKXtyZXR1cm4gbmV3IG8odGhpcy5fX2RhdGFbMF0sdGhpcy5fX2RhdGFbMV0sdGhpcy5fX2RhdGFbMl0sdGhpcy5fX2RhdGFbM10pfWFzQXJyYXkoKXtyZXR1cm4gdGhpcy5fX2RhdGF9YXMzQ29tcG9uZW50QXJyYXkoKXtyZXR1cm5bdGhpcy5fX2RhdGFbMF0sdGhpcy5fX2RhdGFbMV0sdGhpcy5fX2RhdGFbMl1dfXN0YXRpYyBjcmVhdGUoLi4udCl7cmV0dXJuIG5ldyBvKC4uLnQpfXN0YXRpYyBjcmVhdGVGcm9tRmxvYXQzMkJ1ZmZlcih0LGU9MCl7cmV0dXJuIG5ldyBvKHQsNCplKX1zdGF0aWMgbnVtRWxlbWVudHMoKXtyZXR1cm4gNH10b0pTT04oKXtyZXR1cm57cjp0aGlzLnIsZzp0aGlzLmcsYjp0aGlzLmIsYTp0aGlzLmF9fWZyb21KU09OKHQpe3RoaXMucj10LnIsdGhpcy5nPXQuZyx0aGlzLmI9dC5iLHRoaXMuYT10LmF9dG9DU1NTdHJpbmcoKXtyZXR1cm4icmdiYSgiK01hdGgucm91bmQoMjU1KnRoaXMucikrIiwgIitNYXRoLnJvdW5kKDI1NSp0aGlzLmcpKyIsICIrTWF0aC5yb3VuZCgyNTUqdGhpcy5iKSsiLCAiK3RoaXMuYSsiKSJ9fWEucmVnaXN0ZXJUeXBlKCJDb2xvciIsbyk7Y2xhc3MgXyBleHRlbmRzIHN7Y29uc3RydWN0b3IodD0wLGU9MCxzPTAsYT0wKXtpZihzdXBlcigpLGlzTmFOKGEpKXN3aXRjaChhKXtjYXNlIlhZWiI6dGhpcy5vcmRlcj0wO2JyZWFrO2Nhc2UiWVpYIjp0aGlzLm9yZGVyPTE7YnJlYWs7Y2FzZSJaWFkiOnRoaXMub3JkZXI9MjticmVhaztjYXNlIlhaWSI6dGhpcy5vcmRlcj0zO2JyZWFrO2Nhc2UiWllYIjp0aGlzLm9yZGVyPTQ7YnJlYWs7Y2FzZSJZWFoiOnRoaXMub3JkZXI9NTticmVhaztkZWZhdWx0OnRocm93IG5ldyBFcnJvcigiSW52YWxpZCBFdWxlciBBbmdsZXMgT3JkZXI6IithKX1lbHNlIHRoaXMub3JkZXI9YTtpZih0IGluc3RhbmNlb2YgQXJyYXlCdWZmZXIpe2NvbnN0IHM9dCxhPWU7dGhpcy5fX2RhdGE9bmV3IEZsb2F0MzJBcnJheShzLGEsNCl9ZWxzZSB0aGlzLl9fZGF0YT1uZXcgRmxvYXQzMkFycmF5KDMpLHRoaXMuX19kYXRhWzBdPXQsdGhpcy5fX2RhdGFbMV09ZSx0aGlzLl9fZGF0YVsyXT1zfWdldCB4KCl7cmV0dXJuIHRoaXMuX19kYXRhWzBdfXNldCB4KHQpe3RoaXMuX19kYXRhWzBdPXR9Z2V0IHkoKXtyZXR1cm4gdGhpcy5fX2RhdGFbMV19c2V0IHkodCl7dGhpcy5fX2RhdGFbMV09dH1nZXQgeigpe3JldHVybiB0aGlzLl9fZGF0YVsyXX1zZXQgeih0KXt0aGlzLl9fZGF0YVsyXT10fXNldCh0LGUscyl7dGhpcy5fX2RhdGFbMF09dCx0aGlzLl9fZGF0YVsxXT1lLHRoaXMuX19kYXRhWzJdPXN9fWEucmVnaXN0ZXJUeXBlKCJFdWxlckFuZ2xlcyIsXyk7Y2xhc3MgZCBleHRlbmRzIHN7Y29uc3RydWN0b3IodD0xLGU9MCxzPTAsYT0wLGk9MSxyPTAsbj0wLGg9MCxvPTEpe2lmKHN1cGVyKCksdCBpbnN0YW5jZW9mIEFycmF5QnVmZmVyKXtjb25zdCBzPXQsYT1lO3RoaXMuX19kYXRhPW5ldyBGbG9hdDMyQXJyYXkocyxhLDkpfWVsc2UgdGhpcy5fX2RhdGE9bmV3IEZsb2F0MzJBcnJheSg5KSx0aGlzLnNldCh0LGUscyxhLGkscixuLGgsbyl9Z2V0IG0wMCgpe3JldHVybiB0aGlzLl9fZGF0YVswXX1zZXQgbTAwKHQpe3RoaXMuX19kYXRhWzBdPXR9Z2V0IG0wMSgpe3JldHVybiB0aGlzLl9fZGF0YVsxXX1zZXQgbTAxKHQpe3RoaXMuX19kYXRhWzFdPXR9Z2V0IG0wMigpe3JldHVybiB0aGlzLl9fZGF0YVsyXX1zZXQgbTAyKHQpe3RoaXMuX19kYXRhWzJdPXR9Z2V0IG0xMCgpe3JldHVybiB0aGlzLl9fZGF0YVszXX1zZXQgbTEwKHQpe3RoaXMuX19kYXRhWzNdPXR9Z2V0IG0xMSgpe3JldHVybiB0aGlzLl9fZGF0YVs0XX1zZXQgbTExKHQpe3RoaXMuX19kYXRhWzRdPXR9Z2V0IG0xMigpe3JldHVybiB0aGlzLl9fZGF0YVs1XX1zZXQgbTEyKHQpe3RoaXMuX19kYXRhWzVdPXR9Z2V0IG0yMCgpe3JldHVybiB0aGlzLl9fZGF0YVs2XX1zZXQgbTIwKHQpe3RoaXMuX19kYXRhWzZdPXR9Z2V0IG0yMSgpe3JldHVybiB0aGlzLl9fZGF0YVs3XX1zZXQgbTIxKHQpe3RoaXMuX19kYXRhWzddPXR9Z2V0IG0yMigpe3JldHVybiB0aGlzLl9fZGF0YVs4XX1zZXQgbTIyKHQpe3RoaXMuX19kYXRhWzhdPXR9Z2V0IHhBeGlzKCl7cmV0dXJuIHIuY3JlYXRlRnJvbUZsb2F0MzJCdWZmZXIodGhpcy5fX2RhdGEuYnVmZmVyLDApfXNldCB4QXhpcyh0KXt0aGlzLnhBeGlzLnNldCh0LngsdC55LHQueil9Z2V0IHlBeGlzKCl7cmV0dXJuIHIuY3JlYXRlRnJvbUZsb2F0MzJCdWZmZXIodGhpcy5fX2RhdGEuYnVmZmVyLDMpfXNldCB5QXhpcyh0KXt0aGlzLnlBeGlzLnNldCh0LngsdC55LHQueil9Z2V0IHpBeGlzKCl7cmV0dXJuIHIuY3JlYXRlRnJvbUZsb2F0MzJCdWZmZXIodGhpcy5fX2RhdGEuYnVmZmVyLDYpfXNldCB6QXhpcyh0KXt0aGlzLnpBeGlzLnNldCh0LngsdC55LHQueil9c2V0KHQ9MSxlPTAscz0wLGE9MCxpPTEscj0wLG49MCxoPTAsbz0xKXt0aGlzLl9fZGF0YVswXT10LHRoaXMuX19kYXRhWzFdPWUsdGhpcy5fX2RhdGFbMl09cyx0aGlzLl9fZGF0YVszXT1hLHRoaXMuX19kYXRhWzRdPWksdGhpcy5fX2RhdGFbNV09cix0aGlzLl9fZGF0YVs2XT1uLHRoaXMuX19kYXRhWzddPWgsdGhpcy5fX2RhdGFbOF09b31zZXRJZGVudGl0eSgpe3RoaXMuc2V0KCl9c2V0RnJvbU1hdCh0KXt0aGlzLl9fZGF0YVswXT10Lm0wMCx0aGlzLl9fZGF0YVsxXT10Lm0wMSx0aGlzLl9fZGF0YVsyXT10Lm0wMix0aGlzLl9fZGF0YVszXT10Lm0xMCx0aGlzLl9fZGF0YVs0XT10Lm0xMSx0aGlzLl9fZGF0YVs1XT10Lm0xMix0aGlzLl9fZGF0YVs2XT10Lm0yMCx0aGlzLl9fZGF0YVs3XT10Lm0yMSx0aGlzLl9fZGF0YVs4XT10Lm0yMn1zZXRGcm9tRGlyZWN0aW9uQW5kVXB2ZWN0b3IodCxlKXtjb25zdCBzPXQsYT1zLmxlbmd0aCgpO2lmKGE8TnVtYmVyLkVQU0lMT04pcmV0dXJuIHZvaWQgdGhpcy5zZXRJZGVudGl0eSgpO3Muc2NhbGVJblBsYWNlKDEvYSk7Y29uc3QgaT1lLmNyb3NzKHMpLHI9aS5sZW5ndGgoKTtyPk51bWJlci5FUFNJTE9OJiZpLnNjYWxlSW5QbGFjZSgxL3IpO2NvbnN0IG49cy5jcm9zcyhpKSxoPW4ubGVuZ3RoKCk7aD5OdW1iZXIuRVBTSUxPTiYmbi5zY2FsZUluUGxhY2UoMS9oKSx0aGlzLnNldChpLngsaS55LGkueixuLngsbi55LG4ueixzLngscy55LHMueil9aW52ZXJzZSgpe2NvbnN0IHQ9dGhpcy5fX2RhdGFbMF0sZT10aGlzLl9fZGF0YVsxXSxzPXRoaXMuX19kYXRhWzJdLGE9dGhpcy5fX2RhdGFbM10saT10aGlzLl9fZGF0YVs0XSxyPXRoaXMuX19kYXRhWzVdLG49dGhpcy5fX2RhdGFbNl0saD10aGlzLl9fZGF0YVs3XSxvPXRoaXMuX19kYXRhWzhdLF89byppLXIqaCxsPS1vKmErcipuLGM9aCphLWkqbix1PXQqXytlKmwrcypjO3JldHVybiB1Pyh1PTEvdSxuZXcgZChfKnUsKC1vKmUrcypoKSp1LChyKmUtcyppKSp1LGwqdSwobyp0LXMqbikqdSwoLXIqdCtzKmEpKnUsYyp1LCgtaCp0K2UqbikqdSwoaSp0LWUqYSkqdSkpOihjb25zb2xlLndhcm4oIlVuYWJsZSB0byBpbnZlcnQgTWF0MyIpLG51bGwpfWludmVydEluUGxhY2UoKXtjb25zdCB0PXRoaXMuX19kYXRhWzBdLGU9dGhpcy5fX2RhdGFbMV0scz10aGlzLl9fZGF0YVsyXSxhPXRoaXMuX19kYXRhWzNdLGk9dGhpcy5fX2RhdGFbNF0scj10aGlzLl9fZGF0YVs1XSxuPXRoaXMuX19kYXRhWzZdLGg9dGhpcy5fX2RhdGFbN10sbz10aGlzLl9fZGF0YVs4XSxfPW8qaS1yKmgsZD0tbyphK3IqbixsPWgqYS1pKm4sYz10Kl8rZSpkK3MqbDtyZXR1cm4gYz8oYz0xL2MsdGhpcy5zZXQoXypjLCgtbyplK3MqaCkqYywociplLXMqaSkqYyxkKmMsKG8qdC1zKm4pKmMsKC1yKnQrcyphKSpjLGwqYywoLWgqdCtlKm4pKmMsKGkqdC1lKmEpKmMpLCEwKTooY29uc29sZS53YXJuKCJVbmFibGUgdG8gaW52ZXJ0IE1hdDMiKSwhMSl9dHJhbnNwb3NlKCl7cmV0dXJuIGQodGhpcy5fX2RhdGFbMF0sdGhpcy5fX2RhdGFbM10sdGhpcy5fX2RhdGFbNl0sdGhpcy5fX2RhdGFbMV0sdGhpcy5fX2RhdGFbNF0sdGhpcy5fX2RhdGFbN10sdGhpcy5fX2RhdGFbMl0sdGhpcy5fX2RhdGFbNV0sdGhpcy5fX2RhdGFbOF0pfXRyYW5zcG9zZUluUGxhY2UoKXtjb25zdCB0PXRoaXMuX19kYXRhWzFdLGU9dGhpcy5fX2RhdGFbMl0scz10aGlzLl9fZGF0YVs1XTt0aGlzLl9fZGF0YVsxXT10aGlzLl9fZGF0YVszXSx0aGlzLl9fZGF0YVsyXT10aGlzLl9fZGF0YVs2XSx0aGlzLl9fZGF0YVszXT10LHRoaXMuX19kYXRhWzVdPXRoaXMuX19kYXRhWzddLHRoaXMuX19kYXRhWzZdPWUsdGhpcy5fX2RhdGFbN109c310cmFuc2Zvcm1WZWMzKHQpe3JldHVybiBuZXcgcih0aGlzLl9fZGF0YVswXSp0LngrdGhpcy5fX2RhdGFbMV0qdC55K3RoaXMuX19kYXRhWzJdKnQueix0aGlzLl9fZGF0YVszXSp0LngrdGhpcy5fX2RhdGFbNF0qdC55K3RoaXMuX19kYXRhWzVdKnQueix0aGlzLl9fZGF0YVs2XSp0LngrdGhpcy5fX2RhdGFbN10qdC55K3RoaXMuX19kYXRhWzhdKnQueil9Y2xvbmUoKXtyZXR1cm4gbmV3IGQodGhpcy5fX2RhdGFbMF0sdGhpcy5fX2RhdGFbMV0sdGhpcy5fX2RhdGFbMl0sdGhpcy5fX2RhdGFbM10sdGhpcy5fX2RhdGFbNF0sdGhpcy5fX2RhdGFbNV0sdGhpcy5fX2RhdGFbNl0sdGhpcy5fX2RhdGFbN10sdGhpcy5fX2RhdGFbOF0sdGhpcy5fX2RhdGFbOV0pfXN0YXRpYyBjcmVhdGUoLi4udCl7cmV0dXJuIG5ldyBkKC4uLnQpfXN0YXRpYyBjcmVhdGVGcm9tRmxvYXQzMkJ1ZmZlcih0LGU9MCl7cmV0dXJuIG5ldyBkKHQsNCplKX10b0pTT04oKXtyZXR1cm4gdGhpcy5fX2RhdGF9ZnJvbUpTT04odCl7dGhpcy5fX2RhdGE9bmV3IEZsb2F0MzJBcnJheSh0KX10b1N0cmluZygpe3JldHVybiB0aGlzLnRvSlNPTigpLnRvU3RyaW5nKCl9fWEucmVnaXN0ZXJUeXBlKCJNYXQzIixkKTtjbGFzcyBsIGV4dGVuZHMgc3tjb25zdHJ1Y3Rvcih0PTEsZT0wLHM9MCxhPTAsaT0wLHI9MSxuPTAsaD0wLG89MCxfPTAsZD0xLGw9MCxjPTAsdT0wLGY9MCxtPTEpe2lmKHN1cGVyKCksdCBpbnN0YW5jZW9mIEZsb2F0MzJBcnJheSl0aGlzLl9fZGF0YT10O2Vsc2UgaWYodCBpbnN0YW5jZW9mIEFycmF5QnVmZmVyKXtjb25zdCBzPXQsYT1lO3RoaXMuX19kYXRhPW5ldyBGbG9hdDMyQXJyYXkocyxhLDE2KX1lbHNlIHRoaXMuX19kYXRhPW5ldyBGbG9hdDMyQXJyYXkoMTYpLHRoaXMuc2V0KHQsZSxzLGEsaSxyLG4saCxvLF8sZCxsLGMsdSxmLG0pfWdldCBtMDAoKXtyZXR1cm4gdGhpcy5fX2RhdGFbMF19c2V0IG0wMCh0KXt0aGlzLl9fZGF0YVswXT10fWdldCBtMDEoKXtyZXR1cm4gdGhpcy5fX2RhdGFbMV19c2V0IG0wMSh0KXt0aGlzLl9fZGF0YVsxXT10fWdldCBtMDIoKXtyZXR1cm4gdGhpcy5fX2RhdGFbMl19c2V0IG0wMih0KXt0aGlzLl9fZGF0YVsyXT10fWdldCBtMDMoKXtyZXR1cm4gdGhpcy5fX2RhdGFbM119c2V0IG0wMyh0KXt0aGlzLl9fZGF0YVszXT10fWdldCBtMTAoKXtyZXR1cm4gdGhpcy5fX2RhdGFbNF19c2V0IG0xMCh0KXt0aGlzLl9fZGF0YVs0XT10fWdldCBtMTEoKXtyZXR1cm4gdGhpcy5fX2RhdGFbNV19c2V0IG0xMSh0KXt0aGlzLl9fZGF0YVs1XT10fWdldCBtMTIoKXtyZXR1cm4gdGhpcy5fX2RhdGFbNl19c2V0IG0xMih0KXt0aGlzLl9fZGF0YVs2XT10fWdldCBtMTMoKXtyZXR1cm4gdGhpcy5fX2RhdGFbN119c2V0IG0xMyh0KXt0aGlzLl9fZGF0YVs3XT10fWdldCBtMjAoKXtyZXR1cm4gdGhpcy5fX2RhdGFbOF19c2V0IG0yMCh0KXt0aGlzLl9fZGF0YVs4XT10fWdldCBtMjEoKXtyZXR1cm4gdGhpcy5fX2RhdGFbOV19c2V0IG0yMSh0KXt0aGlzLl9fZGF0YVs5XT10fWdldCBtMjIoKXtyZXR1cm4gdGhpcy5fX2RhdGFbMTBdfXNldCBtMjIodCl7dGhpcy5fX2RhdGFbMTBdPXR9Z2V0IG0yMygpe3JldHVybiB0aGlzLl9fZGF0YVsxMV19c2V0IG0yMyh0KXt0aGlzLl9fZGF0YVsxMV09dH1nZXQgbTMwKCl7cmV0dXJuIHRoaXMuX19kYXRhWzEyXX1zZXQgbTMwKHQpe3RoaXMuX19kYXRhWzEyXT10fWdldCBtMzEoKXtyZXR1cm4gdGhpcy5fX2RhdGFbMTNdfXNldCBtMzEodCl7dGhpcy5fX2RhdGFbMTNdPXR9Z2V0IG0zMigpe3JldHVybiB0aGlzLl9fZGF0YVsxNF19c2V0IG0zMih0KXt0aGlzLl9fZGF0YVsxNF09dH1nZXQgbTMzKCl7cmV0dXJuIHRoaXMuX19kYXRhWzE1XX1zZXQgbTMzKHQpe3RoaXMuX19kYXRhWzE1XT10fWdldCB4QXhpcygpe3JldHVybiByLmNyZWF0ZUZyb21GbG9hdDMyQnVmZmVyKHRoaXMuX19kYXRhLmJ1ZmZlciwwKX1zZXQgeEF4aXModCl7dGhpcy54QXhpcy5zZXQodC54LHQueSx0LnopfWdldCB5QXhpcygpe3JldHVybiByLmNyZWF0ZUZyb21GbG9hdDMyQnVmZmVyKHRoaXMuX19kYXRhLmJ1ZmZlciw0KX1zZXQgeUF4aXModCl7dGhpcy55QXhpcy5zZXQodC54LHQueSx0LnopfWdldCB6QXhpcygpe3JldHVybiByLmNyZWF0ZUZyb21GbG9hdDMyQnVmZmVyKHRoaXMuX19kYXRhLmJ1ZmZlciw4KX1zZXQgekF4aXModCl7dGhpcy56QXhpcy5zZXQodC54LHQueSx0LnopfWdldCB0cmFuc2xhdGlvbigpe3JldHVybiByLmNyZWF0ZUZyb21GbG9hdDMyQnVmZmVyKHRoaXMuX19kYXRhLmJ1ZmZlciwxMil9c2V0IHRyYW5zbGF0aW9uKHQpe3RoaXMudHJhbnNsYXRpb24uc2V0KHQueCx0LnksdC56KX1zZXQodD0xLGU9MCxzPTAsYT0wLGk9MCxyPTEsbj0wLGg9MCxvPTAsXz0wLGQ9MSxsPTAsYz0wLHU9MCxmPTAsbT0xKXt0aGlzLl9fZGF0YVswXT10LHRoaXMuX19kYXRhWzFdPWUsdGhpcy5fX2RhdGFbMl09cyx0aGlzLl9fZGF0YVszXT1hLHRoaXMuX19kYXRhWzRdPWksdGhpcy5fX2RhdGFbNV09cix0aGlzLl9fZGF0YVs2XT1uLHRoaXMuX19kYXRhWzddPWgsdGhpcy5fX2RhdGFbOF09byx0aGlzLl9fZGF0YVs5XT1fLHRoaXMuX19kYXRhWzEwXT1kLHRoaXMuX19kYXRhWzExXT1sLHRoaXMuX19kYXRhWzEyXT1jLHRoaXMuX19kYXRhWzEzXT11LHRoaXMuX19kYXRhWzE0XT1mLHRoaXMuX19kYXRhWzE1XT1tfXNldElkZW50aXR5KCl7dGhpcy5zZXQoKX1zZXREYXRhQXJyYXkodCl7dGhpcy5fX2RhdGE9dH1zZXRGcm9tTWF0NCh0KXt0aGlzLl9fZGF0YVswXT10Lm0wMCx0aGlzLl9fZGF0YVsxXT10Lm0wMSx0aGlzLl9fZGF0YVsyXT10Lm0wMix0aGlzLl9fZGF0YVszXT10Lm0wMyx0aGlzLl9fZGF0YVs0XT10Lm0xMCx0aGlzLl9fZGF0YVs1XT10Lm0xMSx0aGlzLl9fZGF0YVs2XT10Lm0xMix0aGlzLl9fZGF0YVs3XT10Lm0xMyx0aGlzLl9fZGF0YVs4XT10Lm0yMCx0aGlzLl9fZGF0YVs5XT10Lm0yMSx0aGlzLl9fZGF0YVsxMF09dC5tMjIsdGhpcy5fX2RhdGFbMTFdPXQubTIzLHRoaXMuX19kYXRhWzEyXT10Lm0zMCx0aGlzLl9fZGF0YVsxM109dC5tMzEsdGhpcy5fX2RhdGFbMTRdPXQubTMyLHRoaXMuX19kYXRhWzE1XT10Lm0zM310b01hdDModCl7cmV0dXJuIG5ldyBkKHRoaXMuX19kYXRhWzBdLHRoaXMuX19kYXRhWzFdLHRoaXMuX19kYXRhWzJdLHRoaXMuX19kYXRhWzRdLHRoaXMuX19kYXRhWzVdLHRoaXMuX19kYXRhWzZdLHRoaXMuX19kYXRhWzhdLHRoaXMuX19kYXRhWzldLHRoaXMuX19kYXRhWzEwXSl9dHJhbnNwb3NlSW5QbGFjZSgpe2NvbnN0IHQ9dGhpcy5fX2RhdGFbMV0sZT10aGlzLl9fZGF0YVsyXSxzPXRoaXMuX19kYXRhWzNdLGE9dGhpcy5fX2RhdGFbNl0saT10aGlzLl9fZGF0YVs3XSxyPXRoaXMuX19kYXRhWzExXTt0aGlzLl9fZGF0YVsxXT10aGlzLl9fZGF0YVs0XSx0aGlzLl9fZGF0YVsyXT10aGlzLl9fZGF0YVs4XSx0aGlzLl9fZGF0YVszXT10aGlzLl9fZGF0YVsxMl0sdGhpcy5fX2RhdGFbNF09dCx0aGlzLl9fZGF0YVs2XT10aGlzLl9fZGF0YVs5XSx0aGlzLl9fZGF0YVs3XT10aGlzLl9fZGF0YVsxM10sdGhpcy5fX2RhdGFbOF09ZSx0aGlzLl9fZGF0YVs5XT1hLHRoaXMuX19kYXRhWzExXT10aGlzLl9fZGF0YVsxNF0sdGhpcy5fX2RhdGFbMTJdPXMsdGhpcy5fX2RhdGFbMTNdPWksdGhpcy5fX2RhdGFbMTRdPXJ9dHJhbnNwb3NlKCl7cmV0dXJuIG5ldyBsKHRoaXMuX19kYXRhWzBdLHRoaXMuX19kYXRhWzRdLHRoaXMuX19kYXRhWzhdLHRoaXMuX19kYXRhWzEyXSx0aGlzLl9fZGF0YVsxXSx0aGlzLl9fZGF0YVs1XSx0aGlzLl9fZGF0YVs5XSx0aGlzLl9fZGF0YVsxM10sdGhpcy5fX2RhdGFbMl0sdGhpcy5fX2RhdGFbNl0sdGhpcy5fX2RhdGFbMTBdLHRoaXMuX19kYXRhWzE0XSx0aGlzLl9fZGF0YVszXSx0aGlzLl9fZGF0YVs3XSx0aGlzLl9fZGF0YVsxMV0sdGhpcy5fX2RhdGFbMTVdKX1pbnZlcnNlKCl7Y29uc3QgdD10aGlzLl9fZGF0YVswXSxlPXRoaXMuX19kYXRhWzFdLHM9dGhpcy5fX2RhdGFbMl0sYT10aGlzLl9fZGF0YVszXSxpPXRoaXMuX19kYXRhWzRdLHI9dGhpcy5fX2RhdGFbNV0sbj10aGlzLl9fZGF0YVs2XSxoPXRoaXMuX19kYXRhWzddLG89dGhpcy5fX2RhdGFbOF0sXz10aGlzLl9fZGF0YVs5XSxkPXRoaXMuX19kYXRhWzEwXSxjPXRoaXMuX19kYXRhWzExXSx1PXRoaXMuX19kYXRhWzEyXSxmPXRoaXMuX19kYXRhWzEzXSxtPXRoaXMuX19kYXRhWzE0XSxnPXRoaXMuX19kYXRhWzE1XSx5PXQqci1lKmkscD10Km4tcyppLGI9dCpoLWEqaSx4PWUqbi1zKnIsdz1lKmgtYSpyLEk9cypoLWEqbixOPW8qZi1fKnUsRj1vKm0tZCp1LHo9bypnLWMqdSxWPV8qbS1kKmYsTT1fKmctYypmLEE9ZCpnLWMqbTtsZXQgUz15KkEtcCpNK2IqVit4KnotdypGK0kqTjtyZXR1cm4gUz8oUz0xL1MsbmV3IGwoKHIqQS1uKk0raCpWKSpTLChzKk0tZSpBLWEqVikqUywoZipJLW0qdytnKngpKlMsKGQqdy1fKkktYyp4KSpTLChuKnotaSpBLWgqRikqUywodCpBLXMqeithKkYpKlMsKG0qYi11KkktZypwKSpTLChvKkktZCpiK2MqcCkqUywoaSpNLXIqeitoKk4pKlMsKGUqei10Kk0tYSpOKSpTLCh1KnctZipiK2cqeSkqUywoXypiLW8qdy1jKnkpKlMsKHIqRi1pKlYtbipOKSpTLCh0KlYtZSpGK3MqTikqUywoZipwLXUqeC1tKnkpKlMsKG8qeC1fKnArZCp5KSpTKSk6KGNvbnNvbGUud2FybigiVW5hYmxlIHRvIGludmVydCBNYXQ0IiksbnVsbCl9aW52ZXJ0SW5QbGFjZSgpe2NvbnN0IHQ9dGhpcy5fX2RhdGFbMF0sZT10aGlzLl9fZGF0YVsxXSxzPXRoaXMuX19kYXRhWzJdLGE9dGhpcy5fX2RhdGFbM10saT10aGlzLl9fZGF0YVs0XSxyPXRoaXMuX19kYXRhWzVdLG49dGhpcy5fX2RhdGFbNl0saD10aGlzLl9fZGF0YVs3XSxvPXRoaXMuX19kYXRhWzhdLF89dGhpcy5fX2RhdGFbOV0sZD10aGlzLl9fZGF0YVsxMF0sbD10aGlzLl9fZGF0YVsxMV0sYz10aGlzLl9fZGF0YVsxMl0sdT10aGlzLl9fZGF0YVsxM10sZj10aGlzLl9fZGF0YVsxNF0sbT10aGlzLl9fZGF0YVsxNV0sZz10KnItZSppLHk9dCpuLXMqaSxwPXQqaC1hKmksYj1lKm4tcypyLHg9ZSpoLWEqcix3PXMqaC1hKm4sST1vKnUtXypjLE49bypmLWQqYyxGPW8qbS1sKmMsej1fKmYtZCp1LFY9XyptLWwqdSxNPWQqbS1sKmY7bGV0IEE9ZypNLXkqVitwKnorYipGLXgqTit3Kkk7cmV0dXJuIEE/KEE9MS9BLHRoaXMuc2V0KChyKk0tbipWK2gqeikqQSwocypWLWUqTS1hKnopKkEsKHUqdy1mKngrbSpiKSpBLChkKngtXyp3LWwqYikqQSwobipGLWkqTS1oKk4pKkEsKHQqTS1zKkYrYSpOKSpBLChmKnAtYyp3LW0qeSkqQSwobyp3LWQqcCtsKnkpKkEsKGkqVi1yKkYraCpJKSpBLChlKkYtdCpWLWEqSSkqQSwoYyp4LXUqcCttKmcpKkEsKF8qcC1vKngtbCpnKSpBLChyKk4taSp6LW4qSSkqQSwodCp6LWUqTitzKkkpKkEsKHUqeS1jKmItZipnKSpBLChvKmItXyp5K2QqZykqQSksITApOihjb25zb2xlLndhcm4oIlVuYWJsZSB0byBpbnZlcnQgTWF0NCIpLCExKX1zZXRJbnZlcnNlKHQpe2NvbnN0IGU9dC5fX2RhdGFbMF0scz10Ll9fZGF0YVsxXSxhPXQuX19kYXRhWzJdLGk9dC5fX2RhdGFbM10scj10Ll9fZGF0YVs0XSxuPXQuX19kYXRhWzVdLGg9dC5fX2RhdGFbNl0sbz10Ll9fZGF0YVs3XSxfPXQuX19kYXRhWzhdLGQ9dC5fX2RhdGFbOV0sbD10Ll9fZGF0YVsxMF0sYz10Ll9fZGF0YVsxMV0sdT10Ll9fZGF0YVsxMl0sZj10Ll9fZGF0YVsxM10sbT10Ll9fZGF0YVsxNF0sZz10Ll9fZGF0YVsxNV0seT1lKm4tcypyLHA9ZSpoLWEqcixiPWUqby1pKnIseD1zKmgtYSpuLHc9cypvLWkqbixJPWEqby1pKmgsTj1fKmYtZCp1LEY9XyptLWwqdSx6PV8qZy1jKnUsVj1kKm0tbCpmLE09ZCpnLWMqZixBPWwqZy1jKm07bGV0IFM9eSpBLXAqTStiKlYreCp6LXcqRitJKk47aWYoIVMpdGhyb3cgbmV3IEVycm9yKCJVbmFibGUgdG8gaW52ZXJ0IE1hdDQiKTtTPTEvUyx0aGlzLnNldCgobipBLWgqTStvKlYpKlMsKGEqTS1zKkEtaSpWKSpTLChmKkktbSp3K2cqeCkqUywobCp3LWQqSS1jKngpKlMsKGgqei1yKkEtbypGKSpTLChlKkEtYSp6K2kqRikqUywobSpiLXUqSS1nKnApKlMsKF8qSS1sKmIrYypwKSpTLChyKk0tbip6K28qTikqUywocyp6LWUqTS1pKk4pKlMsKHUqdy1mKmIrZyp5KSpTLChkKmItXyp3LWMqeSkqUywobipGLXIqVi1oKk4pKlMsKGUqVi1zKkYrYSpOKSpTLChmKnAtdSp4LW0qeSkqUywoXyp4LWQqcCtsKnkpKlMpfW11bHRpcGx5KHQpe2NvbnN0IGU9dGhpcy5fX2RhdGFbMF0scz10aGlzLl9fZGF0YVsxXSxhPXRoaXMuX19kYXRhWzJdLGk9dGhpcy5fX2RhdGFbM10scj10aGlzLl9fZGF0YVs0XSxuPXRoaXMuX19kYXRhWzVdLGg9dGhpcy5fX2RhdGFbNl0sbz10aGlzLl9fZGF0YVs3XSxfPXRoaXMuX19kYXRhWzhdLGQ9dGhpcy5fX2RhdGFbOV0sYz10aGlzLl9fZGF0YVsxMF0sdT10aGlzLl9fZGF0YVsxMV0sZj10aGlzLl9fZGF0YVsxMl0sbT10aGlzLl9fZGF0YVsxM10sZz10aGlzLl9fZGF0YVsxNF0seT10aGlzLl9fZGF0YVsxNV0scD10LmFzQXJyYXkoKTtsZXQgYj1wWzBdLHg9cFsxXSx3PXBbMl0sST1wWzNdO2NvbnN0IE49bmV3IGw7cmV0dXJuIE4ubTAwPWIqZSt4KnIrdypfK0kqZixOLm0wMT1iKnMreCpuK3cqZCtJKm0sTi5tMDI9YiphK3gqaCt3KmMrSSpnLE4ubTAzPWIqaSt4Km8rdyp1K0kqeSxiPXBbNF0seD1wWzVdLHc9cFs2XSxJPXBbN10sTi5tMTA9YiplK3gqcit3Kl8rSSpmLE4ubTExPWIqcyt4Km4rdypkK0kqbSxOLm0xMj1iKmEreCpoK3cqYytJKmcsTi5tMTM9YippK3gqbyt3KnUrSSp5LGI9cFs4XSx4PXBbOV0sdz1wWzEwXSxJPXBbMTFdLE4ubTIwPWIqZSt4KnIrdypfK0kqZixOLm0yMT1iKnMreCpuK3cqZCtJKm0sTi5tMjI9YiphK3gqaCt3KmMrSSpnLE4ubTIzPWIqaSt4Km8rdyp1K0kqeSxiPXBbMTJdLHg9cFsxM10sdz1wWzE0XSxJPXBbMTVdLE4ubTMwPWIqZSt4KnIrdypfK0kqZixOLm0zMT1iKnMreCpuK3cqZCtJKm0sTi5tMzI9YiphK3gqaCt3KmMrSSpnLE4ubTMzPWIqaSt4Km8rdyp1K0kqeSxOfW11bHRpcGx5SW5QbGFjZSh0KXtjb25zdCBlPXRoaXMuYXNBcnJheSgpLHM9ZVswXSxhPWVbMV0saT1lWzJdLHI9ZVszXSxuPWVbNF0saD1lWzVdLG89ZVs2XSxfPWVbN10sZD1lWzhdLGw9ZVs5XSxjPWVbMTBdLHU9ZVsxMV0sZj1lWzEyXSxtPWVbMTNdLGc9ZVsxNF0seT1lWzE1XSxwPXQuYXNBcnJheSgpO2xldCBiPXBbMF0seD1wWzFdLHc9cFsyXSxJPXBbM107cmV0dXJuIHRoaXMubTAwPWIqcyt4Km4rdypkK0kqZix0aGlzLm0wMT1iKmEreCpoK3cqbCtJKm0sdGhpcy5tMDI9YippK3gqbyt3KmMrSSpnLHRoaXMubTAzPWIqcit4Kl8rdyp1K0kqeSxiPXBbNF0seD1wWzVdLHc9cFs2XSxJPXBbN10sdGhpcy5tMTA9YipzK3gqbit3KmQrSSpmLHRoaXMubTExPWIqYSt4KmgrdypsK0kqbSx0aGlzLm0xMj1iKmkreCpvK3cqYytJKmcsdGhpcy5tMTM9YipyK3gqXyt3KnUrSSp5LGI9cFs4XSx4PXBbOV0sdz1wWzEwXSxJPXBbMTFdLHRoaXMubTIwPWIqcyt4Km4rdypkK0kqZix0aGlzLm0yMT1iKmEreCpoK3cqbCtJKm0sdGhpcy5tMjI9YippK3gqbyt3KmMrSSpnLHRoaXMubTIzPWIqcit4Kl8rdyp1K0kqeSxiPXBbMTJdLHg9cFsxM10sdz1wWzE0XSxJPXBbMTVdLHRoaXMubTMwPWIqcyt4Km4rdypkK0kqZix0aGlzLm0zMT1iKmEreCpoK3cqbCtJKm0sdGhpcy5tMzI9YippK3gqbyt3KmMrSSpnLHRoaXMubTMzPWIqcit4Kl8rdyp1K0kqeSx0aGlzfXBvc3RtdWx0aXBseUluUGxhY2UodCl7Y29uc3QgZT10LmFzQXJyYXkoKSxzPWVbMF0sYT1lWzFdLGk9ZVsyXSxyPWVbM10sbj1lWzRdLGg9ZVs1XSxvPWVbNl0sXz1lWzddLGQ9ZVs4XSxsPWVbOV0sYz1lWzEwXSx1PWVbMTFdLGY9ZVsxMl0sbT1lWzEzXSxnPWVbMTRdLHk9ZVsxNV0scD10aGlzLmFzQXJyYXkoKTtsZXQgYj1wWzBdLHg9cFsxXSx3PXBbMl0sST1wWzNdO3JldHVybiB0aGlzLm0wMD1iKnMreCpuK3cqZCtJKmYsdGhpcy5tMDE9YiphK3gqaCt3KmwrSSptLHRoaXMubTAyPWIqaSt4Km8rdypjK0kqZyx0aGlzLm0wMz1iKnIreCpfK3cqdStJKnksYj1wWzRdLHg9cFs1XSx3PXBbNl0sST1wWzddLHRoaXMubTEwPWIqcyt4Km4rdypkK0kqZix0aGlzLm0xMT1iKmEreCpoK3cqbCtJKm0sdGhpcy5tMTI9YippK3gqbyt3KmMrSSpnLHRoaXMubTEzPWIqcit4Kl8rdyp1K0kqeSxiPXBbOF0seD1wWzldLHc9cFsxMF0sST1wWzExXSx0aGlzLm0yMD1iKnMreCpuK3cqZCtJKmYsdGhpcy5tMjE9YiphK3gqaCt3KmwrSSptLHRoaXMubTIyPWIqaSt4Km8rdypjK0kqZyx0aGlzLm0yMz1iKnIreCpfK3cqdStJKnksYj1wWzEyXSx4PXBbMTNdLHc9cFsxNF0sST1wWzE1XSx0aGlzLm0zMD1iKnMreCpuK3cqZCtJKmYsdGhpcy5tMzE9YiphK3gqaCt3KmwrSSptLHRoaXMubTMyPWIqaSt4Km8rdypjK0kqZyx0aGlzLm0zMz1iKnIreCpfK3cqdStJKnksdGhpc310cmFuc2xhdGVJblBsYWNlKHQpe2NvbnN0IGU9dGhpcy5fX2RhdGEscz10LngsYT10LnksaT10Lno7cmV0dXJuIGVbMTJdPWVbMF0qcytlWzRdKmErZVs4XSppK2VbMTJdLGVbMTNdPWVbMV0qcytlWzVdKmErZVs5XSppK2VbMTNdLGVbMTRdPWVbMl0qcytlWzZdKmErZVsxMF0qaStlWzE0XSxlWzE1XT1lWzNdKnMrZVs3XSphK2VbMTFdKmkrZVsxNV0sdGhpc31zZXRMb29rQXQodCxlLHMpe2NvbnN0IGE9dC5zdWJ0cmFjdChlKSxpPWEubGVuZ3RoKCk7aWYoaTxOdW1iZXIuRVBTSUxPTilyZXR1cm4gdm9pZCB0aGlzLnNldElkZW50aXR5KCk7YS5zY2FsZUluUGxhY2UoMS9pKTtjb25zdCByPXMuY3Jvc3MoYSksbj1yLmxlbmd0aCgpO24+TnVtYmVyLkVQU0lMT04mJnIuc2NhbGVJblBsYWNlKDEvbik7Y29uc3QgaD1hLmNyb3NzKHIpLG89aC5sZW5ndGgoKTtvPk51bWJlci5FUFNJTE9OJiZoLnNjYWxlSW5QbGFjZSgxL28pLHRoaXMuc2V0KHIueCxyLnksci56LDAsaC54LGgueSxoLnosMCxhLngsYS55LGEueiwwLHQueCx0LnksdC56LDEpfXNldFJvdGF0aW9uKHQsZSl7Y29uc3Qgcz10Lmxlbmd0aCgpO2lmKE1hdGguYWJzKHMpPE51bWJlci5FUFNJTE9OKXJldHVybiBudWxsO2NvbnN0IGE9dC54L3MsaT10LnkvcyxyPXQuei9zLG49TWF0aC5zaW4oZSksaD1NYXRoLmNvcyhlKSxvPTEtaCxfPXRoaXMuX19kYXRhO3JldHVybiBfWzBdPWEqYSpvK2gsX1sxXT1pKmEqbytyKm4sX1syXT1yKmEqby1pKm4sX1szXT0wLF9bNF09YSppKm8tcipuLF9bNV09aSppKm8raCxfWzZdPXIqaSpvK2EqbixfWzddPTAsX1s4XT1hKnIqbytpKm4sX1s5XT1pKnIqby1hKm4sX1sxMF09cipyKm8raCxfWzExXT0wLF9bMTJdPTAsX1sxM109MCxfWzE0XT0wLF9bMTVdPTEsdGhpc31zZXRYUm90YXRpb24odCl7Y29uc3QgZT1NYXRoLnNpbih0KSxzPU1hdGguY29zKHQpLGE9dGhpcy5fX2RhdGE7cmV0dXJuIGFbMF09MSxhWzFdPTAsYVsyXT0wLGFbM109MCxhWzRdPTAsYVs1XT1zLGFbNl09ZSxhWzddPTAsYVs4XT0wLGFbOV09LWUsYVsxMF09cyxhWzExXT0wLGFbMTJdPTAsYVsxM109MCxhWzE0XT0wLGFbMTVdPTEsdGhpc31zZXRZUm90YXRpb24odCl7Y29uc3QgZT1NYXRoLnNpbih0KSxzPU1hdGguY29zKHQpLGE9dGhpcy5fX2RhdGE7cmV0dXJuIGFbMF09cyxhWzFdPTAsYVsyXT0tZSxhWzNdPTAsYVs0XT0wLGFbNV09MSxhWzZdPTAsYVs3XT0wLGFbOF09ZSxhWzldPTAsYVsxMF09cyxhWzExXT0wLGFbMTJdPTAsYVsxM109MCxhWzE0XT0wLGFbMTVdPTEsdGhpc31zZXRaUm90YXRpb24odCl7Y29uc3QgZT1NYXRoLnNpbih0KSxzPU1hdGguY29zKHQpLGE9dGhpcy5fX2RhdGE7cmV0dXJuIGFbMF09cyxhWzFdPWUsYVsyXT0wLGFbM109MCxhWzRdPS1lLGFbNV09cyxhWzZdPTAsYVs3XT0wLGFbOF09MCxhWzldPTAsYVsxMF09MSxhWzExXT0wLGFbMTJdPTAsYVsxM109MCxhWzE0XT0wLGFbMTVdPTEsdGhpc310cmFuc2Zvcm1WZWM0KHQpe2NvbnN0IGU9dGhpcy5fX2RhdGEscz10LngsYT10LnksaT10Lnoscj10LnQ7cmV0dXJuIG5ldyBWZWM0KGVbMF0qcytlWzRdKmErZVs4XSppK2VbMTJdKnIsZVsxXSpzK2VbNV0qYStlWzldKmkrZVsxM10qcixlWzJdKnMrZVs2XSphK2VbMTBdKmkrZVsxNF0qcixlWzNdKnMrZVs3XSphK2VbMTFdKmkrZVsxNV0qcil9dHJhbnNmb3JtVmVjMyh0KXtjb25zdCBlPXRoaXMuX19kYXRhLHM9dC54LGE9dC55LGk9dC56O3JldHVybiBuZXcgcihlWzBdKnMrZVs0XSphK2VbOF0qaStlWzEyXSxlWzFdKnMrZVs1XSphK2VbOV0qaStlWzEzXSxlWzJdKnMrZVs2XSphK2VbMTBdKmkrZVsxNF0pfXJvdGF0ZVZlYzModCl7Y29uc3QgZT10aGlzLl9fZGF0YSxzPXQueCxhPXQueSxpPXQuejtyZXR1cm4gbmV3IHIoZVswXSpzK2VbNF0qYStlWzhdKmksZVsxXSpzK2VbNV0qYStlWzldKmksZVsyXSpzK2VbNl0qYStlWzEwXSppKX1zZXRQZXJzcGVjdGl2ZU1hdHJpeCh0LGUscyxhKXtjb25zdCBpPU1hdGgudGFuKC41Kk1hdGguUEktLjUqdCkscj0xLyhzLWEpO3RoaXMuc2V0KGkvZSwwLDAsMCwwLGksMCwwLDAsMCwocythKSpyLC0xLDAsMCxzKmEqcioyLDApfXNldE9ydGhvZ3JhcGhpY01hdHJpeCh0LGUscyxhLGkscil7Y29uc3Qgbj0xLyh0LWUpLGg9MS8ocy1hKSxvPTEvKGktcik7dGhpcy5zZXQoLTIqbiwwLDAsMCwwLC0yKmgsMCwwLDAsMCwyKm8sMCwodCtlKSpuLChhK3MpKmgsKHIraSkqbywxKX1zZXRTY2FsZSh0LGUscyl7dCBpbnN0YW5jZW9mIHI/dGhpcy5zZXQodC54LDAsMCwwLDAsdC55LDAsMCwwLDAsdC56LDAsMCwwLDAsMSk6dGhpcy5zZXQodCwwLDAsMCwwLGUsMCwwLDAsMCxzLDAsMCwwLDAsMSl9c2V0RnJvbU1hdDN4NEFycmF5KHQpe3RoaXMuc2V0KHRbMF0sdFsxXSx0WzJdLDAsdFszXSx0WzRdLHRbNV0sMCx0WzZdLHRbN10sdFs4XSwwLHRbOV0sdFsxMF0sdFsxMV0sMSl9c3RhdGljIGNyZWF0ZUZyb21GbG9hdDMyQnVmZmVyKHQsZT0wKXtyZXR1cm4gbmV3IGwodCw0KmUpfWNsb25lKCl7cmV0dXJuIG5ldyBsKHRoaXMuX19kYXRhWzBdLHRoaXMuX19kYXRhWzFdLHRoaXMuX19kYXRhWzJdLHRoaXMuX19kYXRhWzNdLHRoaXMuX19kYXRhWzRdLHRoaXMuX19kYXRhWzVdLHRoaXMuX19kYXRhWzZdLHRoaXMuX19kYXRhWzddLHRoaXMuX19kYXRhWzhdLHRoaXMuX19kYXRhWzldLHRoaXMuX19kYXRhWzEwXSx0aGlzLl9fZGF0YVsxMV0sdGhpcy5fX2RhdGFbMTJdLHRoaXMuX19kYXRhWzEzXSx0aGlzLl9fZGF0YVsxNF0sdGhpcy5fX2RhdGFbMTVdKX1zdGF0aWMgY3JlYXRlKC4uLnQpe3JldHVybiBuZXcgbCguLi50KX10b0pTT04oKXtyZXR1cm4gdGhpcy5fX2RhdGF9ZnJvbUpTT04odCl7dGhpcy5fX2RhdGE9bmV3IEZsb2F0MzJBcnJheSh0KX19YS5yZWdpc3RlclR5cGUoIk1hdDQiLGwpO2NsYXNzIHUgZXh0ZW5kcyBze2NvbnN0cnVjdG9yKHQ9MCxlPTAscz0wLGE9MSl7aWYoc3VwZXIoKSx0IGluc3RhbmNlb2YgQXJyYXlCdWZmZXIpe2NvbnN0IHM9dCxhPWU7dGhpcy5fX2RhdGE9bmV3IEZsb2F0MzJBcnJheShzLGEsNCl9ZWxzZSBpZih0aGlzLl9fZGF0YT1uZXcgRmxvYXQzMkFycmF5KDQpLCJvYmplY3QiPT10eXBlb2YgdCl7dGhpcy5fX2RhdGFbMF09MCx0aGlzLl9fZGF0YVsxXT0wLHRoaXMuX19kYXRhWzJdPTAsdGhpcy5fX2RhdGFbM109MTtmb3IoY29uc3QgZSBpbiB0KUFycmF5LmlzQXJyYXkodFtlXSk/dGhpc1tlXS5jYWxsKHRoaXMsLi4udFtlXSk6dGhpc1tlXS5jYWxsKHRoaXMsdFtlXSl9ZWxzZSB0aGlzLl9fZGF0YVswXT10LHRoaXMuX19kYXRhWzFdPWUsdGhpcy5fX2RhdGFbMl09cyx0aGlzLl9fZGF0YVszXT1hfWdldCB4KCl7cmV0dXJuIHRoaXMuX19kYXRhWzBdfXNldCB4KHQpe3RoaXMuX19kYXRhWzBdPXR9Z2V0IHkoKXtyZXR1cm4gdGhpcy5fX2RhdGFbMV19c2V0IHkodCl7dGhpcy5fX2RhdGFbMV09dH1nZXQgeigpe3JldHVybiB0aGlzLl9fZGF0YVsyXX1zZXQgeih0KXt0aGlzLl9fZGF0YVsyXT10fWdldCB3KCl7cmV0dXJuIHRoaXMuX19kYXRhWzNdfXNldCB3KHQpe3RoaXMuX19kYXRhWzNdPXR9c2V0KHQsZSxzLGEpe3RoaXMuX19kYXRhWzBdPXQsdGhpcy5fX2RhdGFbMV09ZSx0aGlzLl9fZGF0YVsyXT1zLHRoaXMuX19kYXRhWzNdPWF9c2V0RGF0YUFycmF5KHQpe3RoaXMuX19kYXRhPXR9c2V0RnJvbU90aGVyKHQpe3RoaXMuX19kYXRhWzBdPXQueCx0aGlzLl9fZGF0YVsxXT10LnksdGhpcy5fX2RhdGFbMl09dC56LHRoaXMuX19kYXRhWzNdPXQud31zZXRGcm9tRXVsZXJBbmdsZXModCl7Y29uc3QgZT1uZXcgcjtzd2l0Y2godC5vcmRlcil7Y2FzZSAwOmUuc2V0KHQueCwtdC55LHQueik7YnJlYWs7Y2FzZSAxOmUuc2V0KHQueSwtdC56LHQueCk7YnJlYWs7Y2FzZSAyOmUuc2V0KHQueiwtdC54LHQueSk7YnJlYWs7Y2FzZSAzOmUuc2V0KHQueCx0LnosdC55KTticmVhaztjYXNlIDQ6ZS5zZXQodC56LHQueSx0LngpO2JyZWFrO2Nhc2UgNTplLnNldCh0LnksdC54LHQueik7YnJlYWs7ZGVmYXVsdDp0aHJvdyBuZXcgRXJyb3IoInNkcnR5Iil9Y29uc3Qgcz0uNSplLngsYT0uNSplLnksaT0uNSplLnosbj1NYXRoLmNvcyhzKSxoPU1hdGguY29zKGEpLG89TWF0aC5jb3MoaSksXz1NYXRoLnNpbihzKSxkPU1hdGguc2luKGEpLGw9TWF0aC5zaW4oaSksYz1uKm8sdT1uKmwsZj1fKm8sbT1fKmwsZz1oKmYtZCp1LHk9aCptK2QqYyxwPWgqdS1kKmY7c3dpdGNoKHRoaXMudz1oKmMrZCptLHQub3JkZXIpe2Nhc2UgMDp0aGlzLng9Zyx0aGlzLnk9LXksdGhpcy56PXA7YnJlYWs7Y2FzZSAxOnRoaXMueD1wLHRoaXMueT1nLHRoaXMuej0teTticmVhaztjYXNlIDI6dGhpcy54PS15LHRoaXMueT1wLHRoaXMuej1nO2JyZWFrO2Nhc2UgMzp0aGlzLng9Zyx0aGlzLnk9cCx0aGlzLno9eTticmVhaztjYXNlIDQ6dGhpcy54PXAsdGhpcy55PXksdGhpcy56PWc7YnJlYWs7Y2FzZSA1OnRoaXMueD15LHRoaXMueT1nLHRoaXMuej1wO2JyZWFrO2RlZmF1bHQ6dGhyb3cgbmV3IEVycm9yKCJzZHJ0eSIpfX10b0V1bGVyQW5nbGVzKHQpe2NvbnN0IGU9bmV3IHI7c3dpdGNoKHQpe2Nhc2UgMDplLnNldCh0aGlzLnosdGhpcy54LHRoaXMueSk7YnJlYWs7Y2FzZSAxOmUuc2V0KHRoaXMueCx0aGlzLnksdGhpcy56KTticmVhaztjYXNlIDI6ZS5zZXQodGhpcy55LHRoaXMueix0aGlzLngpO2JyZWFrO2Nhc2UgMzplLnNldCh0aGlzLnksLXRoaXMueCx0aGlzLnopO2JyZWFrO2Nhc2UgNDplLnNldCh0aGlzLngsLXRoaXMueix0aGlzLnkpO2JyZWFrO2Nhc2UgNTplLnNldCh0aGlzLnosLXRoaXMueSx0aGlzLngpO2JyZWFrO2RlZmF1bHQ6dGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIHJvdGF0aW9uIG9yZGVyOiIrdCl9Y29uc3Qgcz1uZXcgcixhPWUueCplLnkrZS56KnRoaXMudztpZihhPi40OTk5OSlzLnk9MipNYXRoLmF0YW4yKGUueCx0aGlzLncpLHMuej0uNSpNYXRoLlBJLHMueD0wO2Vsc2UgaWYoYTwtLjQ5OTk5KXMueT0tMipNYXRoLmF0YW4yKGUueCx0aGlzLncpLHMuej0tLjUqTWF0aC5QSSxzLng9MDtlbHNle2NvbnN0IHQ9ZS54KmUueCxpPWUueSplLnkscj1lLnoqZS56O3MueT1NYXRoLmF0YW4yKDIqZS55KnRoaXMudy0yKmUueCplLnosMS0yKmktMipyKSxzLno9TWF0aC5hc2luKDIqYSkscy54PU1hdGguYXRhbjIoMiplLngqdGhpcy53LTIqZS55KmUueiwxLTIqdC0yKnIpfXN3aXRjaCh0KXtjYXNlIDA6cmV0dXJuIG5ldyBfKHMueSxzLnoscy54LHQpO2Nhc2UgMTpyZXR1cm4gbmV3IF8ocy54LHMueSxzLnosdCk7Y2FzZSAyOnJldHVybiBuZXcgXyhzLnoscy54LHMueSx0KTtjYXNlIDM6cmV0dXJuIG5ldyBfKC1zLnkscy54LHMueix0KTtjYXNlIDQ6cmV0dXJuIG5ldyBfKHMueCxzLnosLXMueSx0KTtjYXNlIDU6cmV0dXJuIG5ldyBfKHMueiwtcy55LHMueCx0KX19c2V0RnJvbUF4aXNBbmRBbmdsZSh0LGUpe2NvbnN0IHM9ZS8yLGE9dC5ub3JtYWxpemUoKS5zY2FsZShNYXRoLnNpbihzKSk7dGhpcy5zZXQoYS54LGEueSxhLnosTWF0aC5jb3MocykpfXNldEZyb21EaXJlY3Rpb25BbmRVcHZlY3Rvcih0LGUpe2NvbnN0IHM9bmV3IGQ7cy5zZXRGcm9tRGlyZWN0aW9uQW5kVXB2ZWN0b3IodCxlKSx0aGlzLnNldEZyb21NYXQzKHMpfXNldEZyb20yVmVjdG9ycyh0LGUpe3Qubm9ybWFsaXplKCksZS5ub3JtYWxpemUoKTtjb25zdCBzPXQuY3Jvc3MoZSksYT10LmRvdChlKSxpPU1hdGguc3FydCgyKigxK2EpKTt0aGlzLnNldChzLngvaSxzLnkvaSxzLnovaSxpLzIpLHRoaXMubm9ybWFsaXplSW5QbGFjZSgpfXNldEZyb21NYXQzKHQpe2NvbnN0IGU9dC5fX2RhdGFbMF0rdC5fX2RhdGFbNF0rdC5fX2RhdGFbOF07bGV0IHM7aWYoZT4wKXM9TWF0aC5zcXJ0KGUrMSksdGhpcy5fX2RhdGFbM109LjUqcyxzPS41L3MsdGhpcy5fX2RhdGFbMF09KHQuX19kYXRhWzVdLXQuX19kYXRhWzddKSpzLHRoaXMuX19kYXRhWzFdPSh0Ll9fZGF0YVs2XS10Ll9fZGF0YVsyXSkqcyx0aGlzLl9fZGF0YVsyXT0odC5fX2RhdGFbMV0tdC5fX2RhdGFbM10pKnM7ZWxzZXtsZXQgZT0wO3QuX19kYXRhWzRdPnQuX19kYXRhWzBdJiYoZT0xKSx0Ll9fZGF0YVs4XT50Ll9fZGF0YVszKmUrZV0mJihlPTIpO2NvbnN0IGE9KGUrMSklMyxpPShlKzIpJTM7cz1NYXRoLnNxcnQodC5fX2RhdGFbMyplK2VdLXQuX19kYXRhWzMqYSthXS10Ll9fZGF0YVszKmkraV0rMSksdGhpcy5fX2RhdGFbZV09LjUqcyxzPS41L3MsdGhpcy5fX2RhdGFbM109KHQuX19kYXRhWzMqYStpXS10Ll9fZGF0YVszKmkrYV0pKnMsdGhpcy5fX2RhdGFbYV09KHQuX19kYXRhWzMqYStlXSt0Ll9fZGF0YVszKmUrYV0pKnMsdGhpcy5fX2RhdGFbaV09KHQuX19kYXRhWzMqaStlXSt0Ll9fZGF0YVszKmUraV0pKnN9dGhpcy5ub3JtYWxpemVJblBsYWNlKCl9c2V0RnJvbU1hdDQodCl7Y29uc3QgZT10Ll9fZGF0YVswXSt0Ll9fZGF0YVs1XSt0Ll9fZGF0YVsxMF07bGV0IHM7aWYoZT4wKXM9TWF0aC5zcXJ0KGUrMSksdGhpcy5fX2RhdGFbM109LjUqcyxzPS41L3MsdGhpcy5fX2RhdGFbMF09KHQuX19kYXRhWzZdLXQuX19kYXRhWzldKSpzLHRoaXMuX19kYXRhWzFdPSh0Ll9fZGF0YVs4XS10Ll9fZGF0YVsyXSkqcyx0aGlzLl9fZGF0YVsyXT0odC5fX2RhdGFbMV0tdC5fX2RhdGFbNF0pKnM7ZWxzZXtsZXQgZT0wO3QuX19kYXRhWzVdPnQuX19kYXRhWzBdJiYoZT0xKSx0Ll9fZGF0YVsxMF0+dC5fX2RhdGFbNCplK2VdJiYoZT0yKTtjb25zdCBhPShlKzEpJTMsaT0oZSsyKSUzO3M9TWF0aC5zcXJ0KHQuX19kYXRhWzQqZStlXS10Ll9fZGF0YVs0KmErYV0tdC5fX2RhdGFbNCppK2ldKzEpLHRoaXMuX19kYXRhW2VdPS41KnMscz0uNS9zLHRoaXMuX19kYXRhWzNdPSh0Ll9fZGF0YVs0KmEraV0tdC5fX2RhdGFbNCppK2FdKSpzLHRoaXMuX19kYXRhW2FdPSh0Ll9fZGF0YVs0KmErZV0rdC5fX2RhdGFbNCplK2FdKSpzLHRoaXMuX19kYXRhW2ldPSh0Ll9fZGF0YVs0KmkrZV0rdC5fX2RhdGFbNCplK2ldKSpzfXRoaXMubm9ybWFsaXplSW5QbGFjZSgpfWlzSWRlbnRpdHkoKXtyZXR1cm4gdGhpcy5nZXRBbmdsZSgpPE51bWJlci5FUFNJTE9OfWdldEFuZ2xlKCl7cmV0dXJuIDIqTWF0aC5hY29zKHRoaXMudyl9ZXF1YWwodCl7cmV0dXJuIHRoaXMueD09dC54JiZ0aGlzLnk9PXQueSYmdGhpcy56PT10LnomJnRoaXMudz09dC53fW5vdGVxdWFscyh0KXtyZXR1cm4gdGhpcy54IT10LngmJnRoaXMueSE9dC55JiZ0aGlzLnohPXQueiYmdGhpcy53IT10Lnd9YXBwcm94RXF1YWwodCxlPU51bWJlci5FUFNJTE9OKXtyZXR1cm4gTWF0aC5hYnModGhpcy54LXQueCk8ZSYmTWF0aC5hYnModGhpcy55LXQueSk8ZSYmTWF0aC5hYnModGhpcy56LXQueik8ZSYmTWF0aC5hYnModGhpcy53LXQudyk8ZX1hZGQodCl7cmV0dXJuIG5ldyB1KHRoaXMueCt0LngsdGhpcy55K3QueSx0aGlzLnordC56LHRoaXMudyt0LncpfWFkZEluUGxhY2UodCl7dGhpcy54Kz10LngsdGhpcy55Kz10LnksdGhpcy56Kz10LnosdGhpcy53Kz10Lnd9c3VidHJhY3QodCl7cmV0dXJuIG5ldyB1KHRoaXMueC10LngsdGhpcy55LXQueSx0aGlzLnotdC56LHRoaXMudy10LncpfXNjYWxlKHQpe3JldHVybiBuZXcgdSh0aGlzLngqdCx0aGlzLnkqdCx0aGlzLnoqdCx0aGlzLncqdCl9c2NhbGVJblBsYWNlKHQpe3RoaXMueCo9dCx0aGlzLnkqPXQsdGhpcy56Kj10LHRoaXMudyo9dH1sZW5ndGgoKXtjb25zdCB0PXRoaXMuX19kYXRhWzBdLGU9dGhpcy5fX2RhdGFbMV0scz10aGlzLl9fZGF0YVsyXSxhPXRoaXMuX19kYXRhWzNdO3JldHVybiBNYXRoLnNxcnQodCp0K2UqZStzKnMrYSphKX1sZW5ndGhTcXVhcmVkKCl7Y29uc3QgdD10aGlzLl9fZGF0YVswXSxlPXRoaXMuX19kYXRhWzFdLHM9dGhpcy5fX2RhdGFbMl0sYT10aGlzLl9fZGF0YVszXTtyZXR1cm4gdCp0K2UqZStzKnMrYSphfW5vcm1hbGl6ZSgpe2NvbnN0IHQ9dGhpcy5fX2RhdGFbMF0sZT10aGlzLl9fZGF0YVsxXSxzPXRoaXMuX19kYXRhWzJdLGE9dGhpcy5fX2RhdGFbM107bGV0IGk9dCp0K2UqZStzKnMrYSphO3JldHVybiBpPE51bWJlci5FUFNJTE9OP25ldyB1OihpPTEvTWF0aC5zcXJ0KGkpLG5ldyB1KHQqaSxlKmkscyppKSl9bm9ybWFsaXplSW5QbGFjZSgpe2NvbnN0IHQ9dGhpcy5fX2RhdGFbMF0sZT10aGlzLl9fZGF0YVsxXSxzPXRoaXMuX19kYXRhWzJdLGE9dGhpcy5fX2RhdGFbM107bGV0IGk9dCp0K2UqZStzKnMrYSphO2k8TnVtYmVyLkVQU0lMT058fChpPTEvTWF0aC5zcXJ0KGkpLHRoaXMuc2V0KHQqaSxlKmkscyppLGEqaSkpfWRvdCh0KXtyZXR1cm4gdGhpcy54KnQueCt0aGlzLnkqdC55K3RoaXMueip0LnordGhpcy53KnQud31jcm9zcyh0KXtjb25zdCBlPXRoaXMueCxzPXRoaXMueSxhPXRoaXMueixpPXRoaXMudyxyPXQueCxuPXQueSxoPXQueixvPXQudztyZXR1cm4gbmV3IHUocypoLWEqbixhKm8taSpoLGkqci1lKm8sZSpuLXMqcil9Y29uanVnYXRlKCl7cmV0dXJuIG5ldyB1KC10aGlzLngsLXRoaXMueSwtdGhpcy56LHRoaXMudyl9aW52ZXJzZSgpe3JldHVybiB0aGlzLmNvbmp1Z2F0ZSgpfWFsaWduV2l0aCh0KXt0aGlzLmRvdCh0KTwwJiZ0aGlzLnNldCgtdGhpcy54LC10aGlzLnksLXRoaXMueiwtdGhpcy53KX1tdWx0aXBseSh0KXtjb25zdCBlPXRoaXMuX19kYXRhWzBdLHM9dGhpcy5fX2RhdGFbMV0sYT10aGlzLl9fZGF0YVsyXSxpPXRoaXMuX19kYXRhWzNdLHI9dC5fX2RhdGFbMF0sbj10Ll9fZGF0YVsxXSxoPXQuX19kYXRhWzJdLG89dC5fX2RhdGFbM107cmV0dXJuIG5ldyB1KGUqbytpKnIrcypoLWEqbixzKm8raSpuK2Eqci1lKmgsYSpvK2kqaCtlKm4tcypyLGkqby1lKnItcypuLWEqaCl9bXVsdGlwbHlJblBsYWNlKHQpe2NvbnN0IGU9dGhpcy5fX2RhdGFbMF0scz10aGlzLl9fZGF0YVsxXSxhPXRoaXMuX19kYXRhWzJdLGk9dGhpcy5fX2RhdGFbM10scj10Ll9fZGF0YVswXSxuPXQuX19kYXRhWzFdLGg9dC5fX2RhdGFbMl0sbz10Ll9fZGF0YVszXTt0aGlzLnNldChlKm8raSpyK3MqaC1hKm4scypvK2kqbithKnItZSpoLGEqbytpKmgrZSpuLXMqcixpKm8tZSpyLXMqbi1hKmgpfXJvdGF0ZVZlYzModCl7Y29uc3QgZT1uZXcgdSh0LngsdC55LHQueiwwKSxzPXRoaXMubXVsdGlwbHkoZSkubXVsdGlwbHkodGhpcy5jb25qdWdhdGUoKSk7cmV0dXJuIG5ldyByKHMueCxzLnkscy56KX1yb3RhdGVYKHQpe3QqPS41O2NvbnN0IGU9dGhpcy54LHM9dGhpcy55LGE9dGhpcy56LGk9dGhpcy53LHI9TWF0aC5zaW4odCksbj1NYXRoLmNvcyh0KTt0aGlzLng9ZSpuK2kqcix0aGlzLnk9cypuK2Eqcix0aGlzLno9YSpuLXMqcix0aGlzLnc9aSpuLWUqcn1yb3RhdGVZKHQpe3QqPS41O2NvbnN0IGU9dGhpcy54LHM9dGhpcy55LGE9dGhpcy56LGk9dGhpcy53LHI9TWF0aC5zaW4odCksbj1NYXRoLmNvcyh0KTt0aGlzLng9ZSpuLWEqcix0aGlzLnk9cypuK2kqcix0aGlzLno9YSpuK2Uqcix0aGlzLnc9aSpuLXMqcn1yb3RhdGVaKHQpe3QqPS41O2NvbnN0IGU9dGhpcy54LHM9dGhpcy55LGE9dGhpcy56LGk9dGhpcy53LHI9TWF0aC5zaW4odCksbj1NYXRoLmNvcyh0KTt0aGlzLng9ZSpuK3Mqcix0aGlzLnk9cypuLWUqcix0aGlzLno9YSpuK2kqcix0aGlzLnc9aSpuLWEqcn10b01hdDMoKXtjb25zdCB0PXRoaXMueCxlPXRoaXMueSxzPXRoaXMueixhPXRoaXMudyxpPXQrdCxyPWUrZSxuPXMrcyxoPXQqaSxvPWUqaSxfPWUqcixsPXMqaSxjPXMqcix1PXMqbixmPWEqaSxtPWEqcixnPWEqbix5PW5ldyBkO3JldHVybiB5Ll9fZGF0YVswXT0xLV8tdSx5Ll9fZGF0YVszXT1vLWcseS5fX2RhdGFbNl09bCttLHkuX19kYXRhWzFdPW8rZyx5Ll9fZGF0YVs0XT0xLWgtdSx5Ll9fZGF0YVs3XT1jLWYseS5fX2RhdGFbMl09bC1tLHkuX19kYXRhWzVdPWMrZix5Ll9fZGF0YVs4XT0xLWgtXyx5fWdldFhheGlzKCl7Y29uc3QgdD10aGlzLngqdGhpcy55LGU9dGhpcy54KnRoaXMueixzPXRoaXMueSp0aGlzLnksYT10aGlzLnkqdGhpcy53LGk9dGhpcy56KnRoaXMueixuPXRoaXMueip0aGlzLnc7cmV0dXJuIG5ldyByKDEtMiooaStzKSwyKih0K24pLDIqKGUtYSkpfWdldFlheGlzKCl7Y29uc3QgdD10aGlzLngqdGhpcy54LGU9dGhpcy54KnRoaXMueSxzPXRoaXMueCp0aGlzLncsYT10aGlzLnkqdGhpcy56LGk9dGhpcy56KnRoaXMueixuPXRoaXMueip0aGlzLnc7cmV0dXJuIG5ldyByKDIqKGUtbiksMS0yKihpK3QpLDIqKGErcykpfWdldFpheGlzKCl7Y29uc3QgdD10aGlzLngqdGhpcy54LGU9dGhpcy54KnRoaXMueixzPXRoaXMueCp0aGlzLncsYT10aGlzLnkqdGhpcy55LGk9dGhpcy55KnRoaXMueixuPXRoaXMueSp0aGlzLnc7bmV3IHI7cmV0dXJuIG5ldyByKDIqKG4rZSksMiooaS1zKSwxLTIqKGErdCkpfW1pcnJvcih0KXtzd2l0Y2godCl7Y2FzZSAwOnJldHVybiBuZXcgdSh0aGlzLnosdGhpcy53LHRoaXMueCx0aGlzLnkpO2Nhc2UgMTpyZXR1cm4gbmV3IHUoLXRoaXMudyx0aGlzLnosdGhpcy55LC10aGlzLngpO2Nhc2UgMjpyZXR1cm4gbmV3IHUodGhpcy54LHRoaXMueSx0aGlzLnosLXRoaXMudyl9fXRvTWF0NCgpe2NvbnN0IHQ9dGhpcy54LGU9dGhpcy55LHM9dGhpcy56LGE9dGhpcy53LGk9dCt0LHI9ZStlLG49cytzLGg9dCppLG89ZSppLF89ZSpyLGQ9cyppLGM9cypyLHU9cypuLGY9YSppLG09YSpyLGc9YSpuLHk9bmV3IGw7cmV0dXJuIHkuX19kYXRhWzBdPTEtXy11LHkuX19kYXRhWzRdPW8tZyx5Ll9fZGF0YVs4XT1kK20seS5fX2RhdGFbMV09bytnLHkuX19kYXRhWzVdPTEtaC11LHkuX19kYXRhWzldPWMtZix5Ll9fZGF0YVsyXT1kLW0seS5fX2RhdGFbNl09YytmLHkuX19kYXRhWzEwXT0xLWgtXyx5fWxlcnAodCxlKXtjb25zdCBzPW5ldyB1KHRoaXMueCtlKih0LngtdGhpcy54KSx0aGlzLnkrZSoodC55LXRoaXMueSksdGhpcy56K2UqKHQuei10aGlzLnopLHRoaXMudytlKih0LnctdGhpcy53KSk7cmV0dXJuIHMubm9ybWFsaXplSW5QbGFjZSgpLHN9c3RhdGljIGNyZWF0ZSguLi50KXtyZXR1cm4gbmV3IHUoLi4udCl9c3RhdGljIGNyZWF0ZUZyb21GbG9hdDMyQnVmZmVyKHQsZT0wKXtyZXR1cm4gbmV3IHUodCw0KmUpfXN0YXRpYyBudW1FbGVtZW50cygpe3JldHVybiA0fWNsb25lKCl7cmV0dXJuIG5ldyB1KHRoaXMuX19kYXRhWzBdLHRoaXMuX19kYXRhWzFdLHRoaXMuX19kYXRhWzJdLHRoaXMuX19kYXRhWzNdKX10b0pTT04oKXtyZXR1cm57eDp0aGlzLngseTp0aGlzLnksejp0aGlzLnosdzp0aGlzLnd9fWZyb21KU09OKHQpe3RoaXMuX19kYXRhWzBdPXQueCx0aGlzLl9fZGF0YVsxXT10LnksdGhpcy5fX2RhdGFbMl09dC56LHRoaXMuX19kYXRhWzNdPXQudyx0aGlzLm5vcm1hbGl6ZUluUGxhY2UoKX19YS5yZWdpc3RlclR5cGUoIlF1YXQiLHUpO2NsYXNzIGZ7Y29uc3RydWN0b3IodCxlKXt0aGlzLnN0YXJ0PXQgaW5zdGFuY2VvZiByP3Q6bmV3IHIsdGhpcy5kaXI9ZSBpbnN0YW5jZW9mIHI/ZTpuZXcgcn1jbG9zZXN0UG9pbnQodCl7Y29uc3QgZT10LnN1YnRyYWN0KHRoaXMuc3RhcnQpLmRvdCh0aGlzLmRpcik7aWYoZTxOdW1iZXIuRVBTSUxPTilyZXR1cm4gdGhpcy5zdGFydDtjb25zdCBzPWUvdGhpcy5kaXIuZG90KHRoaXMuZGlyKTtyZXR1cm4gdGhpcy5zdGFydC5hZGQodGhpcy5kaXIuc2NhbGUocykpfXBvaW50QXREaXN0KHQpe3JldHVybiB0aGlzLnN0YXJ0LmFkZCh0aGlzLmRpci5zY2FsZSh0KSl9aW50ZXJzZWN0UmF5VmVjdG9yKHQpe2NvbnN0IGU9dGhpcy5kaXIscz10LmRpcixhPXRoaXMuc3RhcnQuc3VidHJhY3QodC5zdGFydCksaT1lLmRvdChlKSxyPWUuZG90KHMpLG49cy5kb3QocyksaD1lLmRvdChhKSxvPXMuZG90KGEpO2lmKDA9PWkmJjA9PW4pcmV0dXJuIHRoaXMuc3RhcnQuZGlzdGFuY2VUbyh0LnN0YXJ0KTtpZigwPT1pKXJldHVybiB0LmNsb3Nlc3RQb2ludCh0aGlzLnN0YXJ0KTtpZigwPT1uKXJldHVybiB0aGlzLmNsb3Nlc3RQb2ludCh0LnN0YXJ0KTtjb25zdCBfPWkqbi1yKnI7bGV0IGQsbDtyZXR1cm4gXzwuMDAxPyhkPTAsbD1yPm4/aC9yOm8vbik6KGQ9KHIqby1uKmgpL18sbD0oaSpvLXIqaCkvXyksW2QsbF19aW50ZXJzZWN0UmF5UGxhbmUodCl7Y29uc3QgZT10aGlzLnN0YXJ0LnN1YnRyYWN0KHQuc3RhcnQpLHM9dC5kaXIuZG90KHRoaXMuZGlyKSxhPS10LmRpci5kb3QoZSk7aWYoTWF0aC5hYnMocyk8TnVtYmVyLlBSRUNJU0lPTilyZXR1cm4tMTtjb25zdCBpPWEvcztyZXR1cm4gaTwtTnVtYmVyLlBSRUNJU0lPTj8tMTppfWNsb25lKCl7cmV0dXJuIG5ldyBmKHRoaXMuc3RhcnQuY2xvbmUoKSx0aGlzLmRpci5jbG9uZSgpKX1zdGF0aWMgY3JlYXRlKC4uLnQpe3JldHVybiBuZXcgZiguLi50KX10b0pTT04oKXtyZXR1cm57c3RhcnQ6dGhpcy5zdGFydCxkaXI6dGhpcy5kaXJ9fWZyb21KU09OKHQpe3RoaXMuc3RhcnQuZnJvbUpTT04odC5zdGFydCksdGhpcy5kaXIuZnJvbUpTT04odC5kaXIpfXRvU3RyaW5nKCl7cmV0dXJuIGUodGhpcy50b0pTT04oKSl9fWEucmVnaXN0ZXJUeXBlKCJSYXkiLGYpO25ldyByKDEsMSwxKTtjbGFzcyBte2NvbnN0cnVjdG9yKHQsZSxzKXtpZih0IGluc3RhbmNlb2YgRmxvYXQzMkFycmF5KXRoaXMuc2V0RnJvbUZsb2F0MzJBcnJheSh0KTtlbHNle2lmKHQgaW5zdGFuY2VvZiByKXRoaXMudHI9dDtlbHNle2lmKHQgaW5zdGFuY2VvZiB1JiZudWxsPT1lJiZudWxsPT1zKXJldHVybiB0aGlzLnRyPW5ldyByLHRoaXMub3JpPXQsdm9pZCh0aGlzLnNjPW5ldyByKDEsMSwxKSk7dGhpcy50cj1uZXcgcn10aGlzLm9yaT1lIGluc3RhbmNlb2YgdT9lOm5ldyB1LHRoaXMuc2M9cyBpbnN0YW5jZW9mIHI/czpuZXcgcigxLDEsMSl9fXNldCh0LGUscyl7dGhpcy50cj10LHRoaXMub3JpPWUscyBpbnN0YW5jZW9mIHImJih0aGlzLnNjPXMpfXNldEZyb21PdGhlcih0KXt0aGlzLnRyPXQudHIsdGhpcy5vcmk9dC5vcmksdGhpcy5zYz10LnNjfWlzSWRlbnRpdHkoKXtyZXR1cm4gdGhpcy50ci5pc051bGwoKSYmdGhpcy5vcmkuaXNJZGVudGl0eSgpJiZ0aGlzLnNjLmlzMTExKCl9c2V0TG9va0F0KHQsZSxzKXtjb25zdCBhPXQuc3VidHJhY3QoZSk7aWYoYS5sZW5ndGgoKTxOdW1iZXIuRVBTSUxPTil0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgZGlyIik7dGhpcy5vcmkuc2V0RnJvbURpcmVjdGlvbkFuZFVwdmVjdG9yKGEscyksdGhpcy50cj10fW11bHRpcGx5KHQpe2xldCBlPXRoaXMuc2M7cmV0dXJuIHRoaXMuc2MueD09dGhpcy5zYy55JiZ0aGlzLnNjLng9PXRoaXMuc2Muenx8KGU9dC5vcmkucm90YXRlVmVjMyh0aGlzLnNjKSxNYXRoLnNpZ24oZS54KSE9TWF0aC5zaWduKHRoaXMuc2MueCkmJihlLng9LWUueCksTWF0aC5zaWduKGUueSkhPU1hdGguc2lnbih0aGlzLnNjLnkpJiYoZS55PS1lLnkpLE1hdGguc2lnbihlLnopIT1NYXRoLnNpZ24odGhpcy5zYy56KSYmKGUuej0tZS56KSksbmV3IG0odGhpcy50ci5hZGQodGhpcy5vcmkucm90YXRlVmVjMyhlLm11bHRpcGx5KHQudHIpKSksdGhpcy5vcmkubXVsdGlwbHkodC5vcmkpLGUubXVsdGlwbHkodC5zYykpfWludmVyc2UoKXtjb25zdCB0PW5ldyBtO3JldHVybiB0Lm9yaT10aGlzLm9yaS5pbnZlcnNlKCksdGhpcy5zYy54IT10aGlzLnNjLnl8fHRoaXMuc2MueCE9dGhpcy5zYy56Pyh0LnNjPXQub3JpLnJvdGF0ZVZlYzModGhpcy5zYyksTWF0aC5zaWduKHQuc2MueCkhPU1hdGguc2lnbih0aGlzLnNjLngpJiYodC5zYy54PS10LnNjLngpLE1hdGguc2lnbih0LnNjLnkpIT1NYXRoLnNpZ24odGhpcy5zYy55KSYmKHQuc2MueT0tdC5zYy55KSxNYXRoLnNpZ24odC5zYy56KSE9TWF0aC5zaWduKHRoaXMuc2MueikmJih0LnNjLno9LXQuc2MueikpOnQuc2M9dGhpcy5zYy5pbnZlcnNlKCksdC50cj10Lm9yaS5yb3RhdGVWZWMzKHRoaXMudHIubmVnYXRlKCkubXVsdGlwbHkodC5zYykpLHR9dHJhbnNmb3JtVmVjMyh0KXtyZXR1cm4gdGhpcy50ci5hZGQodGhpcy5vcmkucm90YXRlVmVjMyh0aGlzLnNjLm11bHRpcGx5KHQpKSl9dG9NYXQ0KCl7Y29uc3QgdD1uZXcgbCh0aGlzLnNjLngsMCwwLDAsMCx0aGlzLnNjLnksMCwwLDAsMCx0aGlzLnNjLnosMCwwLDAsMCwxKSxlPXRoaXMub3JpLnRvTWF0NCgpLHM9bmV3IGw7cmV0dXJuIHMudHJhbnNsYXRpb249dGhpcy50cixzLm11bHRpcGx5KGUpLm11bHRpcGx5KHQpfWZyb21NYXQ0KHQpe3RoaXMudHI9dC50cmFuc2xhdGlvbix0aGlzLm9yaS5zZXRGcm9tTWF0NCh0KX1zZXRGcm9tRmxvYXQzMkFycmF5KHQpe2lmKDc9PXQubGVuZ3RoKXJldHVybiB0aGlzLnRyPW5ldyByKHQuYnVmZmVyLHQuYnl0ZU9mZnNldCksdGhpcy5vcmk9bmV3IHUodC5idWZmZXIsdC5ieXRlT2Zmc2V0KzEyKSx2b2lkKHRoaXMuc2M9bmV3IHIoMSwxLDEpKTtpZig4IT10Lmxlbmd0aClyZXR1cm4gMTA9PXQubGVuZ3RoPyh0aGlzLnRyPW5ldyByKHQuYnVmZmVyLHQuYnl0ZU9mZnNldCksdGhpcy5vcmk9bmV3IHUodC5idWZmZXIsdC5ieXRlT2Zmc2V0KzEyKSx2b2lkKHRoaXMuc2M9bmV3IHIodC5idWZmZXIsdC5ieXRlT2Zmc2V0KzIxKSkpOnZvaWQgMDt7dGhpcy50cj1uZXcgcih0LmJ1ZmZlcix0LmJ5dGVPZmZzZXQpLHRoaXMub3JpPW5ldyB1KHQuYnVmZmVyLHQuYnl0ZU9mZnNldCsxMik7Y29uc3QgZT10WzddO3RoaXMuc2M9bmV3IHIoZSxlLGUpfX1jbG9uZSgpe3JldHVybiBuZXcgbSh0aGlzLnRyLmNsb25lKCksdGhpcy5vcmkuY2xvbmUoKSx0aGlzLnNjLmNsb25lKCkpfXN0YXRpYyBjcmVhdGUoLi4udCl7cmV0dXJuIG5ldyBtKC4uLnQpfXRvSlNPTigpe2NvbnN0IHQ9e3RyOnRoaXMudHIudG9KU09OKCksb3JpOnRoaXMub3JpLnRvSlNPTigpfTtyZXR1cm4gdGhpcy5zYy5pczExMSgpfHwodC5zYz10aGlzLnNjLnRvSlNPTigpKSx0fWZyb21KU09OKHQpe3RoaXMudHIuZnJvbUpTT04odC50ciksdGhpcy5vcmkuZnJvbUpTT04odC5vcmkpLHQuc2MmJnRoaXMuc2MuZnJvbUpTT04odC5zYyl9dG9TdHJpbmcoKXtyZXR1cm4gZSh0aGlzLnRvSlNPTigpKX19YS5yZWdpc3RlclR5cGUoIlhmbyIsbSk7Y2xhc3MgZ3tjb25zdHJ1Y3Rvcih0LGUpe3RoaXMucDA9dCBpbnN0YW5jZW9mIGk/dDpuZXcgaShOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFksTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZKSx0aGlzLnAxPWUgaW5zdGFuY2VvZiBpP2U6bmV3IGkoTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZLE51bWJlci5ORUdBVElWRV9JTkZJTklUWSl9c2V0KHQsZSl7dGhpcy5wMD10LHRoaXMucDE9ZX1yZXNldCgpe3RoaXMucDAueD1OdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFksdGhpcy5wMS54PU51bWJlci5ORUdBVElWRV9JTkZJTklUWSx0aGlzLnAwLnk9TnVtYmVyLlBPU0lUSVZFX0lORklOSVRZLHRoaXMucDEueT1OdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFl9aXNWYWxpZCgpe3JldHVybiB0aGlzLnAwLnghPU51bWJlci5QT1NJVElWRV9JTkZJTklUWSYmdGhpcy5wMS54IT1OdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFkmJnRoaXMucDAueSE9TnVtYmVyLlBPU0lUSVZFX0lORklOSVRZJiZ0aGlzLnAxLnkhPU51bWJlci5ORUdBVElWRV9JTkZJTklUWX1hZGRQb2ludCh0KXsodGhpcy5wMC54PT1OdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFl8fHQueDx0aGlzLnAwLngpJiYodGhpcy5wMC54PXQueCksKHRoaXMucDAueT09TnVtYmVyLlBPU0lUSVZFX0lORklOSVRZfHx0Lnk8dGhpcy5wMC55KSYmKHRoaXMucDAueT10LnkpLCh0aGlzLnAxLnk9PU51bWJlci5ORUdBVElWRV9JTkZJTklUWXx8dC54PnRoaXMucDEueCkmJih0aGlzLnAxLng9dC54KSwodGhpcy5wMS55PT1OdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFl8fHQueT50aGlzLnAxLnkpJiYodGhpcy5wMS55PXQueSl9c2l6ZSgpe3JldHVybiB0aGlzLnAxLnN1YnRyYWN0KHRoaXMucDApfWRpYWdvbmFsKCl7cmV0dXJuIHRoaXMucDEuc3VidHJhY3QodGhpcy5wMCl9Y2VudGVyKCl7Y29uc3QgdD10aGlzLnAxLnN1YnRyYWN0KHRoaXMucDApO3JldHVybiB0LnNjYWxlSW5QbGFjZSguNSksdC5hZGRJblBsYWNlKHRoaXMucDApLHR9c3RhdGljIGNyZWF0ZSguLi50KXtyZXR1cm4gbmV3IGcoLi4udCl9dG9KU09OKCl7cmV0dXJue3AwOnRoaXMucDAudG9KU09OKCkscDE6dGhpcy5wMS50b0pTT04oKX19dG9TdHJpbmcoKXtyZXR1cm4gZSh0aGlzLnRvSlNPTigpKX19YS5yZWdpc3RlclR5cGUoIkJveDIiLGcpO2NsYXNzIHkgZXh0ZW5kcyBze2NvbnN0cnVjdG9yKHQsZT0wKXtzdXBlcigpLHRoaXMucG9zPXQgaW5zdGFuY2VvZiByP3Q6bmV3IHIsdGhpcy5yYWRpdXM9ZX1jbG9uZSgpe3JldHVybiBuZXcgU3BoZXJlKHRoaXMucG9zLmNsb25lKCksdGhpcy5yYWRpdXMpfWludGVyc2VjdHNCb3godCl7cmV0dXJuIHQuaW50ZXJzZWN0c1NwaGVyZSh0aGlzKX1zdGF0aWMgY3JlYXRlKC4uLnQpe3JldHVybiBuZXcgU3BoZXJlKC4uLnQpfXRvSlNPTigpe3JldHVybntwb3M6dGhpcy5wb3MudG9KU09OKCkscmFkaXVzOnRoaXMucmFkaXVzfX10b1N0cmluZygpe3JldHVybiBlKHRoaXMudG9KU09OKCkpfX1hLnJlZ2lzdGVyVHlwZSgiU3BoZXJlVHlwZSIseSk7Y2xhc3MgcHtjb25zdHJ1Y3Rvcih0LGUpe3QgaW5zdGFuY2VvZiBGbG9hdDMyQXJyYXk/dGhpcy5zZXRGcm9tRmxvYXQzMkFycmF5KHQpOih0aGlzLnAwPXQgaW5zdGFuY2VvZiByP3Q6bmV3IHIoTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZLE51bWJlci5QT1NJVElWRV9JTkZJTklUWSxOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFkpLHRoaXMucDE9ZSBpbnN0YW5jZW9mIHI/ZTpuZXcgcihOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFksTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZLE51bWJlci5ORUdBVElWRV9JTkZJTklUWSkpfWdldCBtaW4oKXtyZXR1cm4gdGhpcy5wMH1nZXQgbWF4KCl7cmV0dXJuIHRoaXMucDF9c2V0KHQsZSl7dGhpcy5wMD10LHRoaXMucDE9ZX1yZXNldCgpe3RoaXMucDAueD1OdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFksdGhpcy5wMS54PU51bWJlci5ORUdBVElWRV9JTkZJTklUWSx0aGlzLnAwLnk9TnVtYmVyLlBPU0lUSVZFX0lORklOSVRZLHRoaXMucDEueT1OdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFksdGhpcy5wMC56PU51bWJlci5QT1NJVElWRV9JTkZJTklUWSx0aGlzLnAxLno9TnVtYmVyLk5FR0FUSVZFX0lORklOSVRZfWlzVmFsaWQoKXtyZXR1cm4gdGhpcy5wMC54IT1OdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFkmJnRoaXMucDEueCE9TnVtYmVyLk5FR0FUSVZFX0lORklOSVRZJiZ0aGlzLnAwLnkhPU51bWJlci5QT1NJVElWRV9JTkZJTklUWSYmdGhpcy5wMS55IT1OdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFkmJnRoaXMucDAueiE9TnVtYmVyLlBPU0lUSVZFX0lORklOSVRZJiZ0aGlzLnAxLnohPU51bWJlci5ORUdBVElWRV9JTkZJTklUWX1hZGRQb2ludCh0KXt0LnghPU51bWJlci5QT1NJVElWRV9JTkZJTklUWSYmdC54IT1OdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFkmJih0Lng8dGhpcy5wMC54JiYodGhpcy5wMC54PXQueCksdC54PnRoaXMucDEueCYmKHRoaXMucDEueD10LngpKSx0LnkhPU51bWJlci5QT1NJVElWRV9JTkZJTklUWSYmdC55IT1OdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFkmJih0Lnk8dGhpcy5wMC55JiYodGhpcy5wMC55PXQueSksdC55PnRoaXMucDEueSYmKHRoaXMucDEueT10LnkpKSx0LnohPU51bWJlci5QT1NJVElWRV9JTkZJTklUWSYmdC56IT1OdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFkmJih0Lno8dGhpcy5wMC56JiYodGhpcy5wMC56PXQueiksdC56PnRoaXMucDEueiYmKHRoaXMucDEuej10LnopKX1hZGRCb3gzKHQsZSl7ZT8odGhpcy5hZGRQb2ludChlLnRyYW5zZm9ybVZlYzModC5wMCkpLHRoaXMuYWRkUG9pbnQoZS50cmFuc2Zvcm1WZWMzKG5ldyByKHQucDAueCx0LnAwLnksdC5wMS56KSkpLHRoaXMuYWRkUG9pbnQoZS50cmFuc2Zvcm1WZWMzKG5ldyByKHQucDAueCx0LnAxLnksdC5wMC56KSkpLHRoaXMuYWRkUG9pbnQoZS50cmFuc2Zvcm1WZWMzKG5ldyByKHQucDEueCx0LnAwLnksdC5wMC56KSkpLHRoaXMuYWRkUG9pbnQoZS50cmFuc2Zvcm1WZWMzKG5ldyByKHQucDAueCx0LnAxLnksdC5wMS56KSkpLHRoaXMuYWRkUG9pbnQoZS50cmFuc2Zvcm1WZWMzKG5ldyByKHQucDEueCx0LnAwLnksdC5wMS56KSkpLHRoaXMuYWRkUG9pbnQoZS50cmFuc2Zvcm1WZWMzKG5ldyByKHQucDEueCx0LnAxLnksdC5wMC56KSkpLHRoaXMuYWRkUG9pbnQoZS50cmFuc2Zvcm1WZWMzKHQucDEpKSk6KHRoaXMuYWRkUG9pbnQodC5wMCksdGhpcy5hZGRQb2ludCh0LnAxKSl9c2l6ZSgpe3JldHVybiB0aGlzLnAxLnN1YnRyYWN0KHRoaXMucDApfWRpYWdvbmFsKCl7cmV0dXJuIHRoaXMucDEuc3VidHJhY3QodGhpcy5wMCl9Y2VudGVyKCl7Y29uc3QgdD10aGlzLnAxLnN1YnRyYWN0KHRoaXMucDApO3JldHVybiB0LnNjYWxlSW5QbGFjZSguNSksdC5hZGRJblBsYWNlKHRoaXMucDApLHR9dG9NYXQ0KCl7Y29uc3QgdD10aGlzLnAxLngtdGhpcy5wMC54LGU9dGhpcy5wMS55LXRoaXMucDAueSxzPXRoaXMucDEuei10aGlzLnAwLno7cmV0dXJuIG5ldyBsKHQsMCwwLDAsMCxlLDAsMCwwLDAscywwLHRoaXMucDAueCx0aGlzLnAwLnksdGhpcy5wMC56LDEpfWdldEJvdW5kaW5nU3BoZXJlKCl7cmV0dXJuIG5ldyB5KHRoaXMuY2VudGVyKCksLjUqdGhpcy5kaWFnb25hbCgpLmxlbmd0aCgpKX1pbnRlcnNlY3RzQm94KHQpe3JldHVybiEodC5tYXgueDx0aGlzLm1pbi54fHx0Lm1pbi54PnRoaXMubWF4Lnh8fHQubWF4Lnk8dGhpcy5taW4ueXx8dC5taW4ueT50aGlzLm1heC55fHx0Lm1heC56PHRoaXMubWluLnp8fHQubWluLno+dGhpcy5tYXgueil9aW50ZXJzZWN0c1NwaGVyZSh0KXtyZXR1cm4gY2xvc2VzdFBvaW50LmRpc3RhbmNlVG9TcXVhcmVkKHQuY2VudGVyKTw9dC5yYWRpdXMqdC5yYWRpdXN9aW50ZXJzZWN0c1BsYW5lKHQpe2xldCBlLHM7cmV0dXJuIHQubm9ybWFsLng+MD8oZT10Lm5vcm1hbC54KnRoaXMubWluLngscz10Lm5vcm1hbC54KnRoaXMubWF4LngpOihlPXQubm9ybWFsLngqdGhpcy5tYXgueCxzPXQubm9ybWFsLngqdGhpcy5taW4ueCksdC5ub3JtYWwueT4wPyhlKz10Lm5vcm1hbC55KnRoaXMubWluLnkscys9dC5ub3JtYWwueSp0aGlzLm1heC55KTooZSs9dC5ub3JtYWwueSp0aGlzLm1heC55LHMrPXQubm9ybWFsLnkqdGhpcy5taW4ueSksdC5ub3JtYWwuej4wPyhlKz10Lm5vcm1hbC56KnRoaXMubWluLnoscys9dC5ub3JtYWwueip0aGlzLm1heC56KTooZSs9dC5ub3JtYWwueip0aGlzLm1heC56LHMrPXQubm9ybWFsLnoqdGhpcy5taW4ueiksZTw9LXQuY29uc3RhbnQmJnM+PS10LmNvbnN0YW50fWNsb25lKCl7cmV0dXJuIG5ldyBwKHRoaXMucDAuY2xvbmUoKSx0aGlzLnAxLmNsb25lKCkpfXN0YXRpYyBjcmVhdGUoLi4udCl7cmV0dXJuIG5ldyBwKC4uLnQpfXN0YXRpYyBzaXplSW5CeXRlcygpe3JldHVybiAyNH10b0pTT04oKXtyZXR1cm57cDA6dGhpcy5wMC50b0pTT04oKSxwMTp0aGlzLnAxLnRvSlNPTigpfX1mcm9tSlNPTih0KXt0aGlzLnAwLmZyb21KU09OKHQucDApLHRoaXMucDEuZnJvbUpTT04odC5wMSl9bG9hZEJpbih0LGUpe3RoaXMucDAubG9hZEJpbih0LGUpLHRoaXMucDAubG9hZEJpbih0LGUrMTIpfXNldEZyb21GbG9hdDMyQXJyYXkodCl7dGhpcy5wMD1uZXcgcih0LmJ1ZmZlcix0LmJ5dGVPZmZzZXQpLHRoaXMucDE9bmV3IHIodC5idWZmZXIsdC5ieXRlT2Zmc2V0KzEyKX10b1N0cmluZygpe3JldHVybiBlKHRoaXMudG9KU09OKCkpfX1hLnJlZ2lzdGVyVHlwZSgiQm94MyIscCk7Y2xhc3MgeCBleHRlbmRzIHN7Y29uc3RydWN0b3IodCxlPTApe3N1cGVyKCksdGhpcy5ub3JtYWw9dCBpbnN0YW5jZW9mIHI/dDpuZXcgcix0aGlzLnc9ZX1zZXQodCxlLHMsYSl7dGhpcy5ub3JtYWwuc2V0KHQsZSxzKSx0aGlzLnc9YX1kaXZpZGVTY2FsYXIodCl7dGhpcy5ub3JtYWwuc2NhbGVJblBsYWNlKDEvdCksdGhpcy53Lz10fWRpc3RhbmNlVG9Qb2ludCh0KXtyZXR1cm4gdC5kb3QodGhpcy5ub3JtYWwpK3RoaXMud31ub3JtYWxpemVJblBsYWNlKCl7Y29uc3QgdD0xL3RoaXMubm9ybWFsLmxlbmd0aCgpO3RoaXMubm9ybWFsLnNjYWxlSW5QbGFjZSh0KSx0aGlzLncqPXR9Y2xvbmUoKXtyZXR1cm4gbmV3IFBsYW5lKHRoaXMubm9ybWFsLmNsb25lKCksdGhpcy53KX1zdGF0aWMgY3JlYXRlKC4uLnQpe3JldHVybiBuZXcgUGxhbmUoLi4udCl9dG9KU09OKCl7cmV0dXJue25vcm1hbDp0aGlzLm5vcm1hbC50b0pTT04oKSx3OnRoaXMud319dG9TdHJpbmcoKXtyZXR1cm4gZSh0aGlzLnRvSlNPTigpKX19YS5yZWdpc3RlclR5cGUoIlBsYW5lVHlwZSIseCk7YS5yZWdpc3RlclR5cGUoIkZydXN0dW0iLGNsYXNze2NvbnN0cnVjdG9yKHQsZSxzLGEsaSxyKXt0aGlzLnBsYW5lcz1bdHx8bmV3IHgsZXx8bmV3IHgsc3x8bmV3IHgsYXx8bmV3IHgsaXx8bmV3IHgscnx8bmV3IHhdfXNldEZyb21NYXRyaXgodCl7Y29uc3QgZT10LHM9dGhpcy5wbGFuZXM7c1swXS5zZXQoZS5tMDMtZS5tMDAsZS5tMTMtZS5tMTAsZS5tMjMtZS5tMjAsZS5tMzMtZS5tMzApLHNbMV0uc2V0KGUubTAzK2UubTAwLGUubTEzK2UubTEwLGUubTIzK2UubTIwLGUubTMzK2UubTMwKSxzWzJdLnNldChlLm0wMytlLm0wMSxlLm0xMytlLm0xMSxlLm0yMytlLm0yMSxlLm0zMytlLm0zMSksc1szXS5zZXQoZS5tMDMtZS5tMDEsZS5tMTMtZS5tMTEsZS5tMjMtZS5tMjEsZS5tMzMtZS5tMzEpLHNbNF0uc2V0KGUubTAzLWUubTAyLGUubTEzLWUubTEyLGUubTIzLWUubTIyLGUubTMzLWUubTMyKSxzWzVdLnNldChlLm0wMytlLm0wMixlLm0xMytlLm0xMixlLm0yMytlLm0yMixlLm0zMytlLm0zMikscy5mb3JFYWNoKHQ9PnQubm9ybWFsaXplSW5QbGFjZSgpKX1pbnRlcnNlY3RzQm94KHQpe2NvbnN0IGU9bmV3IHIscz10aGlzLnBsYW5lcyx7bWluOmEsbWF4Oml9PXQ7Zm9yKGxldCB0PTA7dDw2O3QrKyl7Y29uc3Qgcj1zW3RdO2lmKGUueD1yLm5vcm1hbC54PjA/aS54OmEueCxlLnk9ci5ub3JtYWwueT4wP2kueTphLnksZS56PXIubm9ybWFsLno+MD9pLno6YS56LHIuZGlzdGFuY2VUb1BvaW50KGUpPDApcmV0dXJuITF9cmV0dXJuITB9dG9KU09OKCl7cmV0dXJue3AwOnRoaXMucDAudG9KU09OKCkscDE6dGhpcy5wMS50b0pTT04oKSxwMjp0aGlzLnAyLnRvSlNPTigpLHAzOnRoaXMucDMudG9KU09OKCkscDQ6dGhpcy5wNC50b0pTT04oKSxwNTp0aGlzLnA1LnRvSlNPTigpfX1mcm9tSlNPTih0KXt0aGlzLnAwLmZyb21KU09OKHQucDApLHRoaXMucDEuZnJvbUpTT04odC5wMSksdGhpcy5wMi5mcm9tSlNPTih0LnAyKSx0aGlzLnAzLmZyb21KU09OKHQucDMpLHRoaXMucDQuZnJvbUpTT04odC5wNCksdGhpcy5wNS5mcm9tSlNPTih0LnA1KX10b1N0cmluZygpe3JldHVybiBlKHRoaXMudG9KU09OKCkpfX0pO2NsYXNzIHd7Y29uc3RydWN0b3IodD0hMSl7dGhpcy5fX3Nsb3RzPVtdLHRoaXMuX190b2dnbGVkU2lnbmFsPXQsdGhpcy5fX3RvZ2dsZWQ9ITEsdGhpcy5fX2RhdGE9bnVsbCx0aGlzLmNvbm5lY3Q9dGhpcy5jb25uZWN0LmJpbmQodGhpcyksdGhpcy5kaXNjb25uZWN0PXRoaXMuZGlzY29ubmVjdC5iaW5kKHRoaXMpLHRoaXMuZW1pdD10aGlzLmVtaXQuYmluZCh0aGlzKX1jb25uZWN0KHQpe2lmKG51bGw9PXQpdGhyb3cgbmV3IEVycm9yKCJhIGZ1bmN0aW9uIGNhbGxiYWNrIG11c3QgYmUgcGFzc2VkIHRvIFNpZ25hbC5jb25uZWN0Iik7aWYoLTEhPXRoaXMuX19zbG90cy5pbmRleE9mKHQpKXJldHVybiB2b2lkIGNvbnNvbGUud2FybigiZm4gJyIrdC5uYW1lKyInIGFscmVhZHkgY29ubmVjdGVkIHRvIFNpZ25hbC4iKTtjb25zdCBlPXRoaXMuX19zbG90cy5sZW5ndGg7cmV0dXJuIHRoaXMuX19zbG90c1tlXT10LHRoaXMuX190b2dnbGVkU2lnbmFsJiZ0aGlzLl9fdG9nZ2xlZCYmKHRoaXMuX19kYXRhP3QoLi4udGhpcy5fX2RhdGEpOnQoKSksZX1kaXNjb25uZWN0KHQpe2lmKG51bGw9PXQpdGhyb3cgbmV3IEVycm9yKCJhIGZ1bmN0aW9uIGNhbGxiYWNrIG11c3QgYmUgcGFzc2VkIHRvIFNpZ25hbC5kaXNjb25uZWN0Iik7Y29uc3QgZT1bXTtpZih0aGlzLl9fc2xvdHMuZm9yRWFjaCgoZnVuY3Rpb24ocyxhKXtzPT09dCYmZS5wdXNoKGEpfSkpLDAhPWUubGVuZ3RoKWZvcihjb25zdCB0IG9mIGUpdGhpcy5fX3Nsb3RzW3RdPXZvaWQgMDtlbHNlIGNvbnNvbGUud2FybigiY2FsbGJhY2sgOiIrdC5uYW1lKyIgd2FzIG5vdCBjb25uZWN0ZWQgdG8gdGhpcyBzaWduYWw6Iit0aGlzLl9fbmFtZSl9ZGlzY29ubmVjdElkKHQpe2lmKCF0aGlzLl9fc2xvdHNbdF0pdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIElEIik7dGhpcy5fX3Nsb3RzW3RdPXZvaWQgMH1lbWl0KC4uLnQpe3RoaXMuX190b2dnbGVkU2lnbmFsJiYodGhpcy5fX3RvZ2dsZWQ/Y29uc29sZS53YXJuKCJUb2dnbGVkIHNpZ25hbHMgc2hvdWxkIG9ubHkgYmUgZmlyZWQgb25jZSwgb3IgdW50b2dnbGVkIGJlZm9yZSByZS1maXJpbmcuLiIpOih0aGlzLl9fdG9nZ2xlZD0hMCx0aGlzLl9fZGF0YT10KSk7Y29uc3QgZT10aGlzLl9fc2xvdHMubGVuZ3RoO2ZvcihsZXQgcz0wO3M8ZTtzKyspe2NvbnN0IGU9dGhpcy5fX3Nsb3RzW3NdO2UmJmUoLi4udCl9fWlzVG9nZ2xlZCgpe3JldHVybiB0aGlzLl9fdG9nZ2xlZH1zZXRUb2dnbGVkKHQpe3RoaXMuX190b2dnbGVkPXQsdGhpcy5fX2RhdGE9dm9pZCAwfWdldE51bUNvbm5lY3Rpb25zKCl7cmV0dXJuIHRoaXMuX19zbG90cy5sZW5ndGh9dW50b2dnbGUoKXt0aGlzLl9fdG9nZ2xlZD0hMSx0aGlzLl9fZGF0YT12b2lkIDB9fWNvbnN0IEk9bmV3IGNsYXNze2NvbnN0cnVjdG9yKCl7dGhpcy5fX3JlZ2lzdGVyZWRDbGFzc2VzPXt9LHRoaXMuX19jbGFzc05hbWVzPXt9fXJlZ2lzdGVyQ2xhc3ModCxlKXt0aGlzLl9fcmVnaXN0ZXJlZENsYXNzZXNbdF09e2NsczplLGNhbGxiYWNrczpbXX0sdGhpcy5fX2NsYXNzTmFtZXNbZS5uYW1lXT10fXJlZ2lzdGVyQ2FsbGJhY2sodCxlKXtjb25zdCBzPXRoaXMuX19yZWdpc3RlcmVkQ2xhc3Nlc1t0XTtzP3MuY2FsbGJhY2tzLnB1c2goZSk6Y29uc29sZS53YXJuKCJGYWN0b3J5IG5vdCByZWdpc3RlcmVkOiIrdCl9Z2V0Q2xhc3ModCl7aWYodGhpcy5fX3JlZ2lzdGVyZWRDbGFzc2VzW3RdKXJldHVybiB0aGlzLl9fcmVnaXN0ZXJlZENsYXNzZXNbdF0uY2xzfWdldENsYXNzTmFtZSh0KXtyZXR1cm4gdGhpcy5fX2NsYXNzTmFtZXNbdC5jb25zdHJ1Y3Rvci5uYW1lXT90aGlzLl9fY2xhc3NOYW1lc1t0LmNvbnN0cnVjdG9yLm5hbWVdOnQuY29uc3RydWN0b3IubmFtZX1pc0NvbnN0cnVjdGluZygpe3JldHVybiB0aGlzLl9fY29uc3RydWN0aW5nfWNvbnN0cnVjdENsYXNzKHQpe2NvbnN0IGU9dGhpcy5fX3JlZ2lzdGVyZWRDbGFzc2VzW3RdO2lmKCFlKXJldHVybiBjb25zb2xlLndhcm4oIkZhY3Rvcnkgbm90IHJlZ2lzdGVyZWQ6Iit0KSxudWxsO3RoaXMuX19jb25zdHJ1Y3Rpbmc9ITA7Y29uc3Qgcz1BcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsMSksYT1uZXcgZS5jbHMoLi4ucyk7cmV0dXJuIHRoaXMuX19jb25zdHJ1Y3Rpbmc9ITEsdGhpcy5pbnZva2VDYWxsYmFja3MoYSksYX1pbnZva2VDYWxsYmFja3ModCl7aWYodGhpcy5fX2NsYXNzTmFtZXNbdC5jb25zdHJ1Y3Rvci5uYW1lXSl7Y29uc3QgZT10aGlzLl9fcmVnaXN0ZXJlZENsYXNzZXNbdGhpcy5fX2NsYXNzTmFtZXNbdC5jb25zdHJ1Y3Rvci5uYW1lXV07Zm9yKGNvbnN0IHMgb2YgZS5jYWxsYmFja3Mpcyh0KX19fSxOPTMsRj0yO2xldCB6PTA7Y2xhc3MgVntjb25zdHJ1Y3Rvcih0LGUscyl7aWYodGhpcy5fX2RhdGFUeXBlPXQsdGhpcy5ub3JtYWxpemVkPSExLG51bGwhPXQubnVtRWxlbWVudHMpdGhpcy5fX2RpbWVuc2lvbj10aGlzLl9fZGF0YVR5cGUubnVtRWxlbWVudHMoKTtlbHNlIHN3aXRjaCh0KXtjYXNlIDY6Y2FzZSA0OmNhc2UgNTp0aGlzLl9fZGltZW5zaW9uPTE7YnJlYWs7ZGVmYXVsdDp0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgZGF0YSB0eXBlIGZvciBhdHRyaWJ1dGU6Iit0KX12YXIgYTt0aGlzLl9fZGVmYXVsdEVsZW1lbnRWYWx1ZT1udWxsIT1zP3M6TnVtYmVyLk1BWF9WQUxVRSwoYT1lKSYmdm9pZCAwIT09YS5ieXRlTGVuZ3RoP3RoaXMuX19kYXRhPWU6KHRoaXMuX19kYXRhPW5ldyBGbG9hdDMyQXJyYXkoZSp0aGlzLl9fZGltZW5zaW9uKSx0aGlzLmluaXRSYW5nZSgwKSl9cmVzaXplKHQpe2NvbnN0IGU9dGhpcy5fX2RhdGEubGVuZ3RoLHM9dCp0aGlzLl9fZGltZW5zaW9uLGE9bmV3IEZsb2F0MzJBcnJheShzKTtmb3IobGV0IHQ9MDt0PE1hdGgubWluKHRoaXMuX19kYXRhLmxlbmd0aCxzKTt0KyspYVt0XT10aGlzLl9fZGF0YVt0XTt0aGlzLl9fZGF0YS5sZW5ndGg8cyYmKHRoaXMuX19kYXRhPWEpLHRoaXMuaW5pdFJhbmdlKGUpfWluaXRSYW5nZSh0KXtmb3IobGV0IGU9dDtlPHRoaXMuX19kYXRhLmxlbmd0aDtlKyspdGhpcy5fX2RhdGFbZV09dGhpcy5fX2RlZmF1bHRFbGVtZW50VmFsdWV9Z2V0Q291bnQoKXtyZXR1cm4gdGhpcy5fX2RhdGEubGVuZ3RoL3RoaXMuX19kaW1lbnNpb259Z2V0IGxlbmd0aCgpe3JldHVybiB0aGlzLl9fZGF0YS5sZW5ndGgvdGhpcy5fX2RpbWVuc2lvbn1nZXQgZGF0YVR5cGUoKXtyZXR1cm4gdGhpcy5fX2RhdGFUeXBlfWdldCBkYXRhKCl7cmV0dXJuIHRoaXMuX19kYXRhfXNldCBkYXRhKHQpe3RoaXMuX19kYXRhPXR9Z2V0IG51bUVsZW1lbnRzKCl7cmV0dXJuIHRoaXMuX19kaW1lbnNpb259Z2V0RmxvYXQzMlZhbHVlKHQpe3JldHVybiB0aGlzLl9fZGF0YVt0XX1zZXRGbG9hdDMyVmFsdWUodCxlKXt0aGlzLl9fZGF0YVt0XT1lfWdldFZhbHVlUmVmKHQpe2NvbnN0IGU9dGhpcy5fX2RpbWVuc2lvbjtpZih0Pj10aGlzLl9fZGF0YS5sZW5ndGgvZSl0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgdmVydGV4IGluZGV4OiIrdCsiLiBOdW0gVmVydGljZXM6Iit0aGlzLl9fZGF0YS5sZW5ndGgvMyk7cmV0dXJuIHRoaXMuX19kYXRhVHlwZS5jcmVhdGVGcm9tRmxvYXQzMkJ1ZmZlcih0aGlzLl9fZGF0YS5idWZmZXIsdCplKX1zZXRWYWx1ZSh0LGUpe2NvbnN0IHM9dGhpcy5fX2RpbWVuc2lvbjtpZih0Pj10aGlzLl9fZGF0YS5sZW5ndGgvcyl0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgdmVydGV4IGluZGV4OiIrdCsiLiBOdW0gVmVydGljZXM6Iit0aGlzLl9fZGF0YS5sZW5ndGgvMyk7dGhpcy5fX2RhdGFUeXBlLmNyZWF0ZUZyb21GbG9hdDMyQnVmZmVyKHRoaXMuX19kYXRhLmJ1ZmZlcix0KnMpLnNldEZyb21PdGhlcihlKX10b0pTT04odCxlKXtyZXR1cm57ZGF0YTpBcnJheS5mcm9tKHRoaXMuX19kYXRhKSxkYXRhVHlwZTphLmdldFR5cGVOYW1lKHRoaXMuX19kYXRhVHlwZSksZGVmYXVsdFZhbHVlOnRoaXMuX19kZWZhdWx0RWxlbWVudFZhbHVlLGxlbmd0aDp0aGlzLl9fZGF0YS5sZW5ndGgvdGhpcy5fX2RpbWVuc2lvbn19ZnJvbUpTT04odCl7dGhpcy5fX2RhdGE9RmxvYXQzMkFycmF5LmZyb20odC5kYXRhKX10b1N0cmluZygpe3JldHVybiBKU09OLnN0cmluZ2lmeSh0aGlzLnRvSlNPTigpLG51bGwsMil9fWNsYXNzIE0gZXh0ZW5kcyBjbGFzc3tjb25zdHJ1Y3Rvcigpe3RoaXMuX19pZD0rK3osdGhpcy5fX3BhcmFtcz1bXSx0aGlzLl9fcGFyYW1NYXBwaW5nPXt9LHRoaXMuX19wYXJhbVNpZ25hbElkcz17fSx0aGlzLnBhcmFtZXRlckFkZGVkPW5ldyB3LHRoaXMucGFyYW1ldGVyUmVtb3ZlZD1uZXcgdyx0aGlzLnBhcmFtZXRlclZhbHVlQ2hhbmdlZD1uZXcgd31nZXRJZCgpe3JldHVybiB0aGlzLl9faWR9bnVtUGFyYW1ldGVycygpe3JldHVybiB0aGlzLl9fcGFyYW1zLmxlbmd0aH1nZXRQYXJhbWV0ZXJzKCl7cmV0dXJuIHRoaXMuX19wYXJhbXN9Z2V0UGFyYW1ldGVySW5kZXgodCl7cmV0dXJuIHRoaXMuX19wYXJhbU1hcHBpbmdbdF19Z2V0UGFyYW1ldGVyQnlJbmRleCh0KXtyZXR1cm4gdGhpcy5fX3BhcmFtc1t0XX1oYXNQYXJhbWV0ZXIodCl7cmV0dXJuIHQgaW4gdGhpcy5fX3BhcmFtTWFwcGluZ31nZXRQYXJhbWV0ZXIodCl7Y29uc3QgZT10aGlzLl9fcGFyYW1NYXBwaW5nW3RdO3JldHVybi0xPT1lP251bGw6dGhpcy5fX3BhcmFtc1tlXX1fX3BhcmFtZXRlclZhbHVlQ2hhbmdlZCh0LGUpe3RoaXMucGFyYW1ldGVyVmFsdWVDaGFuZ2VkLmVtaXQodCxlKX1hZGRQYXJhbWV0ZXIodCl7Y29uc3QgZT10LmdldE5hbWUoKTtyZXR1cm4gbnVsbCE9dGhpcy5fX3BhcmFtTWFwcGluZ1tlXSYmKGNvbnNvbGUud2FybigiUmVwbGFjaW5nIFBhcmFtZXRlcjoiK2UpLHRoaXMucmVtb3ZlUGFyYW1ldGVyKGUpKSx0aGlzLl9fcGFyYW1TaWduYWxJZHNbZV09dC52YWx1ZUNoYW5nZWQuY29ubmVjdChlPT50aGlzLl9fcGFyYW1ldGVyVmFsdWVDaGFuZ2VkKHQsZSkpLHRoaXMuX19wYXJhbXMucHVzaCh0KSx0aGlzLl9fcGFyYW1NYXBwaW5nW2VdPXRoaXMuX19wYXJhbXMubGVuZ3RoLTEsdGhpcy5wYXJhbWV0ZXJBZGRlZC5lbWl0KGUpLHR9aW5zZXJ0UGFyYW1ldGVyKHQsZSl7Y29uc3Qgcz10LmdldE5hbWUoKTtudWxsIT10aGlzLl9fcGFyYW1NYXBwaW5nW3NdJiYoY29uc29sZS53YXJuKCJSZXBsYWNpbmcgUGFyYW1ldGVyOiIrcyksdGhpcy5yZW1vdmVQYXJhbWV0ZXIocykpLHRoaXMuX19wYXJhbVNpZ25hbElkc1tzXT10LnZhbHVlQ2hhbmdlZC5jb25uZWN0KGU9PnRoaXMuX19wYXJhbWV0ZXJWYWx1ZUNoYW5nZWQodCxlKSksdGhpcy5fX3BhcmFtcy5zcGxpY2UoZSwwLHQpO2NvbnN0IGE9e307Zm9yKGxldCB0PTA7dDx0aGlzLl9fcGFyYW1zLmxlbmd0aDt0KyspYVt0aGlzLl9fcGFyYW1zW3RdLmdldE5hbWUoKV09dDtyZXR1cm4gdGhpcy5fX3BhcmFtTWFwcGluZz1hLHRoaXMucGFyYW1ldGVyQWRkZWQuZW1pdChzKSx0fXJlbW92ZVBhcmFtZXRlcih0KXtudWxsPT10aGlzLl9fcGFyYW1NYXBwaW5nW3RdJiZjb25zb2xlLnRocm93KCJVbmFibGUgdG8gUmVtb3ZlIFBhcmFtZXRlcjoiK3QpO2NvbnN0IGU9dGhpcy5fX3BhcmFtTWFwcGluZ1t0XTt0aGlzLl9fcGFyYW1zW3RoaXMuX19wYXJhbU1hcHBpbmdbdF1dLnZhbHVlQ2hhbmdlZC5kaXNjb25uZWN0SWQodGhpcy5fX3BhcmFtU2lnbmFsSWRzW3RdKSx0aGlzLl9fcGFyYW1zLnNwbGljZShlLDEpO2NvbnN0IHM9e307Zm9yKGxldCB0PTA7dDx0aGlzLl9fcGFyYW1zLmxlbmd0aDt0Kyspc1t0aGlzLl9fcGFyYW1zW3RdLmdldE5hbWUoKV09dDt0aGlzLl9fcGFyYW1NYXBwaW5nPXMsdGhpcy5wYXJhbWV0ZXJSZW1vdmVkLmVtaXQodCl9cmVwbGFjZVBhcmFtZXRlcih0KXtjb25zdCBlPXQuZ2V0TmFtZSgpLHM9dGhpcy5fX3BhcmFtTWFwcGluZ1tlXTtyZXR1cm4gdGhpcy5fX3BhcmFtc1t0aGlzLl9fcGFyYW1NYXBwaW5nW2VdXS52YWx1ZUNoYW5nZWQuZGlzY29ubmVjdElkKHRoaXMuX19wYXJhbVNpZ25hbElkc1tlXSksdGhpcy5fX3BhcmFtU2lnbmFsSWRzW2VdPXQudmFsdWVDaGFuZ2VkLmNvbm5lY3QoZT0+dGhpcy5fX3BhcmFtZXRlclZhbHVlQ2hhbmdlZCh0LGUpKSx0aGlzLl9fcGFyYW1zW3NdPXQsdH10b0pTT04odCxlKXtjb25zdCBzPXt9O2xldCBhPTA7Zm9yKGNvbnN0IGkgb2YgdGhpcy5fX3BhcmFtcylpZihpLnRlc3RGbGFnKEYpKWlmKGkubnVtUmVmcygpPjEmJjAhPWkuZ2V0UmVmSW5kZXgodGhpcykpc1tpLmdldE5hbWUoKV09e3BhcmFtUGF0aDp0Lm1ha2VSZWxhdGl2ZShpLmdldFBhdGgoKSl9LGErKztlbHNle2NvbnN0IHI9aS50b0pTT04odCxlKTtyJiYoc1tpLmdldE5hbWUoKV09cixhKyspfWlmKGE+MClyZXR1cm57cGFyYW1zOnN9fWZyb21KU09OKHQsZSxzKXtpZih0LnBhcmFtcylmb3IoY29uc3QgcyBpbiB0LnBhcmFtcyl7Y29uc3QgYT10LnBhcmFtc1tzXSxpPXRoaXMuZ2V0UGFyYW1ldGVyKHMpO2k/YS5wYXJhbVBhdGg/ZS5yZXNvbHZlUGF0aChhLnBhcmFtUGF0aCx0PT57dGhpcy5yZXBsYWNlUGFyYW1ldGVyKHQpfSx0PT57Y29uc29sZS53YXJuKCJVbmFibGUgdG8gcmVzb2x2ZSBzaGFyZWQgcGFyYW1ldGVyOiIrYS5wYXJhbVBhdGgpfSk6aS5mcm9tSlNPTihhLGUpOmNvbnNvbGUud2FybigiUGFyYW0gbm90IGZvdW5kOiIrcyl9fXJlYWRCaW5hcnkodCxlKXtpZihlLnZlcnNpb25zWyJ6ZWEtZW5naW5lIl0uZ3JlYXRlck9yRXF1YWxUaGFuKFswLDAsM10pKXtjb25zdCBzPXQubG9hZFVJbnQzMigpO2ZvcihsZXQgYT0wO2E8czthKyspe2NvbnN0IHM9dC5sb2FkU3RyKCksYT10LmxvYWRTdHIoKTtsZXQgaT10aGlzLmdldFBhcmFtZXRlcihhKTtpZighaSl7aWYoaT1JLmNvbnN0cnVjdENsYXNzKHMsYSksIWkpe2NvbnNvbGUuZXJyb3IoIlVuYWJsZSB0byBjb25zdHJ1Y3QgcHJvcDoiK2ErIiBvZiB0eXBlOiIrcyk7Y29udGludWV9dGhpcy5hZGRQYXJhbWV0ZXIoaSl9aS5yZWFkQmluYXJ5KHQsZSl9fX10b1N0cmluZygpe3JldHVybiBKU09OLnN0cmluZ2lmeSh0aGlzLnRvSlNPTigpLG51bGwsMil9Y29weUZyb20odCxlKXtsZXQgcz10Lm51bVBhcmFtZXRlcnMoKTtmb3IoO3MtLTspe2NvbnN0IGU9dC5nZXRQYXJhbWV0ZXJCeUluZGV4KHMpLGE9dGhpcy5nZXRQYXJhbWV0ZXIoZS5nZXROYW1lKCkpO2E/YS5zZXRWYWx1ZShlLmdldFZhbHVlKCksTik6dGhpcy5hZGRQYXJhbWV0ZXIoZS5jbG9uZSgpKX19ZGVzdHJveSgpe2Zvcihjb25zdCB0IG9mIHRoaXMuX19wYXJhbXMpdC5kZXN0cm95KCk7c3VwZXIuZGVzdHJveSgpfX17Y29uc3RydWN0b3IoKXtzdXBlcigpLHRoaXMuX19ib3VuZGluZ0JveD1uZXcgcCx0aGlzLl9fYm91bmRpbmdCb3hEaXJ0eT0hMCx0aGlzLl9fdmVydGV4QXR0cmlidXRlcz1uZXcgTWFwLHRoaXMuX19tZXRhRGF0YT1uZXcgTWFwLHRoaXMuYWRkVmVydGV4QXR0cmlidXRlKCJwb3NpdGlvbnMiLHIsMCksdGhpcy5ib3VuZGluZ0JveERpcnRpZWQ9bmV3IHcsdGhpcy5nZW9tRGF0YUNoYW5nZWQ9bmV3IHcsdGhpcy5nZW9tRGF0YVRvcG9sb2d5Q2hhbmdlZD1uZXcgd31zZXREZWJ1Z05hbWUodCl7dGhpcy5fX25hbWU9dH1hZGRWZXJ0ZXhBdHRyaWJ1dGUodCxlLHMpe2xldCBhO3ZhciBpO3JldHVybiBhPShpPXMpJiZ2b2lkIDAhPT1pLmJ5dGVMZW5ndGg/bmV3IFYoZSxzKTpuZXcgVihlLG51bGwhPXRoaXMudmVydGljZXM/dGhpcy52ZXJ0aWNlcy5sZW5ndGg6MCxzKSx0aGlzLl9fdmVydGV4QXR0cmlidXRlcy5zZXQodCxhKSxhfWhhc1ZlcnRleEF0dHJpYnV0ZSh0KXtyZXR1cm4gdGhpcy5fX3ZlcnRleEF0dHJpYnV0ZXMuaGFzKHQpfWdldFZlcnRleEF0dHJpYnV0ZSh0KXtyZXR1cm4gdGhpcy5fX3ZlcnRleEF0dHJpYnV0ZXMuZ2V0KHQpfWdldFZlcnRleEF0dHJpYnV0ZXModCl7Y29uc3QgZT17fTtmb3IoY29uc3RbdCxzXW9mIHRoaXMuX192ZXJ0ZXhBdHRyaWJ1dGVzLmVudHJpZXMoKSllW3RdPXM7cmV0dXJuIGV9Z2V0IHZlcnRpY2VzKCl7cmV0dXJuIHRoaXMuX192ZXJ0ZXhBdHRyaWJ1dGVzLmdldCgicG9zaXRpb25zIil9bnVtVmVydGljZXMoKXtyZXR1cm4gdGhpcy52ZXJ0aWNlcy5sZW5ndGh9Z2V0TnVtVmVydGljZXMoKXtyZXR1cm4gdGhpcy52ZXJ0aWNlcy5sZW5ndGh9c2V0TnVtVmVydGljZXModCl7dGhpcy5fX3ZlcnRleEF0dHJpYnV0ZXMuZm9yRWFjaChlPT5lLnJlc2l6ZSh0KSl9Z2V0VmVydGV4KHQpe3JldHVybiByLmNyZWF0ZUZyb21GbG9hdDMyQnVmZmVyKHRoaXMudmVydGljZXMuZGF0YS5idWZmZXIsMyp0KX1zZXRWZXJ0ZXgodCxlKXtyZXR1cm4gci5jcmVhdGVGcm9tRmxvYXQzMkJ1ZmZlcih0aGlzLnZlcnRpY2VzLmRhdGEuYnVmZmVyLDMqdCkuc2V0RnJvbU90aGVyKGUpfW1vdmVWZXJ0aWNlcyh0KXtjb25zdCBlPXRoaXMudmVydGljZXM7Zm9yKGxldCBzPTA7czxlLmxlbmd0aDtzKyspZS5nZXRWYWx1ZVJlZihzKS5hZGRJblBsYWNlKHQpO3RoaXMuc2V0Qm91bmRpbmdCb3hEaXJ0eSgpfXRyYW5zZm9ybVZlcnRpY2VzKHQpe2NvbnN0IGU9dGhpcy52ZXJ0aWNlcztmb3IobGV0IHM9MDtzPGUubGVuZ3RoO3MrKyl7Y29uc3QgYT1lLmdldFZhbHVlUmVmKHMpLGk9dC50cmFuc2Zvcm1WZWMzKGEpO2Euc2V0KGkueCxpLnksaS56KX10aGlzLnNldEJvdW5kaW5nQm94RGlydHkoKX1nZXQgYm91bmRpbmdCb3goKXtyZXR1cm4gdGhpcy5fX2JvdW5kaW5nQm94RGlydHkmJnRoaXMudXBkYXRlQm91bmRpbmdCb3goKSx0aGlzLl9fYm91bmRpbmdCb3h9c2V0Qm91bmRpbmdCb3hEaXJ0eSgpe3RoaXMuX19ib3VuZGluZ0JveERpcnR5PSEwLHRoaXMuYm91bmRpbmdCb3hEaXJ0aWVkLmVtaXQoKX11cGRhdGVCb3VuZGluZ0JveCgpe2NvbnN0IHQ9dGhpcy52ZXJ0aWNlcyxlPW5ldyBwLHM9dC5sZW5ndGg7Zm9yKGxldCBhPTA7YTxzO2ErKyllLmFkZFBvaW50KHQuZ2V0VmFsdWVSZWYoYSkpO3RoaXMuX19ib3VuZGluZ0JveD1lLHRoaXMuX19ib3VuZGluZ0JveERpcnR5PSExfWdldE1ldGFkYXRhKHQpe3JldHVybiB0aGlzLl9fbWV0YURhdGEuZ2V0KHQpfWhhc01ldGFkYXRhKHQpe3JldHVybiB0aGlzLl9fbWV0YURhdGEuaGFzKHQpfXNldE1ldGFkYXRhKHQsZSl7dGhpcy5fX21ldGFEYXRhLnNldCh0LGUpfWRlbGV0ZU1ldGFkYXRhKHQpe3RoaXMuX19tZXRhRGF0YS5kZWxldGUodCl9Z2VuQnVmZmVycyh0KXtjb25zdCBlPXt9O2Zvcihjb25zdFt0LHNdb2YgdGhpcy5fX3ZlcnRleEF0dHJpYnV0ZXMpZVt0XT17dmFsdWVzOnMuZGF0YSxjb3VudDpzLnNpemUsZGF0YVR5cGU6cy5kYXRhVHlwZSxub3JtYWxpemVkOnMubm9ybWFsaXplZH07cmV0dXJue251bVZlcnRpY2VzOnRoaXMubnVtVmVydGljZXMoKSxhdHRyQnVmZmVyczplfX1mcmVlQnVmZmVycygpe31sb2FkQmFzZUdlb21CaW5hcnkodCl7dGhpcy5uYW1lPXQubG9hZFN0cigpO2NvbnN0IGU9dC5sb2FkVUludDgoKTt0aGlzLmRlYnVnQ29sb3I9dC5sb2FkUkdCRmxvYXQzMkNvbG9yKCk7Y29uc3Qgcz10LmxvYWRVSW50MzIoKTt0aGlzLl9fYm91bmRpbmdCb3guc2V0KHQubG9hZEZsb2F0MzJWZWMzKCksdC5sb2FkRmxvYXQzMlZlYzMoKSksdGhpcy5zZXROdW1WZXJ0aWNlcyhzKTtjb25zdCBhPXRoaXMudmVydGljZXM7bGV0IG4saDsyJmUmJihuPXRoaXMuZ2V0VmVydGV4QXR0cmlidXRlKCJub3JtYWxzIiksbnx8KG49dGhpcy5hZGRWZXJ0ZXhBdHRyaWJ1dGUoIm5vcm1hbHMiLHIsMCkpKSw0JmUmJihoPXRoaXMuZ2V0VmVydGV4QXR0cmlidXRlKCJ0ZXhDb29yZHMiKSxofHwoaD10aGlzLmFkZFZlcnRleEF0dHJpYnV0ZSgidGV4Q29vcmRzIixpLDApKSk7Y29uc3Qgbz0odCxlLHMsaSk9Pntmb3IobGV0IG49dFswXTtuPHRbMV07bisrKXtjb25zdCB0PW5ldyByKGlbMypuKzBdLzI1NSxpWzMqbisxXS8yNTUsaVszKm4rMl0vMjU1KTt0Lm11bHRpcGx5SW5QbGFjZShzKSx0LmFkZEluUGxhY2UoZSksYS5zZXRWYWx1ZShuLHQpfX0sXz0odCxlLHMsYSk9PntzLmlzTnVsbCgpJiZzLnNldCgxLDEsMSk7Zm9yKGxldCBpPXRbMF07aTx0WzFdO2krKyl7Y29uc3QgdD1uZXcgcihhWzMqaSswXS8yNTUsYVszKmkrMV0vMjU1LGFbMyppKzJdLzI1NSk7dC5tdWx0aXBseUluUGxhY2UocyksdC5hZGRJblBsYWNlKGUpLHQubm9ybWFsaXplSW5QbGFjZSgpLG4uc2V0VmFsdWUoaSx0KX19LGQ9KHQsZSxzLGEpPT57Zm9yKGxldCByPXRbMF07cjx0WzFdO3IrKyl7Y29uc3QgdD1uZXcgaShhWzIqciswXS8yNTUsYVsyKnIrMV0vMjU1KTt0Lm11bHRpcGx5SW5QbGFjZShzKSx0LmFkZEluUGxhY2UoZSksaC5zZXRWYWx1ZShyLHQpfX0sbD10LmxvYWRVSW50MzIoKTtpZigxPT1sKXt7Y29uc3QgZT10aGlzLl9fYm91bmRpbmdCb3gsYT10LmxvYWRVSW50OEFycmF5KDMqcyk7byhbMCxzXSxlLnAwLGUuZGlhZ29uYWwoKSxhKX1pZihuKXtjb25zdCBlPW5ldyBwKHQubG9hZEZsb2F0MzJWZWMzKCksdC5sb2FkRmxvYXQzMlZlYzMoKSksYT10LmxvYWRVSW50OEFycmF5KDMqcyk7XyhbMCxzXSxlLnAwLGUuZGlhZ29uYWwoKSxhKSxuLmxvYWRTcGxpdFZhbHVlcyh0KX1pZihoKXtjb25zdCBlPW5ldyBnKHQubG9hZEZsb2F0MzJWZWMyKCksdC5sb2FkRmxvYXQzMlZlYzIoKSksYT10LmxvYWRVSW50OEFycmF5KDIqcyk7ZChbMCxzXSxlLnAwLGUuZGlhZ29uYWwoKSxhKSxoLmxvYWRTcGxpdFZhbHVlcyh0KX19ZWxzZXtjb25zdCBlPVtdO2xldCBhPTA7Zm9yKGxldCBzPTA7czxsO3MrKyl7Y29uc3Qgcz10LmxvYWRVSW50MzIoKSxpPXtyYW5nZTpbYSxhK3NdLGJib3g6bmV3IHAodC5sb2FkRmxvYXQzMlZlYzMoKSx0LmxvYWRGbG9hdDMyVmVjMygpKX07biYmKGkubm9ybWFsc1JhbmdlPW5ldyBwKHQubG9hZEZsb2F0MzJWZWMzKCksdC5sb2FkRmxvYXQzMlZlYzMoKSkpLGgmJihpLnRleENvb3Jkc1JhbmdlPW5ldyBnKHQubG9hZEZsb2F0MzJWZWMyKCksdC5sb2FkRmxvYXQzMlZlYzIoKSkpLGUucHVzaChpKSxhKz1zfWNvbnN0IGk9dC5sb2FkVUludDhBcnJheSgzKnMpO2xldCByLGM7biYmKHI9dC5sb2FkVUludDhBcnJheSgzKnMpKSxoJiYoYz10LmxvYWRVSW50OEFycmF5KDIqcykpO2ZvcihsZXQgdD0wO3Q8bDt0Kyspe3tjb25zdCBzPWVbdF0uYmJveDtvKGVbdF0ucmFuZ2Uscy5wMCxzLmRpYWdvbmFsKCksaSl9aWYobil7Y29uc3Qgcz1lW3RdLm5vcm1hbHNSYW5nZTtfKGVbdF0ucmFuZ2Uscy5wMCxzLmRpYWdvbmFsKCkscil9aWYoaCl7Y29uc3Qgcz1lW3RdLnRleENvb3Jkc1JhbmdlO2QoZVt0XS5yYW5nZSxzLnAwLHMuZGlhZ29uYWwoKSxjKX19biYmbi5sb2FkU3BsaXRWYWx1ZXModCksaCYmaC5sb2FkU3BsaXRWYWx1ZXModCl9fXRvSlNPTih0LGUpe2xldCBzPXN1cGVyLnRvSlNPTih0LGUpO2lmKHN8fChzPXt9KSxzLnR5cGU9SS5nZXRDbGFzc05hbWUodGhpcyksISgxMDI0JmUpKXtjb25zdCBhPXt9O2Zvcihjb25zdFtzLGldb2YgdGhpcy5fX3ZlcnRleEF0dHJpYnV0ZXMuZW50cmllcygpKWFbc109aS50b0pTT04odCxlKTtzLnZlcnRleEF0dHJpYnV0ZXM9YX1yZXR1cm4gc31mcm9tSlNPTih0LGUscyl7c3VwZXIuZnJvbUpTT04odCxlLHMpO2Zvcihjb25zdCBlIGluIHQudmVydGV4QXR0cmlidXRlcyl7bGV0IHM9dGhpcy5fX3ZlcnRleEF0dHJpYnV0ZXMuZ2V0KGUpO2NvbnN0IGk9dC52ZXJ0ZXhBdHRyaWJ1dGVzW2VdO2lmKCFzKXtjb25zdCB0PWEuZ2V0VHlwZShpLmRhdGFUeXBlKTtzPW5ldyBWZXJ0ZXhBdHRyaWJ1dGUodGhpcyx0LDAsaS5kZWZhdWx0U2NhbGFyVmFsdWUpLHRoaXMuX192ZXJ0ZXhBdHRyaWJ1dGVzLnNldChlLHMpfXMuZnJvbUpTT04oaSl9fXRvU3RyaW5nKCl7cmV0dXJuIEpTT04uc3RyaW5naWZ5KHRoaXMudG9KU09OKCksbnVsbCwyKX19Y2xhc3MgQSBleHRlbmRzIE17Y29uc3RydWN0b3IoKXtzdXBlcigpfWxvYWRCaW4odCl7dGhpcy5uYW1lPXQubG9hZFN0cigpO2NvbnN0IGU9dC5sb2FkVUludDMyKCk7dGhpcy5fX2JvdW5kaW5nQm94LnNldCh0LmxvYWRGbG9hdDMyVmVjMygpLHQubG9hZEZsb2F0MzJWZWMzKCkpLHRoaXMuc2V0TnVtVmVydGljZXMoZSk7Y29uc3Qgcz10aGlzLnZlcnRpY2VzO2lmKGU8MjU2KXtjb25zdCBhPXRoaXMuX19ib3VuZGluZ0JveC50b01hdDQoKSxpPXQubG9hZFVJbnQ4QXJyYXkoMyplKTtmb3IobGV0IHQ9MDt0PGU7dCsrKXtjb25zdCBlPW5ldyBWZWMzKGlbMyp0KzBdLzI1NSxpWzMqdCsxXS8yNTUsaVszKnQrMl0vMjU1KTtzLnNldFZhbHVlKHQsYS50cmFuc2Zvcm1WZWMzKGUpKX19ZWxzZXtjb25zdCBhPXQubG9hZFVJbnQzMigpLGk9W107Zm9yKGxldCBlPTA7ZTxhO2UrKyl7Y29uc3QgZT10LmxvYWRVSW50MzJWZWMyKCkscz10LmxvYWRGbG9hdDMyVmVjMygpLGE9dC5sb2FkRmxvYXQzMlZlYzMoKTtpLnB1c2goe3JhbmdlOmUsYmJveDpuZXcgQm94MyhzLGEpfSl9Y29uc3Qgcj10LmxvYWRVSW50OEFycmF5KDMqZSk7Zm9yKGxldCB0PTA7dDxhO3QrKyl7Y29uc3QgZT1pW3RdLmJib3gudG9NYXQ0KCk7Zm9yKGxldCBhPWlbdF0ucmFuZ2UueDthPGlbdF0ucmFuZ2UueTthKyspe2NvbnN0IHQ9bmV3IFZlYzMoclszKmErMF0vMjU1LHJbMyphKzFdLzI1NSxyWzMqYSsyXS8yNTUpO3Muc2V0VmFsdWUoYSxlLnRyYW5zZm9ybVZlYzModCkpfX19fXJlYWRCaW5hcnkodCxlKXtzdXBlci5sb2FkQmFzZUdlb21CaW5hcnkodCksdGhpcy5nZW9tRGF0YUNoYW5nZWQuZW1pdCgpfX1jbGFzcyBTIGV4dGVuZHMgTXtjb25zdHJ1Y3Rvcigpe3N1cGVyKCksdGhpcy5fX2luZGljZXM9bmV3IFVpbnQzMkFycmF5LHRoaXMuX19zZWdtZW50QXR0cmlidXRlcz1uZXcgTWFwLHRoaXMubGluZVRoaWNrbmVzcz0wfWdldEluZGljZXMoKXtyZXR1cm4gdGhpcy5fX2luZGljZXN9Z2V0TnVtU2VnbWVudHMoKXtyZXR1cm4gdGhpcy5fX2luZGljZXMubGVuZ3RoLzJ9c2V0TnVtU2VnbWVudHModCl7Y29uc3QgZT1uZXcgVWludDMyQXJyYXkoMip0KTt0aGlzLl9faW5kaWNlcz1lfXNldFNlZ21lbnQodCxlLHMpe2lmKHQ+PXRoaXMuX19pbmRpY2VzLmxlbmd0aC8yKXRocm93IG5ldyBFcnJvcigiSW52YWxpZCBsaW5lIGluZGV4OiIrdCsiLiBOdW0gU2VnbWVudHM6Iit0aGlzLl9faW5kaWNlcy5sZW5ndGgvMik7dGhpcy5fX2luZGljZXNbMip0KzBdPWUsdGhpcy5fX2luZGljZXNbMip0KzFdPXN9Z2V0U2VnbWVudFZlcnRleEluZGV4KHQsZSl7aWYodDx0aGlzLm51bUxpbmVzKXJldHVybiB0aGlzLl9faW5kaWNlc1syKnQrZV19YWRkU2VnbWVudEF0dHJpYnV0ZSh0LGUscyl7Y29uc3QgYT1uZXcgQXR0cmlidXRlKGUsbnVsbCE9cz9zOnRoaXMucG9seWdvbkNvdW50KTtyZXR1cm4gdGhpcy5fX3NlZ21lbnRBdHRyaWJ1dGVzLnNldCh0LGEpLGF9aGFzU2VnbWVudEF0dHJpYnV0ZSh0KXtyZXR1cm4gdGhpcy5fX3NlZ21lbnRBdHRyaWJ1dGVzLmhhcyh0KX1nZXRTZWdtZW50QXR0cmlidXRlKHQpe3JldHVybiB0aGlzLl9fc2VnbWVudEF0dHJpYnV0ZXMuZ2V0KHQpfWdlbkJ1ZmZlcnMoKXtjb25zdCB0PXN1cGVyLmdlbkJ1ZmZlcnMoKTtsZXQgZTtyZXR1cm4gdC5udW1WZXJ0aWNlczxNYXRoLnBvdygyLDgpPyhlPW5ldyBVaW50OEFycmF5KHRoaXMuX19pbmRpY2VzLmxlbmd0aCksdGhpcy5fX2luZGljZXMuZm9yRWFjaCgodCxzKT0+e2Vbc109dH0pKTp0Lm51bVZlcnRpY2VzPE1hdGgucG93KDIsMTYpPyhlPW5ldyBVaW50MTZBcnJheSh0aGlzLl9faW5kaWNlcy5sZW5ndGgpLHRoaXMuX19pbmRpY2VzLmZvckVhY2goKHQscyk9PntlW3NdPXR9KSk6ZT10aGlzLl9faW5kaWNlcyx0LmluZGljZXM9ZSx0fXJlYWRCaW5hcnkodCxlKXtzdXBlci5sb2FkQmFzZUdlb21CaW5hcnkodCksdGhpcy5zZXROdW1TZWdtZW50cyh0LmxvYWRVSW50MzIoKSk7Y29uc3Qgcz10LmxvYWRVSW50OCgpOzE9PXM/dGhpcy5fX2luZGljZXM9dC5sb2FkVUludDhBcnJheSgpOjI9PXM/dGhpcy5fX2luZGljZXM9dC5sb2FkVUludDE2QXJyYXkoKTo0PT1zJiYodGhpcy5fX2luZGljZXM9dC5sb2FkVUludDMyQXJyYXkoKSksdGhpcy5nZW9tRGF0YUNoYW5nZWQuZW1pdCgpfXRvSlNPTih0LGUpe2NvbnN0IHM9c3VwZXIudG9KU09OKHQsZSk7cmV0dXJuIDEwMjQmZXx8KHMuaW5kaWNlcz1BcnJheS5mcm9tKHRoaXMuX19pbmRpY2VzKSksc31mcm9tSlNPTih0LGUscyl7c3VwZXIuZnJvbUpTT04odCxlLHMpLHRoaXMuX19pbmRpY2VzPVVpbnQzMkFycmF5LmZyb20odC5pbmRpY2VzKX19Y2xhc3MgTyBleHRlbmRzIFZ7Y29uc3RydWN0b3IodCxlLHMsYSl7c3VwZXIoZSxzLGEpLHRoaXMuX19nZW9tPXQsdGhpcy5fX3NwbGl0cz17fSx0aGlzLl9fc3BsaXRWYWx1ZXM9W119Z2V0RmFjZVZlcnRleFZhbHVlUmVmKHQsZSl7Y29uc3Qgcz10aGlzLl9fZ2VvbS5nZXRGYWNlVmVydGV4SW5kZXgodCxlKTtyZXR1cm4gcyBpbiB0aGlzLl9fc3BsaXRzJiZ0IGluIHRoaXMuX19zcGxpdHNbc10/dGhpcy5fX3NwbGl0VmFsdWVzW3RoaXMuX19zcGxpdHNbc11bdF1dOnRoaXMuZ2V0VmFsdWVSZWYocyl9c2V0RmFjZVZlcnRleFZhbHVlKHQsZSxzKXtjb25zdCBhPXRoaXMuX19nZW9tLmdldEZhY2VWZXJ0ZXhJbmRleCh0LGUpO3RoaXMuc2V0RmFjZVZlcnRleFZhbHVlX0J5VmVydGV4SW5kZXgodCxhLHMpfXNldEZhY2VWZXJ0ZXhWYWx1ZV9CeVZlcnRleEluZGV4KHQsZSxzKXtjb25zdCBhPXRoaXMuZ2V0VmFsdWVSZWYoZSk7aWYoYS5pc1ZhbGlkKCkpaWYoYS5hcHByb3hFcXVhbChzKSk7ZWxzZXtpZihlIGluIHRoaXMuX19zcGxpdHMpe2NvbnN0IGE9dGhpcy5fX3NwbGl0c1tlXTtmb3IoY29uc3QgZSBpbiBhKXtjb25zdCBpPWFbZV07aWYodGhpcy5fX3NwbGl0VmFsdWVzW2ldLmFwcHJveEVxdWFsKHMpKXJldHVybiB2b2lkKGFbdF09aSl9aWYodCBpbiB0aGlzLl9fc3BsaXRzW2VdKXtyZXR1cm4gdm9pZCB0aGlzLl9fc3BsaXRWYWx1ZXNbdGhpcy5fX3NwbGl0c1tlXVt0XV0uc2V0RnJvbU90aGVyKHMpfX1lbHNlIHRoaXMuX19zcGxpdHNbZV09e307dGhpcy5fX3NwbGl0c1tlXVt0XT10aGlzLl9fc3BsaXRWYWx1ZXMubGVuZ3RoLHRoaXMuX19zcGxpdFZhbHVlcy5wdXNoKHMpfWVsc2UgYS5zZXRGcm9tT3RoZXIocyl9c2V0U3BsaXRWZXJ0ZXhWYWx1ZSh0LGUscyl7aWYodCBpbiB0aGlzLl9fc3BsaXRzfHwodGhpcy5fX3NwbGl0c1t0XT17fSksZSBpbiB0aGlzLl9fc3BsaXRzW3RdKXtpZih0aGlzLl9fc3BsaXRWYWx1ZXNbdGhpcy5fX3NwbGl0c1t0XVtlXV0uYXBwcm94RXF1YWwocykpcmV0dXJuO2NvbnNvbGUud2FybigiRmFjZSBWZXJ0ZXggQWxyZWFkeSBTcGxpdCB3aXRoIGRpZmZlcmVudCB2YWx1ZSIpfXRoaXMuX19zcGxpdHNbdF1bZV09dGhpcy5fX3NwbGl0VmFsdWVzLmxlbmd0aCx0aGlzLl9fc3BsaXRWYWx1ZXMucHVzaChzKX1zZXRTcGxpdFZlcnRleFZhbHVlcyh0LGUscyl7dCBpbiB0aGlzLl9fc3BsaXRzfHwodGhpcy5fX3NwbGl0c1t0XT17fSk7Y29uc3QgYT10aGlzLl9fc3BsaXRWYWx1ZXMubGVuZ3RoO3RoaXMuX19zcGxpdFZhbHVlcy5wdXNoKHMpO2Zvcihjb25zdCBzIG9mIGUpdGhpcy5fX3NwbGl0c1t0XVtzXT1hfWdldFNwbGl0cygpe3JldHVybiB0aGlzLl9fc3BsaXRzfWdldFNwbGl0Q291bnQoKXtsZXQgdD0wO2Zvcihjb25zdCBlIGluIHRoaXMuX19zcGxpdHMpdCs9T2JqZWN0LmtleXModGhpcy5fX3NwbGl0c1tlXSkubGVuZ3RoO3JldHVybiB0fWdlbmVyYXRlU3BsaXRWYWx1ZXModCxlKXtpZigwPT1lKXJldHVybiB0aGlzLl9fZGF0YTtjb25zdCBzPXRoaXMubGVuZ3RoLGE9dGhpcy5sZW5ndGgrZSxpPXRoaXMuX19kYXRhVHlwZS5udW1FbGVtZW50cz90aGlzLl9fZGF0YVR5cGUubnVtRWxlbWVudHMoKToxLHI9bmV3IEZsb2F0MzJBcnJheShhKmkpO2ZvcihsZXQgdD0wO3Q8dGhpcy5fX2RhdGEubGVuZ3RoO3QrKylyW3RdPXRoaXMuX19kYXRhW3RdO2Zvcihjb25zdCBlIGluIHQpe2NvbnN0IGE9dFtlXTtmb3IoY29uc3QgdCBpbiBhKXtjb25zdCBuPXMrYVt0XTtpZihlIGluIHRoaXMuX19zcGxpdHMmJnQgaW4gdGhpcy5fX3NwbGl0c1tlXSl7Y29uc3Qgcz10aGlzLl9fc3BsaXRzW2VdW3RdOzY9PXRoaXMuX19kYXRhVHlwZT9yW24qaV09dGhpcy5fX3NwbGl0VmFsdWVzW3NdOnRoaXMuX19kYXRhVHlwZS5jcmVhdGVGcm9tRmxvYXQzMkJ1ZmZlcihyLmJ1ZmZlcixuKmkpLnNldEZyb21PdGhlcih0aGlzLl9fc3BsaXRWYWx1ZXNbc10pfWVsc2V7Y29uc3QgdD1wYXJzZUludChlKTtmb3IobGV0IGU9MDtlPGk7ZSsrKXQqaStlPnRoaXMuX19kYXRhLmxlbmd0aCYmY29uc29sZS5sb2coIkVycm9yIHJlbWFwcGluZyBzcmM6Iit0KmkrZSksbippK2U+ci5sZW5ndGgmJmNvbnNvbGUubG9nKCJFcnJvciByZW1hcHBpbmcgdGd0OiIrbippK2UpLHJbbippK2VdPXRoaXMuX19kYXRhW3QqaStlXX19fXJldHVybiByfXRvSlNPTih0LGUpe2NvbnN0IHM9c3VwZXIudG9KU09OKHQsZSk7cmV0dXJuIHMuc3BsaXRzPXRoaXMuX19zcGxpdHMscy5zcGxpdFZhbHVlcz10aGlzLl9fc3BsaXRWYWx1ZXMsc31mcm9tSlNPTih0LGUscyl7c3VwZXIuZnJvbUpTT04odCxlLHMpLHRoaXMuX19zcGxpdHM9dC5zcGxpdHMsdGhpcy5fX3NwbGl0VmFsdWVzPVtdO2Zvcihjb25zdCBlIG9mIHQuc3BsaXRWYWx1ZXMpdGhpcy5fX3NwbGl0VmFsdWVzLnB1c2godGhpcy5fX2RhdGFUeXBlLmNyZWF0ZUZyb21KU09OKGUpKX1sb2FkU3BsaXRWYWx1ZXModCl7Y29uc3QgZT10LmxvYWRVSW50MzJBcnJheSgpO2lmKDA9PWUubGVuZ3RoKXJldHVybjtsZXQgcz0wLGE9MDtmb3IoOzspe2NvbnN0IHQ9ZVtzKytdLGk9ZVtzKytdLHI9e307Zm9yKGxldCB0PTA7dDxpO3QrKyl7Y29uc3QgdD1lW3MrK10saT1lW3MrK107clt0XT1pLGk+PWEmJihhPWkrMSl9aWYodGhpcy5fX3NwbGl0c1t0XT1yLHM+PWUubGVuZ3RoKWJyZWFrfWNvbnN0IGk9dGhpcy5fX251bUZsb2F0MzJFbGVtZW50cyxyPXQubG9hZEZsb2F0MzJBcnJheShhKmkpO3RoaXMuX19zcGxpdFZhbHVlcz1bXTtmb3IobGV0IHQ9MDt0PGE7dCsrKXtjb25zdCBlPXRoaXMuX19kYXRhVHlwZS5jcmVhdGVGcm9tRmxvYXQzMkFycmF5KHIuc2xpY2UodCppLHQqaStpKSk7dGhpcy5fX3NwbGl0VmFsdWVzLnB1c2goZSl9fX1jbGFzcyBQIGV4dGVuZHMgTXtjb25zdHJ1Y3Rvcigpe3N1cGVyKCksdGhpcy5pbml0KCl9aW5pdCgpe3RoaXMuX19mYWNlQ291bnRzPVtdLHRoaXMuX19mYWNlVmVydGV4Q291bnRzPW5ldyBVaW50OEFycmF5LHRoaXMuX19mYWNlT2Zmc2V0cz1uZXcgVWludDMyQXJyYXksdGhpcy5fX2ZhY2VWZXJ0ZXhJbmRpY2VzPW5ldyBVaW50MzJBcnJheSx0aGlzLl9fbnVtUG9wdWxhdGVkRmFjZVZlcnRleEluZGljZXM9MCx0aGlzLl9fZmFjZUF0dHJpYnV0ZXM9bmV3IE1hcCx0aGlzLl9fZWRnZUF0dHJpYnV0ZXM9bmV3IE1hcCx0aGlzLl9fbG9nVG9wb2xvZ3lXYXJuaW5ncz0hMSx0aGlzLmVkZ2VWZXJ0cz12b2lkIDAsdGhpcy52ZXJ0ZXhFZGdlcz12b2lkIDAsdGhpcy5udW1FZGdlcz0wLHRoaXMuZWRnZUZsYWdzPW5ldyBVaW50MzJBcnJheSx0aGlzLmVkZ2VBbmdsZXM9bmV3IEZsb2F0MzJBcnJheX1nZXRGYWNlVmVydGV4SW5kaWNlcygpe3JldHVybiB0aGlzLl9fZmFjZVZlcnRleEluZGljZXN9Z2V0RmFjZUNvdW50cygpe3JldHVybiB0aGlzLl9fZmFjZUNvdW50c31jbGVhcigpe3RoaXMuX19mYWNlVmVydGV4SW5kaWNlcz12b2lkIDAsdGhpcy5fX2ZhY2VDb3VudHM9W10sdGhpcy5fX251bVBvcHVsYXRlZEZhY2VWZXJ0ZXhJbmRpY2VzPTB9c2V0RmFjZUNvdW50cyh0KXtpZih0aGlzLl9fbnVtUG9wdWxhdGVkRmFjZVZlcnRleEluZGljZXMpdGhyb3cgbmV3IEVycm9yKCJDYW5ub3Qgc2V0IGZhY2UgY291bnRzIG9uIGEgbWVzaCB0aGF0IGlzIGFscmVhZHkgcG9wdWxhdGVkLiBQbGVhc2UgY2FsbCAnY2xlYXInIGJlZm9yZSByZS1idWlsZGluZyB0aGUgbWVzaC4iKTt0aGlzLl9fZmFjZUNvdW50cz10O2xldCBlPTAscz0wLGE9Mztmb3IoY29uc3QgdCBvZiB0aGlzLl9fZmFjZUNvdW50cyllKz10LHMrPXQqYSxhKys7dGhpcy5fX2ZhY2VWZXJ0ZXhDb3VudHM9bmV3IFVpbnQ4QXJyYXkoZSksdGhpcy5fX2ZhY2VPZmZzZXRzPW5ldyBVaW50MzJBcnJheShlKSx0aGlzLl9fZmFjZVZlcnRleEluZGljZXM9bmV3IFVpbnQzMkFycmF5KHMpO2Zvcihjb25zdCB0IG9mIHRoaXMuX19mYWNlQXR0cmlidXRlcyl0LnJlc2l6ZShlKX1zZXRGYWNlVmVydGV4SW5kaWNlcyh0KXtjb25zdCBlPUFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywxKSxzPXRoaXMuX19udW1Qb3B1bGF0ZWRGYWNlVmVydGV4SW5kaWNlcztmb3IobGV0IHQ9MDt0PGUubGVuZ3RoO3QrKyl0aGlzLl9fZmFjZVZlcnRleEluZGljZXNbcyt0XT1lW3RdO3RoaXMuX19mYWNlVmVydGV4Q291bnRzW3RdPWUubGVuZ3RoLTMsdGhpcy5fX2ZhY2VPZmZzZXRzW3RdPXMsdGhpcy5fX251bVBvcHVsYXRlZEZhY2VWZXJ0ZXhJbmRpY2VzKz1lLmxlbmd0aH1nZXRGYWNlVmVydGV4SW5kaWNlcyh0KXtjb25zdCBlPVtdLHM9dGhpcy5fX2ZhY2VPZmZzZXRzW3RdLGE9dGhpcy5fX2ZhY2VWZXJ0ZXhDb3VudHNbdF0rMztmb3IobGV0IHQ9MDt0PGE7dCsrKWUucHVzaCh0aGlzLl9fZmFjZVZlcnRleEluZGljZXNbcyt0XSk7cmV0dXJuIGV9Z2V0RmFjZVZlcnRleEluZGV4KHQsZSl7Y29uc3Qgcz10aGlzLl9fZmFjZU9mZnNldHNbdF07cmV0dXJuIHRoaXMuX19mYWNlVmVydGV4SW5kaWNlc1tzK2VdfWdldE51bUZhY2VzKCl7cmV0dXJuIHRoaXMuX19mYWNlVmVydGV4Q291bnRzLmxlbmd0aH1hZGRWZXJ0ZXhBdHRyaWJ1dGUodCxlLHMpe2NvbnN0IGE9bmV3IE8odGhpcyxlLG51bGwhPXRoaXMudmVydGljZXM/dGhpcy52ZXJ0aWNlcy5sZW5ndGg6MCxzKTtyZXR1cm4gdGhpcy5fX3ZlcnRleEF0dHJpYnV0ZXMuc2V0KHQsYSksYX1hZGRGYWNlQXR0cmlidXRlKHQsZSxzKXtjb25zdCBhPW5ldyBWKGUsbnVsbCE9cz9zOnRoaXMuZ2V0TnVtRmFjZXMoKSk7cmV0dXJuIHRoaXMuX19mYWNlQXR0cmlidXRlcy5zZXQodCxhKSxhfWhhc0ZhY2VBdHRyaWJ1dGUodCl7cmV0dXJuIHRoaXMuX19mYWNlQXR0cmlidXRlcy5oYXModCl9Z2V0RmFjZUF0dHJpYnV0ZSh0KXtyZXR1cm4gdGhpcy5fX2ZhY2VBdHRyaWJ1dGVzLmdldCh0KX1hZGRFZGdlQXR0cmlidXRlKHQsZSxzKXtjb25zdCBhPW5ldyBWKGUsbnVsbCE9cz9zOnRoaXMuZ2V0TnVtRWRnZXMoKSk7cmV0dXJuIHRoaXMuX19lZGdlQXR0cmlidXRlcy5zZXQodCxhKSxhfWhhc0VkZ2VBdHRyaWJ1dGUodCl7cmV0dXJuIHRoaXMuX19lZGdlQXR0cmlidXRlcy5oYXModCl9Z2V0RWRnZUF0dHJpYnV0ZSh0KXtyZXR1cm4gdGhpcy5fX2VkZ2VBdHRyaWJ1dGVzLmdldCh0KX1nZW5Ub3BvbG9neUluZm8oKXtjb25zdCB0PXt9O3RoaXMudmVydGV4RWRnZXM9W10sdGhpcy5lZGdlRmFjZXM9W10sdGhpcy5lZGdlVmVydHM9W10sdGhpcy5mYWNlRWRnZXM9W10sdGhpcy5udW1FZGdlcz0wO2NvbnN0IGU9KGUscyk9PntsZXQgYT1lLGk9cztpZihpPGEpe2NvbnN0IHQ9YTthPWksaT10fWNvbnN0IHI9YSsiPiIraTtpZihyIGluIHQpcmV0dXJuIHRbcl07Y29uc3Qgbj10aGlzLnZlcnRpY2VzLmdldFZhbHVlUmVmKGEpLGg9dGhpcy52ZXJ0aWNlcy5nZXRWYWx1ZVJlZihpKS5zdWJ0cmFjdChuKSxvPXtlZGdlSW5kZXg6dGhpcy5lZGdlRmFjZXMubGVuZ3RoLzIsZWRnZVZlYzpofTtyZXR1cm4gdFtyXT1vLHRoaXMuZWRnZUZhY2VzLnB1c2goLTEpLHRoaXMuZWRnZUZhY2VzLnB1c2goLTEpLHRoaXMuZWRnZVZlcnRzLnB1c2goYSksdGhpcy5lZGdlVmVydHMucHVzaChpKSx0aGlzLm51bUVkZ2VzKyssb30scz0odCxzLGEpPT57Y29uc3QgaT1lKHQscykuZWRnZUluZGV4O2lmKHM8dCl7Y29uc3QgdD0yKmkrMDt0aGlzLl9fbG9nVG9wb2xvZ3lXYXJuaW5ncyYmLTEhPXRoaXMuZWRnZUZhY2VzW3RdJiZjb25zb2xlLndhcm4oIkVkZ2UgcG9seSAwIGFscmVhZHkgc2V0LiBNZXNoIGlzIG5vbi1tYW5pZm9sZC4iKSx0aGlzLmVkZ2VGYWNlc1t0XT1hfWVsc2V7Y29uc3QgdD0yKmkrMTt0aGlzLl9fbG9nVG9wb2xvZ3lXYXJuaW5ncyYmLTEhPXRoaXMuZWRnZUZhY2VzW3RdJiZjb25zb2xlLndhcm4oIkVkZ2UgcG9seSAxIGFscmVhZHkgc2V0LiBNZXNoIGlzIG5vbi1tYW5pZm9sZC4iKSx0aGlzLmVkZ2VGYWNlc1t0XT1hfWEgaW4gdGhpcy5mYWNlRWRnZXN8fCh0aGlzLmZhY2VFZGdlc1thXT1bXSksdGhpcy5mYWNlRWRnZXNbYV0ucHVzaChpKSxudWxsPT10aGlzLnZlcnRleEVkZ2VzW3RdJiYodGhpcy52ZXJ0ZXhFZGdlc1t0XT1uZXcgU2V0KSxudWxsPT10aGlzLnZlcnRleEVkZ2VzW3NdJiYodGhpcy52ZXJ0ZXhFZGdlc1tzXT1uZXcgU2V0KSx0aGlzLnZlcnRleEVkZ2VzW3RdLmFkZChpKSx0aGlzLnZlcnRleEVkZ2VzW3NdLmFkZChpKX0sYT10aGlzLmdldE51bUZhY2VzKCk7Zm9yKGxldCB0PTA7dDxhO3QrKyl7Y29uc3QgZT10aGlzLmdldEZhY2VWZXJ0ZXhJbmRpY2VzKHQpO2ZvcihsZXQgYT0wO2E8ZS5sZW5ndGg7YSsrKXtzKGVbYV0sZVsoYSsxKSVlLmxlbmd0aF0sdCl9fX1jb21wdXRlRmFjZU5vcm1hbHMoKXtjb25zdCB0PXRoaXMudmVydGljZXMsZT10aGlzLmFkZEZhY2VBdHRyaWJ1dGUoIm5vcm1hbHMiLHIpLHM9dGhpcy5nZXROdW1GYWNlcygpO2ZvcihsZXQgYT0wO2E8czthKyspe2NvbnN0IHM9dGhpcy5nZXRGYWNlVmVydGV4SW5kaWNlcyhhKSxpPXQuZ2V0VmFsdWVSZWYoc1swXSk7bGV0IG49dC5nZXRWYWx1ZVJlZihzWzFdKTtjb25zdCBoPW5ldyByO2ZvcihsZXQgZT0yO2U8cy5sZW5ndGg7ZSsrKXtjb25zdCBhPXQuZ2V0VmFsdWVSZWYoc1tlXSkscj1uLnN1YnRyYWN0KGkpLG89YS5zdWJ0cmFjdChpKTtoLmFkZEluUGxhY2Uoci5jcm9zcyhvKS5ub3JtYWxpemUoKSksbj1hfWgubGVuZ3RoU3F1YXJlZCgpLE51bWJlci5FUFNJTE9OLGUuc2V0VmFsdWUoYSxoLm5vcm1hbGl6ZSgpKX19Z2VuZXJhdGVFZGdlRmxhZ3MoKXtudWxsPT10aGlzLnZlcnRleEVkZ2VzJiZ0aGlzLmdlblRvcG9sb2d5SW5mbygpLHRoaXMuaGFzRmFjZUF0dHJpYnV0ZSgibm9ybWFscyIpfHx0aGlzLmNvbXB1dGVGYWNlTm9ybWFscygpO2NvbnN0IHQ9dGhpcy52ZXJ0aWNlcyxlPXRoaXMuZ2V0RmFjZUF0dHJpYnV0ZSgibm9ybWFscyIpO3RoaXMuZWRnZVZlY3M9W10sdGhpcy5lZGdlQW5nbGVzPW5ldyBGbG9hdDMyQXJyYXkodGhpcy5udW1FZGdlcyk7Zm9yKGxldCBzPTA7czx0aGlzLmVkZ2VGYWNlcy5sZW5ndGg7cys9Mil7Y29uc3QgYT10aGlzLmVkZ2VWZXJ0c1tzXSxpPXRoaXMuZWRnZVZlcnRzW3MrMV0scj10LmdldFZhbHVlUmVmKGkpLnN1YnRyYWN0KHQuZ2V0VmFsdWVSZWYoYSkpO3Iubm9ybWFsaXplSW5QbGFjZSgpLHRoaXMuZWRnZVZlY3MucHVzaChyKTtjb25zdCBuPXRoaXMuZWRnZUZhY2VzW3NdLGg9dGhpcy5lZGdlRmFjZXNbcysxXTtpZigtMT09bnx8LTE9PWgpe3RoaXMuZWRnZUFuZ2xlc1tzLzJdPTIqTWF0aC5QSTtjb250aW51ZX1jb25zdCBvPWUuZ2V0VmFsdWVSZWYobiksXz1lLmdldFZhbHVlUmVmKGgpO3RoaXMuZWRnZUFuZ2xlc1tzLzJdPW8uYW5nbGVUbyhfKX19Y29tcHV0ZVZlcnRleE5vcm1hbHModD0xKXt0aGlzLmdlbmVyYXRlRWRnZUZsYWdzKCk7dGhpcy52ZXJ0aWNlcztjb25zdCBlPXRoaXMuZ2V0RmFjZUF0dHJpYnV0ZSgibm9ybWFscyIpLHM9dGhpcy5hZGRWZXJ0ZXhBdHRyaWJ1dGUoIm5vcm1hbHMiLHIpLGE9ZS5kYXRhLmJ1ZmZlcixpPXMuZGF0YSxuPSh0LGUpPT57aVszKnQrMF09ZS54LGlbMyp0KzFdPWUueSxpWzMqdCsyXT1lLnp9LGg9KHQsZSk9PntsZXQgcyxhO2NvbnN0IGk9dGhpcy5mYWNlRWRnZXNbdF07Zm9yKGNvbnN0IHQgb2YgaSkodGhpcy5lZGdlVmVydHNbMip0XT09ZXx8dGhpcy5lZGdlVmVydHNbMip0KzFdPT1lKSYmKHM/YT10aGlzLmVkZ2VWZWNzW3RdOnM9dGhpcy5lZGdlVmVjc1t0XSk7cmV0dXJuW3MsYV19O2ZvcihsZXQgZT0wO2U8dGhpcy52ZXJ0ZXhFZGdlcy5sZW5ndGg7ZSsrKXtpZihudWxsPT10aGlzLnZlcnRleEVkZ2VzW2VdKWNvbnRpbnVlO2NvbnN0IGk9dGhpcy52ZXJ0ZXhFZGdlc1tlXSxfPVtdLGQ9dD0+e2xldCBlPSExO2Zvcihjb25zdCBzIG9mIF8paWYoZT0tMSE9cy5pbmRleE9mKHQpLGUpYnJlYWs7ZXx8Xy5wdXNoKFt0XSl9O2Zvcihjb25zdCBlIG9mIGkpe2NvbnN0IHM9dGhpcy5lZGdlRmFjZXNbMiplXSxhPXRoaXMuZWRnZUZhY2VzWzIqZSsxXTtpZigtMSE9cyYmLTE9PWEmJnRoaXMuZWRnZUFuZ2xlc1tlXTx0KXtsZXQgdD0tMSxlPS0xO2ZvcihsZXQgaT0wO2k8Xy5sZW5ndGg7aSsrKS0xPT10JiYtMSE9X1tpXS5pbmRleE9mKHMpJiYodD1pKSwtMT09ZSYmLTEhPV9baV0uaW5kZXhPZihhKSYmKGU9aSk7LTE9PXQmJi0xPT1lP18ucHVzaChbcyxhXSk6LTEhPXQmJi0xIT1lP3QhPWUmJihfW3RdPV9bdF0uY29uY2F0KF9bZV0pLF8uc3BsaWNlKGUsMSkpOigtMT09dCYmX1tlXS5wdXNoKHMpLC0xPT1lJiZfW3RdLnB1c2goYSkpfWVsc2UtMSE9cyYmZChzKSwtMSE9YSYmZChhKX1fLnNvcnQoKHQsZSk9PnQubGVuZ3RoPGUubGVuZ3RoPzE6dC5sZW5ndGg+ZS5sZW5ndGg/LTE6MCk7bGV0IGw9ITA7Zm9yKGNvbnN0IHQgb2YgXyl7Y29uc3QgaT1uZXcgcjtmb3IoY29uc3QgcyBvZiB0KXtjb25zdCB0PWgocyxlKSxuPXRbMF0uYW5nbGVUbyh0WzFdKTtpLmFkZEluUGxhY2UoKG89cyxuZXcgcihhLDEyKm8pKS5zY2FsZShuKSl9aS5ub3JtYWxpemVJblBsYWNlKCksbD8obihlLGkpLGw9ITEpOnMuc2V0U3BsaXRWZXJ0ZXhWYWx1ZXMoZSx0LGkpfX12YXIgbztyZXR1cm4gc31jb21wdXRlTnVtVHJpYW5nbGVzKCl7bGV0IHQ9MyxlPTA7Zm9yKGNvbnN0IHMgb2YgdGhpcy5fX2ZhY2VDb3VudHMpZSs9cyoodC0yKSx0Kys7cmV0dXJuIGV9Z2VuZXJhdGVUcmlhbmd1bGF0ZWRJbmRpY2VzKHQsZSxzKXtjb25zdCBhPXRoaXMuY29tcHV0ZU51bVRyaWFuZ2xlcygpO2xldCBpO2k9dDxNYXRoLnBvdygyLDgpP25ldyBVaW50OEFycmF5KDMqYSk6dDxNYXRoLnBvdygyLDE2KT9uZXcgVWludDE2QXJyYXkoMyphKTpuZXcgVWludDMyQXJyYXkoMyphKTtsZXQgcj0wO2NvbnN0IG49ZnVuY3Rpb24odCxhKXt0IGluIHMmJmEgaW4gc1t0XSYmKHQ9ZStzW3RdW2FdKSxpW3JdPXQscisrfSxoPXRoaXMuZ2V0TnVtRmFjZXMoKTtmb3IobGV0IHQ9MDt0PGg7dCsrKXtjb25zdCBlPXRoaXMuZ2V0RmFjZVZlcnRleEluZGljZXModCk7Zm9yKGxldCBzPTA7czxlLmxlbmd0aDtzKyspcz49MyYmKG4oZVswXSx0KSxuKGVbcy0xXSx0KSksbihlW3NdLHQpfXJldHVybiBpfWNvbXB1dGVIYXJkRWRnZXNJbmRpY2VzKHQ9MSl7Y29uc3QgZT1bXSxzPXQ9PntlLnB1c2godGhpcy5lZGdlVmVydHNbdF0pLGUucHVzaCh0aGlzLmVkZ2VWZXJ0c1t0KzFdKX07Zm9yKGxldCBlPTA7ZTx0aGlzLmVkZ2VGbGFncy5sZW5ndGg7ZSs9Mil0aGlzLmVkZ2VBbmdsZXNbZS8yXT50JiZzKGUpO3JldHVybiBlfWdldFdpcmVmcmFtZUluZGljZXMoKXtyZXR1cm4gaW5kaWNlc31nZW5CdWZmZXJzKHQpe2NvbnN0IGU9e307bGV0IHM9MDtmb3IoY29uc3RbLHRdb2YgdGhpcy5fX3ZlcnRleEF0dHJpYnV0ZXMpe2NvbnN0IGE9dC5nZXRTcGxpdHMoKTtmb3IoY29uc3QgdCBpbiBhKXt0IGluIGV8fChlW3RdPXt9KTtjb25zdCBpPWFbdF07Zm9yKGNvbnN0IGEgaW4gaSl7Y29uc3QgaT1wYXJzZUludChhKTtpIGluIGVbdF18fChlW3RdW2ldPXMscysrKX19fWNvbnN0IGE9dGhpcy52ZXJ0aWNlcy5sZW5ndGgsaT1hK3M7bGV0IHI7dCYmMD09dC5pbmNsdWRlSW5kaWNlc3x8KHI9dGhpcy5nZW5lcmF0ZVRyaWFuZ3VsYXRlZEluZGljZXMoaSxhLGUpKTtjb25zdCBuPXt9O2Zvcihjb25zdFt0LGFdb2YgdGhpcy5fX3ZlcnRleEF0dHJpYnV0ZXMpe2xldCBpO2k9MD09cz9hLmRhdGE6YS5nZW5lcmF0ZVNwbGl0VmFsdWVzKGUscyk7Y29uc3Qgcj1hLm51bUVsZW1lbnRzLGg9aS5sZW5ndGgvcjtuW3RdPXt2YWx1ZXM6aSxjb3VudDpoLGRpbWVuc2lvbjpyLG5vcm1hbGl6ZWQ6Im5vcm1hbHMiPT10LGRhdGFUeXBlOmEuZGF0YVR5cGV9fWNvbnN0IGg9e251bVZlcnRpY2VzOnRoaXMubnVtVmVydGljZXMoKSxudW1SZW5kZXJWZXJ0czppLGluZGljZXM6cixhdHRyQnVmZmVyczpufTtpZih0JiZ0LmluY2x1ZGVWZXJ0ZXhOZWlnaGJvcnMpe251bGw9PXRoaXMudmVydGV4RWRnZXMmJnRoaXMuZ2VuVG9wb2xvZ3lJbmZvKCk7bGV0IHQ9MDtmb3IobGV0IGU9MDtlPHRoaXMudmVydGV4RWRnZXMubGVuZ3RoO2UrKyl0aGlzLnZlcnRleEVkZ2VzW2VdJiYodCs9dGhpcy52ZXJ0ZXhFZGdlc1tlXS5zaXplKTtjb25zdCBlPW5ldyBVaW50MzJBcnJheSgyKnRoaXMudmVydGV4RWRnZXMubGVuZ3RoK3QpLHM9dD0+e2ZvcihsZXQgZT0wO2U8dC5sZW5ndGg7ZSsrKXtjb25zdCBzPXRbZV07Zm9yKGxldCBhPTA7YTxlO2ErKyl7Y29uc3QgaT10W2FdO2lmKC0xIT1zWzBdJiZzWzBdPT1pWzFdKXtlIT1hKzEmJih0LnNwbGljZShlLDEpLHQuc3BsaWNlKGErMSwwLHMpKTticmVha31pZigtMSE9c1sxXSYmc1sxXT09aVswXSl7dC5zcGxpY2UoZSwxKSx0LnNwbGljZShhLDAscyk7YnJlYWt9fX19LGE9dD0+e2lmKCEoLTEhPXRbMF1bMF0mJi0xIT10W3QubGVuZ3RoLTFdWzFdfHwtMT09dFswXVswXSYmLTE9PXRbdC5sZW5ndGgtMV1bMV0pKXRocm93IG5ldyBFcnJvcigiSWYgZmFuIHN0YXJ0cyB3aXRoIC0xLCBpdCBtdXN0IGFsc28gZW5kIHdpdGggLTEiKTtmb3IobGV0IGU9MDtlPHQubGVuZ3RoO2UrKyl7Y29uc3Qgcz10W2VdO2lmKCgtMT09c1swXXx8LTE9PXNbMV0pJiYwIT1lJiZlIT10Lmxlbmd0aC0xKXRocm93IG5ldyBFcnJvcigiLTEgb25seSBhbGxvd2VkIGF0IHRoZSBiZWdpbm5pbmcgYW5kIGVuZCBvZiBhIGZhbi4iKTtpZigtMSE9c1swXSl7bGV0IGE9ZS0xO2lmKGE8MCYmKGErPXQubGVuZ3RoKSxzWzBdIT10W2FdWzFdKXRocm93IG5ldyBFcnJvcigiRmFjZXMgYXJlIG5vdCBzZXF1ZW50aWFsIil9aWYoLTEhPXNbMV0pe2NvbnN0IGE9KGUrMSkldC5sZW5ndGg7aWYoc1sxXSE9dFthXVswXSl0aHJvdyBuZXcgRXJyb3IoIkZhY2VzIGFyZSBub3Qgc2VxdWVudGlhbCIpfX19O2xldCBpPTIqdGhpcy52ZXJ0ZXhFZGdlcy5sZW5ndGg7Zm9yKGxldCB0PTA7dDx0aGlzLnZlcnRleEVkZ2VzLmxlbmd0aDt0Kyspe2lmKG51bGw9PXRoaXMudmVydGV4RWRnZXNbdF0pY29udGludWU7Y29uc3Qgcj10aGlzLnZlcnRleEVkZ2VzW3RdLG49W107Zm9yKGNvbnN0IGUgb2Ygcil7Y29uc3Qgcz10aGlzLmVkZ2VWZXJ0c1syKmVdLGE9dGhpcy5lZGdlVmVydHNbMiplKzFdO2xldCBpLHI9dGhpcy5lZGdlRmFjZXNbMiplXSxoPXRoaXMuZWRnZUZhY2VzWzIqZSsxXTtpZihzPT10KWk9YTtlbHNle2lmKGEhPXQpdGhyb3cgbmV3IEVycm9yKCJJbnZhbGlkIHRvcG9sb2d5Iik7e2k9cztjb25zdCB0PXI7cj1oLGg9dH19bi5wdXNoKFtyLGgsaV0pfXMobiksYShuKTtsZXQgaD0wOygtMSE9blswXVswXXx8LTEhPW5bbi5sZW5ndGgtMV1bMV0pJiYoaCs9MSksZVsyKnRdPWksZVsyKnQrMV09ci5zaXplKyhoPDw4KTtmb3IoY29uc3QgdCBvZiBuKWVbaV09dFsyXSxpKyt9aC52ZXJ0ZXhOZWlnaGJvcnM9ZX1yZXR1cm4gaH1mcmVlQnVmZmVycygpe3N1cGVyLmZyZWVCdWZmZXJzKCksdGhpcy5pbml0KCl9cmVhZEJpbmFyeSh0LGUpe3N1cGVyLmxvYWRCYXNlR2VvbUJpbmFyeSh0KSx0aGlzLnNldEZhY2VDb3VudHModC5sb2FkVUludDMyQXJyYXkoKSksdGhpcy5fX2ZhY2VWZXJ0ZXhDb3VudHM9dC5sb2FkVUludDhBcnJheSh0aGlzLl9fZmFjZVZlcnRleENvdW50cy5sZW5ndGgpO2NvbnN0IHM9dC5sb2FkU0ludDMyVmVjMigpLGE9dC5sb2FkVUludDgoKTtsZXQgcjsxPT1hP3I9dC5sb2FkVUludDhBcnJheSgpOjI9PWE/cj10LmxvYWRVSW50MTZBcnJheSgpOjQ9PWEmJihyPXQubG9hZFVJbnQzMkFycmF5KCkpO2NvbnN0IG49dGhpcy5nZXROdW1GYWNlcygpO2xldCBoPTAsbz0wO2ZvcihsZXQgdD0wO3Q8bjt0Kyspe2NvbnN0IGU9dGhpcy5fX2ZhY2VWZXJ0ZXhDb3VudHNbdF0rMzt0aGlzLl9fZmFjZU9mZnNldHNbdF09aDtmb3IobGV0IGE9MDthPGU7YSsrKXtjb25zdCBlPWgrYSxpPXJbZV0rcy54O2lmKDA9PXQpdGhpcy5fX2ZhY2VWZXJ0ZXhJbmRpY2VzW2VdPWk7ZWxzZXtsZXQgcz10aGlzLl9fZmFjZU9mZnNldHNbdC0xXTtzKz1hPG8/YTpvLTEsdGhpcy5fX2ZhY2VWZXJ0ZXhJbmRpY2VzW2VdPXRoaXMuX19mYWNlVmVydGV4SW5kaWNlc1tzXStpfX1oKz1lLG89ZX10aGlzLl9fbnVtUG9wdWxhdGVkRmFjZVZlcnRleEluZGljZXM9aDtjb25zdCBfPXQubG9hZFVJbnQzMigpO2lmKF8+MCl7Y29uc3QgZT10aGlzLnZlcnRpY2VzLHM9dGhpcy5hZGRWZXJ0ZXhBdHRyaWJ1dGUoImxpZ2h0bWFwQ29vcmRzIixpKTtmb3IobGV0IGE9MDthPF87YSsrKXtjb25zdCBhPW5ldyBtKHQubG9hZEZsb2F0MzJWZWMzKCksdC5sb2FkRmxvYXQzMlF1YXQoKSkscj10LmxvYWRGbG9hdDMyKCksbj10LmxvYWRGbG9hdDMyVmVjMigpLGg9dC5sb2FkU0ludDMyVmVjMigpLG89dC5sb2FkVUludDgoKTtsZXQgXztfPTE9PW8/dC5sb2FkVUludDhBcnJheSgpOjI9PW8/dC5sb2FkVUludDE2QXJyYXkoKTp0LmxvYWRVSW50MzJBcnJheSgpO2xldCBkPTA7Zm9yKGNvbnN0IHQgb2YgXyl7bGV0IG89dCtoLng7bys9ZCxkPW87Y29uc3QgXz10aGlzLmdldEZhY2VWZXJ0ZXhJbmRpY2VzKG8pO2Zvcihjb25zdCB0IG9mIF8pe2NvbnN0IGg9ZS5nZXRWYWx1ZVJlZih0KSxfPWEudHJhbnNmb3JtVmVjMyhoKSxkPW5ldyBpKF8ueCxfLnopO2Quc2NhbGVJblBsYWNlKHIpLGQuYWRkSW5QbGFjZShuKSxzLnNldEZhY2VWZXJ0ZXhWYWx1ZV9CeVZlcnRleEluZGV4KG8sdCxkKX19fX10aGlzLmhhc1ZlcnRleEF0dHJpYnV0ZSgibm9ybWFscyIpfHx0aGlzLmNvbXB1dGVWZXJ0ZXhOb3JtYWxzKCksdGhpcy5nZW9tRGF0YUNoYW5nZWQuZW1pdCgpfXRvSlNPTih0LGUpe2NvbnN0IHM9c3VwZXIudG9KU09OKHQsZSk7cmV0dXJuIDEwMjQmZXx8KHMuZmFjZUNvdW50cz1BcnJheS5mcm9tKHRoaXMuX19mYWNlQ291bnRzKSxzLmZhY2VWZXJ0ZXhJbmRpY2VzPUFycmF5LmZyb20odGhpcy5fX2ZhY2VWZXJ0ZXhJbmRpY2VzKSksc31mcm9tSlNPTih0LGUscyl7c3VwZXIuZnJvbUpTT04odCxlLHMpLHQuZmFjZUNvdW50cyYmKHRoaXMuX19mYWNlQ291bnRzPVVpbnQzMkFycmF5LmZyb20odC5mYWNlQ291bnRzKSksdC5mYWNlVmVydGV4SW5kaWNlcyYmKHRoaXMuX19mYWNlVmVydGV4SW5kaWNlcz1VaW50MzJBcnJheS5mcm9tKHQuZmFjZVZlcnRleEluZGljZXMpKX19Y2xhc3MgRXtjb25zdHJ1Y3Rvcih0LGU9MCxzPSEwKXt0aGlzLl9fZGF0YT10LHRoaXMuX19ieXRlT2Zmc2V0PWUsdGhpcy5fX2RhdGFWaWV3PW5ldyBEYXRhVmlldyh0aGlzLl9fZGF0YSksdGhpcy5fX2lzTW9iaWxlRGV2aWNlPXMsdGhpcy51dGY4ZGVjb2Rlcj1uZXcgVGV4dERlY29kZXJ9Z2V0IGlzTW9iaWxlRGV2aWNlKCl7cmV0dXJuIHRoaXMuX19pc01vYmlsZURldmljZX1nZXQgZGF0YSgpe3JldHVybiB0aGlzLl9fZGF0YX1nZXQgYnl0ZUxlbmd0aCgpe3JldHVybiB0aGlzLl9fZGF0YVZpZXcuYnl0ZUxlbmd0aH1nZXQgcmVtYWluaW5nQnl0ZUxlbmd0aCgpe3JldHVybiB0aGlzLl9fZGF0YVZpZXcuYnl0ZUxlbmd0aC10aGlzLl9fYnl0ZU9mZnNldH1wb3MoKXtyZXR1cm4gdGhpcy5fX2J5dGVPZmZzZXR9c2Vlayh0KXt0aGlzLl9fYnl0ZU9mZnNldD10fWFkdmFuY2UodCl7dGhpcy5fX2J5dGVPZmZzZXQrPXR9bG9hZFVJbnQ4KCl7Y29uc3QgdD10aGlzLl9fZGF0YVZpZXcuZ2V0VWludDgodGhpcy5fX2J5dGVPZmZzZXQpO3JldHVybiB0aGlzLl9fYnl0ZU9mZnNldCs9MSx0fWxvYWRVSW50MTYoKXtjb25zdCB0PXRoaXMuX19kYXRhVmlldy5nZXRVaW50MTYodGhpcy5fX2J5dGVPZmZzZXQsITApO3JldHVybiB0aGlzLl9fYnl0ZU9mZnNldCs9Mix0fWxvYWRVSW50MzIoKXtjb25zdCB0PXRoaXMuX19kYXRhVmlldy5nZXRVaW50MzIodGhpcy5fX2J5dGVPZmZzZXQsITApO3JldHVybiB0aGlzLl9fYnl0ZU9mZnNldCs9NCx0fWxvYWRTSW50MzIoKXtjb25zdCB0PXRoaXMuX19kYXRhVmlldy5nZXRJbnQzMih0aGlzLl9fYnl0ZU9mZnNldCwhMCk7cmV0dXJuIHRoaXMuX19ieXRlT2Zmc2V0Kz00LHR9bG9hZEZsb2F0MTYoKXtjb25zdCB0PXRoaXMubG9hZFVJbnQxNigpO3JldHVybiBNYXRoLmRlY29kZTE2Qml0RmxvYXQodCl9bG9hZFVGbG9hdDE2KCl7Y29uc3QgdD10aGlzLmxvYWRGbG9hdDE2KCk7cmV0dXJuIHQ8MD8yMDQ4LXQ6dH1sb2FkRmxvYXQxNkZyb20yeFVJbnQ4KCl7Y29uc3QgdD10aGlzLl9fZGF0YVZpZXcuZ2V0RmxvYXQxNih0aGlzLl9fYnl0ZU9mZnNldCwhMCk7cmV0dXJuIHRoaXMuX19ieXRlT2Zmc2V0Kz0yLHR9bG9hZFVJbnQzMkZyb20yeFVGbG9hdDE2KCl7cmV0dXJuIHRoaXMubG9hZFVGbG9hdDE2KCkrNDA5Nip0aGlzLmxvYWRVRmxvYXQxNigpfWxvYWRTSW50MzJGcm9tMnhGbG9hdDE2KCl7cmV0dXJuIHRoaXMubG9hZEZsb2F0MTYoKSsyMDQ4KnRoaXMubG9hZEZsb2F0MTYoKX1sb2FkRmxvYXQzMigpe2NvbnN0IHQ9dGhpcy5fX2RhdGFWaWV3LmdldEZsb2F0MzIodGhpcy5fX2J5dGVPZmZzZXQsITApO3JldHVybiB0aGlzLl9fYnl0ZU9mZnNldCs9NCx0fWxvYWRVSW50OEFycmF5KHQsZT0hMSl7bnVsbD09dCYmKHQ9dGhpcy5sb2FkVUludDMyKCkpO2NvbnN0IHM9bmV3IFVpbnQ4QXJyYXkodGhpcy5fX2RhdGEsdGhpcy5fX2J5dGVPZmZzZXQsdCk7dGhpcy5fX2J5dGVPZmZzZXQrPXQ7dGhpcy5fX2J5dGVPZmZzZXQ7cmV0dXJuIHN9bG9hZFVJbnQxNkFycmF5KHQsZT0hMSl7aWYobnVsbD09dCYmKHQ9dGhpcy5sb2FkVUludDMyKCkpLDA9PXQpcmV0dXJuIG5ldyBVaW50MTZBcnJheTtsZXQgcztpZih0aGlzLnJlYWRQYWRkKDIpLHRoaXMuX19pc01vYmlsZURldmljZSl7cz1uZXcgVWludDE2QXJyYXkodCk7Zm9yKGxldCBlPTA7ZTx0O2UrKylzW2VdPXRoaXMuX19kYXRhVmlldy5nZXRVaW50MTYodGhpcy5fX2J5dGVPZmZzZXQsITApLHRoaXMuX19ieXRlT2Zmc2V0Kz0yfWVsc2Ugcz1uZXcgVWludDE2QXJyYXkodGhpcy5fX2RhdGEsdGhpcy5fX2J5dGVPZmZzZXQsdCksdGhpcy5fX2J5dGVPZmZzZXQrPTIqdDtyZXR1cm4gc31sb2FkVUludDMyQXJyYXkodCxlPSExKXtpZihudWxsPT10JiYodD10aGlzLmxvYWRVSW50MzIoKSksMD09dClyZXR1cm4gbmV3IFVpbnQzMkFycmF5O2xldCBzO2lmKHRoaXMucmVhZFBhZGQoNCksdGhpcy5fX2lzTW9iaWxlRGV2aWNlKXtzPW5ldyBVaW50MzJBcnJheSh0KTtmb3IobGV0IGU9MDtlPHQ7ZSsrKXNbZV09dGhpcy5fX2RhdGFWaWV3LmdldFVpbnQzMih0aGlzLl9fYnl0ZU9mZnNldCwhMCksdGhpcy5fX2J5dGVPZmZzZXQrPTR9ZWxzZSBzPW5ldyBVaW50MzJBcnJheSh0aGlzLl9fZGF0YSx0aGlzLl9fYnl0ZU9mZnNldCx0KSx0aGlzLl9fYnl0ZU9mZnNldCs9NCp0O3JldHVybiBzfWxvYWRGbG9hdDMyQXJyYXkodCxlPSExKXtpZihudWxsPT10JiYodD10aGlzLmxvYWRVSW50MzIoKSksMD09dClyZXR1cm4gbmV3IEZsb2F0MzJBcnJheTtsZXQgcztpZih0aGlzLnJlYWRQYWRkKDQpLHRoaXMuX19pc01vYmlsZURldmljZSl7cz1uZXcgRmxvYXQzMkFycmF5KHQpO2ZvcihsZXQgZT0wO2U8dDtlKyspc1tlXT10aGlzLl9fZGF0YVZpZXcuZ2V0RmxvYXQzMih0aGlzLl9fYnl0ZU9mZnNldCwhMCksdGhpcy5fX2J5dGVPZmZzZXQrPTR9ZWxzZSBzPW5ldyBGbG9hdDMyQXJyYXkodGhpcy5fX2RhdGEsdGhpcy5fX2J5dGVPZmZzZXQsdCksdGhpcy5fX2J5dGVPZmZzZXQrPTQqdDtyZXR1cm4gc31sb2FkU3RyKCl7Y29uc3QgdD10aGlzLmxvYWRVSW50MzIoKSxlPW5ldyBVaW50OEFycmF5KHRoaXMuX19kYXRhLHRoaXMuX19ieXRlT2Zmc2V0LHQpO3JldHVybiB0aGlzLl9fYnl0ZU9mZnNldCs9dCx0aGlzLnV0ZjhkZWNvZGVyLmRlY29kZShlKX1sb2FkU3RyQXJyYXkoKXtjb25zdCB0PXRoaXMubG9hZFVJbnQzMigpLGU9W107Zm9yKGxldCBzPTA7czx0O3MrKyllW3NdPXRoaXMubG9hZFN0cigpO3JldHVybiBlfWxvYWRTSW50MzJWZWMyKCl7Y29uc3QgdD10aGlzLmxvYWRTSW50MzIoKSxlPXRoaXMubG9hZFNJbnQzMigpO3JldHVybiBuZXcgaSh0LGUpfWxvYWRVSW50MzJWZWMyKCl7Y29uc3QgdD10aGlzLmxvYWRVSW50MzIoKSxlPXRoaXMubG9hZFVJbnQzMigpO3JldHVybiBuZXcgaSh0LGUpfWxvYWRGbG9hdDE2VmVjMigpe2NvbnN0IHQ9dGhpcy5sb2FkRmxvYXQxNigpLGU9dGhpcy5sb2FkRmxvYXQxNigpO3JldHVybiBuZXcgaSh0LGUpfWxvYWRGbG9hdDMyVmVjMigpe2NvbnN0IHQ9dGhpcy5sb2FkRmxvYXQzMigpLGU9dGhpcy5sb2FkRmxvYXQzMigpO3JldHVybiBuZXcgaSh0LGUpfWxvYWRGbG9hdDE2VmVjMygpe2NvbnN0IHQ9dGhpcy5sb2FkRmxvYXQxNigpLGU9dGhpcy5sb2FkRmxvYXQxNigpLHM9dGhpcy5sb2FkRmxvYXQxNigpO3JldHVybiBuZXcgcih0LGUscyl9bG9hZEZsb2F0MzJWZWMzKCl7Y29uc3QgdD10aGlzLmxvYWRGbG9hdDMyKCksZT10aGlzLmxvYWRGbG9hdDMyKCkscz10aGlzLmxvYWRGbG9hdDMyKCk7cmV0dXJuIG5ldyByKHQsZSxzKX1sb2FkRmxvYXQxNlF1YXQoKXtjb25zdCB0PXRoaXMubG9hZEZsb2F0MTYoKSxlPXRoaXMubG9hZEZsb2F0MTYoKSxzPXRoaXMubG9hZEZsb2F0MTYoKSxhPXRoaXMubG9hZEZsb2F0MTYoKTtyZXR1cm4gbmV3IHUodCxlLHMsYSl9bG9hZEZsb2F0MzJRdWF0KCl7Y29uc3QgdD10aGlzLmxvYWRGbG9hdDMyKCksZT10aGlzLmxvYWRGbG9hdDMyKCkscz10aGlzLmxvYWRGbG9hdDMyKCksYT10aGlzLmxvYWRGbG9hdDMyKCk7cmV0dXJuIG5ldyB1KHQsZSxzLGEpfWxvYWRSR0JGbG9hdDMyQ29sb3IoKXtjb25zdCB0PXRoaXMubG9hZEZsb2F0MzIoKSxlPXRoaXMubG9hZEZsb2F0MzIoKSxzPXRoaXMubG9hZEZsb2F0MzIoKTtyZXR1cm4gbmV3IG8odCxlLHMpfWxvYWRSR0JBRmxvYXQzMkNvbG9yKCl7Y29uc3QgdD10aGlzLmxvYWRGbG9hdDMyKCksZT10aGlzLmxvYWRGbG9hdDMyKCkscz10aGlzLmxvYWRGbG9hdDMyKCksYT10aGlzLmxvYWRGbG9hdDMyKCk7cmV0dXJuIG5ldyBvKHQsZSxzLGEpfWxvYWRSR0JVSW50OENvbG9yKCl7Y29uc3QgdD10aGlzLmxvYWRVSW50OCgpLGU9dGhpcy5sb2FkVUludDgoKSxzPXRoaXMubG9hZFVJbnQ4KCk7cmV0dXJuIG5ldyBvKHQvMjU1LGUvMjU1LHMvMjU1KX1sb2FkUkdCQVVJbnQ4Q29sb3IoKXtjb25zdCB0PXRoaXMubG9hZFVJbnQ4KCksZT10aGlzLmxvYWRVSW50OCgpLHM9dGhpcy5sb2FkVUludDgoKSxhPXRoaXMubG9hZFVJbnQ4KCk7cmV0dXJuIG5ldyBvKHQvMjU1LGUvMjU1LHMvMjU1LGEvMjU1KX1sb2FkQm94Migpe3JldHVybiBuZXcgZyh0aGlzLmxvYWRGbG9hdDMyVmVjMigpLHRoaXMubG9hZEZsb2F0MzJWZWMyKCkpfWxvYWRCb3gzKCl7cmV0dXJuIG5ldyBwKHRoaXMubG9hZEZsb2F0MzJWZWMzKCksdGhpcy5sb2FkRmxvYXQzMlZlYzMoKSl9cmVhZFBhZGQodCl7Y29uc3QgZT10aGlzLl9fYnl0ZU9mZnNldCV0OzAhPWUmJih0aGlzLl9fYnl0ZU9mZnNldCs9dC1lKX19Y2xhc3Mgdntjb25zdHJ1Y3Rvcih0KXtpZih0KXtjb25zdCBlPXQuc3BsaXQoIi0iKSxzPWVbMF0uc3BsaXQoIi4iKTt0aGlzLm1ham9yPXBhcnNlSW50KHNbMF0pLHRoaXMubWlub3I9cGFyc2VJbnQoc1sxXSksdGhpcy5wYXRjaD1wYXJzZUludChzWzJdKSwyPT1lLmxlbmd0aCYmKHRoaXMuYnJhbmNoPWVbMV0pfWVsc2UgdGhpcy5tYWpvcj0wLHRoaXMubWlub3I9MCx0aGlzLnBhdGNoPTB9ZXF1YWxzKHQpe3JldHVybiEodGhpcy5wYXRjaD09dFsyXSYmdGhpcy5taW5vcj09dFsxXSYmdGhpcy5tYWpvcj09dFswXSl9bGVzc1RoYW4odCl7cmV0dXJuISh0aGlzLm1ham9yPj10WzBdfHx0aGlzLm1pbm9yPj10WzFdfHx0aGlzLnBhdGNoPj10WzJdKX1ncmVhdGVyVGhhbih0KXtyZXR1cm4gdGhpcy5tYWpvcj50WzBdfHx0aGlzLm1pbm9yPnRbMV18fHRoaXMucGF0Y2g+dFsyXX1ncmVhdGVyT3JFcXVhbFRoYW4odCl7cmV0dXJuISh0aGlzLm1ham9yPHRbMF0pJiYodGhpcy5tYWpvcj50WzBdfHwhKHRoaXMubWlub3I8dFsxXSkmJih0aGlzLm1pbm9yPnRbMV18fCEodGhpcy5wYXRjaDx0WzJdKSkpfX1zZWxmLm9ubWVzc2FnZT1mdW5jdGlvbih0KXsoKHQsZSk9Pntmb3IobGV0IGUgaW4gdC5jb250ZXh0LnZlcnNpb25zKXtjb25zdCBzPXQuY29udGV4dC52ZXJzaW9uc1tlXSxhPW5ldyB2O2EubWFqb3I9cy5tYWpvcixhLm1pbm9yPXMubWlub3IsYS5wYXRjaD1zLnBhdGNoLGEuYnJhbmNoPXMuYnJhbmNoLHQuY29udGV4dC52ZXJzaW9uc1tlXT1hfWNvbnN0IHM9W10saT10LnRvY1t0Lmdlb21zUmFuZ2VbMF1dLHI9W107Zm9yKGxldCBlPXQuZ2VvbXNSYW5nZVswXTtlPHQuZ2VvbXNSYW5nZVsxXTtlKyspe2NvbnN0IG49bmV3IEUodC5idWZmZXJTbGljZSx0LnRvY1tlXS1pLHQuaXNNb2JpbGVEZXZpY2UpLGg9bi5sb2FkU3RyKCksbz1uLnBvcygpO2xldCBfO3N3aXRjaChoKXtjYXNlIlBvaW50cyI6Xz1uZXcgQTticmVhaztjYXNlIkxpbmVzIjpfPW5ldyBTO2JyZWFrO2Nhc2UiTWVzaCI6Xz1uZXcgUDticmVhaztkZWZhdWx0OnRocm93IG5ldyBFcnJvcigiVW5zdXBwb3J0ZWQgR2VvbSB0eXBlOiIraCl9dHJ5e24uc2VlayhvKSxfLnJlYWRCaW5hcnkobix0LmNvbnRleHQpfWNhdGNoKHQpe2NvbnNvbGUud2FybigiRXJyb3IgbG9hZGluZzoiK18ubmFtZSsiXG46Iit0KSxzLnB1c2goe30pO2NvbnRpbnVlfWNvbnN0IGQ9Xy5nZW5CdWZmZXJzKHQuZ2VuQnVmZmVyc09wdHMpO2QuaW5kaWNlcyYmci5wdXNoKGQuaW5kaWNlcy5idWZmZXIpO2Zvcihjb25zdCB0IGluIGQuYXR0ckJ1ZmZlcnMpe2NvbnN0IGU9ZC5hdHRyQnVmZmVyc1t0XSxzPWEuZ2V0VHlwZU5hbWUoZS5kYXRhVHlwZSk7ZS5kYXRhVHlwZT1zLHIucHVzaChlLnZhbHVlcy5idWZmZXIpfWQudmVydGV4TmVpZ2hib3JzJiZyLnB1c2goZC52ZXJ0ZXhOZWlnaGJvcnMuYnVmZmVyKSxyLnB1c2goXy5ib3VuZGluZ0JveC5wMC5fX2RhdGEuYnVmZmVyKSxyLnB1c2goXy5ib3VuZGluZ0JveC5wMS5fX2RhdGEuYnVmZmVyKSxzLnB1c2goe25hbWU6Xy5uYW1lLHR5cGU6aCxnZW9tQnVmZmVyczpkLGJib3g6Xy5ib3VuZGluZ0JveH0pfWUoe2tleTp0LmtleSxnZW9tSW5kZXhPZmZzZXQ6dC5nZW9tSW5kZXhPZmZzZXQsZ2VvbXNSYW5nZTp0Lmdlb21zUmFuZ2UsZ2VvbURhdGFzOnN9LHIpfSkodC5kYXRhLCh0LGUpPT57c2VsZi5wb3N0TWVzc2FnZSh0LGUpfSl9OwoK",null,!1);class is{constructor(){this.rangeLoaded=new v,this.streamFileParsed=new v,this.loaded=new v(!0),this.__streamInfos={},this.__genBuffersOpts={},this.__workers=[],this.__nextWorker=0;for(let t=0;t<3;t++)this.__workers.push(this.__constructWorker());this.clear()}clear(){this.__loaded=0,this.__numGeoms=0,this.geoms=[]}__constructWorker(){const t=new ts;return t.onmessage=t=>{this.__recieveGeomDatas(t.data.key,t.data.geomDatas,t.data.geomIndexOffset,t.data.geomsRange)},t}__terminateWorkers(){for(const t of this.__workers)t.terminate();this.__workers=[]}setGenBufferOption(t,i){this.__genBuffersOpts[t]=i}setNumGeoms(t){this.__numGeoms=t}getGeom(t){return t>=this.geoms.length?null:this.geoms[t]}loadUrl(t){$(t,t=>{this.loadBin(t)},t=>{console.warn(t)})}readBinaryBuffer(t,i,s){const n=e.isMobileDevice,l=new ct(i,0,n),h=l.loadUInt32(),o=l.loadUInt32();if(this.__streamInfos[t]={total:h,done:0},0==h)return this.streamFileParsed.emit(1),h;0==this.__numGeoms&&(this.__numGeoms=h);const a=l.loadUInt32Array(h);let c=window.navigator.hardwareConcurrency;c||(c=n?2:4);const r=Math.max(1,Math.floor(h/c+1));let d=0;for(;d<h;){let e,n;d+r>=h?(n=[d,h],e=i.byteLength):(n=[d,d+r],e=a[n[1]]);const c=i.slice(a[d],e);d+=r,this.__workers[this.__nextWorker].postMessage({key:t,toc:a,geomIndexOffset:o,geomsRange:n,isMobileDevice:l.isMobileDevice,bufferSlice:c,genBuffersOpts:this.__genBuffersOpts,context:s},[c]),this.__nextWorker=(this.__nextWorker+1)%this.__workers.length}return h}__recieveGeomDatas(t,i,s,e){const n=s+e[0],l=[n,s+e[1]];for(let t=0;t<i.length;t++){const s=i[t];if(!s.type)continue;let e;switch(s.type){case"Points":e=new Li(s);break;case"Lines":e=new xi(s);break;case"Mesh":case"Plane":case"Sphere":case"Cone":e=new vi(s);break;default:throw new Error("Unsupported Geom type:"+className)}this.geoms[n+t]=e}this.rangeLoaded.emit(l);const h=l[1]-l[0],o=this.__streamInfos[t];o.done+=h,o.done==o.total&&this.streamFileParsed.emit(1),this.__loaded+=h,this.__loaded==this.__numGeoms&&(this.__terminateWorkers(),this.loaded.emit())}toJSON(){return{numGeoms:this.geoms.length()}}toString(){return JSON.stringify(this.toJSON(),null,2)}}class ss extends Qi{constructor(t){super(t),this.__geomLibrary=new is,this.__materials=new Gi,this.loaded=new v(!0),this.loaded.setToggled(!0)}isLoaded(){return this.loaded.isToggled()}getEngineDataVersion(){return this.__engineDataVersion}getGeometryLibrary(){return this.__geomLibrary}getMaterialLibrary(){return this.__materials}getUnitsConversion(){return this.__unitsScale}readBinary(t,i={}){let s;i.assetItem=this,i.numTreeItems=0,i.numGeomItems=0,i.versions["zea-engine"]||(i.versions["zea-engine"]=new ot(t.loadStr())),this.__engineDataVersion=i.versions["zea-engine"],console.log("Loading Engine File version:",i.versions["zea-engine"]);const e={};i.addGeomToLayer=(t,i)=>{if(!e[i]){s||(s=new Qi("Layers"),this.addChild(s,!1));const t=new $i(i);t.propagateXfoToItems=!1,s.addChild(t,!1),e[i]=t}e[i].addItem(t)};const n=()=>{this.__units=t.loadStr();let i=1;switch(this.__units){case"Millimeters":i=.001;break;case"Centimeters":i=.01;break;case"Meters":i=1;break;case"Kilometers":i=1e3;break;case"Inches":i=.0254;break;case"Feet":i=.3048;break;case"Miles":i=1609.34}this.__unitsScale=i;const s=this.getLocalXfo().clone();s.sc.scaleInPlace(i),this.setLocalXfo(s)};i.versions["zea-engine"].greaterThan([0,0,6])&&n(),this.__materials.readBinary(t,i),super.readBinary(t,i),i.versions["zea-engine"].greaterOrEqualThan([0,0,5])&&i.versions["zea-engine"].lessThan([0,0,7])&&n()}toJSON(t={},i=0){return t.makeRelative=t=>{const i=this.getPath(),s=t.slice(0,i.length);for(let e=0;e<s.length-1;e++)if(s[e]!=i[e])return console.warn("Param Path is not relative to the asset. May not be able to be resolved at load time:"+t),t;const e=t.slice(i.length-1);return e[0]=".",e},t.assetItem=this,super.toJSON(t,i)}fromJSON(t,i={},s=0,e){i||(i={}),i.assetItem=this,i.numTreeItems=0,i.numGeomItems=0,null==i.version&&(i.version=0),i.assetItem=this;const n=[];i.resolvePath=(t,i)=>{if(!t)throw new Error("Path not spcecified");const s=this.resolvePath(t);s?i(s):n.push(()=>{const s=this.resolvePath(t);s?i(s):console.warn("Path unable to be resolved:"+t)})},i.addPLCB=t=>n.push(t),super.fromJSON(t,i,s);for(const t of n)t();e&&e()}}N.registerClass("AssetItem",ss);class es extends Qi{constructor(t,i){super(t);const s=this.addParameter(new gt("image"));i&&s.setValue(i),this.addParameter(new ut("scale",.01)),this.addParameter(new ut("alpha",1)),this.addParameter(new Xt("color",new p(1,1,1))),this.addParameter(new bt("alignedToCamera",!1));const e=this.addParameter(new pt("lineStartOffset")),n=this.addParameter(new St("lineEnd",u)),l=[],h=new Nt("LabelLinesMaterial","LinesShader");h.getParameter("Color").setValue(new p(0,0,0),J.OPERATOR_SETVALUE),h.getParameter("Opacity").setValue(1,J.OPERATOR_SETVALUE),n.elementAdded.connect((t,i)=>{const s=new Wi;s.setNumVertices(2),s.setNumSegments(1),s.setSegment(0,0,1);const e=new _i("line"+i);e.setGeometry(s,J.OPERATOR_SETVALUE),e.setMaterial(h,J.OPERATOR_SETVALUE),l[i]=e,o(i),this.addChild(e,!1)}),n.elementRemoved.connect(()=>{});const o=t=>{const i=this.__globalXfoParam.getValue().inverse(),s=e.getValue(),h=n.getValue()[t],o=l[t].getGeometry();o.setVertex(0,s),o.setVertex(1,i.transformVec3(h))},a=()=>{for(let t=0;t<l.length;t++)o(t)};e.valueChanged.connect(a),n.valueChanged.connect(a),this.__globalXfoParam.valueChanged.connect(a)}toJSON(t,i){return super.toJSON(t,i)}fromJSON(t,i,s){return super.fromJSON(t,i,s)}}N.registerClass("BillboardItem",es);class ns extends Qi{constructor(t){null==t&&(t="Camera"),super(t),this.__isOrthographicParam=this.addParameter(new bt("isOrthographic",!1)),this.__fovParam=this.addParameter(new ut("fov",1)),this.__nearParam=this.addParameter(new ut("near",.1)),this.__farParam=this.addParameter(new ut("far",1e3)),this.__focalDistanceParam=this.addParameter(new ut("focalDistance",5)),this.projectionParamChanged=new v,this.movementFinished=new v,this.__isOrthographicParam.valueChanged.connect(this.projectionParamChanged.emit),this.__fovParam.valueChanged.connect(this.projectionParamChanged.emit),this.__nearParam.valueChanged.connect(this.projectionParamChanged.emit),this.__farParam.valueChanged.connect(this.projectionParamChanged.emit),this.setPositionAndTarget(new u(3,3,1.75),new u(0,0,1),J.GENERATED_VALUE),this.setLensFocalLength("28mm",J.GENERATED_VALUE)}getNear(){return this.__nearParam.getValue()}setNear(t){this.__nearParam.setValue(t)}getFar(){return this.__farParam.getValue()}setFar(t){this.__farParam.setValue(t)}getFov(){return this.__fovParam.getValue()}setFov(t){this.__fovParam.setValue(t)}setLensFocalLength(t,i=J.USER_SETVALUE){const s={"10mm":100.4,"11mm":95,"12mm":90,"14mm":81.2,"15mm":77.3,"17mm":70.4,"18mm":67.4,"19mm":64.6,"20mm":61.9,"24mm":53.1,"28mm":46.4,"30mm":43.6,"35mm":37.8,"45mm":29.9,"50mm":27,"55mm":24.6,"60mm":22.6,"70mm":19.5,"75mm":18.2,"80mm":17.1,"85mm":16.1,"90mm":15.2,"100mm":13.7,"105mm":13,"120mm":11.4,"125mm":11,"135mm":10.2,"150mm":9.1,"170mm":8.1,"180mm":7.6,"210mm":6.5,"300mm":4.6,"400mm":3.4,"500mm":2.7,"600mm":2.3,"800mm":1.7};!t in s?console.warn("Camera lense focal length not suported:"+t):this.__fovParam.setValue(Math.degToRad(s[t]),i)}getFocalDistance(){return this.__focalDistanceParam.getValue()}setFocalDistance(t,i=J.USER_SETVALUE){t<1e-4&&console.error("Never set focal distance to zero"),this.__focalDistanceParam.setValue(t,i),this.__nearParam.setValue(.01*t,i),this.__farParam.setValue(200*t,i)}getIsOrthographic(){return this.__isOrthographicParam.getValue()}setIsOrthographic(t,i=J.USER_SETVALUE){this.__isOrthographicParam.setValue(t,i)}setPositionAndTarget(t,i,s=J.USER_SETVALUE){this.setFocalDistance(t.distanceTo(i),s);const e=new g;e.setLookAt(t,i,new u(0,0,1)),this.setGlobalXfo(e,s)}getTargetPostion(){const t=this.__focalDistanceParam.getValue(),i=this.getGlobalXfo(),s=i.ori.getZaxis();return s.scaleInPlace(-t),s.addInPlace(i.tr),s}frameView(t,i,s=J.USER_SETVALUE){const e=new I;for(const t of i)e.addBox3(t.getBoundingBox());if(!e.isValid())return void console.warn("Bounding box not valid.");const n=this.__focalDistanceParam.getValue(),l=this.__fovParam.getValue(),h=this.getGlobalXfo().clone(),o=h.ori.getZaxis(),a=o.scale(-n),c=h.tr.add(a),r=e.center().subtract(c);h.tr.addInPlace(r);const d=new I;d.addBox3(e,h.inverse()),d.center();const u=l*(t.getWidth()/t.getHeight()),m=d.p1,b=Math.abs(m.x)/Math.tan(.5*u)*1.2,Z=Math.abs(m.y)/Math.tan(.5*l)*1.2,p=-.5*(d.p0.z-d.p1.z),G=Math.max(b,Z)+p;h.tr.addInPlace(o.scale(G-n)),this.setFocalDistance(G,s),this.setGlobalXfo(h,s),this.movementFinished.emit()}updateProjectionMatrix(t,i){this.__isOrthographicParam.getValue();const s=this.__fovParam.getValue(),e=this.__nearParam.getValue(),n=this.__farParam.getValue();t.setPerspectiveMatrix(s,i,e,n)}}N.registerClass("Camera",ns);class ls extends Q{constructor(t){super(t),this.addParameter(new Xt("BackgroundColor",new p("#808080"))),this.addParameter(new gt("EnvMap")),this.addParameter(new bt("Display EnvMap",!1)),this.addParameter(new ut("EnvMapLOD",0))}}class hs extends ss{constructor(t){super(t),this.loaded.setToggled(!1),this.lightmap=null,this.geomsLoaded=new v(!0),this.geomsLoaded.setToggled(!1),this.loaded.setToggled(!1),this.__geomLibrary.loaded.connect(()=>{this.geomsLoaded.emit()}),this.__datafileParam=this.addParameter(new It("DataFilePath")),this.__datafileParam.valueChanged.connect(()=>{const t=this.__datafileParam.getFileDesc();if(t){if(console.log(t),this.getName()==N.getClassName(this)){const t=this.__datafileParam.getStem();this.setName(t)}this.geomsLoaded.setToggled(!1),this.loadDataFile(()=>{this.loaded.isToggled()||this.loaded.emit()},()=>{})}}),this.addParameter(new Xt("LightmapTint",new p(1,1,1,1)))}getLightmap(){return this.lightmap}readBinary(t,i){if(-1!=i.version){const t=new ot;t.patch=i.version,i.versions={"zea-mesh":t,"zea-engine":t},i.meshSdk="FBX"}else{const s=t.loadUInt8();if(t.seek(0),10!=s){const s=new ot;s.patch=t.loadUInt32(),i.versions={"zea-mesh":s,"zea-engine":s},i.meshSdk="FBX"}else{const s=new ot(t.loadStr());i.versions={"zea-mesh":s},i.meshSdk="FBX"}}this.meshfileversion=i.versions["zea-mesh"],this.meshSdk=i.meshSdk,console.log("Loading CAD File version:",i.versions["zea-mesh"]," exported using SDK:",i.meshSdk);const s=t.loadUInt32();return super.readBinary(t,i),i.versions["zea-engine"].lessThan([0,0,5])&&t.seek(t.byteLength-4),this.__geomLibrary.setNumGeoms(t.loadUInt32()),s}loadDataFile(t,i){const s=this.__datafileParam.getFileDesc();if(!s)return void console.warn("VLAAsset data file not found.");const n=this.__datafileParam.getFileFolderPath(),l=this.__datafileParam.getValue(),h=this.__datafileParam.getStem();let o=0;const a=new RegExp("\\.(vla)$","i").test(s.name),c=[],r=s=>{let n,h=-1;if(s.tree2)n=new ct(s.tree2.buffer,0,e.isMobileDevice);else{const t=s.tree?s.tree:s[Object.keys(s)[0]];n=new ct(t.buffer,0,e.isMobileDevice),h=0}o=this.readBinary(n,{assetItem:this,version:h}),a||o!=c.length&&console.error("The number of GeomFiles does not match the count given by the VLA file."),t(),0==o&&s.geoms0?(ht.addWork(l+"geoms",1),this.__geomLibrary.readBinaryBuffer(l,s.geoms0.buffer,{version:h}),i()):(ht.addWork(l+"geoms",4*o),d())},d=()=>{const t=[];for(let i=0;i<o;i++)if(a){const s=n+h+i+".vlageoms",e=ht.resolveFilepath(s);if(!e)throw new Error("VLA Geoms file not found:"+s);t.push(u(i,e.url))}else t.push(u(i,c[i].url));Promise.all(t).then(()=>{i&&i()})},u=(t,i)=>new Promise(s=>{ht.loadUrl(l+t,i,t=>{const i=t[Object.keys(t)[0]];this.__geomLibrary.readBinaryBuffer(l,i.buffer),s()},!1)});if(a)ht.loadResource(l,r);else if(s.metadata.ConvertFile){let t;s.metadata.ConvertFile.map(i=>{i.filename.endsWith(".vla")?t=i:i.filename.endsWith(".vlageoms")&&c.push(i)}),t?ht.loadUrl(l,t.url,r):console.warn("ConvertFile metadata contains no vla file.")}this.__geomLibrary.streamFileParsed.connect(t=>{ht.addWorkDone(l+"geoms",t)})}fromJSON(t,i,s){i||(i={}),i.assetItem=this;const e=()=>{super.fromJSON(t,i,s),s&&s()};if(t.params&&t.params.DataFilePath){this.__datafileLoaded=e;const s=t.params.DataFilePath;delete t.params.DataFilePath,this.__datafileParam.fromJSON(s,i)}else e()}}N.registerClass("VLAAsset",hs);const os=new p("#DCDCDC");class as{constructor(t){t&&ht.setResources(t),this.settings=new ls("Scene Settings"),this.root=new Qi("root"),this.root.addChild(this.settings),this.__commonResources={}}getSettings(){return this.settings}getRoot(){return this.root}getResourceLoader(){return ht}setEnvMap(t){console.warn("Deprecated Function. Please access the Scene Settings object."),this.settings.getParameter("EnvMap").setValue(t)}addAsset(t){console.warn("Deprecated Function. Please access the Scene Root object."),this.root.addChild(t,!1)}setupGrid(t=5,i=50,s=os){const e=new Qi("Grid"),n=new Nt("gridMaterial","LinesShader");n.getParameter("BaseColor").setValue(s);const l=new Fi(t,t,i,i,!0);e.addChild(new _i("GridItem",l,n),!1);const h=new Wi;h.setNumVertices(2),h.setNumSegments(1),h.setSegment(0,0,1),h.getVertex(0).set(-.5*t,0,0),h.getVertex(1).set(.5*t,0,0);const o=new Nt("gridXAxisMaterial","LinesShader");o.getParameter("BaseColor").setValue(new p(s.luminance(),0,0)),e.addChild(new _i("xAxisLine",h,o),!1);const a=new Nt("gridZAxisMaterial","LinesShader");a.getParameter("BaseColor").setValue(new p(0,s.luminance(),0));const c=new g;c.ori.setFromAxisAndAngle(new u(0,0,1),.5*Math.PI);const r=new _i("yAxisLine",h,a);return r.setGeomOffsetXfo(c),e.addChild(r,!1),e.setSelectable(!1,!0),e.setFlag(P.IGNORE_BBOX),e.clearFlag(P.USER_EDITED),e.setFlag(P.INVISIBLE),this.root.addChild(e,!1),e}loadCommonAssetResource(t){if(t in this.__commonResources)return this.__commonResources[t];const i=new hs;return i.getParameter("DataFilePath").setValue(t),this.__commonResources[t]=i,i}toJSON(t={},i=0){return t.makeRelative=t=>t,{root:this.root.toJSON(t,i)}}fromJSON(t,i={}){const s=[];i.resolvePath=(t,i)=>{if(!t)throw new Error("Path not spcecified");const e=this.root.resolvePath(t);e?i(e):s.push(()=>{const s=this.resolvePath(t);s?i(s):console.warn("Path unable to be resolved:"+t)})},i.addPLCB=t=>s.push(t),i.settings=this.settings,t.root&&this.root.fromJSON(t.root,i);for(const t of s)t()}}class cs extends ss{constructor(t){super(t),this.geomsLoaded=new v(!0),this.geomsLoaded.setToggled(!1),this.loaded.setToggled(!1),this.addParameter(new bt("splitObjects",!1)),this.addParameter(new bt("splitGroupsIntoObjects",!1)),this.addParameter(new bt("loadMtlFile",!0)),this.addParameter(new ut("unitsConversion",1)),this.addParameter(new Rt("defaultShader","")),this.objfileParam=this.addParameter(new It("ObjFilePath")),this.objfileParam.valueChanged.connect(()=>{this.loaded.untoggle(),this.__loadObj(()=>{this.loaded.emit()},()=>{this.geomsLoaded.emit()})}),this.geomLibrary=new is,this.materials=new Gi}getGeometryLibrary(){return this.geomLibrary}getMaterialLibrary(){return this.materials}__loadObj(t,i){const s=this.objfileParam.getStem(),e=t=>{const i=t.split("\n"),s=/\s+/;let e;const n=function(t){if(3==t.length)return new p(parseFloat(t[0]),parseFloat(t[1]),parseFloat(t[2]));throw new Error("Unable to parse a color from the following parts:"+t.join("_"))},l=t=>{const i=this.objfileParam.getFileFolder();return new FileImage(t[0],i+t[0])};for(let t=0;t<i.length;t++){let h=i[t].trim();if(h.startsWith("#"))continue;-1!=h.indexOf("#")&&(h=h.substring(0,h.indexOf("#")).trim());const o=h.split(s),a=o.shift(),c=o.join(" ");switch(a){case"newmtl":e=new Nt(c),e.setShaderName("StandardSurfaceShader"),this.materials.addMaterial(e);break;case"Kd":e.getParameter("BaseColor").setValue(n(o));break;case"map_Kd":e.getParameter("BaseColor").setValue(l(o));break;case"Ks":const t=(parseFloat(o[0])+parseFloat(o[1])+parseFloat(o[2]))/3;e.roughness=1-t,e.getParameter("Roughness").setValue(1-t),e.getParameter("Reflectance").setValue(t);break;case"map_Ks":e.getParameter("Roughness").setValue(l(o)),e.getParameter("Reflectance").setValue(.2);break;case"d":const i=parseFloat(c);i<1&&(e.setShaderName("TransparentSurfaceShader"),e.getParameter("Opacity").setValue(i));break;case"map_d":e.getParameter("alpha").setValue(parseFloat(o));break;case"map_bump":e.getParameter("normal").setValue(l(o))}}},n=new M;n.incAsyncCount(),n.ready.connect(()=>{m()});const l=t=>new Promise(i=>{A(t.url,t=>{ht.addWorkDone(s,1),e(t),n.decAsyncCount(),ht.addWorkDone(s,1),i()})}),h=new Array,o=new Array,a=new Array,c={},r=async t=>{const i=t.split("\n"),e=/\s+/;let r=void 0,d=void 0;const u=t=>{let i=0;for(;t in c;)i++,t+=String(i);r={verticesRemapping:{},texCoordsRemapping:{},normalsRemapping:{},vertexIndices:[],texCoordIndices:[],normalIndices:[],numVertices:0,numTexCoords:0,numNormals:0,numTris:0,numQuads:0,material:d},c[t]=r};u(s);const m=this.getParameter("splitGroupsIntoObjects").getValue();for(let t=0;t<i.length;t++){let b=i[t].trim();if(b.startsWith("#"))continue;-1!=b.indexOf("#")&&(b=b.substring(0,b.indexOf("#")).trim());const Z=b.split(e),p=Z.shift(),G=Z.join(" ");switch(p){case"":case"s":continue;case"mtllib":if(!this.getParameter("loadMtlFile").getValue())continue;n.incAsyncCount(),ht.addWork(s,2);const t=this.objfileParam.getFileFolderPath(),i=ht.resolveFilepath(t+G);i&&await l(i);break;case"o":u(G);break;case"usemtl":d=G,u(G+Object.keys(c).length);break;case"g":m&&u(Z.join("_"));break;case"v":h.push(Z.map(t=>parseFloat(t)));break;case"vt":a.push(Z.map(t=>parseFloat(t)));break;case"vn":o.push(Z.map(t=>parseFloat(t)));break;case"f":{const t=[],i=[],s=[];for(let e=0,n=Z.length;e<n;e++){const n=Z[e].split("/").map(t=>parseInt(t)-1),l=n[0];let h=r.verticesRemapping[l];null==h&&(h=r.numVertices,r.verticesRemapping[l]=h,r.numVertices++),t.push(h),n.length>1&&!isNaN(n[1])&&i.push(n[1]),n.length>2&&!isNaN(n[2])&&s.push(n[2])}r.vertexIndices.push(t),s.length>0&&r.normalIndices.push(s),i.length>0&&r.texCoordIndices.push(i),3==t.length?r.numTris++:r.numQuads++;break}default:console.warn("Unhandled line:"+b)}}n.decAsyncCount()},m=()=>{for(const t in c)0!=c[t].numVertices&&b(t,c[t]);t(),i()},b=(t,i)=>{const s=i.numVertices,e=new Ii(t);e.setFaceCounts([i.numTris,i.numQuads]),e.setNumVertices(s);const n=e.getVertexAttribute("positions"),l=this.getParameter("unitsConversion").getValue();for(const t in i.verticesRemapping)n.getValueRef(i.verticesRemapping[t]).set(h[t][0]*l,h[t][1]*l,h[t][2]*l);let c,r;i.normalIndices.length>0&&(c=e.addVertexAttribute("normals",u)),i.texCoordIndices.length>0&&(r=e.addVertexAttribute("texCoords",d));for(let t=0;t<i.vertexIndices.length;t++){if(e.setFaceVertexIndices(t,...i.vertexIndices[t]),c){const s=i.normalIndices[t];for(let i=0;i<s.length;i++){const e=new u(o[s[i]][0],o[s[i]][1],o[s[i]][2]);c.setFaceVertexValue(t,i,e)}}if(r&&i.texCoordIndices.length==i.vertexIndices.length){const s=i.texCoordIndices[t];for(let i=0;i<s.length;i++){const e=new d(a[s[i]][0],a[s[i]][1]);r.setFaceVertexValue(t,i,e)}}}const m=new _i(t,e);m.selectable=!0;const b=e.boundingBox.center();if(e.moveVertices(b.negate()),m.setLocalXfo(new g(b)),null!=i.material&&this.materials.hasMaterial(i.material))m.setMaterial(this.materials.getMaterial(i.material));else{const i=this.getParameter("defaultShader").getValue(),s=new Nt(t+"mat");s.setShaderName(""!=i?i:"StandardSurfaceShader");const e=s.getParameter("BaseColor");if(e)e.setValue(p.random(.5));else{const t=s.getParameter("Color");t&&t.setValue(p.random(.5))}const n=s.getParameter("Roughness");n&&n.setValue(.6);const l=s.getParameter("Reflectance");l&&l.setValue(.2),this.materials.addMaterial(s),m.setMaterial(s)}this.addChild(m,!1)};(()=>{const t=this.objfileParam.getFileDesc(),i=this.objfileParam.getStem();ht.addWork(i,2),A(t.url,t=>{ht.addWorkDone(i,1),r(t),ht.addWorkDone(i,1)})})()}}class rs extends Q{constructor(t){super(t),this.setFlag(P.USER_EDITED),this.__outputs=[],this.__evalOutput=this.__evalOutput.bind(this),this.postEval=new v}setDirty(){for(const t of this.__outputs)t.setDirtyFromOp()}__parameterValueChanged(t,i){this.setDirty()}addOutput(t){return this.__outputs.push(t),t.paramSet.connect(t=>{t.bindOperator(this)}),t}removeOutput(t){t.getParam()&&t.getParam().unbindOperator(this),this.__outputs.splice(this.__outputs.indexOf(t),1)}getNumOutputs(){return this.__outputs.length}getOutputByIndex(t){return this.__outputs[t]}getOutput(t){for(const i of this.__outputs)if(i.getName()==t)return i}__evalOutput(t){for(const t of this.__outputs)t.removeCleanerFn(this.__evalOutput);this.evaluate()}__opInputChanged(){this.setDirty()}evaluate(){throw new Error("Not yet implemented")}toJSON(t,i){const s=super.toJSON(t,i);s.type=N.getClassName(this);const e=[];for(const s of this.__outputs)e.push(s.toJSON(t,i));return s.outputs=e,s}fromJSON(t,i,s){if(super.fromJSON(t,i,s),t.outputs){for(let s=0;s<this.__outputs.length;s++)this.__outputs[s].fromJSON(t.outputs[s],i);i.addPLCB(()=>{this.__opInputChanged()})}}detach(){this.__outputs.forEach(t=>t.detach())}reattach(){this.__outputs.forEach(t=>t.reattach())}destroy(){super.destroy(),this.__outputs=[]}}class ds{constructor(t,i){this.__name=t,this.__filterFn=i,this._param=void 0,this.detached=!1,this.paramSet=new v}getName(){return this.__name}getFilterFn(){return this.__filterFn}isConnected(){return null!=this._param}getParam(){return this._param}setParam(t){this._param=t,this.paramSet.emit()}getValue(t=T.OPERATOR_GETVALUE){if(this._param)return this._param.getValue(t)}setValue(t,i=J.OPERATOR_SETVALUE){this._param&&this._param.setValue(t,i)}setClean(t){this._param&&this._param.setClean(t)}setDirty(t){this._param&&this._param.setDirty(t)}setDirtyFromOp(){this._param&&this._param.setDirtyFromOp()}removeCleanerFn(t){this._param&&this._param.removeCleanerFn(t)}toJSON(t,i){const s=this._param?this._param.getPath():"";return{type:this.constructor.name,paramPath:t&&t.makeRelative?t.makeRelative(s):s}}fromJSON(t,i,s){t.paramPath&&i.resolvePath(t.paramPath,t=>{this.setParam(t)},()=>{console.warn("Operator Output: '"+this.getName()+"'. Unable to load item:"+t.paramPath)})}detach(){this.detached=!0}reattach(){this.detached=!1}}N.registerClass("OperatorOutput",ds);class us extends ds{constructor(t){super(t,t=>"Xfo"==t.getDataType())}getInitialValue(){return this._initialParamValue}setParam(t){(()=>{if(this._initialParamValue=t.getValue(),this._initialParamValue.clone&&(this._initialParamValue=this._initialParamValue.clone()),null==this._initialParamValue)throw new Error("WTF?")})(),this._param=t,this.paramSet.emit(t)}}N.registerClass("XfoOperatorOutput",us);class ms extends rs{constructor(t){super(t),this.addParameter(new Vt("ParentGlobal")),this.addParameter(new Vt("LocalXfo")),this.addOutput(new us("GlobalXfo"))}evaluate(){const t=this.getParameter("ParentGlobal").getValue(),i=this.getParameter("LocalXfo").getValue();this.getOutputByIndex(0).setClean(t.multiply(i))}}N.registerClass("CalcGlobalXfoOperator",ms);class bs extends Lt{constructor(t){super(t),this.__stageParam=this._addMember(new ut("Stage",0)),this.__axisParam=this._addMember(new pt("Axis",new u(1,0,0))),this.__movementParam=this._addMember(new Zt("MovementTiming",new d(0,1),[new d(0,0),new d(1,1)])),this.__multiplierParam=this._addMember(new ut("Multiplier",1)),this.__output=new us("Part")}getStage(t=J.USER_GETVALUE){return this.__stageParam.getValue(t)}setStage(t,i=J.USER_SETVALUE){this.__stageParam.setValue(t,i)}getOutput(){return this.__output}evaluate(t,i,s,e,n,l,h,o){if(!this.__output.isConnected())return;const a=this.__stageParam.getValue(),c=this.__movementParam.getValue();let r;if(n){let s=a/e;l&&(s-=.5),r=i*Math.linStep(c.x,c.y,Math.max(0,t-s))}else{let s=1-a/e;l&&(s-=.5),r=i*Math.linStep(c.x,c.y,t)*s}r+=s;let d=this.__axisParam.getValue();const u=this.__multiplierParam.getValue(),m=this.__output.getInitialValue();let b;h?(b=o.multiply(m),d=h.ori.rotateVec3(d),b.tr.addInPlace(d.scale(r*u))):(b=this.__output.getValue(),b.tr=m.tr.add(d.scale(r*u))),this.__output.setClean(b)}toJSON(t,i){const s=super.toJSON(t,i);return s&&(s.output=this.__output.toJSON(t,i)),s}fromJSON(t,i,s){super.fromJSON(t,i,s),t.output&&this.__output.fromJSON(t.output,i)}}class Zs extends rs{constructor(t){super(t),this.__stagesParam=this.addParameter(new ut("Stages",0)),this._explodeParam=this.addParameter(new ut("Explode",0,[0,1])),this._distParam=this.addParameter(new ut("Dist",1)),this._offsetParam=this.addParameter(new ut("Offset",0)),this._cascadeParam=this.addParameter(new bt("Cascade",!1)),this._centeredParam=this.addParameter(new bt("Centered",!1)),this.__parentItemParam=this.addParameter(new xt("RelativeTo")),this.__parentItemParam.valueChanged.connect(()=>{const t=this.__parentItemParam.getValue();this.__invParentSpace=t?t.getGlobalXfo().inverse():void 0}),this.__parentItemParam.treeItemGlobalXfoChanged.connect(()=>{this.setDirty()}),this.__itemsParam=this.addParameter(new St("Parts",bs)),this.__itemsParam.elementAdded.connect((t,i)=>{if(i>0){const s=this.__itemsParam.getElement(i-1).getStage();t.setStage(s+1),this.__stagesParam.setClean(s+2)}else this.__stagesParam.setClean(1);this.addOutput(t.getOutput()),this.setDirty()}),this.__itemsParam.elementRemoved.connect(t=>{this.removeOutput(t.getOutput())}),this.__localXfos=[],this.__parts=[],this.__stages=2}evaluate(){const t=this.__stagesParam.getValue(),i=this._explodeParam.getValue(),s=this._distParam.getValue(),e=this._offsetParam.getValue(),n=this._cascadeParam.getValue(),l=this._centeredParam.getValue(),h=this.__parentItemParam.getValue();let o,a;h&&(o=h.getGlobalXfo(),a=this.__invParentSpace.multiply(o));const c=this.__itemsParam.getValue();for(let h=0;h<c.length;h++)c[h].evaluate(i,s,e,t,n,l,o,a)}toJSON(t,i){return super.toJSON(t,i)}fromJSON(t,i,s){super.fromJSON(t,i,s)}destroy(){clearTimeout(this.__timeoutId),super.destroy()}}N.registerClass("ExplodePartsOperator",Zs);class ps extends Lt{constructor(t){super(t),this.__ratioParam=this._addMember(new ut("Ratio",1)),this.__offsetParam=this._addMember(new ut("Offset",0)),this.__axisParam=this._addMember(new pt("Axis",new u(1,0,0))),this.__output=new us("Gear")}getOutput(){return this.__output}getRatio(){return this.__ratioParam.getValue()}getOffset(){return this.__offsetParam.getValue()}getAxis(){return this.__axisParam.getValue()}toJSON(t,i){const s=super.toJSON(t,i);return s&&(s.output=this.__output.toJSON(t,i)),s}fromJSON(t,i,s){super.fromJSON(t,i,s),t.output&&this.__output.fromJSON(t.output,i)}}class Gs extends rs{constructor(t){super(t),this.__revolutionsParam=this.addParameter(new ut("Revolutions",0));const i=this.addParameter(new ut("RPM",0));i.valueChanged.connect(()=>{const t=i.getValue();if(Math.abs(t)>0){if(!this.__timeoutId){const t=()=>{const s=i.getValue(),e=this.__revolutionsParam.getValue();this.__revolutionsParam.setValue(e+s*(1/3e3)),this.__timeoutId=setTimeout(t,20)};t()}}else clearTimeout(this.__timeoutId),this.__timeoutId=void 0}),this.__gearsParam=this.addParameter(new St("Gears",ps)),this.__gearsParam.elementAdded.connect(t=>{this.addOutput(t.getOutput())}),this.__gearsParam.elementRemoved.connect((t,i)=>{this.removeOutput(i)}),this.__gears=[]}evaluate(){const t=this.__revolutionsParam.getValue(),i=this.__gearsParam.getValue();for(const s of i){const i=s.getOutput(),e=i.getInitialValue();if(!e)return;const n=t*s.getRatio()+s.getOffset(),l=new f;l.setFromAxisAndAngle(s.getAxis(),n*Math.PI*2);const h=i.getValue();h.ori=l.multiply(e.ori),i.setClean(h)}}detach(){super.detach(),this.__timeoutId&&(clearTimeout(this.__timeoutId),this.__timeoutId=null)}reattach(){super.reattach(),this.getParameter("RPM").valueChanged.emit()}destroy(){this.__timeoutId&&(clearTimeout(this.__timeoutId),this.__timeoutId=null),super.destroy()}}N.registerClass("GearsOperator",Gs);class Xs extends Lt{constructor(){super("Piston"),this.__pistonAngleParam=this._addMember(new ut("PistonAngle",0)),this.__camPhaseParam=this._addMember(new ut("CamPhase",0)),this.__camLengthParam=this._addMember(new ut("CamLength",3)),this.__rodLengthParam=this._addMember(new ut("RodLength",3)),this.__rodoutput=new us("Rod"),this.__capoutput=new us("Cap"),this.__pistonAngleParam.valueChanged.connect(this.init.bind(this)),this.__camPhaseParam.valueChanged.connect(this.init.bind(this)),this.__camLengthParam.valueChanged.connect(this.init.bind(this)),this.__rodLengthParam.valueChanged.connect(this.init.bind(this)),this.__bindXfos={}}getRodOutput(){return this.__rodoutput}getCapOutput(){return this.__capoutput}setCrankXfo(t){this.__baseCrankXfo=t,this.init()}init(){if(!this.__baseCrankXfo)return;const t=this.__camPhaseParam.getValue(),i=this.__camLengthParam.getValue(),s=this.__rodLengthParam.getValue(),e=this.__pistonAngleParam.getValue(),n=new u(Math.sin(Math.degToRad(e)),Math.cos(Math.degToRad(e)),0);this.__pistonAxis=this.__baseCrankXfo.ori.rotateVec3(n),this.__camVec=this.__baseCrankXfo.ori.rotateVec3(new u(Math.sin(2*t*Math.PI)*i,Math.cos(2*t*Math.PI)*i,0));const l=2*t*Math.PI,h=Math.sin(l)*i,o=Math.sqrt(s*s-h*h)+Math.cos(l)*i;this.__pistonOffset=o}evaluate(t,i,s){const e=this.__camPhaseParam.getValue(),n=this.__camLengthParam.getValue(),l=this.__rodLengthParam.getValue(),h=2*(e+s)*Math.PI,o=Math.sin(h)*n,a=Math.asin(o/l),c=Math.sqrt(l*l-o*o)+Math.cos(h)*n;if(this.__rodoutput.isConnected()){const s=this.__rodoutput.getInitialValue().clone(),e=this.__rodoutput.getValue(),n=e.tr.subtract(this.__baseCrankXfo.tr).dot(i),l=new f;l.setFromAxisAndAngle(i,-a),e.tr=this.__baseCrankXfo.tr.add(t.rotateVec3(this.__camVec)),e.tr.addInPlace(i.scale(n)),e.ori=l.multiply(s.ori),this.__rodoutput.setValue(e)}if(this.__capoutput.isConnected()){const t=this.__capoutput.getInitialValue().clone(),i=this.__capoutput.getValue();i.tr=t.tr.add(this.__pistonAxis.scale(c-this.__pistonOffset)),this.__capoutput.setValue(i)}}setOwner(t){this.__owner=t}getOwner(){return this.__owner}toJSON(t,i){return super.toJSON(t,i)}fromJSON(t,i,s){super.fromJSON(t,i,s)}clone(t){return new Xs(this.__name,this.__value)}}class ys extends rs{constructor(t){super(t),this.__revolutionsParam=this.addParameter(new ut("Revolutions",0,[0,1]));const i=this.addParameter(new ut("RPM",0));i.valueChanged.connect(()=>{let t=i.getValue();if(t>0){if(!this.__timeoutId){const s=()=>{t=i.getValue();const e=this.__revolutionsParam.getValue();this.__revolutionsParam.setValue(e+t*(1/3e3)),this.__timeoutId=setTimeout(s,20)};s()}}else clearTimeout(this.__timeoutId),this.__timeoutId=void 0}),this.__crankOutput=this.addOutput(new us("Crank")),this.__crankOutput.paramSet.connect(this.init.bind(this)),this.__crankAxisParam=this.addParameter(new pt("CrankAxis",new u(1,0,0))),this.__crankAxisParam.valueChanged.connect(()=>{this.__baseCrankXfo.ori.setFromDirectionAndUpvector(this.__crankAxisParam.getValue(),new u(0,0,1)),this.init()}),this.__pistonsParam=this.addParameter(new St("Pistons",Xs)),this.__pistonsParam.elementAdded.connect(t=>{t.setCrankXfo(this.__baseCrankXfo),this.addOutput(t.getRodOutput()),this.addOutput(t.getCapOutput())}),this.__pistonsParam.elementRemoved.connect(t=>{this.removeOutput(t.getRodOutput()),this.removeOutput(t.getCapOutput())}),this.__baseCrankXfo=new g,this.__pistons=[]}setOwner(t){super.setOwner(t)}getCrankOutput(){return this.__crankOutput}init(){const t=this.__pistonsParam.getValue();for(const i of t)i.setCrankXfo(this.__baseCrankXfo);this.__crankOutput.isConnected()&&(this.__crankOffset=this.__baseCrankXfo.inverse().multiply(this.__crankOutput.getInitialValue()))}evaluate(){const t=this.__revolutionsParam.getValue(T.OPERATOR_GETVALUE),i=this.__crankAxisParam.getValue(T.OPERATOR_GETVALUE),s=new f;if(s.setFromAxisAndAngle(i,t*Math.PI*2),this.__crankOutput.isConnected()){const t=this.__crankOutput.getValue();t.ori=s.multiply(this.__crankOutput.getInitialValue().ori),this.__crankOutput.setValue(t)}const e=this.__pistonsParam.getValue(),n=e.length;for(let l=0;l<n;l++)e[l].evaluate(s,i,t);this.postEval.emit(t)}toJSON(t,i){return super.toJSON(t,i)}fromJSON(t,i,s){super.fromJSON(t,i,s),t.crankOutput&&this.__crankOutput.fromJSON(t.crankOutput,i),this.init()}destroy(){clearTimeout(this.__timeoutId),super.destroy()}}N.registerClass("PistonOperator",ys);class fs extends rs{constructor(t){super(t),this.__inputParam=this.addParameter(new ut("Input")),this.__routesParam=this.addParameter(new St("Routes",ut)),this.__routesParam.elementAdded.connect(t=>{t.setValue(1),this.addOutput(new ds("Output"))}),this.__routesParam.elementRemoved.connect((t,i)=>{this.removeOutput(this.getOutputByIndex(i))})}evaluate(){const t=this.__inputParam.getValue(T.OPERATOR_GETVALUE),i=this.__routesParam.getValue();let s=this.__outputs.length;for(;s--;)this.__outputs[s].setValue(t*i[s].getValue(T.OPERATOR_GETVALUE));this.postEval.emit(t)}toJSON(t,i){return super.toJSON(t,i)}fromJSON(t,i,s){super.fromJSON(t,i,s)}destroy(){super.destroy()}}N.registerClass("RouterOperator",fs);class Vs extends rs{constructor(t){super(t),this.addParameter(new ut("Weight",1)),this.addParameter(new mt("Axis",0,["+X Axis","-X Axis","+Y Axis","-Y Axis","+Z Axis","-Z Axis"])),this.addParameter(new ut("Stretch",0)),this.addParameter(new ut("Initial Dist",1)),this.addParameter(new Vt("Target")),this.addOutput(new us("InputOutput"))}resetStretchRefDist(){const t=this.getParameter("Target").getValue(),i=this.getOutputByIndex(0).getValue(),s=t.tr.subtract(i.tr).length();this.getParameter("Initial Dist").setValue(s)}evaluate(){const t=this.getParameter("Weight").getValue(),i=this.getParameter("Target").getValue(),s=this.getParameter("Axis").getValue(),e=this.getOutputByIndex(0),n=e.getValue(),l=i.tr.subtract(n.tr),h=l.length();if(h<1e-6)return;let o;switch(l.scaleInPlace(1/h),s){case 0:o=n.ori.getXaxis();break;case 1:o=n.ori.getXaxis().negate();break;case 2:o=n.ori.getYaxis();break;case 3:o=n.ori.getYaxis().negate();break;case 4:o=n.ori.getZaxis();break;case 5:o=n.ori.getZaxis().negate()}let a=new f;a.setFrom2Vectors(o,l),a.alignWith(new f),t<1&&(a=(new f).lerp(a,t)),n.ori=a.multiply(n.ori);const c=this.getParameter("Stretch").getValue();if(c>0){const t=1+(h/this.getParameter("Initial Dist").getValue()-1)*c;switch(s){case 0:case 1:n.sc.x=t;break;case 2:case 3:n.sc.y=t;break;case 4:case 5:n.sc.z=t}}e.setClean(n)}}N.registerClass("AimOperator",Vs);class gs extends B{constructor(t){null==t&&(t="Camera"),super(t),this.__defaultManipulationState="orbit",this.__manipulationState=this.__defaultManipulationState,this.__mouseDown=!1,this.__dragging=!1,this.__mouseDragDelta=new d,this.__keyboardMovement=!1,this.__keysPressed=[],this.__maxVel=.002,this.__velocity=new u,this.__ongoingTouches={},this.__orbitRateParam=this.addParameter(new ut("orbitRate",e.isMobileDevice?-.3:1)),this.__dollySpeedParam=this.addParameter(new ut("dollySpeed",.02)),this.__mouseWheelDollySpeedParam=this.addParameter(new ut("mouseWheelDollySpeed",5e-4)),this.movementFinished=new v}setDefaultManipulationMode(t){this.__defaultManipulationState=t}look(t,i){const{viewport:s}=t,e=s.getCamera(),n=e.getFocalDistance(),l=this.__orbitRateParam.getValue();if(this.__keyboardMovement){const t=e.getGlobalXfo();this.__mouseDownCameraXfo=t.clone(),this.__mouseDownZaxis=t.ori.getZaxis();const i=this.__mouseDownZaxis.scale(-n);this.__mouseDownCameraTarget=t.tr.add(i)}const h=this.__mouseDownCameraXfo.clone(),o=new f;o.rotateZ(i.x/s.getWidth()*Math.PI*l),h.ori=o.multiply(h.ori);const a=new f;a.rotateX(i.y/s.getHeight()*Math.PI*l),h.ori.multiplyInPlace(a),e.setGlobalXfo(h)}orbit(t,i){const{viewport:s}=t,e=s.getCamera(),n=e.getFocalDistance(),l=this.__orbitRateParam.getValue();if(this.__keyboardMovement){const t=e.getGlobalXfo();this.__mouseDownCameraXfo=t.clone(),this.__mouseDownZaxis=t.ori.getZaxis();const i=this.__mouseDownZaxis.scale(-n);this.__mouseDownCameraTarget=t.tr.add(i)}const h=this.__mouseDownCameraXfo.clone(),o=new f;o.rotateZ(i.x/s.getWidth()*2*Math.PI*-l),h.ori=o.multiply(h.ori);const a=new f;a.rotateX(i.y/s.getHeight()*Math.PI*-l),h.ori.multiplyInPlace(a),h.tr=this.__mouseDownCameraTarget.add(h.ori.getZaxis().scale(n)),e.setGlobalXfo(h)}pan(t,i){const{viewport:s}=t,e=s.getCamera(),n=e.getFocalDistance(),l=e.getFov(),h=new u(1,0,0),o=new u(0,1,0),a=2*n*Math.tan(.5*l),c=a*(s.getWidth()/s.getHeight()),r=new g;r.tr=h.scale(-i.x/s.getWidth()*c),r.tr.addInPlace(o.scale(i.y/s.getHeight()*a)),e.setGlobalXfo(this.__mouseDownCameraXfo.multiply(r))}dolly(t,i){const{viewport:s}=t,e=s.getCamera(),n=i.x*this.__dollySpeedParam.getValue(),l=new g;l.tr.set(0,0,n),e.setGlobalXfo(this.__mouseDownCameraXfo.multiply(l))}panAndZoom(t,i,s){const{viewport:e}=t,n=e.getCamera(),l=n.getFocalDistance(),h=n.getFov(),o=new u(1,0,0),a=new u(0,1,0),c=2*l*Math.tan(.5*h),r=c*(e.getWidth()/e.getHeight()),d=new g;d.tr=o.scale(-i.x/e.getWidth()*r),d.tr.addInPlace(a.scale(i.y/e.getHeight()*c));const m=s*l;n.setFocalDistance(this.__mouseDownFocalDist+m),d.tr.z+=m,n.setGlobalXfo(this.__mouseDownCameraXfo.multiply(d))}initDrag(t){const{viewport:i}=t,s=i.getCamera(),e=s.getFocalDistance();this.__mouseDown=!0,this.__calculatingDragAction=!1,this.__mouseDownPos=t.mousePos,this.__mouseDownViewport=i,this.__mouseDragDelta.set(0,0),this.__mouseDownCameraXfo=s.getGlobalXfo().clone(),this.__mouseDownZaxis=this.__mouseDownCameraXfo.ori.getZaxis();const n=this.__mouseDownZaxis.scale(-e);this.__mouseDownCameraTarget=s.getGlobalXfo().tr.add(n),this.__mouseDownFocalDist=e,this.__dragListenerId=s.getParameter("GlobalXfo").valueChanged.connect(this.__globalXfoChangedDuringDrag.bind(this))}__globalXfoChangedDuringDrag(t){this.__calculatingDragAction||(this.__mouseDownViewport.getCamera().getParameter("GlobalXfo").valueChanged.disconnectId(this.__dragListenerId),this.initDrag({viewport:this.__mouseDownViewport,mousePos:this.__mouseDownPos}))}endDrag(t){if(this.__dragListenerId){const{viewport:i}=t;i.getCamera().getParameter("GlobalXfo").valueChanged.disconnectId(this.__dragListenerId),this.__dragListenerId=null}this.__mouseDown=!1,this.__dragging=!1}aimFocus(t,i){const{viewport:s}=t,e=s.getCamera();this.__focusIntervalId&&clearInterval(this.__focusIntervalId);let n=0;const l=()=>{const t=e.getGlobalXfo(),s=e.getFocalDistance(),h=i.subtract(t.tr),o=h.normalizeInPlace(),a=new f,c=new f;{const i=t.ori.getZaxis().clone();i.z=0;const s=h.negate();s.z=0,a.setFrom2Vectors(i,s)}{const i=t.ori.getZaxis().clone(),s=h.negate();i.x=s.x,i.y=s.y,i.normalizeInPlace(),i.cross(s).dot(t.ori.getXaxis())>0?c.rotateX(i.angleTo(s)):c.rotateX(-i.angleTo(s))}const r=t.clone();r.ori=a.multiply(r.ori),r.ori.multiplyInPlace(c);const d=Math.pow(n/20,2),u=t.clone();u.ori=t.ori.lerp(r.ori,d),e.setFocalDistance(s+(o-s)*d),e.setGlobalXfo(u),n++,n<=20?this.__focusIntervalId=setTimeout(l,20):(this.__focusIntervalId=void 0,this.movementFinished.emit())};l(),this.__manipulationState="focussing"}onMouseMove(t){}onDoubleClick(t){if(t.intersectionData){const i=t.viewport.getCamera().getGlobalXfo().tr.add(t.mouseRay.dir.scale(t.intersectionData.dist));this.aimFocus(t,i)}}onMouseDown(t){this.initDrag(t),this.__manipulationState=2==t.button?"pan":t.ctrlKey&&t.altKey?"dolly":t.ctrlKey||2==t.button?"look":this.__defaultManipulationState}onMouseMove(t){if(!this.__mouseDown)return;const i=t.mousePos;switch(this.__calculatingDragAction=!0,this.__mouseDragDelta=this.__keyboardMovement?i:i.subtract(this.__mouseDownPos),this.__manipulationState){case"orbit":this.orbit(t,this.__mouseDragDelta);break;case"look":this.look(t,this.__mouseDragDelta);break;case"pan":this.pan(t,this.__mouseDragDelta);break;case"dolly":this.dolly(t,this.__mouseDragDelta)}this.__dragging=!0,this.__calculatingDragAction=!1,t.stopPropagation()}onMouseUp(t){this.__dragging&&(this.movementFinished.emit(),t.stopPropagation()),this.endDrag(t)}onWheel(t){const{viewport:i}=t,s=i.getCamera(),e=this.__mouseWheelDollySpeedParam.getValue(),n=t.shiftKey?.1:.5,l=s.getGlobalXfo(),h=l.ori.getZaxis();this.__mouseWheelZoomIntervalId&&clearInterval(this.__mouseWheelZoomIntervalId);let o=0;const a=()=>{const i=s.getFocalDistance(),c=t.deltaY*e*i*n;l.tr.addInPlace(h.scale(c)),"orbit"==this.__defaultManipulationState&&s.setFocalDistance(s.getFocalDistance()+c),s.setGlobalXfo(l),o++,o<10?this.__mouseWheelZoomIntervalId=setTimeout(a,10):(this.__mouseWheelZoomIntervalId=void 0,this.movementFinished.emit())};a()}__integrateVelocityChange(t){const{viewport:i}=t,s=i.getCamera(),e=new g;e.tr=this.__velocity.normalize().scale(this.__maxVel),s.setGlobalXfo(s.getGlobalXfo().multiply(e))}onKeyPressed(t,i){return!1}onKeyDown(t,i){}onKeyUp(t,i){}__startTouch(t){this.__ongoingTouches[t.identifier]={identifier:t.identifier,pos:new d(t.pageX,t.pageY)}}__endTouch(t){delete this.__ongoingTouches[t.identifier]}onTouchStart(t){console.log("onTouchStart"),t.preventDefault(),t.stopPropagation(),0==Object.keys(this.__ongoingTouches).length&&(this.__manipMode=void 0);const i=t.changedTouches;for(let t=0;t<i.length;t++)this.__startTouch(i[t]);1==Object.keys(this.__ongoingTouches).length&&(this.initDrag(t),this.__dragging=!0)}onTouchMove(t){t.preventDefault(),t.stopPropagation(),this.__calculatingDragAction=!0;const i=t.touches;if(1==i.length&&"panAndZoom"!=this.__manipMode){const s=i[0],e=new d(s.pageX,s.pageY),n=this.__ongoingTouches[s.identifier].pos.subtract(e);"look"==this.__defaultManipulationState?(n.scaleInPlace(6),this.look(t,n)):this.orbit(t,n)}else if(2==i.length){const s=i[0],e=this.__ongoingTouches[s.identifier],n=i[1],l=this.__ongoingTouches[n.identifier],h=new d(s.pageX,s.pageY),o=new d(n.pageX,n.pageY),a=l.pos.subtract(e.pos).length()-o.subtract(h).length(),c=h.subtract(e.pos),r=o.subtract(l.pos),u=c.add(r);u.scaleInPlace(.5),this.panAndZoom(t,u,.002*a),this.__manipMode="panAndZoom"}this.__calculatingDragAction=!1}onTouchEnd(t){t.preventDefault(),t.stopPropagation();const i=t.changedTouches;for(let t=0;t<i.length;t++)this.__endTouch(i[t]);0==Object.keys(this.__ongoingTouches).length&&this.endDrag(t)}onTouchCancel(t){t.preventDefault();const i=t.touches;for(let t=0;t<i.length;t++)this.__endTouch(i[t]);0==Object.keys(this.__ongoingTouches).length&&this.endDrag(t)}onDoubleTap(t){if(t.intersectionData){const{viewport:i}=t,s=i.getCamera().getGlobalXfo().tr.add(t.touchRay.dir.scale(t.intersectionData.dist));this.aimFocus(t,s)}t.preventDefault()}}var Rs=Object.freeze({__proto__:null,RefCounted:F,ParameterOwner:B,ItemFlags:P,BaseItem:Q,getFileFolder:D,loadTextfile:A,loadJSONfile:_,loadXMLfile:q,loadBinfile:$,sgFactory:N,isObject:nt,mergeDeep:lt,resourceLoader:ht,Version:ot,BinReader:ct,BinWriter:rt,Command:dt,ParamFlags:z,ValueGetMode:T,ValueSetMode:J,BaseParameter:H,Parameter:U,MultiChoiceParameter:mt,BooleanParameter:bt,NumberParameter:ut,Vec2Parameter:Zt,Vec3Parameter:pt,Vec4Parameter:Gt,ColorParameter:Xt,Mat3Parameter:yt,Mat4Parameter:ft,XfoParameter:Vt,ImageParameter:gt,StringParameter:Rt,CodeParameter:Wt,FilePathParameter:It,ListParameter:St,StructParameter:Lt,TreeItemParameter:xt,ItemSetParameter:vt,ProxyParameter:Yt,GeometryParameter:Mt,MaterialParameter:yi,MaterialFloatParam:Ct,MaterialColorParam:wt,Attribute:fi,BaseGeom:Vi,SAVE_FLAG_SKIP_GEOMDATA:1024,VertexAttribute:gi,Points:Ri,Lines:Wi,Mesh:Ii,PointsProxy:Li,LinesProxy:xi,MeshProxy:vi,PointGrid:Yi,Rect:Mi,Circle:Ki,Cross:Ci,LinesCuboid:wi,Grid:Fi,Cone:Ni,Cuboid:Ti,Cylinder:Ji,Disc:zi,Plane:Hi,Sphere:Ui,Torus:ki,DataImage:Tt,FileImage:ti,FileImage2D:ii,LDRImage:ei,LDRVideo:ni,GIFImage:li,EnvMap:di,Lightmap:ui,LightmapMixer:mi,Label:Zi,VideoStreamImage2D:pi,labelManager:bi,SaveFlags:Bi,LoadFlags:Pi,CloneFlags:Ei,TreeItem:Qi,InstanceItem:ji,AudioItem:Di,FileAudioItem:Oi,BaseGeomItem:Ai,GeomItem:_i,AssetItem:ss,BillboardItem:es,Camera:ns,Group:$i,GeomLibrary:is,Material:Nt,BaseImage:Kt,MaterialLibrary:Gi,materialLibraryManager:Xi,Scene:as,VLAAsset:hs,ObjAsset:cs,Operator:rs,OperatorOutput:ds,XfoOperatorOutput:us,CalcGlobalXfoOperator:ms,ExplodePartsOperator:Zs,GearsOperator:Gs,PistonOperator:ys,RouterOperator:fs,AimOperator:Vs,CameraMouseAndKeyboard:gs});const Ws=function(t,i){console.log(e);let s=null;if(null!=i.webglContextType)try{s=t.getContext(i.webglContextType,i),s.name=i.webglContextType}catch(t){}else["webgl2","webgl"].some(e=>{try{s=t.getContext(e,i),s.name=e}catch(t){}if(s)return!0});if(s)return s.sizeInBytes=function(t){switch(t){case this.BYTE:case this.UNSIGNED_BYTE:return 1;case this.SHORT:case this.UNSIGNED_SHORT:return 2;case this.INT:case this.UNSIGNED_INT:case this.FLOAT:return 4;default:throw new Error("unknown type")}},"webgl2"==s.name?(s.floatTexturesSupported=!0,s.__ext_float_linear=s.getExtension("OES_texture_float_linear"),s.__ext_texture_half_float_linear=s.getExtension("OES_texture_half_float_linear"),s.__ext_color_buffer_float=s.getExtension("EXT_color_buffer_float")):(s.__ext_float=s.getExtension("OES_texture_float"),s.__ext_float?(s.floatTexturesSupported=!0,s.__ext_float_linear=s.getExtension("OES_texture_float_linear")):console.warn("OES_texture_float is not available"),s.__ext_half_float=s.getExtension("OES_texture_half_float"),s.__ext_half_float&&(s.HALF_FLOAT=s.__ext_half_float.HALF_FLOAT_OES,s.floatTexturesSupported=!0,s.__ext_texture_half_float_linear=s.getExtension("OES_texture_half_float_linear")),s.__ext_color_buffer_float=s.getExtension("EXT_color_buffer_float"),s.__ext_std_derivatives=s.getExtension("OES_standard_derivatives"),s.__ext_Inst=s.getExtension("ANGLE_instanced_arrays"),s.__ext_Inst&&(s.vertexAttribDivisor=s.__ext_Inst.vertexAttribDivisorANGLE.bind(s.__ext_Inst),s.drawArraysInstanced=s.__ext_Inst.drawArraysInstancedANGLE.bind(s.__ext_Inst),s.drawElementsInstanced=s.__ext_Inst.drawElementsInstancedANGLE.bind(s.__ext_Inst)),s.__ext_VAO=s.getExtension("OES_vertex_array_object"),s.__ext_VAO&&(s.createVertexArray=s.__ext_VAO.createVertexArrayOES.bind(s.__ext_VAO),s.deleteVertexArray=s.__ext_VAO.deleteVertexArrayOES.bind(s.__ext_VAO),s.bindVertexArray=s.__ext_VAO.bindVertexArrayOES.bind(s.__ext_VAO)),s.__ext_element_index_uint=s.getExtension("OES_element_index_uint"),s.__ext_WEBGL_depth_texture=s.getExtension("WEBGL_depth_texture"),s.__ext_WEBGL_depth_texture&&(s.UNSIGNED_INT_24_8=s.__ext_WEBGL_depth_texture.UNSIGNED_INT_24_8_WEBGL),s.DRAW_FRAMEBUFFER=s.FRAMEBUFFER),s.__ext_frag_depth=s.getExtension("EXT_frag_depth"),s.setupInstancedQuad=function(){const t=new Float32Array([0,1,2,3]),i=new Uint16Array([0,1,2,2,1,3]);this.__quadVertexIdsBuffer=this.createBuffer(),this.bindBuffer(this.ARRAY_BUFFER,this.__quadVertexIdsBuffer),this.bufferData(this.ARRAY_BUFFER,t,this.STATIC_DRAW),this.__quadIndexBuffer=this.createBuffer(),this.bindBuffer(this.ELEMENT_ARRAY_BUFFER,this.__quadIndexBuffer),this.bufferData(this.ELEMENT_ARRAY_BUFFER,i,this.STATIC_DRAW),this.__quadattrbuffers={vertexIDs:{buffer:this.__quadVertexIdsBuffer,dataType:6,dimension:1,count:t.length,shared:!0}}},s.drawQuad=function(){this.drawElements(this.TRIANGLES,6,this.UNSIGNED_SHORT,0)},s.setupLineSegAttrBuffers=function(){const t=new Float32Array([0,1]),i=s.createBuffer();s.bindBuffer(s.ARRAY_BUFFER,i),s.bufferData(s.ARRAY_BUFFER,t,s.STATIC_DRAW),s.__linesegattrbuffers={vertexIDs:{buffer:i,dimension:1,count:t.length,shared:!0}}},s};class Is extends F{constructor(t,i){if(super(),this.__gl=t,this.ready=new v(!0),this.updated=new v,this.resized=new v,this.width=0,this.height=0,this.textureType=1,this.textureDesc=[0,0,0,0],this.__loaded=!1,this.__bound=!1,null!=i)if(i instanceof Kt){this.__texture=i,this.__texture.setMetadata("gltexture",this);const t=()=>{const t=this.__texture.getParams();this.bufferData(t.data,t.width,t.height)};this.__texture.isLoaded()?(this.configure(this.__texture.getParams()),this.__texture.updated.connect(t)):this.__texture.loaded.connect(()=>{this.configure(this.__texture.getParams()),this.__texture.updated.connect(t)})}else this.configure(i)}isLoaded(){return this.__loaded}getTexture(){return this.__texture}getInternalFormat(){return this.__internalFormat}getType(){return this.__typeParam}getTypeID(){return this.__type}getFormat(){return this.__formatParam}getFormatID(){return this.__format}getFilter(){return this.__filterParam}getWrap(){return this.__wrapParam}getMipMapped(){return this.__mipMapped}configure(t,i=!0){if(!("type"in t&&"format"in t&&"width"in t&&"height"in t))throw new Error("Invalid texture params");const s=this.__gl,e=t.width,n=t.height,l=t.data,h=s.getParameter(s.MAX_TEXTURE_SIZE);if(e<=0||e>h||n<=0||n>h)throw new Error("gl-texture2d: Invalid texture size. width:"+e+" height:"+n+" maxSize:"+h);const o=t.format,a=t.type;let c="minFilter"in t?t.minFilter:"filter"in t?t.filter:"LINEAR",r="magFilter"in t?t.magFilter:"filter"in t?t.filter:"LINEAR";const d="wrap"in t?t.wrap:"CLAMP_TO_EDGE";if("FLOAT"==a)if(this.textureType=3,"webgl2"==s.name)"LINEAR"!=c||s.__ext_float_linear||(console.warn("Floating point texture filtering not supported on this device"),c="NEAREST"),"LINEAR"!=r||s.__ext_float_linear||(console.warn("Floating point texture filtering not supported on this device"),r="NEAREST");else if(s.__ext_float)"LINEAR"!=c||s.__ext_float_linear||(console.warn("Floating point texture filtering not supported on this device"),c="NEAREST"),"LINEAR"!=r||s.__ext_float_linear||(console.warn("Floating point texture filtering not supported on this device"),r="NEAREST");else{if(!s.__ext_half_float)throw new Error("OES_texture_half_float is not available");a="HALF_FLOAT","LINEAR"!=c||s.__ext_texture_half_float_linear||(console.warn("Half Float texture filtering not supported on this device"),c="NEAREST"),"LINEAR"!=r||s.__ext_texture_half_float_linear||(console.warn("Half Float texture filtering not supported on this device"),r="NEAREST")}else if("HALF_FLOAT"==a)if("webgl2"==s.name);else{if(!s.supportUploadingHalfFloat&&null!=l)throw new Error("Safari does not support uploading HALF_FLOAT texture data.");if(!s.__ext_half_float)throw new Error("OES_texture_half_float is not available");if("LINEAR"!=c||s.__ext_texture_half_float_linear||(console.warn("Half Float texture filtering not supported on this device"),c="NEAREST"),"LINEAR"!=r||s.__ext_texture_half_float_linear||(console.warn("Half Float texture filtering not supported on this device"),r="NEAREST"),"RGB"==o)throw new Error("OES_texture_half_float onlysupports RGBA textures")}else if("sRGB"==a&&!s.__ext_sRGB)throw new Error("EXT_sRGB is not available");this.__formatParam=o,this.__typeParam=a,this.__minFilterParam=c,this.__magFilterParam=r,this.__wrapParam=d,this.__format=s[o],this.__internalFormat="internalFormat"in t?s[t.internalFormat]:this.__format,this.__type=s[a],"webgl2"==s.name&&("internalFormat"in t||(this.__type==s.FLOAT?this.__format==s.RED?this.__internalFormat=s.R32F:this.__format==s.RG?this.__internalFormat=s.RG32F:this.__format==s.RGB?this.__internalFormat=s.RGB32F:this.__format==s.RGBA&&(this.__internalFormat=s.RGBA32F):this.__type==s.HALF_FLOAT?this.__format==s.RED?this.__internalFormat=s.R16F:this.__format==s.RG?this.__internalFormat=s.RG16F:this.__format==s.RGB?this.__internalFormat=s.RGB16F:this.__format==s.RGBA&&(this.__internalFormat=s.RGBA16F):this.__type==s.UNSIGNED_BYTE&&(this.__format==s.RED&&(this.__internalFormat=s.R8),this.__format==s.RG&&(this.__internalFormat=s.RG8),this.__format==s.RGB?this.__internalFormat=s.RGB8:this.__format==s.RGBA&&(this.__internalFormat=s.RGBA8)))),this.__minFilter=s[c],this.__magFilter=s[r],this.__wrap=s[d],this.__flipY="flipY"in t&&t.flipY,this.__mipMapped="mipMapped"in t&&t.mipMapped,this.invert="invert"in t&&t.invert,this.alphaFromLuminance="alphaFromLuminance"in t&&t.alphaFromLuminance,this.textureDesc=[e,n,0,0],this.__gltex&&s.deleteTexture(this.__gltex),this.__gltex=s.createTexture(),this.__updateGLTexParams(),l?this.bufferData(l,e,n,!1,!1):this.resize(e,n,!1,!1),this.__loaded||(this.ready.emit(),this.__loaded=!0)}__updateGLTexParams(){const t=this.__gl;t.bindTexture(t.TEXTURE_2D,this.__gltex),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,this.__minFilter),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,this.__magFilter),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,this.__wrap),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,this.__wrap)}bufferData(t,i=-1,s=-1,e=!0,n=!0){const l=this.__gl;if(e&&l.bindTexture(l.TEXTURE_2D,this.__gltex),null!=t){if(t instanceof Image||t instanceof ImageData||t instanceof HTMLCanvasElement||t instanceof HTMLImageElement||t instanceof HTMLVideoElement)l.texImage2D(l.TEXTURE_2D,0,this.__internalFormat,this.__format,this.__type,t),this.width=t.width,this.height=t.height;else{-1==i&&(i=this.width),-1==s&&(s=this.height);const e=i*s;let n;switch(this.__format){case l.RED:case l.RED_INTEGER:case l.ALPHA:case l.LUMINANCE:case l.LUMINANCE_ALPHA:n=1;break;case l.RG:n=2;break;case l.RGB:n=3;break;case l.RGBA:n=4}t.length!=e*n&&console.warn("Invalid data for Image width:"+i+" height:"+s+" format:"+this.__formatParam+" type:"+this.__typeParam+" Data Length:"+t.length+" Expected:"+e*n),this.__type==l.HALF_FLOAT&&t instanceof Float32Array&&(t=Math.convertFloat32ArrayToUInt16Array(t)),"webgl2"==l.name?l.texImage2D(l.TEXTURE_2D,0,this.__internalFormat,i,s,0,this.__format,this.__type,t,0):l.texImage2D(l.TEXTURE_2D,0,this.__internalFormat,i,s,0,this.__format,this.__type,t),this.width=i,this.height=s}this.__mipMapped&&l.generateMipmap(l.TEXTURE_2D)}else l.texImage2D(l.TEXTURE_2D,0,this.__internalFormat,this.width,this.height,0,this.__format,this.__type,null),this.width=i,this.height=s;n&&this.updated.emit()}clear(){const t=this.__gl,i=this.width*this.height;let s,e;switch(this.__format){case t.RED:case t.RED_INTEGER:case t.ALPHA:case t.LUMINANCE:case t.LUMINANCE_ALPHA:s=1;break;case t.RG:s=2;break;case t.RGB:s=3;break;case t.RGBA:s=4;break;default:throw new Error("Invalid Format")}switch(this.__type){case t.UNSIGNED_BYTE:e=new UInt8Array(i*s);break;case t.HALF_FLOAT:e=new UInt16Array(i*s);break;case t.FLOAT:e=new Float32Array(i*s);break;default:throw new Error("Invalid Type")}"webgl2"==t.name?t.texImage2D(t.TEXTURE_2D,0,this.__internalFormat,this.width,this.height,0,this.__format,this.__type,e,0):t.texImage2D(t.TEXTURE_2D,0,this.__internalFormat,this.width,this.height,0,this.__format,this.__type,e)}resize(t,i,s=!1,e=!0){const n=this.__gl;if(this.width!=t||this.height!=i){const l=n.getParameter(n.MAX_TEXTURE_SIZE);if(t<0||t>l||i<0||i>l)throw new Error("gl-texture2d: Invalid texture size. width:"+t+" height:"+i+" maxSize:"+l);if(s){const s=n.createTexture();n.bindTexture(n.TEXTURE_2D,s),n.texImage2D(n.TEXTURE_2D,0,this.__internalFormat,t,i,0,this.__format,this.__type,null);const e=n.createFramebuffer();n.bindFramebuffer(n.FRAMEBUFFER,e),n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,this.__gltex,0),n.bindTexture(n.TEXTURE_2D,s),n.copyTexImage2D(n.TEXTURE_2D,0,this.__internalFormat,0,0,this.width,this.height,0),n.bindFramebuffer(n.FRAMEBUFFER,null),n.deleteFramebuffer(e),this.__gl.deleteTexture(this.__gltex),this.__gltex=s,this.__updateGLTexParams()}else n.bindTexture(n.TEXTURE_2D,this.__gltex),n.texImage2D(n.TEXTURE_2D,0,this.__internalFormat,t,i,0,this.__format,this.__type,null);this.width=t,this.height=i,e&&this.resized.emit(t,i)}}populate(t,i,s,e=0,n=0,l=!0){const h=this.__gl;l&&h.bindTexture(h.TEXTURE_2D,this.__gltex),h.texSubImage2D(h.TEXTURE_2D,0,e,n,i,s,this.__format,this.__type,t)}getSize(){return[this.width,this.height]}get glTex(){return this.__gltex}getTexHdl(){return this.__gltex}bind(t,i){return console.warn("'bind' is deprecated. Please use 'bindToUniform'"),this.bindToUniform(t,i)}preBind(t,i){return{textureTypeUnif:i[t.name+"Type"],textureDescUnif:i[t.name+"Desc"]}}bindToUniform(t,i,s){if(!this.__loaded)return!1;if(!this.__gltex)throw new Error("Unable to bind non-initialized or deleted texture.");const e=t.boundTextures++,n=this.__gl;return n.activeTexture(this.__gl.TEXTURE0+e),n.bindTexture(n.TEXTURE_2D,this.__gltex),n.uniform1i(i.location,e),s&&(s.textureTypeUnif&&n.uniform1i(s.textureTypeUnif.location,this.textureType),s.textureDescUnif&&this.__gl.uniform4fv(s.textureDescUnif.location,this.textureDesc)),!0}destroy(){super.destroy(),this.__texture&&this.__texture.setMetadata("gltexture",void 0),this.__gl.deleteTexture(this.__gltex),this.__gltex=void 0}}class Ss{constructor(t,i,s,e){this.__gl=t,this.__shaderAttrs=i,this.__glattrbuffers=s,this.__indexBuffer=e}bind(t){const i=this.__gl;for(const t in this.__shaderAttrs){if("instancedIds"==t)continue;const s=this.__shaderAttrs[t],e=s.location;if(-1==e)continue;const n=this.__glattrbuffers[t];if(!n){i.disableVertexAttribArray(e);continue}let l,h,o;switch(n.dataType){case 0:l=1,h=4,o=i.UNSIGNED_BYTE;break;case 1:l=1,h=4,o=i.BYTE;break;case 2:l=1,h=4,o=i.UNSIGNED_SHORT;break;case 3:l=1,h=4,o=i.SHORT;break;case 4:l=1,h=4,o=i.UNSIGNED_INT;break;case 5:l=1,h=4,o=i.INT;break;case 6:l=1,h=4,o=i.FLOAT;break;case d:l=2,h=4,o=i.FLOAT;break;case u:l=3,h=4,o=i.FLOAT;break;case m:case p:l=4,h=4,o=i.FLOAT;break;case Z:l=4,h=1,o=i.UNSIGNED_BYTE;break;default:throw"Unhandled Type"}const a=l*h,c=null!=n.offset?n.offset*l*h:0,r=1==n.normalized,b=s.instanced;i.enableVertexAttribArray(e),i.bindBuffer(i.ARRAY_BUFFER,n.buffer),i.vertexAttribPointer(e,l,o,r,a,c),i.vertexAttribDivisor&&i.vertexAttribDivisor(e,1==b?1:0)}return i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,this.__indexBuffer),!0}unbind(){const t=this.__gl;for(const i in this.__shaderAttrs){const s=this.__shaderAttrs[i].location;-1!=s&&(t.disableVertexAttribArray(s),t.vertexAttribDivisor(s,0))}t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null)}destroy(){}}class Ls{constructor(t,i,s,e){this.__gl=t,this.__vao=t.createVertexArray(),t.bindVertexArray(this.__vao);for(const e in i){if("instancedIds"==e)continue;const n=i[e],l=n.location;if(-1==l)continue;const h=s[e];if(!h){t.disableVertexAttribArray(l);continue}let o,a,c;switch(h.dataType){case 0:o=1,a=4,c=t.UNSIGNED_BYTE;break;case 1:o=1,a=4,c=t.BYTE;break;case 2:o=1,a=4,c=t.UNSIGNED_SHORT;break;case 3:o=1,a=4,c=t.SHORT;break;case 4:o=1,a=4,c=t.UNSIGNED_INT;break;case 5:o=1,a=4,c=t.INT;break;case 6:o=1,a=4,c=t.FLOAT;break;case d:o=2,a=4,c=t.FLOAT;break;case u:o=3,a=4,c=t.FLOAT;break;case m:case p:o=4,a=4,c=t.FLOAT;break;case Z:o=4,a=1,c=t.UNSIGNED_BYTE;break;default:throw"Unhandled Type"}const r=o*a,b=null!=h.offset?h.offset*o*a:0,G=1==h.normalized,X=n.instanced;t.enableVertexAttribArray(l),t.bindBuffer(t.ARRAY_BUFFER,h.buffer),t.vertexAttribPointer(l,o,c,G,r,b),t.vertexAttribDivisor(l,X?1:0)}this.__indexBuffer=e}bind(t){return this.__gl.bindVertexArray(this.__vao),this.__indexBuffer&&this.__gl.bindBuffer(this.__gl.ELEMENT_ARRAY_BUFFER,this.__indexBuffer),!0}unbind(){const t=this.__gl;for(const i in this.__shaderAttrs){const s=this.__shaderAttrs[i].location;-1!=s&&(t.disableVertexAttribArray(s),t.vertexAttribDivisor(s,0))}this.__gl.bindVertexArray(null),this.__indexBuffer&&t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null)}destroy(){this.__gl.deleteVertexArray(this.__vao)}}function xs(t,i,s,e){return null==t.createVertexArray?new Ss(t,i,s,e):new Ls(t,i,s,e)}class vs extends F{constructor(t,i){super(),this.__gl=t,this.__geom=i,this.__glattrs={},this.__glattrbuffers={},this.__shaderBindings={},this.destructing=new v,this.updated=new v,this.__geom.geomDataChanged.connect(t=>{this.updateBuffers(t),this.updated.emit()}),this.__geom.geomDataTopologyChanged.connect(t=>{this.clearShaderBindings(),this.updateBuffers(t),this.updated.emit()})}getGeom(){return this.__geom}genBuffers(){}updateBuffers(t){}bind(t){if(this.__destroyed)throw new Error("Error binding a destroyed geom");let i=this.__shaderBindings[t.shaderkey];return i||(i=xs(this.__gl,t.attrs,this.__glattrbuffers,this.__indexBuffer),this.__shaderBindings[t.shaderkey]=i),i.bind(t),!0}unbind(t){const i=this.__shaderBindings[t.shaderkey];i&&i.unbind(t)}draw(){throw new Error("Not implemented. Implement this method in a derived class.")}drawInstanced(t){throw new Error("Not implemented. Implement this method in a derived class.")}bindAndDraw(t){this.bind(t),this.draw(t)}clearShaderBindings(){for(const t in this.__shaderBindings)this.__shaderBindings[t].destroy();this.__shaderBindings={}}destroy(){this.__geom.deleteMetadata("glgeom"),this.clearShaderBindings();const t=this.__gl;for(const i in this.__glattrbuffers){const s=this.__glattrbuffers[i];s.shared||t.deleteBuffer(s.buffer)}this.__glattrs={},this.__shaderBindings={},this.__destroyed=!0,this.destructing.emit(this)}}class Ys extends vs{constructor(t,i){super(t,i),this.genBuffers()}getNumTriangles(){return this.__numTriangles}genBuffers(){super.genBuffers();const t=this.__gl,i=this.__geom.genBuffers(),s=i.indices;this.__numTriIndices=i.indices.length,s instanceof Uint8Array&&(this.__indexDataType=this.__gl.UNSIGNED_BYTE),s instanceof Uint16Array&&(this.__indexDataType=this.__gl.UNSIGNED_SHORT),s instanceof Uint32Array&&(this.__indexDataType=this.__gl.UNSIGNED_INT),this.__numTriangles=s.length/3,this.__numRenderVerts=i.numRenderVerts,this.__indexBuffer=t.createBuffer(),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.__indexBuffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,i.indices,t.STATIC_DRAW);for(const s in i.attrBuffers){const e=i.attrBuffers[s],n=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,n),t.bufferData(t.ARRAY_BUFFER,e.values,t.STATIC_DRAW),this.__glattrbuffers[s]={buffer:n,dataType:e.dataType,normalized:e.normalized},"textureCoords"==s&&(this.__glattrbuffers.texCoords=this.__glattrbuffers.textureCoords)}}updateBuffers(t){const i=this.__gl,s=this.__geom.genBuffers({includeIndices:!1});for(const t in s.attrBuffers){const e=s.attrBuffers[t];i.bindBuffer(i.ARRAY_BUFFER,this.__glattrbuffers[t].buffer),i.bufferData(i.ARRAY_BUFFER,e.values,i.STATIC_DRAW)}}getNumUnSplitVerts(){return this.__geom.vertices.length}getNumSplitVerts(){return this.__numRenderVerts}generateWireframesVAO(){if(!this.__vao)return!1;this.__geom.edgeVerts||this.__geom.genTopologyInfo(),this.__wireframesVao&&this.__ext.deleteVertexArrayOES(this.__wireframesVao),this.__wireframesVao=this.__ext.createVertexArrayOES(),this.__ext.bindVertexArrayOES(this.__wireframesVao);const t=this.__gl,i=t.createBuffer(),s=Uint32Array.from(this.__geom.edgeVerts);t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,i),t.bufferData(t.ELEMENT_ARRAY_BUFFER,s,t.STATIC_DRAW);const e=this.__glattrbuffers.positions.buffer;t.enableVertexAttribArray(0),t.bindBuffer(t.ARRAY_BUFFER,e),t.vertexAttribPointer(0,3,t.FLOAT,!1,12,0),this.__numWireIndices=s.length,this.__ext.bindVertexArrayOES(null)}bindWireframeVAO(t){return null!=this.__wireframesVao&&(this.__ext.bindVertexArrayOES(this.__wireframesVao),!0)}unbindWireframeVAO(){this.__ext.bindVertexArrayOES(null)}drawWireframe(){this.__wireframesVao&&this.__gl.drawElements(this.__gl.LINES,this.__numWireIndices,this.__gl.UNSIGNED_INT,0)}generateHardEdgesVAO(){if(!this.__vao)return!1;this.__geom.edgeVerts||this.__geom.generateHardEdgesFlags(),this.__hardEdgesVao&&this.__ext.deleteVertexArrayOES(this.__hardEdgesVao),this.__hardEdgesVao=this.__ext.createVertexArrayOES(),this.__ext.bindVertexArrayOES(this.__hardEdgesVao);const t=this.__gl,i=t.createBuffer(),s=Uint32Array.from(this.__geom.computeHardEdgesIndices());t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,i),t.bufferData(t.ELEMENT_ARRAY_BUFFER,s,t.STATIC_DRAW);const e=this.__glattrbuffers.positions.buffer;t.enableVertexAttribArray(0),t.bindBuffer(t.ARRAY_BUFFER,e),t.vertexAttribPointer(0,3,t.FLOAT,!1,12,0),this.__numEdgeIndices=s.length,this.__ext.bindVertexArrayOES(null)}bindHardEdgesVAO(t){return null!=this.__hardEdgesVao&&(this.__ext.bindVertexArrayOES(this.__hardEdgesVao),!0)}unbindHardEdgesVAO(){this.__ext.bindVertexArrayOES(null)}drawHardEdges(){this.__hardEdgesVao&&this.__gl.drawElements(this.__gl.LINES,this.__numEdgeIndices,this.__gl.UNSIGNED_INT,0)}drawPoints(){this.__gl.drawArrays(this.__gl.POINTS,0,this.__geom.numVertices())}draw(){this.__gl.drawElements(this.__gl.TRIANGLES,this.__numTriIndices,this.__indexDataType,0)}drawInstanced(t){this.__gl.drawElementsInstanced(this.__gl.TRIANGLES,this.__numTriIndices,this.__indexDataType,0,t)}destroy(){super.destroy(),this.__gl.deleteBuffer(this.__indexBuffer),this.__indexBuffer=void 0}}class Ms extends vs{constructor(t,i){super(t,i),this.genBuffers()}genBuffers(){super.genBuffers();const t=this.__gl,i=this.__geom.genBuffers(),s=i.indices;if(this.fatLines=(this.__geom.lineThickness>0||i.attrBuffers.lineThickness)&&t.floatTexturesSupported,this.fatLines){t.__quadVertexIdsBuffer||t.setupInstancedQuad(),this.__glattrbuffers.vertexIDs=t.__quadattrbuffers.vertexIDs,this.__drawCount=s.length/2;const i=this.__geom.getVertexAttributes(),e=i.positions,n=i.lineThickness,l=new Float32Array(4*e.length);for(let t=0;t<e.length;t++)u.createFromFloat32Buffer(l.buffer,4*t).setFromOther(e.getValueRef(t)),l[4*t+3]=n?n.getFloat32Value(t):this.__geom.lineThickness;this.__positionsTexture=new Is(t,{format:"RGBA",type:"FLOAT",width:e.length,height:1,filter:"NEAREST",wrap:"CLAMP_TO_EDGE",data:l,mipMapped:!1});const h=new Float32Array(s.length);for(let t=0;t<s.length;t++){let i;i=t%2==0?t>0?s[t]==s[t-1]:s[t]==s[s.length-1]:t<s.length-1?s[t]==s[t+1]:s[t]==s[0],h[t]=(i?1:0)+2*s[t]}const o=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,o),t.bufferData(t.ARRAY_BUFFER,h,t.STATIC_DRAW),this.__glattrbuffers.segmentIndices={buffer:o,dimension:2}}else{this.__indexBuffer=t.createBuffer(),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.__indexBuffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,s,t.STATIC_DRAW);for(const s in i.attrBuffers){const e=i.attrBuffers[s],n=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,n),t.bufferData(t.ARRAY_BUFFER,e.values,t.STATIC_DRAW),this.__glattrbuffers[s]={buffer:n,dataType:e.dataType,normalized:e.normalized}}this.__numSegIndices=s.length,this.__numVertices=i.numVertices}s instanceof Uint8Array&&(this.__indexDataType=this.__gl.UNSIGNED_BYTE),s instanceof Uint16Array&&(this.__indexDataType=this.__gl.UNSIGNED_SHORT),s instanceof Uint32Array&&(this.__indexDataType=this.__gl.UNSIGNED_INT)}updateBuffers(t){const i=this.__gl,s=this.__geom.genBuffers(),e=s.indices;if(this.fatLines){this.__drawCount=e.length/2;const t=this.__geom.getVertexAttributes(),s=t.positions,n=t.lineThickness,l=new Float32Array(4*s.length);for(let t=0;t<s.length;t++)u.createFromFloat32Buffer(l.buffer,4*t).setFromOther(s.getValueRef(t)),l[4*t+3]=n?n.getFloat32Value(t):this.__geom.lineThickness;this.__positionsTexture.bufferData(l,s.length,1);const h=new Float32Array(e.length);for(let t=0;t<e.length;t++){let i;i=t%2==0?t>0&&e[t]==e[t-1]:t<e.length-1&&e[t]==e[t+1],h[t]=(i?1:0)+2*e[t]}i.bindBuffer(i.ARRAY_BUFFER,this.__glattrbuffers.segmentIndices.buffer),i.bufferData(i.ARRAY_BUFFER,h,i.STATIC_DRAW)}else{if(this.__geom.getVertexAttributes(),t&&t.indicesChanged){const t=this.__geom.getIndices();this.__numSegIndices!=t.length&&(i.deleteBuffer(this.__indexBuffer),this.__indexBuffer=i.createBuffer()),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,this.__indexBuffer),i.bufferData(i.ELEMENT_ARRAY_BUFFER,t,i.STATIC_DRAW),this.__numSegIndices=t.length}const n=s.numVertices!=this.__numVertices;for(const t in s.attrBuffers){const e=s.attrBuffers[t],l=this.__glattrbuffers[t];n&&(i.deleteBuffer(l.buffer),l.buffer=i.createBuffer()),i.bindBuffer(i.ARRAY_BUFFER,l.buffer),i.bufferData(i.ARRAY_BUFFER,e.values,i.STATIC_DRAW)}this.__numVertices=s.numVertices,this.__numSegIndices=e.length}e instanceof Uint8Array&&(this.__indexDataType=this.__gl.UNSIGNED_BYTE),e instanceof Uint16Array&&(this.__indexDataType=this.__gl.UNSIGNED_SHORT),e instanceof Uint32Array&&(this.__indexDataType=this.__gl.UNSIGNED_INT)}bind(t){if(this.fatLines&&"LineThickness"in t.unifs){const i=this.__gl;let s=this.__shaderBindings[t.shaderkey];s||(s=xs(i,t.attrs,this.__glattrbuffers,i.__quadIndexBuffer),this.__shaderBindings[t.shaderkey]=s),s.bind(t);{const s=t.unifs;s.positionsTexture&&(this.__positionsTexture.bindToUniform(t,s.positionsTexture),i.uniform1i(s.positionsTextureSize.location,this.__positionsTexture.width))}return i.uniform1f(t.unifs.LineThickness.location,(this.__geom.lineThickness?this.__geom.lineThickness:1)*t.viewScale),!0}return super.bind(t)}drawPoints(){this.__gl.drawArrays(this.__gl.POINTS,0,this.__geom.numVertices())}draw(t){const i=this.__gl;this.fatLines?t.unifs.LineThickness&&i.drawElementsInstanced(i.TRIANGLES,6,i.UNSIGNED_SHORT,0,this.__drawCount):i.drawElements(this.__gl.LINES,this.__numSegIndices,this.__indexDataType,0)}drawInstanced(t){this.__gl.drawElementsInstanced(this.__gl.LINES,this.__numSegIndices,this.__indexDataType,0,t)}}class Ks extends vs{constructor(t,i){super(t,i),this.genBuffers()}genBuffers(){super.genBuffers();const t=this.__gl,i=this.__geom.genBuffers();for(const s in i.attrBuffers){const e=i.attrBuffers[s],n=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,n),t.bufferData(t.ARRAY_BUFFER,e.values,t.STATIC_DRAW),this.__glattrbuffers[s]={buffer:n,dataType:e.dataType,normalized:e.normalized}}this.__numVerts=i.numVertices,this.__vboState=2}bind(t){if(t.unifs.PointSize){const i=this.__gl;let s=this.__shaderBindings[t.shaderkey];if(!s){i.__quadVertexIdsBuffer||i.setupInstancedQuad();const e=Object.assign(this.__glattrbuffers,i.__quadattrbuffers);s=xs(i,t.attrs,e,i.__quadIndexBuffer),this.__shaderBindings[t.shaderkey]=s}return s.bind(t),!0}return super.bind(t)}draw(t){const i=this.__gl;t.unifs.PointSize?i.drawElementsInstanced(i.TRIANGLES,6,i.UNSIGNED_SHORT,0,this.__numVerts):i.drawArrays(i.POINTS,0,this.__numVerts)}drawInstanced(t){this.__gl.drawArraysInstanced(this.__gl.POINTS,0,this.__numVerts,t)}}const Cs={bool:Boolean,int:5,uint:4,float:6,ivec2:d,ivec3:u,ivec4:m,vec2:d,vec3:u,vec4:m,color:p,mat3:X,mat4:y,sampler2D:Kt},ws=new class{constructor(){this.__shaderModules={}}hasShaderModule(t){return t in this.__shaderModules}setShaderModule(t,i){return this.parseShader(t,i)}getShaderModule(t){return this.__shaderModules[t]}getShaderModuleNames(){const t=[];for(const i in this.__shaderModules)t.push(i);return t}parseShader(t,i){const s=t=>t.startsWith("..")?e.substring(0,e.lastIndexOf("/"))+t.substring(2):t.startsWith(".")?e+t.substring(1):t.startsWith("/")?t.substring(1):t,e=(h(t),t.substring(0,t.lastIndexOf("/"))),n=i.split("\n"),l={glsl:" //starting:"+t+"\n",lines:n,numLines:0,includeMetaData:[],uniforms:{},attributes:{}},o=/\s+/;for(let i=0;i<n.length;i++){let e=n[i],a=e.trim();if(a.startsWith("//")||a.startsWith("*"))l.glsl=l.glsl+e+"\n",l.numLines++;else if(-1!=a.indexOf("//")&&(a=a.slice(0,a.indexOf("//")).trim()),a.startsWith("<%")||a.startsWith("</%")){const a=function(t){const i=(t=(t=t.startsWith("</%")?t.slice(3):t.slice(2)).endsWith("/>")?t.slice(0,t.length-2):t.slice(0,t.length-1)).split(o),s={tag:i.shift(),attributes:{}};for(const t of i){const i=t.split("=");s.attributes[i[0]]=i[1].replace(/['"]+/g,"")}return s}(n[i].trim());switch(a.tag){case"include":{const e=s(a.attributes.file);if(!this.hasShaderModule(e))throw new Error("Error while parsing :"+t+" \nShader module not found:"+e+"\n in:"+this.getShaderModuleNames());const n=this.getShaderModule(e);h(a.attributes.file);let o=n.glsl;o=o.substring(o.indexOf("\n")+1),l.glsl=l.glsl+" //including:"+a.attributes.file+"\n";const c={};for(const t in a.attributes){if("file"==t)continue;const i=a.attributes[t];o=o.replaceAll(t,i),c[t]=i}l.glsl=l.glsl+o,l.includeMetaData.push({src:l.numLines,tgt:i,length:n.numLines,key:e}),l.glsl=l.glsl+" //continuing:"+t+"\n",l.numLines+=n.numLines+1;for(const t in n.attributes){let i=t;for(const t in c)i=i.replaceAll(t,c[t]);l.attributes[i]=n.attributes[t]}for(const t in n.uniforms){let i=t;for(const t in c)i=i.replaceAll(t,c[t]);l.uniforms[i]=n.uniforms[t]}break}default:console.warn("Error while parsing :"+t+" \nUnhandled line:"+e);continue}}else{const s=(i,s)=>{if(!(i[1]in Cs))throw new Error("Error while parsing :"+t+" \nType not recognized:"+i[1]);const n=i[2].slice(0,i[2].length-1);l.attributes[n]={type:Cs[i[1]],instanced:s},"color"==i[1]&&(i[1]="vec4",e=i.join(" "))};if(a.startsWith("struct")){let t="";if(-1!=a.indexOf("}"))t=a.substring(a.indexOf("{")+1,a.indexOf("}")-1);else for(i++;e+=n[i]+"\n",t+=e.trim(),i++,-1==t.indexOf("}"););const s=t.substring(t.indexOf("{")+1,t.indexOf("}")-1).split(";"),l=[];for(const t of s){if(0==t.length)continue;const i=t.trim().split(o);l.push({name:i[1],type:Cs[i[0]]})}const h=a.split(o);Cs[h[1]]=l}if(a.startsWith("attribute")&&s(a.split(o),!1),a.startsWith("instancedattribute")){const t=a.split(o);s(t,!0),t[0]="attribute",e=t.join(" ")}else if(a.startsWith("uniform")){const i=a.split(o);let s=1;4==i.length&&(s=2);const n=i[s];if(!(n in Cs))throw new Error("Error while parsing :"+t+" \nType not recognized:"+i[1]);const h=i[s+1].slice(0,i[s+1].length-1);l.uniforms[h]=Cs[n],"struct"==l.uniforms[h]&&console.log(i),"color"==i[1]&&(i[1]="vec4",e=i.join(" "))}l.glsl=l.glsl+e+"\n",l.numLines++}}return this.__shaderModules[t]=l,l}};class Fs extends Q{constructor(t){if(super(),!t)throw new Error("gl context must be passed to shader constructor");this.__gl=t,this.__shaderStages={VERTEX_SHADER:{glsl:"",lines:0,uniforms:{},attributes:{}},FRAGMENT_SHADER:{glsl:"",lines:0,uniforms:{},attributes:{}}},this.__shaderProgramHdls={},this.__gltextures={},this.updated=new v,this.invisibleToGeomBuffer=!1}static isTransparent(){return!1}static isOverlay(){return!1}__compileShaderStage(t,i,s,e){const n=this.__gl;if(e||(e=n.shaderopts),e){if(e.repl)for(const i in e.repl)t=t.replaceAll(i,e.repl[i]);e.defines&&(t=e.defines+t)}"webgl2"==n.name&&(t="#version 300 es\n"+(t=(t=(t=t.replaceAll("attribute","in")).replaceAll("varying","vertexShader"==s?"out":"in")).replaceAll("texture2D","texture")));const l=n.createShader(i);if(n.shaderSource(l,t),n.compileShader(l),!n.getShaderParameter(l,n.COMPILE_STATUS)){console.log("Errors in :"+this.constructor.name);const i=n.getShaderInfoLog(l).split("\n"),e={};for(let t in i){if(i[t].startsWith("'")){i[t-1]=i[t-1]+i[t],delete i[t],t--;continue}const s=i[t].split(":");if(s.length>=2){const n=parseInt(s[2]);isNaN(n)||(e[n]?e[n].push(i[t]):e[n]=[i[t]])}}const h=[],o=t.split("\n");for(let t=0;t<o.length;t++)if(h.push((t+1+":").lpad(" ",3)+o[t]),t+1 in e){const i=e[t+1];for(const t of i)h.push(t),h.push("-".lpad("-",t.length))}throw new Error("An error occurred compiling the shader \n=================\n"+this.constructor.name+"."+s+": \n\n"+i.join("\n")+"\n"+h.join("\n"))}return l}__createProgram(t){const i=this.__gl;this.__shaderCompilationAttempted=!0;const s=i.createProgram(),e=this.__shaderStages.VERTEX_SHADER.glsl,n={};if(null!=e){const l=this.__compileShaderStage(e,i.VERTEX_SHADER,"vertexShader",t);if(!l)return!1;i.attachShader(s,l),n[i.VERTEX_SHADER]=l}const l=this.__shaderStages.FRAGMENT_SHADER.glsl;if(null!=l){const e=Object.assign({},i.shaderopts,t);e.frag&&(e.defines=e.frag.defines+e.defines);const h=this.__compileShaderStage(l,i.FRAGMENT_SHADER,"fragmentShader",e);if(!h)return!1;i.attachShader(s,h),n[i.FRAGMENT_SHADER]=h}if(i.linkProgram(s),!i.getProgramParameter(s,i.LINK_STATUS)){const t=i.getProgramInfoLog(s);if(t.includes("D3D shader compilation failed")){const t=i.getExtension("WEBGL_debug_shaders");if(t){const s=t.getTranslatedShaderSource(n[i.VERTEX_SHADER]);console.log(s)}}throw console.log("vertexShaderGLSL:"+e),console.log("fragmentShaderGLSL:"+l),new Error("Unable to link the shader program:"+this.constructor.name+"\n==================\n"+t)}const h=this.__extractAttributeAndUniformLocations(s,t);return h.shaderProgramHdl=s,h}__extractAttributeAndUniformLocations(t,i){const s=this.__gl,e=this.getAttributes(),n={attrs:{},unifs:{}};for(const i in e){const l=s.getAttribLocation(t,i);if(null==l){console.warn("Shader attribute not found:"+i);continue}const h=e[i];n.attrs[i]={name:i,location:l,type:h.type,instanced:h.instanced}}const l=this.getUniforms();for(let e in l){const h=l[e];if(h instanceof Array)for(const i of h){const l=e+"."+i.name,h=s.getUniformLocation(t,l);null!=h&&(n.unifs[l]={name:l,location:h,type:i.type})}if(i&&i.repl)for(const t in i.repl)e=e.replace(t,i.repl[t]);const o=s.getUniformLocation(t,e);null!=o&&(n.unifs[e]={name:e,location:o,type:h})}return n}getAttributes(){const t={};for(const i in this.__shaderStages){const s=this.__shaderStages[i];for(const i in s.attributes)t[i]=s.attributes[i]}return t}getUniforms(){const t={};for(const i in this.__shaderStages){const s=this.__shaderStages[i];for(const i in s.uniforms)t[i]=s.uniforms[i]}return t}finalize(){}compileForTarget(t,i){t||(t=this.constructor.name);let s=this.__shaderProgramHdls[t];return s||!1!==s&&(s=this.__createProgram(i),this.__shaderProgramHdls[t]=s),s}compile(){this.compileForTarget()}bind(t,i){const s=this.__gl;if(t.glshader!=this){const e=this.compileForTarget(i,t.shaderopts);if(!1===e)return console.warn(this.constructor.name+" is not compiled for "+i),!1;s.useProgram(e.shaderProgramHdl),t.shaderkey=this.constructor.name,t.glshader=this,t.boundTextures=0,t.boundLightmap=void 0,t.glgeom=void 0,t.unifs=e.unifs,t.attrs=e.attrs,t.bindRendererUnifs&&t.bindRendererUnifs(e.unifs)}return t.supportsInstancing=!0,!0}unbind(t){return!0}static getParamDeclarations(){return[]}static getGeomDataShaderName(){}static getSelectedShaderName(){}destroy(){const t=this.__gl;for(const i in this.__shaderProgramHdls)t.deleteProgram(this.__shaderProgramHdls[i].shaderProgramHdl);this.__shaderProgramHdls={}}}ws.setShaderModule("utils/quadVertexFromID.glsl","\n\nattribute float vertexIDs;\n\nvec2 getQuadVertexPositionFromID(){\n    int vertexID = int(vertexIDs);\n    if(vertexID == 0)\n        return vec2(-0.5, -0.5);\n    else if(vertexID == 1)\n        return vec2(0.5, -0.5);\n    else if(vertexID == 2)\n        return vec2(-0.5, 0.5);\n    else if(vertexID == 3)\n        return vec2(0.5, 0.5);\n    return vec2(0,0);\n}\n"),ws.setShaderModule("utils/unpackHDR.glsl","\n\nvec3 decodeHDR(const in vec3 ldrPixel, const in float cdmAlpha) {\n    float avg = (cdmAlpha * 16.0 - 8.0);\n    float scl = 1.0;\n    vec3 color;\n    color.x = (tan((ldrPixel.x-0.5)*1.5)/scl)+avg;\n    color.y = (tan((ldrPixel.y-0.5)*1.5)/scl)+avg;\n    color.z = (tan((ldrPixel.z-0.5)*1.5)/scl)+avg;\n\n    // convert from logarithmic curve to linear curve.\n    // subtract the epsilon that was added during encoding.\n    const float eps = 0.001;\n    color.x = pow(10.0, color.x) - eps;\n    color.y = pow(10.0, color.y) - eps;\n    color.z = pow(10.0, color.z) - eps;\n    return color;\n}\n\nvec3 decodeHDR(sampler2D ldrSampler, sampler2D cdmSampler, vec2 texCoord) {\n#ifdef ENABLE_ES3\n    float cdm = texture2D(cdmSampler, texCoord).r;\n#else\n    float cdm = texture2D(cdmSampler, texCoord).a;\n#endif\n    return decodeHDR(texture2D(ldrSampler, texCoord).rgb, cdm);\n}\n\n");class Ns extends Fs{constructor(t){super(t),this.__shaderStages.VERTEX_SHADER=ws.parseShader("UnpackHDRShader.vertexShader",'\nprecision highp float;\n\n<%include file="utils/quadVertexFromID.glsl"/>\n\n/* VS Outputs */\nvarying vec2 v_texCoord;\n \nvoid main()\n{\n    vec2 position = getQuadVertexPositionFromID();\n    v_texCoord = position+0.5;\n    gl_Position = vec4(position*2.0, 0.0, 1.0);\n}\n'),this.__shaderStages.FRAGMENT_SHADER=ws.parseShader("UnpackHDRShader.fragmentShader",'\nprecision highp float;\n\nvarying vec2 v_texCoord;\nuniform sampler2D ldrSampler;\nuniform sampler2D cdmSampler;\nuniform float exposure;\nuniform vec4 tint;\n\n<%include file="utils/unpackHDR.glsl"/>\n\n#ifdef ENABLE_ES3\n    out vec4 fragColor;\n#endif\nvoid main(void) {\n\n#ifndef ENABLE_ES3\n    vec4 fragColor;\n#endif\n\n    fragColor = vec4(decodeHDR(ldrSampler, cdmSampler, v_texCoord) * tint.rgb * exposure, 1.0);\n\n#ifndef ENABLE_ES3\n    gl_FragColor = fragColor;\n#endif\n}\n\n')}}class Ts{constructor(t,i,s=!1){!e.isIOSDevice||"FLOAT"!=i.getType()&&"HALF_FLOAT"!=i.getType()||console.error("IOS devices are unable to render to float textures."),this.__gl=t,this.__colorTexture=i,this.__createDepthTexture=s,this.__clearColor=[0,0,0,0],this.__depthTexture=void 0,this.setup=this.setup.bind(this),this.resize=this.resize.bind(this),this.__colorTexture&&this.__colorTexture.resized.connect(this.resize),this.setup()}setClearColor(t){this.__clearColor=t}getWidth(){return this.__colorTexture.width}getHeight(){return this.__colorTexture.height}getSize(){return[this.__colorTexture.width,this.__colorTexture.height]}getColorTexture(){return this.__colorTexture}getDepthTextureGL(){return this.__depthTexture}get width(){return this.__colorTexture.width}get height(){return this.__colorTexture.height}get size(){return[this.__colorTexture.width,this.__colorTexture.height]}get colorTexture(){return this.__colorTexture}setColorTexture(t){this.__colorTexture=t,gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,this.__colorTexture.glTex,0)}get depthTextureGL(){return this.__depthTexture}setup(){const t=this.__gl;if(this.__fbo=t.createFramebuffer(),t.bindFramebuffer("webgl2"==t.name?t.DRAW_FRAMEBUFFER:t.FRAMEBUFFER,this.__fbo),this.__colorTexture&&t.framebufferTexture2D("webgl2"==t.name?t.DRAW_FRAMEBUFFER:t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.__colorTexture.glTex,0),this.__createDepthTexture)if("webgl2"==t.name||t.__ext_WEBGL_depth_texture)t.activeTexture(t.TEXTURE0),this.__depthTexture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this.__depthTexture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),"webgl2"==t.name?(t.texImage2D(t.TEXTURE_2D,0,t.DEPTH_COMPONENT24,this.width,this.height,0,t.DEPTH_COMPONENT,t.UNSIGNED_INT,null),t.framebufferTexture2D(t.DRAW_FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.TEXTURE_2D,this.__depthTexture,0)):(t.texImage2D(t.TEXTURE_2D,0,t.DEPTH_COMPONENT,this.width,this.height,0,t.DEPTH_COMPONENT,t.UNSIGNED_INT,null),t.framebufferTexture2D(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.TEXTURE_2D,this.__depthTexture,0));else{const i=t.createRenderbuffer();t.bindRenderbuffer(t.RENDERBUFFER,i),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,this.width,this.height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,i)}this.__checkFramebuffer(),t.bindFramebuffer("webgl2"==t.name?t.DRAW_FRAMEBUFFER:t.FRAMEBUFFER,null)}resize(){const t=this.__gl;t.bindFramebuffer("webgl2"==t.name?t.DRAW_FRAMEBUFFER:t.FRAMEBUFFER,this.__fbo),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.__colorTexture.glTex,0),this.__depthTexture&&(t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this.__depthTexture),t.texImage2D(t.TEXTURE_2D,0,"webgl2"==t.name?t.DEPTH_COMPONENT24:t.DEPTH_COMPONENT,this.width,this.height,0,t.DEPTH_COMPONENT,t.UNSIGNED_INT,null)),this.__checkFramebuffer()}__checkFramebuffer(){const t=this.__gl;let i;if(i=t.checkFramebufferStatus("webgl2"==t.name?t.DRAW_FRAMEBUFFER:t.FRAMEBUFFER),i!==t.FRAMEBUFFER_COMPLETE)switch(t.bindTexture(t.TEXTURE_2D,null),t.bindFramebuffer("webgl2"==t.name?t.DRAW_FRAMEBUFFER:t.FRAMEBUFFER,null),console.warn("Error creating Fbo width:",this.width,", height:",this.height," Texture Type:",this.__colorTexture.getType()),i){case t.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw new Error("The attachment types are mismatched or not all framebuffer attachment points are framebuffer attachment complete.");case t.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw new Error("There is no attachment.");case t.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw new Error("Height and width of the attachment are not the same.");case t.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw new Error("The format of the attachment is not supported or if depth and stencil attachments are not the same renderbuffer.");case 36061:throw new Error("The framebuffer is unsupported");default:throw new Error("Incomplete Frambuffer")}}bindForWriting(t){t&&(this.__prevBoundFbo=t.boundRendertarget,t.boundRendertarget=this.__fbo);const i=this.__gl;i.bindFramebuffer("webgl2"==i.name?i.DRAW_FRAMEBUFFER:i.FRAMEBUFFER,this.__fbo),i.viewport(0,0,this.width,this.height)}unbindForWriting(t){t&&(t.boundRendertarget=this.__prevBoundFbo);const i=this.__gl;i.bindFramebuffer("webgl2"==i.name?i.DRAW_FRAMEBUFFER:i.FRAMEBUFFER,this.__prevBoundFbo)}bind(t){this.bindForWriting(t)}unbind(t){this.unbindForWriting(t)}bindForReading(){const t=this.__gl;t.bindFramebuffer("webgl2"==t.name?t.READ_FRAMEBUFFER:t.FRAMEBUFFER,this.__fbo)}unbindForReading(){const t=this.__gl;t.bindFramebuffer("webgl2"==t.name?t.READ_FRAMEBUFFER:t.FRAMEBUFFER,null)}clear(){const t=this.__gl;t.colorMask(!0,!0,!0,!0),t.clearColor(...this.__clearColor),t.clear(this.__createDepthTexture?t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT:t.COLOR_BUFFER_BIT)}bindAndClear(t){this.bind(t),this.clear(t)}unbind(){const t=this.__gl;t.bindFramebuffer(t.FRAMEBUFFER,null)}destroy(){const t=this.__gl;t.bindFramebuffer(t.FRAMEBUFFER,null),t.deleteFramebuffer(this.__fbo),this.__fbo=null,this.__colorTexture.resized.disconnect(this.resize)}}class Js extends Is{constructor(t,i){super(t),this.__hdrImage=i,this.__hdrImage.setMetadata("gltexture",this),this.__hdrImage.updated.connect(()=>{this.__unpackHDRImage(this.__hdrImage.getParams())}),this.__hdrImage.isLoaded()?this.__unpackHDRImage(this.__hdrImage.getParams()):this.__hdrImage.loaded.connect(()=>{this.__unpackHDRImage(this.__hdrImage.getParams())})}__unpackHDRImage(t){const i=this.__gl,s=t.data.ldr,e=t.data.cdm;if(this.__fbo)this.__srcLDRTex.bufferData(s),this.__srcCDMTex.bufferData(e);else{this.configure({format:"RGBA",type:"FLOAT",width:s.width,height:s.height,filter:"LINEAR",wrap:"CLAMP_TO_EDGE"}),this.__fbo=new Ts(i,this),this.__fbo.setClearColor([0,0,0,0]),this.__srcLDRTex=new Is(i,{format:"RGB",type:"UNSIGNED_BYTE",width:s.width,height:s.height,filter:"NEAREST",mipMapped:!1,wrap:"CLAMP_TO_EDGE",data:s}),this.__srcCDMTex=new Is(i,{format:"webgl2"==i.name?"RED":"ALPHA",type:"UNSIGNED_BYTE",width:s.width,height:s.height,filter:"NEAREST",mipMapped:!1,wrap:"CLAMP_TO_EDGE",data:e}),this.__unpackHDRShader=new Ns(i);const t=this.__unpackHDRShader.compileForTarget("GLHDRImage");this.__shaderBinding=xs(i,t.attrs,i.__quadattrbuffers,i.__quadIndexBuffer)}this.__fbo.bindAndClear();const n={};this.__unpackHDRShader.bind(n,"GLHDRImage"),this.__shaderBinding.bind(n);const l=n.unifs;this.__srcLDRTex.bindToUniform(n,l.ldrSampler),this.__srcCDMTex.bindToUniform(n,l.cdmSampler),i.uniform1f(l.exposure.location,1),i.uniform4fv(l.tint.location,this.__hdrImage.getHDRTint().asArray()),i.drawQuad(),this.__fbo.unbind(),this.updated.emit()}bindToUniform(t,i,s){return super.bindToUniform(t,i,s)}destroy(){super.destroy(),this.__fbo&&(this.__fbo.destroy(),this.__srcLDRTex.destroy(),this.__srcCDMTex.destroy()),this.__unpackHDRShader&&this.__unpackHDRShader.destroy(),this.__shaderBinding&&this.__shaderBinding.destroy(),this.__hdrImage.loaded.disconnectScope(this),this.__hdrImage.updated.disconnectScope(this)}}ws.setShaderModule("GLSLUtils.glsl","\n\n\nint ftoi(float val){\n    return int(floor(val + 0.5));\n}\n\n#ifdef ENABLE_ES3\n\nint imod(int x, int y) {\n    return x % y;\n}\n\nvoid setFlag(inout int flags, int flag) {\n    flags |= flag;\n}\n\nvoid clearFlag(inout int flags, int flag) {\n    flags &= ~flag;\n}\n\nbool testFlag(int flags, int flag) {\n    return (flags & flag) != 0;\n}\n\n// private function: Mangle me...\nivec2 _pixelIndexToUV(int index, int textureWidth){\n    return ivec2(index % textureWidth, index / textureWidth);\n}\n\nvec4 fetchTexel(sampler2D texture, int textureWidth, int index) {\n    return texelFetch(texture, _pixelIndexToUV(index, textureWidth), 0);\n}\n\nvec4 fetchTexel(sampler2D texture, ivec2 textureSize, ivec2 texCoord) {\n    return texelFetch(texture, texCoord, 0);\n}\n\n#else\n\n// TODO: integrate: https://gist.github.com/mattatz/70b96f8c57d4ba1ad2cd\n\nint max(int a, int b) {\n    return a > b ? a : b;\n}\nint min(int a, int b) {\n    return a < b ? a : b;\n}\n\n\nfloat round(float val){\n    return floor(val + 0.4);\n}\n\nint imod(int x, int y) {\n    return x-y*(x/y);\n}\n\nvoid setFlag(inout int flags, int flag) {\n    flags += flag;\n}\nvoid clearFlag(inout int flags, int flag) {\n    flags -= flag;\n}\n\nbool testFlag(int flags, int flag) {\n    return imod(flags / flag, 2) != 0;\n}\n\n// private function: Mangle me...\nvec2 _pixelIndexToUV(int index, int textureSize){\n    float flTexSize = float(textureSize);\n    float x = (float(imod(index, textureSize))+0.5)/flTexSize;\n    float y = (floor(float(index / textureSize))+0.5)/flTexSize;\n    return vec2(x, y);\n}\n\nvec4 fetchTexel(sampler2D texture, int textureSize, int index) {\n    vec2 texCoord = _pixelIndexToUV(index, textureSize);\n    return texture2D(texture, texCoord);\n}\n\nvec4 fetchTexel(sampler2D texture, ivec2 textureSize, ivec2 texCoord) {\n    vec2 ftextureSize = vec2(textureSize);\n    return texture2D(texture, (vec2(texCoord) + 0.5) / ftextureSize);\n}\n\n\n#endif\n\nint uvToPixelIndex(vec2 uv, int textureSize){\n    return int(uv.x * float(textureSize)) + (int(floor(uv.y * float(textureSize))) * textureSize);\n}\n\n\n\n"),ws.setShaderModule("utils/ImageStream.glsl","\n\n// Stream Desc looks like the following\n// x : atlas Width in images\n// y : atlas height in images\n// z : image Width\n// w : image Height\n\nvec2 calcFrameImageTexCoords(vec2 texCoord, int index, in vec4 streamDesc){\n\tfloat index_x = floor(mod(float(index), streamDesc.x));\n\tfloat index_y = floor(float(index) / streamDesc.x);\n    return vec2( \n    \t(index_x + texCoord.x) / streamDesc.x, \n    \t(index_y + texCoord.y) / streamDesc.y\n    \t);\n}\n\nvec4 sampleStreamFrame(vec2 texCoord, int index, in sampler2D streamImage, in vec4 streamDesc){\n    return texture2D(streamImage, calcFrameImageTexCoords(texCoord, index, streamDesc));\n}\n\n");class zs{constructor(t,i){this.__gl=t,this.__streamImage=i,this.ready=new v(!0),this.updated=new v,this.resized=new v,this.__descParam=this.__streamImage.getParameter("StreamAtlasDesc"),this.__indexParam=this.__streamImage.getParameter("StreamAtlasIndex"),this.__indexParam.valueChanged.connect(this.updated.emit);const s=()=>{const i=this.__streamImage.getParams();i.data.__atlasTexture||(i.data.__atlasTexture=new Is(t,i)),this.__atlasTexture=i.data.__atlasTexture,this.__atlasTexture.textureType=2,this.__atlasTexture.textureDesc=this.__descParam.getValue().asArray()};this.__streamImage.isLoaded()?s():this.__streamImage.loaded.connect(()=>{s()})}preBind(t,i){const s=this.__atlasTexture.preBind(t,i);return s.textureDescUnif=i[t.name+"Desc"],s.textureIndexUnif=i[t.name+"Index"],s}bindToUniform(t,i,s){return!!this.__atlasTexture.bindToUniform(t,i,s)&&(s&&s.textureIndexUnif&&this.__gl.uniform1i(s.textureIndexUnif.location,this.__indexParam.getValue()),!0)}}class Hs{constructor(t,i,s,e){switch(this.__unif=e,e.type){case Boolean:this.uniformXX=t.uniform1i.bind(t);break;case 4:this.uniformXX="webgl2"==t.name?t.uniform1ui.bind(t):t.uniform1i.bind(t);break;case 5:this.uniformXX=t.uniform1i.bind(t);break;case 6:this.uniformXX=t.uniform1f.bind(t)}this.__val=s.getValue(),s.valueChanged.connect(()=>{this.__val=s.getValue(),i.updated.emit()})}bind(t){this.uniformXX(this.__unif.location,this.__val)}unbind(){}destroy(){}}class Us{constructor(t,i,s,e){switch(this.__unif=e,e.type){case d:this.uniformXX=t.uniform2fv.bind(t);break;case u:this.uniformXX=t.uniform3fv.bind(t);break;case m:this.uniformXX=t.uniform4fv.bind(t)}this.__vals=s.getValue().asArray(),s.valueChanged.connect(()=>{this.__vals=s.getValue().asArray(),i.updated.emit()})}bind(t){this.uniformXX(this.__unif.location,this.__vals)}unbind(){}destroy(){}}class ks{constructor(t,i,s,e){switch(this.__unif=e,e.type){case Mat3:this.uniformMatrixXXX=t.uniformMatrix3fv.bind(t);break;case y:this.uniformMatrixXXX=t.uniformMatrix4fv.bind(t)}this.__vals=s.getValue().asArray(),s.valueChanged.connect(()=>{this.__val=s.getValue().asArray(),i.updated.emit()})}bind(t){this.uniformMatrixXXX(this.__unif.location,!1,this.__val)}unbind(){}destroy(){}}class Bs{constructor(t,i,s,e,n){this.__gl=t,this.__unif=e,this.__textureUnif=n[e.name+"Tex"],this.__textureTypeUnif=n[e.name+"TexType"],this.__vals=[0,0,0,0],this.bind=this.bindValue;const l=t=>{let s=t.getMetadata("gltexture");s||(s="FLOAT"===t.type?new Js(this.__gl,t):t.isStreamAtlas()?new zs(this.__gl,t):new Is(this.__gl,t)),this.texBinding=s.preBind(this.__textureUnif,n),s.updated.connect(()=>{i.updated.emit()}),this.gltexture=s,this.gltexture.addRef(this),this.textureType=1,this.bind=this.bindTexture,i.updated.emit()};let h,o;const a=()=>{l(h)},c=t=>{t.isLoaded()?l(t):t.loaded.connect(a),h=t},r=()=>{h.getMetadata("gltexture").removeRef(this),this.texBinding=null,this.gltexture=null,this.textureType=null,this.bind=this.bindValue,o&&h.loaded.disconnectId(o),h=null,o=null,i.updated.emit()},d=()=>{const t=s.getValue(!1);if(this.__vals=t.asArray(),this.__textureUnif){let t;s.getImage&&(t=s.getImage()),t&&t!=h?c(t):!t&&h&&r()}i.updated.emit()};d(),s.textureConnected&&s.textureConnected.connect(()=>{c(s.getImage())}),s.valueChanged.connect(d),this.uniform1i=t.uniform1i.bind(t),this.uniform4fv=t.uniform4fv.bind(t)}bindValue(t){this.uniform4fv(this.__unif.location,this.__vals),this.__textureTypeUnif&&this.uniform1i(this.__textureTypeUnif.location,0)}bindTexture(t){this.gltexture.bindToUniform(t,this.__textureUnif,this.texBinding)}}const Ps={};class Es{constructor(t,i,s,e){this.__uniformBindings=[];const n=n=>{const l=n.getName(),h=s[l];if(null!=h)switch(h.type){case Boolean:case 4:case 5:case 6:this.__uniformBindings.push(new Hs(t,i,n,h));break;case d:case u:case m:this.__uniformBindings.push(new Us(t,i,n,h));break;case p:this.__uniformBindings.push(new Bs(t,i,n,h,s));break;case y:this.__uniformBindings.push(new ks(t,i,n,h));break;default:return void console.warn("Param :"+l+" has unhandled data type:"+h.type)}else if(e){const t=i.getMaterial().getShaderName();Ps[t]||(Ps[t]={}),Ps[t][l]||(console.warn("Material:"+i.getMaterial().getName(),"with Shader ",t,"Param has no unif",l),Ps[t][l]=!0)}},l=i.getMaterial().getParameters();for(const t of l)n(t)}bind(t){for(const i of this.__uniformBindings)i.bind(t);return!0}unbind(){for(const t of this.__uniformBindings)t.unbind(renderstate)}destroy(){for(const t of this.__uniformBindings)t.destroy(renderstate)}}class Qs{constructor(t,i,s){this.__gl=t,this.__material=i,this.__glshader=s,this.updated=new v,this.__shaderBindings={}}getMaterial(){return this.__material}getGLShader(){return this.__glshader}generateShaderBinding(){const t=this.__material.getParameters();for(const i of t)bindParam(gl,i)}bind(t,i){this.__boundTexturesBeforeMaterial=t.boundTextures;let s=this.__shaderBindings[t.shaderkey];return s||(s=new Es(this.__gl,this,t.unifs,i),this.__shaderBindings[t.shaderkey]=s),s.bind(t)}unbind(t){t.boundTextures=this.__boundTexturesBeforeMaterial}}class js{constructor(t,i){this.resized=new v,this.updated=new v,this.__gl=t,this.textureTargets=[],this.depthTexture=null,i&&this.configure(i)}configure(t){const i=this.__gl,s=function(t,i){if(!i.width||!i.height)throw new Error("Invalid texture params");const s=t.getParameter(t.MAX_TEXTURE_SIZE);if(i.width<=0||i.width>s||i.height<=0||i.height>s)throw new Error("GLTextureParams: Invalid texture size. width:"+i.width+" height:"+i.height+" maxSize:"+s);const e={width:i.width,height:i.height},n=(s,n)=>{s in i?e[s]=isNaN(i[s])?t[i[s]]:i[s]:n&&(e[s]=n)};if(n("format"),n("internalFormat",e.format),n("type",t.UNSIGNED_BYTE),n("minFilter",t.LINEAR),n("magFilter",t.LINEAR),n("wrapS",t.CLAMP_TO_EDGE),n("wrapT",t.CLAMP_TO_EDGE),n("flipY",!1),n("mipMapped",!1),n("depthFormat"),n("depthType"),e.format==t.FLOAT)if("webgl2"==t.name)e.filter!=t.LINEAR||t.__ext_float_linear||(console.warn("Floating point texture filtering not supported on result device"),e.filter=t.NEAREST);else if(t.__ext_float)e.filter!=t.LINEAR||t.__ext_float_linear||(console.warn("Floating point texture filtering not supported on result device"),e.filter=t.NEAREST);else{if(!t.__ext_half_float)throw new Error("OES_texture_half_float is not available");e.format=t.HALF_FLOAT,e.filter!=t.LINEAR||t.__ext_texture_half_float_linear||(console.warn("Half Float texture filtering not supported on result device"),e.filter=t.NEAREST)}else if(e.format==t.HALF_FLOAT)if("webgl2"==t.name);else{if(!t.__ext_half_float)throw new Error("OES_texture_half_float is not available");if(e.filter!=t.LINEAR||t.__ext_texture_half_float_linear||(console.warn("Half Float texture filtering not supported on result device"),e.filter=t.NEAREST),e.channels==t.RGB)throw new Error("OES_texture_half_float onlysupports RGBA textures")}else if("sRGB"==e.format&&!t.__ext_sRGB)throw new Error("EXT_sRGB is not available");return null!=e.format&&"webgl2"==t.name&&e.internalFormat==e.format&&(e.type==t.FLOAT?e.format==t.RED||e.format==t.RED?e.internalFormat=t.R32F:e.format==t.RG?e.internalFormat=t.RG32F:e.format==t.RGBA&&(e.internalFormat=t.RGBA32F):e.type==t.HALF_FLOAT?e.format==t.RED?e.internalFormat=t.R16F:e.format==t.RGB?e.internalFormat=t.RGB16F:e.format==t.RGBA&&(e.internalFormat=t.RGBA16F):e.type==t.UNSIGNED_BYTE&&(e.format==t.RED&&(e.internalFormat=t.R8),e.format==t.RGB?e.internalFormat=t.RGB8:e.format==t.RGBA&&(e.internalFormat=t.RGBA8))),null!=e.depthFormat&&("webgl2"==t.name?e.depthType==t.UNSIGNED_SHORT?e.depthInternalFormat=t.DEPTH_COMPONENT16:e.depthType==t.UNSIGNED_INT&&(e.depthInternalFormat=t.UNSIGNED_INT):e.depthInternalFormat=e.depthFormat),e}(i,t);this.textureTargets.forEach(t=>{i.deleteTexture(t)}),this.textureTargets=[],this.depthTexture&&(i.deleteTexture(this.depthTexture),this.depthTexture=null),this.frameBuffer&&i.deleteFramebuffer(this.frameBuffer),this.type=s.type,this.format=s.format,this.internalFormat=s.internalFormat,this.filter=s.filter,this.wrap=s.wrap,this.flipY=s.flipY,this.width=s.width,this.height=s.height,this.clearColor=new p(0,0,0,0),this.colorMask=[!0,!0,!0,!0],this.textureType=1,this.textureDesc=[this.width,this.height,0,0];const e=null!=t.numColorChannels?t.numColorChannels:null!=s.format?1:0;for(let t=0;t<e;t++){i.activeTexture(i.TEXTURE0+1);const t=i.createTexture();i.bindTexture(i.TEXTURE_2D,t),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,s.wrapS),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,s.wrapT),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,s.minFilter),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,s.magFilter),i.texImage2D(i.TEXTURE_2D,0,this.internalFormat,s.width,s.height,0,this.format,this.type,null),this.textureTargets.push(t)}if(s.depthFormat){if("webgl"==i.name&&!i.__ext_WEBGL_depth_texture)throw new Error("Depth textures not support on this device");i.activeTexture(i.TEXTURE0),this.depthTexture=i.createTexture(),i.bindTexture(i.TEXTURE_2D,this.depthTexture),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,s.wrapS),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,s.wrapT),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,s.minFilter),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,s.magFilter),i.texImage2D(i.TEXTURE_2D,0,s.depthInternalFormat,s.width,s.height,0,s.depthFormat,s.depthType,null)}if(this.frameBuffer=i.createFramebuffer(),i.bindFramebuffer("webgl2"==i.name?i.DRAW_FRAMEBUFFER:i.FRAMEBUFFER,this.frameBuffer),this.textureTargets.length>0){if(this.textureTargets.length>1&&"webgl"==i.name&&!i.drawBuffers){i.__ext_draw_buffers=i.getExtension("WEBGL_draw_buffers"),i.drawBuffers=i.__ext_draw_buffers.drawBuffersWEBGL.bind(i.__ext_draw_buffers);for(let t=1;t<14;t++)i["COLOR_ATTACHMENT"+t]=i.__ext_draw_buffers["COLOR_ATTACHMENT"+t+"_WEBGL"];i.MAX_COLOR_ATTACHMENTS=i.__ext_draw_buffers.MAX_COLOR_ATTACHMENTS_WEBGL,i.MAX_DRAW_BUFFERS=i.__ext_draw_buffers.MAX_DRAW_BUFFERS_WEBGL}const t=[];for(let s=0;s<this.textureTargets.length;s++)i.framebufferTexture2D(i.DRAW_FRAMEBUFFER,i.COLOR_ATTACHMENT0+s,i.TEXTURE_2D,this.textureTargets[s],0),t.push(i.COLOR_ATTACHMENT0+s);this.textureTargets.length>1&&i.drawBuffers(t)}this.depthTexture&&i.framebufferTexture2D(i.DRAW_FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.TEXTURE_2D,this.depthTexture,0);const n=i.checkFramebufferStatus(i.DRAW_FRAMEBUFFER);if(n!=i.FRAMEBUFFER_COMPLETE)switch(n){case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw new Error("The attachment types are mismatched or not all framebuffer attachment points are framebuffer attachment complete.");case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw new Error("There is no attachment.");case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw new Error("Height and width of the attachment are not the same.");case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw new Error("The format of the attachment is not supported or if depth and stencil attachments are not the same renderbuffer.");case 36061:throw new Error("The framebuffer is unsupported");default:throw new Error("Incomplete Frambuffer")}this.unbind()}bindForWriting(t,i=!1){t&&(this.__prevBoundFbo=t.boundRendertarget,t.boundRendertarget=this.frameBuffer);const s=this.__gl;s.bindFramebuffer("webgl2"==s.name?s.DRAW_FRAMEBUFFER:s.FRAMEBUFFER,this.frameBuffer),s.viewport(0,0,this.width,this.height),i&&this.clear()}unbindForWriting(t){t&&(t.boundRendertarget=this.__prevBoundFbo);const i=this.__gl;i.bindFramebuffer("webgl2"==i.name?i.DRAW_FRAMEBUFFER:i.FRAMEBUFFER,this.__prevBoundFbo)}clear(t=!0){const i=this.__gl;i.colorMask(...this.colorMask),i.clearColor(...this.clearColor.asArray());let s=0;this.textureTargets.length>0&&(s|=i.COLOR_BUFFER_BIT),this.depthTexture&&(s|=i.DEPTH_BUFFER_BIT),i.clear(s)}bindForReading(){const t=this.__gl;t.bindFramebuffer("webgl2"==t.name?t.READ_FRAMEBUFFER:t.FRAMEBUFFER,this.frameBuffer)}unbindForReading(){const t=this.__gl;t.bindFramebuffer("webgl2"==t.name?t.READ_FRAMEBUFFER:t.FRAMEBUFFER,null)}bindColorTexture(t,i,s=0){const e=this.__gl,n=t.boundTextures++;return e.uniform1i(i.location,n),e.activeTexture(e.TEXTURE0+n),e.bindTexture(e.TEXTURE_2D,this.textureTargets[s]),!0}bindDepthTexture(t,i){const s=this.__gl,e=t.boundTextures++;return s.uniform1i(i.location,e),s.activeTexture(s.TEXTURE0+e),s.bindTexture(s.TEXTURE_2D,this.depthTexture),!0}unbind(){const t=this.__gl;t.bindFramebuffer(t.DRAW_FRAMEBUFFER,null)}resize(t,i,s=!1){}bindToUniform(t,i,s){const e=t.boundTextures++,n=this.__gl;return n.activeTexture(this.__gl.TEXTURE0+e),n.bindTexture(n.TEXTURE_2D,this.textureTargets[0]),n.uniform1i(i.location,e),s&&(s.textureTypeUnif&&n.uniform1i(s.textureTypeUnif.location,this.textureType),s.textureDescUnif&&this.__gl.uniform4fv(s.textureDescUnif.location,this.textureDesc)),!0}destroy(){const t=this.__gl;this.textureTargets.forEach(i=>{t.deleteTexture(i)}),this.textureTargets=[],this.depthTexture&&(t.deleteTexture(this.depthTexture),this.depthTexture=null),this.frameBuffer&&t.deleteFramebuffer(this.frameBuffer)}}const Ds=new Uint32Array(1);function Os(t){return Ds[0]=t,Ds[0]=(Ds[0]<<16|Ds[0]>>16)>>>0,Ds[0]=(1431655765&Ds[0])<<1|(2863311530&Ds[0])>>>1>>>0,Ds[0]=(858993459&Ds[0])<<2|(3435973836&Ds[0])>>>2>>>0,Ds[0]=(252645135&Ds[0])<<4|(4042322160&Ds[0])>>>4>>>0,Ds[0]=(16711935&Ds[0])<<8|(4278255360&Ds[0])>>>8>>>0,2.3283064365386963e-10*Ds[0]}function As(t,i){return[t/i,Os(t)]}ws.setShaderModule("utils/imageAtlas.glsl","\n\n// Note: On mobile, I can't seem to pass around a stuct containing sampler2D.\n// I have to unpack the struct and pass its members. :(\n// struct ImageAtlas {\n//     sampler2D layout;\n//     sampler2D image;\n//     vec4 desc;\n// };\n\n\n\nvec4 getSubImageLayout(int index, in sampler2D atlasLayout, in vec4 atlasDesc){\n    return fetchTexel(atlasLayout, int(floor(atlasDesc.z+0.5)), index);\n}\n\nvec2 calcSubImageTexCoords(vec2 texCoord, int index, in sampler2D atlasLayout, in vec4 atlasDesc){\n    vec4 layoutData = fetchTexel(atlasLayout, int(floor(atlasDesc.z+0.5)), index);\n    // The following line is a hack to fix artifacts in our PBR lighting\n    // We were seeing loads of lighting garbage on some sufaces that were orthogonal\n    // to the world. The UV coordinates would have been landing right on the edges\n    // of our subimages and were often sampling outside the image. This couuld\n    // have been because of filtering, or an error in the uv coords. \n    texCoord = clamp(texCoord, vec2(0.01, 0.01), vec2(0.99, 0.99));\n    vec2 subimageTexel = texCoord * layoutData.zw;\n    // subimageTexel = clamp(subimageTexel, vec2(0.0, 0.0), vec2(1.0, 1.0));\n    return subimageTexel + layoutData.xy;\n}\n\nvec4 sampleSubImage(vec2 texCoord, int index, in sampler2D atlasLayout, in sampler2D atlasImage, in vec4 atlasDesc){\n    vec4 layoutData = fetchTexel(atlasLayout, int(floor(atlasDesc.z+0.5)), index);\n    vec2 atlasCoords = calcSubImageTexCoords(texCoord, index, atlasLayout, atlasDesc);\n    return texture2D(atlasImage, atlasCoords);\n}\n\n");class _s extends Fs{constructor(t){super(t),this.__shaderStages.VERTEX_SHADER=ws.parseShader("AtlasLayoutShader.vertexShader",'\n\nprecision highp float;\n\n<%include file="utils/quadVertexFromID.glsl"/>\n\nuniform vec2 pos;\nuniform vec2 size;\nuniform vec2 srctextureDim;\nconst int border = 2;\n\n/* VS Outputs */\nvarying vec2 v_texCoord;\n \nvoid main()\n{\n  vec2 position = getQuadVertexPositionFromID();\n  v_texCoord = position+0.5;\n  gl_Position = vec4(vec2(-1.0, -1.0) + (pos * 2.0) + (v_texCoord * size * 2.0), 0.0, 1.0);\n\n  vec2 borderVec2 = vec2(float(border), float(border));\n  v_texCoord *= (srctextureDim + (borderVec2 * 2.0)) / srctextureDim;\n  v_texCoord -= borderVec2 / srctextureDim;\n}\n\n'),this.__shaderStages.FRAGMENT_SHADER=ws.parseShader("AtlasLayoutShader.fragmentShader","\nprecision highp float;\n\nuniform sampler2D srctexture;\nuniform vec2 srctextureDim;\nuniform bool alphaFromLuminance;\nuniform bool invert;\n\n/* VS Outputs */\nvarying vec2 v_texCoord;\n\nfloat luminanceFromRGB(vec3 rgb) {\n  return 0.2126*rgb.r + 0.7152*rgb.g + 0.0722*rgb.b;\n}\n\n#ifdef ENABLE_ES3\n  out vec4 fragColor;\n#endif\n\nvoid main(void) {\n  vec2 pixelCoord = v_texCoord*srctextureDim;\n  vec2 uv = v_texCoord;\n\n  // Wrap X coords\n  if(pixelCoord.x < 0.0){\n    uv.x += 1.0/srctextureDim.x;\n    uv.y = 1.0 - uv.y;\n  }\n  else if(pixelCoord.x > srctextureDim.x){\n    uv.x -= 1.0/srctextureDim.x;\n    uv.y = 1.0 - uv.y;\n  }\n\n  // Wrap Y coords\n  if(pixelCoord.y < 0.0){\n    uv.y += 1.0/srctextureDim.y;\n    uv.x = 1.0 - uv.x;\n  }\n  else if(pixelCoord.y > srctextureDim.y){\n    uv.y -= 1.0/srctextureDim.y;\n    uv.x = 1.0 - uv.x;\n  }\n\n  vec4 texel = texture2D(srctexture, uv);\n\n#ifndef ENABLE_ES3\n  vec4 fragColor;\n#endif\n\n  // TODO: check why we pre-multiply alphas here.\n  // fragColor = vec4(texel.rgb/texel.a, texel.a);\n\n  if(alphaFromLuminance) {\n    fragColor = vec4(texel.rgb, luminanceFromRGB(texel.rgb));\n  }\n  else {\n    fragColor = texel;\n  }\n  \n  if(invert) {\n    fragColor = vec4(1.0) - fragColor;\n  }\n\n#ifndef ENABLE_ES3\n  gl_FragColor = fragColor;\n#endif\n}\n\n")}}class qs extends js{constructor(t,i,s="RGBA",e="FLOAT"){super(t),this.__name=i,this.__formatParam=s,this.__typeParam=e,this.clearColor=new p(0,0,0,0),this.__subImages=[],this.__layoutNeedsRegeneration=!1,this.__async=new M,this.loaded=this.__async.ready}isLoaded(){return 0==this.__async.count}getMainImage(){return this.super}addSubImage(t){if(t instanceof Kt){const i=new Is(this.__gl,t);t.isLoaded()||(this.__async.incAsyncCount(),t.loaded.connect(()=>{this.__async.decAsyncCount()})),t.setMetadata("ImageAtlas_gltex",i),i.addRef(this),t.updated.connect(()=>{this.__layoutNeedsRegeneration=!0,this.renderAtlas()}),this.__subImages.push(i)}else t.addRef(this),this.__subImages.push(t);return this.__layoutNeedsRegeneration=!0,this.__subImages.length-1}removeSubImage(t){let i;if(t instanceof Kt){const s=t.getMetadata("ImageAtlas_gltex");i=this.__subImages.indexOf(s),t.deleteMetadata("ImageAtlas_gltex")}else i=this.__subImages.indexOf(t);this.__subImages[i].removeRef(this),this.__subImages.splice(i,1),this.__layoutNeedsRegeneration=!0}getSubImage(t){return this.__subImages[t]}numSubImages(){return this.__layout?this.__layout.length:this.__subImages.length}generateAtlasLayout(){if(0==this.__subImages.length)return void(this.__layoutNeedsRegeneration=!1);const t=[];this.__subImages.forEach((i,s)=>{t.push({w:i.width+4,h:i.height+4,area:i.width*i.height,index:s})}),t.sort((t,i)=>t.area>i.area?-1:t.area<i.area?1:0);const i=new Y;i.fit(t),this.__layout=[],t.forEach(t=>{t.fit?this.__layout[t.index]={pos:new d(t.fit.x+2,t.fit.y+2),size:new d(t.w,t.h)}:console.warn("Unable to fit image")});const s=i.root.w,e=i.root.h;this.configure({width:s,height:e,format:"FLOAT"==this.__typeParam&&"RGB"==this.__formatParam?"RGBA":this.__formatParam,type:this.__typeParam,filter:"LINEAR"});const n=this.__gl;if(n.__quadVertexIdsBuffer||n.setupInstancedQuad(),!n.__atlasLayoutShader){n.__atlasLayoutShader=new _s(n);const t=n.__atlasLayoutShader.compileForTarget("GLImageAtlas");n.__atlasLayoutShaderBinding=xs(n,t.attrs,n.__quadattrbuffers,n.__quadIndexBuffer)}let l=Math.round(Math.sqrt(1*this.__layout.length)+.5);if(l=Math.nextPow2(l),l%1!=0&&(l+=1-l%1),n.floatTexturesSupported){const t=new Float32Array(l*l*4);for(let i=0;i<this.__layout.length;i++){const n=this.__layout[i];m.createFromFloat32Buffer(t.buffer,4*i).set(n.pos.x/s,n.pos.y/e,n.size.x/s,n.size.y/e)}this.__atlasLayoutTexture&&this.__atlasLayoutTexture.width==l&&this.__atlasLayoutTexture.height==l?this.__atlasLayoutTexture.bufferData(t,l,l):(this.__atlasLayoutTexture&&this.__atlasLayoutTexture.destroy(),this.__atlasLayoutTexture=new Is(n,{format:"RGBA",type:"FLOAT",filter:"NEAREST",wrap:"CLAMP_TO_EDGE",mipMapped:!1,width:l,height:l,data:t}))}else this.__layoutVec4s=[],this.__layout.forEach((t,i)=>{this.__layoutVec4s[i]=[t.pos.x/s,t.pos.y/e,t.size.x/s,t.size.y/e]});this.__layoutNeedsRegeneration=!1}getLayoutData(t){return this.__layoutVec4s[t]}renderAtlas(t=!1,i=0){if(0==this.__subImages.length)return;this.__layoutNeedsRegeneration&&this.generateAtlasLayout();const s=this.__gl,e={};this.bindForWriting(e,!0),s.__atlasLayoutShader.bind(e,"GLImageAtlas"),s.__atlasLayoutShaderBinding.bind(e);const n=new d(1/this.width,1/this.height),l=e.unifs;for(let t=i;t<this.__subImages.length;t++){const i=this.__subImages[t],h=this.__layout[t];i.bindToUniform(e,l.srctexture),s.uniform2fv(l.pos.location,h.pos.multiply(n).asArray()),s.uniform2fv(l.size.location,h.size.multiply(n).asArray()),s.uniform2f(l.srctextureDim.location,i.width,i.height),s.uniform1i(l.alphaFromLuminance.location,i.alphaFromLuminance),s.uniform1i(l.invert.location,i.invert),s.drawQuad(),e.boundTextures--}t&&this.cleanup(),this.unbind(e),this.updated.emit()}isReady(){return null!=this.__atlasLayoutTexture}bindToUniform(t,i){if(!this.__atlasLayoutTexture)return!1;super.bindToUniform(t,i);const s=t.unifs,e=s[i.name+"_layout"];e&&this.__atlasLayoutTexture.bindToUniform(t,e);const n=s[i.name+"_desc"];return n&&this.__gl.uniform4f(n.location,this.width,this.height,this.__atlasLayoutTexture.width,0),!0}cleanup(){for(const t of this.__subImages)t.removeRef(this);this.__subImages=[],this.destroy()}destroy(){this.cleanup(),super.destroy()}}class $s extends Fs{constructor(t){super(t),this.__shaderStages.VERTEX_SHADER=ws.parseShader("ConvolverShader.vertexShader",'\nprecision highp float;\n\n<%include file="utils/quadVertexFromID.glsl"/>\n\n/* VS Outputs */\nvarying vec2 v_texCoord;\n \nvoid main()\n{\n  vec2 position = getQuadVertexPositionFromID();\n  v_texCoord = position+0.5;\n  gl_Position = vec4(position*2.0, 0.0, 1.0);\n}\n'),this.__shaderStages.FRAGMENT_SHADER=ws.parseShader("ConvolverShader.fragmentShader",'\nprecision highp float;\n\n<%include file="math/constants.glsl"/>\n<%include file="GLSLUtils.glsl"/>\n<%include file="utils/imagePyramid.glsl"/>\n<%include file="pragmatic-pbr/envmap-octahedral.glsl"/>\n\nuniform float roughness;\nvarying vec2 v_texCoord;\n\nuniform sampler2D hammersleyMap;\nvec2 Hammersley(int i, int N) {\n  vec4 rgba =  texture2D(hammersleyMap, vec2((float(i) + 0.5)/float(N)), 0.5);\n  return rgba.rg;\n}\n\nmat3 matrixFromVector(vec3 n) { // frisvad\n  float a = 1.0 / (1.0 + n.z);\n  float b = -n.x * n.y * a;\n  vec3 b1 = vec3(1.0 - n.x * n.x * a, b, -n.x);\n  vec3 b2 = vec3(b, 1.0 - n.y * n.y * a, -n.y);\n  return mat3(b1, b2, n);\n}\n\nvec3 ImportanceSampleGGX(vec2 Xi, float a) {\n  float phi = 2.0 * PI * Xi.x;\n  float cos_theta = sqrt((1.0 - Xi.y)/(1.0 + (a*a - 1.0) * Xi.y));\n  float sin_theta = sqrt(1.0 - cos_theta * cos_theta);\n\n  // float phi = Xi.y * 2.0 * PI;\n  // float cos_theta = sqrt(1.0 - Xi.x);\n  // float sin_theta = sqrt(1.0 - cos_theta * cos_theta);\n\n  vec3 H;\n  H.x = sin_theta * cos(phi);\n  H.y = sin_theta * sin(phi);\n  H.z = cos_theta;\n  return H;\n}\n\n// TODO: use tobias\'s code. The guy clearly knows what he\'s doing...\n// https://github.com/thefranke/dirtchamber/blob/master/shader/importance.hlsl\n// Compute a LOD level for filtered importance sampling.\n// From GPU Gems 3: GPU-Based Importance Sampling.\n\n\n#define M_PI       3.14159265358979323846   // pi\n#define M_HALF_PI  1.57079632679489661923   // pi/2\nfloat sqr(float val){ return val*val; }\nfloat saturate(float val) { return clamp(val, 0.0, 1.0); }\nvec3 saturate(vec3 val) { return clamp(val, 0.0, 1.0); }\n\n// Microfacet Models for Refraction through Rough Surfaces\n// Walter et al.\n// http://www.cs.cornell.edu/~srm/publications/EGSR07-btdf.html\n// aka Towbridge-Reitz\nfloat D_ggx(in float alpha, in float NoH)\n{\n  float a2 = alpha*alpha;\n  float cos2 = NoH*NoH;\n\n  return (1.0/M_PI) * sqr(alpha/(cos2 * (a2 - 1.0) + 1.0));\n\n  /*\n  // version from the paper, eq 33\n  float CosSquared = NoH*NoH;\n  float TanSquared = (1.0 - CosSquared)/CosSquared;\n  return (1.0/M_PI) * sqr(alpha/(CosSquared * (alpha*alpha + TanSquared)));\n  */\n}\nfloat compute_lod(in vec3 H, in float pdf, in int num_samples, in int ww, in int hh)\n{\n  return max(0.0, 0.5*log2(float(ww*hh)/float(num_samples)) - 0.5*log2(pdf));\n}\n\nuniform sampler2D   envMapPyramid;\nuniform sampler2D   envMapPyramid_layout;\nuniform vec4        envMapPyramid_desc;\n\n#ifdef ENABLE_ES3\n  out vec4 fragColor;\n#endif\nvoid main(void) {\n#ifndef ENABLE_ES3\n  vec4 fragColor;\n#endif\n\n  vec3 N = sphOctUvToDir(v_texCoord);\n\n  if(false){\n    vec2 uv = dirToSphOctUv(N);\n    // fragColor = vec4(uv.x, uv.y, 0.0, 1.0);\n    fragColor = sampleImagePyramid(uv, 0.5, envMapPyramid_layout, envMapPyramid, envMapPyramid_desc);\n    // fragColor = sampleSubImage(uv, 0, envMapPyramid_layout, envMapPyramid, envMapPyramid_desc);\n    // fragColor = texture2D(envMapPyramid, uv);\n  }\n  else{\n    const int numSamples = NUM_SAMPLES;\n    int w = int(floor(envMapPyramid_desc.x + 0.5));\n    int h = int(floor(envMapPyramid_desc.y + 0.5));\n\n    vec4 color = vec4(0.0,0.0,0.0,0.0);\n    float weight = 0.0;\n    mat3 vecSpace = matrixFromVector(N);\n    float a = roughness*roughness;\n    for(int i=0; i<numSamples; i++) {\n      vec2 Xi = Hammersley(i, numSamples);\n      vec3 H = ImportanceSampleGGX(Xi, a);\n      vec3 V = normalize(vecSpace * H);\n      float VdotN = dot(V, N);\n      float NoH = saturate( dot( N, H ) );\n      float VoH = saturate( dot( V, H ) );\n\n      vec2 uv = dirToSphOctUv(V);\n      // float pdf = D_ggx(a, NoH) * NoH / (4.0 * VoH);\n      // float lod = compute_lod(H, pdf, numSamples, w, h);\n\n      color += sampleImagePyramid(uv, a, envMapPyramid_layout, envMapPyramid, envMapPyramid_desc) * VdotN;\n      weight += VdotN;\n    }\n    color /= float(weight);\n    fragColor = vec4(color.rgb, 1.0);\n  }\n  \n#ifndef ENABLE_ES3\n  gl_FragColor = fragColor;\n#endif\n}\n\n')}}ws.setShaderModule("utils/imagePyramid.glsl",'\n\n<%include file="utils/imageAtlas.glsl"/>\n\nvec4 sampleImagePyramid(vec2 uv, float lod, in sampler2D atlasLayout, in sampler2D atlasImage, in vec4 atlasDesc){\n  if (lod < 0.00001 || lod > 0.9999) {\n    float imageIndex = lod * (atlasDesc.z-1.0);\n    int imageId0 = int(imageIndex);\n    return sampleSubImage(uv, imageId0, atlasLayout, atlasImage, atlasDesc);\n  } else {\n    float imageIndex = lod * (atlasDesc.z-1.0);\n    int imageId0 = int(floor(imageIndex));\n    int imageId1 = imageId0+1;\n    float blend = fract(imageIndex);\n    vec4 c0 = sampleSubImage(uv, imageId0, atlasLayout, atlasImage, atlasDesc);\n    vec4 c1 = sampleSubImage(uv, imageId1, atlasLayout, atlasImage, atlasDesc);\n    return mix(c0, c1, blend);\n  } \n}\n\n\n');class te extends qs{constructor(t,i,s,e=!0,n=16){super(t,i),this.__srcGLTex=s,this.__fbos=[],s.updated.connect(()=>{this.renderAtlas(e)}),this.__srcGLTex.isLoaded()?(this.generateAtlasLayout(n),this.renderAtlas(e)):this.__srcGLTex.updated.connect(()=>{this.generateAtlasLayout(n),this.renderAtlas(e)})}generateAtlasLayout(t){const i=this.__gl;this.size=this.__srcGLTex.height;const s=this.__srcGLTex.width/this.__srcGLTex.height;this.addSubImage(this.__srcGLTex);for(let e=Math.round(function(t){return Math.log2(t)}(this.size))-1;e>=0;--e){const n=Math.pow(2,e);if(n<t)break;const l=new Is(i,{format:this.__srcGLTex.getFormat(),type:this.__srcGLTex.getType(),width:n*s,height:n,filter:"LINEAR",wrap:"CLAMP_TO_EDGE"});this.addSubImage(l),this.__fbos.push(new Ts(i,l))}super.generateAtlasLayout()}renderAtlas(t=!0){const i=this.__gl,s={};i.screenQuad.bindShader(s);for(let t=0;t<this.__fbos.length;t++)this.__fbos[t].bindAndClear(),i.screenQuad.draw(s,this.getSubImage(t));super.renderAtlas(t)}destroy(){super.destroy();for(const t of this.__fbos)t.destroy()}}class ie extends qs{constructor(t,i){super(t,i),this.__gl=t,t.__quadVertexIdsBuffer||t.setupInstancedQuad(),this.__convolved=!1,this.__fbos=[]}generateHammersleySamples(t){const i=this.__gl;if(!i["Hammersley"+t]){const s=new Float32Array(3*t);for(let i=0;i<t;i++){const e=As(i,t),n=3*i;s[n+0]=e[0],s[n+1]=e[1]}i["Hammersley"+t]=new Is(i,{format:"RGB",type:"FLOAT",filter:"NEAREST",wrap:"CLAMP_TO_EDGE",width:t,height:1,data:s,mipMapped:!1})}return i["Hammersley"+t]}convolveProbe(t){const i=this.__gl,s=this.generateHammersleySamples(1024);if(!this.__convolved){this.__lodPyramid||(this.__lodPyramid=new te(i,"Probe Lods",t,!1),this.__lodPyramid.updated.connect(()=>{this.convolveProbe(t)})),this.addSubImage(t);let s=[t.width/2,t.height/2];const e=6;for(let t=0;t<e;t++){const t=new Is(i,{format:"RGBA",type:"FLOAT",filter:"LINEAR",wrap:"CLAMP_TO_EDGE",width:s[0],height:s[1]});this.addSubImage(t);const e=new Ts(i,t);e.setClearColor([0,1,0,0]),this.__fbos.push(e),s=[s[0]/2,s[1]/2]}this.generateAtlasLayout(),this.__convolverShader=new $s(i);const n=this.__convolverShader.compileForTarget("GLProbe",Object.assign({repl:{NUM_SAMPLES:1024}},i.shaderopts));this.__covolverShaderBinding=xs(i,n.attrs,i.__quadattrbuffers,i.__quadIndexBuffer)}const e={};this.__convolverShader.bind(e,"GLProbe"),this.__covolverShaderBinding.bind(e);const n=e.unifs;for(let t=0;t<this.__fbos.length;t++)this.__fbos[t].bindAndClear(),this.__lodPyramid.bindToUniform(e,n.envMapPyramid),"hammersleyMap"in n&&s.bindToUniform(e,n.hammersleyMap),"roughness"in n&&i.uniform1f(n.roughness.location,(t+1)/this.__fbos.length),i.drawQuad();this.__convolved=!0,this.renderAtlas(!1)}bindProbeToUniform(t,i){this.__convolved&&super.bindToUniform(t,i)}destroy(){super.destroy(),this.__convolverShader.destroy();for(const t of this.__fbos)t.destroy()}}ws.setShaderModule("stack-gl/inverse.glsl","\n\n\n#ifndef ENABLE_ES3\n\nfloat inverse(float m) {\n  return 1.0 / m;\n}\n\nmat2 inverse(mat2 m) {\n  return mat2(m[1][1],-m[0][1],\n             -m[1][0], m[0][0]) / (m[0][0]*m[1][1] - m[0][1]*m[1][0]);\n}\n\nmat3 inverse(mat3 m) {\n  float a00 = m[0][0], a01 = m[0][1], a02 = m[0][2];\n  float a10 = m[1][0], a11 = m[1][1], a12 = m[1][2];\n  float a20 = m[2][0], a21 = m[2][1], a22 = m[2][2];\n\n  float b01 = a22 * a11 - a12 * a21;\n  float b11 = -a22 * a10 + a12 * a20;\n  float b21 = a21 * a10 - a11 * a20;\n\n  float det = a00 * b01 + a01 * b11 + a02 * b21;\n\n  return mat3(b01, (-a22 * a01 + a02 * a21), (a12 * a01 - a02 * a11),\n              b11, (a22 * a00 - a02 * a20), (-a12 * a00 + a02 * a10),\n              b21, (-a21 * a00 + a01 * a20), (a11 * a00 - a01 * a10)) / det;\n}\n\nmat4 inverse(mat4 m) {\n  float\n      a00 = m[0][0], a01 = m[0][1], a02 = m[0][2], a03 = m[0][3],\n      a10 = m[1][0], a11 = m[1][1], a12 = m[1][2], a13 = m[1][3],\n      a20 = m[2][0], a21 = m[2][1], a22 = m[2][2], a23 = m[2][3],\n      a30 = m[3][0], a31 = m[3][1], a32 = m[3][2], a33 = m[3][3],\n\n      b00 = a00 * a11 - a01 * a10,\n      b01 = a00 * a12 - a02 * a10,\n      b02 = a00 * a13 - a03 * a10,\n      b03 = a01 * a12 - a02 * a11,\n      b04 = a01 * a13 - a03 * a11,\n      b05 = a02 * a13 - a03 * a12,\n      b06 = a20 * a31 - a21 * a30,\n      b07 = a20 * a32 - a22 * a30,\n      b08 = a20 * a33 - a23 * a30,\n      b09 = a21 * a32 - a22 * a31,\n      b10 = a21 * a33 - a23 * a31,\n      b11 = a22 * a33 - a23 * a32,\n\n      det = b00 * b11 - b01 * b10 + b02 * b09 + b03 * b08 - b04 * b07 + b05 * b06;\n\n  return mat4(\n      a11 * b11 - a12 * b10 + a13 * b09,\n      a02 * b10 - a01 * b11 - a03 * b09,\n      a31 * b05 - a32 * b04 + a33 * b03,\n      a22 * b04 - a21 * b05 - a23 * b03,\n      a12 * b08 - a10 * b11 - a13 * b07,\n      a00 * b11 - a02 * b08 + a03 * b07,\n      a32 * b02 - a30 * b05 - a33 * b01,\n      a20 * b05 - a22 * b02 + a23 * b01,\n      a10 * b10 - a11 * b08 + a13 * b06,\n      a01 * b08 - a00 * b10 - a03 * b06,\n      a30 * b04 - a31 * b02 + a33 * b00,\n      a21 * b02 - a20 * b04 - a23 * b00,\n      a11 * b07 - a10 * b09 - a12 * b06,\n      a00 * b09 - a01 * b07 + a02 * b06,\n      a31 * b01 - a30 * b03 - a32 * b00,\n      a20 * b03 - a21 * b01 + a22 * b00) / det;\n}\n\n#endif\n\n"),ws.setShaderModule("stack-gl/transpose.glsl","\n\n\n#ifndef ENABLE_ES3\n\nfloat transpose(float m) {\n  return m;\n}\n\nmat2 transpose(mat2 m) {\n  return mat2(m[0][0], m[1][0],\n              m[0][1], m[1][1]);\n}\n\nmat3 transpose(mat3 m) {\n  return mat3(m[0][0], m[1][0], m[2][0],\n              m[0][1], m[1][1], m[2][1],\n              m[0][2], m[1][2], m[2][2]);\n}\n\nmat4 transpose(mat4 m) {\n  return mat4(m[0][0], m[1][0], m[2][0], m[3][0],\n              m[0][1], m[1][1], m[2][1], m[3][1],\n              m[0][2], m[1][2], m[2][2], m[3][2],\n              m[0][3], m[1][3], m[2][3], m[3][3]);\n}\n\n#endif\n\n"),ws.setShaderModule("pragmatic-pbr/envmap-octahedral.glsl","\n\n#define sectorize(value) step(0.0, (value))*2.0-1.0\n#define sum(value) dot(clamp((value), 1.0, 1.0), (value))\n\n\nvec2 dirToSphOctUv(vec3 normal){\n    normal = normalize(normal);\n    vec3 aNorm = abs(normal);\n    vec3 sNorm = sectorize(normal);\n\n    vec2 dir = max(aNorm.xy, 1e-20);\n    float orient = atan(dir.x, dir.y)/HalfPI;\n\n    dir = max(vec2(aNorm.z, length(aNorm.xy)), 1e-20);\n    float pitch = atan(dir.y, dir.x)/HalfPI;\n\n    vec2 uv = vec2(sNorm.x*orient, sNorm.y*(1.0-orient))*pitch;\n\n    if(normal.z < 0.0){\n        uv = sNorm.xy - abs(uv.ts)*sNorm.xy;\n    }\n    return uv*0.5+0.5;\n}\n\n\nvec3 sphOctUvToDir(vec2 uv){\n    uv = uv*2.0-1.0;\n    vec2 suv = sectorize(uv);\n    float sabsuv =  sum(abs(uv));\n    float pitch = sabsuv*HalfPI;\n\n    if (pitch <= 0.0) {\n        return vec3(0.0, 0.0, 1.0);\n    }\n    if (abs(pitch - PI) < 0.000001) {\n        return vec3(0.0, 0.0, -1.0);\n    }\n    if(sabsuv > 1.0){\n        uv = (1.0-abs(uv.ts))*suv;\n    }\n\n    float orient = (abs(uv.s)/sabsuv)*HalfPI;\n    float sOrient = sin(orient);\n    float cOrient = cos(orient);\n    float sPitch = sin(pitch);\n    float cPitch = cos(pitch);\n\n    return vec3(\n        sOrient*suv.s*sPitch,\n        cOrient*suv.t*sPitch,\n        cPitch\n    );\n}\n\n"),ws.setShaderModule("pragmatic-pbr/envmap-equirect.glsl","\n\n\nvec2 latLongUVsFromDir(vec3 dir) {\n  // Math function taken from...\n  // http://gl.ict.usc.edu/Data/HighResProbes/\n  // Note: Scaling from u=[0,2], v=[0,1] to u=[0,1], v=[0,1]\n  float phi = acos(dir.z);\n  float theta = atan(dir.x, dir.y);\n  return vec2((1.0 + theta / PI) / 2.0, phi / PI);\n}\n\n// Note: when u == 0.5 z = 1.0\nvec3 dirFromLatLongUVs(float u, float v) {\n    // http://gl.ict.usc.edu/Data/HighResProbes/\n    float theta = PI*((u * 2.0) - 1.0);\n    float phi = PI*v;\n    return vec3(sin(phi)*sin(theta), sin(phi)*cos(theta), cos(phi));\n}\n\nvec3 dirFromPolar(vec2 polar) {\n    float u = polar.x / (PI * 2.0);\n    float v = polar.y / PI;\n    return dirFromLatLongUVs(u, v);\n}\n\n"),ws.setShaderModule("pragmatic-pbr/envmap-dualfisheye.glsl","\n\n\n\nvec2 dualfisheyeUVsFromDir(vec3 dir) {\n  vec2 result;\n  float angle = 0.465;\n    if(dir.x < 0.0) {\n        result = vec2(((dir.z * -angle) + 0.5) * 0.5, (dir.y * angle) + 0.5);\n    }\n    else {\n        result = vec2( 0.5 + ((dir.z * angle) + 0.5) * 0.5, (dir.y * angle) + 0.5);\n    }\n    return result;\n}\n\n\n");class se extends Fs{constructor(t){super(t),this.__shaderStages.VERTEX_SHADER=ws.parseShader("EnvMapShader.vertexShader",'\nprecision highp float;\n\n<%include file="utils/quadVertexFromID.glsl"/>\n\nuniform mat4 projectionMatrix;\nuniform mat4 viewMatrix;\n\n<%include file="stack-gl/inverse.glsl"/>\n<%include file="stack-gl/transpose.glsl"/>\n\n/* VS Outputs */\nvarying vec3 v_worldDir;\nvarying vec2 v_texCoord;\n \nvoid main()\n{\n  vec2 position = getQuadVertexPositionFromID() * 2.0;\n  v_texCoord = position * 0.5 + 0.5;\n\n  mat4 inverseProjection = inverse(projectionMatrix);\n  mat3 inverseModelview = transpose(mat3(viewMatrix));\n\n  // transform from the normalized device coordinates back to the view space\n  vec3 unprojected = (inverseProjection * vec4(position, 0, 1)).xyz;\n\n  // transfrom from the view space back to the world space\n  // and use it as a sampling vector\n  v_worldDir = inverseModelview * unprojected;\n\n  gl_Position = vec4(position, 0, 1);\n}\n\n')}}class ee extends se{constructor(t){super(t),this.__shaderStages.FRAGMENT_SHADER=ws.parseShader("LatLongEnvMapShader.fragmentShader",'\nprecision highp float;\n\n<%include file="math/constants.glsl"/>\n<%include file="GLSLUtils.glsl"/>\n<%include file="pragmatic-pbr/envmap-equirect.glsl"/>\n\n#define ENABLE_INLINE_GAMMACORRECTION\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n<%include file="stack-gl/gamma.glsl"/>\nuniform float exposure;\n#endif\n\nuniform sampler2D backgroundImage;\n\n\n/* VS Outputs */\nvarying vec2 v_texCoord;\n\n#ifdef ENABLE_ES3\n  out vec4 fragColor;\n#endif\n\nvoid main(void) {\n#ifndef ENABLE_ES3\n  vec4 fragColor;\n#endif\n\n  vec4 texel = texture2D(backgroundImage, v_texCoord);\n  fragColor = vec4(texel.rgb/texel.a, 1.0);\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n  //fragColor.rgb = toGamma(fragColor.rgb * exposure);\n\n  // Assuming a simple RGB image in gamma space for now.\n  fragColor.rgb = fragColor.rgb * exposure;\n#endif\n\n\n#ifndef ENABLE_ES3\n  gl_FragColor = fragColor;\n#endif\n}\n'),this.finalize()}}class ne extends se{constructor(t){super(t),this.__shaderStages.FRAGMENT_SHADER=ws.parseShader("OctahedralEnvMapShader.fragmentShader",'\nprecision highp float;\n\n<%include file="math/constants.glsl"/>\n<%include file="GLSLUtils.glsl"/>\n<%include file="pragmatic-pbr/envmap-octahedral.glsl"/>\n<%include file="utils/imagePyramid.glsl"/>\n<%include file="stack-gl/gamma.glsl"/>\n\nuniform float focus;\n\n#define ENABLE_INLINE_GAMMACORRECTION\n#ifdef ENABLE_INLINE_GAMMACORRECTION\nuniform float exposure;\n#endif\n\n// uniform ImageAtlas envMap;\nuniform sampler2D   envMapPyramid;\nuniform sampler2D   envMapPyramid_layout;\nuniform vec4        envMapPyramid_desc;\n\n\n/* VS Outputs */\nvarying vec3 v_worldDir;\nvarying vec2 v_texCoord;\n\n#ifdef ENABLE_ES3\n  out vec4 fragColor;\n#endif\n\nvoid main(void) {\n#ifndef ENABLE_ES3\n  vec4 fragColor;\n#endif\n\n  vec2 uv = dirToSphOctUv(normalize(v_worldDir));\n  if(false){\n    // Use these lines to debug the src GL image.\n    vec4 texel = texture2D(envMapPyramid, uv);\n    fragColor = vec4(texel.rgb/texel.a, 1.0);\n  }\n  else{\n    fragColor = vec4(sampleImagePyramid(uv, focus, envMapPyramid_layout, envMapPyramid, envMapPyramid_desc).rgb, 1.0);\n  }\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n  fragColor.rgb = toGamma(fragColor.rgb * exposure);\n#endif\n\n#ifndef ENABLE_ES3\n  gl_FragColor = fragColor;\n#endif\n}\n'),this.finalize()}}class le extends se{constructor(t){super(t),this.__shaderStages.FRAGMENT_SHADER=ws.parseShader("LatLongEnvMapShader.fragmentShader",'\nprecision highp float;\n\n<%include file="math/constants.glsl"/>\n<%include file="GLSLUtils.glsl"/>\n<%include file="pragmatic-pbr/envmap-equirect.glsl"/>\n\n#define ENABLE_INLINE_GAMMACORRECTION\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n<%include file="stack-gl/gamma.glsl"/>\nuniform float exposure;\n#endif\n\nuniform sampler2D backgroundImage;\n\n\n/* VS Outputs */\nvarying vec3 v_worldDir;\nvarying vec2 v_texCoord;\n\n#ifdef ENABLE_ES3\n  out vec4 fragColor;\n#endif\n\nvoid main(void) {\n#ifndef ENABLE_ES3\n  vec4 fragColor;\n#endif\n\n  vec2 uv = latLongUVsFromDir(normalize(v_worldDir));\n\n  vec4 texel = texture2D(backgroundImage, uv);\n  fragColor = vec4(texel.rgb/texel.a, 1.0);\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n  fragColor.rgb = toGamma(fragColor.rgb * exposure);\n#endif\n#ifndef ENABLE_ES3\n  gl_FragColor = fragColor;\n#endif\n}\n'),this.finalize()}static getParamDeclarations(){return super.getParamDeclarations()}}class he extends se{constructor(t){super(t),this.__shaderStages.FRAGMENT_SHADER=ws.parseShader("SterioLatLongEnvMapShader.fragmentShader",'\nprecision highp float;\n\n<%include file="math/constants.glsl"/>\n<%include file="GLSLUtils.glsl"/>\n<%include file="pragmatic-pbr/envmap-equirect.glsl"/>\n\n#define ENABLE_INLINE_GAMMACORRECTION\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n<%include file="stack-gl/gamma.glsl"/>\nuniform float exposure;\n#endif\n\nuniform int eye;// L = 0, R = 1;\n\nuniform sampler2D backgroundImage;\n\n/* VS Outputs */\nvarying vec3 v_worldDir;\nvarying vec2 v_texCoord;\n\n#ifdef ENABLE_ES3\n  out vec4 fragColor;\n#endif\n\nvoid main(void) {\n#ifndef ENABLE_ES3\n  vec4 fragColor;\n#endif\n\n  vec2 uv = latLongUVsFromDir(normalize(v_worldDir));\n  uv.y *= 0.5;\n  if(eye == 1){\n    uv.y += 0.5;\n  }\n\n  vec4 texel = texture2D(backgroundImage, uv);\n  fragColor = vec4(texel.rgb/texel.a, 1.0);\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n  //fragColor.rgb = toGamma(fragColor.rgb * exposure);\n\n  // Assuming a simple RGB image in gamma space for now.\n  fragColor.rgb = fragColor.rgb * exposure;\n#endif\n\n#ifndef ENABLE_ES3\n  gl_FragColor = fragColor;\n#endif\n}\n'),this.finalize()}}class oe extends se{constructor(t){super(t),this.__shaderStages.FRAGMENT_SHADER=ws.parseShader("DualFishEyeEnvMapShader.fragmentShader",'\nprecision highp float;\n\n<%include file="math/constants.glsl"/>\n<%include file="GLSLUtils.glsl"/>\n<%include file="pragmatic-pbr/envmap-dualfisheye.glsl"/>\n\n#define ENABLE_INLINE_GAMMACORRECTION\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n<%include file="stack-gl/gamma.glsl"/>\nuniform float exposure;\n#endif\n\nuniform sampler2D backgroundImage;\n\n/* VS Outputs */\nvarying vec3 v_worldDir;\nvarying vec2 v_texCoord;\n\n#ifdef ENABLE_ES3\n  out vec4 fragColor;\n#endif\n\nvoid main(void) {\n#ifndef ENABLE_ES3\n  vec4 fragColor;\n#endif\n\n  vec2 uv = dualfisheyeUVsFromDir(normalize(v_worldDir));\n\n  vec4 texel = texture2D(backgroundImage, uv);\n  fragColor = vec4(texel.rgb/texel.a, 1.0);\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n  //fragColor.rgb = toGamma(fragColor.rgb * exposure);\n\n  // Assuming a simple RGB image in gamma space for now.\n  fragColor.rgb = fragColor.rgb * exposure;\n#endif\n\n#ifndef ENABLE_ES3\n  gl_FragColor = fragColor;\n#endif\n}\n'),this.finalize()}}class ae extends se{constructor(t){super(t),this.__shaderStages.FRAGMENT_SHADER=ws.parseShader("DualFishEyeEnvMapShader.fragmentShader",'\nprecision highp float;\n\n<%include file="math/constants.glsl"/>\n<%include file="GLSLUtils.glsl"/>\n<%include file="pragmatic-pbr/envmap-equirect.glsl"/>\n<%include file="pragmatic-pbr/envmap-dualfisheye.glsl"/>\n\n#define ENABLE_INLINE_GAMMACORRECTION\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n<%include file="stack-gl/gamma.glsl"/>\nuniform float exposure;\n#endif\n\nuniform sampler2D backgroundImage;\n\n/* VS Outputs */\nvarying vec3 v_worldDir;\nvarying vec2 v_texCoord;\n\n#ifdef ENABLE_ES3\n  out vec4 fragColor;\n#endif\n\nvoid main(void) {\n#ifndef ENABLE_ES3\n  vec4 fragColor;\n#endif\n\n  vec2 uv = dualfisheyeUVsFromDir(dirFromLatLongUVs(v_texCoord.x, v_texCoord.y));\n  vec4 texel = texture2D(backgroundImage, uv);\n  fragColor = vec4(texel.rgb/texel.a, 1.0);\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n  //fragColor.rgb = toGamma(fragColor.rgb * exposure);\n\n  // Assuming a simple RGB image in gamma space for now.\n  // fragColor.rgb = fragColor.rgb * exposure;\n#endif\n\n#ifndef ENABLE_ES3\n  gl_FragColor = fragColor;\n#endif\n}\n'),this.finalize()}}class ce extends ie{constructor(t,i,s){super(t.gl,"EnvMap"),this.__renderer=t,this.__envMap=i,this.__backgroundFocus=0;const e=t.gl;e.__quadVertexIdsBuffer||e.setupInstancedQuad();let n=this.__envMap.getMetadata("gltexture");n||(n=new Js(e,this.__envMap)),this.__srcGLTex=n,this.__envMapShader=new ne(e);const l=this.__envMapShader.compileForTarget("GLEnvMap",s);this.__envMapShaderBinding=xs(e,l.attrs,e.__quadattrbuffers,e.__quadIndexBuffer),this.__envMap.isLoaded()?this.convolveProbe(n):this.__envMap.loaded.connect(()=>{this.convolveProbe(n),this.loaded.emit()})}getEnvMap(){return this.__envMap}getBackgroundFocus(){return this.__backgroundFocus}setBackgroundFocus(t){this.__backgroundFocus=t,this.__renderer.requestRedraw()}draw(t){if(this.__envMap.isLoaded()){const i=this.__gl;{this.__envMapShader.bind(t,"GLEnvMap");const s=t.unifs;this.bindProbeToUniform(t,s.envMapPyramid);{const t=s.focus;t&&i.uniform1f(t.location,this.__backgroundFocus)}{const e=s.exposure;e&&i.uniform1f(e.location,t.exposure)}this.__envMapShaderBinding.bind(t),i.depthMask(!1),t.bindViewports(s,()=>{i.drawQuad()})}}}bindToUniform(t,i,s){return this.__srcGLTex.bindToUniform(t,i,s)}destroy(){super.destroy(),this.__srcGLTex.loaded.disconnectScope(this),this.__srcGLTex.updated.disconnectScope(this),this.__srcGLTex.destroy()}}class re extends Fs{constructor(t){super(t),this.__shaderStages.VERTEX_SHADER=ws.parseShader("ScreenQuadShader.vertexShader",'\nprecision highp float;\n\n<%include file="utils/quadVertexFromID.glsl"/>\n\nuniform vec2 pos;\nuniform vec2 size;\n\n/* VS Outputs */\nvarying vec2 v_texCoord;\n \nvoid main()\n{\n    vec2 position = getQuadVertexPositionFromID();\n    v_texCoord = position+0.5;\n    gl_Position = vec4(vec2(-1.0, -1.0) + (pos * 2.0) + (v_texCoord * abs(size) * 2.0), 0.0, 1.0);\n    if(size.x < 0.0)\n        v_texCoord.x = 1.0 - v_texCoord.x;\n    if(size.y < 0.0)\n        v_texCoord.y = 1.0 - v_texCoord.y;\n}\n'),this.__shaderStages.FRAGMENT_SHADER=ws.parseShader("ScreenQuadShader.fragmentShader","\nprecision highp float;\n\nuniform sampler2D image;\n\nvarying vec2 v_texCoord;\n\n\n#ifdef ENABLE_ES3\n    out vec4 fragColor;\n#endif\nvoid main(void) {\n#ifndef ENABLE_ES3\n    vec4 fragColor;\n#endif\n    fragColor = texture2D(image, v_texCoord);\n    fragColor = vec4(fragColor.rgb/fragColor.a, 1.0);\n\n#ifndef ENABLE_ES3\n    gl_FragColor = fragColor;\n#endif\n}\n"),this.finalize()}}class de{constructor(t,i){this.__gl=t,this.__pos=[0,0],this.__size=[1,1],this.flipY=!0,this.__glshader=new re(t),t.__quadVertexIdsBuffer||t.setupInstancedQuad();const s=this.__glshader.compileForTarget("GLScreenQuad",i);this.__quadBinding=xs(t,s.attrs,t.__quadattrbuffers,t.__quadIndexBuffer),this.ready=!0}bind(t,i,s,e){const n=t.unifs;i.bindToUniform(t,t.unifs.image);const l=this.__gl;{const t=n.pos;t&&l.uniform2fv(t.location,s?s instanceof a?s.asArray():s:this.__pos)}{const t=n.size;t&&l.uniform2fv(t.location,e?e instanceof a?e.asArray():e:this.__size)}this.__quadBinding.bind(t)}bindShader(t){return this.__glshader.bind(t,"GLScreenQuad")}draw(t,i,s,e){this.bind(t,i,s,e),this.__gl.drawQuad()}destroy(){}}class ue extends B{constructor(t){super(),this.__renderer=t,this.__doubleClickTimeMSParam=this.addParameter(new ut("DoubleClickTimeMS",200)),this.__fbo=void 0,this.updated=new v,this.resized=new v,this.__renderer.sceneSet.connect(()=>{const i=t.getScene().settings.getParameter("BackgroundColor"),s=()=>{const t=i.getValue();let s=this.__renderer.gl;t instanceof Kt?"FLOAT"===t.type?(this.__backgroundTexture=t,this.__backgroundGLTexture=new Js(s,t)):(this.__backgroundTexture=t,this.__backgroundGLTexture=new Is(s,t)):t instanceof p?(this.__backgroundGLTexture&&(this.__backgroundGLTexture.destroy(),this.__backgroundGLTexture=void 0,this.__backgroundTexture=void 0),this.__backgroundColor=t):console.warn("Invalid background:"+t),this.updated.emit()};s(i.getValue()),i.valueChanged.connect(s)})}getRenderer(){return this.__renderer}getName(){return this.__name}getBl(){return this.__bl}setBl(t){this.__bl=t,this.resize(this.__canvasWidth,this.__canvasHeight)}getTr(){return this.__tr}setTr(t){this.__tr=t,this.resize(this.__canvasWidth,this.__canvasHeight)}getPosX(){return this.__x}getPosY(){return this.__y}getWidth(){return this.__width}getHeight(){return this.__height}getBackground(){return console.warn("Deprecated Function. Please access the Scene Settings object."),this.__renderer.getScene().settings.getParameter("BackgroundColor").getValue()}setBackground(t){console.warn("Deprecated Function. Please access the Scene Settings object."),this.__renderer.getScene().settings.getParameter("BackgroundColor").setValue(t),this.updated.emit()}resize(t,i){this.__canvasWidth=t,this.__canvasHeight=i,this.__width=t,this.__height=i,this.resized.emit()}onMouseDown(t){return!1}onMouseUp(t){return!1}onMouseMove(t){return!1}onMouseLeave(t){return!1}onKeyPressed(t,i){return!1}onKeyDown(t,i){return!1}onKeyUp(t,i){return!1}}class me extends ue{constructor(t,i,s,e){super(t),this.__name=i,this.__projectionMatrix=new y,this.__frustumDim=new d,this.__bl=new d(0,0),this.__tr=new d(1,1),this.__exposure=0,this.__exposureRange=[-5,10],this.__tonemap=!0,this.__gamma=2.2,this.__prevDownTime=0,this.__geomDataBuffer=void 0,this.__geomDataBufferFbo=void 0,this.viewChanged=new v,this.capturedItem=null,this.keyDown=new v,this.keyPressed=new v,this.keyUp=new v,this.mouseDown=new v,this.mouseDoubleClicked=new v,this.mouseMove=new v,this.mouseUp=new v,this.mouseLeave=new v,this.mouseDownOnGeom=new v,this.mouseWheel=new v,this.touchStart=new v,this.touchMove=new v,this.touchEnd=new v,this.touchCancel=new v,this.doubleTapped=new v,this.setCamera(new ns("Default")),this.setManipulator(new gs),this.resize(s,e)}resize(t,i){this.__canvasWidth=t,this.__canvasHeight=i,this.__x=t*this.__bl.x,this.__y=t*this.__bl.y,this.__width=t*this.__tr.x-t*this.__bl.x,this.__height=i*this.__tr.y-i*this.__bl.y,this.region=[this.__x,this.__y,this.__width,this.__height],this.__camera&&this.__updateProjectionMatrix(),this.__geomDataBufferFbo&&(this.__geomDataBuffer.resize(this.__width,this.__height),this.__geomDataBufferFbo.resize()),this.resized.emit()}getCamera(){return this.__camera}setCamera(t){this.__camera=t;const i=t.getParameter("GlobalXfo"),s=()=>{this.__cameraXfo=i.getValue(),this.__cameraMat=this.__cameraXfo.toMat4(),this.__viewMat=this.__cameraMat.inverse()};s(),i.valueChanged.connect(()=>{s(),this.invalidateGeomDataBuffer(),this.updated.emit(),this.viewChanged.emit({interfaceType:"CameraAndPointer",viewXfo:this.__cameraXfo,focalDistance:this.__camera.getFocalDistance()})}),this.__camera.projectionParamChanged.connect(()=>{this.__updateProjectionMatrix(),this.updated.emit()}),this.__updateProjectionMatrix()}getManipulator(){return this.__cameraManipulator}setManipulator(t){this.__cameraManipulator=t}__updateProjectionMatrix(){const t=this.__width/this.__height;this.__camera.updateProjectionMatrix(this.__projectionMatrix,t);const i=Math.tan(this.__camera.getFov()/2)*this.__camera.getNear()*2;this.__frustumDim.set(i*t,i)}getProjectionMatrix(){return this.__projectionMatrix}getViewMatrix(){return this.__viewMat}setActive(t){activeViewport=t?this:void 0}frameView(t){this.__camera.frameView(this,t)}calcRayFromScreenPos(t){let i=(t.x-this.__x)/this.__width,s=(t.y-this.__canvasHeight*(1-this.__tr.y))/this.__height;i=2*i-1,s=2*s-1;const e=this.__cameraMat,n=this.__projectionMatrix.inverse();if(null==n)return null;let l,h;return this.__camera.getIsOrthographic()?(l=e.transformVec3(n.transformVec3(new u(i,-s,-1))),h=new u(0,0,-1)):(l=e.translation,h=n.transformVec3(new u(i,-s,-1))),h=e.rotateVec3(h).normalize(),new V(l,h)}createGeomDataFbo(t){const i=this.__renderer.gl;this.__floatGeomBuffer=t,this.__geomDataBuffer=new Is(i,this.__floatGeomBuffer?{type:"FLOAT",format:"RGBA",filter:"NEAREST",width:this.__width<=1?1:this.__width,height:this.__height<=1?1:this.__height}:{type:"UNSIGNED_BYTE",format:"RGBA",filter:"NEAREST",width:this.__width<=1?1:this.__width,height:this.__height<=1?1:this.__height}),this.__geomDataBufferFbo=new Ts(i,this.__geomDataBuffer,!0),this.__geomDataBufferFbo.setClearColor([0,0,0,0])}getGeomDataFbo(){return this.__geomDataBufferFbo}renderGeomDataFbo(){if(this.__geomDataBufferFbo){this.__geomDataBufferFbo.bindAndClear();const t={};this.__initRenderState(t),this.__renderer.drawSceneGeomData(t),this.__geomDataBufferInvalid=!1}}invalidateGeomDataBuffer(){this.__geomDataBufferInvalid=!0}getGeomDataAtPos(t,i){if(this.__geomDataBufferFbo){if(this.__geomDataBufferInvalid&&(this.renderGeomDataFbo(),this.__screenPos=null),t===this.__screenPos)return this.__intersectionData;this.__screenPos=t,this.__intersectionData=null;const s=this.__renderer.gl;let e,n;if(s.finish(),this.__geomDataBufferFbo.bindForReading(),s.floatGeomBuffer){if(n=new Float32Array(4),s.readPixels(t.x,this.__height-t.y,1,1,s.RGBA,s.FLOAT,n),0==n[3])return;e=63&Math.round(n[0])}else{if(n=new Uint8Array(4),s.readPixels(t.x,this.__height-t.y,1,1,s.RGBA,s.UNSIGNED_BYTE,n),s.bindFramebuffer(s.FRAMEBUFFER,null),0==n[0]&&0==n[1])return;e=0}this.__geomDataBufferFbo.unbind();const l=this.__renderer.getPass(e);if(!l)return void console.warn("Geom data buffer returns invalid pass id:",e);const h=l.getGeomItemAndDist(n);if(h){i||(i=this.calcRayFromScreenPos(t));const s=i.start.add(i.dir.scale(h.dist));this.__intersectionData={screenPos:t,mouseRay:i,intersectionPos:s,geomItem:h.geomItem,dist:h.dist,geomData:n}}return this.__intersectionData}}getGeomItemsInRect(t,i){if(this.__geomDataBufferFbo){const s=this.__renderer.gl;s.finish();const e=Math.round(this.__height-i.y),n=Math.round(t.x),l=Math.round(i.x-t.x),h=Math.round(i.y-t.y),o=l*h;let a;this.__geomDataBufferFbo.bindForReading(),s.floatGeomBuffer?(a=new Float32Array(4*o),s.readPixels(n,e,l,h,s.RGBA,s.FLOAT,a)):(a=new Uint8Array(4*o),s.readPixels(n,e,l,h,s.RGBA,s.UNSIGNED_BYTE,a)),s.bindFramebuffer(s.FRAMEBUFFER,null);const c=new Set;for(let t=0;t<o;t++){let i;const e=a.subarray(4*t,4*(t+1));i=s.floatGeomBuffer?Math.round(e[0]):0;const n=this.__renderer.getPass(i).getGeomItemAndDist(e);n&&c.add(n.geomItem)}return c}}__eventMousePos(t){return new d(t.rendererX-this.getPosX(),t.rendererY-this.getPosY())}__prepareEvent(t){if(t.viewport=this,t.propagating=!0,t.stopPropagation(),t.stopPropagation=()=>{t.propagating=!1},t.setCapture=t=>{this.capturedItem=t},t.getCapture=()=>this.capturedItem,t.releaseCapture=()=>{this.capturedItem=null,this.renderGeomDataFbo()},t instanceof MouseEvent){const i=this.__eventMousePos(t);t.mousePos=i,t.mouseRay=this.calcRayFromScreenPos(i);const s=this.getGeomDataAtPos(t.mousePos,t.mouseRay);null!=s&&(t.intersectionData=s)}}setCapture(t){this.capturedItem=t}getCapture(){return this.capturedItem}releaseCapture(){this.capturedItem=null,this.renderGeomDataFbo()}onMouseDown(t){if(this.__prepareEvent(t),this.capturedItem)return void this.capturedItem.onMouseDown(t);if(null!=t.intersectionData){if(t.intersectionData.geomItem.onMouseDown(t),!t.propagating||this.capturedItem)return;if(this.mouseDownOnGeom.emit(t),!t.propagating)return}const i=Date.now();if(i-this.__prevDownTime<this.__doubleClickTimeMSParam.getValue()){if(this.__cameraManipulator&&(this.__cameraManipulator.onDoubleClick(t),!t.propagating))return;this.mouseDoubleClicked.emit(t)}else{if(this.__prevDownTime=i,this.__cameraManipulator&&(this.__cameraManipulator.onMouseDown(t),!t.propagating))return;this.mouseDown.emit(t)}return!1}onMouseMove(t){if(this.__prepareEvent(t),this.capturedItem)this.capturedItem.onMouseMove(t);else{if(null!=t.intersectionData){if(t.intersectionData.geomItem!=this.mouseOverItem&&(this.mouseOverItem&&this.mouseOverItem.onMouseLeave(t),this.mouseOverItem=t.intersectionData.geomItem,this.mouseOverItem.onMouseEnter(t)),t.intersectionData.geomItem.onMouseMove(t),!t.propagating||this.capturedItem)return}else this.mouseOverItem&&(this.mouseOverItem.onMouseLeave(t),this.mouseOverItem=null);this.__cameraManipulator&&(this.__cameraManipulator.onMouseMove(t),!t.propagating)||this.mouseMove.emit(t)}}onMouseUp(t){this.__prepareEvent(t),this.capturedItem?this.capturedItem.onMouseUp(t):(null==t.intersectionData||(t.intersectionData.geomItem.onMouseUp(t),t.propagating))&&(this.__cameraManipulator&&(this.__cameraManipulator.onMouseUp(t),!t.propagating)||this.mouseUp.emit(t))}onMouseLeave(t){this.__prepareEvent(t),this.mouseLeave.emit(t)}onKeyPressed(t,i){this.__prepareEvent(i),this.__cameraManipulator&&this.__cameraManipulator.onKeyPressed(t,i)||this.keyPressed.emit(t,i)}onKeyDown(t,i){this.__prepareEvent(i),this.__cameraManipulator&&this.__cameraManipulator.onKeyDown(t,i)||this.keyDown.emit(t,i)}onKeyUp(t,i){this.__prepareEvent(i),this.__cameraManipulator&&this.__cameraManipulator.onKeyUp(t,i)||this.keyUp.emit(t,i)}onWheel(t){this.__prepareEvent(t),(null==t.intersectionData||(t.intersectionData.geomItem.onWheel(t),t.propagating))&&(this.__cameraManipulator?this.__cameraManipulator.onWheel(t):this.mouseWheel.emit(t))}__eventTouchPos(t){return new d(t.rendererX-this.getPosX(),t.rendererY-this.getPosY())}onTouchStart(t){if(this.__prepareEvent(t),1==t.touches.length){const i=this.__eventTouchPos(t.touches[0]);t.touchPos=i,t.touchRay=this.calcRayFromScreenPos(i);const s=this.getGeomDataAtPos(i,t.touchRay);if(null!=s){if(t.intersectionData=s,s.geomItem.onMouseDown(t,s),!t.propagating)return;if(this.capturedItem)return;if(this.mouseDownOnGeom.emit(t),!t.propagating)return}const e=Date.now();if(e-this.__prevDownTime<this.__doubleClickTimeMSParam.getValue()){if(this.__cameraManipulator&&(this.__cameraManipulator.onDoubleTap(t),!t.propagating))return;return void this.doubleTapped.emit(t)}this.__prevDownTime=e}this.__cameraManipulator?this.__cameraManipulator.onTouchStart(t):this.touchStart.emit(t)}onTouchMove(t){if(this.__prepareEvent(t),this.capturedItem){t.touchPos=[],t.touchRay=[];for(let i=0;i<t.touches.length;i++){const s=this.__eventTouchPos(t.touches[i]);t.touchPos[i]=s,t.touchRay[i]=this.calcRayFromScreenPos(s)}return t.mousePos=t.touchPos[0],t.mouseRay=t.touchRay[0],void this.capturedItem.onMouseMove(t)}this.__cameraManipulator?this.__cameraManipulator.onTouchMove(t):this.touchMove.emit(t)}onTouchEnd(t){this.__prepareEvent(t),this.capturedItem?this.capturedItem.onMouseUp(t):this.__cameraManipulator?this.__cameraManipulator.onTouchEnd(t):this.touchEnd.emit(t)}onTouchCancel(t){this.__prepareEvent(t),this.capturedItem?this.capturedItem.onTouchCancel(t):this.__cameraManipulator?this.__cameraManipulator.onTouchCancel(t):this.touchCancel.emit(t)}__initRenderState(t){t.viewXfo=this.__cameraXfo,t.viewScale=1,t.region=this.region,t.cameraMatrix=this.__cameraMat,t.viewports=[{region:this.region,viewMatrix:this.__viewMat,projectionMatrix:this.__projectionMatrix,viewportFrustumSize:this.__frustumDim,isOrthographic:this.__camera.getIsOrthographic(),fovY:this.__camera.getFov()}]}draw(){const t=this.__renderer.gl;t.bindFramebuffer(t.FRAMEBUFFER,null),t.viewport(...this.region),this.__backgroundColor&&t.clearColor(...this.__backgroundColor.asArray()),t.colorMask(!0,!0,!0,!0),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT);const i={};this.__initRenderState(i),this.__renderer.drawScene(i)}}class be{constructor(t,i){this.__vrviewport=t,this.__treeItem=new Qi("VRHead"),i.addChild(this.__treeItem),this.__mat4=new y,this.__localXfo=new g}update(t){this.__mat4.setDataArray(t.transform.matrix),this.__localXfo.fromMat4(this.__mat4),this.__treeItem.setLocalXfo(this.__localXfo)}getTreeItem(){return this.__treeItem}getXfo(){return this.__localXfo}}class Ze{constructor(t,i,s){if(this.__vrviewport=t,this.__inputSource=i,this.__id=s,this.__isDaydramController=e.isMobileDevice,this.touchpadTouched=new v,this.buttonPressed=new v,this.buttonReleased=new v,this.__pressedButtons=[],this.__mat4=new y,this.__xfo=new g,this.__treeItem=new Qi("VRController:"+i.handedness+s),!this.__isDaydramController){this.__tip=new Qi("Tip");const i=new g;i.tr.set(0,-.05,-.13),this.__tip.setLocalXfo(i),this.__treeItem.addChild(this.__tip,!1),t.getTreeItem().addChild(this.__treeItem),this.__activeVolumeSize=.04,t.loadHMDResources().then(t=>{t.loaded.connect(()=>{let i;0==s?i=t.getChildByName("LeftController"):1==s&&(i=t.getChildByName("RightController")),i||(i=t.getChildByName("Controller"));const e=i.clone();e.setLocalXfo(new g(new u(0,-.035,-.085),new f({setFromAxisAndAngle:[new u(0,1,0),Math.PI]}),new u(.001,.001,.001))),this.__treeItem.addChild(e,!1)})})}}getHandedness(){return this.__inputSource.handedness}getId(){return this.__id}getTreeItem(){return this.__treeItem}getTipItem(){return this.__tip}getTipXfo(){return this.__tip.getGlobalXfo()}getTouchPadValue(){return this.__touchpadValue}isButtonPressed(){return this.__buttonPressed}getControllerStageLocalXfo(){return this.__xfo}getControllerTipStageLocalXfo(){return this.__xfo.multiply(this.__tip.getLocalXfo())}updatePose(t,i,s){const e=i.getPose(s.gripSpace,t);e&&e.transform&&(this.__mat4.setDataArray(e.transform.matrix),this.__xfo.fromMat4(this.__mat4),this.__treeItem.setLocalXfo(this.__xfo),this.__geomAtTip=void 0,this.__hitTested=!1)}getGeomItemAtTip(){if(this.__hitTested)return this.__intersectionData;this.__hitTested=!0;const t=this.__vrviewport.getRenderer(),i=this.__tip.getGlobalXfo(),s=this.__activeVolumeSize;return this.__intersectionData=t.raycastWithXfo(i,s,s),this.__intersectionData}}class pe extends ue{constructor(t){super(t),this.getParameter("DoubleClickTimeMS").setValue(300),this.__projectionMatriciesUpdated=!1,this.__far=1024,this.__near=.1,this.__stageTreeItem=new Qi("VRStage"),this.__stageTreeItem.setSelectable(!1),this.__stageTreeItem.setVisible(!1),this.__renderer.addTreeItem(this.__stageTreeItem),this.__vrhead=new be(this.__renderer.gl,this.__stageTreeItem),this.__vrControllersMap={},this.__vrControllers=[];const i=new g;i.ori.setFromAxisAndAngle(new u(1,0,0),.5*Math.PI),this.setXfo(i),this.__leftViewMatrix=new y,this.__leftProjectionMatrix=new y,this.__rightViewMatrix=new y,this.__rightProjectionMatrix=new y,this.resized=new v,this.viewChanged=new v,this.presentingChanged=new v,this.controllerAdded=new v,this.controllerButtonDown=new v,this.controllerButtonUp=new v,this.controllerDoubleClicked=new v,this.controllerTouchpadTouched=new v}getVRDisplay(){return this.__vrDisplay}getAsset(){return this.__vrAsset}getTreeItem(){return this.__stageTreeItem}getVRHead(){return this.__vrhead}getXfo(){return this.__stageXfo}setXfo(t){this.__stageXfo=t,this.__stageTreeItem.setGlobalXfo(t),this.__stageMatrix=t.inverse().toMat4(),this.__stageScale=t.sc.x}getControllers(){return this.__vrControllers}canPresent(){return this.__canPresent}isPresenting(){return this.__session}__startSession(){const t=(i,s)=>{this.__session&&(this.__session.requestAnimationFrame(t),this.draw(s))};this.__session.requestAnimationFrame(t)}loadHMDResources(){const t=localStorage.getItem("hmd");return this.__hmd!=t&&(this.__hmdAssetPromise=void 0),this.__hmdAssetPromise||(this.__hmd=t,this.__hmdAssetPromise=new Promise((i,s)=>{this.__renderer.sceneSet.connect(n=>{const l=n.getResourceLoader();let h;switch(t){case"Vive":h="ZeaEngine/Vive.vla";break;case"Oculus":default:h="ZeaEngine/Oculus.vla"}const o=l.resolveFilePathToId(h);o&&!e.isMobileDevice?(this.__vrAsset=this.__renderer.getScene().loadCommonAssetResource(o),this.__vrAsset.loaded.connect(()=>{const t=this.__vrAsset.getMaterialLibrary(),s=t.getMaterialNames();for(const i of s){const s=t.getMaterial(i,!1);s&&(s.visibleInGeomDataBuffer=!1,s.setShaderName("SimpleSurfaceShader"))}i(this.__vrAsset)})):s()})})),this.__hmdAssetPromise}startPresenting(){const t=this.__renderer.gl;this.loadHMDResources().then(()=>{navigator.xr.requestSession("immersive-vr",{requiredFeatures:["local-floor"],optionalFeatures:["bounded-floor"]}).then(i=>{this.__renderer.__xrViewportPresenting=!0;const s=document.createElement("canvas");s.style.position="relative",s.style.left="0px",s.style.top="0px",s.style.width="100%",s.style.height="100%",this.__renderer.getDiv().replaceChild(s,this.__renderer.getGLCanvas()),i.addEventListener("end",()=>{this.__stageTreeItem.setVisible(!1),this.__renderer.getDiv().replaceChild(this.__renderer.getGLCanvas(),s),this.__session=null,this.presentingChanged.emit(!1)}),i.addEventListener("selectstart",t=>{const i=this.__vrControllersMap[t.inputSource.handedness];if(i){const s=Date.now();console.log("controller:",t.inputSource.handedness," down",s-i.__prevDownTime),s-i.__prevDownTime<this.__doubleClickTimeMSParam.getValue()?this.controllerDoubleClicked.emit({button:1,controller:i,vleStopPropagation:!1,vrviewport:this},this):(i.__prevDownTime=s,this.controllerButtonDown.emit({button:1,controller:i,vleStopPropagation:!1,vrviewport:this},this))}}),i.addEventListener("selectend",t=>{const i=this.__vrControllersMap[t.inputSource.handedness];i&&(console.log("controller:",t.inputSource.handedness," up"),this.controllerButtonUp.emit({button:1,controller:i,vleStopPropagation:!1,vrviewport:this},this))}),this.__session=i,i.updateRenderState({baseLayer:new XRWebGLLayer(i,t,{compositionDisabled:"inline"==i.mode}),outputContext:s.getContext("xrpresent")}),i.requestReferenceSpace("local-floor").catch(()=>(console.log("Falling back to identity reference space"),i.requestReferenceSpace("viewer").then(t=>t.getOffsetReferenceSpace(new XRRigidTransform({y:-1.6}))))).then(t=>{this.__refSpace=t,this.__stageTreeItem.setVisible(!0),this.presentingChanged.emit(!0),this.__startSession()}).catch(t=>{console.warn(t.message)})}).catch(t=>{console.warn(t.message)})})}stopPresenting(){this.__session&&this.__session.end()}togglePresenting(){this.__session?this.stopPresenting():this.startPresenting()}getHMDCanvasSize(){return this.__hmdCanvasSize}__createController(t,i){console.log("creating controller:",i.handedness);const s=new Ze(this,i,t);return this.__vrControllersMap[i.handedness]=s,this.__vrControllers[t]=s,this.controllerAdded.emit(s),s}updateControllers(t){const i=this.__session.inputSources;for(let s=0;s<i.length;s++){const e=i[s];if(""==e.handedness||"none"==e.handedness)return;this.__vrControllers[s]||this.__createController(s,e),this.__vrControllers[s].updatePose(this.__refSpace,t,e)}}draw(t){const i=t.session.renderState.baseLayer,s=t.getViewerPose(this.__refSpace),e=s.views;if(!this.__projectionMatriciesUpdated){this.__projectionMatrices=[],this.__viewMatrices=[],this.__cameraMatrices=[],this.__region=[0,0,0,0];for(let t=0;t<e.length;t++){const s=e[t],n=new y;n.setDataArray(s.projectionMatrix),this.__projectionMatrices[t]=n,this.__viewMatrices[t]=new y,this.__cameraMatrices[t]=new y;const l=i.getViewport(s);this.__region[2]=Math.max(this.__region[2],l.x+l.width),this.__region[3]=Math.max(this.__region[3],l.y+l.height)}this.__renderer.resizeFbos(this.__region[2],this.__region[3]),this.__projectionMatriciesUpdated=!0}const n=this.__renderer.gl;n.bindFramebuffer(n.FRAMEBUFFER,i.framebuffer),this.__backgroundColor&&n.clearColor(...this.__backgroundColor.asArray()),n.colorMask(!0,!0,!0,!0),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT);const l={boundRendertarget:i.framebuffer,region:this.__region,viewports:[]};for(let t=0;t<e.length;t++){const s=e[t];this.__viewMatrices[t].setDataArray(s.transform.inverse.matrix),this.__viewMatrices[t].multiplyInPlace(this.__stageMatrix);const n=i.getViewport(s);l.viewports.push({viewMatrix:this.__viewMatrices[t],projectionMatrix:this.__projectionMatrices[t],region:[n.x,n.y,n.width,n.height]})}this.__vrhead.update(s),this.updateControllers(t),l.viewXfo=this.__vrhead.getTreeItem().getGlobalXfo(),l.viewScale=1/this.__stageScale,l.cameraMatrix=l.viewXfo.toMat4(),l.region=this.__region,this.__renderer.drawScene(l),this.capturedElement&&this.capturedElement.onMouseMove({viewport:this}),this.viewChanged.emit({interfaceType:"VR",hmd:this.__hmd,viewXfo:l.viewXfo,controllers:this.__vrControllers,vrviewport:this},this)}setCapture(t){this.capturedElement=t}getCapture(){return this.capturedElement}releaseCapture(){this.capturedElement=null,this.renderGeomDataFbo()}}let Ge=void 0,Xe=!1,ye=!1;const fe={},Ve={OPAQUE:1,TRANSPARENT:2,OVERLAY:4};class ge extends B{constructor(){super(),this.updated=new v,this.enabled=!0,this.__passIndex=0;const t=this.addParameter(new bt("Enabled",!0));t.valueChanged.connect(()=>this.enabled=t.getValue())}__parameterValueChanged(t,i){super.__parameterValueChanged(t,i),this.__renderer&&this.__renderer.requestRedraw()}init(t,i){if(null==i)throw new Error("Missing constructor argument.");this.__gl=t.gl,this.__renderer=t,this.__passIndex=i}setPassIndex(t){this.__passIndex=t}startPresenting(){}stopPresenting(){}draw(t){}drawHighlightedGeoms(t){}drawGeomData(t){}getGeomItemAndDist(t){}}class Re extends Fs{constructor(t){super(t),this.__shaderStages.VERTEX_SHADER=ws.parseShader("OutlinesShader.vertexShader","\nprecision highp float;\n\nattribute vec3 positions;    //(location = 0)\n\n/* VS Outputs */\nvarying vec2 v_texCoord;\n \nvoid main()\n{\n    v_texCoord = positions.xy+0.5;\n    gl_Position = vec4(positions.xy*2.0, 0.0, 1.0);\n}\n\n"),this.__shaderStages.FRAGMENT_SHADER=ws.parseShader("OutlinesShader.fragmentShader","\nprecision highp float;\n\nuniform sampler2D highlightDataTexture;\nuniform vec2 highlightDataTextureSize;\n\nvarying vec2 v_texCoord;\n\n\nbool isFilledPixel(vec4 p) {\n    return p.r > 0.01 || p.g > 0.01 || p.b > 0.01;\n}\nvoid accumOutlinePixel(vec2 fragCoord, inout vec4 res) {\n    vec3 p = texture2D(highlightDataTexture, fragCoord/highlightDataTextureSize).rgb;\n    if(p.r > 0.01 || p.g > 0.01 || p.b > 0.01) {\n        res.r += p.r;\n        res.g += p.g;\n        res.b += p.b;\n        res.a += 1.0;\n    }\n}\nvec4 getOutlinePixelColor(vec2 fragCoord) {\n    vec4 M = texture2D(highlightDataTexture, fragCoord/highlightDataTextureSize);\n    \n    /// To display a fill instead of an outline.\n    // return M;\n\n    if( isFilledPixel(M) ) {\n        // Note: the filled pixel has an alpha value\n        // that determines how much fill is applied\n        // The outline is a solid color. \n        return M;\n    }\n    // Search surrounding pixels for selected geoms.\n    vec4 res;\n    accumOutlinePixel(fragCoord+vec2( 1, 1), res); // NW\n    accumOutlinePixel(fragCoord+vec2(-1, 1), res); // NE\n    accumOutlinePixel(fragCoord+vec2( 1,-1), res); // SW\n    accumOutlinePixel(fragCoord+vec2(-1,-1), res); // SE\n    accumOutlinePixel(fragCoord+vec2( 0, 2), res); // NN\n    accumOutlinePixel(fragCoord+vec2(-2, 0), res); // EE\n    accumOutlinePixel(fragCoord+vec2( 2, 0), res); // WW\n    accumOutlinePixel(fragCoord+vec2( 0,-2), res); // SS\n    accumOutlinePixel(fragCoord+vec2( 1, 2), res); // NNW\n    accumOutlinePixel(fragCoord+vec2(-1, 2), res); // NNE\n    accumOutlinePixel(fragCoord+vec2(-2, 1), res); // EEN\n    accumOutlinePixel(fragCoord+vec2(-2,-1), res); // EES\n    accumOutlinePixel(fragCoord+vec2( 2, 1), res); // WWN\n    accumOutlinePixel(fragCoord+vec2( 2,-1), res); // WWS\n    accumOutlinePixel(fragCoord+vec2( 1,-2), res); // SSW\n    accumOutlinePixel(fragCoord+vec2(-1,-2), res); // SSE\n\n    if(isFilledPixel(res))\n        return vec4(res.rgb / res.a, 1.0);\n    else\n        return vec4(0.0, 0.0, 0.0, 0.0);\n}\n\n\n#ifdef ENABLE_ES3\nout vec4 fragColor;\n#endif\n\nvoid main(void) {\n\n    // fragColor = texture2D(highlightDataTexture, v_texCoord);;\n    //can also use gl_FragCoord.xy\n    mediump vec2 fragCoord = v_texCoord * highlightDataTextureSize; \n    /////////////////\n    // Selection Outlines\n    vec4 outlineColor = getOutlinePixelColor(fragCoord);\n    if(outlineColor.a > 0.0001){\n#ifndef ENABLE_ES3\n        gl_FragColor = outlineColor;\n#else\n        fragColor = outlineColor;\n#endif\n    }\n    else {\n        discard;\n    }\n}\n\n")}}const We=Ve.OPAQUE|Ve.TRANSPARENT|Ve.OVERLAY;class Ie extends class{constructor(t,i={}){if(e.gpuDesc){this.__shaders={},this.__passes={},this.__passCallbacks=[],this.addTreeItem=this.addTreeItem.bind(this),this.removeTreeItem=this.removeTreeItem.bind(this),this.__viewports=[],this.__activeViewport=void 0,this.__continuousDrawing=!1,this.__redrawRequested=!1,this.__isMobile=e.isMobileDevice,this.__drawSuspensionLevel=1,this.__shaderDirectives={},this.__preproc={},this.__xrViewportPresenting=!1,this.renderGeomDataFbos=this.renderGeomDataFbos.bind(this),this.requestRedraw=this.requestRedraw.bind(this),this.resized=new v,this.keyPressed=new v,this.sceneSet=new v(!0),this.vrViewportSetup=new v(!0),this.sessionClientSetup=new v(!0),this.viewChanged=new v,this.redrawOccured=new v,this.setupWebGL(t,i.webglOptions?i.webglOptions:{}),this.bindEventHandlers();for(const t in fe)for(const i of fe[t])this.addPass(new i,t,!1);this.addViewport("main"),this.__supportXR=void 0===i.supportXR||i.supportXR,this.__xrViewport=void 0,this.__xrViewportPromise=new Promise(t=>{if(this.__supportXR&&navigator.xr){const i=()=>{this.__gl.makeXRCompatible().then(()=>{this.__xrViewport=this.__setupXRViewport(),this.vrViewportSetup.emit(this.__xrViewport),t(this.__xrViewport)})};navigator.xr.supportsSessionMode?navigator.xr.supportsSessionMode("immersive-vr").then(i).catch(t=>{console.warn("Unable to setup XR:"+t)}):navigator.xr.isSessionSupported("immersive-vr").then(t=>{t&&i()}).catch(t=>{console.warn("Unable to setup XR:"+t)})}})}else console.warn("Unable to create renderer")}addShaderPreprocessorDirective(t,i){this.__shaderDirectives[t]=i?"#define "+t+" = "+i:"#define "+t;const s=[];for(const t in this.__shaderDirectives)s.push(this.__shaderDirectives[t]);this.__preproc.defines=s.join("\n")+"\n",this.__gl.shaderopts=this.__preproc}getShaderPreproc(){return this.__preproc}getWidth(){return this.__glcanvas.width}getHeight(){return this.__glcanvas.height}addViewport(t){const i=new me(this,t,this.getWidth(),this.getHeight());return i.updated.connect(()=>{this.requestRedraw()}),i.createGeomDataFbo(this.__floatGeomBuffer),i.viewChanged.connect(t=>{this.__xrViewportPresenting||this.viewChanged.emit(t)}),this.__viewports.push(i),i}getViewport(t=0){return this.__viewports[t]}getViewportAtPos(t,i){for(const s of this.__viewports){const e=s.getPosX(),n=s.getPosY(),l=s.getWidth(),h=s.getHeight();if(t>=e&&i>=n&&t<=l+e&&i<=h+n)return s}}activateViewport(t){this.__activeViewport!=t&&(this.__activeViewport=t)}activateViewportAtPos(t,i){if(this.__xrViewportPresenting)return;const s=this.getViewportAtPos(t,i);s&&s!=this.__activeViewport&&this.activateViewport(s)}getActiveViewport(){return this.__xrViewportPresenting?this.__xrViewport:this.__activeViewport}suspendDrawing(){this.__drawSuspensionLevel++}resumeDrawing(){this.__drawSuspensionLevel--,0==this.__drawSuspensionLevel&&(this.__loadingImg&&this.__glcanvasDiv.removeChild(this.__loadingImg),this.renderGeomDataFbos(),this.requestRedraw())}renderGeomDataFbos(){1!=this.__renderGeomDataFbosRequested&&(this.__renderGeomDataFbosRequested=!0,window.requestAnimationFrame(()=>{for(const t of this.__viewports)t.renderGeomDataFbo();this.__renderGeomDataFbosRequested=!1}))}setupGrid(t,i,s,e){return console.warn("Deprecated Method. Please use scene.setupGrid"),this.__scene.setupGrid(t,s,i)}getScene(){return this.__scene}setScene(t){this.__scene=t,this.addTreeItem(this.__scene.getRoot()),this.__gizmoContext&&this.__gizmoContext.setSelectionManager(t.getSelectionManager()),this.sceneSet.emit(this.__scene)}addTreeItem(t){if(t instanceof Qi){for(const i of this.__passCallbacks){const s={continueInSubTree:!0};if(i.itemAddedFn(t,s)){if(!s.continueInSubTree)return;break}}for(const i of t.getChildren())i&&this.addTreeItem(i);t.childAdded.connect(this.addTreeItem),t.childRemoved.connect(this.removeTreeItem),this.renderGeomDataFbos()}}removeTreeItem(t){if(t instanceof Qi){t.childAdded.disconnect(this.addTreeItem),t.childRemoved.disconnect(this.removeTreeItem);for(const i of this.__passCallbacks){if(!i.itemRemovedFn)continue;const s={continueInSubTree:!0};if(i.itemRemovedFn(t,s)){if(!s.continueInSubTree)return;break}}for(const i of t.getChildren())i&&this.removeTreeItem(i);this.renderGeomDataFbos()}}get gl(){return this.__gl}getGL(){return this.__gl}resizeFbos(t,i){}__onResize(){if(!this.__xrViewportPresenting){const t=1;this.__glcanvas.width=this.__glcanvas.clientWidth*t,this.__glcanvas.height=this.__glcanvas.clientHeight*t;for(const t of this.__viewports)t.resize(this.__glcanvas.width,this.__glcanvas.height);this.resizeFbos(this.__glcanvas.width,this.__glcanvas.height),this.resized.emit(this.__glcanvas.width,this.__glcanvas.height),this.requestRedraw()}}getDiv(){return this.__glcanvasDiv}setupWebGL(t,i){this.__glcanvas=document.createElement("canvas"),this.__glcanvas.style.position=i.canvasPosition?i.canvasPosition:"absolute",this.__glcanvas.style.left="0px",this.__glcanvas.style.top="0px",this.__glcanvas.style.width="100%",this.__glcanvas.style.height="100%",this.__glcanvasDiv=t,this.__glcanvasDiv.appendChild(this.__glcanvas),s(this.__glcanvas,()=>{this.__onResize()}),this.__onResize(),i.preserveDrawingBuffer=!0,i.stencil=!!i.stencil&&i.stencil,i.alpha=!!i.alpha&&i.alpha,i.xrCompatible=!0,this.__gl=Ws(this.__glcanvas,i),this.__gl||alert("Unable to create WebGL context. WebGL not supported."),this.__gl.renderer=this,"webgl2"==this.__gl.name&&this.addShaderPreprocessorDirective("ENABLE_ES3"),this.__gl.floatTexturesSupported&&this.addShaderPreprocessorDirective("ENABLE_FLOAT_TEXTURES"),this.__gl.screenQuad=new de(this.__gl),this.__screenQuad=this.__gl.screenQuad,this.__floatGeomBuffer=this.__gl.floatTexturesSupported&&"Safari"!=e.browserName,this.__gl.floatGeomBuffer=this.__floatGeomBuffer}bindEventHandlers(){const t=()=>this.__glcanvas.width>0&&this.__glcanvas.height,i=t=>{const i=this.__glcanvas.getBoundingClientRect();t.rendererX=1*(t.clientX-i.left),t.rendererY=1*(t.clientY-i.top)};this.__glcanvas.addEventListener("mouseenter",t=>{t.stopPropagation(),t.undoRedoManager=this.undoRedoManager,Xe||(Ge=this,i(t),Ge.activateViewportAtPos(t.rendererX,t.rendererY),ye=!1)}),this.__glcanvas.addEventListener("mouseleave",i=>{if(Ge==this&&t())if(i.stopPropagation(),i.undoRedoManager=this.undoRedoManager,Xe)ye=!0;else{const t=Ge.getActiveViewport();t&&(t.onMouseLeave(i),i.preventDefault()),Ge=void 0}}),this.__glcanvas.addEventListener("mousedown",t=>{t.stopPropagation(),t.undoRedoManager=this.undoRedoManager,i(t),Xe=!0,Ge=this,Ge.activateViewportAtPos(t.rendererX,t.rendererY);const s=Ge.getActiveViewport();return s&&s.onMouseDown(t),ye=!1,!1}),document.addEventListener("mouseup",s=>{if(Ge!=this||!t())return;s.stopPropagation(),s.undoRedoManager=this.undoRedoManager,i(s),Xe=!1;const e=Ge.getActiveViewport();if(e&&e.onMouseUp(s),ye){const t=Ge.getActiveViewport();t&&(t.onMouseLeave(s),s.preventDefault()),Ge=void 0}return!1}),document.addEventListener("mousemove",s=>{if(Ge!=this||!t())return;s.preventDefault(),s.stopPropagation(),s.undoRedoManager=this.undoRedoManager,i(s),Xe||Ge.activateViewportAtPos(s.rendererX,s.rendererY);const e=Ge.getActiveViewport();return e&&e.onMouseMove(s),!1});const s=i=>{if(Ge==this&&t())return Ge&&(i.stopPropagation(),i.undoRedoManager=this.undoRedoManager,window.addEventListener||i.preventDefault(),this.onWheel(i)),!1};window.addEventListener?window.addEventListener("wheel",s,{passive:!0}):window.onmousewheel=document.onmousewheel=s,window.oncontextmenu=function(){return!1},document.addEventListener("keypress",i=>{if(Ge!=this||!t())return;const s=String.fromCharCode(i.keyCode).toLowerCase(),e=Ge.getActiveViewport();e&&e.onKeyPressed(s,i)}),document.addEventListener("keydown",i=>{if(Ge!=this||!t())return;const s=String.fromCharCode(i.keyCode).toLowerCase(),e=Ge.getActiveViewport();e&&e.onKeyDown(s,i)}),document.addEventListener("keyup",i=>{if(Ge!=this||!t())return;const s=String.fromCharCode(i.keyCode).toLowerCase(),e=Ge.getActiveViewport();e&&e.onKeyUp(s,i)}),this.__glcanvas.addEventListener("touchstart",t=>{t.stopPropagation(),t.undoRedoManager=this.undoRedoManager;for(let s=0;s<t.touches.length;s++)i(t.touches[s]);this.getViewport().onTouchStart(t)},!1),this.__glcanvas.addEventListener("touchmove",t=>{t.stopPropagation(),t.undoRedoManager=this.undoRedoManager;for(let s=0;s<t.touches.length;s++)i(t.touches[s]);this.getViewport().onTouchMove(t)},!1),this.__glcanvas.addEventListener("touchend",t=>{t.stopPropagation(),t.undoRedoManager=this.undoRedoManager;for(let s=0;s<t.touches.length;s++)i(t.touches[s]);this.getViewport().onTouchEnd(t)},!1),this.__glcanvas.addEventListener("touchcancel",t=>{t.stopPropagation(),t.undoRedoManager=this.undoRedoManager,this.getViewport().onTouchCancel(t)},!1)}setUndoRedoManager(t){this.undoRedoManager=t}getGLCanvas(){return this.__glcanvas}getScreenQuad(){return this.__screenQuad}onWheel(t){this.__viewports[0].onWheel(t)}frameAll(t=0){this.__viewports[t].frameView([this.__scene.getRoot()])}getOrCreateShader(t){let i=this.__shaders[t];return i||(i=N.constructClass(t,this.__gl),i||console.error("Shader not registered with the SGFactory:",t),this.__shaders[t]=i),i}addPass(t,i=0,s=!0){this.__passes[i]||(this.__passes[i]=[]);let e=0;for(const t in this.__passes){if(t==i)break;e+=this.__passes[t].length}if(e+=this.__passes[i].length,t.updated.connect(this.requestRedraw.bind(this)),t.init(this,e),this.__passes[i].push(t),s){let t=0;for(const i in this.__passes){const s=this.__passes[i];s.forEach((i,s)=>{i.setPassIndex(t+s)}),t+=s.length}}return this.requestRedraw(),e}registerPass(t,i){this.__passCallbacks.splice(0,0,{itemAddedFn:t,itemRemovedFn:i})}getPass(t){let i=0;for(const s in this.__passes){const e=this.__passes[s];if(t-i<e.length)return e[t-i];i+=e.length}}findPass(t){for(const i in this.__passes){const s=this.__passes[i];for(const i of s)if(i.constructor==t)return i}}getGizmoPass(){return this.__gizmoPass}supportsVR(){return console.warn("Deprecated Method. Please instead connect to the vrViewportSetup signal."),this.__supportXR&&null!=navigator.xr}__setupXRViewport(){const t=new pe(this);return t.presentingChanged.connect(i=>{if(this.__xrViewportPresenting=i,i){for(const t in this.__passes){const i=this.__passes[t];for(const t of i)t.startPresenting()}t.viewChanged.connect(this.viewChanged.emit)}else{t.viewChanged.disconnect(this.viewChanged.emit);for(const t in this.__passes){const i=this.__passes[t];for(const t of i)t.stopPresenting()}this.viewChanged.emit({interfaceType:"CameraAndPointer",viewXfo:this.getViewport().getCamera().getGlobalXfo()}),this.resizeFbos(this.__glcanvas.width,this.__glcanvas.height),this.requestRedraw()}}),t}getVRViewport(){return this.__xrViewport}getXRViewport(){return this.__xrViewportPromise}isXRViewportPresenting(){return this.__xrViewportPresenting}isContinuouslyDrawing(){return this.__continuousDrawing}startContinuousDrawing(){if(this.isContinuouslyDrawing()||this.__xrViewportPresenting)return;const t=()=>{this.__continuousDrawing&&!this.__xrViewportPresenting&&window.requestAnimationFrame(t);for(const t of this.__viewports)t.draw()};this.__continuousDrawing=!0,window.requestAnimationFrame(t)}stopContinuousDrawing(){this.__continuousDrawing=!1}toggleContinuousDrawing(){this.__continuousDrawing?this.stopContinuousDrawing():this.startContinuousDrawing()}drawItemChanged(){for(const t of this.__viewports)t.invalidateGeomDataBuffer();this.requestRedraw()}requestRedraw(){return!(this.__redrawRequested||this.__continuousDrawing||this.__xrViewportPresenting||(window.requestAnimationFrame(()=>{this.__redrawRequested=!1;for(const t of this.__viewports)t.draw()}),this.__redrawRequested=!0,0))}bindGLBaseRenderer(t){t.shaderopts=this.__preproc;const i=this.__gl;t.viewports&&1!=t.viewports.length?(t.bindRendererUnifs=s=>{const{cameraMatrix:e}=s;e&&i.uniformMatrix4fv(e.location,!1,t.cameraMatrix.asArray())},t.bindViewports=(s,e)=>{t.viewports.forEach((t,n)=>{i.viewport(...t.region);const{viewMatrix:l,projectionMatrix:h,eye:o}=s;l&&i.uniformMatrix4fv(l.location,!1,t.viewMatrix.asArray()),h&&i.uniformMatrix4fv(h.location,!1,t.projectionMatrix.asArray()),o&&i.uniform1i(o.location,n),e()})}):(t.bindRendererUnifs=s=>{const{cameraMatrix:e,viewMatrix:n,projectionMatrix:l,eye:h}=s;e&&i.uniformMatrix4fv(e.location,!1,t.cameraMatrix.asArray());const o=t.viewports[0];n&&i.uniformMatrix4fv(n.location,!1,o.viewMatrix.asArray()),l&&i.uniformMatrix4fv(l.location,!1,o.projectionMatrix.asArray()),h&&i.uniform1i(h.location,index)},t.bindViewports=(t,i)=>i())}drawScene(t){for(const i in this.__passes){const s=this.__passes[i];for(const i of s)i.enabled&&i.draw(t)}}drawHighlightedGeoms(t){this.bindGLBaseRenderer(t);for(const i in this.__passes){const s=this.__passes[i];for(const i of s)i.enabled&&i.drawHighlightedGeoms(t)}}drawSceneGeomData(t,i=255){this.bindGLBaseRenderer(t);for(const s in this.__passes){if(0==(Number.parseInt(s)&i))continue;const e=this.__passes[s];for(const i of e)i.enabled&&i.drawGeomData(t)}}static registerPass(t,i){fe[i]||(fe[i]=[]),fe[i].push(t)}}{constructor(t,i={}){super(t,i,{antialias:!0,depth:!0}),this.__exposure=1,this.__tonemap=!0,this.__gamma=2.2,this.__glEnvMap=void 0,this.__glBackgroundMap=void 0,this.envMapAssigned=new v(!0),this.__glLightmaps={},this.__displayEnvironment=!0,this.__debugMode=0,this.__debugLightmaps=!1,this._planeDist=0,this.__cutPlaneNormal=new u(1,0,0);const s=this.__gl;this.__debugTextures=[void 0],this.addShaderPreprocessorDirective("ENABLE_INLINE_GAMMACORRECTION"),i.disableLightmaps||this.addShaderPreprocessorDirective("ENABLE_LIGHTMAPS"),i.disableTextures||this.addShaderPreprocessorDirective("ENABLE_TEXTURES"),e.isMobileDevice||i.disableSpecular||this.addShaderPreprocessorDirective("ENABLE_SPECULAR"),this.__outlineShader=new Re(s),this.quad=new Ys(s,new Hi(1,1)),this.createSelectedGeomsFbo(),this.createRayCastRenderTarget()}__bindEnvMap(t){if(t instanceof di)this.__glEnvMap=t.getMetadata("gltexture"),this.__glEnvMap||("FLOAT"===t.type?(this.addShaderPreprocessorDirective("ENABLE_SPECULAR"),this.__glEnvMap=new ce(this,t,this.__preproc)):this.__glEnvMap=t.isStreamAtlas()?new GLImageStream(this.__gl,t):new Is(this.__gl,t)),this.__glEnvMap.loaded.connect(this.requestRedraw),this.__glEnvMap.updated.connect(this.requestRedraw),this.envMapAssigned.emit(this.__glEnvMap);else{const i=t;if(this.__glBackgroundMap=i.getMetadata("gltexture"),this.__glBackgroundMap||(this.__glBackgroundMap="FLOAT"===i.type?new Js(gl,i):new Is(gl,i)),this.__glBackgroundMap.loaded.connect(this.requestRedraw),this.__glBackgroundMap.updated.connect(this.requestRedraw),!this.__backgroundMapShader){switch(gl.__quadVertexIdsBuffer||gl.setupInstancedQuad(),i.getMapping()){case"octahedral":this.__backgroundMapShader=new ne(gl);break;case"latlong":this.__backgroundMapShader=new le(gl);break;case"steriolatlong":this.__backgroundMapShader=new he(gl);break;case"dualfisheye":this.__backgroundMapShader=new ae(gl);break;case"uv":default:this.__backgroundMapShader=new ee(gl)}const t=this.__backgroundMapShader.compileForTarget();this.__backgroundMapShaderBinding=xs(gl,t.attrs,gl.__quadattrbuffers,gl.__quadIndexBuffer)}}}getGLEnvMap(){return this.__glEnvMap}getEnvMapTex(){return console.warn("Deprecated Function"),this.__glEnvMap}setScene(t){const i=t.settings.getParameter("EnvMap");null!=i.getValue()&&this.__bindEnvMap(i.getValue()),i.valueChanged.connect(()=>{this.__bindEnvMap(i.getValue())});const s=t.settings.getParameter("Display EnvMap");this.__displayEnvironment=s.getValue(),s.valueChanged.connect(()=>{this.__displayEnvironment=s.getValue(),this.requestRedraw()}),super.setScene(t)}addTreeItem(t){if(super.addTreeItem(t),t instanceof hs){const i=(t,i)=>{let s=i.image.getMetadata("gltexture");s||(s=new Js(this.__gl,i.image)),s.updated.connect(()=>{this.requestRedraw()}),this.__glLightmaps[t]={atlasSize:i.atlasSize,glimage:s}},s=t;s.loaded.connect(()=>{this.__glEnvMap&&s.getLightmap()&&i(s.getName(),s.getLightmap())})}}removeTreeItem(t){super.removeTreeItem(t)}addViewport(t){return super.addViewport(t)}onKeyPressed(t,i){switch(t){case"b":this.__displayEnvironment=!this.__displayEnvironment,this.requestRedraw();break;default:super.onKeyPressed(t,i)}}get exposure(){return this.__exposure}set exposure(t){this.__exposure=t,this.requestRedraw()}get gamma(){return this.__gamma}set gamma(t){this.__gamma=t,this.requestRedraw()}get displayEnvironment(){return this.__displayEnvironment}set displayEnvironment(t){this.__displayEnvironment=t,this.requestRedraw()}get planeDist(){return this._planeDist}set planeDist(t){this._planeDist=t,this.requestRedraw()}get cutPlaneNormal(){return this.__cutPlaneNormal}set cutPlaneNormal(t){this.__cutPlaneNormal=t,this.requestRedraw()}resizeFbos(t,i){super.resizeFbos(),this.__fbo&&this.__fbo.colorTexture.resize(t,i),this.__highlightedGeomsBufferFbo&&this.__highlightedGeomsBuffer.resize(t,i)}createSelectedGeomsFbo(){const t=this.__gl;this.__highlightedGeomsBuffer=new Is(t,{type:"UNSIGNED_BYTE",format:"RGBA",filter:"NEAREST",width:this.__glcanvas.width<=1?1:this.__glcanvas.width,height:this.__glcanvas.height<=1?1:this.__glcanvas.height}),this.__highlightedGeomsBufferFbo=new Ts(t,this.__highlightedGeomsBuffer,!0),this.__highlightedGeomsBufferFbo.setClearColor([0,0,0,0])}getFbo(){return this.__fbo}createOffscreenFbo(t="RGB"){const i=this.__gl;this.__fwBuffer=new Is(i,{type:"FLOAT",format:t,filter:"NEAREST",width:this.__glcanvas.width,height:this.__glcanvas.height}),this.__fbo=new Ts(i,this.__fwBuffer,!0),this.__fbo.setClearColor(this.__backgroundColor.asArray())}createRayCastRenderTarget(){this.__rayCastRenderTarget=new js(this.__gl,{type:"FLOAT",format:"RGBA",filter:"NEAREST",width:3,height:3,numColorChannels:1}),this.__rayCastRenderTargetProjMatrix=new y,this.rayCastDist=0,this.rayCastArea=0}raycastWithRay(t,i,s=.01,e=We){const n=new g;return n.setLookAt(t.start,t.start.add(t.dir)),this.raycast(n,t,i,s,e)}raycastWithXfo(t,i,s=.01,e=We){const n=new V(t.tr,t.ori.getZaxis().negate());return this.raycast(t,n,i,s,e)}raycast(t,i,s,e=.01,n=We){this.rayCastDist==s&&this.rayCastArea==e||(this.__rayCastRenderTargetProjMatrix.setOrthographicMatrix(-.5*e,.5*e,-.5*e,.5*e,0,s),this.rayCastDist=s,this.rayCastArea=e);const l=this.__gl,h={cameraMatrix:t.toMat4(),viewports:[{region:[0,0,3,3],viewMatrix:t.inverse().toMat4(),projectionMatrix:this.__rayCastRenderTargetProjMatrix,isOrthographic:!0}]};this.__rayCastRenderTarget.bindForWriting(h,!0),l.enable(l.CULL_FACE),l.enable(l.DEPTH_TEST),l.depthFunc(l.LEQUAL),l.depthMask(!0),this.drawSceneGeomData(h,n),l.finish(),this.__rayCastRenderTarget.unbindForWriting(),this.__rayCastRenderTarget.bindForReading();const o=new Float32Array(36);l.readPixels(0,0,3,3,l.RGBA,l.FLOAT,o),this.__rayCastRenderTarget.unbindForReading();const a=[4,3,5,1,7];let c;for(const t of a)if(0!=o[4*t+3]){c=o.subarray(4*t,4*t+4);break}if(!c)return;const r=63&Math.round(c[0]),d=this.getPass(r).getGeomItemAndDist(c);if(d){const t=i.start.add(i.dir.scale(d.dist));return{ray:i,intersectionPos:t,geomItem:d.geomItem,dist:d.dist,geomData:c}}}drawBackground(t){if(this.__glBackgroundMap){if(!this.__glBackgroundMap.isLoaded())return;const i=this.__gl;i.depthMask(!1),this.__backgroundMapShader.bind(t),this.__glBackgroundMap.bindToUniform(t,t.unifs.backgroundImage),this.__backgroundMapShaderBinding.bind(t),i.drawQuad()}else this.__glEnvMap&&this.__glEnvMap.draw&&this.__glEnvMap.draw(t)}bindGLRenderer(t){super.bindGLBaseRenderer(t),t.envMap=this.__glEnvMap,t.exposure=this.__exposure,t.gamma=this.__gamma,t.lightmaps=this.__glLightmaps,t.boundLightmap=void 0;const i=this.__gl,s=t.bindRendererUnifs;t.bindRendererUnifs=e=>{if(s(e),this.__glEnvMap){const i=e.envMapPyramid;if(i&&this.__glEnvMap.bindProbeToUniform)this.__glEnvMap.bindProbeToUniform(t,i);else{const{envMapTex:i,envMapTexType:s}=e;i&&this.__glEnvMap.bindToUniform(t,i,{textureTypeUnif:s})}}{const t=e.exposure;t&&i.uniform1f(t.location,this.__exposure)}{const t=e.gamma;t&&i.uniform1f(t.location,this.__gamma)}}}drawScene(t){if(this.bindGLRenderer(t),this.__displayEnvironment&&this.drawBackground(t),super.drawScene(t),this.__highlightedGeomsBufferFbo){const i=this.__gl;this.__highlightedGeomsBufferFbo.bindForWriting(t),this.__highlightedGeomsBufferFbo.clear(),i.disable(i.BLEND),i.enable(i.DEPTH_TEST),i.depthFunc(i.LESS),i.depthMask(!0),this.drawHighlightedGeoms(t),this.__highlightedGeomsBufferFbo.unbindForWriting(t),i.viewport(...t.region),this.__outlineShader.bind(t),i.enable(i.BLEND),i.blendEquation(i.FUNC_ADD),i.blendFunc(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA);const s=t.unifs;this.__highlightedGeomsBuffer.bindToUniform(t,s.highlightDataTexture),i.uniform2f(s.highlightDataTextureSize.location,t.region[2],t.region[3]),this.quad.bindAndDraw(t),i.disable(i.BLEND)}this.redrawOccured.emit()}}ws.setShaderModule("drawItemId.glsl","\n\n#ifdef ENABLE_FLOAT_TEXTURES\n\nattribute float instancedIds;    // instanced attribute..\nuniform int instancedDraw;\nuniform int transformIndex;\n\nint getDrawItemId() {\n    if(instancedDraw == 0){\n       return transformIndex;\n    }\n    else{\n       return int(instancedIds);\n    }\n}\n\n\n#else\n\nuniform int transformIndex;\n\nint getDrawItemId() {\n    return transformIndex;\n}\n\n#endif\n\n"),ws.setShaderModule("drawItemTexture.glsl",'\n\n#ifdef ENABLE_FLOAT_TEXTURES\n\nuniform sampler2D instancesTexture;\nuniform highp int instancesTextureSize;\n\n<%include file="GLSLUtils.glsl"/>\n\nconst int pixelsPerItem = 6;\n\nvec4 getInstanceData(int id) {\n    return fetchTexel(instancesTexture, instancesTextureSize, (id * pixelsPerItem) + 0);\n}\n\n#else\n\nuniform vec4 drawItemData;\n\nvec4 getInstanceData(int id) {\n    return drawItemData;\n}\n\n#endif\n\n\n'),ws.setShaderModule("modelMatrix.glsl","\n\n#ifdef ENABLE_FLOAT_TEXTURES\n\nmat4 getMatrix(sampler2D texture, int textureSize, int index) {\n    // Unpack 3 x 4 matix columns into a 4 x 4 matrix.\n    vec4 col0 = fetchTexel(texture, textureSize, (index * pixelsPerItem) + 1);\n    vec4 col1 = fetchTexel(texture, textureSize, (index * pixelsPerItem) + 2);\n    vec4 col2 = fetchTexel(texture, textureSize, (index * pixelsPerItem) + 3);\n    mat4 result = mat4(col0, col1, col2, vec4(0.0, 0.0, 0.0, 1.0));\n    return transpose(result);\n    // return mat4(1.0);\n}\n\nmat4 getModelMatrix(int id) {\n    return getMatrix(instancesTexture, instancesTextureSize, id);\n}\n\n#else\n\nuniform mat4 modelMatrix;\n\nmat4 getModelMatrix(int id) {\n    return modelMatrix;\n}\n\n#endif\n\n\n"),ws.setShaderModule("materialparams.glsl","\n\n////////////////////////\n// Material Param Helpers.\n\nvec4 getColorParamValue(vec4 value, sampler2D tex, int texType, vec2 texCoord) {\n    if(texType == 0){\n        return toLinear(value);\n    }\n    else if(texType == 1 || texType == 2){\n        // TODO: Use SRGB textures.\n        return toLinear(texture2D(tex, texCoord));\n    }\n    else if(texType == 3){\n        // Float HDR Texture\n        return texture2D(tex, texCoord);\n    }\n    else\n        return value;\n}\n\n\n\nfloat luminanceFromRGB(vec3 rgb) {\n    return 0.2126*rgb.r + 0.7152*rgb.g + 0.0722*rgb.b;\n}\n\nfloat getLuminanceParamValue(float value, sampler2D tex, int texType, vec2 texCoord) {\n    if(texType == 0)\n        return value;\n    else\n        return luminanceFromRGB(texture2D(tex, texCoord).rgb);\n}\n"),ws.setShaderModule("debugColors.glsl","\n\nfloat modI(float a, float b) {\n    float m=a-floor((a+0.5)/b)*b;\n    return floor(m+0.5);\n}\n\nvec3 getDebugColor(float id) {\n#ifdef GLSL_ES3\n    const vec3 clusterColors[4] = vec3[4]( vec3(0.0, 0.25, 0.25), vec3(0.0, 0.85, 0.25), vec3(0.0, 0.25, 0.85), vec3(0.0, 0.85, 0.85) );\n#else\n    vec3 clusterColors[8];\n    clusterColors[0] = vec3(0.0, 0.15, 0.15);\n    clusterColors[1] = vec3(0.0, 0.85, 0.15);\n    clusterColors[2] = vec3(0.0, 0.15, 0.85);\n    clusterColors[3] = vec3(0.0, 0.85, 0.85);\n    clusterColors[4] = vec3(0.75, 0.15, 0.15);\n    clusterColors[5] = vec3(0.75, 0.85, 0.15);\n    clusterColors[6] = vec3(0.75, 0.15, 0.85);\n    clusterColors[7] = vec3(0.75, 0.85, 0.85);\n#endif\n\n    if(modI(id, 8.0) == 0.0)\n        return clusterColors[0];\n    else if(modI(id, 8.0) == 1.0)\n        return clusterColors[1];\n    else if(modI(id, 8.0) == 2.0)\n        return clusterColors[2];\n    else if(modI(id, 8.0) == 3.0)\n        return clusterColors[3];\n    else if(modI(id, 8.0) == 4.0)\n        return clusterColors[4];\n    else if(modI(id, 8.0) == 5.0)\n        return clusterColors[5];\n    else if(modI(id, 8.0) == 6.0)\n        return clusterColors[6];\n    else if(modI(id, 8.0) == 7.0)\n        return clusterColors[7];\n\n    return vec3(1,0,0);\n}\n\n\n");class Se extends Fs{constructor(t){super(t),this.__shaderStages.VERTEX_SHADER=ws.parseShader("BillboardShader.vertexShader",'\nprecision highp float;\n\n\n<%include file="utils/quadVertexFromID.glsl"/>\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\nuniform mat4 cameraMatrix;\n\n#ifdef ENABLE_FLOAT_TEXTURES\n\ninstancedattribute float instanceIds;\n\n<%include file="GLSLUtils.glsl"/>\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="utils/imageAtlas.glsl"/>\n\nuniform sampler2D atlasBillboards_layout;\nuniform vec4 atlasBillboards_desc;\n\nuniform sampler2D instancesTexture;\nuniform int instancesTextureSize;\n\n\nconst int cols_per_instance = 5;\n\nmat4 getMatrix(sampler2D texture, int textureSize, int index) {\n  // Unpack 3 x 4 matix columns into a 4 x 4 matrix.\n  vec4 col0 = fetchTexel(texture, textureSize, (index * cols_per_instance) + 0);\n  vec4 col1 = fetchTexel(texture, textureSize, (index * cols_per_instance) + 1);\n  vec4 col2 = fetchTexel(texture, textureSize, (index * cols_per_instance) + 2);\n  mat4 result = mat4(col0, col1, col2, vec4(0.0, 0.0, 0.0, 1.0));\n  return transpose(result);\n  // return mat4(1.0);\n}\n\nmat4 getModelMatrix(int id) {\n  return getMatrix(instancesTexture, instancesTextureSize, id);\n}\nvec4 getInstanceData(int id) {\n  return fetchTexel(instancesTexture, instancesTextureSize, (id * cols_per_instance) + 3);\n}\nvec4 getTintColor(int id) {\n  return fetchTexel(instancesTexture, instancesTextureSize, (id * cols_per_instance) + 4);\n}\n\n\n#else\n\nuniform vec4 atlasBillboards_desc;\n\nuniform mat4 modelMatrix;\nuniform vec4 billboardData;\nuniform vec4 tintColor;\nuniform vec4 layoutData;\n\n\n#endif\n\nmat4 calcLookAtMatrix(vec3 origin, vec3 target, float roll) {\n  // vec3 rr = vec3(sin(roll), 0.0, cos(roll));\n  vec3 rr = vec3(0.0, 0.0, 1.0);\n  vec3 ww = normalize(target - origin);\n  vec3 uu = normalize(cross(rr, ww));\n  vec3 vv = normalize(cross(ww, uu));\n\n  return mat4(vec4(uu, 0.0), vec4(vv, 0.0), vec4(ww, 0.0), vec4(origin, 1.0));\n}\n\nfloat map(float value, float inMin, float inMax, float outMin, float outMax) {\n  return outMin + (outMax - outMin) * (value - inMin) / (inMax - inMin);\n}\n\n/* VS Outputs */\nvarying vec2 v_texCoord;\nvarying float v_alpha;\nvarying vec4 v_tint;\n\nvoid main(void) {\n\n#ifdef ENABLE_FLOAT_TEXTURES\n\n  int instanceID = int(instanceIds);\n\n  mat4 modelMatrix = getModelMatrix(instanceID);\n  vec4 billboardData = getInstanceData(instanceID);\n  vec4 layoutData = fetchTexel(atlasBillboards_layout, int(atlasBillboards_desc.z), int(billboardData.z));\n  v_tint = getTintColor(instanceID);\n\n#else\n\n  v_tint = tintColor;\n\n#endif\n\n  vec2 quadVertex = getQuadVertexPositionFromID();\n\n\n  v_texCoord = vec2(quadVertex.x, -quadVertex.y) + 0.5;\n  v_alpha = billboardData.w;\n  v_texCoord *= layoutData.zw;\n  v_texCoord += layoutData.xy;\n\n  float scl = billboardData.x;\n  float width = layoutData.z * atlasBillboards_desc.x * scl * 0.002;\n  float height = layoutData.w * atlasBillboards_desc.y * scl * 0.002;\n  int flags = int(billboardData.y);\n  bool alignedToCamera = flags > 0;\n  if(alignedToCamera){\n    vec3 cameraPos = vec3(cameraMatrix[3][0], cameraMatrix[3][1], cameraMatrix[3][2]);\n    vec3 billboardPos = vec3(modelMatrix[3][0], modelMatrix[3][1], modelMatrix[3][2]);\n    mat4 lookAt = calcLookAtMatrix(billboardPos, cameraPos, 0.0);\n    mat4 modelViewProjectionMatrix = projectionMatrix * viewMatrix * lookAt;\n    gl_Position = modelViewProjectionMatrix * vec4(quadVertex.x * width, (quadVertex.y + 0.5) * height, 0.0, 1.0);\n  }\n  else{\n    mat4 modelViewProjectionMatrix = projectionMatrix * viewMatrix * modelMatrix;\n    gl_Position = modelViewProjectionMatrix * vec4(quadVertex.x * width, (quadVertex.y + 0.5) * height, 0.0, 1.0);\n  }\n\n  bool overlay = flags > 0;\n  if(overlay){\n    gl_Position.z -= 0.05;\n  }\n}\n'),this.__shaderStages.FRAGMENT_SHADER=ws.parseShader("BillboardShader.fragmentShader",'\nprecision highp float;\n\n<%include file="stack-gl/gamma.glsl"/>\n<%include file="GLSLUtils.glsl"/>\n<%include file="materialparams.glsl"/>\n<%include file="utils/imageAtlas.glsl"/>\n\nuniform sampler2D atlasBillboards;\n\n/* VS Outputs */\nvarying vec2 v_texCoord;\nvarying float v_alpha;\nvarying vec4 v_tint;\n\n\n#ifdef ENABLE_ES3\n  out vec4 fragColor;\n#endif\nvoid main(void) {\n#ifndef ENABLE_ES3\n  vec4 fragColor;\n#endif\n\n  fragColor = texture2D(atlasBillboards, v_texCoord) * v_tint;\n  fragColor.a *= v_alpha;\n\n  // fragColor.r = 1.0;\n  // fragColor.a = 1.0;\n  \n#ifndef ENABLE_ES3\n  gl_FragColor = fragColor;\n#endif\n}\n')}}class Le extends Fs{constructor(t){super(t),this.__shaderStages.VERTEX_SHADER=ws.parseShader("DepthMapShader.vertexShader","\nprecision highp float;\n\nattribute vec3 positions;    //(location = 0)\n\nuniform mat4 modelMatrix;\nuniform mat4 lightViewMatrix;\nuniform mat4 lightProjectionMatrix;\n\n/* VS Outputs */\nvarying vec3 v_viewPos;\n\nvoid main(void) {\n  mat4 modelViewMatrix = lightViewMatrix * modelMatrix;\n  v_viewPos = modelViewMatrix * vec4(positions, 1.0);\n  gl_Position = lightProjectionMatrix * v_viewPos;\n}\n\n"),this.__shaderStages.FRAGMENT_SHADER=ws.parseShader("DepthMapShader.fragmentShader","\n#extension GL_OES_standard_derivatives : enable\nprecision highp float;\n\nuniform float near;\nuniform float far;\n\nvarying vec3 v_viewPos;\n\nfloat linstep(float edge0, float edge1, float value){\n  return clamp((value-edge0)/(edge1-edge0), 0.0, 1.0);\n}\n\nvoid main(void) {\n  float depth = linstep(near, far, -v_viewPos.z);\n  //gl_FragColor = vec4(depth, depth, depth,  1.0);\n\n  float dx = dFdx(depth);\n  float dy = dFdy(depth);\n  gl_FragColor = vec4(depth, pow(depth, 2.0) + 0.25*(dx*dx + dy*dy), 0.0, 1.0);\n}\n")}}class xe extends Fs{constructor(t){super(t),this.__shaderStages.VERTEX_SHADER=ws.parseShader("EnvProjectionShader.vertexShader",'\nprecision highp float;\n\nattribute vec3 positions;    //(location = 0)\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\nuniform vec3 projectionCenter;\n\n<%include file="stack-gl/inverse.glsl"/>\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n\n/* VS Outputs */\nvarying vec3 v_worldDir;\n \nvoid main()\n{\n  int drawItemId = getDrawItemId();\n  vec4 pos = vec4(positions, 1.);\n  mat4 modelMatrix = getModelMatrix(drawItemId);\n  mat4 modelViewProjectionMatrix = projectionMatrix * viewMatrix * modelMatrix;\n\n  gl_Position = modelViewProjectionMatrix * pos;\n\n  vec4 worldPos = modelMatrix * pos;\n  v_worldDir = worldPos.xyz - projectionCenter;\n}\n\n'),this.finalize()}static getParamDeclarations(){const t=super.getParamDeclarations();return t.push({name:"projectionCenter",defaultValue:new u(0,0,1.7)}),t}}class ve extends xe{constructor(t){super(t),this.__shaderStages.FRAGMENT_SHADER=ws.parseShader("OctahedralEnvProjectionShader.fragmentShader",'\nprecision highp float;\n\n<%include file="math/constants.glsl"/>\n<%include file="GLSLUtils.glsl"/>\n<%include file="pragmatic-pbr/envmap-octahedral.glsl"/>\n<%include file="stack-gl/gamma.glsl"/>\n<%include file="materialparams.glsl"/>\n\n\nuniform color envMap;\nuniform sampler2D envMapTex;\nuniform int envMapTexType;\n\n\nuniform float exposure;\n\n/* VS Outputs */\nvarying vec3 v_worldDir;\n\n#ifdef ENABLE_ES3\n  out vec4 fragColor;\n#endif\nvoid main(void) {\n#ifndef ENABLE_ES3\n  vec4 fragColor;\n#endif\n\n  vec2 texCoord = dirToSphOctUv(normalize(v_worldDir));\n  vec4 env = getColorParamValue(envMap, envMapTex, envMapTexType, texCoord);\n\n  fragColor = vec4(env.rgb/env.a, 1.0);\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n  fragColor.rgb = toGamma(fragColor.rgb * exposure);\n#endif\n\n#ifndef ENABLE_ES3\n  gl_FragColor = fragColor;\n#endif\n}\n'),this.finalize()}}N.registerClass("OctahedralEnvProjectionShader",ve);class Ye extends xe{constructor(t){super(t),this.__shaderStages.FRAGMENT_SHADER=ws.parseShader("LatLongEnvProjectionShader.fragmentShader",'\nprecision highp float;\n\n<%include file="math/constants.glsl"/>\n<%include file="GLSLUtils.glsl"/>\n<%include file="pragmatic-pbr/envmap-equirect.glsl"/>\n<%include file="stack-gl/gamma.glsl"/>\n<%include file="materialparams.glsl"/>\n\nuniform color envMap;\nuniform sampler2D envMapTex;\nuniform int envMapTexType;\n\nuniform float exposure;\n\n/* VS Outputs */\nvarying vec3 v_worldDir;\n\n#ifdef ENABLE_ES3\n  out vec4 fragColor;\n#endif\nvoid main(void) {\n#ifndef ENABLE_ES3\n  vec4 fragColor;\n#endif\n\n  vec2 texCoord = latLongUVsFromDir(normalize(v_worldDir));\n  vec4 env = getColorParamValue(envMap, envMapTex, envMapTexType, texCoord);\n  fragColor = vec4(env.rgb/env.a, 1.0);\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n  fragColor.rgb = toGamma(fragColor.rgb * exposure);\n#endif\n\n\n#ifndef ENABLE_ES3\n  gl_FragColor = fragColor;\n#endif\n}\n'),this.finalize()}}N.registerClass("LatLongEnvProjectionShader",Ye);class Me extends Fs{constructor(t){super(t),this.__shaderStages.VERTEX_SHADER=ws.parseShader("FatLinesShader.vertexShader",'\nprecision highp float;\n\ninstancedattribute vec2 segmentIndices;\nattribute float vertexIDs;\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\n\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="drawItemId.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n\nuniform sampler2D positionsTexture;\nuniform int positionsTextureSize;\n\nuniform float LineThickness;\n\n/* VS Outputs */\nvarying vec3 v_viewPos;\nvarying vec3 v_viewNormal;\nvarying vec2 v_texCoord;\n\nvoid main(void) {\n  int drawItemId = getDrawItemId();\n  int vertexID = int(vertexIDs);\n\n  mat4 modelMatrix = getModelMatrix(drawItemId);\n  mat4 modelViewMatrix = viewMatrix * modelMatrix;\n\n  int seqentialIndex_0 = int(mod(segmentIndices.x, 2.));\n  int seqentialIndex_1 = int(mod(segmentIndices.y, 2.));\n  int index_0 = int(segmentIndices.x) / 2;\n  int index_1 = int(segmentIndices.y) / 2;\n\n  vec3 viewPos;\n  vec4 data_0 = fetchTexel(positionsTexture, positionsTextureSize, index_0);\n  vec4 data_1 = fetchTexel(positionsTexture, positionsTextureSize, index_1);\n\n  vec4 pos_0 = modelViewMatrix * vec4(data_0.xyz, 1.0);\n  vec4 pos_1 = modelViewMatrix * vec4(data_1.xyz, 1.0);\n  // Note: multiply the per-vertex line thickness with the line thickness uniform value;\n  float lineThickness_0 = LineThickness * data_0.w;\n  float lineThickness_1 = LineThickness * data_1.w;\n\n  if(vertexID < 2){\n    viewPos = pos_0.xyz;\n  }\n  else{\n    viewPos = pos_1.xyz;\n  }\n  if(pos_1 != pos_0){\n    vec3 segmentDir = normalize(pos_1.xyz - pos_0.xyz);\n    vec3 viewVector = normalize(viewPos);\n\n    if(vertexID < 2){\n      vec3 segmentStartDir = segmentDir;\n      if(seqentialIndex_0 != 0){\n        //if index_0 == 0, get the last index in the line as previous\n        int index_prev = (index_0 > 0) ? (index_0-1) : (positionsTextureSize-1);\n        vec4 data_prev = fetchTexel(positionsTexture, positionsTextureSize, index_prev);\n        vec4 pos_prev = modelViewMatrix * vec4(data_prev.xyz, 1.0);\n        segmentStartDir = normalize(segmentDir + normalize(pos_0.xyz - pos_prev.xyz));\n      }\n      vec3 startBiTangent = normalize(cross(segmentStartDir, viewVector));\n      v_viewNormal = normalize(cross(segmentStartDir, startBiTangent));\n      // Move the endpoints to overlap a bit more.\n      //viewPos -= vec3(segmentStartDir * lineThickness_0 * 0.25);\n      if(mod(vertexIDs, 2.0) == 0.0){\n        viewPos += vec3(startBiTangent * lineThickness_0);\n        v_texCoord.x = 1.0;\n      }\n      else{\n        viewPos -= vec3(startBiTangent * lineThickness_0);\n        v_texCoord.x = 0.0;\n      }\n      v_texCoord.y = 0.0;\n    }\n    else{\n      vec3 segmentEndDir = segmentDir;\n      if(seqentialIndex_1 != 0){\n        //if index_1 == numPoints-1, get the first index in the line as next\n        int index_next = (index_1 < (positionsTextureSize-1)) ? (index_1+1) : 0;\n        vec4 data_next = fetchTexel(positionsTexture, positionsTextureSize, index_next);\n        vec4 pos_next = modelViewMatrix * vec4(data_next.xyz, 1.0);\n        segmentEndDir = normalize(segmentDir + normalize(pos_next.xyz - pos_1.xyz));\n      }\n      vec3 endBiTangent = normalize(cross(segmentEndDir, viewVector));\n      v_viewNormal = normalize(cross(segmentEndDir, endBiTangent));\n      // Move the endpoints to overlap a bit more.\n      //viewPos += vec3(segmentEndDir * lineThickness_1 * 0.25);\n      if(mod(vertexIDs, 2.0) == 0.0){\n        viewPos += vec3(endBiTangent * lineThickness_1);\n        v_texCoord.x = 1.0;\n      }\n      else{\n        viewPos -= vec3(endBiTangent * lineThickness_1);\n        v_texCoord.x = 0.0;\n      }\n      v_texCoord.y = 1.0;\n    }\n\n    // Move the line towards the viewer by the line thickness.\n    // this is to avoid depth issues when lines are rendered over meshes. \n    viewPos.z -= (lineThickness_0 + lineThickness_1) * 0.25;\n  }\n\n  v_viewPos       = viewPos;\n  gl_Position     = projectionMatrix * vec4(viewPos, 1.0);\n}\n'),this.__shaderStages.FRAGMENT_SHADER=ws.parseShader("FatLinesShader.fragmentShader","\nprecision highp float;\n\n/* VS Outputs */\nvarying vec3 v_viewPos;\nvarying vec3 v_viewNormal;\nvarying vec2 v_texCoord;\n\nuniform color BaseColor;\nuniform mat4 cameraMatrix;\n\n#ifdef ENABLE_ES3\n  out vec4 fragColor;\n#endif\nvoid main(void) {\n#ifndef ENABLE_ES3\n  vec4 fragColor;\n#endif\n\n  int debugLevel = 0;\n  if(debugLevel == 0){\n\n    vec3 viewVector = mat3(cameraMatrix) * normalize(-v_viewPos);\n    vec3 normal = mat3(cameraMatrix) * v_viewNormal;\n    float NdotV = dot(normalize(normal), normalize(viewVector));\n\n    // Modulate the lighting using the texture coord so the line looks round.\n    NdotV *= cos((v_texCoord.x - 0.5) * 2.0);\n\n    vec4 color = BaseColor * NdotV;\n    fragColor = vec4(color.rgb, BaseColor.a);\n  }\n  else{\n    fragColor = vec4(v_texCoord.x, 0.0, 0.0, 1.0);\n  }\n\n#ifndef ENABLE_ES3\n  gl_FragColor = fragColor;\n#endif\n}\n"),this.finalize()}bind(t){return!!super.bind(t)&&(t.supportsInstancing=!1,!0)}static getParamDeclarations(){const t=super.getParamDeclarations();return t.push({name:"BaseColor",defaultValue:new p(1,1,.5)}),t.push({name:"Opacity",defaultValue:1}),t}}N.registerClass("FatLinesShader",Me),ws.setShaderModule("stack-gl/gamma.glsl","\n\nconst float gamma_const = 2.2;\n\nfloat toLinear(float v) {\n  return pow(v, gamma_const);\n}\n\nvec2 toLinear(vec2 v) {\n  return pow(v, vec2(gamma_const));\n}\n\nvec3 toLinear(vec3 v) {\n  return pow(v, vec3(gamma_const));\n}\n\nvec4 toLinear(vec4 v) {\n  return vec4(toLinear(v.rgb), v.a);\n}\n\n\nfloat toGamma(float v) {\n  return pow(v, 1.0 / gamma_const);\n}\n\nvec2 toGamma(vec2 v) {\n  return pow(v, vec2(1.0 / gamma_const));\n}\n\nvec3 toGamma(vec3 v) {\n  return pow(v, vec3(1.0 / gamma_const));\n}\n\nvec4 toGamma(vec4 v) {\n  return vec4(toGamma(v.rgb), v.a);\n}\n\nfloat toGamma(float v, float gamma) {\n  return pow(v, 1.0 / gamma);\n}\n\nvec2 toGamma(vec2 v, float gamma) {\n  return pow(v, vec2(1.0 / gamma));\n}\n\nvec3 toGamma(vec3 v, float gamma) {\n  return pow(v, vec3(1.0 / gamma));\n}\n\nvec4 toGamma(vec4 v, float gamma) {\n  return vec4(toGamma(v.rgb, gamma), v.a);\n}\n\n\n");class Ke extends Fs{constructor(t){super(t),this.__shaderStages.VERTEX_SHADER=ws.parseShader("FlatSurfaceShader.vertexShader",'\nprecision highp float;\n\nattribute vec3 positions;\n#ifdef ENABLE_TEXTURES\nattribute vec2 texCoords;\n#endif\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\n\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="drawItemId.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n\n/* VS Outputs */\nvarying vec3 v_viewPos;\n#ifdef ENABLE_TEXTURES\nvarying vec2 v_textureCoord;\n#endif\n\n\nvoid main(void) {\n  int drawItemId = getDrawItemId();\n    mat4 modelMatrix = getModelMatrix(drawItemId);\n    mat4 modelViewMatrix = viewMatrix * modelMatrix;\n\n    vec4 viewPos = (modelViewMatrix * vec4(positions, 1.0));\n    gl_Position = projectionMatrix * viewPos;\n\n    v_viewPos = viewPos.xyz;\n    v_textureCoord = texCoords;\n    v_textureCoord.y = 1.0 - v_textureCoord.y;// Flip y\n}\n'),this.__shaderStages.FRAGMENT_SHADER=ws.parseShader("FlatSurfaceShader.fragmentShader",'\nprecision highp float;\n\n<%include file="stack-gl/gamma.glsl"/>\n<%include file="materialparams.glsl"/>\n\nuniform color BaseColor;\n\n#ifdef ENABLE_TEXTURES\nuniform sampler2D BaseColorTex;\nuniform int BaseColorTexType;\n#endif\n\n/* VS Outputs */\nvarying vec3 v_viewPos;\n#ifdef ENABLE_TEXTURES\nvarying vec2 v_textureCoord;\n#endif\n\n\n#ifdef ENABLE_ES3\n    out vec4 fragColor;\n#endif\nvoid main(void) {\n\n#ifndef ENABLE_TEXTURES\n    vec4 baseColor = BaseColor;\n#else\n    vec4 baseColor      = getColorParamValue(BaseColor, BaseColorTex, BaseColorTexType, v_textureCoord);\n#endif\n\n#ifndef ENABLE_ES3\n    vec4 fragColor;\n#endif\n    fragColor = baseColor;\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n    fragColor.rgb = toGamma(fragColor.rgb);\n#endif\n\n#ifndef ENABLE_ES3\n    gl_FragColor = fragColor;\n#endif\n}\n'),this.finalize()}static getParamDeclarations(){const t=super.getParamDeclarations();return t.push({name:"BaseColor",defaultValue:new p(1,1,.5)}),t}static getGeomDataShaderName(){return"StandardSurfaceGeomDataShader"}static getSelectedShaderName(){return"StandardSurfaceSelectedGeomsShader"}}N.registerClass("FlatSurfaceShader",Ke);class Ce extends Ke{static isTransparent(){return!0}bind(t,i){return"ADD"==t.pass&&super.bind(t,i)}}N.registerClass("FlatAlphaSurfaceShader",Ce),ws.setShaderModule("math/constants.glsl","\n\n#define PI 3.141592653589793\n#define TwoPI (2.0 * PI)\n#define HalfPI (0.5 * PI)\n\n"),ws.setShaderModule("GGX_Specular.glsl",'\n\n\n<%include file="pragmatic-pbr/envmap-octahedral.glsl"/>\n<%include file="utils/imagePyramid.glsl"/>\n\n// uniform ImageAtlas envMap;\n// see: GLImageAtlas.js: line 460.\nuniform sampler2D   envMapPyramid;\nuniform sampler2D   envMapPyramid_layout;\nuniform vec4        envMapPyramid_desc;\n\n\nvec3 sampleEnvMap(vec3 dir, float roughness) {\n    return sampleImagePyramid(dirToSphOctUv(dir), roughness, envMapPyramid_layout, envMapPyramid, envMapPyramid_desc).rgb;\n}\n\n\n// Borrowed heavily from here: http://www.codinglabs.net/article_physically_based_rendering_cook_torrance.aspx\n\nvec3 Fresnel_Schlick(float cosT, vec3 F0)\n{\n    return F0 + (vec3(1.0)-F0) * vec3(pow( 1.0 - cosT, 5.0));\n\n    // for now we calculate this in the suface shader\n    // float schlick = reflectance + pow((1.0-reflectance)*(1.0-dot(N,V)), 5.0);\n}\n\nfloat chiGGX(float v)\n{\n    return v > 0.0 ? 1.0 : 0.0;\n}\n\nfloat saturate(float v)\n{\n    return clamp(v, 0.0, 1.0);\n}\n\nvec3 saturate(vec3 v)\n{\n    return clamp(v, vec3(0.0), vec3(1.0));\n}\n\nfloat saturatedDot( in vec3 a, in vec3 b )\n{\n    return max( dot( a, b ), 0.0 );   \n}\n\nfloat GGX_PartialGeometryTerm(vec3 v, vec3 n, vec3 h, float alpha)\n{\n    float VoH2 = saturate(dot(v,h));\n    float chi = chiGGX( VoH2 / saturate(dot(v,n)) );\n    VoH2 = VoH2 * VoH2;\n    float tan2 = ( 1.0 - VoH2 ) / VoH2;\n    return (chi * 2.0) / ( 1.0 + sqrt( 1.0 + alpha * alpha * tan2 ) );\n}\n\nvec3 GGX_Specular_PrefilteredEnv(vec3 normal, vec3 viewVector, float roughness, float fresnel)\n{\n    vec3 reflectionVector = reflect(-viewVector, normal);\n    vec3 radiance = vec3(0.0);\n    float NoV = saturate(dot(normal, viewVector));\n\n    vec3 sampleVector = reflectionVector;\n\n    // Calculate the half vector\n    vec3 halfVector = normalize(sampleVector + viewVector);\n    float cosT = saturatedDot(reflectionVector, normal);\n    float sinT = sqrt( 1.0 - cosT * cosT);\n\n    // Calculate fresnel\n    // vec3 fresnel = Fresnel_Schlick( saturate(dot( halfVector, viewVector ) ), F0 );\n    // Geometry term\n    float geometry = GGX_PartialGeometryTerm(viewVector, normal, halfVector, clamp(roughness, 0.01, 1.0)) * GGX_PartialGeometryTerm(reflectionVector, normal, halfVector, clamp(roughness, 0.01, 1.0));\n\n    // Calculate the Cook-Torrance denominator\n    float denominator = clamp( 4.0 * (NoV * saturate(dot(halfVector, normal)) + 0.05), 0.0, 1.0 );\n    // kS += fresnel;\n\n    // Accumulate the radiance\n    vec3 envColor = sampleEnvMap(reflectionVector, roughness);\n    radiance += envColor * geometry * fresnel * sinT / denominator;\n    //radiance += envColor * fresnel; // Removing "geometry" for now until we construct a better geometric shading term\n\n    return radiance;        \n}\n'),ws.setShaderModule("PBRSurfaceRadiance.glsl","\n\nstruct MaterialParams {\n    vec3 baseColor;\n    float metallic;\n    float roughness;\n    float reflectance;\n};\n\nvec4 pbrSpecularReflectance(in MaterialParams materialParams, vec3 normal, in vec3 viewVector) {\n\n    float NdotV = dot(normal, viewVector);\n    \n    // -------------------------- Specular Reflectance --------------------------\n    // vec3 ks = vec3(0.0);\n    // vec3 specular = GGX_Specular_PrefilteredEnv(normal, viewVector, materialParams.roughness, F0, ks );\n    // vec3 kd = (vec3(1.0) - ks) * vec3(1.0 - metallic);    \n\n    float schlickFresnel = materialParams.reflectance + pow((1.0-materialParams.reflectance)*(1.0-NdotV), 5.0);\n\n    vec3 specularReflectance = GGX_Specular_PrefilteredEnv(normal, viewVector, materialParams.roughness, schlickFresnel);\n\n\n    // -------------------------- Specular Occlusion --------------------------\n    // Fast and quick way of reducing specular reflection in areas that are less exposed to the environment\n    // A better approch is to try screen space specular occlusion but need to check performance and feasibility in webGL\n    //float specularOcclusion = clamp(length(irradiance), 0.01, 1.0);    \n    //specularReflectance = (specularReflectance * specularOcclusion); \n\n    return vec4(specularReflectance, schlickFresnel);\n}\n\n\nvec3 pbrSurfaceRadiance(in MaterialParams materialParams, vec3 irradiance, vec3 normal, in vec3 viewVector) {\n\n    float NdotV = dot(normal, viewVector);\n    vec3 specularReflectance;\n\n    // -------------------------- Diffuse Reflectance --------------------------\n\n    vec3 diffuseReflectance = materialParams.baseColor * irradiance;\n\n    // From the Disney dielectric BRDF    \n    // Need to check if this is useful for us but the implementation works based on their paper\n    //diffuseReflectance = (diffuseReflectance / PI); // << [PT 18-08-2018] What did this line do??? (makes everything 3.1x darker.)\n    // diffuseReflectance = vec3(mix(diffuseReflectance, diffuseReflectance * mix(0.5, 2.5, materialParams.roughness), pow(1.0 - NdotV, 5.0)));\n    diffuseReflectance = vec3(mix(diffuseReflectance, diffuseReflectance * mix(0.5, 1.0, materialParams.roughness), pow(1.0 - NdotV, 5.0)));\n\n\n    // -------------------------- Color at normal incidence --------------------------\n    \n    // Need to use 'Reflectance' here instead of 'ior'\n    //vec3 F0 = vec3(abs((1.0 - ior) / (1.0 + ior)));    \n    //F0 = F0 * F0;\n    //F0 = mix(F0, materialParams.baseColor, materialParams.metallic);      \n\n\n    // -------------------------- Specular Reflectance --------------------------\n    // vec3 ks = vec3(0.0);\n    // vec3 specular = GGX_Specular_PrefilteredEnv(normal, viewVector, materialParams.roughness, F0, ks );\n    // vec3 kd = (vec3(1.0) - ks) * vec3(1.0 - metallic);    \n\n    float schlickFresnel = materialParams.reflectance + pow((1.0-materialParams.reflectance)*(1.0-NdotV), 5.0);\n\n    specularReflectance = GGX_Specular_PrefilteredEnv(normal, viewVector, materialParams.roughness, schlickFresnel);\n\n\n    // -------------------------- Specular Occlusion --------------------------\n    // Fast and quick way of reducing specular reflection in areas that are less exposed to the environment\n    // A better approch is to try screen space specular occlusion but need to check performance and feasibility in webGL\n    //float specularOcclusion = clamp(length(irradiance), 0.01, 1.0);    \n    //specularReflectance = (specularReflectance * specularOcclusion);  \n      \n\n    // -------------------------- Metallic --------------------------\n    // We need to do few things given a higher > 0 metallic value\n    //      1. tint specular reflectance by the albedo color (not at grazing angles)\n    //      2. almost elliminate all diffuse reflectance (in reality metals have some diffuse due to layering (i.e. dust, prints, etc.))\n    //      3. set \"specular\" artistic value to metallic range (0.6 - 0.85)\n\n    specularReflectance = mix(specularReflectance, specularReflectance * materialParams.baseColor, materialParams.metallic);\n    diffuseReflectance = mix(diffuseReflectance, vec3(0.0,0.0,0.0), materialParams.metallic); // Leaveing at pure black for now but always need some %3 diffuse left for imperfection of pulished pure metal\n    // Would be best to compute reflectace internally and set here to 0.6-0.85 for metals\n    \n\n    // -------------------------- Final color --------------------------\n    // Energy conservation already taken into account in both the diffuse and specular reflectance\n    vec3 radiance = diffuseReflectance + specularReflectance;\n\n    // radiance = vec4( kd * diffuse + /*ks */ specular, 1);\n    return radiance;\n}\n");class we extends Fs{constructor(t){super(t),this.__shaderStages.VERTEX_SHADER=ws.parseShader("LayeredCarPaintShader.vertexShader",'\nprecision highp float;\n\nattribute vec3 positions;\nattribute vec3 normals;\n#ifdef ENABLE_TEXTURES\nattribute vec2 texCoords;\n#endif\nattribute vec2 lightmapCoords;\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\n\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="stack-gl/inverse.glsl"/>\n<%include file="drawItemId.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n\nattribute float clusterIDs;\nuniform vec2 lightmapSize;\n\n/* VS Outputs */\nvarying vec4 v_geomItemData;\nvarying vec3 v_viewPos;\nvarying vec3 v_viewNormal;\n#ifdef ENABLE_TEXTURES\nvarying vec2 v_textureCoord;\n#endif\n// varying vec2 v_lightmapCoord;\n// #ifdef ENABLE_DEBUGGING_LIGHTMAPS\n// varying float v_clusterID;\n// #endif\nvarying vec3 v_worldPos;\n/* VS Outputs */\n\nvoid main(void) {\n    int drawItemId = getDrawItemId();\n\n    v_geomItemData = getInstanceData(drawItemId);\n\n    vec4 pos = vec4(positions, 1.);\n    mat4 modelMatrix = getModelMatrix(drawItemId);\n    mat4 modelViewMatrix = viewMatrix * modelMatrix;\n    vec4 viewPos    = modelViewMatrix * pos;\n    gl_Position     = projectionMatrix * viewPos;\n\n\n#ifdef ENABLE_TEXTURES\n    v_textureCoord  = texCoords;\n#endif\n    // v_lightmapCoord = (lightmapCoords + geomItemData.zw) / lightmapSize;\n\n    // mat4 mvp = projectionMatrix * viewMatrix * modelMatrix;\n    // gl_Position = mvp * vec4((lightmapCoords + geomItemData.xy), 0., 1.);\n// #ifdef ENABLE_DEBUGGING_LIGHTMAPS\n//     v_clusterID = clusterIDs;\n// #endif\n\n    v_worldPos      = (modelMatrix * pos).xyz;\n    mat3 normalMatrix = mat3(transpose(inverse(modelViewMatrix)));\n    v_viewPos       = -viewPos.xyz;\n    v_viewNormal    = normalMatrix * normals;\n}\n'),this.__shaderStages.FRAGMENT_SHADER=ws.parseShader("LayeredCarPaintShader.fragmentShader",'\n#ifndef ENABLE_ES3\n    #extension GL_OES_standard_derivatives : enable\n#endif\nprecision highp float;\n\n<%include file="math/constants.glsl"/>\n<%include file="GLSLUtils.glsl"/>\n<%include file="GGX_Specular.glsl"/>\n<%include file="PBRSurfaceRadiance.glsl"/>\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n<%include file="stack-gl/gamma.glsl"/>\n#endif\n<%include file="materialparams.glsl"/>\n\n/* VS Outputs */\nvarying vec4 v_geomItemData;\nvarying vec3 v_viewPos;\nvarying vec3 v_viewNormal;\n#ifdef ENABLE_TEXTURES\nvarying vec2 v_textureCoord;\n#endif\n// varying vec2 v_lightmapCoord;\n// #ifdef ENABLE_DEBUGGING_LIGHTMAPS\n// varying float v_clusterID;\n// #endif\nvarying vec3 v_worldPos;\n/* VS Outputs */\n\n\nuniform sampler2D lightmap;\nuniform vec2 lightmapSize;\n#ifdef ENABLE_DEBUGGING_LIGHTMAPS\n<%include file="debugColors.glsl"/>\nuniform bool debugLightmapTexelSize;\n#endif\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\nuniform float exposure;\n#endif\n\nuniform mat4 cameraMatrix;\n\nuniform color BaseColor;\nuniform color MidColorTint;\nuniform float MidColorTintReflectance;\n\nuniform float MicroflakePerturbation;\nuniform sampler2D FlakesNormalTex;\nuniform float FlakesScale;\n\n#ifdef ENABLE_SPECULAR\n\nuniform float BaseRoughness;\nuniform float BaseMetallic;\nuniform float BaseReflectance;\nuniform float GlossRoughness;\nuniform float GlossMetallic;\nuniform float GlossReflectance;\n\n#endif\n\n#ifdef ENABLE_TEXTURES\n\nuniform sampler2D BaseColorTex;\nuniform int BaseColorTexType;\n\n#endif\n\n// Followup: Normal Mapping Without Precomputed Tangents\n// http://www.thetenthplanet.de/archives/1180\nmat3 cotangent_frame( vec3 normal, vec3 position, vec2 uv )\n{\n    // get edge vectors of the pixel triangle\n    vec3 dp1 = dFdx( position );\n    vec3 dp2 = dFdy( position );\n    vec2 duv1 = dFdx( uv );\n    vec2 duv2 = dFdy( uv );\n \n    // solve the linear system\n    vec3 dp2perp = cross( dp2, normal );\n    vec3 dp1perp = cross( normal, dp1 );\n    vec3 tangent = dp2perp * duv1.x + dp1perp * duv2.x;\n    vec3 bitangent = dp2perp * duv1.y + dp1perp * duv2.y;\n \n    // construct a scale-invariant frame \n    float invmax = inversesqrt( max( dot(tangent,tangent), dot(bitangent,bitangent) ) );\n    return mat3( tangent * invmax, bitangent * invmax, normal );\n}\n\n#define WITH_NORMALMAP_UNSIGNED 1\n\nvec3 sampleNormalMap( sampler2D normalMap, vec2 texcoord )\n{\n    // assume normal, the interpolated vertex normal and \n    // viewVec, the view vector (vertex to eye)\n    vec3 map = texture2D( normalMap, texcoord ).xyz;\n#ifdef WITH_NORMALMAP_UNSIGNED\n    map = map * 255./127. - 128./127.;\n#endif\n#ifdef WITH_NORMALMAP_2CHANNEL\n    map.z = sqrt( 1. - dot( map.xy, map.xy ) );\n#endif\n#ifdef WITH_NORMALMAP_GREEN_UP\n    map.y = -map.y;\n#endif\n    return map;\n}\n\n\n#ifdef ENABLE_ES3\n    out vec4 fragColor;\n#endif\n\nvoid main(void) {\n\n    MaterialParams material;\n\n#ifndef ENABLE_TEXTURES\n    material.baseColor      = BaseColor.rgb;\n#else\n    vec2 texCoord           = vec2(v_textureCoord.x, 1.0 - v_textureCoord.y);\n    material.baseColor      = getColorParamValue(BaseColor, BaseColorTex, BaseColorTexType, texCoord).rgb;\n#endif\n\n#ifdef ENABLE_SPECULAR\n    material.roughness      = BaseRoughness;\n    material.metallic       = BaseMetallic;\n    material.reflectance    = BaseReflectance;\n#endif\n\n    vec3 irradiance = texture2D(lightmap, v_lightmapCoord).rgb;\n \n#ifdef ENABLE_DEBUGGING_LIGHTMAPS\n    if(debugLightmapTexelSize)\n    {\n        vec2 coord_texelSpace = (v_lightmapCoord * lightmapSize) - v_geomItemData.zw;\n        //vec2 coord_texelSpace = (v_textureCoord * lightmapSize);\n        float total = floor(coord_texelSpace.x) +\n                      floor(coord_texelSpace.y);\n                      \n        vec3 clustercolor = getDebugColor(v_clusterID);\n\n        if(mod(total,2.0)==0.0){\n            material.baseColor = clustercolor;\n            irradiance = vec3(1.0);\n        }\n        else{\n            material.baseColor = material.baseColor * 1.5;\n        }\n    }\n#endif\n\n    vec3 viewNormal = normalize(v_viewNormal);\n    vec3 surfacePos = -v_viewPos;\n\n    // The vector from the camera to the surface point.\n    vec3 viewVector = mat3(cameraMatrix) * normalize(v_viewPos);\n    vec3 viewDir = normalize(viewVector);\n    vec3 normal = normalize(mat3(cameraMatrix) * viewNormal);\n\n    float NdotV = dot(normal, viewDir);\n    if(NdotV < 0.0){\n        normal = -normal;\n        NdotV = dot(normal, viewDir);\n    }\n\n#ifndef ENABLE_SPECULAR\n    vec3 radiance = material.baseColor * irradiance;\n#else\n    \n    // Mix the base color to give a multi-layered paint look.\n    material.baseColor      = mix(material.baseColor, material.baseColor * MidColorTint.rgb, (1.0-NdotV));\n\n    mat3 TBN = cotangent_frame( normal, surfacePos, v_lightmapCoord );\n    vec3 flakesNormal = TBN * -sampleNormalMap( FlakesNormalTex, (v_lightmapCoord * lightmapSize) / FlakesScale );\n    flakesNormal = normalize(mix(normal, flakesNormal, MicroflakePerturbation));\n\n    vec3 baseRadiance = pbrSurfaceRadiance(material, irradiance, flakesNormal, viewVector);\n\n    material.roughness      = GlossRoughness;\n    material.reflectance    = GlossReflectance;\n    vec4 gloss = pbrSpecularReflectance(material, normal, viewVector);\n    vec3 radiance = mix(baseRadiance, gloss.rgb, gloss.a);\n    //vec3 radiance = baseRadiance;\n\n#endif\n\n#ifndef ENABLE_ES3\n    vec4 fragColor;\n#endif\n\n    fragColor = vec4(radiance, 1.0);\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n    fragColor.rgb = toGamma(fragColor.rgb * exposure);\n#endif\n\n#ifndef ENABLE_ES3\n    gl_FragColor = fragColor;\n#endif\n}\n'),this.finalize()}static getParamDeclarations(){const t=super.getParamDeclarations();t.push({name:"BaseColor",defaultValue:new p(1,0,0)}),t.push({name:"BaseMetallic",defaultValue:0}),t.push({name:"BaseRoughness",defaultValue:.35}),t.push({name:"BaseReflectance",defaultValue:.03}),t.push({name:"MidColorTint",defaultValue:new p(1,1,1)}),t.push({name:"MidColorTintReflectance",defaultValue:.03}),t.push({name:"GlossMetallic",defaultValue:0}),t.push({name:"GlossRoughness",defaultValue:.35}),t.push({name:"GlossReflectance",defaultValue:.03});const i=new ti("flakes","ZeaEngine/FlakesNormalMap.png");return i.wrap="REPEAT",i.mipMapped=!0,t.push({name:"FlakesNormal",defaultValue:i}),t.push({name:"FlakesScale",defaultValue:.1}),t.push({name:"MicroflakePerturbation",defaultValue:.1}),t}static getGeomDataShaderName(){return"StandardSurfaceGeomDataShader"}static getSelectedShaderName(){return"StandardSurfaceSelectedGeomsShader"}}N.registerClass("LayeredCarPaintShader",we);class Fe extends Fs{constructor(t){super(t),this.__shaderStages.VERTEX_SHADER=ws.parseShader("FlatShader.vertexShader",'\nprecision highp float;\n\nattribute vec3 positions;\nattribute vec2 lightmapCoords;\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\nuniform vec3 ProjectionCenter;\n\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="stack-gl/inverse.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n\nattribute float clusterIDs;\nuniform vec2 lightmapSize;\n\n/* VS Outputs */\n// varying vec2 v_lightmapCoord;\nvarying vec3 v_worldDir;\n\nvoid main(void) {\n    int drawItemId = getDrawItemId();\n\n    vec4 geomItemData = getInstanceData(drawItemId);\n\n    vec4 pos = vec4(positions, 1.);\n    mat4 modelMatrix = getModelMatrix(drawItemId);\n    mat4 modelViewProjectionMatrix = projectionMatrix * viewMatrix * modelMatrix;\n    gl_Position     = modelViewProjectionMatrix * pos;\n\n    vec4 worldPos = modelMatrix * pos;\n    v_worldDir = worldPos.xyz - ProjectionCenter;\n\n    v_lightmapCoord = (lightmapCoords + geomItemData.zw) / lightmapSize;\n}\n')}}N.registerClass("ShadowCatcherShader",class extends Fe{constructor(t){super(t),this.__shaderStages.FRAGMENT_SHADER=ws.parseShader("ShadowCatcherShader.fragmentShader",'\nprecision highp float;\n\n<%include file="math/constants.glsl"/>\n<%include file="GLSLUtils.glsl"/>\n<%include file="pragmatic-pbr/envmap-octahedral.glsl"/>\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n<%include file="stack-gl/gamma.glsl"/>\n#endif\n\n/* VS Outputs */\nvarying vec2 v_lightmapCoord;\nvarying vec3 v_worldDir;\n\nuniform sampler2D lightmap;\nuniform float ShadowMultiplier;\n\nuniform color envMap;\nuniform sampler2D envMapTex;\nuniform int envMapTexType;\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\nuniform float exposure;\n#endif\n\nfloat luminanceFromRGB(vec3 rgb) {\n    return 0.2126*rgb.r + 0.7152*rgb.g + 0.0722*rgb.b;\n}\n\n\n#ifdef ENABLE_ES3\n    out vec4 fragColor;\n#endif\nvoid main(void) {\n\n    vec4 env = envMap;\n    if(envMapTexType != 0) {\n        vec2 texCoord = dirToSphOctUv(normalize(v_worldDir));\n        env = texture2D(envMapTex, texCoord);\n    }\n\n    vec3 irradiance = texture2D(lightmap, v_lightmapCoord).rgb * ShadowMultiplier;\n    float irradianceLum = clamp(luminanceFromRGB(irradiance), 0.0, 1.0);\n\n#ifndef ENABLE_ES3\n    vec4 fragColor;\n#endif\n\n    fragColor = vec4(env.rgb/env.a, 1.0);\n    fragColor.rgb = mix(fragColor.rgb * irradiance, fragColor.rgb, irradianceLum);\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n    fragColor.rgb = toGamma(fragColor.rgb * exposure);\n#endif\n\n\n#ifndef ENABLE_ES3\n    gl_FragColor = fragColor;\n#endif\n}\n'),this.finalize()}static getParamDeclarations(){const t=super.getParamDeclarations();return t.push({name:"ProjectionCenter",defaultValue:new u(0,0,1.7)}),t.push({name:"ShadowMultiplier",defaultValue:1}),t}static isTransparent(){return!0}bind(t,i){return"ADD"==t.pass&&super.bind(t,i)}}),N.registerClass("FloatingShadowCatcherShader",class extends Fe{constructor(t){super(t),this.__shaderStages.FRAGMENT_SHADER=ws.parseShader("FloatingShadowCatcherShader.fragmentShader",'\nprecision highp float;\n\n<%include file="math/constants.glsl"/>\n<%include file="GLSLUtils.glsl"/>\n<%include file="stack-gl/gamma.glsl"/>\n<%include file="materialparams.glsl"/>\n<%include file="pragmatic-pbr/envmap-octahedral.glsl"/>\n\n/* VS Outputs */\nvarying vec2 v_lightmapCoord;\nvarying vec3 v_worldDir;\n\nuniform sampler2D lightmap;\n\nuniform float ShadowMultiplier;\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\nuniform float exposure;\n#endif\n\n\n#ifdef ENABLE_ES3\n    out vec4 fragColor;\n#endif\nvoid main(void) {\n\n#ifndef ENABLE_ES3\n    vec4 fragColor;\n#endif\n    \n    float shadow = luminanceFromRGB(texture2D(lightmap, v_lightmapCoord).rgb) * ShadowMultiplier;\n\n    // This material works by multiplying the image buffer values by the luminance in the lightmap.\n    fragColor.rgb = vec3(pow(shadow, 1.0/ShadowMultiplier));\n    fragColor.a = 1.0;\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n    fragColor.rgb = toGamma(fragColor.rgb * exposure);\n#endif\n\n#ifndef ENABLE_ES3\n    gl_FragColor = fragColor;\n#endif\n}\n')}bind(t,i){return"MULTIPLY"==t.pass&&super.bind(t,i)}static isTransparent(){return!0}static getParamDeclarations(){const t=super.getParamDeclarations();return t.push({name:"ShadowMultiplier",defaultValue:1}),t}});class Ne extends Fs{constructor(t){super(t),this.__shaderStages.VERTEX_SHADER=ws.parseShader("LinesShader.vertexShader",'\nprecision highp float;\n\nattribute vec3 positions;\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\n\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="drawItemId.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n\n/* VS Outputs */\n\nvoid main(void) {\n    int drawItemId = getDrawItemId();\n    mat4 modelMatrix = getModelMatrix(drawItemId);\n    mat4 modelViewProjectionMatrix = projectionMatrix * viewMatrix * modelMatrix;\n    gl_Position = modelViewProjectionMatrix * vec4(positions, 1.0);\n}\n'),this.__shaderStages.FRAGMENT_SHADER=ws.parseShader("LinesShader.fragmentShader","\nprecision highp float;\n\nuniform color BaseColor;\nuniform float Opacity;\n\n#ifdef ENABLE_ES3\n    out vec4 fragColor;\n#endif\nvoid main(void) {\n#ifndef ENABLE_ES3\n    vec4 fragColor;\n#endif\n    fragColor = BaseColor;\n    fragColor.a *= Opacity;\n    \n#ifndef ENABLE_ES3\n    gl_FragColor = fragColor;\n#endif\n}\n"),this.finalize()}static getParamDeclarations(){const t=super.getParamDeclarations();return t.push({name:"BaseColor",defaultValue:new p(1,1,.5)}),t.push({name:"Opacity",defaultValue:1}),t}static getGeomDataShaderName(){return"StandardSurfaceGeomDataShader"}static getSelectedShaderName(){return"StandardSurfaceSelectedGeomsShader"}static isTransparent(){return!0}bind(t,i){return"ADD"==t.pass&&super.bind(t,i)}}N.registerClass("LinesShader",Ne);class Te extends Fs{constructor(t){super(t),this.__shaderStages.VERTEX_SHADER=ws.parseShader("NormalsShader.vertexShader",'\nprecision highp float;\n\ninstancedattribute vec3 positions;\ninstancedattribute vec3 normals;\nattribute vec2 vertexIDs;\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\n\nuniform float normalLength;\n\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n\n\n/* VS Outputs */\nvarying float v_weight;\n\nvoid main(void) {\n  mat4 modelMatrix = getModelMatrix(transformIndex);\n  mat4 modelViewProjectionMatrix = projectionMatrix * viewMatrix * modelMatrix;\n  if(vertexIDs.x == 0.0){\n    gl_Position = modelViewProjectionMatrix * vec4(positions, 1.0);\n    v_weight = 1.0;\n  }\n  else{\n    gl_Position = modelViewProjectionMatrix * vec4(positions+(normals*normalLength), 1.0);\n    v_weight = 0.0;\n  }\n}\n'),this.__shaderStages.FRAGMENT_SHADER=ws.parseShader("NormalsShader.fragmentShader","\nprecision highp float;\n\nuniform color normalColor;\n\n/* VS Outputs */\nvarying float v_weight;\n\n\nvoid main(void) {\n  gl_FragColor = normalColor;\n  gl_FragColor.a = v_weight;\n}\n")}}class Je extends Fs{constructor(t){super(t),this.__shaderStages.VERTEX_SHADER=ws.parseShader("PointsShader.vertexShader",'\nprecision highp float;\n\nattribute vec3 positions;\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\n\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="stack-gl/inverse.glsl"/>\n<%include file="drawItemId.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n\n/* VS Outputs */\n\nvoid main(void) {\n  int drawItemId = getDrawItemId();\n  mat4 modelMatrix = getModelMatrix(drawItemId);\n  mat4 modelViewProjectionMatrix = projectionMatrix * viewMatrix * modelMatrix;\n  gl_Position = modelViewProjectionMatrix * vec4(positions, 1.);\n}\n'),this.__shaderStages.FRAGMENT_SHADER=ws.parseShader("PointsShader.fragmentShader","\nprecision highp float;\n\nuniform color BaseColor;\n\n#ifdef ENABLE_ES3\nout vec4 fragColor;\n#endif\n\nvoid main(void) {\n\n#ifndef ENABLE_ES3\n  vec4 fragColor;\n#endif\n\n  fragColor = BaseColor;\n\n#ifndef ENABLE_ES3\n  gl_FragColor = fragColor;\n#endif\n}\n")}static getParamDeclarations(){const t=super.getParamDeclarations();return t.push({name:"BaseColor",defaultValue:new p(1,1,.5)}),t}}N.registerClass("PointsShader",Je);class ze extends Fs{constructor(t){super(t),this.__shaderStages.VERTEX_SHADER=ws.parseShader("FatPointsShader.vertexShader",'\nprecision highp float;\n\ninstancedattribute vec3 positions;\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\n\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="stack-gl/inverse.glsl"/>\n<%include file="drawItemId.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n<%include file="utils/quadVertexFromID.glsl"/>\n\nuniform float PointSize;\n\n/* VS Outputs */\nvarying vec2 v_texCoord;\nvarying vec3 v_viewPos;\nvarying float v_drawItemId;\n\nvoid main(void) {\n  int drawItemId = getDrawItemId();\n  vec2 quadPointPos = getQuadVertexPositionFromID();\n  v_texCoord = quadPointPos + 0.5;\n\n  mat4 modelMatrix = getModelMatrix(drawItemId);\n  mat4 modelViewMatrix = viewMatrix * modelMatrix;\n  \n  vec4 viewPos = modelViewMatrix * vec4(positions, 1.);\n\n  viewPos += vec4(vec3(quadPointPos, 0.0) * PointSize, 0.);\n\n  // Generate a quad which is 0.5 * PointSize closer towards\n  // us. This allows points to be visualized even if snug on \n  // a surface. (else they get fully clipped)\n  viewPos.z += 0.5 * PointSize;\n\n  v_drawItemId = float(getDrawItemId());\n  v_viewPos = -viewPos.xyz;\n  \n  gl_Position = projectionMatrix * viewPos;\n}\n'),this.__shaderStages.FRAGMENT_SHADER=ws.parseShader("FatPointsShader.fragmentShader",'\nprecision highp float;\n\n<%include file="math/constants.glsl"/>\n\nuniform color BaseColor;\nuniform float Rounded;\nuniform float BorderWidth;\n\n/* VS Outputs */\nvarying vec2 v_texCoord;\nvarying vec3 v_viewPos;\nvarying float v_drawItemId;\n\n#ifdef ENABLE_ES3\nout vec4 fragColor;\n#endif\n\nvoid main(void) {\n\n#ifndef ENABLE_ES3\n  vec4 fragColor;\n#endif\n\n  float dist = length(v_texCoord - 0.5);\n  if(dist > 0.5)\n    discard;\n  if(dist > 0.5 - (BorderWidth * 0.5))\n    fragColor = vec4(0.,0.,0.,1.);\n  else {\n    // Modulate the lighting using the texture coord so the point looks round.\n    float NdotV = cos(dist * PI);\n\n    fragColor = BaseColor * mix(1.0, NdotV, Rounded);\n  }\n  \n\n#ifndef ENABLE_ES3\n  gl_FragColor = fragColor;\n#endif\n}\n')}bind(t){return!!super.bind(t)&&(t.supportsInstancing=!1,!0)}static getParamDeclarations(){const t=super.getParamDeclarations();return t.push({name:"BaseColor",defaultValue:new p(1,1,.5)}),t.push({name:"PointSize",defaultValue:.05}),t.push({name:"Rounded",defaultValue:1}),t.push({name:"BorderWidth",defaultValue:.2}),t}static getGeomDataShaderName(){return"FatPointsGeomDataShader"}static getSelectedShaderName(){return"FatPointsSelectedShader"}}class He extends ze{constructor(t){super(t),this.__shaderStages.FRAGMENT_SHADER=ws.parseShader("FatPointsGeomDataShader.fragmentShader",'\nprecision highp float;\n\n<%include file="math/constants.glsl"/>\n<%include file="GLSLBits.glsl"/>\n\nuniform int floatGeomBuffer;\nuniform int passId;\n\n/* VS Outputs */\nvarying vec2 v_texCoord;\nvarying vec3 v_viewPos;\nvarying float v_drawItemId;\n\n#ifdef ENABLE_ES3\nout vec4 fragColor;\n#endif\n\nvoid main(void) {\n\n#ifndef ENABLE_ES3\n  vec4 fragColor;\n#endif\n\n  float dist = length(v_texCoord - 0.5);\n  if(dist > 0.5)\n    discard;\n    \n\n  float viewDist = length(v_viewPos);\n\n  if(floatGeomBuffer != 0) {\n    fragColor.r = float(passId); \n    fragColor.g = float(v_drawItemId);\n    fragColor.b = 0.0;// TODO: store poly-id or something.\n    fragColor.a = viewDist;\n  }\n  else {\n    ///////////////////////////////////\n    // UInt8 buffer\n    fragColor.r = (mod(v_drawItemId, 256.) + 0.5) / 255.;\n    fragColor.g = (floor(v_drawItemId / 256.) + 0.5) / 255.;\n\n    // encode the dist as a 16 bit float\n    vec2 float16bits = encode16BitFloatInto2xUInt8(viewDist);\n    fragColor.b = float16bits.x;\n    fragColor.a = float16bits.y;\n  }\n\n\n#ifndef ENABLE_ES3\n  gl_FragColor = fragColor;\n#endif\n}\n')}}class Ue extends ze{constructor(t){super(t),this.__shaderStages.FRAGMENT_SHADER=ws.parseShader("FatPointsSelectedShader.fragmentShader",'\nprecision highp float;\n\n<%include file="math/constants.glsl"/>\n<%include file="GLSLBits.glsl"/>\n\nuniform int floatGeomBuffer;\nuniform int passId;\n\n/* VS Outputs */\nvarying vec2 v_texCoord;\nvarying vec3 v_viewPos;\nvarying float v_drawItemId;\n\n\n<%include file="drawItemTexture.glsl"/>\n\n#ifdef ENABLE_FLOAT_TEXTURES\nvec4 getHighlightColor(int id) {\n  return fetchTexel(instancesTexture, instancesTextureSize, (id * pixelsPerItem) + 4);\n}\n#else\n\nuniform vec4 highlightColor;\n\nvec4 getHighlightColor() {\n    return highlightColor;\n}\n\n#endif\n\n\n#ifdef ENABLE_ES3\nout vec4 fragColor;\n#endif\n\nvoid main(void) {\n\n#ifndef ENABLE_ES3\n  vec4 fragColor;\n#endif\n\n  float dist = length(v_texCoord - 0.5);\n  if(dist > 0.5)\n    discard;\n  \n  int drawItemId = int(v_drawItemId + 0.5);\n  fragColor = getHighlightColor(drawItemId);\n\n#ifndef ENABLE_ES3\n  gl_FragColor = fragColor;\n#endif\n}\n')}}N.registerClass("FatPointsShader",ze),N.registerClass("FatPointsGeomDataShader",He),N.registerClass("FatPointsSelectedShader",Ue),ws.setShaderModule("pragmatic-pbr/exposure.glsl","\n\n/*\n* Get an exposure using the Saturation-based Speed method.\n*/\nfloat getSaturationBasedExposure(float aperture,\n                                 float shutterSpeed,\n                                 float iso)\n{\n    float l_max = (7800.0 / 65.0) * sqrt(aperture) / (iso * shutterSpeed);\n    return 1.0 / l_max;\n}\n\n//White balance middle grey we are targetting for a good scene exposure\n//https://en.wikipedia.org/wiki/Middle_gray\nconst float MIDDLE_GREY = 0.18;\n\n/*\n* Get an exposure using the Standard Output Sensitivity method.\n* Accepts an additional parameter of the target middle grey.\n*/\nfloat getStandardOutputBasedExposure(float aperture,\n                                     float shutterSpeed,\n                                     float iso)\n{\n    //https://placeholderart.wordpress.com/2014/11/21/implementing-a-physically-based-camera-manual-exposure/\n    //https://en.wikipedia.org/wiki/Film_speed#Standard_output_sensitivity_.28SOS.29\n    //photometric exposure magic\n    //represents the properties of lens\n    float q = 0.65;\n\n    //float l_avg = (1000.0f / 65.0f) * sqrt(aperture) / (iso * shutterSpeed);\n    float l_avg = (1.0 / q) * sqrt(aperture) / (iso * shutterSpeed);\n    //float l_avg = sqrt(aperture) / (iso * shutterSpeed);\n    return MIDDLE_GREY / l_avg;\n}\n\n"),ws.setShaderModule("pragmatic-pbr/tonemap-filmic.glsl","\n\n//Based on Filmic Tonemapping Operators http://filmicgames.com/archives/75\nvec3 tonemapFilmic(vec3 color) {\n    vec3 x = max(vec3(0.0), color - 0.004);\n    return (x * (6.2 * x + 0.5)) / (x * (6.2 * x + 1.7) + 0.06);\n}\n\n"),ws.setShaderModule("mattdesl/fxaa-texcoords.glsl","\n//To save 9 dependent texture reads, you can compute\n//these in the vertex shader and use the optimized\n//frag.glsl function in your frag shader. \n\n//This is best suited for mobile devices, like iOS.\n\nvoid texcoords(vec2 fragCoord, vec2 resolution,\n            out vec2 v_rgbNW, out vec2 v_rgbNE,\n            out vec2 v_rgbSW, out vec2 v_rgbSE,\n            out vec2 v_rgbM) {\n    vec2 inverseVP = 1.0 / resolution.xy;\n    v_rgbNW = (fragCoord + vec2(-1.0, -1.0)) * inverseVP;\n    v_rgbNE = (fragCoord + vec2(1.0, -1.0)) * inverseVP;\n    v_rgbSW = (fragCoord + vec2(-1.0, 1.0)) * inverseVP;\n    v_rgbSE = (fragCoord + vec2(1.0, 1.0)) * inverseVP;\n    v_rgbM = vec2(fragCoord * inverseVP);\n}\n\n"),ws.setShaderModule("mattdesl/fxaa.glsl",'\n\n/**\nBasic FXAA implementation based on the code on geeks3d.com with the\nmodification that the texture2DLod stuff was removed since it\'s\nunsupported by WebGL.\n--\nFrom:\nhttps://github.com/mitsuhiko/webgl-meincraft\nCopyright (c) 2011 by Armin Ronacher.\nSome rights reserved.\nRedistribution and use in source and binary forms, with or without\nmodification, are permitted provided that the following conditions are\nmet:\n    * Redistributions of source code must retain the above copyright\n      notice, this list of conditions and the following disclaimer.\n    * Redistributions in binary form must reproduce the above\n      copyright notice, this list of conditions and the following\n      disclaimer in the documentation and/or other materials provided\n      with the distribution.\n    * The names of the contributors may not be used to endorse or\n      promote products derived from this software without specific\n      prior written permission.\nTHIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS\n"AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT\nLIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR\nA PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT\nOWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,\nSPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT\nLIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,\nDATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY\nTHEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\n(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE\nOF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n*/\n\n#ifndef FXAA_REDUCE_MIN\n    #define FXAA_REDUCE_MIN   (1.0/ 128.0)\n#endif\n#ifndef FXAA_REDUCE_MUL\n    #define FXAA_REDUCE_MUL   (1.0 / 8.0)\n#endif\n#ifndef FXAA_SPAN_MAX\n    #define FXAA_SPAN_MAX     8.0\n#endif\n\n//optimized version for mobile, where dependent \n//texture reads can be a bottleneck\nvec4 fxaa(sampler2D tex, vec2 fragCoord, vec2 resolution,\n            vec2 v_rgbNW, vec2 v_rgbNE, \n            vec2 v_rgbSW, vec2 v_rgbSE, \n            vec2 v_rgbM) {\n    vec4 color;\n    mediump vec2 inverseVP = vec2(1.0 / resolution.x, 1.0 / resolution.y);\n    vec3 rgbNW = texture2D(tex, v_rgbNW).xyz;\n    vec3 rgbNE = texture2D(tex, v_rgbNE).xyz;\n    vec3 rgbSW = texture2D(tex, v_rgbSW).xyz;\n    vec3 rgbSE = texture2D(tex, v_rgbSE).xyz;\n    vec4 texColor = texture2D(tex, v_rgbM);\n    vec3 rgbM  = texColor.xyz;\n    vec3 luma = vec3(0.299, 0.587, 0.114);\n    float lumaNW = dot(rgbNW, luma);\n    float lumaNE = dot(rgbNE, luma);\n    float lumaSW = dot(rgbSW, luma);\n    float lumaSE = dot(rgbSE, luma);\n    float lumaM  = dot(rgbM,  luma);\n    float lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\n    float lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\n    \n    mediump vec2 dir;\n    dir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\n    dir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\n    \n    float dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) *\n                          (0.25 * FXAA_REDUCE_MUL), FXAA_REDUCE_MIN);\n    \n    float rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\n    dir = min(vec2(FXAA_SPAN_MAX, FXAA_SPAN_MAX),\n              max(vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX),\n              dir * rcpDirMin)) * inverseVP;\n    \n    vec3 rgbA = 0.5 * (\n        texture2D(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz +\n        texture2D(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\n    vec3 rgbB = rgbA * 0.5 + 0.25 * (\n        texture2D(tex, fragCoord * inverseVP + dir * -0.5).xyz +\n        texture2D(tex, fragCoord * inverseVP + dir * 0.5).xyz);\n\n    float lumaB = dot(rgbB, luma);\n    if ((lumaB < lumaMin) || (lumaB > lumaMax))\n        color = vec4(rgbA, texColor.a);\n    else\n        color = vec4(rgbB, texColor.a);\n    return color;\n}\n\n'),ws.setShaderModule("mattdesl/fxaa-apply.glsl",'\n\n<%include file="mattdesl/fxaa.glsl"/>\n\nvec4 apply(sampler2D tex, vec2 fragCoord, vec2 resolution) {\n    mediump vec2 v_rgbNW;\n    mediump vec2 v_rgbNE;\n    mediump vec2 v_rgbSW;\n    mediump vec2 v_rgbSE;\n    mediump vec2 v_rgbM;\n\n    //compute the texture coords\n    texcoords(fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n    \n    //compute FXAA\n    return fxaa(tex, fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n}\n\n');class ke extends Fs{constructor(t){super(t),this.__shaderStages.VERTEX_SHADER=ws.parseShader("PostProcessing.vertexShader",'\nprecision highp float;\n\n<%include file="utils/quadVertexFromID.glsl"/>\n<%include file="mattdesl/fxaa-texcoords.glsl"/>\n\nuniform vec2 textureSize;\n\n/* VS Outputs */\nvarying vec2 v_texCoord;\n\n//texcoords computed in vertex step\n//to avoid dependent texture reads\nvarying vec2 v_rgbNW;\nvarying vec2 v_rgbNE;\nvarying vec2 v_rgbSW;\nvarying vec2 v_rgbSE;\nvarying vec2 v_rgbM;\n\n \nvoid main()\n{\n    vec2 position = getQuadVertexPositionFromID();\n    v_texCoord = position+0.5;\n    gl_Position = vec4(position*2.0, 0.0, 1.0);\n\n    vec2 fragCoord = v_texCoord * textureSize;\n    texcoords(fragCoord, textureSize, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n}\n\n'),this.__shaderStages.FRAGMENT_SHADER=ws.parseShader("PostProcessing.fragmentShader",'\nprecision highp float;\n\n<%include file="pragmatic-pbr/exposure.glsl"/>\n<%include file="pragmatic-pbr/tonemap-filmic.glsl"/>\n<%include file="stack-gl/gamma.glsl"/>\n\n<%include file="mattdesl/fxaa.glsl"/>\n\n//texcoords computed in vertex step\n//to avoid dependent texture reads\nvarying vec2 v_rgbNW;\nvarying vec2 v_rgbNE;\nvarying vec2 v_rgbSW;\nvarying vec2 v_rgbSE;\nvarying vec2 v_rgbM;\n\nuniform sampler2D texture;\nuniform vec2 textureSize;\n\nuniform bool antialiase;\nuniform bool tonemap;\nuniform float exposure;\nuniform float gamma;\n\nvarying vec2 v_texCoord;\n\n#ifdef ENABLE_ES3\n    out vec4 fragColor;\n#endif\nvoid main(void) {\n    //can also use gl_FragCoord.xy\n    mediump vec2 fragCoord = v_texCoord * textureSize; \n\n    if (antialiase) {\n        fragColor = fxaa(texture, fragCoord, textureSize, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n    } else {\n        fragColor = texture2D(texture, v_texCoord);\n    }\n    \n    //fragColor.rgb *= getStandardOutputBasedExposure(aperture, shutterSpeed, iso);\n    fragColor.rgb *= exposure;\n    \n    if (tonemap) \n        fragColor.rgb = tonemapFilmic(fragColor.rgb);\n    else\n        fragColor.rgb = toGamma(fragColor.rgb, gamma);\n\n    \n    //fragColor.rgb = toGamma(fragColor.rgb, gamma);\n    \n    fragColor.a = 1.0;\n\n#ifndef ENABLE_ES3\n    gl_FragColor = fragColor;\n#endif\n}'),this.finalize()}}class Be extends Fs{constructor(t){super(t),this.__shaderStages.VERTEX_SHADER=ws.parseShader("SimpleSurfaceShader.vertexShader",'\nprecision highp float;\n\nattribute vec3 positions;\nattribute vec3 normals;\n#ifdef ENABLE_TEXTURES\nattribute vec2 texCoords;\n#endif\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\n\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="stack-gl/inverse.glsl"/>\n<%include file="drawItemId.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n\n/* VS Outputs */\nvarying float v_drawItemId;\nvarying vec4 v_geomItemData;\nvarying vec3 v_viewPos;\nvarying vec3 v_viewNormal;\n#ifdef ENABLE_TEXTURES\nvarying vec2 v_textureCoord;\n#endif\nvarying vec3 v_worldPos;\n\nvoid main(void) {\n    int drawItemId = getDrawItemId();\n    v_drawItemId = float(drawItemId);\n    v_geomItemData  = getInstanceData(drawItemId);\n\n    vec4 pos = vec4(positions, 1.);\n    mat4 modelMatrix = getModelMatrix(drawItemId);\n    mat4 modelViewMatrix = viewMatrix * modelMatrix;\n    vec4 viewPos    = modelViewMatrix * pos;\n    gl_Position     = projectionMatrix * viewPos;\n\n    mat3 normalMatrix = mat3(transpose(inverse(modelViewMatrix)));\n    v_viewPos       = -viewPos.xyz;\n    v_viewNormal    = normalMatrix * normals;\n\n#ifdef ENABLE_TEXTURES\n    v_textureCoord  = texCoords;\n    // v_textureCoord.y = 1.0 - v_textureCoord.y;// Flip y\n#endif\n\n    v_worldPos      = (modelMatrix * pos).xyz;\n}\n'),this.__shaderStages.FRAGMENT_SHADER=ws.parseShader("SimpleSurfaceShader.fragmentShader",'\nprecision highp float;\n\n<%include file="drawItemTexture.glsl"/>\n<%include file="cutaways.glsl"/>\n<%include file="stack-gl/gamma.glsl"/>\n<%include file="materialparams.glsl"/>\n\n/* VS Outputs */\nvarying float v_drawItemId;\nvarying vec4 v_geomItemData;\nvarying vec3 v_viewPos;\nvarying vec3 v_viewNormal;\n#ifdef ENABLE_TEXTURES\nvarying vec2 v_textureCoord;\n#endif\nvarying vec3 v_worldPos;\n\nuniform mat4 cameraMatrix;\n\nuniform color BaseColor;\nuniform float Opacity;\n\n#ifdef ENABLE_TEXTURES\n\nuniform sampler2D BaseColorTex;\nuniform int BaseColorTexType;\nuniform sampler2D OpacityTex;\nuniform int OpacityTexType;\n\nuniform color cutColor;\nvec4 getCutaway(int id) {\n    return fetchTexel(instancesTexture, instancesTextureSize, (id * pixelsPerItem) + 5);\n}\n\n#endif\n\n#ifdef ENABLE_ES3\n    out vec4 fragColor;\n#endif\n\nvoid main(void) {\n    int drawItemId = int(v_drawItemId + 0.5);\n\n    int flags = int(v_geomItemData.r + 0.5);\n    // Cutaways\n    if(testFlag(flags, GEOMITEM_FLAG_CUTAWAY)) \n    {\n        vec4 cutAwayData   = getCutaway(drawItemId);\n        vec3 planeNormal = cutAwayData.xyz;\n        float planeDist = cutAwayData.w;\n        if(cutaway(v_worldPos, planeNormal, planeDist)){\n            discard;\n            return;\n        }\n        else if(!gl_FrontFacing){\n            fragColor = cutColor;\n#ifndef ENABLE_ES3\n            gl_FragColor = fragColor;\n#endif\n            return;\n        }\n    }\n\n#ifndef ENABLE_TEXTURES\n    vec4 baseColor      = BaseColor;\n    float opacity       = baseColor.a * Opacity;\n#else\n    vec4 baseColor      = getColorParamValue(BaseColor, BaseColorTex, BaseColorTexType, v_textureCoord);\n    float opacity       = baseColor.a * getLuminanceParamValue(Opacity, OpacityTex, OpacityTexType, v_textureCoord);\n#endif\n\n    // Hacky simple irradiance. \n    vec3 viewVector = normalize(mat3(cameraMatrix) * normalize(v_viewPos));\n    vec3 normal = normalize(mat3(cameraMatrix) * v_viewNormal);\n    float ndotv = dot(normal, viewVector);\n    if(ndotv < 0.0){\n        normal = -normal;\n        ndotv = dot(normal, viewVector);\n\n        // Note: these 2 lines can be used to debug inverted meshes.\n        //baseColor = vec4(1.0, 0.0, 0.0, 1.0);\n        //ndotv = 1.0;\n    }\n\n#ifndef ENABLE_ES3\n    vec4 fragColor;\n#endif\n    fragColor = vec4(ndotv * baseColor.rgb, opacity);\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n    fragColor.rgb = toGamma(fragColor.rgb);\n#endif\n\n#ifndef ENABLE_ES3\n    gl_FragColor = fragColor;\n#endif\n}\n'),this.finalize()}static getParamDeclarations(){const t=super.getParamDeclarations();return t.push({name:"BaseColor",defaultValue:new p(1,1,.5)}),t.push({name:"Opacity",defaultValue:1,range:[0,1]}),t}static getGeomDataShaderName(){return"StandardSurfaceGeomDataShader"}static getSelectedShaderName(){return"StandardSurfaceSelectedGeomsShader"}}N.registerClass("SimpleSurfaceShader",Be),ws.setShaderModule("cutaways.glsl","\n\n\nconst int GEOMITEM_FLAG_CUTAWAY =  1; // 1<<0;\n\n#define RAY_EPS 0.0000001\nstruct Ray {\n    vec3 start;\n    vec3 dir;\n};\n\nfloat intersectRayPlane(Ray ray, Ray plane) {\n    vec3 w = ray.start - plane.start;\n    float D = dot(plane.dir, ray.dir);\n    float N = dot(-plane.dir, w);\n\n    if (abs(D) < RAY_EPS) {\n        // segment is parallel to plane\n        if (N == 0.0)\n            return -1.0; // segment lies in plane\n        else\n            return -1.0; // no intersection\n    }\n    // they are not parallel\n    // compute intersect param\n    float sI = N / D;\n    if (sI < -RAY_EPS) {\n        return -1.0; // no intersection\n    }\n    return sI;\n}\n\n\nbool cutaway(vec3 worldPos, vec3 planeNormal, float planeDist) {\n\n    vec3 planePos = planeNormal * planeDist;\n    vec3 planeDir = worldPos + planePos;\n    float planeOffset = dot(planeDir, planeNormal);\n    if(planeOffset > 0.0){\n        return true;\n    }\n    return  false;\n}\n");class Pe extends Fs{constructor(t){super(t),this.__shaderStages.VERTEX_SHADER=ws.parseShader("StandardSurfaceShader.vertexShader",'\nprecision highp float;\n\nattribute vec3 positions;\nattribute vec3 normals;\n#ifdef ENABLE_TEXTURES\nattribute vec2 texCoords;\n#endif\nattribute vec2 lightmapCoords;\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\n\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="stack-gl/inverse.glsl"/>\n<%include file="drawItemId.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n\n// attribute float clusterIDs;\n// uniform vec2 lightmapSize;\n\n/* VS Outputs */\nvarying float v_drawItemId;\nvarying vec4 v_geomItemData;\nvarying vec3 v_viewPos;\nvarying vec3 v_viewNormal;\n#ifdef ENABLE_TEXTURES\nvarying vec2 v_textureCoord;\n#endif\n// varying vec2 v_lightmapCoord;\n// #ifdef ENABLE_DEBUGGING_LIGHTMAPS\n// varying float v_clusterID;\n// #endif\nvarying vec3 v_worldPos;\n/* VS Outputs */\n\n\nvoid main(void) {\n    int drawItemId = getDrawItemId();\n    v_drawItemId = float(drawItemId);\n    v_geomItemData = getInstanceData(drawItemId);\n\n    vec4 pos = vec4(positions, 1.);\n    mat4 modelMatrix = getModelMatrix(drawItemId);\n    mat4 modelViewMatrix = viewMatrix * modelMatrix;\n    vec4 viewPos    = modelViewMatrix * pos;\n    gl_Position     = projectionMatrix * viewPos;\n\n    mat3 normalMatrix = mat3(transpose(inverse(modelViewMatrix)));\n    v_viewPos       = -viewPos.xyz;\n    v_viewNormal    = normalMatrix * normals;\n\n#ifdef ENABLE_TEXTURES\n    v_textureCoord  = texCoords;\n#endif\n\n    // v_lightmapCoord = (lightmapCoords + v_geomItemData.zw) / lightmapSize;\n\n    // mat4 mvp = projectionMatrix * viewMatrix * modelMatrix;\n    // gl_Position = mvp * vec4((lightmapCoords + v_geomItemData.zw), 0., 1.);\n#ifdef ENABLE_DEBUGGING_LIGHTMAPS\n    v_clusterID = clusterIDs;\n#endif\n\n    v_worldPos      = (modelMatrix * pos).xyz;\n}\n'),this.__shaderStages.FRAGMENT_SHADER=ws.parseShader("StandardSurfaceShader.fragmentShader",'\nprecision highp float;\n\n<%include file="math/constants.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="cutaways.glsl"/>\n\n\n<%include file="stack-gl/gamma.glsl"/>\n<%include file="materialparams.glsl"/>\n\n<%include file="GGX_Specular.glsl"/>\n<%include file="PBRSurfaceRadiance.glsl"/>\n\n/* VS Outputs */\nvarying float v_drawItemId;\nvarying vec4 v_geomItemData;\nvarying vec3 v_viewPos;\nvarying vec3 v_viewNormal;\n#ifdef ENABLE_TEXTURES\nvarying vec2 v_textureCoord;\n#endif\n// varying vec2 v_lightmapCoord;\n// #ifdef ENABLE_DEBUGGING_LIGHTMAPS\n// varying float v_clusterID;\n// #endif\nvarying vec3 v_worldPos;\n/* VS Outputs */\n\n\n// uniform sampler2D lightmap;\n// uniform bool lightmapConnected;\n// #ifdef ENABLE_DEBUGGING_LIGHTMAPS\n// <%include file="debugColors.glsl"/>\n// uniform vec2 lightmapSize;\n// uniform bool debugLightmapTexelSize;\n// #endif\n\nuniform color cutColor;\nvec4 getCutaway(int id) {\n    return fetchTexel(instancesTexture, instancesTextureSize, (id * pixelsPerItem) + 5);\n}\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\nuniform float exposure;\n#endif\n\nuniform mat4 cameraMatrix;\n\nuniform color BaseColor;\nuniform float EmissiveStrength;\n\n\n#ifdef ENABLE_SPECULAR\nuniform float Roughness;\nuniform float Metallic;\nuniform float Reflectance;\n#endif\n\n#ifdef ENABLE_TEXTURES\nuniform sampler2D BaseColorTex;\nuniform int BaseColorTexType;\n\n#ifdef ENABLE_SPECULAR\nuniform sampler2D RoughnessTex;\nuniform int RoughnessTexType;\n\nuniform sampler2D MetallicTex;\nuniform int MetallicTexType;\n\nuniform sampler2D ReflectanceTex;\nuniform int ReflectanceTexType;\n\nuniform sampler2D NormalTex;\nuniform int NormalTexType;\n// uniform float NormalScale;\n#endif\n\nuniform sampler2D EmissiveStrengthTex;\nuniform int EmissiveStrengthTexType;\n\n\n#endif\n\n#ifdef ENABLE_ES3\nout vec4 fragColor;\n\n#endif\n\nvoid main(void) {\n    int drawItemId = int(v_drawItemId + 0.5);\n\n    int flags = int(v_geomItemData.r + 0.5);\n    // Cutaways\n    if(testFlag(flags, GEOMITEM_FLAG_CUTAWAY)) {\n        vec4 cutAwayData   = getCutaway(drawItemId);\n        vec3 planeNormal = cutAwayData.xyz;\n        float planeDist = cutAwayData.w;\n        if(cutaway(v_worldPos, planeNormal, planeDist)){\n            discard;\n            return;\n        }\n        else if(!gl_FrontFacing){\n            fragColor = cutColor;\n#ifndef ENABLE_ES3\n            gl_FragColor = fragColor;\n#endif\n            return;\n        }\n    }\n\n\n    MaterialParams material;\n\n#ifndef ENABLE_TEXTURES\n    material.BaseColor     = BaseColor.rgb;\n    float emission         = EmissiveStrength;\n\n#ifdef ENABLE_SPECULAR\n    material.roughness     = Roughness;\n    material.metallic      = Metallic;\n    material.reflectance   = Reflectance;\n#endif\n\n#else\n    // Planar YZ projection for texturing, repeating every meter.\n    // vec2 texCoord       = v_worldPos.xz * 0.2;\n    vec2 texCoord          = vec2(v_textureCoord.x, 1.0 - v_textureCoord.y);\n    material.baseColor     = getColorParamValue(BaseColor, BaseColorTex, BaseColorTexType, texCoord).rgb;\n\n#ifdef ENABLE_SPECULAR\n    material.roughness     = getLuminanceParamValue(Roughness, RoughnessTex, RoughnessTexType, texCoord);\n    material.metallic      = getLuminanceParamValue(Metallic, MetallicTex, MetallicTexType, texCoord);\n    material.reflectance   = getLuminanceParamValue(Reflectance, ReflectanceTex, ReflectanceTexType, texCoord);\n#endif\n    float emission         = getLuminanceParamValue(EmissiveStrength, EmissiveStrengthTex, EmissiveStrengthTexType, texCoord);\n#endif\n\n    vec3 viewNormal = normalize(v_viewNormal);\n    //vec3 surfacePos = -v_viewPos;\n\n#ifdef ENABLE_TEXTURES\n#ifdef ENABLE_SPECULAR\n    if(NormalTexType != 0){\n        vec3 textureNormal_tangentspace = normalize(texture2D(NormalTex, texCoord).rgb * 2.0 - 1.0);\n        viewNormal = normalize(mix(viewNormal, textureNormal_tangentspace, 0.3));\n    }\n#endif\n#endif\n\n    vec3 viewVector = normalize(mat3(cameraMatrix) * normalize(v_viewPos));\n    vec3 normal = normalize(mat3(cameraMatrix) * viewNormal);\n    if(dot(normal, viewVector) < 0.0){\n        normal = -normal;\n        // Note: this line can be used to debug inverted meshes.\n        //material.baseColor = vec3(1.0, 0.0, 0.0);\n    }\n\n    vec3 irradiance;\n    // if(lightmapConnected){\n    //     irradiance = texture2D(lightmap, v_lightmapCoord).rgb;\n    // }\n    // else{\n#ifndef ENABLE_SPECULAR\n        irradiance = sampleEnvMap(normal, 1.0);\n#else\n        irradiance = vec3(dot(normal, viewVector));\n#endif\n        \n    // }\n\n// #ifdef ENABLE_DEBUGGING_LIGHTMAPS\n//     if(debugLightmapTexelSize)\n//     {\n//         vec2 coord_texelSpace = (v_lightmapCoord * lightmapSize) - v_geomItemData.zw;\n//         //vec2 coord_texelSpace = (v_textureCoord * lightmapSize);\n//         float total = floor(coord_texelSpace.x) +\n//                       floor(coord_texelSpace.y);\n                      \n//         vec3 clustercolor = getDebugColor(v_clusterID);\n\n//         material.metallic = 0.0;\n//         material.reflectance = 0.0;\n//         if(mod(total,2.0)==0.0){\n//             material.baseColor = clustercolor;\n//             irradiance = vec3(1.0);\n//         }\n//         else{\n//             material.baseColor = material.baseColor * 1.5;\n//         }\n//     }\n// #endif\n\n#ifndef ENABLE_SPECULAR\n    vec3 radiance = material.baseColor * irradiance;\n#else\n    vec3 radiance = pbrSurfaceRadiance(material, irradiance, normal, viewVector);\n#endif\n\n#ifndef ENABLE_ES3\n    vec4 fragColor;\n#endif\n    // fragColor = vec4(material.baseColor, 1.0);\n    // fragColor = vec4(material.baseColor * irradiance, 1.0);\n    fragColor = vec4(radiance + (emission * material.baseColor), 1.0);\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n    fragColor.rgb = toGamma(fragColor.rgb * exposure);\n#endif\n\n#ifndef ENABLE_ES3\n    gl_FragColor = fragColor;\n#endif\n}\n'),this.finalize()}static getParamDeclarations(){const t=super.getParamDeclarations();return t.push({name:"BaseColor",defaultValue:new p(1,1,.5)}),t.push({name:"Metallic",defaultValue:0,range:[0,1]}),t.push({name:"Roughness",defaultValue:.85,range:[0,1]}),t.push({name:"Reflectance",defaultValue:.1,range:[0,1]}),t.push({name:"EmissiveStrength",defaultValue:0,range:[0,1]}),t}static getGeomDataShaderName(){return"StandardSurfaceGeomDataShader"}static getSelectedShaderName(){return"StandardSurfaceSelectedGeomsShader"}}N.registerClass("StandardSurfaceShader",Pe),ws.setShaderModule("GLSLBits.glsl",'\n    \n/////////////////////////////////////////////////////////////////\n// http://concord-consortium.github.io/lab/experiments/webgl-gpgpu/script.js\nfloat shift_right(float v, float amt) {\n  v = floor(v) + 0.5;\n  return floor(v / exp2(amt));\n}\nfloat shift_left(float v, float amt) {\n  return floor(v * exp2(amt) + 0.5);\n}\n\nfloat mask_last(float v, float bits) {\n  return mod(v, shift_left(1.0, bits));\n}\nfloat extract_bits(float num, float from, float to) {\n  from = floor(from + 0.5);\n  to = floor(to + 0.5);\n  return mask_last(shift_right(num, from), to - from);\n}\n\n/////////////////////////////////////////////////////////////////\n// https://stackoverflow.com/questions/18453302/how-do-you-pack-one-32bit-int-into-4-8bit-ints-in-glsl-webgl\n\nconst vec4 bitEnc = vec4(1.,255.,65025.,16581375.);\nconst vec4 bitDec = 1./bitEnc;\nvec4 EncodeFloatRGBA (float v) {\n    vec4 enc = bitEnc * v;\n    enc = fract(enc);\n    enc -= enc.yzww * vec2(1./255., 0.).xxxy;\n    return enc;\n}\nfloat DecodeFloatRGBA (vec4 v) {\n    return dot(v, bitDec);\n}\n\n\n\n/////////////////////////////////////////////////////////////////\n// https://gist.github.com/Flexi23/1713774\n// \nvec2 encode16BitFloatInto2xUInt8(float v){\n    vec2 c = vec2(0.);\n\n    int signum = (v >= 0.) ? 128 : 0;\n    v = abs(v);\n    int exponent = 15;\n    float limit = 1024.; // considering the bias from 2^-5 to 2^10 (==1024)\n    for(int exp = 15; exp > 0; exp--){\n        if( v < limit){\n            limit /= 2.;\n            exponent--;\n        }\n    }\n\n    float rest;\n    if(exponent == 0){\n        rest = v / limit / 2.;      // "subnormalize" implicite preceding 0. \n    }else{\n        rest = (v - limit)/limit;   // normalize accordingly to implicite preceding 1.\n    }\n\n    int mantissa = int(rest * 2048.);   // 2048 = 2^11 for the (split) 11 bit mantissa\n    int msb = mantissa / 256;           // the most significant 3 bits go into the lower part of the first byte\n    int lsb = mantissa - msb * 256;     // there go the other 8 bit of the lower significance\n\n    c.x = float(signum + exponent * 8 + msb) / 255.;    // color normalization for texture2D\n    c.y = float(lsb) / 255.;\n\n    if(v >= 2048.){\n        c.y = 1.;\n    }\n\n    return c;\n}\n\nfloat decode16BitFloatFrom2xUInt8(vec2 c){\n    float v = 0.;\n\n    int ix = int(c.x*255.); // 1st byte: 1 bit signum, 4 bits exponent, 3 bits mantissa (MSB)\n    int iy = int(c.y*255.); // 2nd byte: 8 bit mantissa (LSB)\n\n    int s = (c.x >= 0.5) ? 1 : -1;\n    ix = (s > 0) ? ix - 128 : ix;   // remove the signum bit from exponent\n    int iexp = ix / 8;              // cut off the last 3 bits of the mantissa to select the 4 exponent bits\n    int msb = ix - iexp * 8;        // subtract the exponent bits to select the 3 most significant bits of the mantissa\n\n    int norm = (iexp == 0) ? 0 : 2048;          // distinguish between normalized and subnormalized numbers\n    int mantissa = norm + msb * 256 + iy;       // implicite preceding 1 or 0 added here\n    norm = (iexp == 0) ? 1 : 0;                 // normalization toggle\n    float exponent = pow( 2., float(iexp + norm) - 16.); // -5 for the the exponent bias from 2^-5 to 2^10 plus another -11 for the normalized 12 bit mantissa \n    v = float( s * mantissa ) * exponent;\n\n    return v;\n}\n\n\n// TODO : Encoding Float32 to 4x UInt8\n// http://concord-consortium.github.io/lab/experiments/webgl-gpgpu/script.js\n// http://ultraist.hatenablog.com/entry/20110608/1307539319\n\n');class Ee extends Fs{constructor(t,i){super(t),this.__shaderStages.VERTEX_SHADER=ws.parseShader("StandardSurfaceGeomDataShader.vertexShader",'\nprecision highp float;\n\nattribute vec3 positions;\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\n\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="drawItemId.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n\n\nvarying float v_drawItemId;\nvarying vec4 v_geomItemData;\nvarying vec3 v_viewPos;\nvarying float v_drawItemID;\nvarying vec3 v_worldPos;\n\nvoid main(void) {\n  int drawItemId = getDrawItemId();\n  v_drawItemId = float(drawItemId);\n  v_geomItemData = getInstanceData(drawItemId);\n\n  vec4 pos = vec4(positions, 1.);\n  mat4 modelMatrix = getModelMatrix(drawItemId);\n  mat4 modelViewMatrix = viewMatrix * modelMatrix;\n  vec4 viewPos = modelViewMatrix * pos;\n  gl_Position = projectionMatrix * viewPos;\n\n  v_viewPos = -viewPos.xyz;\n\n  v_drawItemID = float(getDrawItemId());\n  \n  v_worldPos      = (modelMatrix * pos).xyz;\n}\n'),this.__shaderStages.FRAGMENT_SHADER=ws.parseShader("StandardSurfaceGeomDataShader.fragmentShader",'\nprecision highp float;\n\n<%include file="drawItemTexture.glsl"/>\n<%include file="cutaways.glsl"/>\n<%include file="GLSLBits.glsl"/>\n\nuniform int floatGeomBuffer;\nuniform int passId;\n\nuniform color cutColor;\nvec4 getCutaway(int id) {\n    return fetchTexel(instancesTexture, instancesTextureSize, (id * pixelsPerItem) + 5);\n}\n\nvarying float v_drawItemId;\nvarying vec4 v_geomItemData;\nvarying vec3 v_viewPos;\nvarying float v_drawItemID;\nvarying vec3 v_worldPos;\n\n\n#ifdef ENABLE_ES3\n    out vec4 fragColor;\n#endif\nvoid main(void) {\n  int drawItemId = int(v_drawItemId + 0.5);\n\n#ifndef ENABLE_ES3\n    vec4 fragColor;\n#endif\n\n  int flags = int(v_geomItemData.r + 0.5);\n  // Cutaways\n  if(testFlag(flags, GEOMITEM_FLAG_CUTAWAY)) {\n      vec4 cutAwayData   = getCutaway(drawItemId);\n      vec3 planeNormal = cutAwayData.xyz;\n      float planeDist = cutAwayData.w;\n      if(cutaway(v_worldPos, planeNormal, planeDist)){\n          discard;\n          return;\n      }\n      else if(!gl_FrontFacing){\n          fragColor = cutColor;\n  #ifndef ENABLE_ES3\n          gl_FragColor = fragColor;\n  #endif\n          return;\n      }\n  }\n\n    float dist = length(v_viewPos);\n\n    if(floatGeomBuffer != 0) {\n        fragColor.r = float(passId); \n        fragColor.g = float(v_drawItemID);\n        fragColor.b = 0.0;// TODO: store poly-id or something.\n        fragColor.a = dist;\n    }\n    else {\n        ///////////////////////////////////\n        // UInt8 buffer\n        fragColor.r = (mod(v_drawItemID, 256.) + 0.5) / 255.;\n        fragColor.g = (floor(v_drawItemID / 256.) + 0.5) / 255.;\n\n\n        // encode the dist as a 16 bit float\n        vec2 float16bits = encode16BitFloatInto2xUInt8(dist);\n        fragColor.b = float16bits.x;\n        fragColor.a = float16bits.y;\n    }\n\n\n#ifndef ENABLE_ES3\n    gl_FragColor = fragColor;\n#endif\n}\n')}}N.registerClass("StandardSurfaceGeomDataShader",Ee);class Qe extends Fs{constructor(t,i){super(t),this.__shaderStages.VERTEX_SHADER=ws.parseShader("StandardSurfaceSelectedGeomsShader.vertexShader",'\nprecision highp float;\n\nattribute vec3 positions;\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\n\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="drawItemId.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n\nvarying float v_drawItemId;\n\nvoid main(void) {\n    int drawItemId = getDrawItemId();\n    v_drawItemId = float(drawItemId);\n    mat4 modelMatrix = getModelMatrix(drawItemId);\n    mat4 modelViewMatrix = viewMatrix * modelMatrix;\n    vec4 viewPos = modelViewMatrix * vec4(positions, 1.0);\n    gl_Position = projectionMatrix * viewPos;\n\n}\n'),this.__shaderStages.FRAGMENT_SHADER=ws.parseShader("StandardSurfaceSelectedGeomsShader.fragmentShader",'\nprecision highp float;\n\nvarying float v_drawItemId;\n\n\n<%include file="drawItemTexture.glsl"/>\n\n#ifdef ENABLE_FLOAT_TEXTURES\nvec4 getHighlightColor(int id) {\n  return fetchTexel(instancesTexture, instancesTextureSize, (id * pixelsPerItem) + 4);\n}\n#else\n\nuniform vec4 highlightColor;\n\nvec4 getHighlightColor() {\n    return highlightColor;\n}\n\n#endif\n\n#ifdef ENABLE_ES3\n    out vec4 fragColor;\n#endif\nvoid main(void) {\n\n#ifndef ENABLE_ES3\n    vec4 fragColor;\n#endif\n    int drawItemId = int(v_drawItemId + 0.5);\n    fragColor = getHighlightColor(drawItemId);\n\n#ifndef ENABLE_ES3\n    gl_FragColor = fragColor;\n#endif\n}\n')}}N.registerClass("StandardSurfaceSelectedGeomsShader",Qe);class je extends Fs{constructor(t){super(t),this.__shaderStages.VERTEX_SHADER=ws.parseShader("HandleShader.vertexShader",'\nprecision highp float;\n\nattribute vec3 positions;\n#ifdef ENABLE_TEXTURES\nattribute vec2 texCoords;\n#endif\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\nuniform int maintainScreenSize;\n\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="drawItemId.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n\n/* VS Outputs */\nvarying vec3 v_viewPos;\n#ifdef ENABLE_TEXTURES\nvarying vec2 v_textureCoord;\n#endif\n\n\nvoid main(void) {\n  int drawItemId = getDrawItemId();\n  mat4 modelMatrix = getModelMatrix(drawItemId);\n  mat4 modelViewMatrix = viewMatrix * modelMatrix;\n\n  if(maintainScreenSize != 0) {\n    float dist = modelViewMatrix[3][2];\n    float sc = dist;\n    mat4 scmat = mat4(\n      sc, 0.0, 0.0, 0.0,\n      0.0, sc, 0.0, 0.0,\n      0.0, 0.0, sc, 0.0,\n      0.0, 0.0, 0.0, 1.0\n    );\n    modelViewMatrix = modelViewMatrix * scmat;\n  }\n\n  vec4 viewPos = modelViewMatrix * vec4(positions, 1.0);\n  gl_Position = projectionMatrix * viewPos;\n\n  v_viewPos = viewPos.xyz;\n  v_textureCoord = texCoords;\n  v_textureCoord.y = 1.0 - v_textureCoord.y;// Flip y\n}\n'),this.__shaderStages.FRAGMENT_SHADER=ws.parseShader("HandleShader.fragmentShader",'\nprecision highp float;\n\n<%include file="stack-gl/gamma.glsl"/>\n<%include file="materialparams.glsl"/>\n\nuniform color BaseColor;\n\n#ifdef ENABLE_TEXTURES\nuniform sampler2D BaseColorTex;\nuniform int BaseColorTexType;\n#endif\n\n/* VS Outputs */\nvarying vec3 v_viewPos;\n#ifdef ENABLE_TEXTURES\nvarying vec2 v_textureCoord;\n#endif\n\n\n#ifdef ENABLE_ES3\n    out vec4 fragColor;\n#endif\nvoid main(void) {\n\n#ifndef ENABLE_TEXTURES\n    vec4 baseColor = BaseColor;\n#else\n    vec4 baseColor      = getColorParamValue(BaseColor, BaseColorTex, BaseColorTexType, v_textureCoord);\n#endif\n\n#ifndef ENABLE_ES3\n    vec4 fragColor;\n#endif\n    fragColor = baseColor;\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n    fragColor.rgb = toGamma(fragColor.rgb);\n#endif\n\n#ifndef ENABLE_ES3\n    gl_FragColor = fragColor;\n#endif\n}\n'),this.finalize()}static getParamDeclarations(){const t=super.getParamDeclarations();return t.push({name:"BaseColor",defaultValue:new p(1,1,.5)}),t.push({name:"maintainScreenSize",defaultValue:0}),t}static isOverlay(){return!0}static getGeomDataShaderName(){return"HandleGeomDataShader"}}N.registerClass("HandleShader",je);class De extends Ee{constructor(t,i){super(t),this.__shaderStages.VERTEX_SHADER=ws.parseShader("HandleGeomDataShader.vertexShader",'\nprecision highp float;\n\nattribute vec3 positions;\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\nuniform int maintainScreenSize;\n\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="drawItemId.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n\n\nvarying float v_drawItemId;\nvarying vec4 v_geomItemData;\nvarying vec3 v_viewPos;\nvarying float v_drawItemID;\nvarying vec3 v_worldPos;\n\nvoid main(void) {\n  int drawItemId = getDrawItemId();\n  mat4 modelMatrix = getModelMatrix(drawItemId);\n  mat4 modelViewMatrix = viewMatrix * modelMatrix;\n  \n  if(maintainScreenSize != 0) {\n    float dist = modelViewMatrix[3][2];\n    float sc = dist;\n    mat4 scmat = mat4(\n      sc, 0.0, 0.0, 0.0,\n      0.0, sc, 0.0, 0.0,\n      0.0, 0.0, sc, 0.0,\n      0.0, 0.0, 0.0, 1.0\n    );\n    modelViewMatrix = modelViewMatrix * scmat;\n  }\n\n  vec4 viewPos = modelViewMatrix * vec4(positions, 1.0);\n  gl_Position = projectionMatrix * viewPos;\n\n  v_viewPos = -viewPos.xyz;\n\n  v_drawItemID = float(getDrawItemId());\n}\n')}}N.registerClass("HandleGeomDataShader",De);class Oe extends Fs{constructor(t){super(t),this.__shaderStages.VERTEX_SHADER=ws.parseShader("TransparentSurfaceShader.vertexShader",'\nprecision highp float;\n\n\nattribute vec3 positions;\nattribute vec3 normals;\n\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\n\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="stack-gl/inverse.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n\n/* VS Outputs */\nvarying vec3 v_viewPos;\nvarying vec3 v_viewNormal;\n\nvarying vec3 v_worldPos;\n/* VS Outputs */\n\nvoid main(void) {\n    int drawItemId = getDrawItemId();\n\n    vec4 geomItemData = getInstanceData(drawItemId);\n\n    vec4 pos = vec4(positions, 1.);\n    mat4 modelMatrix = getModelMatrix(drawItemId);\n    mat4 modelViewMatrix = viewMatrix * modelMatrix;\n    vec4 viewPos    = modelViewMatrix * pos;\n    gl_Position     = projectionMatrix * viewPos;\n\n    // mat4 mvp = projectionMatrix * viewMatrix * modelMatrix;\n    // gl_Position = mvp * vec4((lightmapCoords + geomItemData.xy), 0., 1.);\n\n    v_worldPos      = (modelMatrix * pos).xyz;\n\n    mat3 normalMatrix = mat3(transpose(inverse(modelViewMatrix)));\n    v_viewPos       = -viewPos.xyz;\n    v_viewNormal    = normalMatrix * normals;\n}\n'),this.__shaderStages.FRAGMENT_SHADER=ws.parseShader("TransparentSurfaceShader.fragmentShader",'\nprecision highp float;\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n<%include file="stack-gl/gamma.glsl"/>\n#endif\n<%include file="GLSLUtils.glsl"/>\n\n/* VS Outputs */\nvarying vec3 v_viewPos;\nvarying vec3 v_viewNormal;\n\nvarying vec3 v_worldPos;\n/* VS Outputs */\n\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\nuniform float exposure;\n#endif\n\nuniform mat4 cameraMatrix;\nuniform float planeDist;\nuniform float planeAngle;\n\nuniform color BaseColor;\nuniform float Opacity;\n\n#ifdef ENABLE_SPECULAR\n<%include file="math/constants.glsl"/>\n<%include file="GGX_Specular.glsl"/>\n<%include file="PBRSurfaceRadiance.glsl"/>\nuniform float Roughness;\nuniform float Metallic;\nuniform float Reflectance;\n#endif\n\n#ifdef __ENABLE_TEXTURES\nuniform sampler2D BaseColorTex;\nuniform bool BaseColorTexType;\n\nuniform sampler2D OpacityTex;\nuniform bool OpacityTexType;\n\nuniform sampler2D RoughnessTex;\nuniform bool RoughnessTexType;\n\nuniform sampler2D ReflectanceTex;\nuniform bool ReflectanceTexType;\n\nuniform sampler2D NormalTex;\nuniform bool NormalTexType;\nuniform float NormalScale;\n\n\n#endif\n\n#ifdef ENABLE_ES3\n    out vec4 fragColor;\n#endif\nvoid main(void) {\n\n    MaterialParams material;\n\n#ifndef __ENABLE_TEXTURES\n    material.baseColor      = BaseColor.rgb;\n    float opacity           = Opacity;\n\n#ifdef ENABLE_SPECULAR\n    material.roughness      = Roughness;\n    material.metallic       = Metallic;\n    material.reflectance    = Reflectance;\n#endif\n\n#else\n    // Planar YZ projection for texturing, repeating every meter.\n    // vec2 texCoord        = v_worldPos.xz * 0.2;\n    vec2 texCoord           = vec2(v_textureCoord.x, 1.0 - v_textureCoord.y);\n    material.baseColor      = getColorParamValue(BaseColor, BaseColorTex, BaseColorTexType, texCoord).rgb;\n    material.roughness      = getLuminanceParamValue(Roughness, RoughnessTex, RoughnessTexType, texCoord);\n    material.metallic       = getLuminanceParamValue(Metallic, MetallicTex, MetallicTexType, texCoord);\n    material.reflectance    = Reflectance;//getLuminanceParamValue(Reflectance, ReflectanceTex, ReflectanceTexType, texCoord);\n\n    float opacity           = getLuminanceParamValue(Opacity, OpacityTex, OpacityTexType, texCoords);\n#endif\n\n#ifndef ENABLE_SPECULAR\n    gl_FragColor = vec4(material.baseColor.rgb, opacity);\n#else\n\n    vec3 viewNormal = normalize(v_viewNormal);\n    //vec3 surfacePos = -v_viewPos;\n\n#ifdef __ENABLE_TEXTURES\n    if(NormalTexType != 0){\n        vec3 textureNormal_tangentspace = normalize(texture2D(NormalTex, texCoord).rgb * 2.0 - 1.0);\n        viewNormal = normalize(mix(viewNormal, textureNormal_tangentspace, 0.3));\n    }\n#endif\n\n    vec3 viewVector = normalize(mat3(cameraMatrix) * normalize(v_viewPos));\n    vec3 normal = normalize(mat3(cameraMatrix) * viewNormal);\n    if(dot(normal, viewVector) < 0.0){\n        normal = -normal;\n        // Note: this line can be used to debug inverted meshes.\n        //material.baseColor = vec3(1.0, 0.0, 0.0);\n    }\n\n    vec4 specularReflectance = pbrSpecularReflectance(material, normal, viewVector);\n\n#ifndef ENABLE_ES3\n    vec4 fragColor;\n#endif\n\n    fragColor = vec4(specularReflectance.rgb, mix(opacity, 1.0, specularReflectance.a));\n\n#endif\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n    fragColor.rgb = toGamma(fragColor.rgb * exposure);\n#endif\n\n#ifndef ENABLE_ES3\n    gl_FragColor = fragColor;\n#endif\n}\n'),this.finalize()}static getParamDeclarations(){const t=super.getParamDeclarations();return t.push({name:"BaseColor",defaultValue:new p(1,1,.5)}),t.push({name:"Opacity",defaultValue:1,range:[0,1]}),t.push({name:"Roughness",defaultValue:.85}),t.push({name:"Reflectance",defaultValue:1e-4}),t}static getGeomDataShaderName(){return"StandardSurfaceGeomDataShader"}static getSelectedShaderName(){return"StandardSurfaceSelectedGeomsShader"}static isTransparent(){return!0}bind(t,i){return"ADD"==t.pass&&super.bind(t,i)}}N.registerClass("TransparentSurfaceShader",Oe);class Ae extends Fs{constructor(t){super(t),this.__shaderStages.VERTEX_SHADER=ws.parseShader("ScreenSpaceShader.vertexShader",'\nprecision highp float;\n\nattribute vec3 positions;\n#ifdef ENABLE_TEXTURES\nattribute vec2 texCoords;\n#endif\n\n<%include file="stack-gl/transpose.glsl"/>\n<%include file="drawItemId.glsl"/>\n<%include file="drawItemTexture.glsl"/>\n<%include file="modelMatrix.glsl"/>\n\n/* VS Outputs */\n#ifdef ENABLE_TEXTURES\nvarying vec2 v_textureCoord;\n#endif\n\n\nvoid main(void) {\n  int drawItemId = getDrawItemId();\n    mat4 modelMatrix = getModelMatrix(drawItemId);\n\n    gl_Position = (modelMatrix * vec4(positions, 1.0));\n\n    v_textureCoord = texCoords;\n    v_textureCoord.y = 1.0 - v_textureCoord.y;// Flip y\n}\n'),this.__shaderStages.FRAGMENT_SHADER=ws.parseShader("ScreenSpaceShader.fragmentShader",'\nprecision highp float;\n\n<%include file="stack-gl/gamma.glsl"/>\n<%include file="materialparams.glsl"/>\n\nuniform color BaseColor;\n\n#ifdef ENABLE_TEXTURES\nuniform sampler2D BaseColorTex;\nuniform int BaseColorTexType;\n#endif\n\n/* VS Outputs */\n#ifdef ENABLE_TEXTURES\nvarying vec2 v_textureCoord;\n#endif\n\n\n#ifdef ENABLE_ES3\n    out vec4 fragColor;\n#endif\nvoid main(void) {\n\n#ifndef ENABLE_TEXTURES\n    vec4 baseColor = BaseColor;\n#else\n    vec4 baseColor      = getColorParamValue(BaseColor, BaseColorTex, BaseColorTexType, v_textureCoord);\n#endif\n\n#ifndef ENABLE_ES3\n    vec4 fragColor;\n#endif\n    fragColor = baseColor;\n\n#ifdef ENABLE_INLINE_GAMMACORRECTION\n    fragColor.rgb = toGamma(fragColor.rgb);\n#endif\n\n#ifndef ENABLE_ES3\n    gl_FragColor = fragColor;\n#endif\n}\n'),this.finalize()}static isOverlay(){return!0}static getParamDeclarations(){const t=super.getParamDeclarations();return t.push({name:"BaseColor",defaultValue:new p(1,1,.5)}),t}static getGeomDataShaderName(){return null}static getSelectedShaderName(){return null}}N.registerClass("ScreenSpaceShader",Ae);class _e extends Ke{constructor(t){super(t),this.invisibleToGeomBuffer=!0}}N.registerClass("ToolIconShader",_e);class qe extends Fs{constructor(t){super(t),this.__shaderStages.VERTEX_SHADER=ws.parseShader("UnpackLDRAlphaImageShader.vertexShader",'\nprecision highp float;\n\n<%include file="utils/quadVertexFromID.glsl"/>\n\n/* VS Outputs */\nvarying vec2 v_texCoord;\n \nvoid main()\n{\n    vec2 position = getQuadVertexPositionFromID();\n    v_texCoord = position+0.5;\n    gl_Position = vec4(position*2.0, 0.0, 1.0);\n}\n'),this.__shaderStages.FRAGMENT_SHADER=ws.parseShader("UnpackLDRAlphaImageShader.fragmentShader","\nprecision highp float;\n\nvarying vec2 v_texCoord;\nuniform sampler2D ldrSampler;\nuniform sampler2D alphaSampler;\n\nfloat luminanceFromRGB(vec3 rgb) {\n    return 0.2126*rgb.r + 0.7152*rgb.g + 0.0722*rgb.b;\n}\n\n\n#ifdef ENABLE_ES3\n    out vec4 fragColor;\n#endif\nvoid main(void) {\n\n#ifndef ENABLE_ES3\n    vec4 fragColor;\n#endif\n\n    fragColor = vec4(texture2D(ldrSampler, v_texCoord).rgb, luminanceFromRGB(texture2D(alphaSampler, v_texCoord).rgb));\n\n#ifndef ENABLE_ES3\n    gl_FragColor = fragColor;\n#endif\n}\n\n")}}class $e extends Fs{constructor(t){super(t),this.__shaderStages.VERTEX_SHADER=ws.parseShader("WireShader.vertexShader","\nprecision highp float;\n\nattribute vec3 positions;    //(location = 0)\n\nuniform mat4 modelMatrix;\nuniform mat4 viewMatrix;\nuniform mat4 projectionMatrix;\n\n/* VS Outputs */\n\nvoid main(void) {\n    mat4 modelViewProjectionMatrix = projectionMatrix * viewMatrix * modelMatrix;\n    gl_Position = modelViewProjectionMatrix * vec4(positions, 1.0);\n\n    // Apply the perspective transform, and then move the vertices\n    //  towards the camera by a tiny little bit...\n    gl_Position.z -= 0.001 / gl_Position.w;\n    //gl_Position.z *= 0.999;\n}\n"),this.__shaderStages.FRAGMENT_SHADER=ws.parseShader("WireShader.fragmentShader","\nprecision highp float;\n\nuniform color wireColor;\n\n#ifdef ENABLE_ES3\n    out vec4 fragColor;\n#endif\nvoid main(void) {\n#ifdef ENABLE_ES3\n    gl_FragColor = color;\n#else\n    fragColor = color;\n#endif  \n}\n")}}class tn{constructor(t,i,s,e,n=null){this.gl=t,this.geomItem=i,this.glGeom=s,this.id=e,this.flags=n,this.visible=this.geomItem.getVisible(),this.culled=!1,this.lightmapName=i.getLightmapName(),this.updated=new v,this.visibilityChanged=new v,this.highlightChanged=i.highlightChanged,this.updateVisibility=this.updateVisibility.bind(this),this.updateVisibility=this.updateVisibility.bind(this),this.destroy=this.destroy.bind(this),this.updateXfo=t.floatTexturesSupported?()=>{this.updated.emit(0)}:()=>{this.updateGeomMatrix()},this.geomItem.geomXfoChanged.connect(this.updateXfo),this.geomItem.visibilityChanged.connect(this.updateVisibility),this.geomItem.cutAwayChanged.connect(()=>{this.updated.emit(0)}),this.highlightChangedId=this.geomItem.highlightChanged.connect(()=>{this.updated.emit(3)}),this.glGeom.updated.connect(()=>{this.updated.emit(1)});const l=this.geomItem.getLightmapCoordsOffset();this.geomData=[l.x,l.y,0,0]}getGeomItem(){return this.geomItem}getGLGeom(){return this.glGeom}getVisible(){return this.geomItem.getVisible()}getId(){return this.id}getFlags(){return this.flags}updateVisibility(){const t=this.geomItem.getVisible()&&!this.culled;this.visible!=t&&(this.visible=t,this.visibilityChanged.emit(t),this.updated.emit())}setCullState(t){this.culled=t,this.updateVisibility()}updateGeomMatrix(){this.modelMatrixArray=this.geomItem.getGeomMat4().asArray()}getGeomMatrixArray(){return this.modelMatrixArray}bind(t){const i=this.gl,s=t.unifs;if(!i.floatTexturesSupported){const t=s.modelMatrix;t&&i.uniformMatrix4fv(t.location,!1,this.modelMatrixArray);const e=s.drawItemData;e&&i.uniform4f(e.location,this.geomData)}const e=s.transformIndex;if(e&&i.uniform1i(e.location,this.id),t.lightmaps&&s.lightmap&&t.boundLightmap!=this.lightmapName){const e=t.lightmaps[this.lightmapName];e&&e.glimage.isLoaded()?(e.glimage.bindToUniform(t,s.lightmap),i.uniform2fv(s.lightmapSize.location,e.atlasSize.asArray()),s.lightmapConnected&&i.uniform1i(s.lightmapConnected.location,!0),t.boundLightmap=this.lightmapName):s.lightmapConnected&&i.uniform1i(s.lightmapConnected.location,!1)}return!0}destroy(){this.geomItem.visibilityChanged.disconnect(this.updateVisibility),this.geomItem.geomXfoChanged.disconnect(this.updateXfo),this.geomItem.highlightChanged.disconnectId(this.highlightChangedId)}}class sn extends ge{constructor(){super(),this.__drawItems=[void 0],this.__drawItemsIndexFreeList=[],this.__dirtyItemIndices=[]}init(t,i){super.init(t,i),this.__renderer.registerPass(t=>{if(t instanceof _i){if(t.getMetadata("glgeomItem"))return!1;{const i=i=>!!this.filterGeomItem(i)&&(null==t.getGeometry()?t.geomAssigned.connect(()=>{this.addGeomItem(i)}):this.addGeomItem(i),!0);return null==t.getMaterial()?(console.warn("Scene item :"+t.getPath()+" has no material"),!1):i(t)}}return!1},t=>!!(t instanceof _i&&t.getMetadata("glgeomItem"))&&this.removeGeomItem(t))}filterGeomItem(t){return!0}addShader(t){return this.__renderer.getOrCreateShader(t.getShaderName())}constructShaders(t){let i,s;const e=this.__renderer.getOrCreateShader(t);return e.constructor.getGeomDataShaderName()&&(i=this.__renderer.getOrCreateShader(e.constructor.getGeomDataShaderName())),e.constructor.getSelectedShaderName()&&(s=this.__renderer.getOrCreateShader(e.constructor.getSelectedShaderName())),{glshader:e,glgeomdatashader:i,glselectedshader:s}}addMaterial(t){let i=t.getMetadata("glmaterial");if(i)return i;const s=this.__renderer.getOrCreateShader(t.getShaderName());return i=new Qs(this.__gl,t,s),i.updated.connect(()=>{this.__renderer.requestRedraw()}),t.setMetadata("glmaterial",i),i}addGeom(t){let i=t.getMetadata("glgeom");if(i)return i.addRef(this),i;const s=this.__gl;if(t instanceof Ii||t instanceof vi)i=new Ys(s,t);else if(t instanceof Wi||t instanceof xi)i=new Ms(s,t);else{if(!(t instanceof Ri||t instanceof Li))throw new Error("Unsupported geom type:"+t.constructor.name);i=new Ks(s,t)}return t.setMetadata("glgeom",i),i.addRef(this),i}removeGeom(t){let i=t.getMetadata("glgeom");if(i)return i.removeRef(this),i}addGeomItem(t){const i=this.addGeom(t.getGeometry());let s;this.__drawItemsIndexFreeList.length>0?s=this.__drawItemsIndexFreeList.pop():(s=this.__drawItems.length,this.__drawItems.push(null)),this.__dirtyItemIndices.push(s);const e=new tn(this.__gl,t,i,s,1);return t.setMetadata("glgeomItem",e),e.updated.connect(t=>{switch(t){case 0:if(-1!=this.__dirtyItemIndices.indexOf(s))return;this.__dirtyItemIndices.push(s);break;case 1:case 2:break;case 3:if(-1!=this.__dirtyItemIndices.indexOf(s))return;return this.__dirtyItemIndices.push(s),void this.__renderer.requestRedraw()}this.__renderer.drawItemChanged()}),this.__drawItems[s]=e,this.__renderer.requestRedraw(),t.setMetadata("glpass",this),e}removeGeomItem(t){if(t.getMetadata("glpass")!=this)return;const i=t.getMetadata("glgeomItem"),s=i.getId();return this.__drawItems[s]=null,this.__drawItemsIndexFreeList.push(s),this.__renderer.requestRedraw(),t.getMetadata("glpass"),t.deleteMetadata("glgeomItem"),i}removeGLGeom(t,i){const s=i.geomItemMappings.indexOf(t);i.geomItemMappings.splice(s,1)}getGeomItem(t){if(!(t>=this.__drawItems.length))return this.__drawItems[t];console.warn("Invalid Draw Item id:"+t+" NumItems:"+(this.__drawItems.length-1))}__populateDrawItemDataArray(t,i,s){const e=24*i;let n=0;t.isCutawayEnabled()&&(n|=1);const l=t.getLightmapCoordsOffset();m.createFromFloat32Buffer(s.buffer,e+0).set(n,0,l.x,l.y);const h=t.getGeomMat4(),o=m.createFromFloat32Buffer(s.buffer,e+4),a=m.createFromFloat32Buffer(s.buffer,e+8),c=m.createFromFloat32Buffer(s.buffer,e+12);o.set(h.xAxis.x,h.yAxis.x,h.zAxis.x,h.translation.x),a.set(h.xAxis.y,h.yAxis.y,h.zAxis.y,h.translation.y),c.set(h.xAxis.z,h.yAxis.z,h.zAxis.z,h.translation.z);const r=m.createFromFloat32Buffer(s.buffer,e+16);if(t.isHighlighted()){const i=t.getHighlight();r.set(i.r,i.g,i.b,i.a)}const d=m.createFromFloat32Buffer(s.buffer,e+20);if(t.isCutawayEnabled()){const i=t.getCutVector(),s=t.getCutDist();d.set(i.x,i.y,i.z,s)}}newItemsReadyForLoading(){return this.__dirtyItemIndices.length>0}uploadGeomItems(){const t=this.__gl;if(!t.floatTexturesSupported){const t=this.__dirtyItemIndices.length;for(let i=0;i<t;i++){const t=this.__drawItems[this.__dirtyItemIndices[i]];t&&t.updateGeomMatrix()}return void(this.__dirtyItemIndices=[])}let i=Math.round(Math.sqrt(6*this.__drawItems.length)+.5);i=Math.nextPow2(i),i%6!=0&&(i+=6-i%6),this.__drawItemsTexture?this.__drawItemsTexture.width!=i&&(this.__drawItemsTexture.resize(i,i),this.__dirtyItemIndices=Array(i*i/6).fill().map((t,i)=>i)):(this.__drawItemsTexture=new Is(t,{format:"RGBA",type:"FLOAT",width:i,height:i,filter:"NEAREST",wrap:"CLAMP_TO_EDGE",mipMapped:!1}),this.__drawItemsTexture.clear()),t.bindTexture(t.TEXTURE_2D,this.__drawItemsTexture.glTex);const s=this.__drawItemsTexture.getTypeID();for(let e=0;e<this.__dirtyItemIndices.length;e++){const n=this.__dirtyItemIndices[e],l=Math.floor(6*n/i);let h=n+1;for(let t=e+1;t<this.__dirtyItemIndices.length;t++){const s=this.__dirtyItemIndices[t];if(Math.floor(6*s/i)!=l)break;if(s!=h)break;h++}const o=h-n,a=6*n%i,c=6*o,r=1,d=new Float32Array(24*o);for(let t=n;t<h;t++){const i=this.__drawItems[t];i&&this.__populateDrawItemDataArray(i.getGeomItem(),t-n,d)}if(s==t.FLOAT)this.__drawItemsTexture.populate(d,c,r,a,l,!1);else{const t=Math.convertFloat32ArrayToUInt16Array(d);this.__drawItemsTexture.populate(t,c,r,a,l,!1)}e+=o-1}this.__dirtyItemIndices=[]}finalize(){0!=this.__dirtyItemIndices.length&&this.uploadGeomItems()}bind(t){const i=this.__gl,s=t.unifs;return this.__drawItemsTexture&&s.instancesTexture&&(this.__drawItemsTexture.bindToUniform(t,s.instancesTexture),i.uniform1i(s.instancesTextureSize.location,this.__drawItemsTexture.width)),!0}bindShader(t,i){return!!i.bind(t,this.constructor.name)&&!!this.bind(t)}bindMaterial(t,i,s){return i.bind(t,s)}}class en{constructor(t,i){this.gl=t,this.glgeom=i,this.glgeomItems=[],this.glgeomItems_freeIndices=[],this.glgeomItemSignalIds=[],this.drawIdsArray=null,this.drawIdsBuffer=null,this.drawIdsBufferDirty=!0,this.highlightedIdsArray=null,this.highlightedIdsBuffer=null,this.highlightedIdsBufferDirty=!0,this.lightmapName=void 0,this.drawCountChanged=new v,this.visibleItems=[],this.highlightedItems=[]}getGLGeom(){return this.glgeom}getLightmapName(){return this.lightmapName}getDrawCount(){return this.visibleItems.length}addGeomItem(t){let i;this.glgeomItems_freeIndices.length>0?i=this.glgeomItems_freeIndices.pop():(i=this.glgeomItems.length,this.glgeomItems.push(null)),t.visible&&(this.visibleItems.push(i),this.drawCountChanged.emit(1)),t.getGeomItem().isHighlighted()&&(this.highlightedItems.push(i),this.highlightedIdsBufferDirty=!0),1==this.glgeomItems.length&&(this.lightmapName=t.getGeomItem().getLightmapName());const s={};s.sel=t.highlightChanged.connect(()=>{if(t.getGeomItem().isHighlighted()){if(-1!=this.highlightedItems.indexOf(i))return;this.highlightedItems.push(i)}else this.highlightedItems.splice(this.highlightedItems.indexOf(i),1);this.highlightedIdsBufferDirty=!0}),s.vis=t.visibilityChanged.connect(t=>{t?(this.visibleItems.push(i),this.drawCountChanged.emit(1)):(this.visibleItems.splice(this.visibleItems.indexOf(i),1),this.drawCountChanged.emit(-1)),this.drawIdsBufferDirty=!0}),this.glgeomItems[i]=t,this.glgeomItemSignalIds[i]=s,this.drawIdsBufferDirty=!0}removeGeomItem(t){const i=this.glgeomItems.indexOf(t),s=this.glgeomItemSignalIds[i];t.highlightChanged.disconnectId(s.sel),t.visibilityChanged.disconnectId(s.vis),this.glgeomItems[i]=null,this.glgeomItemSignalIds[i]=null,this.glgeomItems_freeIndices.push(i),t.visible&&(this.visibleItems.splice(this.visibleItems.indexOf(i),1),this.drawCountChanged.emit(-1)),t.getGeomItem().isHighlighted()&&this.highlightedItems.splice(this.highlightedItems.indexOf(i),1),this.drawIdsBufferDirty=!0,0==this.glgeomItems.length&&this.destroy()}updateDrawIDsBuffer(){const t=this.gl;t.floatTexturesSupported?(this.drawIdsBuffer&&this.glgeomItems.length!=this.drawIdsArray.length&&(this.gl.deleteBuffer(this.drawIdsBuffer),this.drawIdsBuffer=null),this.drawIdsBuffer||(this.drawIdsArray=new Float32Array(this.glgeomItems.length),this.drawIdsBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.drawIdsBuffer)),this.visibleItems.forEach((t,i)=>{this.drawIdsArray[i]=this.glgeomItems[t].getId()}),t.bindBuffer(t.ARRAY_BUFFER,this.drawIdsBuffer),t.bufferData(t.ARRAY_BUFFER,this.drawIdsArray,t.STATIC_DRAW),this.drawIdsBufferDirty=!1):this.drawIdsBufferDirty=!1}updateHighlightedIDsBuffer(){const t=this.gl;t.floatTexturesSupported?(this.highlightedIdsBuffer&&this.glgeomItems.length!=this.highlightedIdsArray.length&&(this.gl.deleteBuffer(this.highlightedIdsBuffer),this.highlightedIdsBuffer=null),(!this.highlightedIdsArray||this.highlightedItems.length>this.highlightedIdsArray.length)&&(this.highlightedIdsArray=new Float32Array(this.highlightedItems.length),this.highlightedIdsBuffer&&(t.deleteBuffer(this.highlightedIdsBuffer),this.highlightedIdsBuffer=null)),this.highlightedItems.forEach((t,i)=>{this.highlightedIdsArray[i]=this.glgeomItems[t].getId()}),this.highlightedIdsBuffer||(this.highlightedIdsBuffer=t.createBuffer()),t.bindBuffer(t.ARRAY_BUFFER,this.highlightedIdsBuffer),t.bufferData(t.ARRAY_BUFFER,this.highlightedIdsArray,t.STATIC_DRAW),this.highlightedIdsBufferDirty=!1):this.highlightedIdsBufferDirty=!1}draw(t){if(0==this.visibleItems.length)return;this.drawIdsBufferDirty&&this.updateDrawIDsBuffer();const i=this.gl,s=t.unifs;if(t.lightmaps&&s.lightmap&&t.boundLightmap!=this.lightmapName){const e=t.lightmaps[this.lightmapName];e&&e.glimage.isLoaded()?(e.glimage.bindToUniform(t,s.lightmap),i.uniform2fv(s.lightmapSize.location,e.atlasSize.asArray()),s.lightmapConnected&&i.uniform1i(s.lightmapConnected.location,!0),t.boundLightmap=this.lightmapName):s.lightmapConnected&&i.uniform1i(s.lightmapConnected.location,!1)}this.__bindAndRender(t,this.visibleItems,this.drawIdsBuffer)}drawHighlighted(t){0!=this.highlightedItems.length&&(this.highlightedIdsBufferDirty&&this.updateHighlightedIDsBuffer(),this.__bindAndRender(t,this.highlightedItems,this.highlightedIdsBuffer))}__bindAndRender(t,i,s){const e=this.gl,n=t.unifs;if(t.glgeom!=this.glgeom&&(this.glgeom.bind(t),t.glgeom=this.glgeom),e.floatTexturesSupported&&e.drawElementsInstanced&&t.supportsInstancing){e.uniform1i(t.unifs.instancedDraw.location,1);const l=t.attrs.instancedIds.location;e.enableVertexAttribArray(l),e.bindBuffer(e.ARRAY_BUFFER,s),e.vertexAttribPointer(l,1,e.FLOAT,!1,4,0),e.vertexAttribDivisor(l,1),t.bindViewports(n,()=>{this.glgeom.drawInstanced(i.length)})}else t.unifs.instancedDraw&&e.uniform1i(t.unifs.instancedDraw.location,0),i.forEach(i=>{this.glgeomItems[i].bind(t),t.bindViewports(n,()=>{this.glgeom.draw(t)})})}destroy(){}}class nn{constructor(t){this.glshader=t.glshader,this.glgeomdatashader=t.glgeomdatashader,this.glselectedshader=t.glselectedshader,this.glmaterialGeomItemSets=[]}findMaterialGeomItemSets(t){for(const i of this.glmaterialGeomItemSets)if(i.glmaterial==t)return i}addMaterialGeomItemSets(t){this.glmaterialGeomItemSets.push(t)}removeMaterialGeomItemSets(t){const i=this.glmaterialGeomItemSets.indexOf(t);this.glmaterialGeomItemSets.splice(i,1)}getMaterialGeomItemSets(){return this.glmaterialGeomItemSets}}class ln{constructor(t){this.glmaterial=t,this.geomItemSets=[],this.drawCount=0,this.visibleInGeomDataBuffer=t.getMaterial().visibleInGeomDataBuffer,this.__drawCountChanged=this.__drawCountChanged.bind(this)}getGLMaterial(){return this.glmaterial}__drawCountChanged(t){this.drawCount+=t}addGeomItemSet(t){-1==this.geomItemSets.indexOf(t)?(this.geomItemSets.push(t),this.drawCount+=t.drawCount,t.drawCountChanged.connect(this.__drawCountChanged)):console.warn("geomItemSet already added to GLMaterialGeomItemSets")}removeGeomItemSet(t){const i=this.geomItemSets.indexOf(t);this.geomItemSets.splice(i,1),t.drawCountChanged.disconnect(this.__drawCountChanged),t.destroy()}findGeomItemSet(t){for(const i of this.geomItemSets)if(i.getGLGeom()==t)return i;return null}getGeomItemSets(){return this.geomItemSets}}class hn extends sn{constructor(){super(),this.__glshadermaterials={}}init(t,i){super.init(t,i)}filterGeomItem(t){const i=t.getMaterial().getShaderClass();if(i){if(i.isTransparent())return!1;if(i.isOverlay())return!1;const s=t.getMaterial().getParameter("BaseColor");return!(s&&s.getValue().a<1)}return!1}addGeomItem(t){const i=t.getMaterial(),s=i.getShaderName(),e=this.constructShaders(s),n=this.addMaterial(i),l=super.addGeomItem(t);let h=this.__glshadermaterials[s];h||(h=new nn(e),this.__glshadermaterials[s]=h);let o=h.findMaterialGeomItemSets(n);o||(o=new ln(n),h.addMaterialGeomItemSets(o));let a=o.findGeomItemSet(l.glGeom);return a||(a=new en(this.__gl,l.glGeom),o.addGeomItemSet(a)),t.setMetadata("geomItemSet",a),a.addGeomItem(l),!0}removeGeomItem(t){const i=super.removeGeomItem(t);if(!i)return!1;const s=t.getMetadata("geomItemSet");return s&&(s.removeGeomItem(i),t.deleteMetadata("geomItemSet")),!0}removeMaterial(t){const i=this.__glshadermaterials[t.hash];if(!i||i!=t.getMetadata("glshaderMaterials"))return void console.warn("Material not found in pass");const s=t.getMetadata("glmaterialGeomItemSets");i.removeMaterialGeomItemSets(s)}__traverseTreeAndDraw(t){for(const i in this.__glshadermaterials){const s=this.__glshadermaterials[i],e=s.glshader;if(this.bindShader(t,e)){const i=s.getMaterialGeomItemSets();for(const s of i)if(0!=s.drawCount&&this.bindMaterial(t,s.getGLMaterial(),!0)){const i=s.getGeomItemSets();for(const s of i)s.draw(t)}}e.unbind(t)}t.glgeom&&t.glgeom.unbind(t)}draw(t){this.newItemsReadyForLoading()&&this.finalize();const i=this.__gl;i.disable(i.BLEND),i.disable(i.CULL_FACE),i.enable(i.DEPTH_TEST),i.depthFunc(i.LESS),i.depthMask(!0),this.__traverseTreeAndDraw(t)}drawHighlightedGeoms(t){const i=this.__gl;i.disable(i.CULL_FACE);for(const i in this.__glshadermaterials){const s=this.__glshadermaterials[i];if(!s.glselectedshader)continue;if(!this.bindShader(t,s.glselectedshader))continue;const e=s.getMaterialGeomItemSets();for(const i of e){const s=i.getGeomItemSets();for(const i of s)i.drawHighlighted(t)}}t.glgeom&&t.glgeom.unbind(t)}getGeomItemAndDist(t){let i,s;this.__gl.floatGeomBuffer?(i=Math.round(t[1]),s=t[3]):(i=t[0]+(t[1]<<8),s=Math.decode16BitFloatFrom2xUInt8([t[2],t[3]]));const e=this.__drawItems[i];if(e)return{geomItem:e.getGeomItem(),dist:s}}drawGeomData(t){this.newItemsReadyForLoading()&&this.finalize();const i=this.__gl;i.disable(i.BLEND),i.disable(i.CULL_FACE),i.enable(i.DEPTH_TEST),i.depthFunc(i.LESS),i.depthMask(!0);for(const s in this.__glshadermaterials){const e=this.__glshadermaterials[s];if(!e.glgeomdatashader)continue;if(!this.bindShader(t,e.glgeomdatashader))continue;{const s=t.unifs.floatGeomBuffer;s&&i.uniform1i(s.location,i.floatGeomBuffer?1:0)}{const s=t.unifs.passId;s&&i.uniform1i(s.location,this.__passIndex)}const n=e.getMaterialGeomItemSets();for(const i of n)if(0!=i.drawCount&&i.visibleInGeomDataBuffer&&this.bindMaterial(t,i.getGLMaterial(),!1)){const s=i.getGeomItemSets();for(const i of s)i.draw(t)}}t.glgeom&&t.glgeom.unbind(t)}}Ie.registerPass(hn,Ve.OPAQUE);class on extends sn{constructor(){super()}init(t,i){super.init(t,i),this.transparentItems=[],this.freeList=[],this.visibleItems=[],this.prevSortCameraPos=new u(999,999,999),this.resort=!1}filterGeomItem(t){const i=t.getMaterial().getShaderClass();if(i){if(i.isTransparent())return!0;if(i.isOverlay())return!1;const s=t.getMaterial().getParameter("BaseColor");if(s&&s.getValue().a<.999)return!0}return!1}addGeomItem(t){const i=t.getMaterial(),s=i.getShaderName(),e=this.constructShaders(s),n=this.addMaterial(i),l=super.addGeomItem(t),h=t.visibilityChanged.connect(t=>{if(t)this.visibleItems.push(a);else{const t=this.visibleItems.indexOf(a);this.visibleItems.splice(t,1)}}),o=t.geomXfoChanged.connect(()=>{this.resort=!0}),a={geomItem:t,shaders:e,glmaterial:n,glgeomitem:l,visibilityChangedId:h,geomXfoChangedId:o};let c;c=this.freeList.length>0?this.freeList.pop():this.transparentItems.length,this.transparentItems[c]=a,t.setMetadata("itemIndex",c),t.getVisible()&&this.visibleItems.push(a),this.resort=!0}removeGeomItem(t){if(!super.removeGeomItem(t))return;const i=t.getMetadata("itemIndex"),s=this.transparentItems[i];this.transparentItems[i]=null,this.freeList.push(i);const e=this.visibleItems.indexOf(s);-1!=e&&this.visibleItems.splice(e,1)}sortItems(t){for(const i of this.visibleItems){const s=i.glgeomitem.geomItem.getGeomMat4();i.dist=s.translation.distanceTo(t)}this.visibleItems.sort((t,i)=>t.dist>i.dist?-1:t.dist<i.dist?1:0),this.prevSortCameraPos=t,this.resort=!1}_drawItem(t,i,s){if(s.currentglMaterial!=i.glmaterial&&(s.currentglMaterial=i.glmaterial,!s.currentglMaterial.bind(t)))return;const e=i.glgeomitem;if((s.currentglGeom==e.glGeom||(s.currentglGeom=e.glGeom,s.currentglGeom.bind(t)))&&e.bind(t)){if(t.unifs.instancedDraw){const i=this.__gl;i.uniform1i(t.unifs.instancedDraw.location,0),i.disableVertexAttribArray(t.attrs.instancedIds.location)}t.bindViewports(t.unifs,()=>{s.currentglGeom.draw(t)})}}_drawItems(t){const i={currentglShader:null,currentglMaterial:null,currentglGeom:null};for(const s of this.visibleItems){if(i.currentglShader!=s.shaders.glshader){if(!this.bindShader(t,s.shaders.glshader))continue;i.currentglShader=s.shaders.glshader}this._drawItem(t,s,i)}i.currentglGeom&&i.currentglGeom.unbind(t)}draw(t){if(0==this.visibleItems.length)return;this.newItemsReadyForLoading()&&this.finalize();const i=this.__gl,s=t.viewXfo.tr;(this.resort||s.distanceTo(this.prevSortCameraPos)>.3)&&this.sortItems(s),i.enable(i.DEPTH_TEST),i.depthFunc(i.LESS),i.depthMask(!0),i.enable(i.BLEND),i.blendEquation(i.FUNC_ADD),t.pass="MULTIPLY",i.blendFunc(i.DST_COLOR,i.ZERO),this._drawItems(t),t.pass="ADD",i.blendFunc(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA),this._drawItems(t),i.disable(i.BLEND)}drawHighlightedGeoms(t){const i=this.__gl;i.disable(i.CULL_FACE);const s={currentglShader:null,currentglMaterial:null,currentglGeom:null};for(const i of this.visibleItems){if(!i.geomItem.isHighlighted())continue;if(!i.shaders.glselectedshader)continue;const e=i.shaders;if(s.currentglShader!=e.glselectedshader){if(!this.bindShader(t,e.glselectedshader))continue;s.currentglShader=e.glselectedshader}this._drawItem(t,i,s)}s.currentglGeom&&s.currentglGeom.unbind(t)}getGeomItemAndDist(t){let i,s;this.__gl.floatGeomBuffer?(i=Math.round(t[1]),s=t[3]):(i=t[0]+(t[1]<<8),s=Math.decode16BitFloatFrom2xUInt8([t[2],t[3]]));const e=this.__drawItems[i];if(e)return{geomItem:e.getGeomItem(),dist:s}}drawGeomData(t){this.newItemsReadyForLoading()&&this.finalize();const i=this.__gl;i.disable(i.BLEND),i.disable(i.CULL_FACE),i.enable(i.DEPTH_TEST),i.depthFunc(i.LESS),i.depthMask(!0);const s={currentglShader:null,currentglMaterial:null,currentglGeom:null};for(const e of this.visibleItems){const n=e.shaders;if(s.currentglShader!=n.glgeomdatashader){if(!this.bindShader(t,n.glgeomdatashader))continue;s.currentglShader=n.glgeomdatashader}{const s=t.unifs.floatGeomBuffer;s&&i.uniform1i(s.location,i.floatGeomBuffer?1:0)}{const s=t.unifs.passId;s&&i.uniform1i(s.location,this.__passIndex)}this._drawItem(t,e,s)}s.currentglGeom&&s.currentglGeom.unbind(t)}}Ie.registerPass(on,Ve.TRANSPARENT);class an extends ge{constructor(){super()}init(t,i){super.init(t,i),this.__billboards=[],this.__freeIndices=[],this.__drawCount=0,this.__threshold=0,this.__updateRequested=!1,this.__prevSortCameraPos=new u,this.__atlas=new qs(this.__renderer.gl,"Billboards","RGBA","UNSIGNED_BYTE",[1,1,1,0]),this.__atlas.loaded.connect(this.updated.emit),this.__atlas.updated.connect(this.updated.emit),this.__renderer.registerPass(t=>t instanceof es&&(this.addBillboard(t),!0),t=>t instanceof es&&(this.removeBillboard(t),!0))}filterRenderTree(){}addBillboard(t){const i=t.getParameter("image"),s=i.getValue();if(!s)return void i.valueChanged.connect(()=>this.addBillboard(t));let e;e=this.__freeIndices.length>0?this.__freeIndices.pop():this.__billboards.length;const n=this.__atlas.addSubImage(s);t.setMetadata("GLBillboardsPass_Index",e);const l=t.visibilityChanged.connect(()=>{t.getVisible()?(this.__drawCount++,this.__updateBillboard(e)):this.__drawCount--,this.__reqUpdateIndexArray()}),h=t.getParameter("GlobalXfo").valueChanged.connect(()=>{t.getVisible()&&(this.__updateBillboard(e),this.updated.emit())}),o=t.getParameter("alpha").valueChanged.connect(()=>{t.getVisible()&&(this.__updateBillboard(e),this.updated.emit())});t.getVisible()&&this.__drawCount++,this.__billboards[e]={billboard:t,imageIndex:n,visibilityChangedId:l,xfoChangedId:h,alphaChangedId:o},this.indexArrayUpdateNeeded=!0,this.__requestUpdate()}removeBillboard(t){const i=t.getMetadata("GLBillboardsPass_Index");if(-1==i)return void console.warn("Billboard already removed.");const s=this.__billboards[i],e=s.billboard.getParameter("image").getValue();this.__atlas.removeSubImage(e),t.visibilityChanged.disconnectId(s.visibilityChangedId),t.getParameter("GlobalXfo").valueChanged.disconnectId(s.xfoChangedId),t.getParameter("alpha").valueChanged.disconnectId(s.alphaChangedId),this.__billboards[i]=null,this.__freeIndices.push(i),t.getVisible()&&this.__drawCount--,this.indexArrayUpdateNeeded=!0,this.__requestUpdate()}__populateBillboardDataArray(t,i,s){const e=t.billboard,n=e.getGlobalXfo().toMat4(),l=e.getParameter("scale").getValue();let h=0;e.getParameter("alignedToCamera").getValue()&&(h|=4);const o=e.getParameter("alpha").getValue(),a=e.getParameter("color").getValue(),c=5*i*4,r=m.createFromFloat32Buffer(s.buffer,c),d=m.createFromFloat32Buffer(s.buffer,c+4),u=m.createFromFloat32Buffer(s.buffer,c+8),b=m.createFromFloat32Buffer(s.buffer,c+12);r.set(n.xAxis.x,n.yAxis.x,n.zAxis.x,n.translation.x),d.set(n.xAxis.y,n.yAxis.y,n.zAxis.y,n.translation.y),u.set(n.xAxis.z,n.yAxis.z,n.zAxis.z,n.translation.z),b.set(l,h,t.imageIndex,o),m.createFromFloat32Buffer(s.buffer,c+16).set(a.r,a.g,a.b,a.a)}__requestUpdate(){this.__updateRequested||(this.__updateRequested=!0,setTimeout(()=>{this.__updateBillboards()},100))}__reqUpdateIndexArray(){this.indexArrayUpdateNeeded||(this.indexArrayUpdateNeeded=!0,this.updateIndexArrayId=setTimeout(()=>{this.indexArrayUpdateNeeded&&(this.__updateIndexArray(),this.updated.emit())},1))}__updateIndexArray(){const t=this.__gl;this.__indexArray&&this.__indexArray.length!=this.__drawCount&&(t.deleteBuffer(this.__instanceIdsBuffer),this.__instanceIdsBuffer=null),this.__indexArray=new Float32Array(this.__drawCount);let i=0;for(let t=0;t<this.__billboards.length;t++)this.__billboards[t]&&this.__billboards[t].billboard.getVisible()&&(this.__indexArray[i]=t,i++);this.__instanceIdsBuffer||(this.__instanceIdsBuffer=t.createBuffer()),t.bindBuffer(t.ARRAY_BUFFER,this.__instanceIdsBuffer),t.bufferData(t.ARRAY_BUFFER,this.__indexArray,t.STATIC_DRAW),this.indexArrayUpdateNeeded=!1}__updateBillboards(){this.indexArrayUpdateNeeded&&this.__updateIndexArray();const t=this.__gl;if(!this.__glshader){t.__quadVertexIdsBuffer||t.setupInstancedQuad(),this.__glshader=new Se(t);const i=this.__glshader.compileForTarget("GLBillboardsPass",this.__renderer.getShaderPreproc());this.__shaderBinding=xs(t,i.attrs,t.__quadattrbuffers,t.__quadIndexBuffer)}const i=()=>{if(this.__atlas.renderAtlas(),!t.floatTexturesSupported||!t.drawElementsInstanced)return this.__modelMatrixArray=[],this.__billboardDataArray=[],this.__tintColorArray=[],this.__indexArray.forEach(t=>{const i=this.__billboards[t],s=i.billboard,e=s.getGlobalXfo().toMat4(),n=s.getParameter("scale").getValue(),l=s.getParameter("flags").getValue(),h=s.getParameter("alpha").getValue(),o=s.getParameter("color").getValue();this.__modelMatrixArray[t]=e.asArray(),this.__billboardDataArray[t]=[n,l,i.imageIndex,h],this.__tintColorArray[t]=[o.r,o.g,o.b,o.a]}),void(this.__updateRequested=!1);let i=Math.round(Math.sqrt(5*(this.__billboards.length-this.__freeIndices.length))+.5);i%5!=0&&(i+=5-i%5),this.__width=i,this.__drawItemsTexture?this.__drawItemsTexture.resize(i,i):(this.__drawItemsTexture=new Is(t,{format:"RGBA",type:"FLOAT",width:i,height:i,filter:"NEAREST",wrap:"CLAMP_TO_EDGE",mipMapped:!1}),this.__drawItemsTexture.clear()),this.__indexArray.forEach(t=>{-1!=t&&this.__updateBillboard(t)}),this.__updateRequested=!1};this.__atlas.isLoaded()?i():this.__atlas.loaded.connect(i)}__updateBillboard(t){if(0==this.__drawCount||!this.__drawItemsTexture)return;const i=this.__billboards[t];if(!i.billboard.getVisible())return;const s=this.__gl,e=new Float32Array(20);this.__populateBillboardDataArray(i,0,e),s.bindTexture(s.TEXTURE_2D,this.__drawItemsTexture.glTex);const n=5*t%this.__width,l=Math.floor(5*t/this.__width),h=this.__drawItemsTexture.getType(),o=this.__drawItemsTexture.getFormat();if("FLOAT"==h)s.texSubImage2D(s.TEXTURE_2D,0,n,l,5,1,s[o],s[h],e);else{const t=Math.convertFloat32ArrayToUInt16Array(e);s.texSubImage2D(s.TEXTURE_2D,0,n,l,5,1,s[o],s[h],t)}}sort(t){for(const i of this.__billboards)i&&i.billboard.getVisible()&&(i.dist=i.billboard.getGlobalXfo().tr.distanceTo(t));this.__indexArray.sort((t,i)=>-1==t?1:-1==i||this.__billboards[t].dist>this.__billboards[i].dist?-1:this.__billboards[t].dist<this.__billboards[i].dist?1:0);const i=this.__gl;i.floatTexturesSupported&&this.__instanceIdsBuffer&&(i.bindBuffer(i.ARRAY_BUFFER,this.__instanceIdsBuffer),i.bufferData(i.ARRAY_BUFFER,this.__indexArray,i.STATIC_DRAW))}draw(t){if(0==this.__drawCount||!this.__atlas.isReady()||this.__updateRequested)return;this.indexArrayUpdateNeeded&&this.__updateIndexArray();const i=this.__gl;i.disable(i.CULL_FACE),i.enable(i.BLEND),i.blendEquation(i.FUNC_ADD),i.blendFunc(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA);const s=t.viewXfo.tr;if(s.distanceTo(this.__prevSortCameraPos)>this.__threshold)if(this.sort(s),this.__prevSortCameraPos=s.clone(),this.__drawCount>1){const t=this.__billboards[this.__indexArray[0]].billboard.getGlobalXfo().tr,i=this.__billboards[this.__indexArray[1]].billboard.getGlobalXfo().tr;this.__threshold=t.distanceTo(i)}else this.__threshold=9999;this.__glshader.bind(t),this.__shaderBinding.bind(t);const e=t.unifs;if(this.__atlas.bindToUniform(t,e.atlasBillboards),i.floatTexturesSupported&&i.drawElementsInstanced){this.__drawItemsTexture.bindToUniform(t,e.instancesTexture),i.uniform1i(e.instancesTextureSize.location,this.__width);{const s=t.attrs.instanceIds.location;i.enableVertexAttribArray(s),i.bindBuffer(i.ARRAY_BUFFER,this.__instanceIdsBuffer),i.vertexAttribPointer(s,1,i.FLOAT,!1,4,0),i.vertexAttribDivisor(s,1)}t.bindViewports(e,()=>{i.drawElementsInstanced(i.TRIANGLES,6,i.UNSIGNED_SHORT,0,this.__drawCount)})}else{const s=this.__indexArray.length;for(let n=0;n<s;n++)i.uniformMatrix4fv(e.modelMatrix.location,!1,this.__modelMatrixArray[n]),i.uniform4fv(e.billboardData.location,this.__billboardDataArray[n]),i.uniform4fv(e.tintColor.location,this.__tintColorArray[n]),i.uniform4fv(e.layoutData.location,this.__atlas.getLayoutData(this.__billboards[n].imageIndex)),t.bindViewports(e,()=>{i.drawQuad()})}i.disable(i.BLEND)}}Ie.registerPass(an,Ve.TRANSPARENT);class cn extends hn{constructor(){super()}init(t,i){super.init(t,i)}filterGeomItem(t){if(t.isOverlay())return!0;const i=t.getMaterial().getShaderClass();return!(!i||!i.isOverlay())}draw(t){this.newItemsReadyForLoading()&&this.finalize();const i=this.__gl;i.clear(i.DEPTH_BUFFER_BIT),i.enable(i.CULL_FACE),i.cullFace(i.BACK),i.enable(i.BLEND),i.blendEquation(i.FUNC_ADD),t.pass="ADD",i.blendFunc(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA),this.__traverseTreeAndDraw(t),i.disable(i.BLEND)}drawGeomData(t){const i=this.__gl;i.clear(i.DEPTH_BUFFER_BIT),i.enable(i.BLEND),i.blendEquation(i.FUNC_ADD),t.pass="ADD",i.blendFunc(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA),super.drawGeomData(t),i.disable(i.BLEND),i.enable(i.DEPTH_TEST)}}Ie.registerPass(cn,Ve.OVERLAY);const rn=window.AudioContext||window.webkitAudioContext||!1;rn?i.audioCtx=new rn:alert("Sorry, but the Web Audio API is not supported by your browser. Please, consider upgrading to the latest version or downloading Google Chrome or Mozilla Firefox");class dn extends ge{constructor(){super(),this.__audioItems=[]}init(t,s){super.init(t,s),i.audioCtx&&this.__renderer.registerPass(t=>{if(t instanceof Di)return t.audioSourceCreated.connect(i=>{this.addAudioSource(t,i,t)}),!0;if(t instanceof _i){const i=t.getMaterial();if(i){const s=i.getParameter("BaseColor");if(s&&s.getImage&&s.getImage()){const i=s.getImage();i.loaded.connect(()=>{if(i.getAudioSource){const s=i.getAudioSource();(s instanceof HTMLMediaElement||s instanceof AudioBufferSourceNode)&&this.addAudioSource(t,s,i)}})}}return!1}},()=>{})}addAudioSource(t,s,e){if(s.addedToCollector)return;let n;n=s instanceof HTMLMediaElement?i.audioCtx.createMediaElementSource(s):s instanceof AudioBufferSourceNode?s:i.audioCtx.createMediaStreamSource(s);const l=i.audioCtx.createGain(),h=e.getParameter("Gain");var o,a;h&&(a=l.gain,(o=h)&&(a.setValueAtTime(o.getValue(),0),a.setValueAtTime(o.getValue(),5),o.valueChanged.connect(()=>{a.value=o.getValue()}))),n.connect(l);const c=e.getParameter("SpatializeAudio");if(c&&0==c.getValue())n.connect(i.audioCtx.destination);else{const s=i.audioCtx.createPanner();s.panningModel="HRTF",s.distanceModel="inverse",n.connect(s),s.connect(i.audioCtx.destination);const l=t=>{const i=e.getParameter(t);i&&(s[t]=i.getValue(),i.valueChanged.connect(()=>{s[t]=i.getValue()}))};l("coneInnerAngle"),l("coneOuterAngle"),l("coneOuterGain");const h=()=>{let i;i=t instanceof _i?t.getGeomMat4():t.getGlobalXfo().toMat4();const e=i.translation;s.setPosition(e.x,e.y,e.z);const n=i.zAxis;s.setOrientation(n.x,n.y,n.z)};h(),t.globalXfoChanged.connect(()=>{h()})}s.addedToCollector=!0,this.__audioItems.push({treeItem:t,audioSource:s,parameterOwner:e}),this.updated.emit()}__updateListenerPosition(t){if(!i.audioCtx)return;const s=i.audioCtx.listener;s.setPosition(t.tr.x,t.tr.y,t.tr.z);const e=t.ori.getYaxis(),n=t.ori.getZaxis().negate();s.setOrientation(n.x,n.y,n.z,e.x,e.y,e.z)}draw(t){0!=this.__audioItems.length&&this.__updateListenerPosition(t.viewXfo)}}Ie.registerPass(dn,Ve.OVERLAY),window&&(window.ZeaAudioaudioCtx=i.audioCtx);var un=Object.freeze({__proto__:null,create3DContext:Ws,GLTexture2D:Is,GLMesh:Ys,GLLines:Ms,GLPoints:Ks,GLMaterial:Qs,GLShader:Fs,GLFbo:Ts,GLRenderTarget:js,GLRenderer:Ie,GLBaseViewport:ue,GLViewport:me,shaderLibrary:ws,generateShaderGeomBinding:xs,BillboardShader:Se,ConvolverShader:$s,DepthMapShader:Le,EnvMapShader:se,BackgroundImageShader:ee,OctahedralEnvMapShader:ne,LatLongEnvMapShader:le,SterioLatLongEnvMapShader:he,DualFishEyeEnvMapShader:oe,DualFishEyeToLatLongBackgroundShader:ae,EnvProjectionShader:xe,OctahedralEnvProjectionShader:ve,LatLongEnvProjectionShader:Ye,FatLinesShader:Me,FlatSurfaceShader:Ke,FlatAlphaSurfaceShader:Ce,LayeredCarPaintShader:we,LinesShader:Ne,NormalsShader:Te,PointsShader:Je,FatPointsShader:ze,FatPointsGeomDataShader:He,FatPointsSelectedShader:Ue,PostProcessing:ke,ScreenQuadShader:re,SimpleSurfaceShader:Be,StandardSurfaceShader:Pe,StandardSurfaceGeomDataShader:Ee,StandardSurfaceSelectedGeomsShader:Qe,HandleShader:je,HandleGeomDataShader:De,TransparentSurfaceShader:Oe,ScreenSpaceShader:Ae,ToolIconShader:_e,UnpackHDRShader:Ns,UnpackLDRAlphaImageShader:qe,WireShader:$e,GLPass:ge,PassType:Ve,GLStandardGeomsPass:sn,GLOpaqueGeomsPass:hn,GLTransparentGeomsPass:on,GLBillboardsPass:an,GLOverlayPass:cn,GLAudioItemsPass:dn,get audioCtx(){return i.audioCtx},VRViewport:pe});class mn{constructor(t){this.__name=t||this.constructor.name,this.__stateEvents=[],this.__activationActions=[],this.__deactivationActions=[]}getName(){return this.__name}setName(t){this.__name=t}setStateMachine(t){this.__stateMachine=t}getStateMachine(){return this.__stateMachine}activate(){this.__stateEvents.forEach(t=>{t.activate()}),this.__activationActions.forEach(t=>{t.activate()})}deactivate(){this.__stateEvents.forEach(t=>{t.deactivate()}),this.__deactivationActions.forEach(t=>{t.activate()})}addStateEvent(t){t.setState(this),this.__stateEvents.push(t)}getStateEvent(t){return this.__stateEvents[t]}addActivationAction(t){t.setState(this),this.__activationActions.push(t)}getActivationAction(t){return this.__activationActions[t]}addDeactivationAction(t){t.setState(this),this.__deactivationActions.push(t)}toJSON(t,i){const s={name:this.__name,type:this.constructor.name},e=[];for(const s of this.__stateEvents)e.push(s.toJSON(t,i));s.stateEvents=e;const n=[];for(const s of this.__activationActions)n.push(s.toJSON(t,i));s.activationActions=n;const l=[];for(const s of this.__deactivationActions)l.push(s.toJSON(t,i));return s.deactivationActions=l,s}fromJSON(t,i,s){this.__name=t.name;for(const s of t.stateEvents){const t=N.constructClass(s.type);t.fromJSON(s,i),this.addStateEvent(t)}for(const s of t.activationActions){const t=N.constructClass(s.type);t.fromJSON(s,i),this.addActivationAction(t)}for(const s of t.deactivationActions){const t=N.constructClass(s.type);t.fromJSON(s,i),this.addDeactivationAction(t)}}}N.registerClass("State",mn);class bn extends B{constructor(t){super(),this.__name=t,this.__childActions=[],this.__outputs={}}addOutput(t){return this.__outputs[t.getName()]=t,t}getOutput(t){return this.__outputs[t]}setState(t){this.__state=t,this.__childActions.forEach(i=>{i.setState(t)})}addChild(t){this.__childActions.push(t),t.setState(this.__state)}getChild(t){return this.__childActions[t]}activate(){console.warn("activate must be implmented by each action. this:"+this.constructor.name)}addChild(t){this.__childActions.push(t),t.setState(this.__state)}deactivate(){}__onDone(){this.__childActions.forEach(t=>{t.activate()})}toJSON(t,i){let s=super.toJSON(t,i);s||(s={}),s.type=N.getClassName(this);const e=[];for(const s of this.__childActions)e.push(s.toJSON(t,i));s.childActions=e;const n={};for(const s in this.__outputs)n[s]=this.__outputs[s].toJSON(t,i);return s.outputs=n,s}fromJSON(t,i,s){super.fromJSON(t,i,s);for(const s of t.childActions){const t=N.constructClass(s.type);if(!t)throw new Error("Invalid type:"+s.type);t.fromJSON(s,i),this.addChild(t)}for(const s in t.outputs)this.__outputs[s].fromJSON(t.outputs[s],i)}destroy(){super.destroy(),this.__outputs=[]}}class Zn extends bn{constructor(t){super(),this.__name=t,this.__onEvent=this.__onEvent.bind(this)}__onEvent(){this.__childActions.forEach(t=>{t.activate()})}}class pn extends Q{constructor(t){super(t),this.__states={},this.stateChanged=new v,this.setFlag(P.USER_EDITED),N.isConstructing()||N.invokeCallbacks(this)}addState(t){t.setStateMachine(this),this.__states[t.getName()]=t,1==Object.keys(this.__states).length&&null==this.__initialStateName&&(this.__initialStateName=t.getName())}getState(t){return this.__states[t]}activateState(t){if(!this.__states[t])throw new Error("Invalid state transtion:"+t);this.__currentState!=this.__states[t]&&(this.__currentState&&this.__currentState.deactivate(),this.__currentState=this.__states[t],this.__currentState.activate(),this.stateChanged.emit(t))}getActiveState(){return this.__currentState}getActiveStateName(){return this.__currentState.constructor.name}getInitialState(){return this.__initialStateName}setInitialState(t){this.__initialStateName=t}toJSON(t,i){const s=super.toJSON(t,i);s.initialStateName=this.__initialStateName;const e={};for(const s in this.__states)e[s]=this.__states[s].toJSON(t,i);return s.states=e,s}fromJSON(t,i,s){super.fromJSON(t,i,s),this.__initialStateName=t.initialStateName,i.stateMachine=this;for(const s in t.states){const e=t.states[s],n=N.constructClass(e.type);if(!n)throw new Error("Invalid type:"+e.type);n.fromJSON(e,i),this.addState(n)}i.addPLCB(()=>{})}}N.registerClass("StateMachine",pn);class Gn extends bn{constructor(){super(),this.__targetStateParam=this.addParameter(new Rt("TargetState",""))}activate(){this.__state.getStateMachine().activateState(this.__targetStateParam.getValue())}}N.registerClass("SwitchState",Gn);class Xn extends bn{constructor(){super(),this.addParameter(new xt("Camera",t=>t instanceof ns)),this.addParameter(new pt("cameraPos")),this.addParameter(new pt("cameraTarget")),this.addParameter(new ut("interpTime",1)),this.addParameter(new ut("updateFrequency",30))}SetCameraPositionAndTarget(t,i){this.getParameter("cameraPos").setValue(t),this.getParameter("cameraTarget").setValue(i)}activate(){const t=this.getParameter("Camera").getValue();if(!t)return void console.warn("Camera not assigned to SetCameraPositionAndTarget state action");const i=this.getParameter("cameraPos").getValue(),s=this.getParameter("cameraTarget").getValue(),e=this.getParameter("interpTime").getValue();if(e>0){const n=t.getGlobalXfo().tr,l=t.getTargetPostion(),h=(n.subtract(l).length(),this.getParameter("updateFrequency").getValue()),o=i.subtract(s).length();let a=!0,c=0,r=0;const d=Math.round(e*h);let u=!1;const m=()=>{u||(a=!1)};t.globalXfoChanged.connect(m);const b=()=>{if(r++,r<d){const e=r/d,n=Math.smoothStep(0,1,e),l=(n-c)/(1-e);c=n;const m=t.getGlobalXfo().tr,Z=t.getTargetPostion(),p=m.subtract(Z).length();let G=m;const X=Z.lerp(s,l);a&&(G=m.lerp(i,l));const y=G.subtract(X),f=(y.length(),Math.lerp(p,o,l));y.scaleInPlace(f/y.length()),u=!0,t.setPositionAndTarget(X.add(y),X),u=!1,this.__timeoutId=window.setTimeout(b,1e3/h)}else t.globalXfoChanged.disconnect(m),t.movementFinished.emit(),this.__timeoutId=void 0,this.__onDone()};b()}else t.setPositionAndTarget(i,s)}cancel(){this.__timeoutId&&(clearTimeout(this.__timeoutId),this.__timeoutId=void 0)}}N.registerClass("SetCameraPositionAndTarget",Xn);class yn extends bn{constructor(){super(),this.__interpTimeParam=this.addParameter(new ut("InterpTime",1)),this.__updateFrequencyParam=this.addParameter(new ut("UpdateFrequency",30)),this.__outParam=this.addOutput(new ds("Param")),this.__outParam.paramSet.connect(()=>{if(!this.__valueParam||this.__outParam.getParam().getDataType()!=this.__valueParam.getDataType()){const t=this.__outParam.getParam().clone();t.setName("Value"),t.setValue(this.__outParam.getInitialValue?this.__outParam.getInitialValue():this.__outParam.getParam().getValue()),this.__valueParam=this.addParameter(t)}})}activate(){if(this.__outParam.isConnected()){const t=this.__interpTimeParam.getValue();if(t>0){const i=this.__updateFrequencyParam.getValue(),s=this.__outParam.getValue(),e=this.__valueParam.getValue();let n=0;const l=Math.round(t/(1/i)),h=()=>{if(n++,n<l){const t=Math.smoothStep(0,1,n/l),o=Math.lerp(s,e,t);this.__outParam.setValue(o,J.GENERATED_VALUE),this.__timeoutId=window.setTimeout(h,1e3/i)}else this.__outParam.setValue(this.__valueParam.getValue(),J.GENERATED_VALUE),this.__timeoutId=void 0,this.__onDone()};h()}else this.__outParam.setValue(this.__valueParam.getValue(),J.GENERATED_VALUE),this.__onDone()}}cancel(){this.__timeoutId&&(clearTimeout(this.__timeoutId),this.__timeoutId=void 0)}toJSON(t,i){const s=super.toJSON(t,i);return this.__valueParam&&(s.valueParamType=this.__valueParam.constructor.name),s}fromJSON(t,i,s){if(t.valueParamType){const i=N.constructClass(t.valueParamType,"Value");i&&(this.__valueParam=this.addParameter(i))}super.fromJSON(t,i,s)}}N.registerClass("SetParameterValue",yn);class fn extends Zn{constructor(t){super(t),this.__geomParam=this.addParameter(new xt("TreeItem")),this.__geomParam.valueChanged.connect(()=>{this.__geom=this.__geomParam.getValue()})}__geomClicked(t){t.stopPropagation(),this.__onEvent()}activate(){this.__geom&&this.__geom.mouseDown.connect(this.__geomClicked.bind(this))}deactivate(){this.__geom&&this.__geom.mouseDown.disconnect(this.__geomClicked.bind(this))}}N.registerClass("GeomClicked",fn);class Vn extends Zn{constructor(t){super(t),this.onKeyPressed=this.onKeyPressed.bind(this),this.__keyParam=this.addParameter(new Rt("Key",""))}onKeyPressed(t){console.log(t.key),t.key==this.__keyParam.getValue()&&this.__onEvent()}activate(){document.addEventListener("keydown",this.onKeyPressed)}deactivate(){document.removeEventListener("keydown",this.onKeyPressed)}}N.registerClass("KeyPressedEvent",Vn);class gn extends Zn{constructor(t){super(t),this.__waitTimeParam=this.addParameter(new ut("WaitTime",1))}activate(){this.__timeoutId=window.setTimeout(()=>{delete this.__timeoutId,this.__onEvent()},1e3*this.__waitTimeParam.getValue())}deactivate(){this.__timeoutId&&window.clearTimeout(this.__timeoutId)}}N.registerClass("TimedWait",gn);const Rn={onResize:s,...n,...x,...C,...Rs,...un,...Object.freeze({__proto__:null,State:mn,StateAction:bn,StateEvent:Zn,StateMachine:pn,SwitchState:Gn,SetCameraPositionAndTarget:Xn,SetParameterValue:yn,GeomClicked:fn,KeyPressedEvent:Vn,TimedWait:gn})};i.AimOperator=Vs,i.AssetItem=ss,i.Async=M,i.AttrValue=a,i.Attribute=fi,i.AudioItem=Di,i.BackgroundImageShader=ee,i.BaseGeom=Vi,i.BaseGeomItem=Ai,i.BaseImage=Kt,i.BaseItem=Q,i.BaseParameter=H,i.BillboardItem=es,i.BillboardShader=Se,i.BinReader=ct,i.BinWriter=rt,i.BooleanParameter=bt,i.Box2=R,i.Box3=I,i.CalcGlobalXfoOperator=ms,i.Camera=ns,i.CameraMouseAndKeyboard=gs,i.Circle=Ki,i.CloneFlags=Ei,i.CodeParameter=Wt,i.Color=p,i.ColorParameter=Xt,i.Command=dt,i.Cone=Ni,i.ConvolverShader=$s,i.Cross=Ci,i.Cuboid=Ti,i.Cylinder=Ji,i.DataImage=Tt,i.DepthMapShader=Le,i.Disc=zi,i.DualFishEyeEnvMapShader=oe,i.DualFishEyeToLatLongBackgroundShader=ae,i.EnvMap=di,i.EnvMapShader=se,i.EnvProjectionShader=xe,i.EulerAngles=G,i.ExplodePartsOperator=Zs,i.FatLinesShader=Me,i.FatPointsGeomDataShader=He,i.FatPointsSelectedShader=Ue,i.FatPointsShader=ze,i.FileAudioItem=Oi,i.FileImage=ti,i.FileImage2D=ii,i.FilePathParameter=It,i.FlatAlphaSurfaceShader=Ce,i.FlatSurfaceShader=Ke,i.Float32=6,i.Frustum=L,i.GIFImage=li,i.GLAudioItemsPass=dn,i.GLBaseViewport=ue,i.GLBillboardsPass=an,i.GLFbo=Ts,i.GLLines=Ms,i.GLMaterial=Qs,i.GLMesh=Ys,i.GLOpaqueGeomsPass=hn,i.GLOverlayPass=cn,i.GLPass=ge,i.GLPoints=Ks,i.GLRenderTarget=js,i.GLRenderer=Ie,i.GLShader=Fs,i.GLStandardGeomsPass=sn,i.GLTexture2D=Is,i.GLTransparentGeomsPass=on,i.GLViewport=me,i.GearsOperator=Gs,i.GeomClicked=fn,i.GeomItem=_i,i.GeomLibrary=is,i.GeometryParameter=Mt,i.Grid=Fi,i.Group=$i,i.GrowingPacker=Y,i.HandleGeomDataShader=De,i.HandleShader=je,i.ImageParameter=gt,i.InstanceItem=ji,i.ItemFlags=P,i.ItemSetParameter=vt,i.JSON_stringify_fixedPrecision=o,i.KeyPressedEvent=Vn,i.LDRImage=ei,i.LDRVideo=ni,i.Label=Zi,i.LatLongEnvMapShader=le,i.LatLongEnvProjectionShader=Ye,i.LayeredCarPaintShader=we,i.Lightmap=ui,i.LightmapMixer=mi,i.Lines=Wi,i.LinesCuboid=wi,i.LinesProxy=xi,i.LinesShader=Ne,i.ListParameter=St,i.LoadFlags=Pi,i.Mat3=X,i.Mat3Parameter=yt,i.Mat4=y,i.Mat4Parameter=ft,i.Material=Nt,i.MaterialColorParam=wt,i.MaterialFloatParam=Ct,i.MaterialLibrary=Gi,i.MaterialParameter=yi,i.Mesh=Ii,i.MeshProxy=vi,i.MultiChoiceParameter=mt,i.NormalsShader=Te,i.NumberParameter=ut,i.ObjAsset=cs,i.OctahedralEnvMapShader=ne,i.OctahedralEnvProjectionShader=ve,i.Operator=rs,i.OperatorOutput=ds,i.ParamFlags=z,i.Parameter=U,i.ParameterOwner=B,i.PassType=Ve,i.PistonOperator=ys,i.Plane=Hi,i.PlaneType=S,i.PointGrid=Yi,i.Points=Ri,i.PointsProxy=Li,i.PointsShader=Je,i.PostProcessing=ke,i.ProxyParameter=Yt,i.Quat=f,i.RGBA=Z,i.Ray=V,i.Rect=Mi,i.RefCounted=F,i.RouterOperator=fs,i.SAVE_FLAG_SKIP_GEOMDATA=1024,i.SInt16=3,i.SInt32=5,i.SInt8=1,i.SaveFlags=Bi,i.Scene=as,i.ScreenQuadShader=re,i.ScreenSpaceShader=Ae,i.SetCameraPositionAndTarget=Xn,i.SetParameterValue=yn,i.Signal=v,i.SimpleSurfaceShader=Be,i.Sphere=Ui,i.SphereType=W,i.StandardSurfaceGeomDataShader=Ee,i.StandardSurfaceSelectedGeomsShader=Qe,i.StandardSurfaceShader=Pe,i.State=mn,i.StateAction=bn,i.StateEvent=Zn,i.StateMachine=pn,i.SterioLatLongEnvMapShader=he,i.StringParameter=Rt,i.StructParameter=Lt,i.SwitchState=Gn,i.SystemDesc=e,i.TimedWait=gn,i.ToolIconShader=_e,i.Torus=ki,i.TransparentSurfaceShader=Oe,i.TreeItem=Qi,i.TreeItemParameter=xt,i.UInt16=2,i.UInt32=4,i.UInt8=0,i.UnpackHDRShader=Ns,i.UnpackLDRAlphaImageShader=qe,i.VLAAsset=hs,i.VRViewport=pe,i.ValueGetMode=T,i.ValueSetMode=J,i.Vec2=d,i.Vec2Parameter=Zt,i.Vec3=u,i.Vec3Parameter=pt,i.Vec4=m,i.Vec4Parameter=Gt,i.Version=ot,i.VertexAttribute=gi,i.VideoStreamImage2D=pi,i.WireShader=$e,i.Xfo=g,i.XfoOperatorOutput=us,i.XfoParameter=Vt,i.create3DContext=Ws,i.decodeText=K,i.default=Rn,i.generateShaderGeomBinding=xs,i.getFileFolder=D,i.hashStr=h,i.isObject=nt,i.labelManager=bi,i.loadBinfile=$,i.loadJSONfile=_,i.loadTextfile=A,i.loadXMLfile=q,i.materialLibraryManager=Xi,i.mergeDeep=lt,i.onResize=s,i.resourceLoader=ht,i.sgFactory=N,i.shaderLibrary=ws,i.typeRegistry=r})),l=/^(?:(?![^:@]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,h=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],o=function(t){var i=t,s=t.indexOf("["),e=t.indexOf("]");-1!=s&&-1!=e&&(t=t.substring(0,s)+t.substring(s,e).replace(/:/g,";")+t.substring(e,t.length));for(var n=l.exec(t||""),o={},a=14;a--;)o[h[a]]=n[a]||"";return-1!=s&&-1!=e&&(o.source=i,o.host=o.host.substring(1,o.host.length-1).replace(/;/g,":"),o.authority=o.authority.replace("[","").replace("]","").replace(/;/g,":"),o.ipv6uri=!0),o},a=1e3,r=60*a,d=60*r,u=24*d,m=function(t,i){i=i||{};var s=typeof t;if("string"===s&&t.length>0)return function(t){if(!((t=String(t)).length>100)){var i=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(t);if(i){var s=parseFloat(i[1]);switch((i[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return 315576e5*s;case"weeks":case"week":case"w":return 6048e5*s;case"days":case"day":case"d":return s*u;case"hours":case"hour":case"hrs":case"hr":case"h":return s*d;case"minutes":case"minute":case"mins":case"min":case"m":return s*r;case"seconds":case"second":case"secs":case"sec":case"s":return s*a;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return s;default:return}}}}(t);if("number"===s&&isFinite(t))return i.long?function(t){var i=Math.abs(t);return i>=u?Z(t,i,u,"day"):i>=d?Z(t,i,d,"hour"):i>=r?Z(t,i,r,"minute"):i>=a?Z(t,i,a,"second"):t+" ms"}(t):function(t){var i=Math.abs(t);return i>=u?Math.round(t/u)+"d":i>=d?Math.round(t/d)+"h":i>=r?Math.round(t/r)+"m":i>=a?Math.round(t/a)+"s":t+"ms"}(t);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(t))};function Z(t,i,s,e){var n=i>=1.5*s;return Math.round(t/s)+" "+e+(n?"s":"")}var p=e((function(t,i){i.log=function(...t){return"object"==typeof console&&console.log&&console.log(...t)},i.formatArgs=function(i){if(i[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+i[0]+(this.useColors?"%c ":" ")+"+"+t.exports.humanize(this.diff),!this.useColors)return;const s="color: "+this.color;i.splice(1,0,s,"color: inherit");let e=0,n=0;i[0].replace(/%[a-zA-Z%]/g,t=>{"%%"!==t&&(e++,"%c"===t&&(n=e))}),i.splice(n,0,s)},i.save=function(t){try{t?i.storage.setItem("debug",t):i.storage.removeItem("debug")}catch(t){}},i.load=function(){let t;try{t=i.storage.getItem("debug")}catch(t){}return!t&&"undefined"!=typeof process&&"env"in process&&(t=process.env.DEBUG),t},i.useColors=function(){return!("undefined"==typeof window||!window.process||"renderer"!==window.process.type&&!window.process.__nwjs)||("undefined"==typeof navigator||!navigator.userAgent||!navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))&&("undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/))},i.storage=function(){try{return localStorage}catch(t){}}(),i.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],t.exports=function(t){function i(t){let i=0;for(let s=0;s<t.length;s++)i=(i<<5)-i+t.charCodeAt(s),i|=0;return s.colors[Math.abs(i)%s.colors.length]}function s(t){let l;function h(...t){if(!h.enabled)return;const i=h,e=Number(new Date);i.diff=e-(l||e),i.prev=l,i.curr=e,l=e,t[0]=s.coerce(t[0]),"string"!=typeof t[0]&&t.unshift("%O");let n=0;t[0]=t[0].replace(/%([a-zA-Z%])/g,(e,l)=>{if("%%"===e)return e;n++;const h=s.formatters[l];return"function"==typeof h&&(e=h.call(i,t[n]),t.splice(n,1),n--),e}),s.formatArgs.call(i,t),(i.log||s.log).apply(i,t)}return h.namespace=t,h.enabled=s.enabled(t),h.useColors=s.useColors(),h.color=i(t),h.destroy=e,h.extend=n,"function"==typeof s.init&&s.init(h),s.instances.push(h),h}function e(){const t=s.instances.indexOf(this);return-1!==t&&(s.instances.splice(t,1),!0)}function n(t,i){const e=s(this.namespace+(void 0===i?":":i)+t);return e.log=this.log,e}function l(t){return t.toString().substring(2,t.toString().length-2).replace(/\.\*\?$/,"*")}return s.debug=s,s.default=s,s.coerce=function(t){return t instanceof Error?t.stack||t.message:t},s.disable=function(){const t=[...s.names.map(l),...s.skips.map(l).map(t=>"-"+t)].join(",");return s.enable(""),t},s.enable=function(t){let i;s.save(t),s.names=[],s.skips=[];const e=("string"==typeof t?t:"").split(/[\s,]+/),n=e.length;for(i=0;i<n;i++)e[i]&&("-"===(t=e[i].replace(/\*/g,".*?"))[0]?s.skips.push(new RegExp("^"+t.substr(1)+"$")):s.names.push(new RegExp("^"+t+"$")));for(i=0;i<s.instances.length;i++){const t=s.instances[i];t.enabled=s.enabled(t.namespace)}},s.enabled=function(t){if("*"===t[t.length-1])return!0;let i,e;for(i=0,e=s.skips.length;i<e;i++)if(s.skips[i].test(t))return!1;for(i=0,e=s.names.length;i<e;i++)if(s.names[i].test(t))return!0;return!1},s.humanize=m,Object.keys(t).forEach(i=>{s[i]=t[i]}),s.instances=[],s.names=[],s.skips=[],s.formatters={},s.selectColor=i,s.enable(s.load()),s}(i);const{formatters:s}=t.exports;s.j=function(t){try{return JSON.stringify(t)}catch(t){return"[UnexpectedJSONParseError]: "+t.message}}})),G=p("socket.io-client:url"),X=function(t,i){var s=t;i=i||"undefined"!=typeof location&&location,null==t&&(t=i.protocol+"//"+i.host),"string"==typeof t&&("/"===t.charAt(0)&&(t="/"===t.charAt(1)?i.protocol+t:i.host+t),/^(https?|wss?):\/\//.test(t)||(G("protocol-less url %s",t),t=void 0!==i?i.protocol+"//"+t:"https://"+t),G("parse %s",t),s=o(t)),s.port||(/^(http|ws)$/.test(s.protocol)?s.port="80":/^(http|ws)s$/.test(s.protocol)&&(s.port="443")),s.path=s.path||"/";var e=-1!==s.host.indexOf(":")?"["+s.host+"]":s.host;return s.id=s.protocol+"://"+e+":"+s.port,s.href=s.protocol+"://"+e+(i&&i.port===s.port?"":":"+s.port),s},y=36e5,f=24*y,V=function(t,i){i=i||{};var s=typeof t;if("string"===s&&t.length>0)return function(t){if(!((t=String(t)).length>100)){var i=/^((?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|years?|yrs?|y)?$/i.exec(t);if(i){var s=parseFloat(i[1]);switch((i[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return 315576e5*s;case"days":case"day":case"d":return s*f;case"hours":case"hour":case"hrs":case"hr":case"h":return s*y;case"minutes":case"minute":case"mins":case"min":case"m":return 6e4*s;case"seconds":case"second":case"secs":case"sec":case"s":return 1e3*s;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return s;default:return}}}}(t);if("number"===s&&!1===isNaN(t))return i.long?function(t){return g(t,f,"day")||g(t,y,"hour")||g(t,6e4,"minute")||g(t,1e3,"second")||t+" ms"}(t):function(t){return t>=f?Math.round(t/f)+"d":t>=y?Math.round(t/y)+"h":t>=6e4?Math.round(t/6e4)+"m":t>=1e3?Math.round(t/1e3)+"s":t+"ms"}(t);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(t))};function g(t,i,s){if(!(t<i))return t<1.5*i?Math.floor(t/i)+" "+s:Math.ceil(t/i)+" "+s+"s"}var R=e((function(t,i){function s(t){var s;function n(){if(n.enabled){var t=n,e=+new Date,l=e-(s||e);t.diff=l,t.prev=s,t.curr=e,s=e;for(var h=new Array(arguments.length),o=0;o<h.length;o++)h[o]=arguments[o];h[0]=i.coerce(h[0]),"string"!=typeof h[0]&&h.unshift("%O");var a=0;h[0]=h[0].replace(/%([a-zA-Z%])/g,(function(s,e){if("%%"===s)return s;a++;var n=i.formatters[e];return"function"==typeof n&&(s=n.call(t,h[a]),h.splice(a,1),a--),s})),i.formatArgs.call(t,h);var c=n.log||i.log||console.log.bind(console);c.apply(t,h)}}return n.namespace=t,n.enabled=i.enabled(t),n.useColors=i.useColors(),n.color=function(t){var s,e=0;for(s in t)e=(e<<5)-e+t.charCodeAt(s),e|=0;return i.colors[Math.abs(e)%i.colors.length]}(t),n.destroy=e,"function"==typeof i.init&&i.init(n),i.instances.push(n),n}function e(){var t=i.instances.indexOf(this);return-1!==t&&(i.instances.splice(t,1),!0)}(i=t.exports=s.debug=s.default=s).coerce=function(t){return t instanceof Error?t.stack||t.message:t},i.disable=function(){i.enable("")},i.enable=function(t){var s;i.save(t),i.names=[],i.skips=[];var e=("string"==typeof t?t:"").split(/[\s,]+/),n=e.length;for(s=0;s<n;s++)e[s]&&("-"===(t=e[s].replace(/\*/g,".*?"))[0]?i.skips.push(new RegExp("^"+t.substr(1)+"$")):i.names.push(new RegExp("^"+t+"$")));for(s=0;s<i.instances.length;s++){var l=i.instances[s];l.enabled=i.enabled(l.namespace)}},i.enabled=function(t){if("*"===t[t.length-1])return!0;var s,e;for(s=0,e=i.skips.length;s<e;s++)if(i.skips[s].test(t))return!1;for(s=0,e=i.names.length;s<e;s++)if(i.names[s].test(t))return!0;return!1},i.humanize=V,i.instances=[],i.names=[],i.skips=[],i.formatters={}})),W=e((function(t,i){function s(){var t;try{t=i.storage.debug}catch(t){}return!t&&"undefined"!=typeof process&&"env"in process&&(t=process.env.DEBUG),t}(i=t.exports=R).log=function(){return"object"==typeof console&&console.log&&Function.prototype.apply.call(console.log,console,arguments)},i.formatArgs=function(t){var s=this.useColors;if(t[0]=(s?"%c":"")+this.namespace+(s?" %c":" ")+t[0]+(s?"%c ":" ")+"+"+i.humanize(this.diff),s){var e="color: "+this.color;t.splice(1,0,e,"color: inherit");var n=0,l=0;t[0].replace(/%[a-zA-Z%]/g,(function(t){"%%"!==t&&(n++,"%c"===t&&(l=n))})),t.splice(l,0,e)}},i.save=function(t){try{null==t?i.storage.removeItem("debug"):i.storage.debug=t}catch(t){}},i.load=s,i.useColors=function(){return!("undefined"==typeof window||!window.process||"renderer"!==window.process.type)||("undefined"==typeof navigator||!navigator.userAgent||!navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))&&("undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/))},i.storage="undefined"!=typeof chrome&&void 0!==chrome.storage?chrome.storage.local:function(){try{return window.localStorage}catch(t){}}(),i.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],i.formatters.j=function(t){try{return JSON.stringify(t)}catch(t){return"[UnexpectedJSONParseError]: "+t.message}},i.enable(s())})),I=e((function(t){function i(t){if(t)return function(t){for(var s in i.prototype)t[s]=i.prototype[s];return t}(t)}t.exports=i,i.prototype.on=i.prototype.addEventListener=function(t,i){return this._callbacks=this._callbacks||{},(this._callbacks["$"+t]=this._callbacks["$"+t]||[]).push(i),this},i.prototype.once=function(t,i){function s(){this.off(t,s),i.apply(this,arguments)}return s.fn=i,this.on(t,s),this},i.prototype.off=i.prototype.removeListener=i.prototype.removeAllListeners=i.prototype.removeEventListener=function(t,i){if(this._callbacks=this._callbacks||{},0==arguments.length)return this._callbacks={},this;var s,e=this._callbacks["$"+t];if(!e)return this;if(1==arguments.length)return delete this._callbacks["$"+t],this;for(var n=0;n<e.length;n++)if((s=e[n])===i||s.fn===i){e.splice(n,1);break}return this},i.prototype.emit=function(t){this._callbacks=this._callbacks||{};var i=[].slice.call(arguments,1),s=this._callbacks["$"+t];if(s)for(var e=0,n=(s=s.slice(0)).length;e<n;++e)s[e].apply(this,i);return this},i.prototype.listeners=function(t){return this._callbacks=this._callbacks||{},this._callbacks["$"+t]||[]},i.prototype.hasListeners=function(t){return!!this.listeners(t).length}})),S={}.toString,L=Array.isArray||function(t){return"[object Array]"==S.call(t)},x=function(t){return v&&Buffer.isBuffer(t)||Y&&(t instanceof ArrayBuffer||function(t){return"function"==typeof ArrayBuffer.isView?ArrayBuffer.isView(t):t.buffer instanceof ArrayBuffer}(t))},v="function"==typeof Buffer&&"function"==typeof Buffer.isBuffer,Y="function"==typeof ArrayBuffer,M=Object.prototype.toString,K="function"==typeof Blob||"undefined"!=typeof Blob&&"[object BlobConstructor]"===M.call(Blob),C="function"==typeof File||"undefined"!=typeof File&&"[object FileConstructor]"===M.call(File),w=e((function(t,i){var s=W("socket.io-parser");function e(){}i.protocol=4,i.types=["CONNECT","DISCONNECT","EVENT","ACK","ERROR","BINARY_EVENT","BINARY_ACK"],i.CONNECT=0,i.DISCONNECT=1,i.EVENT=2,i.ACK=3,i.ERROR=4,i.BINARY_EVENT=5,i.BINARY_ACK=6,i.Encoder=e,i.Decoder=h;var n=i.ERROR+'"encode error"';function l(t){var e=""+t.type;if(i.BINARY_EVENT!==t.type&&i.BINARY_ACK!==t.type||(e+=t.attachments+"-"),t.nsp&&"/"!==t.nsp&&(e+=t.nsp+","),null!=t.id&&(e+=t.id),null!=t.data){var l=function(t){try{return JSON.stringify(t)}catch(t){return!1}}(t.data);if(!1===l)return n;e+=l}return s("encoded %j as %s",t,e),e}function h(){this.reconstructor=null}function o(t){this.reconPack=t,this.buffers=[]}function a(t){return{type:i.ERROR,data:"parser error: "+t}}e.prototype.encode=function(t,e){s("encoding packet %j",t),i.BINARY_EVENT===t.type||i.BINARY_ACK===t.type?function(t,i){!function(t,i){var s=0,e=t;!function t(n,l,h){if(!n)return n;if(K&&n instanceof Blob||C&&n instanceof File){s++;var o=new FileReader;o.onload=function(){h?h[l]=this.result:e=this.result,--s||i(e)},o.readAsArrayBuffer(n)}else if(L(n))for(var a=0;a<n.length;a++)t(n[a],a,n);else if("object"==typeof n&&!x(n))for(var c in n)t(n[c],c,n)}(e),s||i(e)}(t,(function(t){var s=function(t){var i=[],s=t;return s.data=function t(i,s){if(!i)return i;if(x(i)){var e={_placeholder:!0,num:s.length};return s.push(i),e}if(L(i)){for(var n=new Array(i.length),l=0;l<i.length;l++)n[l]=t(i[l],s);return n}if("object"==typeof i&&!(i instanceof Date)){for(var h in n={},i)n[h]=t(i[h],s);return n}return i}(t.data,i),s.attachments=i.length,{packet:s,buffers:i}}(t),e=l(s.packet),n=s.buffers;n.unshift(e),i(n)}))}(t,e):e([l(t)])},I(h.prototype),h.prototype.add=function(t){var e;if("string"==typeof t)e=function(t){var e=0,n={type:Number(t.charAt(0))};if(null==i.types[n.type])return a("unknown packet type "+n.type);if(i.BINARY_EVENT===n.type||i.BINARY_ACK===n.type){for(var l="";"-"!==t.charAt(++e)&&(l+=t.charAt(e),e!=t.length););if(l!=Number(l)||"-"!==t.charAt(e))throw new Error("Illegal attachments");n.attachments=Number(l)}if("/"===t.charAt(e+1))for(n.nsp="";++e&&","!==(o=t.charAt(e))&&(n.nsp+=o,e!==t.length););else n.nsp="/";var h=t.charAt(e+1);if(""!==h&&Number(h)==h){for(n.id="";++e;){var o;if(null==(o=t.charAt(e))||Number(o)!=o){--e;break}if(n.id+=t.charAt(e),e===t.length)break}n.id=Number(n.id)}if(t.charAt(++e)){var c=function(t){try{return JSON.parse(t)}catch(t){return!1}}(t.substr(e));if(!1===c||n.type!==i.ERROR&&!L(c))return a("invalid payload");n.data=c}return s("decoded %s as %j",t,n),n}(t),i.BINARY_EVENT===e.type||i.BINARY_ACK===e.type?(this.reconstructor=new o(e),0===this.reconstructor.reconPack.attachments&&this.emit("decoded",e)):this.emit("decoded",e);else{if(!x(t)&&!t.base64)throw new Error("Unknown type: "+t);if(!this.reconstructor)throw new Error("got binary data when not reconstructing a packet");(e=this.reconstructor.takeBinaryData(t))&&(this.reconstructor=null,this.emit("decoded",e))}},h.prototype.destroy=function(){this.reconstructor&&this.reconstructor.finishedReconstruction()},o.prototype.takeBinaryData=function(t){if(this.buffers.push(t),this.buffers.length===this.reconPack.attachments){var i=function(t,i){return t.data=function t(i,s){if(!i)return i;if(i&&i._placeholder)return s[i.num];if(L(i))for(var e=0;e<i.length;e++)i[e]=t(i[e],s);else if("object"==typeof i)for(var n in i)i[n]=t(i[n],s);return i}(t.data,i),t.attachments=void 0,t}(this.reconPack,this.buffers);return this.finishedReconstruction(),i}return null},o.prototype.finishedReconstruction=function(){this.reconPack=null,this.buffers=[]}})),F=e((function(t){try{t.exports="undefined"!=typeof XMLHttpRequest&&"withCredentials"in new XMLHttpRequest}catch(i){t.exports=!1}})),N="undefined"!=typeof self?self:"undefined"!=typeof window?window:Function("return this")(),T=function(t){var i=t.xdomain,s=t.xscheme,e=t.enablesXDR;try{if("undefined"!=typeof XMLHttpRequest&&(!i||F))return new XMLHttpRequest}catch(t){}try{if("undefined"!=typeof XDomainRequest&&!s&&e)return new XDomainRequest}catch(t){}if(!i)try{return new(N[["Active"].concat("Object").join("X")])("Microsoft.XMLHTTP")}catch(t){}},J=Object.keys||function(t){var i=[],s=Object.prototype.hasOwnProperty;for(var e in t)s.call(t,e)&&i.push(e);return i},z={}.toString,H=Array.isArray||function(t){return"[object Array]"==z.call(t)},U=Object.prototype.toString,k="function"==typeof Blob||"undefined"!=typeof Blob&&"[object BlobConstructor]"===U.call(Blob),B="function"==typeof File||"undefined"!=typeof File&&"[object FileConstructor]"===U.call(File),P=function t(i){if(!i||"object"!=typeof i)return!1;if(H(i)){for(var s=0,e=i.length;s<e;s++)if(t(i[s]))return!0;return!1}if("function"==typeof Buffer&&Buffer.isBuffer&&Buffer.isBuffer(i)||"function"==typeof ArrayBuffer&&i instanceof ArrayBuffer||k&&i instanceof Blob||B&&i instanceof File)return!0;if(i.toJSON&&"function"==typeof i.toJSON&&1===arguments.length)return t(i.toJSON(),!0);for(var n in i)if(Object.prototype.hasOwnProperty.call(i,n)&&t(i[n]))return!0;return!1},E=function(t,i,s){var e=t.byteLength;if(i=i||0,s=s||e,t.slice)return t.slice(i,s);if(i<0&&(i+=e),s<0&&(s+=e),s>e&&(s=e),i>=e||i>=s||0===e)return new ArrayBuffer(0);for(var n=new Uint8Array(t),l=new Uint8Array(s-i),h=i,o=0;h<s;h++,o++)l[o]=n[h];return l.buffer};function Q(){}
/*! https://mths.be/utf8js v2.1.2 by @mathias */var D,O,A,_=String.fromCharCode;function q(t){for(var i,s,e=[],n=0,l=t.length;n<l;)(i=t.charCodeAt(n++))>=55296&&i<=56319&&n<l?56320==(64512&(s=t.charCodeAt(n++)))?e.push(((1023&i)<<10)+(1023&s)+65536):(e.push(i),n--):e.push(i);return e}function $(t,i){if(t>=55296&&t<=57343){if(i)throw Error("Lone surrogate U+"+t.toString(16).toUpperCase()+" is not a scalar value");return!1}return!0}function tt(t,i){return _(t>>i&63|128)}function it(t,i){if(0==(4294967168&t))return _(t);var s="";return 0==(4294965248&t)?s=_(t>>6&31|192):0==(4294901760&t)?($(t,i)||(t=65533),s=_(t>>12&15|224),s+=tt(t,6)):0==(4292870144&t)&&(s=_(t>>18&7|240),s+=tt(t,12),s+=tt(t,6)),s+_(63&t|128)}function st(){if(A>=O)throw Error("Invalid byte index");var t=255&D[A];if(A++,128==(192&t))return 63&t;throw Error("Invalid continuation byte")}function et(t){var i,s;if(A>O)throw Error("Invalid byte index");if(A==O)return!1;if(i=255&D[A],A++,0==(128&i))return i;if(192==(224&i)){if((s=(31&i)<<6|st())>=128)return s;throw Error("Invalid continuation byte")}if(224==(240&i)){if((s=(15&i)<<12|st()<<6|st())>=2048)return $(s,t)?s:65533;throw Error("Invalid continuation byte")}if(240==(248&i)&&(s=(7&i)<<18|st()<<12|st()<<6|st())>=65536&&s<=1114111)return s;throw Error("Invalid UTF-8 detected")}var nt=function(t,i){for(var s=!1!==(i=i||{}).strict,e=q(t),n=e.length,l=-1,h="";++l<n;)h+=it(e[l],s);return h},lt=function(t,i){var s=!1!==(i=i||{}).strict;D=q(t),O=D.length,A=0;for(var e,n=[];!1!==(e=et(s));)n.push(e);return function(t){for(var i,s=t.length,e=-1,n="";++e<s;)(i=t[e])>65535&&(n+=_((i-=65536)>>>10&1023|55296),i=56320|1023&i),n+=_(i);return n}(n)},ht=e((function(t,i){!function(){for(var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",s=new Uint8Array(256),e=0;e<t.length;e++)s[t.charCodeAt(e)]=e;i.encode=function(i){var s,e=new Uint8Array(i),n=e.length,l="";for(s=0;s<n;s+=3)l+=t[e[s]>>2],l+=t[(3&e[s])<<4|e[s+1]>>4],l+=t[(15&e[s+1])<<2|e[s+2]>>6],l+=t[63&e[s+2]];return n%3==2?l=l.substring(0,l.length-1)+"=":n%3==1&&(l=l.substring(0,l.length-2)+"=="),l},i.decode=function(t){var i,e,n,l,h,o=.75*t.length,a=t.length,c=0;"="===t[t.length-1]&&(o--,"="===t[t.length-2]&&o--);var r=new ArrayBuffer(o),d=new Uint8Array(r);for(i=0;i<a;i+=4)e=s[t.charCodeAt(i)],n=s[t.charCodeAt(i+1)],l=s[t.charCodeAt(i+2)],h=s[t.charCodeAt(i+3)],d[c++]=e<<2|n>>4,d[c++]=(15&n)<<4|l>>2,d[c++]=(3&l)<<6|63&h;return r}}()})),ot=void 0!==ot?ot:"undefined"!=typeof WebKitBlobBuilder?WebKitBlobBuilder:"undefined"!=typeof MSBlobBuilder?MSBlobBuilder:"undefined"!=typeof MozBlobBuilder&&MozBlobBuilder,ct=function(){try{return 2===new Blob(["hi"]).size}catch(t){return!1}}(),rt=ct&&function(){try{return 2===new Blob([new Uint8Array([1,2])]).size}catch(t){return!1}}(),dt=ot&&ot.prototype.append&&ot.prototype.getBlob;function ut(t){return t.map((function(t){if(t.buffer instanceof ArrayBuffer){var i=t.buffer;if(t.byteLength!==i.byteLength){var s=new Uint8Array(t.byteLength);s.set(new Uint8Array(i,t.byteOffset,t.byteLength)),i=s.buffer}return i}return t}))}function mt(t,i){i=i||{};var s=new ot;return ut(t).forEach((function(t){s.append(t)})),i.type?s.getBlob(i.type):s.getBlob()}function bt(t,i){return new Blob(ut(t),i||{})}"undefined"!=typeof Blob&&(mt.prototype=Blob.prototype,bt.prototype=Blob.prototype);var Zt=ct?rt?Blob:bt:dt?mt:void 0,pt=e((function(t,i){var s;"undefined"!=typeof ArrayBuffer&&(s=ht);var e="undefined"!=typeof navigator&&/Android/i.test(navigator.userAgent),n="undefined"!=typeof navigator&&/PhantomJS/i.test(navigator.userAgent),l=e||n;i.protocol=3;var h=i.packets={open:0,close:1,ping:2,pong:3,message:4,upgrade:5,noop:6},o=J(h),a={type:"error",data:"parser error"};function c(t,i,s){for(var e=new Array(t.length),n=function(t,i,s){var e=!1;return s=s||Q,n.count=t,0===t?i():n;function n(t,l){if(n.count<=0)throw new Error("after called too many times");--n.count,t?(e=!0,i(t),i=s):0!==n.count||e||i(null,l)}}(t.length,s),l=function(t,s,n){i(s,(function(i,s){e[t]=s,n(i,e)}))},h=0;h<t.length;h++)l(h,t[h],n)}i.encodePacket=function(t,s,e,n){"function"==typeof s&&(n=s,s=!1),"function"==typeof e&&(n=e,e=null);var o=void 0===t.data?void 0:t.data.buffer||t.data;if("undefined"!=typeof ArrayBuffer&&o instanceof ArrayBuffer)return function(t,s,e){if(!s)return i.encodeBase64Packet(t,e);var n=t.data,l=new Uint8Array(n),o=new Uint8Array(1+n.byteLength);o[0]=h[t.type];for(var a=0;a<l.length;a++)o[a+1]=l[a];return e(o.buffer)}(t,s,n);if(void 0!==Zt&&o instanceof Zt)return function(t,s,e){if(!s)return i.encodeBase64Packet(t,e);if(l)return function(t,s,e){if(!s)return i.encodeBase64Packet(t,e);var n=new FileReader;return n.onload=function(){i.encodePacket({type:t.type,data:n.result},s,!0,e)},n.readAsArrayBuffer(t.data)}(t,s,e);var n=new Uint8Array(1);return n[0]=h[t.type],e(new Zt([n.buffer,t.data]))}(t,s,n);if(o&&o.base64)return function(t,s){return s("b"+i.packets[t.type]+t.data.data)}(t,n);var a=h[t.type];return void 0!==t.data&&(a+=e?nt(String(t.data),{strict:!1}):String(t.data)),n(""+a)},i.encodeBase64Packet=function(t,s){var e,n="b"+i.packets[t.type];if(void 0!==Zt&&t.data instanceof Zt){var l=new FileReader;return l.onload=function(){var t=l.result.split(",")[1];s(n+t)},l.readAsDataURL(t.data)}try{e=String.fromCharCode.apply(null,new Uint8Array(t.data))}catch(i){for(var h=new Uint8Array(t.data),o=new Array(h.length),a=0;a<h.length;a++)o[a]=h[a];e=String.fromCharCode.apply(null,o)}return n+=btoa(e),s(n)},i.decodePacket=function(t,s,e){if(void 0===t)return a;if("string"==typeof t){if("b"===t.charAt(0))return i.decodeBase64Packet(t.substr(1),s);if(e&&!1===(t=function(t){try{t=lt(t,{strict:!1})}catch(t){return!1}return t}(t)))return a;var n=t.charAt(0);return Number(n)==n&&o[n]?t.length>1?{type:o[n],data:t.substring(1)}:{type:o[n]}:a}n=new Uint8Array(t)[0];var l=E(t,1);return Zt&&"blob"===s&&(l=new Zt([l])),{type:o[n],data:l}},i.decodeBase64Packet=function(t,i){var e=o[t.charAt(0)];if(!s)return{type:e,data:{base64:!0,data:t.substr(1)}};var n=s.decode(t.substr(1));return"blob"===i&&Zt&&(n=new Zt([n])),{type:e,data:n}},i.encodePayload=function(t,s,e){"function"==typeof s&&(e=s,s=null);var n=P(t);return s&&n?Zt&&!l?i.encodePayloadAsBlob(t,e):i.encodePayloadAsArrayBuffer(t,e):t.length?void c(t,(function(t,e){i.encodePacket(t,!!n&&s,!1,(function(t){e(null,function(t){return t.length+":"+t}(t))}))}),(function(t,i){return e(i.join(""))})):e("0:")},i.decodePayload=function(t,s,e){if("string"!=typeof t)return i.decodePayloadAsBinary(t,s,e);var n;if("function"==typeof s&&(e=s,s=null),""===t)return e(a,0,1);for(var l,h,o="",c=0,r=t.length;c<r;c++){var d=t.charAt(c);if(":"===d){if(""===o||o!=(l=Number(o)))return e(a,0,1);if(o!=(h=t.substr(c+1,l)).length)return e(a,0,1);if(h.length){if(n=i.decodePacket(h,s,!1),a.type===n.type&&a.data===n.data)return e(a,0,1);if(!1===e(n,c+l,r))return}c+=l,o=""}else o+=d}return""!==o?e(a,0,1):void 0},i.encodePayloadAsArrayBuffer=function(t,s){if(!t.length)return s(new ArrayBuffer(0));c(t,(function(t,s){i.encodePacket(t,!0,!0,(function(t){return s(null,t)}))}),(function(t,i){var e=i.reduce((function(t,i){var s;return t+(s="string"==typeof i?i.length:i.byteLength).toString().length+s+2}),0),n=new Uint8Array(e),l=0;return i.forEach((function(t){var i="string"==typeof t,s=t;if(i){for(var e=new Uint8Array(t.length),h=0;h<t.length;h++)e[h]=t.charCodeAt(h);s=e.buffer}n[l++]=i?0:1;var o=s.byteLength.toString();for(h=0;h<o.length;h++)n[l++]=parseInt(o[h]);for(n[l++]=255,e=new Uint8Array(s),h=0;h<e.length;h++)n[l++]=e[h]})),s(n.buffer)}))},i.encodePayloadAsBlob=function(t,s){c(t,(function(t,s){i.encodePacket(t,!0,!0,(function(t){var i=new Uint8Array(1);if(i[0]=1,"string"==typeof t){for(var e=new Uint8Array(t.length),n=0;n<t.length;n++)e[n]=t.charCodeAt(n);t=e.buffer,i[0]=0}var l=(t instanceof ArrayBuffer?t.byteLength:t.size).toString(),h=new Uint8Array(l.length+1);for(n=0;n<l.length;n++)h[n]=parseInt(l[n]);if(h[l.length]=255,Zt){var o=new Zt([i.buffer,h.buffer,t]);s(null,o)}}))}),(function(t,i){return s(new Zt(i))}))},i.decodePayloadAsBinary=function(t,s,e){"function"==typeof s&&(e=s,s=null);for(var n=t,l=[];n.byteLength>0;){for(var h=new Uint8Array(n),o=0===h[0],c="",r=1;255!==h[r];r++){if(c.length>310)return e(a,0,1);c+=h[r]}n=E(n,2+c.length),c=parseInt(c);var d=E(n,0,c);if(o)try{d=String.fromCharCode.apply(null,new Uint8Array(d))}catch(t){var u=new Uint8Array(d);for(d="",r=0;r<u.length;r++)d+=String.fromCharCode(u[r])}l.push(d),n=E(n,c)}var m=l.length;l.forEach((function(t,n){e(i.decodePacket(t,s,!0),n,m)}))}})),Gt=e((function(t){function i(t){if(t)return function(t){for(var s in i.prototype)t[s]=i.prototype[s];return t}(t)}t.exports=i,i.prototype.on=i.prototype.addEventListener=function(t,i){return this._callbacks=this._callbacks||{},(this._callbacks["$"+t]=this._callbacks["$"+t]||[]).push(i),this},i.prototype.once=function(t,i){function s(){this.off(t,s),i.apply(this,arguments)}return s.fn=i,this.on(t,s),this},i.prototype.off=i.prototype.removeListener=i.prototype.removeAllListeners=i.prototype.removeEventListener=function(t,i){if(this._callbacks=this._callbacks||{},0==arguments.length)return this._callbacks={},this;var s,e=this._callbacks["$"+t];if(!e)return this;if(1==arguments.length)return delete this._callbacks["$"+t],this;for(var n=0;n<e.length;n++)if((s=e[n])===i||s.fn===i){e.splice(n,1);break}return this},i.prototype.emit=function(t){this._callbacks=this._callbacks||{};var i=[].slice.call(arguments,1),s=this._callbacks["$"+t];if(s)for(var e=0,n=(s=s.slice(0)).length;e<n;++e)s[e].apply(this,i);return this},i.prototype.listeners=function(t){return this._callbacks=this._callbacks||{},this._callbacks["$"+t]||[]},i.prototype.hasListeners=function(t){return!!this.listeners(t).length}})),Xt=yt;function yt(t){this.path=t.path,this.hostname=t.hostname,this.port=t.port,this.secure=t.secure,this.query=t.query,this.timestampParam=t.timestampParam,this.timestampRequests=t.timestampRequests,this.readyState="",this.agent=t.agent||!1,this.socket=t.socket,this.enablesXDR=t.enablesXDR,this.withCredentials=t.withCredentials,this.pfx=t.pfx,this.key=t.key,this.passphrase=t.passphrase,this.cert=t.cert,this.ca=t.ca,this.ciphers=t.ciphers,this.rejectUnauthorized=t.rejectUnauthorized,this.forceNode=t.forceNode,this.isReactNative=t.isReactNative,this.extraHeaders=t.extraHeaders,this.localAddress=t.localAddress}Gt(yt.prototype),yt.prototype.onError=function(t,i){var s=new Error(t);return s.type="TransportError",s.description=i,this.emit("error",s),this},yt.prototype.open=function(){return"closed"!==this.readyState&&""!==this.readyState||(this.readyState="opening",this.doOpen()),this},yt.prototype.close=function(){return"opening"!==this.readyState&&"open"!==this.readyState||(this.doClose(),this.onClose()),this},yt.prototype.send=function(t){if("open"!==this.readyState)throw new Error("Transport not open");this.write(t)},yt.prototype.onOpen=function(){this.readyState="open",this.writable=!0,this.emit("open")},yt.prototype.onData=function(t){var i=pt.decodePacket(t,this.socket.binaryType);this.onPacket(i)},yt.prototype.onPacket=function(t){this.emit("packet",t)},yt.prototype.onClose=function(){this.readyState="closed",this.emit("close")};var ft,Vt=function(t){var i="";for(var s in t)t.hasOwnProperty(s)&&(i.length&&(i+="&"),i+=encodeURIComponent(s)+"="+encodeURIComponent(t[s]));return i},gt=function(t,i){var s=function(){};s.prototype=i.prototype,t.prototype=new s,t.prototype.constructor=t},Rt="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_".split(""),Wt={},It=0,St=0;function Lt(t){var i="";do{i=Rt[t%64]+i,t=Math.floor(t/64)}while(t>0);return i}function xt(){var t=Lt(+new Date);return t!==ft?(It=0,ft=t):t+"."+Lt(It++)}for(;St<64;St++)Wt[Rt[St]]=St;xt.encode=Lt,xt.decode=function(t){var i=0;for(St=0;St<t.length;St++)i=64*i+Wt[t.charAt(St)];return i};var vt=xt,Yt=6e4,Mt=60*Yt,Kt=24*Mt,Ct=function(t,i){i=i||{};var s=typeof t;if("string"===s&&t.length>0)return function(t){if(!((t=String(t)).length>100)){var i=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(t);if(i){var s=parseFloat(i[1]);switch((i[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return 315576e5*s;case"weeks":case"week":case"w":return 6048e5*s;case"days":case"day":case"d":return s*Kt;case"hours":case"hour":case"hrs":case"hr":case"h":return s*Mt;case"minutes":case"minute":case"mins":case"min":case"m":return s*Yt;case"seconds":case"second":case"secs":case"sec":case"s":return 1e3*s;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return s;default:return}}}}(t);if("number"===s&&isFinite(t))return i.long?function(t){var i=Math.abs(t);return i>=Kt?wt(t,i,Kt,"day"):i>=Mt?wt(t,i,Mt,"hour"):i>=Yt?wt(t,i,Yt,"minute"):i>=1e3?wt(t,i,1e3,"second"):t+" ms"}(t):function(t){var i=Math.abs(t);return i>=Kt?Math.round(t/Kt)+"d":i>=Mt?Math.round(t/Mt)+"h":i>=Yt?Math.round(t/Yt)+"m":i>=1e3?Math.round(t/1e3)+"s":t+"ms"}(t);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(t))};function wt(t,i,s,e){var n=i>=1.5*s;return Math.round(t/s)+" "+e+(n?"s":"")}var Ft=e((function(t,i){i.log=function(...t){return"object"==typeof console&&console.log&&console.log(...t)},i.formatArgs=function(i){if(i[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+i[0]+(this.useColors?"%c ":" ")+"+"+t.exports.humanize(this.diff),!this.useColors)return;const s="color: "+this.color;i.splice(1,0,s,"color: inherit");let e=0,n=0;i[0].replace(/%[a-zA-Z%]/g,t=>{"%%"!==t&&(e++,"%c"===t&&(n=e))}),i.splice(n,0,s)},i.save=function(t){try{t?i.storage.setItem("debug",t):i.storage.removeItem("debug")}catch(t){}},i.load=function(){let t;try{t=i.storage.getItem("debug")}catch(t){}return!t&&"undefined"!=typeof process&&"env"in process&&(t=process.env.DEBUG),t},i.useColors=function(){return!("undefined"==typeof window||!window.process||"renderer"!==window.process.type&&!window.process.__nwjs)||("undefined"==typeof navigator||!navigator.userAgent||!navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))&&("undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/))},i.storage=function(){try{return localStorage}catch(t){}}(),i.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],t.exports=function(t){function i(t){let i=0;for(let s=0;s<t.length;s++)i=(i<<5)-i+t.charCodeAt(s),i|=0;return s.colors[Math.abs(i)%s.colors.length]}function s(t){let l;function h(...t){if(!h.enabled)return;const i=h,e=Number(new Date);i.diff=e-(l||e),i.prev=l,i.curr=e,l=e,t[0]=s.coerce(t[0]),"string"!=typeof t[0]&&t.unshift("%O");let n=0;t[0]=t[0].replace(/%([a-zA-Z%])/g,(e,l)=>{if("%%"===e)return e;n++;const h=s.formatters[l];return"function"==typeof h&&(e=h.call(i,t[n]),t.splice(n,1),n--),e}),s.formatArgs.call(i,t),(i.log||s.log).apply(i,t)}return h.namespace=t,h.enabled=s.enabled(t),h.useColors=s.useColors(),h.color=i(t),h.destroy=e,h.extend=n,"function"==typeof s.init&&s.init(h),s.instances.push(h),h}function e(){const t=s.instances.indexOf(this);return-1!==t&&(s.instances.splice(t,1),!0)}function n(t,i){const e=s(this.namespace+(void 0===i?":":i)+t);return e.log=this.log,e}function l(t){return t.toString().substring(2,t.toString().length-2).replace(/\.\*\?$/,"*")}return s.debug=s,s.default=s,s.coerce=function(t){return t instanceof Error?t.stack||t.message:t},s.disable=function(){const t=[...s.names.map(l),...s.skips.map(l).map(t=>"-"+t)].join(",");return s.enable(""),t},s.enable=function(t){let i;s.save(t),s.names=[],s.skips=[];const e=("string"==typeof t?t:"").split(/[\s,]+/),n=e.length;for(i=0;i<n;i++)e[i]&&("-"===(t=e[i].replace(/\*/g,".*?"))[0]?s.skips.push(new RegExp("^"+t.substr(1)+"$")):s.names.push(new RegExp("^"+t+"$")));for(i=0;i<s.instances.length;i++){const t=s.instances[i];t.enabled=s.enabled(t.namespace)}},s.enabled=function(t){if("*"===t[t.length-1])return!0;let i,e;for(i=0,e=s.skips.length;i<e;i++)if(s.skips[i].test(t))return!1;for(i=0,e=s.names.length;i<e;i++)if(s.names[i].test(t))return!0;return!1},s.humanize=Ct,Object.keys(t).forEach(i=>{s[i]=t[i]}),s.instances=[],s.names=[],s.skips=[],s.formatters={},s.selectColor=i,s.enable(s.load()),s}(i);const{formatters:s}=t.exports;s.j=function(t){try{return JSON.stringify(t)}catch(t){return"[UnexpectedJSONParseError]: "+t.message}}})),Nt=Ft("engine.io-client:polling"),Tt=zt,Jt=null!=new T({xdomain:!1}).responseType;function zt(t){Jt&&!(t&&t.forceBase64)||(this.supportsBinary=!1),Xt.call(this,t)}gt(zt,Xt),zt.prototype.name="polling",zt.prototype.doOpen=function(){this.poll()},zt.prototype.pause=function(t){var i=this;function s(){Nt("paused"),i.readyState="paused",t()}if(this.readyState="pausing",this.polling||!this.writable){var e=0;this.polling&&(Nt("we are currently polling - waiting to pause"),e++,this.once("pollComplete",(function(){Nt("pre-pause polling complete"),--e||s()}))),this.writable||(Nt("we are currently writing - waiting to pause"),e++,this.once("drain",(function(){Nt("pre-pause writing complete"),--e||s()})))}else s()},zt.prototype.poll=function(){Nt("polling"),this.polling=!0,this.doPoll(),this.emit("poll")},zt.prototype.onData=function(t){var i=this;Nt("polling got data %s",t),pt.decodePayload(t,this.socket.binaryType,(function(t){if("opening"===i.readyState&&i.onOpen(),"close"===t.type)return i.onClose(),!1;i.onPacket(t)})),"closed"!==this.readyState&&(this.polling=!1,this.emit("pollComplete"),"open"===this.readyState?this.poll():Nt('ignoring poll - transport state "%s"',this.readyState))},zt.prototype.doClose=function(){var t=this;function i(){Nt("writing close packet"),t.write([{type:"close"}])}"open"===this.readyState?(Nt("transport open - closing"),i()):(Nt("transport not open - deferring close"),this.once("open",i))},zt.prototype.write=function(t){var i=this;this.writable=!1;var s=function(){i.writable=!0,i.emit("drain")};pt.encodePayload(t,this.supportsBinary,(function(t){i.doWrite(t,s)}))},zt.prototype.uri=function(){var t=this.query||{},i=this.secure?"https":"http",s="";return!1!==this.timestampRequests&&(t[this.timestampParam]=vt()),this.supportsBinary||t.sid||(t.b64=1),t=Vt(t),this.port&&("https"===i&&443!==Number(this.port)||"http"===i&&80!==Number(this.port))&&(s=":"+this.port),t.length&&(t="?"+t),i+"://"+(-1!==this.hostname.indexOf(":")?"["+this.hostname+"]":this.hostname)+s+this.path+t};var Ht=Ft("engine.io-client:polling-xhr"),Ut=Pt,kt=Et;function Bt(){}function Pt(t){if(Tt.call(this,t),this.requestTimeout=t.requestTimeout,this.extraHeaders=t.extraHeaders,"undefined"!=typeof location){var i="https:"===location.protocol,s=location.port;s||(s=i?443:80),this.xd="undefined"!=typeof location&&t.hostname!==location.hostname||s!==t.port,this.xs=t.secure!==i}}function Et(t){this.method=t.method||"GET",this.uri=t.uri,this.xd=!!t.xd,this.xs=!!t.xs,this.async=!1!==t.async,this.data=void 0!==t.data?t.data:null,this.agent=t.agent,this.isBinary=t.isBinary,this.supportsBinary=t.supportsBinary,this.enablesXDR=t.enablesXDR,this.withCredentials=t.withCredentials,this.requestTimeout=t.requestTimeout,this.pfx=t.pfx,this.key=t.key,this.passphrase=t.passphrase,this.cert=t.cert,this.ca=t.ca,this.ciphers=t.ciphers,this.rejectUnauthorized=t.rejectUnauthorized,this.extraHeaders=t.extraHeaders,this.create()}function Qt(){for(var t in Et.requests)Et.requests.hasOwnProperty(t)&&Et.requests[t].abort()}gt(Pt,Tt),Pt.prototype.supportsBinary=!0,Pt.prototype.request=function(t){return(t=t||{}).uri=this.uri(),t.xd=this.xd,t.xs=this.xs,t.agent=this.agent||!1,t.supportsBinary=this.supportsBinary,t.enablesXDR=this.enablesXDR,t.withCredentials=this.withCredentials,t.pfx=this.pfx,t.key=this.key,t.passphrase=this.passphrase,t.cert=this.cert,t.ca=this.ca,t.ciphers=this.ciphers,t.rejectUnauthorized=this.rejectUnauthorized,t.requestTimeout=this.requestTimeout,t.extraHeaders=this.extraHeaders,new Et(t)},Pt.prototype.doWrite=function(t,i){var s=this.request({method:"POST",data:t,isBinary:"string"!=typeof t&&void 0!==t}),e=this;s.on("success",i),s.on("error",(function(t){e.onError("xhr post error",t)})),this.sendXhr=s},Pt.prototype.doPoll=function(){Ht("xhr poll");var t=this.request(),i=this;t.on("data",(function(t){i.onData(t)})),t.on("error",(function(t){i.onError("xhr poll error",t)})),this.pollXhr=t},Gt(Et.prototype),Et.prototype.create=function(){var t={agent:this.agent,xdomain:this.xd,xscheme:this.xs,enablesXDR:this.enablesXDR};t.pfx=this.pfx,t.key=this.key,t.passphrase=this.passphrase,t.cert=this.cert,t.ca=this.ca,t.ciphers=this.ciphers,t.rejectUnauthorized=this.rejectUnauthorized;var i=this.xhr=new T(t),s=this;try{Ht("xhr open %s: %s",this.method,this.uri),i.open(this.method,this.uri,this.async);try{if(this.extraHeaders)for(var e in i.setDisableHeaderCheck&&i.setDisableHeaderCheck(!0),this.extraHeaders)this.extraHeaders.hasOwnProperty(e)&&i.setRequestHeader(e,this.extraHeaders[e])}catch(t){}if("POST"===this.method)try{i.setRequestHeader("Content-type",this.isBinary?"application/octet-stream":"text/plain;charset=UTF-8")}catch(t){}try{i.setRequestHeader("Accept","*/*")}catch(t){}"withCredentials"in i&&(i.withCredentials=this.withCredentials),this.requestTimeout&&(i.timeout=this.requestTimeout),this.hasXDR()?(i.onload=function(){s.onLoad()},i.onerror=function(){s.onError(i.responseText)}):i.onreadystatechange=function(){if(2===i.readyState)try{var t=i.getResponseHeader("Content-Type");(s.supportsBinary&&"application/octet-stream"===t||"application/octet-stream; charset=UTF-8"===t)&&(i.responseType="arraybuffer")}catch(t){}4===i.readyState&&(200===i.status||1223===i.status?s.onLoad():setTimeout((function(){s.onError("number"==typeof i.status?i.status:0)}),0))},Ht("xhr data %s",this.data),i.send(this.data)}catch(t){return void setTimeout((function(){s.onError(t)}),0)}"undefined"!=typeof document&&(this.index=Et.requestsCount++,Et.requests[this.index]=this)},Et.prototype.onSuccess=function(){this.emit("success"),this.cleanup()},Et.prototype.onData=function(t){this.emit("data",t),this.onSuccess()},Et.prototype.onError=function(t){this.emit("error",t),this.cleanup(!0)},Et.prototype.cleanup=function(t){if(null!=this.xhr){if(this.hasXDR()?this.xhr.onload=this.xhr.onerror=Bt:this.xhr.onreadystatechange=Bt,t)try{this.xhr.abort()}catch(t){}"undefined"!=typeof document&&delete Et.requests[this.index],this.xhr=null}},Et.prototype.onLoad=function(){var t;try{var i;try{i=this.xhr.getResponseHeader("Content-Type")}catch(t){}t=("application/octet-stream"===i||"application/octet-stream; charset=UTF-8"===i)&&this.xhr.response||this.xhr.responseText}catch(t){this.onError(t)}null!=t&&this.onData(t)},Et.prototype.hasXDR=function(){return"undefined"!=typeof XDomainRequest&&!this.xs&&this.enablesXDR},Et.prototype.abort=function(){this.cleanup()},Et.requestsCount=0,Et.requests={},"undefined"!=typeof document&&("function"==typeof attachEvent?attachEvent("onunload",Qt):"function"==typeof addEventListener&&addEventListener("onpagehide"in N?"pagehide":"unload",Qt,!1)),Ut.Request=kt;var jt,Dt=qt,Ot=/\n/g,At=/\\n/g;function _t(){}function qt(t){Tt.call(this,t),this.query=this.query||{},jt||(jt=N.___eio=N.___eio||[]),this.index=jt.length;var i=this;jt.push((function(t){i.onData(t)})),this.query.j=this.index,"function"==typeof addEventListener&&addEventListener("beforeunload",(function(){i.script&&(i.script.onerror=_t)}),!1)}gt(qt,Tt),qt.prototype.supportsBinary=!1,qt.prototype.doClose=function(){this.script&&(this.script.parentNode.removeChild(this.script),this.script=null),this.form&&(this.form.parentNode.removeChild(this.form),this.form=null,this.iframe=null),Tt.prototype.doClose.call(this)},qt.prototype.doPoll=function(){var t=this,i=document.createElement("script");this.script&&(this.script.parentNode.removeChild(this.script),this.script=null),i.async=!0,i.src=this.uri(),i.onerror=function(i){t.onError("jsonp poll error",i)};var s=document.getElementsByTagName("script")[0];s?s.parentNode.insertBefore(i,s):(document.head||document.body).appendChild(i),this.script=i,"undefined"!=typeof navigator&&/gecko/i.test(navigator.userAgent)&&setTimeout((function(){var t=document.createElement("iframe");document.body.appendChild(t),document.body.removeChild(t)}),100)},qt.prototype.doWrite=function(t,i){var s=this;if(!this.form){var e,n=document.createElement("form"),l=document.createElement("textarea"),h=this.iframeId="eio_iframe_"+this.index;n.className="socketio",n.style.position="absolute",n.style.top="-1000px",n.style.left="-1000px",n.target=h,n.method="POST",n.setAttribute("accept-charset","utf-8"),l.name="d",n.appendChild(l),document.body.appendChild(n),this.form=n,this.area=l}function o(){a(),i()}function a(){if(s.iframe)try{s.form.removeChild(s.iframe)}catch(t){s.onError("jsonp polling iframe removal error",t)}try{e=document.createElement('<iframe src="javascript:0" name="'+s.iframeId+'">')}catch(t){(e=document.createElement("iframe")).name=s.iframeId,e.src="javascript:0"}e.id=s.iframeId,s.form.appendChild(e),s.iframe=e}this.form.action=this.uri(),a(),t=t.replace(At,"\\\n"),this.area.value=t.replace(Ot,"\\n");try{this.form.submit()}catch(t){}this.iframe.attachEvent?this.iframe.onreadystatechange=function(){"complete"===s.iframe.readyState&&o()}:this.iframe.onload=o};const $t=Object.freeze({__proto__:null,default:{}});var ti,ii,si=Ft("engine.io-client:websocket");if("undefined"!=typeof WebSocket?ti=WebSocket:"undefined"!=typeof self&&(ti=self.WebSocket||self.MozWebSocket),"undefined"==typeof window)try{ii=$t}catch(t){}var ei=ti||ii,ni=li;function li(t){t&&t.forceBase64&&(this.supportsBinary=!1),this.perMessageDeflate=t.perMessageDeflate,this.usingBrowserWebSocket=ti&&!t.forceNode,this.protocols=t.protocols,this.usingBrowserWebSocket||(ei=ii),Xt.call(this,t)}gt(li,Xt),li.prototype.name="websocket",li.prototype.supportsBinary=!0,li.prototype.doOpen=function(){if(this.check()){var t=this.uri(),i=this.protocols,s={agent:this.agent,perMessageDeflate:this.perMessageDeflate};s.pfx=this.pfx,s.key=this.key,s.passphrase=this.passphrase,s.cert=this.cert,s.ca=this.ca,s.ciphers=this.ciphers,s.rejectUnauthorized=this.rejectUnauthorized,this.extraHeaders&&(s.headers=this.extraHeaders),this.localAddress&&(s.localAddress=this.localAddress);try{this.ws=this.usingBrowserWebSocket&&!this.isReactNative?i?new ei(t,i):new ei(t):new ei(t,i,s)}catch(t){return this.emit("error",t)}void 0===this.ws.binaryType&&(this.supportsBinary=!1),this.ws.supports&&this.ws.supports.binary?(this.supportsBinary=!0,this.ws.binaryType="nodebuffer"):this.ws.binaryType="arraybuffer",this.addEventListeners()}},li.prototype.addEventListeners=function(){var t=this;this.ws.onopen=function(){t.onOpen()},this.ws.onclose=function(){t.onClose()},this.ws.onmessage=function(i){t.onData(i.data)},this.ws.onerror=function(i){t.onError("websocket error",i)}},li.prototype.write=function(t){var i=this;this.writable=!1;for(var s=t.length,e=0,n=s;e<n;e++)!function(t){pt.encodePacket(t,i.supportsBinary,(function(e){if(!i.usingBrowserWebSocket){var n={};t.options&&(n.compress=t.options.compress),i.perMessageDeflate&&("string"==typeof e?Buffer.byteLength(e):e.length)<i.perMessageDeflate.threshold&&(n.compress=!1)}try{i.usingBrowserWebSocket?i.ws.send(e):i.ws.send(e,n)}catch(t){si("websocket closed before onclose event")}--s||(i.emit("flush"),setTimeout((function(){i.writable=!0,i.emit("drain")}),0))}))}(t[e])},li.prototype.onClose=function(){Xt.prototype.onClose.call(this)},li.prototype.doClose=function(){void 0!==this.ws&&this.ws.close()},li.prototype.uri=function(){var t=this.query||{},i=this.secure?"wss":"ws",s="";return this.port&&("wss"===i&&443!==Number(this.port)||"ws"===i&&80!==Number(this.port))&&(s=":"+this.port),this.timestampRequests&&(t[this.timestampParam]=vt()),this.supportsBinary||(t.b64=1),(t=Vt(t)).length&&(t="?"+t),i+"://"+(-1!==this.hostname.indexOf(":")?"["+this.hostname+"]":this.hostname)+s+this.path+t},li.prototype.check=function(){return!(!ei||"__initialize"in ei&&this.name===li.prototype.name)};var hi={polling:function(t){var i=!1,s=!1,e=!1!==t.jsonp;if("undefined"!=typeof location){var n="https:"===location.protocol,l=location.port;l||(l=n?443:80),i=t.hostname!==location.hostname||l!==t.port,s=t.secure!==n}if(t.xdomain=i,t.xscheme=s,"open"in new T(t)&&!t.forceJSONP)return new Ut(t);if(!e)throw new Error("JSONP disabled");return new Dt(t)},websocket:ni},oi=[].indexOf,ai=function(t,i){if(oi)return t.indexOf(i);for(var s=0;s<t.length;++s)if(t[s]===i)return s;return-1},ci=Ft("engine.io-client:socket"),ri=di;function di(t,i){if(!(this instanceof di))return new di(t,i);i=i||{},t&&"object"==typeof t&&(i=t,t=null),t?(t=o(t),i.hostname=t.host,i.secure="https"===t.protocol||"wss"===t.protocol,i.port=t.port,t.query&&(i.query=t.query)):i.host&&(i.hostname=o(i.host).host),this.secure=null!=i.secure?i.secure:"undefined"!=typeof location&&"https:"===location.protocol,i.hostname&&!i.port&&(i.port=this.secure?"443":"80"),this.agent=i.agent||!1,this.hostname=i.hostname||("undefined"!=typeof location?location.hostname:"localhost"),this.port=i.port||("undefined"!=typeof location&&location.port?location.port:this.secure?443:80),this.query=i.query||{},"string"==typeof this.query&&(this.query=function(t){for(var i={},s=t.split("&"),e=0,n=s.length;e<n;e++){var l=s[e].split("=");i[decodeURIComponent(l[0])]=decodeURIComponent(l[1])}return i}(this.query)),this.upgrade=!1!==i.upgrade,this.path=(i.path||"/engine.io").replace(/\/$/,"")+"/",this.forceJSONP=!!i.forceJSONP,this.jsonp=!1!==i.jsonp,this.forceBase64=!!i.forceBase64,this.enablesXDR=!!i.enablesXDR,this.withCredentials=!1!==i.withCredentials,this.timestampParam=i.timestampParam||"t",this.timestampRequests=i.timestampRequests,this.transports=i.transports||["polling","websocket"],this.transportOptions=i.transportOptions||{},this.readyState="",this.writeBuffer=[],this.prevBufferLen=0,this.policyPort=i.policyPort||843,this.rememberUpgrade=i.rememberUpgrade||!1,this.binaryType=null,this.onlyBinaryUpgrades=i.onlyBinaryUpgrades,this.perMessageDeflate=!1!==i.perMessageDeflate&&(i.perMessageDeflate||{}),!0===this.perMessageDeflate&&(this.perMessageDeflate={}),this.perMessageDeflate&&null==this.perMessageDeflate.threshold&&(this.perMessageDeflate.threshold=1024),this.pfx=i.pfx||null,this.key=i.key||null,this.passphrase=i.passphrase||null,this.cert=i.cert||null,this.ca=i.ca||null,this.ciphers=i.ciphers||null,this.rejectUnauthorized=void 0===i.rejectUnauthorized||i.rejectUnauthorized,this.forceNode=!!i.forceNode,this.isReactNative="undefined"!=typeof navigator&&"string"==typeof navigator.product&&"reactnative"===navigator.product.toLowerCase(),("undefined"==typeof self||this.isReactNative)&&(i.extraHeaders&&Object.keys(i.extraHeaders).length>0&&(this.extraHeaders=i.extraHeaders),i.localAddress&&(this.localAddress=i.localAddress)),this.id=null,this.upgrades=null,this.pingInterval=null,this.pingTimeout=null,this.pingIntervalTimer=null,this.pingTimeoutTimer=null,this.open()}di.priorWebsocketSuccess=!1,Gt(di.prototype),di.protocol=pt.protocol,di.Socket=di,di.Transport=Xt,di.transports=hi,di.parser=pt,di.prototype.createTransport=function(t){ci('creating transport "%s"',t);var i=function(t){var i={};for(var s in t)t.hasOwnProperty(s)&&(i[s]=t[s]);return i}(this.query);i.EIO=pt.protocol,i.transport=t;var s=this.transportOptions[t]||{};return this.id&&(i.sid=this.id),new hi[t]({query:i,socket:this,agent:s.agent||this.agent,hostname:s.hostname||this.hostname,port:s.port||this.port,secure:s.secure||this.secure,path:s.path||this.path,forceJSONP:s.forceJSONP||this.forceJSONP,jsonp:s.jsonp||this.jsonp,forceBase64:s.forceBase64||this.forceBase64,enablesXDR:s.enablesXDR||this.enablesXDR,withCredentials:s.withCredentials||this.withCredentials,timestampRequests:s.timestampRequests||this.timestampRequests,timestampParam:s.timestampParam||this.timestampParam,policyPort:s.policyPort||this.policyPort,pfx:s.pfx||this.pfx,key:s.key||this.key,passphrase:s.passphrase||this.passphrase,cert:s.cert||this.cert,ca:s.ca||this.ca,ciphers:s.ciphers||this.ciphers,rejectUnauthorized:s.rejectUnauthorized||this.rejectUnauthorized,perMessageDeflate:s.perMessageDeflate||this.perMessageDeflate,extraHeaders:s.extraHeaders||this.extraHeaders,forceNode:s.forceNode||this.forceNode,localAddress:s.localAddress||this.localAddress,requestTimeout:s.requestTimeout||this.requestTimeout,protocols:s.protocols||void 0,isReactNative:this.isReactNative})},di.prototype.open=function(){var t;if(this.rememberUpgrade&&di.priorWebsocketSuccess&&-1!==this.transports.indexOf("websocket"))t="websocket";else{if(0===this.transports.length){var i=this;return void setTimeout((function(){i.emit("error","No transports available")}),0)}t=this.transports[0]}this.readyState="opening";try{t=this.createTransport(t)}catch(t){return this.transports.shift(),void this.open()}t.open(),this.setTransport(t)},di.prototype.setTransport=function(t){ci("setting transport %s",t.name);var i=this;this.transport&&(ci("clearing existing transport %s",this.transport.name),this.transport.removeAllListeners()),this.transport=t,t.on("drain",(function(){i.onDrain()})).on("packet",(function(t){i.onPacket(t)})).on("error",(function(t){i.onError(t)})).on("close",(function(){i.onClose("transport close")}))},di.prototype.probe=function(t){ci('probing transport "%s"',t);var i=this.createTransport(t,{probe:1}),s=!1,e=this;function n(){e.onlyBinaryUpgrades&&(s=s||!this.supportsBinary&&e.transport.supportsBinary),s||(ci('probe transport "%s" opened',t),i.send([{type:"ping",data:"probe"}]),i.once("packet",(function(n){if(!s)if("pong"===n.type&&"probe"===n.data){if(ci('probe transport "%s" pong',t),e.upgrading=!0,e.emit("upgrading",i),!i)return;di.priorWebsocketSuccess="websocket"===i.name,ci('pausing current transport "%s"',e.transport.name),e.transport.pause((function(){s||"closed"!==e.readyState&&(ci("changing transport and sending upgrade packet"),r(),e.setTransport(i),i.send([{type:"upgrade"}]),e.emit("upgrade",i),i=null,e.upgrading=!1,e.flush())}))}else{ci('probe transport "%s" failed',t);var l=new Error("probe error");l.transport=i.name,e.emit("upgradeError",l)}})))}function l(){s||(s=!0,r(),i.close(),i=null)}function h(s){var n=new Error("probe error: "+s);n.transport=i.name,l(),ci('probe transport "%s" failed because of error: %s',t,s),e.emit("upgradeError",n)}function o(){h("transport closed")}function a(){h("socket closed")}function c(t){i&&t.name!==i.name&&(ci('"%s" works - aborting "%s"',t.name,i.name),l())}function r(){i.removeListener("open",n),i.removeListener("error",h),i.removeListener("close",o),e.removeListener("close",a),e.removeListener("upgrading",c)}di.priorWebsocketSuccess=!1,i.once("open",n),i.once("error",h),i.once("close",o),this.once("close",a),this.once("upgrading",c),i.open()},di.prototype.onOpen=function(){if(ci("socket open"),this.readyState="open",di.priorWebsocketSuccess="websocket"===this.transport.name,this.emit("open"),this.flush(),"open"===this.readyState&&this.upgrade&&this.transport.pause){ci("starting upgrade probes");for(var t=0,i=this.upgrades.length;t<i;t++)this.probe(this.upgrades[t])}},di.prototype.onPacket=function(t){if("opening"===this.readyState||"open"===this.readyState||"closing"===this.readyState)switch(ci('socket receive: type "%s", data "%s"',t.type,t.data),this.emit("packet",t),this.emit("heartbeat"),t.type){case"open":this.onHandshake(JSON.parse(t.data));break;case"pong":this.setPing(),this.emit("pong");break;case"error":var i=new Error("server error");i.code=t.data,this.onError(i);break;case"message":this.emit("data",t.data),this.emit("message",t.data)}else ci('packet received with socket readyState "%s"',this.readyState)},di.prototype.onHandshake=function(t){this.emit("handshake",t),this.id=t.sid,this.transport.query.sid=t.sid,this.upgrades=this.filterUpgrades(t.upgrades),this.pingInterval=t.pingInterval,this.pingTimeout=t.pingTimeout,this.onOpen(),"closed"!==this.readyState&&(this.setPing(),this.removeListener("heartbeat",this.onHeartbeat),this.on("heartbeat",this.onHeartbeat))},di.prototype.onHeartbeat=function(t){clearTimeout(this.pingTimeoutTimer);var i=this;i.pingTimeoutTimer=setTimeout((function(){"closed"!==i.readyState&&i.onClose("ping timeout")}),t||i.pingInterval+i.pingTimeout)},di.prototype.setPing=function(){var t=this;clearTimeout(t.pingIntervalTimer),t.pingIntervalTimer=setTimeout((function(){ci("writing ping packet - expecting pong within %sms",t.pingTimeout),t.ping(),t.onHeartbeat(t.pingTimeout)}),t.pingInterval)},di.prototype.ping=function(){var t=this;this.sendPacket("ping",(function(){t.emit("ping")}))},di.prototype.onDrain=function(){this.writeBuffer.splice(0,this.prevBufferLen),this.prevBufferLen=0,0===this.writeBuffer.length?this.emit("drain"):this.flush()},di.prototype.flush=function(){"closed"!==this.readyState&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length&&(ci("flushing %d packets in socket",this.writeBuffer.length),this.transport.send(this.writeBuffer),this.prevBufferLen=this.writeBuffer.length,this.emit("flush"))},di.prototype.write=di.prototype.send=function(t,i,s){return this.sendPacket("message",t,i,s),this},di.prototype.sendPacket=function(t,i,s,e){if("function"==typeof i&&(e=i,i=void 0),"function"==typeof s&&(e=s,s=null),"closing"!==this.readyState&&"closed"!==this.readyState){(s=s||{}).compress=!1!==s.compress;var n={type:t,data:i,options:s};this.emit("packetCreate",n),this.writeBuffer.push(n),e&&this.once("flush",e),this.flush()}},di.prototype.close=function(){if("opening"===this.readyState||"open"===this.readyState){this.readyState="closing";var t=this;this.writeBuffer.length?this.once("drain",(function(){this.upgrading?e():i()})):this.upgrading?e():i()}function i(){t.onClose("forced close"),ci("socket closing - telling transport to close"),t.transport.close()}function s(){t.removeListener("upgrade",s),t.removeListener("upgradeError",s),i()}function e(){t.once("upgrade",s),t.once("upgradeError",s)}return this},di.prototype.onError=function(t){ci("socket error %j",t),di.priorWebsocketSuccess=!1,this.emit("error",t),this.onClose("transport error",t)},di.prototype.onClose=function(t,i){"opening"!==this.readyState&&"open"!==this.readyState&&"closing"!==this.readyState||(ci('socket close with reason: "%s"',t),clearTimeout(this.pingIntervalTimer),clearTimeout(this.pingTimeoutTimer),this.transport.removeAllListeners("close"),this.transport.close(),this.transport.removeAllListeners(),this.readyState="closed",this.id=null,this.emit("close",t,i),this.writeBuffer=[],this.prevBufferLen=0)},di.prototype.filterUpgrades=function(t){for(var i=[],s=0,e=t.length;s<e;s++)~ai(this.transports,t[s])&&i.push(t[s]);return i};var ui=ri;ui.parser=pt;var mi=e((function(t){function i(t){if(t)return function(t){for(var s in i.prototype)t[s]=i.prototype[s];return t}(t)}t.exports=i,i.prototype.on=i.prototype.addEventListener=function(t,i){return this._callbacks=this._callbacks||{},(this._callbacks["$"+t]=this._callbacks["$"+t]||[]).push(i),this},i.prototype.once=function(t,i){function s(){this.off(t,s),i.apply(this,arguments)}return s.fn=i,this.on(t,s),this},i.prototype.off=i.prototype.removeListener=i.prototype.removeAllListeners=i.prototype.removeEventListener=function(t,i){if(this._callbacks=this._callbacks||{},0==arguments.length)return this._callbacks={},this;var s,e=this._callbacks["$"+t];if(!e)return this;if(1==arguments.length)return delete this._callbacks["$"+t],this;for(var n=0;n<e.length;n++)if((s=e[n])===i||s.fn===i){e.splice(n,1);break}return this},i.prototype.emit=function(t){this._callbacks=this._callbacks||{};var i=[].slice.call(arguments,1),s=this._callbacks["$"+t];if(s)for(var e=0,n=(s=s.slice(0)).length;e<n;++e)s[e].apply(this,i);return this},i.prototype.listeners=function(t){return this._callbacks=this._callbacks||{},this._callbacks["$"+t]||[]},i.prototype.hasListeners=function(t){return!!this.listeners(t).length}})),bi=function(t,i){for(var s=[],e=(i=i||0)||0;e<t.length;e++)s[e-i]=t[e];return s},Zi=function(t,i,s){return t.on(i,s),{destroy:function(){t.removeListener(i,s)}}},pi=[].slice,Gi=function(t,i){if("string"==typeof i&&(i=t[i]),"function"!=typeof i)throw new Error("bind() requires a function");var s=pi.call(arguments,2);return function(){return i.apply(t,s.concat(pi.call(arguments)))}},Xi=e((function(t){var i=p("socket.io-client:socket");t.exports=n;var s={connect:1,connect_error:1,connect_timeout:1,connecting:1,disconnect:1,error:1,reconnect:1,reconnect_attempt:1,reconnect_failed:1,reconnect_error:1,reconnecting:1,ping:1,pong:1},e=mi.prototype.emit;function n(t,i,s){this.io=t,this.nsp=i,this.json=this,this.ids=0,this.acks={},this.receiveBuffer=[],this.sendBuffer=[],this.connected=!1,this.disconnected=!0,this.flags={},s&&s.query&&(this.query=s.query),this.io.autoConnect&&this.open()}mi(n.prototype),n.prototype.subEvents=function(){if(!this.subs){var t=this.io;this.subs=[Zi(t,"open",Gi(this,"onopen")),Zi(t,"packet",Gi(this,"onpacket")),Zi(t,"close",Gi(this,"onclose"))]}},n.prototype.open=n.prototype.connect=function(){return this.connected||(this.subEvents(),this.io.open(),"open"===this.io.readyState&&this.onopen(),this.emit("connecting")),this},n.prototype.send=function(){var t=bi(arguments);return t.unshift("message"),this.emit.apply(this,t),this},n.prototype.emit=function(t){if(s.hasOwnProperty(t))return e.apply(this,arguments),this;var n=bi(arguments),l={type:(void 0!==this.flags.binary?this.flags.binary:P(n))?w.BINARY_EVENT:w.EVENT,data:n,options:{}};return l.options.compress=!this.flags||!1!==this.flags.compress,"function"==typeof n[n.length-1]&&(i("emitting packet with ack id %d",this.ids),this.acks[this.ids]=n.pop(),l.id=this.ids++),this.connected?this.packet(l):this.sendBuffer.push(l),this.flags={},this},n.prototype.packet=function(t){t.nsp=this.nsp,this.io.packet(t)},n.prototype.onopen=function(){if(i("transport is open - connecting"),"/"!==this.nsp)if(this.query){var t="object"==typeof this.query?Vt(this.query):this.query;i("sending connect packet with query %s",t),this.packet({type:w.CONNECT,query:t})}else this.packet({type:w.CONNECT})},n.prototype.onclose=function(t){i("close (%s)",t),this.connected=!1,this.disconnected=!0,delete this.id,this.emit("disconnect",t)},n.prototype.onpacket=function(t){if(t.nsp===this.nsp||t.type===w.ERROR&&"/"===t.nsp)switch(t.type){case w.CONNECT:this.onconnect();break;case w.EVENT:case w.BINARY_EVENT:this.onevent(t);break;case w.ACK:case w.BINARY_ACK:this.onack(t);break;case w.DISCONNECT:this.ondisconnect();break;case w.ERROR:this.emit("error",t.data)}},n.prototype.onevent=function(t){var s=t.data||[];i("emitting event %j",s),null!=t.id&&(i("attaching ack callback to event"),s.push(this.ack(t.id))),this.connected?e.apply(this,s):this.receiveBuffer.push(s)},n.prototype.ack=function(t){var s=this,e=!1;return function(){if(!e){e=!0;var n=bi(arguments);i("sending ack %j",n),s.packet({type:P(n)?w.BINARY_ACK:w.ACK,id:t,data:n})}}},n.prototype.onack=function(t){var s=this.acks[t.id];"function"==typeof s?(i("calling ack %s with %j",t.id,t.data),s.apply(this,t.data),delete this.acks[t.id]):i("bad ack %s",t.id)},n.prototype.onconnect=function(){this.connected=!0,this.disconnected=!1,this.emit("connect"),this.emitBuffered()},n.prototype.emitBuffered=function(){var t;for(t=0;t<this.receiveBuffer.length;t++)e.apply(this,this.receiveBuffer[t]);for(this.receiveBuffer=[],t=0;t<this.sendBuffer.length;t++)this.packet(this.sendBuffer[t]);this.sendBuffer=[]},n.prototype.ondisconnect=function(){i("server disconnect (%s)",this.nsp),this.destroy(),this.onclose("io server disconnect")},n.prototype.destroy=function(){if(this.subs){for(var t=0;t<this.subs.length;t++)this.subs[t].destroy();this.subs=null}this.io.destroy(this)},n.prototype.close=n.prototype.disconnect=function(){return this.connected&&(i("performing disconnect (%s)",this.nsp),this.packet({type:w.DISCONNECT})),this.destroy(),this.connected&&this.onclose("io client disconnect"),this},n.prototype.compress=function(t){return this.flags.compress=t,this},n.prototype.binary=function(t){return this.flags.binary=t,this}})),yi=fi;function fi(t){this.ms=(t=t||{}).min||100,this.max=t.max||1e4,this.factor=t.factor||2,this.jitter=t.jitter>0&&t.jitter<=1?t.jitter:0,this.attempts=0}fi.prototype.duration=function(){var t=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var i=Math.random(),s=Math.floor(i*this.jitter*t);t=0==(1&Math.floor(10*i))?t-s:t+s}return 0|Math.min(t,this.max)},fi.prototype.reset=function(){this.attempts=0},fi.prototype.setMin=function(t){this.ms=t},fi.prototype.setMax=function(t){this.max=t},fi.prototype.setJitter=function(t){this.jitter=t};var Vi=p("socket.io-client:manager"),gi=Object.prototype.hasOwnProperty,Ri=Wi;function Wi(t,i){if(!(this instanceof Wi))return new Wi(t,i);t&&"object"==typeof t&&(i=t,t=void 0),(i=i||{}).path=i.path||"/socket.io",this.nsps={},this.subs=[],this.opts=i,this.reconnection(!1!==i.reconnection),this.reconnectionAttempts(i.reconnectionAttempts||1/0),this.reconnectionDelay(i.reconnectionDelay||1e3),this.reconnectionDelayMax(i.reconnectionDelayMax||5e3),this.randomizationFactor(i.randomizationFactor||.5),this.backoff=new yi({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()}),this.timeout(null==i.timeout?2e4:i.timeout),this.readyState="closed",this.uri=t,this.connecting=[],this.lastPing=null,this.encoding=!1,this.packetBuffer=[];var s=i.parser||w;this.encoder=new s.Encoder,this.decoder=new s.Decoder,this.autoConnect=!1!==i.autoConnect,this.autoConnect&&this.open()}Wi.prototype.emitAll=function(){for(var t in this.emit.apply(this,arguments),this.nsps)gi.call(this.nsps,t)&&this.nsps[t].emit.apply(this.nsps[t],arguments)},Wi.prototype.updateSocketIds=function(){for(var t in this.nsps)gi.call(this.nsps,t)&&(this.nsps[t].id=this.generateId(t))},Wi.prototype.generateId=function(t){return("/"===t?"":t+"#")+this.engine.id},mi(Wi.prototype),Wi.prototype.reconnection=function(t){return arguments.length?(this._reconnection=!!t,this):this._reconnection},Wi.prototype.reconnectionAttempts=function(t){return arguments.length?(this._reconnectionAttempts=t,this):this._reconnectionAttempts},Wi.prototype.reconnectionDelay=function(t){return arguments.length?(this._reconnectionDelay=t,this.backoff&&this.backoff.setMin(t),this):this._reconnectionDelay},Wi.prototype.randomizationFactor=function(t){return arguments.length?(this._randomizationFactor=t,this.backoff&&this.backoff.setJitter(t),this):this._randomizationFactor},Wi.prototype.reconnectionDelayMax=function(t){return arguments.length?(this._reconnectionDelayMax=t,this.backoff&&this.backoff.setMax(t),this):this._reconnectionDelayMax},Wi.prototype.timeout=function(t){return arguments.length?(this._timeout=t,this):this._timeout},Wi.prototype.maybeReconnectOnOpen=function(){!this.reconnecting&&this._reconnection&&0===this.backoff.attempts&&this.reconnect()},Wi.prototype.open=Wi.prototype.connect=function(t){if(Vi("readyState %s",this.readyState),~this.readyState.indexOf("open"))return this;Vi("opening %s",this.uri),this.engine=ui(this.uri,this.opts);var i=this.engine,s=this;this.readyState="opening",this.skipReconnect=!1;var e=Zi(i,"open",(function(){s.onopen(),t&&t()})),n=Zi(i,"error",(function(i){if(Vi("connect_error"),s.cleanup(),s.readyState="closed",s.emitAll("connect_error",i),t){var e=new Error("Connection error");e.data=i,t(e)}else s.maybeReconnectOnOpen()}));if(!1!==this._timeout){var l=this._timeout;Vi("connect attempt will timeout after %d",l);var h=setTimeout((function(){Vi("connect attempt timed out after %d",l),e.destroy(),i.close(),i.emit("error","timeout"),s.emitAll("connect_timeout",l)}),l);this.subs.push({destroy:function(){clearTimeout(h)}})}return this.subs.push(e),this.subs.push(n),this},Wi.prototype.onopen=function(){Vi("open"),this.cleanup(),this.readyState="open",this.emit("open");var t=this.engine;this.subs.push(Zi(t,"data",Gi(this,"ondata"))),this.subs.push(Zi(t,"ping",Gi(this,"onping"))),this.subs.push(Zi(t,"pong",Gi(this,"onpong"))),this.subs.push(Zi(t,"error",Gi(this,"onerror"))),this.subs.push(Zi(t,"close",Gi(this,"onclose"))),this.subs.push(Zi(this.decoder,"decoded",Gi(this,"ondecoded")))},Wi.prototype.onping=function(){this.lastPing=new Date,this.emitAll("ping")},Wi.prototype.onpong=function(){this.emitAll("pong",new Date-this.lastPing)},Wi.prototype.ondata=function(t){this.decoder.add(t)},Wi.prototype.ondecoded=function(t){this.emit("packet",t)},Wi.prototype.onerror=function(t){Vi("error",t),this.emitAll("error",t)},Wi.prototype.socket=function(t,i){var s=this.nsps[t];if(!s){s=new Xi(this,t,i),this.nsps[t]=s;var e=this;s.on("connecting",n),s.on("connect",(function(){s.id=e.generateId(t)})),this.autoConnect&&n()}function n(){~ai(e.connecting,s)||e.connecting.push(s)}return s},Wi.prototype.destroy=function(t){var i=ai(this.connecting,t);~i&&this.connecting.splice(i,1),this.connecting.length||this.close()},Wi.prototype.packet=function(t){Vi("writing packet %j",t);var i=this;t.query&&0===t.type&&(t.nsp+="?"+t.query),i.encoding?i.packetBuffer.push(t):(i.encoding=!0,this.encoder.encode(t,(function(s){for(var e=0;e<s.length;e++)i.engine.write(s[e],t.options);i.encoding=!1,i.processPacketQueue()})))},Wi.prototype.processPacketQueue=function(){if(this.packetBuffer.length>0&&!this.encoding){var t=this.packetBuffer.shift();this.packet(t)}},Wi.prototype.cleanup=function(){Vi("cleanup");for(var t=this.subs.length,i=0;i<t;i++)this.subs.shift().destroy();this.packetBuffer=[],this.encoding=!1,this.lastPing=null,this.decoder.destroy()},Wi.prototype.close=Wi.prototype.disconnect=function(){Vi("disconnect"),this.skipReconnect=!0,this.reconnecting=!1,"opening"===this.readyState&&this.cleanup(),this.backoff.reset(),this.readyState="closed",this.engine&&this.engine.close()},Wi.prototype.onclose=function(t){Vi("onclose"),this.cleanup(),this.backoff.reset(),this.readyState="closed",this.emit("close",t),this._reconnection&&!this.skipReconnect&&this.reconnect()},Wi.prototype.reconnect=function(){if(this.reconnecting||this.skipReconnect)return this;var t=this;if(this.backoff.attempts>=this._reconnectionAttempts)Vi("reconnect failed"),this.backoff.reset(),this.emitAll("reconnect_failed"),this.reconnecting=!1;else{var i=this.backoff.duration();Vi("will wait %dms before reconnect attempt",i),this.reconnecting=!0;var s=setTimeout((function(){t.skipReconnect||(Vi("attempting reconnect"),t.emitAll("reconnect_attempt",t.backoff.attempts),t.emitAll("reconnecting",t.backoff.attempts),t.skipReconnect||t.open((function(i){i?(Vi("reconnect attempt error"),t.reconnecting=!1,t.reconnect(),t.emitAll("reconnect_error",i.data)):(Vi("reconnect success"),t.onreconnect())})))}),i);this.subs.push({destroy:function(){clearTimeout(s)}})}},Wi.prototype.onreconnect=function(){var t=this.backoff.attempts;this.reconnecting=!1,this.backoff.reset(),this.updateSocketIds(),this.emitAll("reconnect",t)};var Ii=e((function(t,i){var s=p("socket.io-client");t.exports=i=n;var e=i.managers={};function n(t,i){"object"==typeof t&&(i=t,t=void 0),i=i||{};var n,l=X(t),h=l.source,o=l.id;return i.forceNew||i["force new connection"]||!1===i.multiplex||e[o]&&l.path in e[o].nsps?(s("ignoring socket cache for %s",h),n=Ri(h,i)):(e[o]||(s("new io instance for %s",h),e[o]=Ri(h,i)),n=e[o]),l.query&&!i.query&&(i.query=l.query),n.socket(l.path,i)}i.protocol=w.protocol,i.connect=n,i.Manager=Ri,i.Socket=Xi}));function Si(){}function Li(){Li.init.call(this)}function xi(t){return void 0===t._maxListeners?Li.defaultMaxListeners:t._maxListeners}function vi(t,i,s){if(i)t.call(s);else for(var e=t.length,n=Ti(t,e),l=0;l<e;++l)n[l].call(s)}function Yi(t,i,s,e){if(i)t.call(s,e);else for(var n=t.length,l=Ti(t,n),h=0;h<n;++h)l[h].call(s,e)}function Mi(t,i,s,e,n){if(i)t.call(s,e,n);else for(var l=t.length,h=Ti(t,l),o=0;o<l;++o)h[o].call(s,e,n)}function Ki(t,i,s,e,n,l){if(i)t.call(s,e,n,l);else for(var h=t.length,o=Ti(t,h),a=0;a<h;++a)o[a].call(s,e,n,l)}function Ci(t,i,s,e){if(i)t.apply(s,e);else for(var n=t.length,l=Ti(t,n),h=0;h<n;++h)l[h].apply(s,e)}function wi(t,i,s,e){var n,l,h,o;if("function"!=typeof s)throw new TypeError('"listener" argument must be a function');if((l=t._events)?(l.newListener&&(t.emit("newListener",i,s.listener?s.listener:s),l=t._events),h=l[i]):(l=t._events=new Si,t._eventsCount=0),h){if("function"==typeof h?h=l[i]=e?[s,h]:[h,s]:e?h.unshift(s):h.push(s),!h.warned&&(n=xi(t))&&n>0&&h.length>n){h.warned=!0;var a=new Error("Possible EventEmitter memory leak detected. "+h.length+" "+i+" listeners added. Use emitter.setMaxListeners() to increase limit");a.name="MaxListenersExceededWarning",a.emitter=t,a.type=i,a.count=h.length,o=a,"function"==typeof console.warn?console.warn(o):console.log(o)}}else h=l[i]=s,++t._eventsCount;return t}function Fi(t,i,s){var e=!1;function n(){t.removeListener(i,n),e||(e=!0,s.apply(t,arguments))}return n.listener=s,n}function Ni(t){var i=this._events;if(i){var s=i[t];if("function"==typeof s)return 1;if(s)return s.length}return 0}function Ti(t,i){for(var s=new Array(i);i--;)s[i]=t[i];return s}Si.prototype=Object.create(null),Li.EventEmitter=Li,Li.usingDomains=!1,Li.prototype.domain=void 0,Li.prototype._events=void 0,Li.prototype._maxListeners=void 0,Li.defaultMaxListeners=10,Li.init=function(){this.domain=null,this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=new Si,this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},Li.prototype.setMaxListeners=function(t){if("number"!=typeof t||t<0||isNaN(t))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=t,this},Li.prototype.getMaxListeners=function(){return xi(this)},Li.prototype.emit=function(t){var i,s,e,n,l,h,o,a="error"===t;if(h=this._events)a=a&&null==h.error;else if(!a)return!1;if(o=this.domain,a){if(i=arguments[1],!o){if(i instanceof Error)throw i;var c=new Error('Uncaught, unspecified "error" event. ('+i+")");throw c.context=i,c}return i||(i=new Error('Uncaught, unspecified "error" event')),i.domainEmitter=this,i.domain=o,i.domainThrown=!1,o.emit("error",i),!1}if(!(s=h[t]))return!1;var r="function"==typeof s;switch(e=arguments.length){case 1:vi(s,r,this);break;case 2:Yi(s,r,this,arguments[1]);break;case 3:Mi(s,r,this,arguments[1],arguments[2]);break;case 4:Ki(s,r,this,arguments[1],arguments[2],arguments[3]);break;default:for(n=new Array(e-1),l=1;l<e;l++)n[l-1]=arguments[l];Ci(s,r,this,n)}return!0},Li.prototype.on=Li.prototype.addListener=function(t,i){return wi(this,t,i,!1)},Li.prototype.prependListener=function(t,i){return wi(this,t,i,!0)},Li.prototype.once=function(t,i){if("function"!=typeof i)throw new TypeError('"listener" argument must be a function');return this.on(t,Fi(this,t,i)),this},Li.prototype.prependOnceListener=function(t,i){if("function"!=typeof i)throw new TypeError('"listener" argument must be a function');return this.prependListener(t,Fi(this,t,i)),this},Li.prototype.removeListener=function(t,i){var s,e,n,l,h;if("function"!=typeof i)throw new TypeError('"listener" argument must be a function');if(!(e=this._events))return this;if(!(s=e[t]))return this;if(s===i||s.listener&&s.listener===i)0==--this._eventsCount?this._events=new Si:(delete e[t],e.removeListener&&this.emit("removeListener",t,s.listener||i));else if("function"!=typeof s){for(n=-1,l=s.length;l-- >0;)if(s[l]===i||s[l].listener&&s[l].listener===i){h=s[l].listener,n=l;break}if(n<0)return this;if(1===s.length){if(s[0]=void 0,0==--this._eventsCount)return this._events=new Si,this;delete e[t]}else!function(t,i){for(var s=i,e=s+1,n=t.length;e<n;s+=1,e+=1)t[s]=t[e];t.pop()}(s,n);e.removeListener&&this.emit("removeListener",t,h||i)}return this},Li.prototype.removeAllListeners=function(t){var i,s;if(!(s=this._events))return this;if(!s.removeListener)return 0===arguments.length?(this._events=new Si,this._eventsCount=0):s[t]&&(0==--this._eventsCount?this._events=new Si:delete s[t]),this;if(0===arguments.length){for(var e,n=Object.keys(s),l=0;l<n.length;++l)"removeListener"!==(e=n[l])&&this.removeAllListeners(e);return this.removeAllListeners("removeListener"),this._events=new Si,this._eventsCount=0,this}if("function"==typeof(i=s[t]))this.removeListener(t,i);else if(i)do{this.removeListener(t,i[i.length-1])}while(i[0]);return this},Li.prototype.listeners=function(t){var i,s=this._events;return s&&(i=s[t])?"function"==typeof i?[i.listener||i]:function(t){for(var i=new Array(t.length),s=0;s<i.length;++s)i[s]=t[s].listener||t[s];return i}(i):[]},Li.listenerCount=function(t,i){return"function"==typeof t.listenerCount?t.listenerCount(i):Ni.call(t,i)},Li.prototype.listenerCount=Ni,Li.prototype.eventNames=function(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]};var Ji=Object.freeze({__proto__:null,default:Li,EventEmitter:Li}).EventEmitter;const zi={JOIN_ROOM:"join-room",PING_ROOM:"ping-room",LEAVE_ROOM:"leave-room"};class Hi{constructor(t,i){this.userData=t,this.socketUrl=i,this.users={},this.userStreams={},this.callbacks={},this.envIsBrowser="undefined"!=typeof window}stopCamera(t=!0){this.stream&&(this.stream.getVideoTracks()[0].enabled=!1,t&&this.pub(Hi.actions.USER_VIDEO_STOPPED,{}))}startCamera(t=!0){this.stream&&(this.stream.getVideoTracks()[0].enabled=!0,t&&this.pub(Hi.actions.USER_VIDEO_STARTED,{}))}muteAudio(t=!0){this.stream&&(this.stream.getAudioTracks()[0].enabled=!1,t&&this.pub(Hi.actions.USER_VIDEO_STOPPED,{}))}unmuteAudio(t=!0){this.stream&&(this.stream.getAudioTracks()[0].enabled=!0,t&&this.pub(Hi.actions.USER_AUDIO_STARTED,{}))}getVideoStream(t){return this.userStreams[t]}setVideoStream(t,i){if(this.userStreams[i])return;const s=document.createElement("video");s.srcObject=t,this.userStreams[i]=s,s.onloadedmetadata=()=>{s.play()},document.body.appendChild(s)}static concatFullRoomId(t,i,s){return t+(i||"_ALL_FILES_")+(s||"_ALL_ROOMS_")}isJoiningTheSameRoom(t,i,s){return this.fullRoomId===Hi.concatFullRoomId(t,i,s)}joinRoom(t,i,s){this.projectId=t,this.fileId=i,this.roomId=s,this.fullRoomId=Hi.concatFullRoomId(this.projectId,this.fileId,this.roomId),this.leaveRoom(),this.socket=Ii(this.socketUrl,{"sync disconnect on unload":!0,query:`userId=${this.userData.id}&roomId=${this.fullRoomId}`}),function(){var t=(Ii.Manager||Ji).prototype.emit;function i(i){var s=i.data||[];return null!=i.id&&s.push(this.ack(i.id)),t.call(this,"*",i),t.apply(this,s)}return function(t,s){return t.onevent!==i&&(t.onevent=i),s?s():null}}()(this.socket),this.socket.on("*",t=>{const[i,s]=t.data;i in zi||this._emit(i,s.payload,s.userId)}),this.envIsBrowser&&window.addEventListener("beforeunload",()=>{this.leaveRoom()}),this.pub(zi.JOIN_ROOM),this.socket.on(zi.JOIN_ROOM,t=>{console.info(zi.JOIN_ROOM+":",t),this._addUserIfNew(t.userData),this.pub(zi.PING_ROOM)}),this.socket.on(zi.LEAVE_ROOM,t=>{console.info(zi.LEAVE_ROOM+":",t);const i=t.userData,s=i.id;if(s in this.users)return delete this.users[s],void this._emit(Hi.actions.USER_LEFT,i);console.warn("Outgoing user was not found in room.")}),this.socket.on(zi.PING_ROOM,t=>{console.info(zi.PING_ROOM+":",t),this._addUserIfNew(t.userData)})}_prepareMediaStream(){return this.__streamPromise||(this.__streamPromise=new window.Promise((t,i)=>{this.stream?t():navigator.mediaDevices.getUserMedia({audio:!0,video:{width:400,height:300}}).then(i=>{this.stream=i,this.stopCamera(!1),this.muteAudio(!1),t()}).catch(t=>{i(t)})})),this.__streamPromise}leaveRoom(){this._emit(Hi.actions.LEFT_ROOM),this.users={},this.socket&&this.pub(zi.LEAVE_ROOM,void 0,()=>{this.socket.close()})}_addUserIfNew(t){t.id in this.users||(this.users[t.id]=t,this._emit(Hi.actions.USER_JOINED,t))}createRoom(){return this.roomId=shortid.generate(),this.joinRoom(this.projectId,this.fileId,this.roomId),this.envIsBrowser&&window.history.pushState(null,null,`?project-id=${this.projectId}&file-id=${this.fileId}&room-id=${this.roomId}`),this.roomId}getUsers(){return this.users}getUser(t){return this.users[t]}pub(t,i,s){if(!t)throw new Error("Missing messageType");this.socket.emit(t,{userData:this.userData,userId:this.userData.id,payload:i},s)}_emit(t,i,s){const e=this.callbacks[t];e&&e.forEach(t=>t(i,s))}sub(t,i){if(!t)throw new Error("Missing messageType");if(!i)throw new Error("Missing callback");return this.callbacks[t]=this.callbacks[t]||[],this.callbacks[t].push(i),()=>{this.callbacks[t].splice(this.callbacks[t].indexOf(i),1)}}}Hi.actions={USER_JOINED:"user-joined",USER_VIDEO_STARTED:"user-video-started",USER_VIDEO_STOPPED:"user-video-stopped",USER_AUDIO_STARTED:"user-audio-started",USER_AUDIO_STOPPED:"user-audio-stopped",USER_LEFT:"user-left",LEFT_ROOM:"left-room",TEXT_MESSAGE:"text-message",POSE_CHANGED:"pose-message",COMMAND_ADDED:"command-added",COMMAND_UPDATED:"command-updated",FILE_WITH_PROGRESS:"file-with-progress"};const Ui=Object.freeze({__proto__:null,Session:Hi,SessionFactory:class{static setSocketURL(t){this.socketUrl=t}static getInstance(t,i,s,e){if(!this.session){if(!this.socketUrl)throw new Error("Missing #socketUrl. Call #setSocketURL first.");this.session=new Hi(t,this.socketUrl)}return this.session.isJoiningTheSameRoom(i,s,e)||this.session.joinRoom(i,s,e),this.session}static getCurrentSession(){return this.session}},SessionRecorder:class{constructor(t){if(this.actionRegistry=t,this.__recordings={},self.origin.startsWith("https://localhost")){const i=["https://upload.wikimedia.org/wikipedia/commons/7/7c/Profile_avatar_placeholder_large.png"],s={};let e,n,l;const h=()=>{const t=(h=i.length,Math.floor(Math.random()*Math.floor(h)));var h;e={id:"_"+Math.random().toString(36).substr(2,9),picture:i[t],name:"Presenter"+Object.keys(s).length},l=[];let o={messageType:"user-joined",payload:e},a=performance.now();n=this.session.pub,this.session.pub=(t,i)=>{const s=performance.now();o.ms=s-a,l.push(o),o={messageType:t,payload:i},a=s,n.call(this.session,t,i)}},o=()=>{l.push({messageType:"user-left",payload:e}),s[e.id]=l,this.session.pub=n,this.__playRecording(s)};let a=!1;t.registerAction({path:["Sessions"],name:"Toggle Recording",callback:()=>{a?(o(),a=!1):(h(),a=!0)},availableInVR:!0}),t.registerAction({path:["Sessions"],name:"Stop Recording",callback:()=>{o()},availableInVR:!0}),t.registerAction({path:["Sessions"],name:"Save",callback:()=>{this.save(s)}})}}setSession(t){this.session=t}setResourceLoader(t){this.resourceLoader=t;const i=t=>{this.__recordings[t.name]=t,this.actionRegistry.registerAction({path:["Sessions","Recordings"],name:t.name,callback:()=>{this.playRecording(t.name)},availableInVR:!0})};this.resourceLoader.registerResourceCallback(".rec",t=>{i(t)})}save(t){!function(t,i){var s=new Blob([t],{type:"application/json"});if(window.navigator.msSaveOrOpenBlob)window.navigator.msSaveOrOpenBlob(s,i);else{var e=document.createElement("a"),n=URL.createObjectURL(s);e.href=n,e.download=i,document.body.appendChild(e),e.click(),setTimeout((function(){document.body.removeChild(e),window.URL.revokeObjectURL(n)}),0)}}(JSON.stringify(t),"MyRec.rec")}__stopPlayback(){for(let t in this.__timeoutIds)clearTimeout(this.__timeoutIds[t]);this.__timeoutIds={}}__play(t,i,s){let e=0;const n=()=>{const l=i[e];this.session._emit(l.messageType,l.payload,t),e++,e<i.length?this.__timeoutIds[t]=setTimeout(n,l.ms):s()};this.__timeoutIds[t]=setTimeout(n,1e3)}__playRecording(t){this.__stopPlayback();let i=0;this.__timeoutIds={};for(let s in t)i++,this.__play(s,t[s],()=>{i--,0==i&&this.__playRecording(t)})}playRecording(t){this.resourceLoader.loadResource(this.__recordings[t].id,t=>{const i=JSON.parse(session.decodeText(t.rec));this.__playRecording(i)})}}});var ki=e((function(t,i){Object.defineProperty(i,"__esModule",{value:!0});var s=n,e=Ui;const l={},h={},o=[];class a{constructor(){this.__undoStack=[],this.__redoStack=[],this.changeAdded=new s.Signal,this.changeUpdated=new s.Signal,this.changeUndone=new s.Signal,this.changeRedone=new s.Signal,this.__currChangeUpdated=this.__currChangeUpdated.bind(this)}flush(){for(const t of this.__undoStack)t.destroy();this.__undoStack=[];for(const t of this.__redoStack)t.destroy();this.__redoStack=[]}addChange(t){this.getCurrentChange()&&this.getCurrentChange().updated.disconnect(this.__currChangeUpdated),this.__undoStack.push(t),t.updated.connect(this.__currChangeUpdated);for(const t of this.__redoStack)t.destroy();this.__redoStack=[],this.changeAdded.emit(t)}getCurrentChange(){return this.__undoStack[this.__undoStack.length-1]}__currChangeUpdated(t){this.changeUpdated.emit(t)}undo(t=!0){if(this.__undoStack.length>0){const i=this.__undoStack.pop();i.undo(),t&&(this.__redoStack.push(i),this.changeUndone.emit())}}redo(){if(this.__redoStack.length>0){const t=this.__redoStack.pop();t.redo(),this.__undoStack.push(t),this.changeRedone.emit()}}constructChange(t){return new l[t]}static getChangeClassName(t){const i=o.indexOf(t.constructor);return h[i]?h[i]:(console.warn("Change not registered:",t.constructor.name),t.constructor.name)}static registerChange(t,i){-1!=o.indexOf(i)&&console.warn("Class already registered:",t);const s=o.length;o.push(i),l[t]=i,h[s]=t}}class c{constructor(t){this.name=t||a.getChangeClassName(this),this.updated=new s.Signal}undo(){throw new Error("Implement me")}redo(){throw new Error("Implement me")}update(t){throw new Error("Implement me")}toJSON(t){return{}}fromJSON(t,i){}changeFromJSON(t){this.update(t)}destroy(){}}class r extends s.TreeItem{constructor(t){super(t),this.captured=!1}highlight(){}unhighlight(){}getManipulationPlane(){const t=this.getGlobalXfo();return new s.Ray(t.tr,t.ori.getZaxis())}onMouseEnter(t){this.highlight()}onMouseLeave(t){this.unhighlight()}onMouseDown(t){t.setCapture(this),t.stopPropagation(),this.captured=!0,t.viewport?this.handleMouseDown(t):t.vrviewport&&this.onVRControllerButtonDown(t)}onMouseMove(t){this.captured&&(t.stopPropagation(),t.viewport?this.handleMouseMove(t):t.vrviewport&&this.onVRPoseChanged(t))}onMouseUp(t){this.captured&&(t.releaseCapture(),t.stopPropagation(),this.captured=!1,t.viewport?this.handleMouseUp(t):t.vrviewport&&this.onVRControllerButtonUp(t))}onWheel(t){}handleMouseDown(t){this.gizmoRay=this.getManipulationPlane();const i=t.mouseRay.intersectRayPlane(this.gizmoRay);return t.grabPos=t.mouseRay.pointAtDist(i),this.onDragStart(t),!0}handleMouseMove(t){const i=t.mouseRay.intersectRayPlane(this.gizmoRay);return t.holdPos=t.mouseRay.pointAtDist(i),this.onDrag(t),!0}handleMouseUp(t){const i=t.mouseRay.intersectRayPlane(this.gizmoRay);return t.releasePos=t.mouseRay.pointAtDist(i),this.onDragEnd(t),!0}onVRControllerButtonDown(t){this.activeController=t.controller;const i=this.activeController.getTipXfo().clone(),s=this.getManipulationPlane(),e=i.tr.subtract(s.start),n=i.tr.subtract(s.dir.scale(e.dot(s.dir)));return t.grabPos=n,this.onDragStart(t),!0}onVRPoseChanged(t){if(this.activeController){const i=this.activeController.getTipXfo(),s=this.getManipulationPlane(),e=i.tr.subtract(s.start),n=i.tr.subtract(s.dir.scale(e.dot(s.dir)));return t.holdPos=n,this.onDrag(t),!0}}onVRControllerButtonUp(t){if(this.activeController==t.controller){const i=this.activeController.getTipXfo();return this.onDragEnd(t,i.tr),this.activeController=void 0,!0}}onDragStart(t){console.log("onDragStart",t)}onDrag(t){console.log("onDrag",t)}onDragEnd(t){console.log("onDragEnd",t)}}class d extends r{constructor(t){super(t)}handleMouseDown(t){this.gizmoRay=this.getManipulationPlane(),this.grabDist=t.mouseRay.intersectRayVector(this.gizmoRay)[1];const i=this.gizmoRay.pointAtDist(this.grabDist);return t.grabDist=this.grabDist,t.grabPos=i,this.onDragStart(t),!0}handleMouseMove(t){const i=t.mouseRay.intersectRayVector(this.gizmoRay)[1],s=this.gizmoRay.pointAtDist(i);t.holdDist=i,t.holdPos=s,t.value=i,t.delta=i-this.grabDist,this.onDrag(t)}handleMouseUp(t){const i=t.mouseRay.intersectRayVector(this.gizmoRay)[1],s=this.gizmoRay.pointAtDist(i);return t.releasePos=s,this.onDragEnd(t),!0}onVRControllerButtonDown(t){this.gizmoRay=this.getManipulationPlane(),this.activeController=t.controller;const i=this.activeController.getTipXfo();this.grabDist=i.tr.subtract(this.gizmoRay.start).dot(this.gizmoRay.dir);const s=this.gizmoRay.start.add(this.gizmoRay.dir.scale(this.grabDist));return t.grabPos=s,this.onDragStart(t),!0}onVRPoseChanged(t){const i=this.activeController.getTipXfo().tr.subtract(this.gizmoRay.start).dot(this.gizmoRay.dir),s=this.gizmoRay.start.add(this.gizmoRay.dir.scale(i));return t.value=i,t.holdPos=s,t.delta=i-this.grabDist,this.onDrag(t),!0}onVRControllerButtonUp(t){if(this.activeController==t.controller)return this.onDragEnd(),this.activeController=void 0,!0}}class u extends c{constructor(t,i,e=s.ValueSetMode.USER_SETVALUE){t?(super(t?t.getName()+" Changed":"ParameterValueChange"),this.__prevValue=t.getValue(),this.__param=t,this.__mode=e,null!=i&&(this.__nextValue=i,this.__param.setValue(this.__nextValue,e))):super()}undo(){this.__param&&this.__param.setValue(this.__prevValue,this.__mode)}redo(){this.__param&&this.__param.setValue(this.__nextValue,this.__mode)}update(t){this.__param&&(this.__nextValue=t.value,this.__param.setValue(this.__nextValue,t.mode?t.mode:this.__mode),this.updated.emit(t))}toJSON(t){const i={name:this.name,paramPath:this.__param.getPath()};return null!=this.__nextValue&&(i.value=this.__nextValue.toJSON?this.__nextValue.toJSON():this.__nextValue),i}fromJSON(t,i){const e=i.appData.scene.getRoot().resolvePath(t.paramPath,1);e&&e instanceof s.Parameter?(this.__param=e,this.__prevValue=this.__param.getValue(),this.__nextValue=this.__prevValue.clone?this.__prevValue.clone():this.__prevValue,this.name=t.name,null!=t.value&&this.changeFromJSON(t)):console.warn("resolvePath is unable to resolve",t.paramPath)}changeFromJSON(t){this.__param&&(this.__nextValue.fromJSON?this.__nextValue.fromJSON(t.value):this.__nextValue=t.value,this.__param.setValue(this.__nextValue,s.ValueSetMode.REMOTEUSER_SETVALUE))}}a.registerChange("ParameterValueChange",u);class m extends d{constructor(t,i,e,n){super(t),this.__color=n,this.__hilightedColor=new s.Color(1,1,1),this.colorParam=this.addParameter(new s.ColorParameter("BaseColor",n));const l=new s.Material("handle","HandleShader");l.getParameter("maintainScreenSize").setValue(1),l.replaceParameter(this.colorParam);const h=new s.Cylinder(e,i,64);h.getParameter("baseZAtZero").setValue(!0);const o=new s.Cone(4*e,10*e,64,!0),a=new s.GeomItem("handle",h,l),c=new s.GeomItem("tip",o,l),r=new s.Xfo;r.tr.set(0,0,i),o.transformVertices(r),this.addChild(a),this.addChild(c)}highlight(){this.colorParam.setValue(this.__hilightedColor)}unhighlight(){this.colorParam.setValue(this.__color)}setTargetParam(t,i=!0){if(this.param=t,i){const i=()=>{this.setGlobalXfo(t.getValue())};i(),t.valueChanged.connect(i)}}getTargetParam(){return this.param?this.param:this.getParameter("GlobalXfo")}onDragStart(t){this.grabPos=t.grabPos;const i=this.getTargetParam();this.baseXfo=i.getValue(),t.undoRedoManager&&(this.change=new u(i),t.undoRedoManager.addChange(this.change))}onDrag(t){const i=t.holdPos.subtract(this.grabPos),s=this.baseXfo.clone();s.tr.addInPlace(i),this.change?this.change.update({value:s}):this.param.setValue(s)}onDragEnd(t){this.change=null}}class b extends r{constructor(t){super(t),this.fullXfoManipulationInVR=!0}setTargetParam(t,i=!0){if(this.param=t,i){const i=()=>{this.setGlobalXfo(t.getValue())};i(),t.valueChanged.connect(i)}}getTargetParam(){return this.param?this.param:this.getParameter("GlobalXfo")}onDragStart(t){this.grabPos=t.grabPos;const i=this.getTargetParam();this.baseXfo=i.getValue(),t.undoRedoManager&&(this.change=new u(i),t.undoRedoManager.addChange(this.change))}onDrag(t){const i=t.holdPos.subtract(this.grabPos),s=this.baseXfo.clone();s.tr.addInPlace(i),this.change?this.change.update({value:s}):this.getTargetParam().setValue(s)}onDragEnd(t){this.change=null}onVRControllerButtonDown(t){if(this.fullXfoManipulationInVR){this.activeController=t.controller;const i=this.activeController.getTipXfo(),s=this.getGlobalXfo();this.grabOffset=i.inverse().multiply(s)}else super.onVRControllerButtonDown(t);return!0}onVRPoseChanged(t){if(this.fullXfoManipulationInVR){const t=this.activeController.getTipXfo().multiply(this.grabOffset);this.change?this.change.update({value:t}):this.getTargetParam().setValue(t)}else super.onVRPoseChanged(t)}onVRControllerButtonUp(t){this.fullXfoManipulationInVR?this.change=null:super.onVRControllerButtonUp(t)}}class Z extends r{constructor(t){super(t)}setTargetParam(t,i=!0){if(this.param=t,i){const i=()=>{this.setGlobalXfo(t.getValue())};i(),t.valueChanged.connect(i)}}getTargetParam(){return this.param?this.param:this.getParameter("GlobalXfo")}onDragStart(t){this.baseXfo=this.getGlobalXfo().clone(),this.baseXfo.sc.set(1,1,1),this.deltaXfo=new s.Xfo;const i=this.getTargetParam(),e=i.getValue();this.offsetXfo=this.baseXfo.inverse().multiply(e),this.vec0=t.grabPos.subtract(this.baseXfo.tr),this.grabCircleRadius=this.vec0.length(),this.vec0.normalizeInPlace(),t.undoRedoManager&&(this.change=new u(i),t.undoRedoManager.addChange(this.change))}onDrag(t){const i=t.holdPos.subtract(this.baseXfo.tr),e=i.length();i.normalizeInPlace();const n=e/this.grabCircleRadius;let l=this.vec0.angleTo(i)*n;if(this.vec0.cross(i).dot(this.baseXfo.ori.getZaxis())<0&&(l=-l),this.range&&(l=Math.clamp(l,this.range[0],this.range[1])),t.shiftKey){const t=Math.degToRad(22.5);l=Math.floor(l/t)*t}this.deltaXfo.ori.setFromAxisAndAngle(new s.Vec3(0,0,1),l);const h=this.baseXfo.multiply(this.deltaXfo).multiply(this.offsetXfo);this.change?this.change.update({value:h}):this.getTargetParam().setValue(h)}onDragEnd(t){this.change=null}}class p extends Z{constructor(t,i,e,n){super(t),this.__color=n,this.__hilightedColor=new s.Color(1,1,1),this.radiusParam=this.addParameter(new s.NumberParameter("radius",i)),this.colorParam=this.addParameter(new s.ColorParameter("BaseColor",n));const l=new s.Material("handle","HandleShader");l.getParameter("maintainScreenSize").setValue(1),l.replaceParameter(this.colorParam);const h=new s.Torus(e,i,64);this.handle=new s.GeomItem("handle",h,l),this.handleXfo=new s.Xfo,this.radiusParam.valueChanged.connect(()=>{i=this.radiusParam.getValue(),h.getParameter("radius").setValue(i),h.getParameter("height").setValue(.02*i)}),this.addChild(this.handle)}highlight(){this.colorParam.setValue(this.__hilightedColor)}unhighlight(){this.colorParam.setValue(this.__color)}getBaseXfo(){return this.getParameter("GlobalXfo").getValue()}onDragStart(t){super.onDragStart(t),this.colorParam.setValue(new s.Color(1,1,1))}onDrag(t){super.onDrag(t)}onDragEnd(t){super.onDragEnd(t),this.colorParam.setValue(this.__color)}}class G extends d{constructor(t,i,e,n){super(t),this.__color=n,this.__hilightedColor=new s.Color(1,1,1),this.colorParam=this.addParameter(new s.ColorParameter("BaseColor",n));const l=new s.Material("handle","HandleShader");l.getParameter("maintainScreenSize").setValue(1),l.replaceParameter(this.colorParam);const h=new s.Cylinder(e,i-10*e,64);h.getParameter("baseZAtZero").setValue(!0);const o=new s.Cuboid(10*e,10*e,10*e),a=new s.GeomItem("handle",h,l),c=new s.GeomItem("tip",o,l),r=new s.Xfo;r.tr.set(0,0,i-10*e),o.transformVertices(r),this.addChild(a),this.addChild(c)}highlight(){this.colorParam.setValue(this.__hilightedColor)}unhighlight(){this.colorParam.setValue(this.__color)}setTargetParam(t,i=!0){if(this.param=t,i){const i=()=>{this.setGlobalXfo(t.getValue())};i(),t.valueChanged.connect(i)}}getTargetParam(){return this.param?this.param:this.getParameter("GlobalXfo")}onDragStart(t){this.grabDist=t.grabDist,this.oriXfo=this.getGlobalXfo(),this.tmplocalXfo=this.getLocalXfo();const i=this.getTargetParam();this.baseXfo=i.getValue(),t.undoRedoManager&&(this.change=new u(i),t.undoRedoManager.addChange(this.change))}onDrag(t){const i=this.baseXfo.clone(),s=t.holdDist/this.grabDist;s<1e-4||(i.sc.set(this.baseXfo.sc.x*s,this.baseXfo.sc.y*s,this.baseXfo.sc.z*s),this.tmplocalXfo.sc.set(1,1,s),this.setLocalXfo(this.tmplocalXfo),this.change?this.change.update({value:i}):this.param.setValue(i))}onDragEnd(t){this.change=null,this.tmplocalXfo.sc.set(1,1,1),this.setLocalXfo(this.tmplocalXfo);const i=this.getChildByName("tip"),s=i.getLocalXfo();s.sc.set(1,1,1),i.setLocalXfo(s)}}class X extends r{constructor(t,i,e){super(t),this.radius=i;const n=new s.Material("mask","HandleShader");n.getParameter("maintainScreenSize").setValue(1),n.getParameter("BaseColor").setValue(e);const l=new s.Sphere(i,64),h=new s.GeomItem("mask",l,n);this.addChild(h)}highlight(){}unhighlight(){}setTargetParam(t,i=!0){if(this.param=t,i){const i=()=>{this.setGlobalXfo(t.getValue())};i(),t.valueChanged.connect(i)}}getTargetParam(){return this.param?this.param:this.getParameter("GlobalXfo")}handleMouseDown(t){return!0}handleMouseMove(t){return!0}handleMouseUp(t){return!0}onDragStart(t){this.baseXfo=this.getGlobalXfo(),this.baseXfo.sc.set(1,1,1),this.deltaXfo=new s.Xfo;const i=this.getTargetParam();this.offsetXfo=this.baseXfo.inverse().multiply(i.getValue()),this.vec0=t.grabPos.subtract(this.baseXfo.tr),this.vec0.normalizeInPlace(),this.colorParam.setValue(new s.Color(1,1,1)),t.undoRedoManager&&(this.change=new ParameterValueChange(i),t.undoRedoManager.addChange(this.change))}onDrag(t){const i=t.holdPos.subtract(this.baseXfo.tr);i.normalizeInPlace();const s=this.vec0.angleTo(i)*modulator,e=this.vec0.cross(i).normalize();this.deltaXfo.ori.setFromAxisAndAngle(e,s);const n=this.baseXfo.multiply(this.deltaXfo),l=n.multiply(this.offsetXfo);this.change?this.change.update({value:l}):this.getTargetParam().setValue(n)}onDragEnd(t){this.change=null,this.colorParam.setValue(this.__color)}}class y extends b{constructor(t,i,e,n){super(t),this.__color=e,this.__hilightedColor=new s.Color(1,1,1),this.sizeParam=this.addParameter(new s.NumberParameter("size",i)),this.colorParam=this.addParameter(new s.ColorParameter("BaseColor",e));const l=new s.Material("handle","HandleShader");l.getParameter("maintainScreenSize").setValue(1),l.replaceParameter(this.colorParam);const h=new s.Cuboid(i,i,.02*i),o=new s.Xfo;o.tr=n,h.transformVertices(o),this.handle=new s.GeomItem("handle",h,l),this.sizeParam.valueChanged.connect(()=>{i=this.sizeParam.getValue(),h.getParameter("size").setValue(i),h.getParameter("height").setValue(.02*i)}),this.addChild(this.handle)}highlight(){this.colorParam.setValue(this.__hilightedColor)}unhighlight(){this.colorParam.setValue(this.__color)}}class f extends s.TreeItem{constructor(t,i){super("XfoHandle");const e=new s.TreeItem("Translate");e.setVisible(!1),this.addChild(e);const n=new s.Color(1,.1,.1),l=new s.Color("#32CD32"),h=new s.Color("#1E90FF");n.a=.8,l.a=.8,h.a=.8;{const l=new m("linearX",t,i,n),h=new s.Xfo;h.ori.setFromAxisAndAngle(new s.Vec3(0,1,0),.5*Math.PI),l.getParameter("LocalXfo").setValue(h),e.addChild(l)}{const n=new m("linearY",t,i,l),h=new s.Xfo;h.ori.setFromAxisAndAngle(new s.Vec3(1,0,0),-.5*Math.PI),n.getParameter("LocalXfo").setValue(h),e.addChild(n)}{const s=new m("linearZ",t,i,h);e.addChild(s)}const o=.35*t;{const t=new y("planarXY",o,l,new s.Vec3(.5*o,.5*o,0)),i=new s.Xfo;t.getParameter("LocalXfo").setValue(i),e.addChild(t)}{const t=new y("planarYZ",o,n,new s.Vec3(-.5*o,.5*o,0)),i=new s.Xfo;i.ori.setFromAxisAndAngle(new s.Vec3(0,1,0),.5*Math.PI),t.getParameter("LocalXfo").setValue(i),e.addChild(t)}{const t=new y("planarXZ",o,h,new s.Vec3(.5*o,.5*o,0)),i=new s.Xfo;i.ori.setFromAxisAndAngle(new s.Vec3(1,0,0),.5*Math.PI),t.getParameter("LocalXfo").setValue(i),e.addChild(t)}const a=new s.TreeItem("Rotate");a.setVisible(!1),this.addChild(a);{const e=new X("rotation",t-i,new s.Color(1,1,1,.4));a.addChild(e)}{const e=new p("rotationX",t,i,n),l=new s.Xfo;l.ori.setFromAxisAndAngle(new s.Vec3(0,1,0),.5*Math.PI),e.getParameter("LocalXfo").setValue(l),a.addChild(e)}{const e=new p("rotationY",t,i,l),n=new s.Xfo;n.ori.setFromAxisAndAngle(new s.Vec3(1,0,0),.5*Math.PI),e.getParameter("LocalXfo").setValue(n),a.addChild(e)}{const s=new p("rotationZ",t,i,h);a.addChild(s)}const c=new s.TreeItem("Scale");c.setVisible(!1),this.addChild(c);const r=.95*t;{const t=new G("scaleX",r,i,n),e=new s.Xfo;e.ori.setFromAxisAndAngle(new s.Vec3(0,1,0),.5*Math.PI),t.getParameter("LocalXfo").setValue(e),c.addChild(t)}{const t=new G("scaleY",r,i,l),e=new s.Xfo;e.ori.setFromAxisAndAngle(new s.Vec3(1,0,0),-.5*Math.PI),t.getParameter("LocalXfo").setValue(e),c.addChild(t)}{const t=new G("scaleZ",r,i,h);c.addChild(t)}}_cleanGlobalXfo(t){const i=this.getParentItem();if(void 0!==i){const t=i.getGlobalXfo().clone();return t.sc.set(1,1,1),t.multiply(this.__localXfoParam.getValue())}return this.__localXfoParam.getValue()}showHandles(t){this.traverse(t=>{if(t!=this)return t.setVisible(!1),!1});const i=this.getChildByName(t);i&&i.setVisible(!0)}setTargetParam(t){this.param=t,this.traverse(i=>{i instanceof r&&i.setTargetParam(t,!1)})}}class V extends s.Group{constructor(t){let i,e;super(),t.selectionOutlineColor?i=t.selectionOutlineColor:(i=new s.Color("#03E3AC"),i.a=.1),t.branchSelectionOutlineColor?e=t.branchSelectionOutlineColor:(e=i.lerp(new s.Color("white"),.5),e.a=.1),this.getParameter("HighlightColor").setValue(i),this.addParameter(new s.ColorParameter("SubtreeHighlightColor",e)),this.propagatingSelectionToItems=0!=t.setItemsSelected,this.getParameter("InitialXfoMode").setValue(s.Group.INITIAL_XFO_MODES.average),this.__itemsParam.setFilterFn(t=>t instanceof s.BaseItem)}clone(t){const i=new V;return i.copyFrom(this,t),i}rebindInitialXfos(){Array.from(this.__itemsParam.getValue()).forEach((t,i)=>{t instanceof s.TreeItem&&(this.__initialXfos[i]=t.getGlobalXfo())})}__bindItem(t,i){this.propagatingSelectionToItems&&t.setSelected(this);const e={};if(t instanceof s.TreeItem){const n=this.getParameter("HighlightColor").getValue();n.a=this.getParameter("HighlightFill").getValue();const l=this.getParameter("SubtreeHighlightColor").getValue();t.addHighlight("selected"+this.getId(),n,!1),t.getChildren().forEach(t=>{t instanceof s.TreeItem&&t.addHighlight("branchselected"+this.getId(),l,!0)}),e.globalXfoChangedIndex=t.globalXfoChanged.connect(()=>{this.calculatingGroupXfo||this.propagatingXfoToItems||(this.__initialXfos[i]=t.getGlobalXfo(),this._setGlobalXfoDirty())}),this.__initialXfos[i]=t.getGlobalXfo()}this.__signalIndices[i]=e}__unbindItem(t,i){this.propagatingSelectionToItems&&t.setSelected(!1),t instanceof s.TreeItem&&(t.removeHighlight("selected"+this.getId()),t.getChildren().forEach(t=>{t instanceof s.TreeItem&&t.removeHighlight("branchselected"+this.getId(),!0)}),t.globalXfoChanged.disconnectId(this.__signalIndices[i].globalXfoChangedIndex),this.__initialXfos.splice(i,1)),this.__signalIndices.splice(i,1)}_propagateDirtyXfoToItems(){if(this.calculatingGroupXfo)return;const t=Array.from(this.__itemsParam.getValue());if(!this.calculatingGroupXfo&&t.length>0&&this.invGroupXfo&&!this.dirty){const i=this.__globalXfoParam.getValue().multiply(this.invGroupXfo);this.propagatingXfoToItems=!0;const e=(t,s)=>{const e=t.getParameter("GlobalXfo"),n=i.multiply(s);e.setValue(n)};t.forEach((t,i)=>{t instanceof s.TreeItem&&e(t,this.__initialXfos[i])}),this.propagatingXfoToItems=!1}}}class g extends c{constructor(t,i,s){super("SelectionChange"),this.__selectionManager=t,this.__prevSelection=i,this.__newSelection=s}undo(){this.__selectionManager.setSelection(this.__prevSelection,!1)}redo(){this.__selectionManager.setSelection(this.__newSelection,!1)}toJSON(t){const i=super.toJSON(t),s=[];for(const t of this.__newSelection)s.push(t.getPath());return i.itemPaths=s,i}fromJSON(t,i){super.fromJSON(t,i),this.__selectionManager=i.appData.selectionManager,this.__prevSelection=new Set(this.__selectionManager.getSelection());const s=i.appData.scene.getRoot(),e=new Set;for(const i of t.itemPaths)e.add(s.resolvePath(i,1));this.__newSelection=e,this.__selectionManager.setSelection(this.__newSelection,!1)}}a.registerChange("SelectionChange",g);class R extends c{constructor(t,i){super("Selection Visibility Change"),this.selection=t,this.state=i,this.do(this.state)}undo(){this.do(!this.state)}redo(){this.do(this.state)}do(t){for(const i of this.selection)i.getParameter("Visible").setValue(t)}}a.registerChange("ToggleSelectionVisibility",R);class W{constructor(t,i={}){if(this.appData=t,this.leadSelection=void 0,this.selectionChanged=new s.Signal,this.leadSelectionChanged=new s.Signal,this.selectionGroup=new V(i),!0===i.enableXfoHandles){const i=.1;this.xfoHandle=new f(i,.02*i),this.xfoHandle.setTargetParam(this.selectionGroup.getParameter("GlobalXfo"),!1),this.xfoHandle.setVisible(!1),this.selectionGroup.addChild(this.xfoHandle),this.handleGroup={Translate:new s.Signal,Rotate:new s.Signal,Scale:new s.Signal},this.currMode="",t.actionRegistry.registerAction({name:"Translate",path:["Edit"],callback:()=>{this.showHandles("Translate")},key:"w",activatedChanged:this.handleGroup.Translate}),t.actionRegistry.registerAction({name:"Rotate",path:["Edit"],callback:()=>{this.showHandles("Rotate")},key:"e",activatedChanged:this.handleGroup.Rotate}),t.actionRegistry.registerAction({name:"Scale",path:["Edit"],callback:()=>{this.showHandles("Scale")},key:"r",activatedChanged:this.handleGroup.Scale}),t.actionRegistry.registerAction({name:"Local",path:["Edit","Coords"],callback:()=>{this.setXfoMode(ZeaEngine.Group.INITIAL_XFO_MODES.average)},key:"k",activatedChanged:this.handleGroup.Translate}),t.actionRegistry.registerAction({name:"Global",path:["Edit","Coords"],callback:()=>{this.setXfoMode(ZeaEngine.Group.INITIAL_XFO_MODES.globalOri)},key:"l",activatedChanged:this.handleGroup.Rotate})}this.appData.renderer&&this.setRenderer(this.appData.renderer)}setRenderer(t){this.__renderer=t,this.__renderer.addTreeItem(this.selectionGroup)}setXfoMode(t){this.xfoHandle&&(this.selectionGroup.rebindInitialXfos(),this.selectionGroup.getParameter("InitialXfoMode").setValue(t))}showHandles(t){if(this.xfoHandle&&this.currMode!=t){this.currMode=t;for(const i in this.handleGroup)this.handleGroup[i].emit(t==i);this.xfoHandle.showHandles(t)}}updateHandleVisiblity(){if(!this.xfoHandle)return;const t=this.selectionGroup.getItems(),i=Array.from(t).length>0;this.xfoHandle.setVisible(i),this.__renderer.requestRedraw()}getSelection(){return this.selectionGroup.getItems()}setSelection(t,i=!0){const s=new Set(this.selectionGroup.getItems()),e=new Set(s);for(const i of t)s.has(i)||s.add(i);for(const i of s)t.has(i)||s.delete(i);if(this.selectionGroup.setItems(s),s.size>0?this.__setLeadSelection(s.values().next().value):this.__setLeadSelection(),this.updateHandleVisiblity(),i){const t=new g(this,e,s);this.appData.undoRedoManager&&this.appData.undoRedoManager.addChange(t)}}__setLeadSelection(t){this.leadSelection!=t&&(this.leadSelection=t,this.leadSelectionChanged.emit(t))}toggleItemSelection(t,i=!0){const s=new Set(this.selectionGroup.getItems()),e=new Set(s);if(i&&(1!=s.size||!s.has(t))){let i=!0;if(s.has(t)){let e=1;t.traverse(t=>{s.has(t)&&e++}),i=e!=s.size}i&&s.clear()}let n;s.has(t)?(s.delete(t),n=!1):(s.add(t),n=!0),this.selectionGroup.setItems(s),n&&1===s.size?this.__setLeadSelection(t):n||(1===s.size?this.__setLeadSelection(s.values().next().value):0===s.size&&this.__setLeadSelection());const l=new g(this,e,s);this.appData.undoRedoManager&&this.appData.undoRedoManager.addChange(l),this.updateHandleVisiblity(),this.selectionChanged.emit(e)}clearSelection(t=!0){const i=new Set(this.selectionGroup.getItems());if(0==i.size)return!1;let s;if(t&&(s=new Set(i)),i.clear(),this.selectionGroup.setItems(i),this.updateHandleVisiblity(),t){const t=new g(this,s,i);this.appData.undoRedoManager&&this.appData.undoRedoManager.addChange(t),this.selectionChanged.emit(i)}return!0}selectItems(t,i=!0){const s=new Set(this.selectionGroup.getItems()),e=new Set(s);i&&s.clear();for(const i of t)i.getSelected()||s.add(i);const n=new g(this,e,s);this.appData.undoRedoManager&&this.appData.undoRedoManager.addChange(n),this.selectionGroup.setItems(s),1===s.size?this.__setLeadSelection(s.values().next().value):0===s.size&&this.__setLeadSelection(),this.updateHandleVisiblity(),this.selectionChanged.emit(s)}deselectItems(t){const i=this.selectionGroup.getItems(),s=new Set(i);for(const s of t)s.getSelected()&&i.delete(selectedParam);this.selectionGroup.setItems(i);const e=new g(this,s,i);this.appData.undoRedoManager&&this.appData.undoRedoManager.addChange(e),1===i.size?this.__setLeadSelection(i.values().next().value):0===i.size&&this.__setLeadSelection(),this.updateHandleVisiblity(),this.selectionChanged.emit(i)}toggleSelectionVisiblity(){if(this.leadSelection){const t=this.selectionGroup.getItems(),i=!this.leadSelection.getVisible(),s=new R(t,i);this.appData.undoRedoManager&&this.appData.undoRedoManager.addChange(s)}}startPickingMode(t,i,s,e){console.log(t),this.__pickCB=i,this.__pickFilter=s,this.__pickCount=e,this.__picked=[]}pickingFilter(t){return this.__pickFilter(t)}pickingModeActive(){return null!=this.__pickCB}cancelPickingMode(){this.__pickCB=void 0}pick(t){if(this.__pickCB){if(Array.isArray(t))this.__picked=this.__picked.concat(this.__pickFilter?t.filter(this.__pickFilter):t);else{if(this.__pickFilter&&!this.__pickFilter(t))return;this.__picked.push(t)}this.__picked.length==this.__pickCount&&(this.__pickCB(this.__picked),this.__pickCB=void 0)}}}const I=new s.Vec3(0,0,1);class S{constructor(t,i,e=!1){if(this.__appData=t,this.__userData=i,this.__currentUserAvatar=e,this.__treeItem=new s.TreeItem(this.__userData.id),this.__treeItem.addRef(this),this.__appData.renderer.addTreeItem(this.__treeItem),this.__avatarColor=new s.Color(.3,.3,.3),this.__hilightPointerColor=new s.Color(1.2,0,0),this.__plane=new s.Plane(1,1),this.__uiGeomIndex=-1,!this.__currentUserAvatar){let t,i;if(this.__camera=new s.Camera,this.__camera.addRef(this),this.__cameraBound=!1,this.__userData.picture&&""!=this.__userData.picture)t=new s.LDRImage("user"+this.__userData.id+"AvatarImage"),t.setImageURL(this.__userData.picture),i=new s.Disc(.5,64);else{t=new s.Label(name);const e=new s.Color(.84,.84,.84);t.getParameter("backgroundColor").setValue(e),t.getParameter("fontSize").setValue(48),t.getParameter("borderRadius").setValue(15),t.getParameter("margin").setValue(8),t.getParameter("text").setValue(this.__userData.name),i=new s.Plane(2,.5),t.labelRendered.connect(t=>{const s=t.width/t.height;i.getParameter("SizeX").setValue(.5*s)})}const e=new s.Material("user"+this.__userData.id+"AvatarImageMaterial","FlatSurfaceShader");e.getParameter("BaseColor").setValue(this.__avatarColor),e.getParameter("BaseColor").setImage(t),e.visibleInGeomDataBuffer=!1,this.__avatarImageGeomItem=new s.GeomItem("avatarImage",i,e),this.__avatarImageXfo=new s.Xfo,this.__avatarImageXfo.sc.set(.2,.2,1),this.__avatarImageXfo.ori.setFromAxisAndAngle(new s.Vec3(0,1,0),Math.PI),this.__avatarImageGeomItem.setLocalXfo(this.__avatarImageXfo),this.__avatarImageGeomItem.addRef(this)}}attachRTCStream(t){if(!this.__avatarCamGeomItem){const i=new s.VideoStreamImage2D("webcamStream");i.setVideoStream(t),this.__avatarCamMaterial=new s.Material("user"+this.__userData.id+"AvatarImageMaterial","FlatSurfaceShader"),this.__avatarCamMaterial.getParameter("BaseColor").setValue(this.__avatarColor),this.__avatarCamMaterial.getParameter("BaseColor").setImage(i),this.__avatarCamMaterial.visibleInGeomDataBuffer=!1,this.__avatarCamGeomItem=new s.GeomItem("avatarImage",this.__plane,this.__avatarCamMaterial),this.__avatarCamGeomItem.addRef(this);const e=.02;this.__avatarCamXfo=new s.Xfo,this.__avatarCamXfo.sc.set(16*e,9*e,1),this.__avatarCamXfo.tr.set(0,0,-.1*e),this.__avatarCamGeomItem.setLocalXfo(this.__avatarCamXfo),this.__avatarCamXfo.sc.x=this.__avatarCamXfo.sc.y*(t.videoWidth/t.videoHeight),this.__avatarImageGeomItem.setLocalXfo(this.__avatarCamXfo)}"CameraAndPointer"==this.__currentViewMode&&(this.__treeItem.getChild(0).removeAllChildren(),this.__treeItem.getChild(0).addChild(this.__avatarCamGeomItem,!1))}detachRTCStream(){if("CameraAndPointer"==this.__currentViewMode){this.__treeItem.getChild(0).removeAllChildren();const t=.02;this.__avatarImageXfo.sc.set(9*t,9*t,1),this.__avatarImageXfo.tr.set(0,0,-.1*t),this.__avatarImageGeomItem.setLocalXfo(this.__avatarImageXfo),this.__treeItem.getChild(0).addChild(this.__avatarImageGeomItem,!1)}}getCamera(){return this.__camera}bindCamera(){this.__cameraBound=!0;const t=this.__camera.getOwner();t&&t.traverse(t=>{t!=this.__camera&&t.setVisible(!1)})}unbindCamera(){this.__cameraBound=!1;const t=this.__camera.getOwner();t&&t.traverse(t=>{t!=this.__camera&&t.setVisible(!0)})}setCameraAndPointerRepresentation(){if(this.__treeItem.removeAllChildren(),this.__currentViewMode="CameraAndPointer",this.__currentUserAvatar)return;const t=new s.Cuboid(.32,.18,.06,!0),i=new s.Vec3(.1,.1,1);t.getVertex(0).multiplyInPlace(i),t.getVertex(1).multiplyInPlace(i),t.getVertex(2).multiplyInPlace(i),t.getVertex(3).multiplyInPlace(i),t.computeVertexNormals();const e=new s.Material("user"+this.__userData.id+"Material","SimpleSurfaceShader");e.visibleInGeomDataBuffer=!1,e.getParameter("BaseColor").setValue(this.__avatarColor);const n=new s.GeomItem("camera",t,e),l=new s.Xfo;n.setGeomOffsetXfo(l);const h=new s.Lines;h.setNumVertices(2),h.setNumSegments(1),h.setSegment(0,0,1),h.getVertex(0).set(0,0,0),h.getVertex(1).set(0,0,1),h.setBoundingBoxDirty(),this.pointerXfo=new s.Xfo,this.pointerXfo.sc.set(1,1,0),this.__pointermat=new s.Material("pointermat","LinesShader"),this.__pointermat.getParameter("Color").setValue(this.__avatarColor),this.__pointerItem=new s.GeomItem("Pointer",h,this.__pointermat),this.__pointerItem.addRef(this),this.__pointerItem.setLocalXfo(this.pointerXfo),this.__avatarCamGeomItem?n.addChild(this.__avatarCamGeomItem,!1):this.__avatarImageGeomItem&&(this.__avatarImageXfo.sc.set(.18,.18,1),this.__avatarImageXfo.tr.set(0,0,-.002),this.__avatarImageGeomItem.setLocalXfo(this.__avatarImageXfo),n.addChild(this.__avatarImageGeomItem,!1)),this.__audioItem&&n.addChild(this.__audioItem,!1),this.__treeItem.addChild(n,!1),this.__treeItem.addChild(this.__pointerItem,!1),this.__treeItem.addChild(this.__camera,!1),this.__cameraBound&&n.setVisible(!1)}updateCameraAndPointerPose(t){if(!this.__currentUserAvatar)if(t.viewXfo){if(t.focalDistance){const i=t.focalDistance/5;i>1&&t.viewXfo.sc.set(i,i,i)}this.__treeItem.getChild(0).setLocalXfo(t.viewXfo),this.pointerXfo.sc.z=0,this.__treeItem.getChild(1).setLocalXfo(this.pointerXfo)}else t.movePointer?(this.pointerXfo.tr=t.movePointer.start,this.pointerXfo.ori.setFromDirectionAndUpvector(t.movePointer.dir,I),this.pointerXfo.sc.z=t.movePointer.length,this.__treeItem.getChild(1).setLocalXfo(this.pointerXfo)):t.hilightPointer?this.__pointermat.getParameter("Color").setValue(this.__hilightPointerColor):t.unhilightPointer?this.__pointermat.getParameter("Color").setValue(this.__avatarColor):t.hidePointer&&(this.pointerXfo.sc.z=0,this.__treeItem.getChild(1).setLocalXfo(this.pointerXfo))}setVRRepresentation(t){this.__treeItem.removeAllChildren(),this.__currentViewMode="VR";const i=new s.TreeItem("hmdHolder");if(this.__audioItem&&i.addChild(this.__audioItem),this.__avatarImageGeomItem&&(this.__avatarImageXfo.sc.set(.12,.12,1),this.__avatarImageXfo.tr.set(0,-.04,-.135),this.__avatarImageGeomItem.setLocalXfo(this.__avatarImageXfo),i.addChild(this.__avatarImageGeomItem,!1)),this.__treeItem.addChild(i),this.__camera&&i.addChild(this.__camera,!1),this.__hmdGeomItem)this.__currentUserAvatar||i.addChild(this.__hmdGeomItem,!1),this.__cameraBound&&this.__hmdGeomItem.setVisible(!1);else{const e=this.__appData.scene.getResourceLoader();let n;switch(t.hmd){case"Vive":n="ZeaEngine/Vive.vla";break;case"Oculus":n="ZeaEngine/Oculus.vla";break;default:n="ZeaEngine/Vive.vla"}if(!this.__vrAsset){const t=e.resolveFilePathToId(n);t&&(this.__vrAsset=this.__appData.scene.loadCommonAssetResource(t),this.__vrAsset.geomsLoaded.connect(()=>{const t=this.__vrAsset.getMaterialLibrary(),e=t.getMaterialNames();for(const i of e){const s=t.getMaterial(i,!1);s&&(s.visibleInGeomDataBuffer=!1,s.setShaderName("SimpleSurfaceShader"))}if(!this.__currentUserAvatar){const t=this.__vrAsset.getChildByName("HMD").clone(),e=t.getLocalXfo();e.tr.set(0,-.03,-.03),e.ori.setFromAxisAndAngle(new s.Vec3(0,1,0),Math.PI),e.sc.set(.001),t.setLocalXfo(e),this.__hmdGeomItem=t,this.__hmdGeomItem.addRef(this),this.__cameraBound&&this.__hmdGeomItem.setVisible(!1),i.addChild(this.__hmdGeomItem,!1)}}))}}this.__controllerTrees=[]}updateVRPose(t){const i=t=>{if(this.__controllerTrees[t])this.__treeItem.addChild(this.__controllerTrees[t],!1);else{const i=new s.TreeItem("handleHolder"+t);i.addRef(this),this.__controllerTrees[t]=i,this.__treeItem.addChild(this.__controllerTrees[t],!1);const e=()=>{let e;0==t?e=this.__vrAsset.getChildByName("LeftController"):1==t&&(e=this.__vrAsset.getChildByName("RightController")),e||(e=this.__vrAsset.getChildByName("Controller"));const n=e.clone(),l=new s.Xfo(new s.Vec3(0,-.035,-.085),new s.Quat({setFromAxisAndAngle:[new s.Vec3(0,1,0),Math.PI]}),new s.Vec3(.001,.001,.001));n.setLocalXfo(l),i.addChild(n,!1)};this.__vrAsset.geomsLoaded.connect(()=>{e()})}};if(t.viewXfo&&this.__treeItem.getChild(0).setGlobalXfo(t.viewXfo),t.controllers)for(let s=0;s<t.controllers.length;s++)t.controllers[s]&&!this.__controllerTrees[s]&&i(s),this.__controllerTrees[s].setGlobalXfo(t.controllers[s].xfo);if(t.showUIPanel){if(!this.__uiGeomItem){const i=new s.Material("uimat","FlatSurfaceShader");i.getParameter("BaseColor").setValue(this.__avatarColor),this.__uiGeomOffsetXfo=new s.Xfo,this.__uiGeomOffsetXfo.sc.set(t.showUIPanel.size.x,t.showUIPanel.size.y,1),this.__uiGeomOffsetXfo.ori.setFromAxisAndAngle(new s.Vec3(0,1,0),Math.PI),this.__uiGeomItem=new s.GeomItem("VRControllerUI",this.__plane,i),this.__uiGeomItem.addRef(this),this.__uiGeomItem.setGeomOffsetXfo(this.__uiGeomOffsetXfo);const e=new s.Xfo;e.fromJSON(t.showUIPanel.localXfo),this.__uiGeomItem.setLocalXfo(e)}this.__uiGeomIndex=this.__controllerTrees[t.showUIPanel.controllerId].addChild(this.__uiGeomItem,!1)}else t.updateUIPanel?this.__uiGeomItem&&(this.__uiGeomOffsetXfo.sc.set(t.updateUIPanel.size.x,t.updateUIPanel.size.y,1),this.__uiGeomItem.setGeomOffsetXfo(this.__uiGeomOffsetXfo)):t.hideUIPanel&&this.__uiGeomIndex>=0&&(this.__controllerTrees[t.hideUIPanel.controllerId].removeChild(this.__uiGeomIndex),this.__uiGeomIndex=-1)}updatePose(t){switch(t.interfaceType){case"CameraAndPointer":"CameraAndPointer"!==this.__currentViewMode&&this.setCameraAndPointerRepresentation(),this.updateCameraAndPointerPose(t);break;case"Vive":case"VR":"VR"!==this.__currentViewMode&&this.setVRRepresentation(t),this.updateVRPose(t)}}destroy(){this.__appData.renderer.removeTreeItem(this.__treeItem),this.__treeItem.removeRef(this),this.__camera||this.__camera.removeRef(this)}}const L=t=>{if(null!=t){if(t instanceof s.BaseItem)return"::"+t.getPath();if(t.toJSON){const i=t.toJSON();return i.typeName=s.typeRegistry.getTypeName(t.constructor),i}if(Array.isArray(t)){const i=[];for(const s of t)i.push(L(s));return i}if("object"==typeof t){const i={};for(const s in t)i[s]=L(t[s]);return i}return t}},x=(t,i)=>{if(null!=t){if("string"==typeof t&&t.startsWith("::"))return i.getRoot().resolvePath(t,1);if(t.typeName){const i=s.typeRegistry.getType(t.typeName).create();return i.fromJSON(t),i}if(Array.isArray(t)){const s=[];for(const e of t)s.push(x(e,i));return s}if("object"==typeof t){const s={};for(const e in t)s[e]=x(t[e],i);return s}return t}};class v extends c{constructor(t,i,s){t?(super(t.getName()+" Added"),this.treeItem=t,this.owner=i,this.selectionManager=s,this.prevSelection=new Set(this.selectionManager.getSelection()),this.treeItemIndex=this.owner.addChild(this.treeItem),this.selectionManager.setSelection(new Set([this.treeItem]),!1),this.treeItem.addRef(this)):super()}undo(){this.treeItem instanceof s.Operator?this.treeItem.detach():this.treeItem instanceof s.TreeItem&&this.treeItem.traverse(t=>{t instanceof s.Operator&&t.detach()},!1),this.owner.removeChild(this.treeItemIndex),this.selectionManager&&this.selectionManager.setSelection(this.prevSelection,!1)}redo(){this.treeItem instanceof s.Operator?this.treeItem.reattach():subTreeItem instanceof s.TreeItem&&this.treeItem.traverse(t=>{t instanceof s.Operator&&t.reattach()},!1),this.owner.addChild(this.treeItem),this.selectionManager&&this.selectionManager.setSelection(new Set([this.treeItem]),!1)}toJSON(t){return{name:this.name,treeItem:this.treeItem.toJSON(t),treeItemPath:this.treeItem.getPath(),treeItemIndex:this.treeItemIndex}}fromJSON(t,i){const e=s.sgFactory.constructClass(t.treeItem.type);e?(this.name=t.name,this.treeItem=e,this.treeItem.addRef(this),this.treeItem.fromJSON(t.treeItem,i),this.treeItemIndex=this.owner.addChild(this.treeItem,!1,!1)):console.warn("resolvePath is unable to conostruct",t.treeItem)}destroy(){this.treeItem.removeRef(this)}}a.registerChange("TreeItemAddChange",v);class Y extends c{constructor(t,i){if(super(),this.items=[],this.itemOwners=[],this.itemPaths=[],this.itemIndices=[],t){this.selectionManager=i.selectionManager,this.prevSelection=new Set(this.selectionManager.getSelection()),this.items=t,this.newSelection=new Set(this.prevSelection);const e=[];this.items.forEach(t=>{const i=t.getOwner(),n=i.getChildIndex(t);e.push(t.getName()),t.addRef(this),this.itemOwners.push(i),this.itemPaths.push(t.getPath()),this.itemIndices.push(n),this.selectionManager&&this.newSelection.has(t)&&this.newSelection.delete(t),t instanceof s.Operator?t.detach():t instanceof s.TreeItem&&t.traverse(t=>{t instanceof s.Operator&&t.detach(),this.selectionManager&&this.newSelection.has(t)&&this.newSelection.delete(t)},!1),i.removeChild(n)}),this.selectionManager.setSelection(this.newSelection,!1),this.name=e+" Deleted"}}undo(){this.items.forEach((t,i)=>{this.itemOwners[i].insertChild(t,this.itemIndices[i],!1,!1),t instanceof s.Operator?t.reattach():subTreeItem instanceof s.TreeItem&&t.traverse(t=>{t instanceof s.Operator&&t.reattach()},!1)}),this.selectionManager&&this.selectionManager.setSelection(this.prevSelection,!1)}redo(){this.selectionManager&&this.selectionManager.setSelection(this.newSelection,!1),this.items.forEach((t,i)=>{this.itemOwners[i].removeChild(this.itemIndices[i]),t instanceof s.Operator?t.detach():subTreeItem instanceof s.TreeItem&&t.traverse(t=>{t instanceof s.Operator&&t.detach()},!1)})}toJSON(t){const i={name:this.name,items:[],itemPaths:this.itemPaths,itemIndices:this.itemIndices};return this.items.forEach(t=>{i.items.push(t.toJSON())}),i}fromJSON(t,i){this.name=t.name,t.itemPaths.forEach(t=>{const s=i.scene.getRoot().resolvePath(t,1);if(!s)return void console.warn("resolvePath is unable to resolve",t);const e=s.getOwner();this.itemOwners.push(e),this.itemPaths.push(s.getPath()),this.itemIndices.push(e.getChildIndex(s))})}destroy(){this.items.forEach(t=>t.removeRef(this))}}a.registerChange("TreeItemsRemoveChange",Y);class M extends c{constructor(t,i){t?(console.log("TreeItemMoveChange"),super(t.getName()+" Added"),this.treeItem=t,this.oldOwner=this.treeItem.getOwner(),this.oldOwnerIndex=this.oldOwner.getChildIndex(this.treeItem),this.newOwner=i,this.newOwner.addChild(this.treeItem,!0)):super()}undo(){this.oldOwner.insertChild(this.treeItem,this.oldOwnerIndex,!0)}redo(){this.newOwner.addChild(this.treeItem,!0)}toJSON(t){return{name:this.name,treeItemPath:this.treeItem.getPath(),newOwnerPath:this.newOwner.getPath()}}fromJSON(t,i){const s=appData.scene.getRoot().resolvePath(t.treeItemPath,1);if(!s)return void console.warn("resolvePath is unable to resolve",t.treeItemPath);const e=appData.scene.getRoot().resolvePath(t.newOwnerPath,1);e?(this.name=t.name,this.treeItem=s,this.newOwner=e,this.oldOwner=this.treeItem.getOwner(),this.oldOwnerIndex=this.oldOwner.getChildIndex(this.treeItem),this.newOwner.addChild(this.treeItem,!0)):console.warn("resolvePath is unable to resolve",t.newOwnerPath)}}a.registerChange("TreeItemMoveChange",M);class K{constructor(t){}}const C=new class{constructor(){this.treeItemFactories=[],this.widgetFactories=[],this.inspectorFactories=[]}registerInpector(t,i){this.inspectorFactories.push({inspector:t,rule:i})}constructInspector(...t){const i=t[0];for(let s=this.inspectorFactories.length;s-- >0;){const e=this.inspectorFactories[s];if(e.rule(i))return new e.inspector(...t)}console.warn(`Inspector factory not found for parameter '${i.getName()}' of class '${i.constructor.name}'`)}registerTreeItemElement(t,i){this.treeItemFactories.push({treeItemElement:t,rule:i})}constructTreeItemElement(...t){const i=t[0];for(let s=this.treeItemFactories.length;s-- >0;){const e=this.treeItemFactories[s];if(e.rule(i))return new e.treeItemElement(...t)}console.warn(`Tree item factory not found for parameter '${i.getName()}' of class '${i.constructor.name}'`)}registerWidget(t,i){this.widgetFactories.push({widget:t,rule:i})}findWidgetReg(t){for(let i=this.widgetFactories.length;i-- >0;){const s=this.widgetFactories[i];if(s.rule(t))return s}}constructWidget(...t){const i=t[0];for(let s=this.widgetFactories.length;s-- >0;){const e=this.widgetFactories[s];if(e.rule(i))return new e.widget(...t)}console.warn(`Widget factory not found for parameter '${i.getName()}' of class '${i.constructor.name}'`)}};function w(t,i=6){return Math.abs(t)<Number("1e-6")?0:Number(Math.round(t+"e"+i)+"e-"+i)}C.registerWidget(class extends K{constructor(t,i,e){super(t);const n=document.createElement("input");let l,h;n.setAttribute("id",t.getName()),n.setAttribute("type","checkbox"),n.setAttribute("tabindex",0),n.checked=t.getValue(),i.appendChild(n),t.valueChanged.connect(i=>{l||(n.checked=t.getValue(),i==s.ValueSetMode.REMOTEUSER_SETVALUE&&(n.classList.add("user-edited"),h&&clearTimeout(h),h=setTimeout(()=>{n.classList.remove("user-edited"),h=null},1500)))}),n.addEventListener("input",()=>{l=new u(t,n.checked),e.undoRedoManager.addChange(l),l=void 0})}},t=>t instanceof s.BooleanParameter),C.registerWidget(class extends K{constructor(t,i,e){super(t);const n=new iro.ColorPicker(i,{width:200,height:200,color:t.getValue().getAsRGBDict(),anticlockwise:!0,borderWidth:1,borderColor:"#fff"});let l,h=void 0,o=!1;t.valueChanged.connect(i=>{h||(o=!0,n.color.rgb=t.getValue().getAsRGBDict(),o=!1,i==s.ValueSetMode.REMOTEUSER_SETVALUE&&(n.el.classList.add("user-edited"),l&&clearTimeout(l),l=setTimeout(()=>{n.el.classList.remove("user-edited"),l=null},1500)))}),n.on("input:start",()=>{console.log("input:start",t.getValue().getAsRGBDict()),h=new u(t),e.undoRedoManager.addChange(h)}),n.on("input:end",()=>{console.log("input:end"),h=void 0}),n.on("color:change",()=>{if(o)return;const i=new s.Color;i.setFromRGBDict(n.color.rgb),h?h.update({value:i}):(h=new u(t,i),e.undoRedoManager.addChange(h))})}setParentDomElem(t){}},t=>t instanceof s.ColorParameter),C.registerWidget(class extends K{constructor(t,i,e){super(t);const n=t.getRange(),l=document.createElement("input"),h=[];if(n){h.push("mdl-slider"),h.push("mdl-js-slider"),l.className=h.join(" "),l.setAttribute("id",t.getName()),l.setAttribute("type","range"),l.setAttribute("min",0),l.setAttribute("max",200);const i=(t.getValue()-n[0])/(n[1]-n[0])*200;l.setAttribute("value",i);const s=t.getStep();l.setAttribute("step",s||1),l.setAttribute("tabindex",0)}else l.className=h.join(" "),l.setAttribute("id",t.getName()),l.setAttribute("type","number"),l.setAttribute("pattern","-?[0-9]*(.[0-9]+)?"),l.setAttribute("value",t.getValue()),l.setAttribute("tabindex",0);i.appendChild(l);let o,a=void 0;function c(t,i=6){return Number(Math.round(t+"e"+i)+"e-"+i)}t.valueChanged.connect(i=>{a||(l.value=n?(t.getValue()-n[0])/(n[1]-n[0])*200:t.getValue(),i==s.ValueSetMode.REMOTEUSER_SETVALUE&&(l.classList.add("user-edited"),o&&clearTimeout(o),o=setTimeout(()=>{l.classList.remove("user-edited"),o=null},1500)))});const r=()=>{let i=c(l.valueAsNumber);n&&(i=n[0]+i/200*(n[1]-n[0]),i=Math.clamp(i,n[0],n[1])),a?a.update({value:i}):(a=new u(t,i),e.undoRedoManager.addChange(a))},d=()=>{a&&(t.setValueDone(),a=void 0)};l.addEventListener("input",()=>{r()}),l.addEventListener("change",d),l.addEventListener("keydown",(function(t){38!==t.which&&40!==t.which||(38===t.which&&(l.valueAsNumber=c(l.valueAsNumber+.1)),40===t.which&&(l.valueAsNumber=c(l.valueAsNumber-.1)),r(),t.preventDefault())})),l.addEventListener("focusout",d)}},t=>t instanceof s.NumberParameter),C.registerWidget(class extends K{constructor(t,i,e){super(t);const n=document.createElement("input");let l,h;n.className="mdl-textfield__input",n.setAttribute("id",t.getName()),n.setAttribute("type","text"),n.setAttribute("value",t.getValue()),n.setAttribute("tabindex",0),i.appendChild(n),t.valueChanged.connect(i=>{l||(n.value=t.getValue(),i==s.ValueSetMode.REMOTEUSER_SETVALUE&&(n.classList.add("user-edited"),h&&clearTimeout(h),h=setTimeout(()=>{n.classList.remove("user-edited"),h=null},1500)))});const o=()=>{const i=n.value;l?l.update({value:i}):(l=new u(t,i),e.undoRedoManager.addChange(l))};n.addEventListener("input",o),n.addEventListener("change",()=>{o(),l=void 0})}},t=>t instanceof s.StringParameter),C.registerWidget(class extends K{constructor(t,i,e){super(t);const n=document.createElement("div");n.setAttribute("id",t.getName()),n.textContent=t.getValue(),n.style.width="100%";const l=Math.min(50,t.getValue().split("\n").length);n.style.height=14*Math.max(8,l+2)+"px",i.appendChild(n);const h=ace.edit(n);let o,a;h.setTheme("ace/theme/chrome"),h.session.setMode("ace/mode/javascript"),t.valueChanged.connect(i=>{o||(h.session.setValue(t.getValue()),i==s.ValueSetMode.REMOTEUSER_SETVALUE&&(n.classList.add("user-edited"),a&&clearTimeout(a),a=setTimeout(()=>{n.classList.remove("user-edited"),a=null},1500)))}),n.addEventListener("keydown",i=>{i.ctrlKey&&"s"==i.key&&((()=>{const i=h.getValue();o?o.update({value:i}):(o=new u(t,i),e.undoRedoManager.addChange(o))})(),t.setValueDone(),o=void 0,i.preventDefault()),i.stopPropagation()})}},t=>t instanceof s.CodeParameter),C.registerWidget(class extends K{constructor(t,i,e){super(t);const n=document.createElement("div");n.className="container";const l=document.createElement("ul");l.className="flex-editvalues",n.appendChild(l);const h=document.createElement("input");h.setAttribute("id",t.getName()),h.setAttribute("type","number"),h.setAttribute("pattern","-?[0-9]*(.[0-9]+)?"),h.setAttribute("value",t.getValue().x),h.setAttribute("tabindex",0),h.style.width="100%";const o=document.createElement("li");o.appendChild(h),l.appendChild(o);const a=document.createElement("input");a.setAttribute("id",t.getName()),a.setAttribute("type","number"),a.setAttribute("pattern","-?[0-9]*(.[0-9]+)?"),a.setAttribute("value",t.getValue().y),a.setAttribute("tabindex",0),a.style.width="100%";const c=document.createElement("li");c.appendChild(a),l.appendChild(c),i.appendChild(n);let r,d=void 0;t.valueChanged.connect(()=>{if(!d){const i=t.getValue();h.value=w(i.x),a.value=w(i.y),mode==s.ValueSetMode.REMOTEUSER_SETVALUE&&(n.classList.add("user-edited"),r&&clearTimeout(r),r=setTimeout(()=>{n.classList.remove("user-edited"),r=null},1500))}});const m=()=>{const i=new s.Vec2(h.valueAsNumber,a.valueAsNumber);d?d.update({value:i}):(d=new u(t,i),e.undoRedoManager.addChange(d))},b=()=>{m(),d=void 0};h.addEventListener("input",m),a.addEventListener("input",m),h.addEventListener("change",b),a.addEventListener("change",b)}},t=>t instanceof s.Vec2Parameter),C.registerWidget(class extends K{constructor(t,i,e){super(t);const n=document.createElement("div");n.className="container";const l=document.createElement("ul");l.className="flex-editvalues",n.appendChild(l);const h=document.createElement("input");h.setAttribute("id",t.getName()),h.setAttribute("type","number"),h.setAttribute("pattern","-?[0-9]*(.[0-9]+)?"),h.setAttribute("value",t.getValue().x),h.setAttribute("tabindex",0),h.style.width="100%";const o=document.createElement("li");o.appendChild(h),l.appendChild(o);const a=document.createElement("input");a.setAttribute("id",t.getName()),a.setAttribute("type","number"),a.setAttribute("pattern","-?[0-9]*(.[0-9]+)?"),a.setAttribute("value",t.getValue().y),a.setAttribute("tabindex",0),a.style.width="100%";const c=document.createElement("li");c.appendChild(a),l.appendChild(c);const r=document.createElement("input");r.setAttribute("id",t.getName()),r.setAttribute("type","number"),r.setAttribute("pattern","-?[0-9]*(.[0-9]+)?"),r.setAttribute("value",t.getValue().z),r.setAttribute("tabindex",0),r.style.width="100%";const d=document.createElement("li");d.appendChild(r),l.appendChild(d),i.appendChild(n);let m,b=void 0;t.valueChanged.connect(()=>{if(!b){const i=t.getValue();h.value=w(i.x),a.value=w(i.y),r.value=w(i.z),mode==s.ValueSetMode.REMOTEUSER_SETVALUE&&(n.classList.add("user-edited"),m&&clearTimeout(m),m=setTimeout(()=>{n.classList.remove("user-edited"),m=null},1500))}});const Z=()=>{const i=new s.Vec3(h.valueAsNumber,a.valueAsNumber,r.valueAsNumber);b?b.update({value:i}):(b=new u(t,i),e.undoRedoManager.addChange(b))},p=()=>{Z(),b=void 0};h.addEventListener("input",Z),a.addEventListener("input",Z),r.addEventListener("input",Z),h.addEventListener("change",p),a.addEventListener("change",p),r.addEventListener("change",p)}},t=>t instanceof s.Vec3Parameter),C.registerWidget(class extends K{constructor(t,i,e){super(t);const n=document.createElement("div");n.className="container";const l=document.createElement("ul");l.className="flex-editvalues",n.appendChild(l);const h=document.createElement("input");h.setAttribute("id",t.getName()),h.setAttribute("type","number"),h.setAttribute("pattern","-?[0-9]*(.[0-9]+)?"),h.setAttribute("value",t.getValue().x),h.setAttribute("tabindex",0),h.style.width="100%";const o=document.createElement("li");o.appendChild(h),l.appendChild(o);const a=document.createElement("input");a.setAttribute("id",t.getName()),a.setAttribute("type","number"),a.setAttribute("pattern","-?[0-9]*(.[0-9]+)?"),a.setAttribute("value",t.getValue().y),a.setAttribute("tabindex",0),a.style.width="100%";const c=document.createElement("li");c.appendChild(a),l.appendChild(c);const r=document.createElement("input");r.setAttribute("id",t.getName()),r.setAttribute("type","number"),r.setAttribute("pattern","-?[0-9]*(.[0-9]+)?"),r.setAttribute("value",t.getValue().z),r.setAttribute("tabindex",0),r.style.width="100%";const d=document.createElement("li");d.appendChild(r),l.appendChild(d);const m=document.createElement("input");m.setAttribute("id",t.getName()),m.setAttribute("type","number"),m.setAttribute("pattern","-?[0-9]*(.[0-9]+)?"),m.setAttribute("value",t.getValue().t),m.setAttribute("tabindex",0),m.style.width="100%";const b=document.createElement("li");b.appendChild(m),l.appendChild(b),i.appendChild(n);let Z,p=void 0;t.valueChanged.connect(()=>{if(!p){const i=t.getValue();h.value=w(i.x),a.value=w(i.y),r.value=w(i.z),m.value=w(i.t),mode==s.ValueSetMode.REMOTEUSER_SETVALUE&&(n.classList.add("user-edited"),Z&&clearTimeout(Z),Z=setTimeout(()=>{n.classList.remove("user-edited"),Z=null},1500))}});const G=()=>{const i=new s.Vec4(h.valueAsNumber,a.valueAsNumber,r.valueAsNumber,m.valueAsNumber);p?p.update({value:i}):(p=new u(t,i),e.undoRedoManager.addChange(p))},X=()=>{G(),p=void 0};h.addEventListener("input",G),a.addEventListener("input",G),r.addEventListener("input",G),m.addEventListener("input",G),h.addEventListener("change",X),a.addEventListener("change",X),r.addEventListener("change",X),m.addEventListener("change",X)}},t=>t instanceof s.Vec4Parameter),C.registerWidget(class extends K{constructor(t,i,e){super(t);const n=document.createElement("div");n.className="container";const l=document.createElement("ul");l.className="flex-editvalues",n.appendChild(l);let h,o=void 0,a=!1;const c=i=>{if(!a){function e(t,i=6){return Number(Math.round(t+"e"+i)+"e-"+i)}const l=t.getValue();Z.value=e(l.m00),p.value=e(l.m01),G.value=e(l.m02),X.value=e(l.m03),y.value=e(l.m10),f.value=e(l.m11),V.value=e(l.m12),g.value=e(l.m13),R.value=e(l.m20),W.value=e(l.m21),I.value=e(l.m22),S.value=e(l.m23),L.value=e(l.m30),x.value=e(l.m31),v.value=e(l.m32),Y.value=e(l.m33),i==s.ValueSetMode.REMOTEUSER_SETVALUE&&(n.classList.add("user-edited"),h&&clearTimeout(h),h=setTimeout(()=>{n.classList.remove("user-edited"),h=null},1500))}};t.valueChanged.connect(c);const r=()=>{a=!0;const i=new s.Mat4;i.set(Z.valueAsNumber,p.valueAsNumber,G.valueAsNumber,X.valueAsNumber,y.valueAsNumber,f.valueAsNumber,V.valueAsNumber,g.valueAsNumber,R.valueAsNumber,W.valueAsNumber,I.valueAsNumber,S.valueAsNumber,L.valueAsNumber,x.valueAsNumber,v.valueAsNumber,Y.valueAsNumber),o?o.update({value:i}):(o=new u(t,xfo),e.undoRedoManager.addChange(o))},d=()=>{r(),o=void 0,a=!1,c()};function m(i,s,e,n){const l=document.createElement("li"),h=document.createElement("input");return h.setAttribute("id",t.getName()),h.setAttribute("type","number"),h.setAttribute("pattern","-?[0-9]*(.[0-9]+)?"),h.setAttribute("value",e),h.setAttribute("tabindex",n),h.style.width="100%",l.appendChild(h),s.appendChild(l),h.addEventListener("input",r),h.addEventListener("change",d),h}const b=t.getValue(),Z=m(0,l,b.m00,0),p=m(0,l,b.m01,1),G=m(0,l,b.m02,2),X=m(0,l,b.m03,3),y=m(0,l,b.m10,4),f=m(0,l,b.m11,5),V=m(0,l,b.m12,6),g=m(0,l,b.m13,7),R=m(0,l,b.m20,8),W=m(0,l,b.m21,9),I=m(0,l,b.m22,10),S=m(0,l,b.m23,11),L=m(0,l,b.m30,12),x=m(0,l,b.m31,13),v=m(0,l,b.m32,14),Y=m(0,l,b.m33,15);i.appendChild(n)}},t=>t instanceof s.Mat4Parameter),C.registerWidget(class extends K{constructor(t,i,e){super(t);const n=document.createElement("div");n.className="container";const l=document.createElement("ul");l.className="flex-editvalues",n.appendChild(l);const h=t.getValue();let o,a=void 0,c=!1;const r=i=>{if(!c){const e=t.getValue();Z.value=w(e.tr.x),p.value=w(e.tr.y),G.value=w(e.tr.z),X.value=w(e.ori.x),y.value=w(e.ori.y),f.value=w(e.ori.z),V.value=w(e.ori.w),g.value=w(e.sc.x),R.value=w(e.sc.y),W.value=w(e.sc.z),i==s.ValueSetMode.REMOTEUSER_SETVALUE&&(n.classList.add("user-edited"),o&&clearTimeout(o),o=setTimeout(()=>{n.classList.remove("user-edited"),o=null},1500))}};t.valueChanged.connect(r);const d=()=>{c=!0;const i=new s.Xfo;i.tr.set(Z.valueAsNumber,p.valueAsNumber,G.valueAsNumber),i.ori.set(X.valueAsNumber,y.valueAsNumber,f.valueAsNumber,V.valueAsNumber),i.ori.normalizeInPlace(),i.sc.set(g.valueAsNumber,R.valueAsNumber,W.valueAsNumber),a?a.update({value:i}):(a=new u(t,i),e.undoRedoManager.addChange(a))},m=()=>{d(),a=void 0,c=!1,r()};function b(i,s,e,n){const l=document.createElement("li"),h=document.createElement("input");return h.setAttribute("id",t.getName()),h.setAttribute("type","number"),h.setAttribute("pattern","-?[0-9]*(.[0-9]+)?"),h.setAttribute("value",e),h.setAttribute("tabindex",n),h.style.width="100%",l.appendChild(h),s.appendChild(l),h.addEventListener("input",d),h.addEventListener("change",m),h}const Z=b(0,l,h.tr.x,0),p=b(0,l,h.tr.y,1),G=b(0,l,h.tr.z,2),X=b(0,l,h.ori.x,3),y=b(0,l,h.ori.y,4),f=b(0,l,h.ori.z,5),V=b(0,l,h.ori.w,6),g=b(0,l,h.sc.x,7),R=b(0,l,h.sc.y,8),W=b(0,l,h.sc.z,9);i.appendChild(n)}},t=>t instanceof s.XfoParameter),C.registerWidget(class extends K{constructor(t,i,e){super(t);const n=document.createElement("div");n.className="container";const l=document.createElement("ul");l.className="flex-editvalues",n.appendChild(l);const h=t.getValue();let o=void 0;const a=()=>{if(!o){const i=t.getValue();i.isValid()&&(m.value=i.p0.x,b.value=i.p0.y,Z.value=i.p0.z,p.value=i.p1.x,G.value=i.p1.y,X.value=i.p1.z)}};t.valueChanged.connect(a);const c=()=>{const i=new s.Box3;i.p0.set(m.valueAsNumber,b.valueAsNumber,Z.valueAsNumber),i.p1.set(p.valueAsNumber,G.valueAsNumber,X.valueAsNumber),o?o.update({value:i}):(o=new u(t,i),e.undoRedoManager.addChange(o)),a()},r=()=>{c(),o=void 0};function d(i,s,e,n){const l=document.createElement("li"),h=document.createElement("input");return h.setAttribute("id",t.getName()),h.setAttribute("type","number"),h.setAttribute("pattern","-?[0-9]*(.[0-9]+)?"),h.setAttribute("value",e),h.setAttribute("tabindex",n),h.style.width="100%",l.appendChild(h),s.appendChild(l),h.addEventListener("input",c),h.addEventListener("change",r),h}const m=d(0,l,h.p0.x,0),b=d(0,l,h.p0.y,1),Z=d(0,l,h.p0.z,2),p=d(0,l,h.p1.x,3),G=d(0,l,h.p1.y,4),X=d(0,l,h.p1.z,5);i.appendChild(n)}},t=>t.getValue()instanceof s.Box3);class F extends c{constructor(t,i){t?(super(t?t.getName()+" Name Changed":"NameValueChange"),this.__prevName=t.getName(),this.__item=t,null!=i&&(this.__nextName=i,this.__item.setName(this.__nextName))):super()}undo(){this.__item&&this.__item.setName(this.__prevName)}redo(){this.__item&&this.__item.setName(this.__nextName)}update(t){this.__item&&(this.__nextName=t.value,this.__item.setName(this.__nextName),this.updated.emit(t))}toJSON(t){const i=this.__item.getPath().slice();return i.pop(),i.push(this.__prevName),{name:this.name,nextName:this.__nextName,itemPath:i}}fromJSON(t,i){const e=i.appData.scene.getRoot().resolvePath(t.itemPath,1);e&&e instanceof s.BaseItem?(this.__item=e,this.__prevName=this.__item.getName(),this.__nextName=t.nextName,this.__item.setName(this.__nextName,s.ValueSetMode.REMOTEUSER_SETVALUE),this.name=this.__item.getName()+" Changed"):console.warn("resolvePath is unable to resolve",t.itemPath)}changeFromJSON(t){this.__item&&(this.__nextName=t.value,this.__item.setName(this.__nextName,s.ValueSetMode.REMOTEUSER_SETVALUE))}}a.registerChange("NameValueChange",F);class N{constructor(t,i,e){const n=document.createElement("input");let l,h;n.className="mdl-textfield__input",n.setAttribute("type","text"),n.setAttribute("value",t.getName()),n.setAttribute("tabindex",0),i.appendChild(n),t.nameChanged.connect((i,e,o)=>{l||(n.value=t.getName(),o==s.ValueSetMode.REMOTEUSER_SETVALUE&&(n.classList.add("user-edited"),h&&clearTimeout(h),h=setTimeout(()=>{n.classList.remove("user-edited"),h=null},1500)))});const o=()=>{const i=n.value;l?l.update({value:i}):(l=new F(t,i),e.undoRedoManager.addChange(l))};n.addEventListener("input",o),n.addEventListener("change",()=>{o(),l=void 0})}}class T{constructor(t,i,s){this.domElement=i,this.clean(),this.appData=s,this.container=document.createElement("div"),this.container.className="container",this.domElement.appendChild(this.container),this.ul=document.createElement("ul"),this.ul.className="flex-outer",this.container.appendChild(this.ul),t&&this.setParameterOwner(t)}clean(){for(;this.domElement.firstChild;)this.domElement.removeChild(this.domElement.firstChild)}destroy(){this.clean()}getDomElement(){return this.container}setParameterOwner(t){if(this.parameterOwner=t,this.widgets=[],t)for(const i of t.getParameters())this.addParameterWidget(i)}addParameterWidget(t){const i=t.getName(),s=C.findWidgetReg(t);if(!s)return void console.warn(`Unable to display parameter '${i}', value:${t.getValue()}`);const e=document.createElement("li");this.ul.appendChild(e);const n=document.createElement("label");n.setAttribute("for",i),n.appendChild(document.createTextNode(i)),e.appendChild(n);const l=new s.widget(t,e,this.appData);this.widgets.push(l)}}class J extends K{constructor(t,i,e){super(t);const n=document.createElement("ul");n.className="list pa0";const l=document.createElement("li"),h=document.createElement("li");i.appendChild(n),n.appendChild(l),n.appendChild(h);const o=t=>{t instanceof s.BaseItem&&(this.nameWidget=new N(t,l,e)),this.parameterContainer=new T(t,h,e)},a=t.getValue();a&&o(a),t.valueChanged.connect(()=>{for(;l.firstChild;)l.removeChild(l.firstChild);for(;h.firstChild;)h.removeChild(h.firstChild);o(t.getValue())})}}C.registerWidget(J,t=>t.getValue()instanceof s.ParameterOwner),C.registerWidget(class extends J{constructor(t,i,s){let e=t.getValue();{const s=document.createElement("ul");s.style.width="100%",s.style["padding-inline-start"]="0px";{const i=document.createElement("input");i.className="mdl-textfield__input",i.setAttribute("id",t.getName()),i.setAttribute("type","text"),i.setAttribute("value",e?e.getPath():"<NONE>"),i.setAttribute("tabindex",0);const n=document.createElement("li");n.style.display="block",n.appendChild(i),s.appendChild(n)}i.appendChild(s)}super(t,i,s),t.valueChanged.connect(()=>{e||i.removeChild(void 0)})}setParentDomElem(t){}},t=>t instanceof s.ImageParameter),C.registerWidget(class extends K{constructor(t,i,e){super(t);const n=new iro.ColorPicker(i,{width:200,height:200,color:t.getValue().getAsRGBDict(),anticlockwise:!0,borderWidth:1,borderColor:"#fff"});let l=void 0,h=!1;t.valueChanged.connect(()=>{l||(h=!0,n.color.rgb=t.getValue().getAsRGBDict(),h=!1)}),n.on("input:start",()=>{l=new u(t),e.undoRedoManager.addChange(l)}),n.on("input:end",()=>{l=void 0}),n.on("color:change",()=>{if(h)return;const i=new s.Color;i.setFromRGBDict(n.color.rgb),l?l.update({value:i}):(l=new u(t,i),e.undoRedoManager.addChange(l))})}setParentDomElem(t){}},t=>t instanceof s.MaterialColorParam),C.registerWidget(class extends K{constructor(t,i,e){super(t);const n=t.getChoices(),l=document.createElement("select");for(let t=0;t<n.length;t++){const i=n[t],s=document.createElement("option");s.appendChild(document.createTextNode(i)),l.appendChild(s)}l.selectedIndex=t.getValue(),i.appendChild(l);let h,o=!1;t.valueChanged.connect(i=>{o||(l.selectedIndex=t.getValue(),i==s.ValueSetMode.REMOTEUSER_SETVALUE&&(l.classList.add("user-edited"),h&&clearTimeout(h),h=setTimeout(()=>{l.classList.remove("user-edited"),h=null},1500)))}),l.addEventListener("change",()=>{o=!0;const i=new u(t,l.selectedIndex);e.undoRedoManager.addChange(i),t.setValueDone(),o=!1})}},t=>t instanceof s.MultiChoiceParameter),C.registerWidget(class extends K{constructor(t,i,s){super(t);const e=t.getValue(),n=document.createElement("input");n.className="mdl-textfield__input",n.setAttribute("id",t.getName()),n.setAttribute("type","text"),n.setAttribute("value",e?e.getPath().join("/"):"<none>"),n.style["outline-color"]="grey",n.style["outline-width"]="1px",n.style["outline-style"]="solid";const l=document.createElement("button");l.appendChild(document.createTextNode("Pick")),l.addEventListener("click",()=>{s.selectionManager.startPickingMode(`Pick ${t.getName()} item.`,i=>{const e=new u(t,i[0]);s.undoRedoManager.addChange(e)},t.getFilterFn(),1)}),l.style.margin="2px",i.appendChild(n),i.appendChild(l),t.valueChanged.connect(()=>{{const i=t.getValue();n.setAttribute("value",i?i.getPath().join("/"):"<none>")}})}},t=>t instanceof s.TreeItemParameter),C.registerWidget(class extends K{constructor(t,i,e){super(t);const n=document.createElement("select");n.classList.add("itemset-items");const l=()=>{const i=Array.from(t.getValue());n.setAttribute("size",i.length+1);for(let t=0;t<i.length;t++){const s=i[t],e=document.createElement("option");e.appendChild(document.createTextNode(s.getPath())),n.appendChild(e)}};t.valueChanged.connect(()=>{for(;n.firstChild;)n.removeChild(n.firstChild);l()}),l(),n.selectedIndex=-1,n.style.width="100%";const h=document.createElement("ul");h.style.width="100%",h.style["padding-inline-start"]="0px";const o=document.createElement("li");o.style.display="block",h.appendChild(o),o.appendChild(n),i.appendChild(h),this.selectionChanged=new s.Signal,this.selectionDoubleClicked=new s.Signal;let a=-1;if(n.addEventListener("change",()=>{console.log("valueChange",n.selectedIndex),this.selectionChanged.emit(n.selectedIndex,a),a=n.selectedIndex}),n.addEventListener("dblclick",()=>{console.log("dblclick",n.selectedIndex);const i=t.getItem(n.selectedIndex);e.selectionManager.setSelection(new Set([i])),this.selectionDoubleClicked.emit(n.selectedIndex)}),null!=t.getFilterFn()){const i=document.createElement("button");i.appendChild(document.createTextNode("Add")),i.addEventListener("click",()=>{e.selectionManager.startPickingMode("Pick a new item.",i=>{t.addItems(i)},t.getFilterFn(),1)});const s=document.createElement("button");s.appendChild(document.createTextNode("Remove")),s.addEventListener("click",()=>{t.removeItem(n.selectedIndex)});const l=document.createElement("li");l.style.display="block",i.style.margin="2px",s.style.margin="2px",l.appendChild(i),l.appendChild(s),h.appendChild(l)}}},t=>t instanceof s.ItemSetParameter),C.registerWidget(class extends K{constructor(t,i,s){super(t);const e=[],n=()=>{t.getMemberNames().forEach((i,n)=>{const l=t.getMember(i),h=C.findWidgetReg(l);if(!h)return void console.warn(`StructWidget Unable to display item '${l.getNam()}'`);const a=document.createElement("li"),c=document.createElement("label");c.setAttribute("for",i),c.appendChild(document.createTextNode(i)),a.appendChild(c);const r=new h.widget(l,a,s);e[n]=r,o.appendChild(a)})};t.valueChanged.connect(()=>{for(;o.firstChild;)o.removeChild(o.firstChild);n()});const l=document.createElement("ul");l.style.width="100%",l.style["padding-inline-start"]="0px";const h=document.createElement("li");h.style.display="block",l.appendChild(h);const o=document.createElement("ul");o.style.display="block",l.appendChild(o),n(),i.appendChild(l)}},t=>t instanceof s.StructParameter),C.registerWidget(class extends K{constructor(t,i,s){super(t);const e=[],n=()=>{Array.from(t.getValue()).forEach((i,n)=>{const l=C.findWidgetReg(i);if(!l)return void console.warn(`ListWidget Unable to display list item '${i.getNam()}'`);const h=document.createElement("li"),a=new l.widget(i,h,s);e[n]=a;const c=document.createElement("button");c.appendChild(document.createTextNode("Remove")),c.addEventListener("click",()=>{t.removeElement(n)}),c.style.margin="2px",h.appendChild(c),o.appendChild(h)})};t.valueChanged.connect(()=>{for(;o.firstChild;)o.removeChild(o.firstChild);n()});const l=document.createElement("ul");l.style.width="100%",l.style["padding-inline-start"]="0px";const h=document.createElement("li");h.style.display="block",l.appendChild(h);const o=document.createElement("ul");o.style.display="block",l.appendChild(o),n(),i.appendChild(l);{const i=document.createElement("li");i.style.display="block";const s=document.createElement("button");s.appendChild(document.createTextNode("Add")),s.addEventListener("click",()=>{t.addElement()}),s.style.margin="2px",i.appendChild(s),l.appendChild(i)}}},t=>t instanceof s.ListParameter);class z{constructor(t,i){this.userPressed=new s.Signal,this.domElement=t,this.clean(),this.userDiv=document.createElement("div"),this.userDiv.className="user-chip pa1 br2",this.domElement.appendChild(this.userDiv),this.userImage=document.createElement("img"),this.userImage.className="user-image br-100 ba b--black-10",this.userImage.alt="Avatar",this.userImage.src=i.picture,this.userImage.addEventListener("mousedown",()=>{this.userPressed.emit(this.userData),this.userImage.classList.add("user-image--selected")},!0),this.userImage.addEventListener("mouseup",()=>{this.userImage.classList.remove("user-image--selected")},!0),this.userDiv.appendChild(this.userImage),this.userToolTip=document.createElement("span"),this.userToolTip.className="tooltiptext",this.userDiv.appendChild(this.userToolTip),i&&this.setUserData(i)}setUserData(t){this.userData=t,this.userNameSpan&&(this.userNameSpan.innerHTML=t.name),this.userToolTip.innerHTML=t.name}clean(){for(;this.domElement.firstChild;)this.domElement.removeChild(this.domElement.firstChild)}unmount(){this.clean()}}class H{constructor(t){let i,e;this.panelSide=t,0==t?(this.domElement=document.createElement("div"),this.domElement.className="SidePanel SidePanel--left overflow-auto pa2",this.handleElement=document.createElement("div"),this.handleElement.className="PanelHandler bg-center"):(this.handleElement=document.createElement("div"),this.handleElement.className="PanelHandler bg-center",this.domElement=document.createElement("div"),this.domElement.className="SidePanel SidePanel--right overflow-auto pa2"),this.domElement.style.width="0px";const n=s=>{const n=(s.clientX-i)*window.devicePixelRatio,l=0==t?e+n:e-n;l<40?(this.domElement.style.display="none",this.domElement.style.width="0px"):(this.domElement.style.display="block",this.domElement.style.width=l+"px")},l=()=>{document.removeEventListener("mousemove",n,!1),document.removeEventListener("mouseup",l,!1)};this.handleElement.addEventListener("mousedown",t=>{i=t.clientX,e=parseInt(document.defaultView.getComputedStyle(this.domElement).width,10)*window.devicePixelRatio,document.addEventListener("mousemove",n,!1),document.addEventListener("mouseup",l,!1)},!1);const h={},o=t=>{delete h[t.identifier]};this.handleElement.addEventListener("touchstart",t=>{t.preventDefault(),t.stopPropagation(),e=parseInt(document.defaultView.getComputedStyle(this.domElement).width,10)*window.devicePixelRatio;const n=t.changedTouches;if(1==n.length){i=n[0].clientX;for(let t=0;t<n.length;t++)h[(l=n[t]).identifier]={identifier:l.identifier,pos:new s.Vec2(l.pageX,l.pageY)};t.stopPropagation()}var l},!1),this.handleElement.addEventListener("touchmove",s=>{const n=s.changedTouches;if(1==n.length){const l=(n[0].clientX-i)*window.devicePixelRatio,h=0==t?e+l:e-l;h<40?(this.domElement.style.display="none",this.domElement.style.width="0px"):(this.domElement.style.display="block",this.domElement.style.width=h+"px"),s.stopPropagation()}},!1),this.handleElement.addEventListener("touchend",t=>{t.preventDefault(),t.stopPropagation();const i=t.changedTouches;for(let t=0;t<i.length;t++)o(i[t]);t.stopPropagation()},!1),this.handleElement.addEventListener("touchcancel",t=>{const i=t.changedTouches;for(let t=0;t<i.length;t++)o(i[t]);t.stopPropagation()},!1)}getPanelWidget(){return this.widget}setPanelWidget(t){if(this.widget)for(this.widget.unMount(this.domElement);this.domElement.firstChild;)this.domElement.removeChild(this.domElement.firstChild);this.widget=t,this.widget?(this.domElement.style.display="block",this.domElement.style.width=(t.getDefaultWidth?t.getDefaultWidth():300)+"px",this.widget.mount?this.widget.mount(this.domElement):this.domElement.appendChild(this.widget)):(this.domElement.style.display="none",this.domElement.style.width="0px")}mount(t){this.parentDomElement=t,0==this.panelSide?(this.parentDomElement.appendChild(this.domElement),this.parentDomElement.appendChild(this.handleElement)):(this.parentDomElement.appendChild(this.handleElement),this.parentDomElement.appendChild(this.domElement))}unMount(t){this.parentDomElement.removeChild(this.domElement)}}class U{constructor(){let t,i;this.handleElement=document.createElement("div"),this.handleElement.className="BottomPanelHandler bg-center z-1 bt",this.domElement=document.createElement("div"),this.domElement.className="BottomPanel overflow-auto pa2",this.domElement.style.height="0px",this.closedHeight=0;const s=s=>{let e=i-(s.clientY-t);e<this.closedHeight+40&&(e=this.closedHeight),this.domElement.style.height=e+"px"},e=()=>{document.removeEventListener("mousemove",s,!1),document.removeEventListener("mouseup",e,!1)};this.handleElement.addEventListener("mousedown",n=>{t=n.clientY,i=parseInt(document.defaultView.getComputedStyle(this.domElement).height,10),document.addEventListener("mousemove",s,!1),document.addEventListener("mouseup",e,!1)},!1)}getPanelWidget(){return this.widget}setPanelWidget(t){if(this.widget)for(this.widget.unMount(this.domElement);this.domElement.firstChild;)this.domElement.removeChild(this.domElement.firstChild);this.widget=t,this.widget?(this.domElement.style.display="block",this.domElement.style.height=(t.getDefaultHeight?t.getDefaultHeight():180)+"px",this.widget.mount?this.widget.mount(this.domElement):this.domElement.appendChild(this.widget)):(this.domElement.style.display="none",this.domElement.style.height="0px")}mount(t){this.parentDomElement=t,this.parentDomElement.appendChild(this.handleElement),this.parentDomElement.appendChild(this.domElement)}unMount(t){this.parentDomElement.removeChild(this.domElement)}}C.registerTreeItemElement(class{constructor(t,i,e,n=!1){this.treeItem=t,this.appData=i,this.options=e,this.li=document.createElement("li"),this.li.className="TreeNodesListItem",this.li.treeItem=t,this.expandBtn=document.createElement("button"),this.expandBtn.className="TreeNodesListItem__ToggleExpanded",this.li.appendChild(this.expandBtn),t instanceof s.TreeItem&&(this.toggleVisibilityBtn=document.createElement("button"),this.toggleVisibilityBtn.className="TreeNodesListItem__ToggleVisibility",this.li.appendChild(this.toggleVisibilityBtn),this.toggleVisibilityBtn.innerHTML='<i class="material-icons md-15">visibility</i>',this.toggleVisibilityBtn.addEventListener("click",()=>{const t=this.treeItem.getParameter("Visible"),i=new u(t,!t.getValue());this.appData.undoRedoManager&&this.appData.undoRedoManager.addChange(i)}),this.updateVisibilityId=this.treeItem.visibilityChanged.connect(this.updateVisibility.bind(this)),this.updateVisibility()),this.titleElement=document.createElement("span"),this.titleElement.className="TreeNodesListItem__Title",this.titleElement.textContent=t.getName(),this.treeItem.nameChanged.connect(()=>{this.titleElement.textContent=t.getName()}),this.li.appendChild(this.titleElement),this.titleElement.addEventListener("click",t=>{i.selectionManager&&(i.selectionManager.pickingModeActive()?i.selectionManager.pick(this.treeItem):i.selectionManager.toggleItemSelection(this.treeItem,!t.ctrlKey))}),this.updateSelectedId=this.treeItem.selectedChanged.connect(this.updateSelected.bind(this)),this.updateSelected(),t instanceof s.TreeItem&&(this.updateHighlightId=this.treeItem.highlightChanged.connect(this.updateHighlight.bind(this)),this.updateHighlight()),this.ul=document.createElement("ul"),this.ul.className="TreeNodesList",this.li.appendChild(this.ul),this.childElements=[],this.expanded=!1,t instanceof s.TreeItem&&(n?this.expand():this.treeItem.getChildren().length>0&&this.collapse(),this.expandBtn.addEventListener("click",()=>{this.treeItem.getNumChildren()>0&&(this.expanded?this.collapse():this.expand())}),this.childAddedId=this.treeItem.childAdded.connect(this.childAdded.bind(this)),this.childRemovedId=this.treeItem.childRemoved.connect(this.childRemoved.bind(this)),this.titleElement.onmousedown=t=>{if(e.allowDragNDrop){t.stopPropagation(),t.preventDefault();const i=t.clientX,e=t.clientY;let n,l,h=i-this.li.getBoundingClientRect().left,o=e-this.li.getBoundingClientRect().top,a=!1;const c=t=>{if(!a){const s=t.clientY-e;Math.abs(t.clientX-i)>10&&Math.abs(s)>10&&(n=document.createElement("li"),n.className="TreeNodesListItem",n.classList.add("TreeNodesListItem--isHighlighted"),n.classList.add("TreeNodesListItem--isSelected"),n.classList.add("TreeNodesListItem__Dragging"),n.appendChild(this.titleElement.cloneNode(!0)),n.style.position="absolute",n.style.zIndex=1e3,document.body.append(n),a=!0)}if(a){n.style.left=t.pageX-h+"px",n.style.top=t.pageY-o+"px",n.hidden=!0;const i=document.elementFromPoint(t.clientX,t.clientY);if("TreeNodesListItem__Title"==i.className&&i.parentElement.treeItem instanceof s.TreeItem){const t=i.parentElement;l&&l!=t&&l.classList.remove("TreeNodesListItem--isHighlighted"),t==this.li?l=null:t&&l!=t&&(l=t,l.classList.add("TreeNodesListItem--isHighlighted"))}n.hidden=!1}},r=()=>{if(n&&document.body.removeChild(n),l){const t=new M(this.treeItem,l.treeItem);this.appData.undoRedoManager&&this.appData.undoRedoManager.addChange(t)}document.removeEventListener("mousemove",c),document.removeEventListener("mouseup",r)};document.addEventListener("mousemove",c),document.addEventListener("mouseup",r)}}),this.li.ondragstart=function(){return!1}}updateVisibility(){this.treeItem.getVisible()?this.li.classList.remove("TreeNodesListItem--isHidden"):this.li.classList.add("TreeNodesListItem--isHidden")}updateSelected(){this.treeItem.getSelected()?this.li.classList.add("TreeNodesListItem--isSelected"):this.li.classList.remove("TreeNodesListItem--isSelected")}updateHighlight(){const t=this.treeItem.isHighlighted();t?this.li.classList.add("TreeNodesListItem--isHighlighted"):this.li.classList.remove("TreeNodesListItem--isHighlighted"),t&&(this.titleElement.style["border-color"]=this.treeItem.getHighlight().toHex())}childAdded(t,i){this.addChild(t,i)}childRemoved(t,i){this.expanded&&(this.li.removeChild(this.childElements[i].li),this.childElements[i].destroy(),this.childElements.splice(i,1))}addComponent(t){this.subul||(this.subul=document.createElement("ul"),this.titleElement.appendChild(this.subul));const i=document.createElement("li");i.className="TreeNodesListItem";const s=document.createElement("span");s.className="TreeNodesListItem__Title",s.textContent=t,i.appendChild(s),this.subul.appendChild(i)}addChild(t,i){if(this.expanded){const s=C.constructTreeItemElement(t,this.appData,this.options);i==this.childElements.length?this.ul.appendChild(s.li):this.ul.insertBefore(s.li,this.childElements[i].li),this.childElements.splice(i,0,s)}else this.collapse()}getChild(t){return this.childElements[t]}expand(){this.expanded=!0,this.ul.classList.remove("TreeNodesList--collapsed"),this.expandBtn.innerHTML='<i class="material-icons md-24">arrow_drop_down</i>',this.childrenAlreadyCreated||(this.treeItem.getChildren().forEach((t,i)=>{this.addChild(t,i)}),this.childrenAlreadyCreated=!0)}collapse(){this.ul.classList.add("TreeNodesList--collapsed"),this.expandBtn.innerHTML='<i class="material-icons md-24">arrow_right</i>',this.expanded=!1}destroy(){this.treeItem.selectedChanged.disconnectId(this.updateSelectedId),this.treeItem instanceof s.TreeItem&&(this.treeItem.highlightChanged.disconnectId(this.updateHighlightId),this.treeItem.visibilityChanged.disconnectId(this.updateVisibilityId),this.treeItem.childAdded.disconnectId(this.childAddedId),this.treeItem.childRemoved.disconnectId(this.childRemovedId))}},t=>t instanceof s.BaseItem),C.registerInpector(class{constructor(t,i,s){const e=document.createElement("ul");e.className="list pa0 pr3";const n=document.createElement("li"),l=document.createElement("li");i.appendChild(e),e.appendChild(n),e.appendChild(l),this.nameWidget=new N(t,n,s),this.parameterContainer=new T(t,l,s)}destroy(){this.parameterContainer.destroy()}},t=>t instanceof s.BaseItem);class k extends s.ParameterOwner{constructor(t){super(),t||console.error("App data not provided to tool"),this.appData=t,this.installChanged=new s.Signal,this.activatedChanged=new s.Signal,this.actionFinished=new s.Signal,this.__params=[],this.__installed=!1,this.__activated=!1}getName(){return this.constructor.name}isPrimaryTool(){return!1}installed(){return this.__installed}install(t){if(this.__installed)throw new Error("Tool already installed");this.index=t,this.__installed=!0,this.installChanged.emit(!0)}uninstall(){this.__installed=!1,this.installChanged.emit(!1)}activateTool(){if(this.__activated)throw new Error("Tool already activate");this.__activated=!0,this.activatedChanged.emit(!0)}deactivateTool(){this.__activated=!1,this.activatedChanged.emit(!1)}onMouseDown(t){}onMouseMove(t){}onMouseUp(t){}onDoubleClick(t){}onWheel(t){}onKeyPressed(t,i){}onKeyDown(t,i){}onKeyUp(t,i){}onTouchStart(t){}onTouchMove(t){}onTouchEnd(t){}onTouchCancel(t){}onDoubleTap(t){}onVRControllerButtonDown(t){}onVRControllerButtonUp(t){}onVRControllerDoubleClicked(t){}onVRPoseChanged(t){}}const B={VIEWER:0,DCC:1};class P extends k{constructor(t){super(t),this.dragging=!1,this.selectionRect=new s.Rect(1,1),this.selectionRectMat=new s.Material("marker","ScreenSpaceShader"),this.selectionRectMat.getParameter("BaseColor").setValue(new s.Color("#03E3AC")),this.selectionRectXfo=new s.Xfo,this.selectionRectXfo.tr.set(.5,.5,0),this.selectionRectXfo.sc.set(0,0,0)}activateTool(){super.activateTool(),this.rectItem||(this.rectItem=new s.GeomItem("selectionRect",this.selectionRect,this.selectionRectMat),this.rectItem.getParameter("Visible").setValue(!1),this.appData.renderer.addTreeItem(this.rectItem))}deactivateTool(){super.deactivateTool(),this.selectionRectXfo.sc.set(0,0,0),this.rectItem.setGlobalXfo(this.selectionRectXfo)}onMouseDown(t){return 0==t.button&&!t.altKey&&(console.log("onMouseDown"),this.mouseDownPos=t.mousePos,this.dragging=!1,!0)}__resizeRect(t,i){const e=new s.Vec2(1/t.getWidth()*2,1/t.getHeight()*2),n=i.multiply(e);this.selectionRectXfo.sc.set(Math.abs(n.x),Math.abs(n.y),1);const l=this.mouseDownPos.subtract(i.scale(.5)).multiply(e).subtract(new s.Vec2(1,1));this.selectionRectXfo.tr.x=l.x,this.selectionRectXfo.tr.y=-l.y,this.rectItem.setGlobalXfo(this.selectionRectXfo)}onMouseMove(t){if(this.mouseDownPos){const i=this.mouseDownPos.subtract(t.mousePos);this.dragging&&this.__resizeRect(t.viewport,i),i.length()>4&&(this.dragging=!0,this.rectItem.getParameter("Visible").setValue(!0),this.__resizeRect(t.viewport,i))}return!0}onMouseUp(t){if(this.mouseDownPos){if(this.dragging){this.rectItem.getParameter("Visible").setValue(!1);const i=t.mousePos,e=new s.Vec2(Math.min(this.mouseDownPos.x,i.x),Math.min(this.mouseDownPos.y,i.y)),n=new s.Vec2(Math.max(this.mouseDownPos.x,i.x),Math.max(this.mouseDownPos.y,i.y)),l=t.viewport.getGeomItemsInRect(e,n);if(this.appData.selectionManager.pickingModeActive())this.appData.selectionManager.pick(l);else{const i=new Set([...l].filter(t=>!(t.getOwner()instanceof r)));t.shiftKey?this.appData.selectionManager.deselectItems(i):this.appData.selectionManager.selectItems(i,!t.ctrlKey),this.selectionRectXfo.sc.set(0,0,0),this.rectItem.setGlobalXfo(this.selectionRectXfo)}}else{const i=t.viewport.getGeomDataAtPos(t.mousePos);if(null==i||i.geomItem.getOwner()instanceof r)this.appData.selectionManager.clearSelection();else if(this.appData.selectionManager.pickingModeActive())this.appData.selectionManager.pick(i.geomItem);else if(t.shiftKey){const t=new Set;t.add(i.geomItem),this.appData.selectionManager.deselectItems(t)}else this.appData.selectionManager.toggleItemSelection(i.geomItem,!t.ctrlKey)}return this.mouseDownPos=void 0,!0}}onVRControllerButtonDown(t){if(1==t.button){const i=t.controller.getGeomItemAtTip();if(null!=i&&!(i.geomItem.getOwner()instanceof r))return this.appData.selectionManager.toggleItemSelection(i.geomItem),!0}}}a.registerChange("SelectionTool",P);const E=function(){return{escape:function(t){return t.replace(/([.*+?^${}()|\[\]\/\\])/g,"\\$1")},parseExtension:t,mimeType:function(i){const s=t(i).toLowerCase();return function(){const t="application/font-woff";return{woff:t,woff2:t,ttf:"application/font-truetype",eot:"application/vnd.ms-fontobject",png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg",gif:"image/gif",tiff:"image/tiff",svg:"image/svg+xml"}}()[s]||""},dataAsUrl:function(t,i){return"data:"+i+";base64,"+t},isDataUrl:function(t){return-1!==t.search(/^(data:)/)},canvasToBlob:function(t){return t.toBlob?new Promise((function(i){t.toBlob(i)})):function(t){return new Promise((function(i){const s=window.atob(t.toDataURL().split(",")[1]),e=s.length,n=new Uint8Array(e);for(let t=0;t<e;t++)n[t]=s.charCodeAt(t);i(new Blob([n],{type:"image/png"}))}))}(t)},resolveUrl:function(t,i){const s=document.implementation.createHTMLDocument(),e=s.createElement("base");s.head.appendChild(e);const n=s.createElement("a");return s.body.appendChild(n),e.href=i,n.href=t,n.href},getAndEncode:function(t){return O.impl.options.cacheBust&&(t+=(/\?/.test(t)?"&":"?")+(new Date).getTime()),new Promise((function(i){const s=new XMLHttpRequest;let e;if(s.onreadystatechange=function(){if(4!==s.readyState)return;if(200!==s.status)return void(e?i(e):n("cannot fetch resource: "+t+", status: "+s.status));const l=new FileReader;l.onloadend=function(){const t=l.result.split(/,/)[1];i(t)},l.readAsDataURL(s.response)},s.ontimeout=function(){e?i(e):n("timeout of 30000ms occured while fetching resource: "+t)},s.responseType="blob",s.timeout=3e4,s.open("GET",t,!0),s.send(),O.impl.options.imagePlaceholder){const t=O.impl.options.imagePlaceholder.split(/,/);t&&t[1]&&(e=t[1])}function n(t){console.error(t),i("")}}))},uid:function(){let t=0;return function(){return"u"+("0000"+(Math.random()*Math.pow(36,4)<<0).toString(36)).slice(-4)+t++}}(),delay:function(t){return function(i){return new Promise((function(s){setTimeout((function(){s(i)}),t)}))}},asArray:function(t){const i=[],s=t.length;for(let e=0;e<s;e++)i.push(t[e]);return i},escapeXhtml:function(t){return t.replace(/#/g,"%23").replace(/\n/g,"%0A")},makeImage:function(t){return new Promise((function(i,s){const e=new Image;e.onload=function(){i(e)},e.onerror=s,e.src=t}))},width:function(t){const s=i(t,"border-left-width"),e=i(t,"border-right-width");return t.scrollWidth+s+e},height:function(t){const s=i(t,"border-top-width"),e=i(t,"border-bottom-width");return t.scrollHeight+s+e}};function t(t){const i=/\.([^\.\/]*?)$/g.exec(t);return i?i[1]:""}function i(t,i){const s=window.getComputedStyle(t).getPropertyValue(i);return parseFloat(s.replace("px",""))}}(),Q=function(){const t=/url\(['"]?([^'"]+?)['"]?\)/g;return{inlineAll:function(t,n,l){return i(t)?Promise.resolve(t).then(s).then((function(i){let s=Promise.resolve(t);return i.forEach((function(t){s=s.then((function(i){return e(i,t,n,l)}))})),s})):Promise.resolve(t)},shouldProcess:i,impl:{readUrls:s,inline:e}};function i(i){return-1!==i.search(t)}function s(i){const s=[];let e;for(;null!==(e=t.exec(i));)s.push(e[1]);return s.filter((function(t){return!E.isDataUrl(t)}))}function e(t,i,s,e){return Promise.resolve(i).then((function(t){return s?E.resolveUrl(t,s):t})).then(e||E.getAndEncode).then((function(t){return E.dataAsUrl(t,E.mimeType(i))})).then((function(s){return t.replace(function(t){return new RegExp("(url\\(['\"]?)("+E.escape(t)+")(['\"]?\\))","g")}(i),"$1"+s+"$3")}))}}(),j=function(){return{resolveAll:function(){return t().then((function(t){return Promise.all(t.map((function(t){return t.resolve()})))})).then((function(t){return t.join("\n")}))},impl:{readAll:t}};function t(){return Promise.resolve(E.asArray(document.styleSheets)).then((function(t){const i=[];return t.forEach((function(t){try{E.asArray(t.cssRules||[]).forEach(i.push.bind(i))}catch(i){console.log("Error while reading CSS rules from "+t.href,i.toString())}})),i})).then((function(t){return t.filter((function(t){return t.type===CSSRule.FONT_FACE_RULE})).filter((function(t){return Q.shouldProcess(t.style.getPropertyValue("src"))}))})).then((function(i){return i.map(t)}));function t(t){return{resolve:function(){return Q.inlineAll(t.cssText,(t.parentStyleSheet||{}).href)},src:function(){return t.style.getPropertyValue("src")}}}}}(),D=function(){return{inlineAll:function i(s){return s instanceof Element?function(t){const i=t.style.getPropertyValue("background");return i?Q.inlineAll(i).then((function(i){t.style.setProperty("background",i,t.style.getPropertyPriority("background"))})).then((function(){return t})):Promise.resolve(t)}(s).then((function(){return s instanceof HTMLImageElement?t(s).inline():Promise.all(E.asArray(s.childNodes).map((function(t){return i(t)})))})):Promise.resolve(s)},impl:{newImage:t}};function t(t){return{inline:function(i){return E.isDataUrl(t.src)?Promise.resolve():Promise.resolve(t.src).then(i||E.getAndEncode).then((function(i){return E.dataAsUrl(i,E.mimeType(t.src))})).then((function(i){return new Promise((function(s,e){t.onload=s,t.onerror=e,t.src=i}))}))}}}}(),O={toSvg:A,toPng:function(t,i){return _(t,i||{}).then((function(t){return t.toDataURL()}))},toJpeg:function(t,i){return _(t,i=i||{}).then((function(t){return t.toDataURL("image/jpeg",i.quality||1)}))},toBlob:function(t,i){return _(t,i||{}).then(E.canvasToBlob)},toPixelData:function(t,i){return _(t,i||{}).then((function(i){return i.getContext("2d").getImageData(0,0,E.width(t),E.height(t)).data}))},toCanvas:function(t,i){return _(t,i||{}).then((function(t){return t}))},impl:{fontFaces:j,images:D,util:E,inliner:Q,options:{}}};function A(t,i){return function(t){O.impl.options.imagePlaceholder=void 0===t.imagePlaceholder?undefined:t.imagePlaceholder,O.impl.options.cacheBust=void 0!==t.cacheBust&&t.cacheBust}(i=i||{}),Promise.resolve(t).then((function(t){return function t(i,s,e){return e||!s||s(i)?Promise.resolve(i).then((function(t){return t instanceof HTMLCanvasElement?E.makeImage(t.toDataURL()):t.cloneNode(!1)})).then((function(t){return n(i,t,s)})).then((function(t){return function(t,i){return i instanceof Element?Promise.resolve().then((function(){var s,e;s=window.getComputedStyle(t),e=i.style,s.cssText?e.cssText=s.cssText:function(t,i){E.asArray(t).forEach((function(s){i.setProperty(s,t.getPropertyValue(s),t.getPropertyPriority(s))}))}(s,e)})).then((function(){[":before",":after"].forEach((function(s){!function(s){const e=window.getComputedStyle(t,s),n=e.getPropertyValue("content");if(""===n||"none"===n)return;const l=E.uid();i.className=i.className+" "+l;const h=document.createElement("style");h.appendChild(function(t,i,s){const e="."+t+":"+i,n=s.cssText?function(t){const i=t.getPropertyValue("content");return t.cssText+" content: "+i+";"}(s):function(t){return E.asArray(t).map((function(i){return i+": "+t.getPropertyValue(i)+(t.getPropertyPriority(i)?" !important":"")})).join("; ")+";"}(s);return document.createTextNode(e+"{"+n+"}")}(l,s,e)),i.appendChild(h)}(s)}))})).then((function(){t instanceof HTMLTextAreaElement&&(i.innerHTML=t.value),t instanceof HTMLInputElement&&i.setAttribute("value",t.value)})).then((function(){i instanceof SVGElement&&(i.setAttribute("xmlns","http://www.w3.org/2000/svg"),i instanceof SVGRectElement&&["width","height"].forEach((function(t){const s=i.getAttribute(t);s&&i.style.setProperty(t,s)})))})).then((function(){return i})):i}(i,t)})):Promise.resolve();function n(i,s,e){const n=i.childNodes;return 0===n.length?Promise.resolve(s):function(i,s,e){let n=Promise.resolve();return s.forEach((function(s){n=n.then((function(){return t(s,e)})).then((function(t){t&&i.appendChild(t)}))})),n}(s,E.asArray(n),e).then((function(){return s}))}}(t,i.filter,!0)})).then(q).then($).then((function(t){return i.bgcolor&&(t.style.backgroundColor=i.bgcolor),i.width&&(t.style.width=i.width+"px"),i.height&&(t.style.height=i.height+"px"),i.style&&Object.keys(i.style).forEach((function(s){t.style[s]=i.style[s]})),t})).then((function(s){return function(t,i,s){return Promise.resolve(t).then((function(t){return t.setAttribute("xmlns","http://www.w3.org/1999/xhtml"),(new XMLSerializer).serializeToString(t)})).then(E.escapeXhtml).then((function(t){return'<foreignObject x="0" y="0" width="100%" height="100%">'+t+"</foreignObject>"})).then((function(t){return'<svg xmlns="http://www.w3.org/2000/svg" width="'+i+'" height="'+s+'">'+t+"</svg>"})).then((function(t){return"data:image/svg+xml;charset=utf-8,"+t}))}(s,i.width||E.width(t),i.height||E.height(t))}))}function _(t,i){return A(t,i).then(E.makeImage).then(E.delay(100)).then((function(s){const e=function(t){const s=document.createElement("canvas");if(s.width=i.width||E.width(t),s.height=i.height||E.height(t),i.bgcolor){const t=s.getContext("2d");t.fillStyle=i.bgcolor,t.fillRect(0,0,s.width,s.height)}return s}(t);return e.getContext("2d").drawImage(s,0,0),e}))}function q(t){return j.resolveAll().then((function(i){const s=document.createElement("style");return t.appendChild(s),s.appendChild(document.createTextNode(i)),t}))}function $(t){return D.inlineAll(t).then((function(){return t}))}class tt extends s.GeomItem{constructor(t,i,e){const n=new s.Material("uimat","FlatSurfaceShader");let l;n.visibleInGeomDataBuffer=!1,super("VRControllerUI",new s.Plane(1,1),n),this.appData=t,this.__vrUIDOMHolderElement=i,this.__vrUIDOMElement=e,this.__uiimage=new s.DataImage,n.getParameter("BaseColor").setValue(this.__uiimage),this.__uiGeomOffsetXfo=new s.Xfo,this.__uiGeomOffsetXfo.sc.set(0,0,1),this.__rect={width:0,height:0},this.__uiGeomOffsetXfo.ori.setFromAxisAndAngle(new s.Vec3(0,1,0),Math.PI),this.setGeomOffsetXfo(this.__uiGeomOffsetXfo);let h=[];const o=()=>{l=null;const t=h.map(t=>this.updateElemInAtlas(t));Promise.all(t).then(()=>{this.updateUIImage(),h=[]})};this.__mutationObserver=new MutationObserver(t=>{this.mainCtx?(t.some(t=>{let i=t.target;for(;i.parentNode;){if(i==this.__vrUIDOMElement)return this.renderUIToImage(),h=[],!1;if(i.classList.contains("VRUIElement")||i==this.__vrUIDOMElement){-1==h.indexOf(i)&&h.push(i);break}i=i.parentNode}return!0}),l&&clearTimeout(l),l=setTimeout(o,50)):this.renderUIToImage()}),this.__active=!1,this.__renderRequested=!1}activate(){this.__vrUIDOMHolderElement.style.display="block",this.__active=!0,this.__mutationObserver.observe(this.__vrUIDOMElement,{attributes:!0,characterData:!0,childList:!0,subtree:!0}),this.renderUIToImage()}deactivate(){this.__vrUIDOMHolderElement.style.display="none",this.__active=!0,this.__mutationObserver.disconnect()}updateElemInAtlas(t){return new Promise(i=>{O.toCanvas(t).then(s=>{const e=t.getBoundingClientRect();e.width*e.height!=0?(this.mainCtx.fillRect(e.x,e.y,e.width,e.height),this.mainCtx.drawImage(s,e.x,e.y),i()):i()})})}updateUIImage(){const t=this.mainCtx.getImageData(0,0,this.__rect.width,this.__rect.height);this.__uiimage.setData(this.__rect.width,this.__rect.height,new Uint8Array(t.data.buffer))}renderUIToImage(){O.toCanvas(this.__vrUIDOMElement).then(t=>{this.mainCtx=t.getContext("2d"),this.mainCtx.fillStyle="#FFFFFF";const i=this.__vrUIDOMElement.getBoundingClientRect();if(i.width*i.height!=0){if(i.width!=this.__rect.width||i.height!=this.__rect.height){this.__rect=i;const t=7e-4;this.__uiGeomOffsetXfo.sc.set(this.__rect.width*t,this.__rect.height*t,1),this.setGeomOffsetXfo(this.__uiGeomOffsetXfo),this.appData.session.pub("pose-message",{interfaceType:"VR",updateUIPanel:{size:this.__uiGeomOffsetXfo.sc.toJSON()}})}this.updateUIImage()}})}sendMouseEvent(t,i,s){const e=new MouseEvent(t,Object.assign({target:s,view:window,bubbles:!0,cancelable:!0},i));return s.dispatchEvent(e),e}}class it extends c{constructor(t){super("HoldObjectsChange"),this.__selection=[],this.__prevXfos=[],this.__newXfos=[],t&&this.update(t)}undo(){for(let t=0;t<this.__selection.length;t++)this.__selection[t]&&this.__selection[t].setGlobalXfo(this.__prevXfos[t])}redo(){for(let t=0;t<this.__selection.length;t++)this.__selection[t]&&this.__selection[t].setGlobalXfo(this.__newXfos[t])}update(t){if(t.newItem)this.__selection[t.newItemId]=t.newItem,this.__prevXfos[t.newItemId]=t.newItem.getGlobalXfo();else if(t.changeXfos)for(let i=0;i<t.changeXfoIds.length;i++){const s=t.changeXfoIds[i];this.__selection[s]&&(this.__selection[s].setGlobalXfo(t.changeXfos[i]),this.__newXfos[s]=t.changeXfos[i])}this.updated.emit(t)}toJSON(t){const i=super.toJSON(t),s=[];for(let t=0;t<this.__selection.length;t++)this.__selection[t]?s[t]=this.__selection[t].getPath():s.push(null);return i.itemPaths=s,i}fromJSON(t,i){super.fromJSON(t,i);const s=i.appData.scene.getRoot(),e=[];for(let i=0;i<t.itemPaths.length;i++){const n=t.itemPaths[i];n&&(e[i]=s.resolvePath(n,1))}this.__selection=e}}a.registerChange("HoldObjectsChange",it);class st extends k{constructor(t){super(t)}isPrimaryTool(){return!0}}class et extends c{constructor(t){super(t)}setParentAndXfo(t,i){this.parentItem=t;const s=this.parentItem.generateUniqueName(this.geomItem.getName());this.geomItem.setName(s),this.geomItem.setGlobalXfo(i),this.childIndex=this.parentItem.addChild(this.geomItem,!0),this.geomItem.addRef(this)}undo(){this.parentItem.removeChild(this.childIndex)}redo(){this.parentItem.addChild(this.geomItem,!1,!1)}toJSON(t){const i=super.toJSON(t);return i.parentItemPath=this.parentItem.getPath(),i.geomItemName=this.geomItem.getName(),i.geomItemXfo=this.geomItem.getParameter("LocalXfo").getValue(),i}fromJSON(t,i){const e=i.appData.scene.getRoot();this.parentItem=e.resolvePath(t.parentItemPath,1),this.geomItem.setName(this.parentItem.generateUniqueName(t.geomItemName));const n=new s.Xfo;n.fromJSON(t.geomItemXfo),this.geomItem.setLocalXfo(n),this.childIndex=this.parentItem.addChild(this.geomItem,!1)}destroy(){this.geomItem.removeRef(this)}}class nt extends st{constructor(t){super(t),this.stage=0,this.removeToolOnRightClick=!0,this.cp=this.addParameter(new s.ColorParameter("Line Color",new s.Color(.7,.2,.2)))}activateTool(){super.activateTool(),this.appData.renderer.getDiv().style.cursor="crosshair",this.appData.renderer.getXRViewport().then(t=>{this.vrControllerToolTip||(this.vrControllerToolTip=new s.Cross(.05),this.vrControllerToolTipMat=new s.Material("VRController Cross","LinesShader"),this.vrControllerToolTipMat.getParameter("Color").setValue(this.cp.getValue()),this.vrControllerToolTipMat.visibleInGeomDataBuffer=!1);const i=t=>{const i=new s.GeomItem("CreateGeomToolTip",this.vrControllerToolTip,this.vrControllerToolTipMat);t.getTipItem().removeAllChildren(),t.getTipItem().addChild(i,!1)};for(const s of t.getControllers())i(s);this.addIconToControllerId=t.controllerAdded.connect(i)})}deactivateTool(){super.deactivateTool(),this.appData.renderer.getDiv().style.cursor="pointer",this.appData.renderer.getXRViewport().then(t=>{t.controllerAdded.disconnectId(this.addIconToControllerId)})}screenPosToXfo(t,i){const e=i.calcRayFromScreenPos(t),n=new s.Ray(this.constructionPlane.tr,this.constructionPlane.ori.getZaxis()),l=e.intersectRayPlane(n);if(l>0){const t=this.constructionPlane.clone();return t.tr=e.pointAtDist(l),t}const h=i.getCamera(),o=h.getGlobalXfo().clone();return o.tr=e.pointAtDist(h.getFocalDistance()),o}createStart(t,i){this.stage=1}createPoint(t){}createMove(t){}createRelease(t){}onMouseDown(t){if(0==this.stage){if(0==t.button){this.constructionPlane=new s.Xfo;const i=this.screenPosToXfo(t.mousePos,t.viewport);this.createStart(i,this.appData.scene.getRoot())}else 2==t.button&&this.removeToolOnRightClick&&this.appData.toolManager.removeTool(this.index);return!0}return 2!=t.button||(this.appData.undoRedoManager.undo(!1),this.stage=0,!0)}onMouseMove(t){if(this.stage>0){const i=this.screenPosToXfo(t.mousePos,t.viewport);return this.createMove(i.tr),!0}}onMouseUp(t){if(this.stage>0){const i=this.screenPosToXfo(t.mousePos,t.viewport);return this.createRelease(i.tr),!0}}onWheel(t){}onKeyPressed(t,i){}onKeyDown(t,i){}onKeyUp(t,i){}onTouchStart(t){}onTouchMove(t){}onTouchEnd(t){}onTouchCancel(t){}onVRControllerButtonDown(t){if(!this.__activeController){this.__activeController=t.controller,this.constructionPlane=new s.Xfo;const i=this.constructionPlane.clone();i.tr=this.__activeController.getTipXfo().tr,this.createStart(i,this.appData.scene.getRoot())}return!0}onVRPoseChanged(t){if(this.__activeController&&this.stage>0){const t=this.__activeController.getTipXfo();return this.createMove(t.tr),!0}}onVRControllerButtonUp(t){if(this.stage>0&&this.__activeController==t.controller){const t=this.__activeController.getTipXfo();return this.createRelease(t.tr),0==this.stage&&(this.__activeController=void 0),!0}}}class lt extends et{constructor(t,i,e,n){super("Create Line"),this.line=new s.Lines(0),this.line.setNumVertices(2),this.line.setNumSegments(1),this.line.setSegment(0,0,1);const l=new s.Material("Line","LinesShader");l.getParameter("Color").setValue(new s.Color(.7,.2,.2)),this.geomItem=new s.GeomItem("Line"),this.geomItem.setGeometry(this.line),this.geomItem.setMaterial(l),e&&l.getParameter("Color").setValue(e),n&&(this.line.lineThickness=n),t&&i&&this.setParentAndXfo(t,i)}update(t){t.p1&&(this.line.getVertex(1).setFromOther(t.p1),this.line.geomDataChanged.emit()),this.updated.emit(t)}fromJSON(t,i){if(super.fromJSON(t,i),t.color){const i=new s.Color;i.fromJSON(t.color),material.getParameter("Color").setValue(i)}t.thickness&&(this.line.lineThickness=t.thickness)}}a.registerChange("CreateLineChange",lt);class ht extends nt{constructor(t){super(t),this.tp=this.addParameter(new s.NumberParameter("Line Thickness",.06,[0,.1]))}createStart(t,i){this.change=new lt(i,t),this.appData.undoRedoManager.addChange(this.change),this.xfo=t.inverse(),this.stage=1,this.length=0}createMove(t){const i=this.xfo.transformVec3(t);this.length=i.length(),this.change.update({p1:i})}createRelease(t){0==this.length&&this.appData.undoRedoManager.undo(!1),this.stage=0,this.actionFinished.emit()}}class ot extends et{constructor(t,i){super("Create Circle",t),this.circle=new s.Circle(0,64),this.circle.lineThickness=.05;const e=new s.Material("circle","FatLinesShader");e.getParameter("Color").setValue(new s.Color(.7,.2,.2)),this.geomItem=new s.GeomItem("Circle"),this.geomItem.setGeometry(this.circle),this.geomItem.setMaterial(e),t&&i&&this.setParentAndXfo(t,i)}update(t){this.circle.getParameter("Radius").setValue(t.radius),this.updated.emit(t)}toJSON(){const t=super.toJSON();return t.radius=this.circle.getParameter("Radius").getValue(),t}changeFromJSON(t){console.log("CreateCircleChange:",t),t.radius&&this.circle.getParameter("Radius").setValue(t.radius)}}a.registerChange("CreateCircleChange",ot);class at extends et{constructor(t,i){super("Create Rect"),this.rect=new s.Rect(0,0),this.rect.lineThickness=.05;const e=new s.Material("circle","FatLinesShader");e.getParameter("Color").setValue(new s.Color(.7,.2,.2)),this.geomItem=new s.GeomItem("Rect"),this.geomItem.setGeometry(this.rect),this.geomItem.setMaterial(e),t&&i&&this.setParentAndXfo(t,i)}update(t){if(t.baseSize&&this.rect.setSize(t.baseSize[0],t.baseSize[1]),t.tr){const i=this.geomItem.getParameter("LocalXfo").getValue();i.tr.fromJSON(t.tr),this.geomItem.getParameter("LocalXfo").setValue(i)}this.updated.emit(t)}}a.registerChange("CreateRectChange",at);class ct extends et{constructor(t,i,e,n){super("Create Freehand Line"),this.used=0,this.vertexCount=100,this.line=new s.Lines,this.line.setNumVertices(this.vertexCount),this.line.setNumSegments(this.vertexCount-1),this.line.vertices.setValue(0,new s.Vec3);const l=new s.Material("freeHandLine","FatLinesShader");this.geomItem=new s.GeomItem("freeHandLine"),this.geomItem.setGeometry(this.line),this.geomItem.setMaterial(l),e&&l.getParameter("Color").setValue(e),n&&(this.line.lineThickness=n),t&&i&&this.setParentAndXfo(t,i)}update(t){this.used++;let i=!1;this.used>=this.line.getNumSegments()&&(this.vertexCount=this.vertexCount+100,this.line.setNumVertices(this.vertexCount),this.line.setNumSegments(this.vertexCount-1),i=!0),this.line.vertices.setValue(this.used,t.point),this.line.setSegment(this.used-1,this.used-1,this.used),i?this.line.geomDataTopologyChanged.emit({indicesChanged:!0}):this.line.geomDataChanged.emit({indicesChanged:!0}),this.updated.emit(t)}toJSON(t){const i=super.toJSON(t);return i.lineThickness=this.line.lineThickness,i.color=this.geomItem.getMaterial().getParameter("Color").getValue(),i}fromJSON(t,i){t.lineThickness&&(this.line.lineThickness=t.lineThickness);const e=new s.Color(.7,.2,.2);t.color&&e.fromJSON(t.color),this.geomItem.getMaterial().getParameter("Color").setValue(e),super.fromJSON(t,i)}}a.registerChange("CreateFreehandLineChange",ct);class rt extends et{constructor(t,i){super("Create Sphere",t),this.sphere=new s.Sphere(0,64,32);const e=new s.Material("Sphere","SimpleSurfaceShader");this.geomItem=new s.GeomItem("Sphere"),this.geomItem.setGeometry(this.sphere),this.geomItem.setMaterial(e),t&&i&&this.setParentAndXfo(t,i)}update(t){this.sphere.radius=t.radius,this.updated.emit(t)}toJSON(){const t=super.toJSON();return t.radius=this.geomItem.getGeometry().radius,t}changeFromJSON(t){t.radius&&(this.geomItem.getGeometry().radius=t.radius)}}a.registerChange("CreateSphereChange",rt);class dt extends et{constructor(t,i){super("Create Cuboid"),this.cuboid=new s.Cuboid(0,0,0,!0);const e=new s.Material("Cuboid","SimpleSurfaceShader");this.geomItem=new s.GeomItem("Cuboid"),this.geomItem.setGeometry(this.cuboid),this.geomItem.setMaterial(e),t&&i&&this.setParentAndXfo(t,i)}update(t){if(t.baseSize&&this.cuboid.setBaseSize(t.baseSize[0],t.baseSize[1]),t.tr){const i=this.geomItem.getParameter("LocalXfo").getValue();i.tr.fromJSON(t.tr),this.geomItem.getParameter("LocalXfo").setValue(i)}t.height&&(this.cuboid.z=t.height),this.updated.emit(t)}}a.registerChange("CreateCuboidChange",dt);class ut extends d{constructor(t,i=.5,e=.02,n=new s.Color(1,1,0)){super(t),this.lengthParam=this.addParameter(new s.NumberParameter("Length",i)),this.handleRadiusParam=this.addParameter(new s.NumberParameter("Handle Radius",e)),this.barRadiusParam=this.addParameter(new s.NumberParameter("Bar Radius",.25*e)),this.colorParam=this.addParameter(new s.ColorParameter("Color",n)),this.hilghlightColorParam=this.addParameter(new s.ColorParameter("Highlight Color",new s.Color(1,1,1))),this.handleMat=new s.Material("handle","FlatSurfaceShader"),this.handleMat.getParameter("BaseColor").setValue(this.colorParam.getValue());const l=new s.Material("topBar","FlatSurfaceShader");l.getParameter("BaseColor").setValue(new s.Color(.5,.5,.5));const h=new s.Cylinder(.25*e,1,64,2,!0,!0),o=new s.Sphere(e,64);this.handle=new s.GeomItem("handle",o,this.handleMat),this.baseBar=new s.GeomItem("baseBar",h,this.handleMat),this.topBar=new s.GeomItem("topBar",h,l),this.handleXfo=new s.Xfo,this.baseBarXfo=new s.Xfo,this.topBarXfo=new s.Xfo,this.barRadiusParam.valueChanged.connect(()=>{h.getParameter("radius").setValue(this.barRadiusParam.getValue())}),this.handleRadiusParam.valueChanged.connect(()=>{o.getParameter("radius").setValue(this.handleRadiusParam.getValue())}),this.lengthParam.valueChanged.connect(()=>{this.__updateSlider(this.value)}),this.colorParam.valueChanged.connect(()=>{this.handleMat.getParameter("BaseColor").setValue(this.colorParam.getValue())}),this.addChild(this.handle),this.addChild(this.baseBar),this.addChild(this.topBar),this.__updateSlider(0)}highlight(){this.handleMat.getParameter("BaseColor").setValue(this.hilghlightColorParam.getValue())}unhighlight(){this.handleMat.getParameter("BaseColor").setValue(this.colorParam.getValue())}setTargetParam(t){this.param=t;const i=()=>{this.__updateSlider(t.getValue())};i(),t.valueChanged.connect(i)}__updateSlider(t){this.value=t;const i=this.param&&this.param.getRange()?this.param.getRange():[0,1],e=Math.remap(t,i[0],i[1],0,1),n=this.lengthParam.getValue();this.baseBarXfo.sc.z=e*n,this.handleXfo.tr.z=e*n,this.topBarXfo.tr.z=e*n,this.topBarXfo.sc.z=(1-e)*n,this.handle.setLocalXfo(this.handleXfo,s.ValueSetMode.GENERATED_VALUE),this.baseBar.setLocalXfo(this.baseBarXfo,s.ValueSetMode.GENERATED_VALUE),this.topBar.setLocalXfo(this.topBarXfo,s.ValueSetMode.GENERATED_VALUE)}onDragStart(t){this.handleXfo.sc.x=this.handleXfo.sc.y=this.handleXfo.sc.z=1.2,this.handle.setLocalXfo(this.handleXfo,s.ValueSetMode.GENERATED_VALUE),this.param&&t.undoRedoManager&&(this.change=new u(this.param),t.undoRedoManager.addChange(this.change))}onDrag(t){const i=this.lengthParam.getValue(),s=this.param&&this.param.getRange()?this.param.getRange():[0,1],e=Math.clamp(Math.remap(t.value,0,i,s[0],s[1]),s[0],s[1]);if(!this.param)return this.__updateSlider(e),void(this.value=e);this.change?this.change.update({value:e}):this.param.setValue(e)}onDragEnd(t){this.change=null,this.handleXfo.sc.x=this.handleXfo.sc.y=this.handleXfo.sc.z=1,this.handle.setLocalXfo(this.handleXfo,s.ValueSetMode.GENERATED_VALUE)}toJSON(t,i=0){const s=super.toJSON(t,i|SAVE_FLAG_SKIP_CHILDREN);return this.param&&(s.targetParam=this.param.getPath()),s}fromJSON(t,i,s){super.fromJSON(t,i,s),t.targetParam&&i.resolvePath(t.targetParam).then(t=>{this.setTargetParam(t)})}}s.sgFactory.registerClass("SliderHandle",ut);class mt extends Z{constructor(t,i=1,e=1,n=.02,l=new s.Color(1,1,0)){super(t),this.arcRadiusParam=this.addParameter(new s.NumberParameter("Arc Radius",i)),this.arcAngleParam=this.addParameter(new s.NumberParameter("Arc Angle",e)),this.handleRadiusParam=this.addParameter(new s.NumberParameter("Handle Radius",n)),this.colorParam=this.addParameter(new s.ColorParameter("Color",l)),this.hilghlightColorParam=this.addParameter(new s.ColorParameter("Highlight Color",new s.Color(1,1,1))),this.handleMat=new s.Material("handleMat","HandleShader");const h=new s.Circle(i,e,64),o=new s.Sphere(n,64);this.handle=new s.GeomItem("handle",o,this.handleMat),this.arc=new s.GeomItem("arc",h,this.handleMat),this.handleXfo=new s.Xfo,this.handleGeomOffsetXfo=new s.Xfo,this.handleGeomOffsetXfo.tr.x=i,this.handle.getParameter("GeomOffsetXfo").setValue(this.handleGeomOffsetXfo),this.range=[0,e],this.arcAngleParam.valueChanged.connect(()=>{const t=this.arcAngleParam.getValue();h.getParameter("Angle").setValue(t),this.range=[0,t]}),this.arcRadiusParam.valueChanged.connect(()=>{const t=this.arcRadiusParam.getValue();h.getParameter("Radius").setValue(t),this.handleGeomOffsetXfo.tr.x=t,this.handle.getParameter("GeomOffsetXfo").setValue(this.handleGeomOffsetXfo)}),this.handleRadiusParam.valueChanged.connect(()=>{o.getParameter("radius").setValue(this.handleRadiusParam.getValue())}),this.colorParam.valueChanged.connect(()=>{this.handleMat.getParameter("BaseColor").setValue(this.colorParam.getValue())}),this.addChild(this.handle),this.addChild(this.arc),this.setTargetParam(this.handle.getParameter("GlobalXfo"),!1),this.dragStart=new s.Signal,this.dragEnd=new s.Signal}onMouseEnter(t){t.intersectionData&&t.intersectionData.geomItem==this.handle&&this.highlight()}onMouseLeave(t){this.unhighlight()}onMouseDown(t){t.intersectionData&&t.intersectionData.geomItem==this.handle&&super.onMouseDown(t)}highlight(){this.handleMat.getParameter("BaseColor").setValue(this.hilghlightColorParam.getValue())}unhighlight(){this.handleMat.getParameter("BaseColor").setValue(this.colorParam.getValue())}getBaseXfo(){return this.handle.getParameter("GlobalXfo").getValue()}onDragStart(t){this.baseXfo=this.getGlobalXfo().clone(),this.baseXfo.sc.set(1,1,1),this.deltaXfo=new s.Xfo,this.vec0=this.getGlobalXfo().ori.getXaxis(),this.vec0.normalizeInPlace(),t.undoRedoManager&&(this.change=new u(this.param),t.undoRedoManager.addChange(this.change)),this.handleGeomOffsetXfo.sc.x=this.handleGeomOffsetXfo.sc.y=this.handleGeomOffsetXfo.sc.z=1.2,this.handle.getParameter("GeomOffsetXfo").setValue(this.handleGeomOffsetXfo),this.dragStart.emit()}onDrag(t){const i=t.holdPos.subtract(this.baseXfo.tr);i.normalizeInPlace();let s=this.vec0.angleTo(i);if(this.vec0.cross(i).dot(this.baseXfo.ori.getZaxis())<0&&(s=-s),this.range&&(s=Math.clamp(s,this.range[0],this.range[1])),t.shiftKey){const t=Math.degToRad(22.5);s=Math.floor(s/t)*t}this.deltaXfo.ori.setFromAxisAndAngle(new Vec3(0,0,1),s);const e=this.baseXfo.multiply(this.deltaXfo);this.change?this.change.update({value:e}):(this.param?this.param:this.getParameter("GlobalXfo")).setValue(e)}onDragEnd(t){this.change=null,this.handleGeomOffsetXfo.sc.x=this.handleGeomOffsetXfo.sc.y=this.handleGeomOffsetXfo.sc.z=1,this.handle.getParameter("GeomOffsetXfo").setValue(this.handleGeomOffsetXfo),this.dragEnd.emit()}toJSON(t,i=0){const s=super.toJSON(t,i|SAVE_FLAG_SKIP_CHILDREN);return this.param&&(s.targetParam=this.param.getPath()),s}fromJSON(t,i,s){super.fromJSON(t,i,s),t.targetParam&&i.resolvePath(t.targetParam).then(t=>{this.setTargetParam(t)})}}s.sgFactory.registerClass("ArcSlider",mt);class bt extends HTMLElement{constructor(){super();const t=this.attachShadow({mode:"open"}),i=document.createElement("style");i.appendChild(document.createTextNode(bt.css)),t.appendChild(i),this.itemContainer=document.createElement("div"),this.itemHeader=document.createElement("div"),this.itemHeader.className="TreeNodeHeader",this.itemContainer.appendChild(this.itemHeader),this.itemChildren=document.createElement("div"),this.itemChildren.className="TreeNodesList",this.itemContainer.appendChild(this.itemChildren),this.expandBtn=document.createElement("button"),this.expandBtn.className="TreeNodesListItem__ToggleExpanded",this.itemHeader.appendChild(this.expandBtn),this.expanded=!1,this.childrenAlreadyCreated=!1,this.expandBtn.addEventListener("click",()=>{this.treeItem.getNumChildren()>0&&(this.expanded?this.collapse():this.expand())}),this.titleElement=document.createElement("span"),this.titleElement.className="TreeNodesListItem__Title",this.titleElement.addEventListener("click",t=>{this.appData&&this.appData.selectionManager?this.appData.selectionManager.pickingModeActive()?this.appData.selectionManager.pick(this.treeItem):this.appData.selectionManager.toggleItemSelection(this.treeItem,!t.ctrlKey):this.treeItem.setSelected(!this.treeItem.getSelected())}),this.itemHeader.appendChild(this.titleElement),t.appendChild(this.itemContainer)}setTreeItem(t,i){this.treeItem=t,this.appData=i,this.titleElement.textContent=t.getName(),this.treeItem.nameChanged.connect(()=>{this.titleElement.textContent=t.getName()}),this.updateSelectedId=this.treeItem.selectedChanged.connect(this.updateSelected.bind(this)),this.updateSelected(),t instanceof s.TreeItem&&(this.toggleVisibilityBtn=document.createElement("button"),this.toggleVisibilityBtn.className="TreeNodesListItem__ToggleVisibility",this.itemHeader.insertBefore(this.toggleVisibilityBtn,this.titleElement),this.toggleVisibilityBtn.innerHTML='<i class="material-icons-outlined md-15">visibility</i>',this.toggleVisibilityBtn.addEventListener("click",()=>{const t=this.treeItem.getParameter("Visible");if(this.appData&&this.appData.undoRedoManager){const i=new ParameterValueChange(t,!t.getValue());this.appData.undoRedoManager.addChange(i)}else t.setValue(!t.getValue())}),this.updateVisibilityId=this.treeItem.visibilityChanged.connect(this.updateVisibility.bind(this)),this.updateVisibility(),this.updateHighlightId=this.treeItem.highlightChanged.connect(this.updateHighlight.bind(this)),this.updateHighlight(),this.treeItem.getChildren().length&&this.collapse(),this.childAddedId=this.treeItem.childAdded.connect(this.childAdded.bind(this)),this.childRemovedId=this.treeItem.childRemoved.connect(this.childRemoved.bind(this)))}updateVisibility(){const t=this.treeItem.getVisible();t?this.itemContainer.classList.remove("TreeNodesListItem--isHidden"):this.itemContainer.classList.add("TreeNodesListItem--isHidden"),this.toggleVisibilityBtn.innerHTML=t?'<i class="material-icons-outlined md-15">visibility</i>':'<i class="material-icons-outlined md-15">visibility_off</i>'}updateSelected(){this.treeItem.getSelected()?this.itemContainer.classList.add("TreeNodesListItem--isSelected"):this.itemContainer.classList.remove("TreeNodesListItem--isSelected")}updateHighlight(){const t=this.treeItem.isHighlighted();if(t?this.itemContainer.classList.add("TreeNodesListItem--isHighlighted"):this.itemContainer.classList.remove("TreeNodesListItem--isHighlighted"),t){const t=this.treeItem.getHighlight(),i=t.lerp(new s.Color(.75,.75,.75,0),.5);this.titleElement.style.setProperty("border-color",t.toHex()),this.titleElement.style.setProperty("background-color",i.toHex())}else this.titleElement.style.removeProperty("border-color"),this.titleElement.style.removeProperty("background-color")}expand(){this.expanded=!0,this.itemChildren.classList.remove("TreeNodesList--collapsed"),this.expandBtn.innerHTML='<i class="material-icons md-24">arrow_drop_down</i>',this.childrenAlreadyCreated||(this.treeItem.getChildren().forEach((t,i)=>{this.addChild(t,i)}),this.childrenAlreadyCreated=!0)}collapse(){this.itemChildren.classList.add("TreeNodesList--collapsed"),this.expandBtn.innerHTML='<i class="material-icons md-24">arrow_right</i>',this.expanded=!1}addChild(t,i){if(this.expanded){const s=document.createElement("tree-item-view");s.setTreeItem(t,this.appData),i==this.itemChildren.childElementCount?this.itemChildren.appendChild(s):this.itemChildren.insertBefore(s,this.itemChildren.children[i])}else this.collapse()}childAdded(t,i){this.addChild(t,i)}childRemoved(t,i){this.expanded&&(this.itemChildren.children[i].destroy(),this.itemChildren.removeChild(this.itemChildren.children[i]))}destroy(){this.treeItem.selectedChanged.disconnectId(this.updateSelectedId),this.treeItem instanceof s.TreeItem&&(this.treeItem.highlightChanged.disconnectId(this.updateHighlightId),this.treeItem.visibilityChanged.disconnectId(this.updateVisibilityId),this.treeItem.childAdded.disconnectId(this.childAddedId),this.treeItem.childRemoved.disconnectId(this.childRemovedId))}}bt.css="\n  /* tree-view.css */\n\n  ////\n  /// From https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined\n\n  /* fallback */\n  @font-face {\n    font-family: 'Material Icons';\n    font-style: normal;\n    font-weight: 400;\n    src: url(https://fonts.gstatic.com/s/materialicons/v48/flUhRq6tzZclQEJ-Vdg-IuiaDsNc.woff2) format('woff2');\n  }\n  /* fallback */\n  @font-face {\n    font-family: 'Material Icons Outlined';\n    font-style: normal;\n    font-weight: 400;\n    src: url(https://fonts.gstatic.com/s/materialiconsoutlined/v14/gok-H7zzDkdnRel8-DQ6KAXJ69wP1tGnf4ZGhUce.woff2) format('woff2');\n  }\n\n  .material-icons {\n    font-family: 'Material Icons';\n    font-weight: normal;\n    font-style: normal;\n    font-size: 24px;\n    line-height: 1;\n    letter-spacing: normal;\n    text-transform: none;\n    display: inline-block;\n    white-space: nowrap;\n    word-wrap: normal;\n    direction: ltr;\n    -webkit-font-feature-settings: 'liga';\n    -webkit-font-smoothing: antialiased;\n  }\n\n  .material-icons-outlined {\n    font-family: 'Material Icons Outlined';\n    font-weight: normal;\n    font-style: normal;\n    font-size: 24px;\n    line-height: 1;\n    letter-spacing: normal;\n    text-transform: none;\n    display: inline-block;\n    white-space: nowrap;\n    word-wrap: normal;\n    direction: ltr;\n    -webkit-font-feature-settings: 'liga';\n    -webkit-font-smoothing: antialiased;\n  }\n  .TreeNodesList {\n    border-left: 1px dotted;\n    list-style-type: none;\n    padding: 0 0 0 15px;\n    margin: 0 0 0 10px;\n  }\n\n  .TreeNodesList--collapsed {\n    display: none;\n  }\n\n  .TreeNodesList--root {\n    border: none;\n    margin: 0;\n    padding: 0;\n    width: max-content;\n  }\n\n  .TreeNodesListItem{\n    display: flex;\n  }\n\n  .TreeNodesListItem__ToggleVisibility {\n    border: none;\n    color: #333;\n    height: 24px;\n    padding: 0;\n    width: 25px;\n  }\n\n  .TreeNodesListItem__ToggleVisibility:focus {\n    outline: none;\n  }\n\n  .TreeNodesListItem__ToggleExpanded {\n    border: none;\n    height: 24px;\n    width: 24px;\n    padding: 0;\n    background-color: #0000;\n    outline: none;\n  }\n\n  .TreeNodesListItem::before {\n    border-bottom: 1px dotted;\n    content: '';\n    display: inline-block;\n    left: -15px;\n    position: relative;\n    top: -5px;\n    width: 10px;\n  }\n\n  .TreeNodesListItem__Toggle:focus {\n    outline: none;\n  }\n\n  .TreeNodeHeader{\n    display: flex;\n    margin: 0.4em auto;\n  }\n\n  .TreeNodesListItem__Title {\n    cursor: default;\n    padding: 2px 4px;\n    border-radius: 5px;\n  }\n\n  .TreeNodesListItem__Title:hover {\n    background-color: #e1f5fe;\n  }\n  .TreeNodesListItem__Hover {\n    background-color: #e1f5fe;\n  }\n\n  .TreeNodesListItem__Dragging {\n    background-color: #e1f5fe;\n  }\n\n  .TreeNodesListItem--isSelected > .TreeNodeHeader > .TreeNodesListItem__Title {\n    background-color: #76d2bb;\n    color: #3B3B3B;\n  }\n\n  .TreeNodesListItem--isHidden > .TreeNodeHeader >  .TreeNodesListItem__Title {\n    color: #9e9e9e;\n  }\n\n  .TreeNodesListItem--isHighlighted > .TreeNodeHeader >  .TreeNodesListItem__Title {\n    border-style: solid;\n    border-width: thin;\n  }\n\n  /* Rules for sizing the icon. */\n  .material-icons-outlined.md-15,\n  .material-icons.md-15 {\n    font-size: 15px;\n  }\n  .material-icons.md-18 {\n    font-size: 18px;\n  }\n  .material-icons.md-24 {\n    font-size: 24px;\n  }\n  .material-icons.md-36 {\n    font-size: 36px;\n  }\n  .material-icons.md-48 {\n    font-size: 48px;\n  }\n\n  /* Rules for using icons as black on a light background. */\n  .material-icons.md-dark {\n    color: rgba(0, 0, 0, 0.54);\n  }\n  .material-icons.md-dark.md-inactive {\n    color: rgba(0, 0, 0, 0.26);\n  }\n\n  /* Rules for using icons as white on a dark background. */\n  .material-icons.md-light {\n    color: rgba(255, 255, 255, 1);\n  }\n  .material-icons.md-light.md-inactive {\n    color: rgba(255, 255, 255, 0.3);\n  }\n\n  ",customElements.get("tree-item-view")||customElements.define("tree-item-view",bt);class Zt extends HTMLElement{constructor(){super();const t=this.attachShadow({mode:"open"});this.treeContainer=document.createElement("div"),t.appendChild(this.treeContainer),this.treeItemView=document.createElement("tree-item-view");const i=new CSSStyleSheet;i.replaceSync("@font-face {\n      font-family: \"Material Icons\";\n      font-style: normal;\n      font-weight: 400;\n      src: url('https://fonts.gstatic.com/s/materialicons/v48/flUhRq6tzZclQEJ-Vdg-IuiaDsNc.woff2') format('woff');\n    }");const s=new CSSStyleSheet;s.replaceSync("@font-face {\n      font-family: \"Material Icons Outlined\";\n      font-style: normal;\n      font-weight: 400;\n      src: url('https://fonts.gstatic.com/s/materialiconsoutlined/v14/gok-H7zzDkdnRel8-DQ6KAXJ69wP1tGnf4ZGhUce.woff2') format('woff');\n    }"),document.adoptedStyleSheets=[...document.adoptedStyleSheets,i,s]}setTreeItem(t,i){this.treeItemView.setTreeItem(t,i),this.treeContainer.appendChild(this.treeItemView)}}customElements.get("scene-tree-view")||customElements.define("scene-tree-view",Zt),i.ActionRegistry=class{constructor(){this.actions=[],this.actionAdded=new s.Signal}registerAction(t){const{name:i}=t;i?this._addAction(t):console.warn("A action is missing its name.")}_addAction(t){this.actions.push(t),this.actionAdded.emit(t)}getActions(){return this.actions}},i.ActionTreeView=class{constructor(t){this.actionRegistry=t,this.__existingItems={};const i=document.createElement("div");document.body.appendChild(i);const s=this._addUlTo(i,"pure-menu-list");this.actionRegistry.getActions().forEach(t=>{1==t.availableInVR&&this._addMenuItem(s,t)}),this.actionRegistry.actionAdded.connect(t=>{1==t.availableInVR&&this._addMenuItem(s,t)})}_addSpanTo(t,i,s){const e=document.createElement("span");return e.className=i,s&&(e.innerHTML=s),t.appendChild(e),e}_addMenuItem(t,i){const s=document.createElement("a");s.href="#";const e="pure-menu-link VRUIElement";let n=!1;return s.className=e,s.addEventListener("mouseenter",()=>{n||(s.className=e+" HighlightedMenu")}),s.addEventListener("mouseleave",()=>{s.className=n?e+" ActionedMenu":e}),i.activatedChanged?i.activatedChanged.connect(t=>{s.className=t?e+" ActionedMenu":e,n=t}):(s.addEventListener("mousedown",()=>{s.className=e+" ActionedMenu"}),s.addEventListener("mouseup",()=>{s.className=e+" HighlightedMenu"})),i.callback&&s.addEventListener("click",t=>{t.preventDefault(),i.callback()}),t.appendChild(s),this._addSpanTo(s,"ActionTitle",i.name),s}_addUlTo(t,i,s){const e=document.createElement("ul");return e.className=i,s&&(e.innerHTML=s),t.appendChild(e),e}_addLiTo(t,i,s){const e=document.createElement("li");return e.className=i,s&&(e.innerHTML=s),t.appendChild(e),e}},i.ArcSlider=mt,i.AxialRotationHandle=p,i.Change=c,i.CollabPanel=class{constructor(t){this.userSelected=new s.Signal,this.session=t}mount(t){t.innerHTML='\n      <div class="ba b--light-blue br2 pa2 h4 overflow-y-auto mb2">\n        <ul id="userChips" class="list pa0 ma0"></ul>\n      </div>\n      <div class="ba b--light-blue br2 pa2 h5 overflow-y-auto mb2" id="receivedMessages"></div>\n\n      <form autocomplete="off" name="formSendMessage">\n        <div class="mb2 flex">\n          <input class="w-100 mr1" name="messageToSend" required type="text">\n          <button class="pure-button">\n            <i class="material-icons f4">send</i>\n          </button>\n        </div>\n      </form>\n\n      <div class="btn-group">\n        <button class="pure-button AudioButton" disabled id="toggleMic">\n          <i class="material-icons">mic</i>\n        </button>\n\n        <button class="pure-button CameraButton" disabled id="toggleCam">\n          <i class="material-icons">videocam</i>\n        </button>\n      </div>\n      \x3c!--\n      <form class="pure-form pure-form-aligned" name="formCreateRoom">\n        <legend>Create Room</legend>\n        <fieldset>\n          <div class="pure-control-group">\n            <label for="roomId">Room ID</label>\n            <input name="roomId" disabled type="text">\n            <button class="pure-button" disabled type="button">\n              <i class="material-icons f4">file_copy</i>\n            </button>\n          </div>\n        </fieldset>\n      </form>\n\n      <form class="pure-form pure-form-aligned" name="formJoinRoom">\n        <legend>Join Room</legend>\n        <fieldset>\n          <div class="pure-control-group">\n            <label for="roomId">Room ID</label>\n            <input name="roomId" type="text">\n          </div>\n        </fieldset>\n        <div class="flex justify-center">\n          <button class="pure-button pure-button-primary">\n            Join Room\n          </button>\n        </div>\n      </form>\n      --!>\n      <div class="btn-group tc">\n        <button class="pure-button pure-button-primary ma2" disabled>\n          Create Room\n        </button>\n        <button class="pure-button pure-button-primary ma0" disabled>\n          Join Room\n        </button>\n      </div>\n    ';const i=document.getElementById("userChips"),s=document.getElementById("receivedMessages"),n=document.getElementById("toggleMic");let l=!1;n.addEventListener("click",()=>{l?(this.session.muteAudio(),n.classList.remove("AudioButton--on"),l=!1):(this.session.unmuteAudio(),n.classList.add("AudioButton--on"),l=!0)});const h=document.getElementById("toggleCam");let o=!1;h.addEventListener("click",()=>{o?(this.session.stopCamera(),h.classList.remove("CameraButton--on"),o=!1):(this.session.startCamera(),h.classList.add("CameraButton--on"),o=!0)});const a=(t,i)=>{const e=document.createElement("p");e.innerHTML=`<strong>${t}:</strong> ${i}`,s.appendChild(e),s.scrollTop=s.scrollHeight};document.formSendMessage.addEventListener("submit",t=>{const i=t.target;a("Me",i.messageToSend.value),this.session.pub(e.Session.actions.TEXT_MESSAGE,{text:i.messageToSend.value}),t.preventDefault(),i.reset()}),this.session.sub(e.Session.actions.TEXT_MESSAGE,(t,i)=>{const s=this.session.getUser(i);a(s.given_name,t.text)});const c={},r=t=>{const e=document.createElement("p");e.innerHTML=`<strong>(${t.name} has joined)</strong>`,s.appendChild(e),s.scrollTop=s.scrollHeight;const n=document.createElement("li");i.appendChild(n),new z(n,t).userSelected.connect(t=>{this.userSelected.emit(t)}),c[t.id]=n},d=t=>{const e=document.createElement("p");e.innerHTML=`<strong>(${t.name} has left)</strong>`,s.appendChild(e),s.scrollTop=s.scrollHeight,i.removeChild(c[t.id])};this.session.sub(e.Session.actions.USER_JOINED,t=>{r(t)}),this.session.sub(e.Session.actions.USER_LEFT,t=>{d(t)}),this.session.sub(e.Session.actions.LEFT_ROOM,()=>{const t=this.session.getUsers();for(const i in t)d(t[i]);s.innerHTML=""});const u=this.session.getUsers();for(const t in u)r(u[t])}unMount(t){}},i.CreateCircleTool=class extends nt{constructor(t){super(t)}createStart(t,i){this.change=new ot(i,t),this.appData.undoRedoManager.addChange(this.change),this.xfo=t,this.stage=1,this.radius=0}createMove(t){this.radius=t.distanceTo(this.xfo.tr),this.change.update({radius:this.radius})}createRelease(t){0==this.radius&&this.appData.undoRedoManager.undo(!1),this.change=null,this.stage=0,this.actionFinished.emit()}},i.CreateCuboidTool=class extends nt{constructor(t){super(t)}createStart(t,i){this.change=new dt(i,t),this.appData.undoRedoManager.addChange(this.change),this.xfo=t,this.invxfo=t.inverse(),this.stage=1,this._height=0}createMove(t){if(1==this.stage){const i=this.invxfo.transformVec3(t);this.change.update({baseSize:[Math.abs(i.x),Math.abs(i.y)],tr:this.xfo.tr.add(i.scale(.5))})}else{const i=this.invxfo.transformVec3(t);this.change.update({height:i.y})}}createRelease(t,i){if(1==this.stage){this.stage=2,this.pt1=t;const i=new s.Quat;i.setFromAxisAndAngle(new s.Vec3(1,0,0),.5*Math.PI),this.constructionPlane.ori=this.constructionPlane.ori.multiply(i),this.constructionPlane.tr=t,this.invxfo=this.constructionPlane.inverse()}else 2==this.stage&&(this.stage=0,this.actionFinished.emit())}},i.CreateFreehandLineTool=class extends ht{constructor(t){super(t),this.mp=this.addParameter(new s.BooleanParameter("Modulate Thickness By Stroke Speed",!1))}createStart(t,i){const s=this.cp.getValue(),e=this.tp.getValue();this.change=new ct(i,t,s,e),this.appData.undoRedoManager.addChange(this.change),this.xfo=t,this.invxfo=t.inverse(),this.stage=1,this.prevP=t.tr,this.length=0}createMove(t){const i=this.invxfo.transformVec3(t),s=i.subtract(this.prevP).length();s>.001&&this.change.update({point:i}),this.length+=s,this.prevP=i}createRelease(t){0==this.length&&this.appData.undoRedoManager.undo(!1),this.stage=0,this.actionFinished.emit()}},i.CreateLineTool=ht,i.CreateRectTool=class extends nt{constructor(t){super(t)}createStart(t,i){this.change=new at(i,t),this.appData.undoRedoManager.addChange(this.change),this.xfo=t,this.invxfo=t.inverse(),this.stage=1,this._size=0}createMove(t){if(1==this.stage){const i=this.invxfo.transformVec3(t);this._size=Math.abs(i.x),this.change.update({baseSize:[Math.abs(i.x),Math.abs(i.y)],tr:this.xfo.tr.add(i.scale(.5))})}else{const i=this.invxfo.transformVec3(t);this.change.update({height:i.y})}}createRelease(t,i){0==this._size&&this.appData.undoRedoManager.undo(!1),this.stage=0,this.actionFinished.emit()}},i.CreateSphereTool=class extends nt{constructor(t){super(t)}createStart(t,i){this.change=new rt(i,t),this.appData.undoRedoManager.addChange(this.change),this.xfo=t,this.stage=1,this.radius=0}createMove(t){this.radius=t.distanceTo(this.xfo.tr),this.change.update({radius:this.radius})}createRelease(t){0==this.radius&&this.appData.undoRedoManager.undo(!1),this.stage=0,this.actionFinished.emit()}},i.HandleTool=class extends k{constructor(t){super(t),this.activeHandle=void 0,this.capturedItems=[],this.mouseOverItems=[]}activateTool(){super.activateTool(),console.log("activateTool.HandleTool"),this.appData.renderer.getDiv().style.cursor="crosshair";const t=t=>{if(!this.__activated)return;const i=new s.Sphere(.015),e=new s.Material("Cross","FlatSurfaceShader");e.getParameter("BaseColor").setValue(new s.Color("#03E3AC")),e.visibleInGeomDataBuffer=!1;const n=new s.GeomItem("HandleToolTip",i,e);t.getTipItem().removeAllChildren(),t.getTipItem().addChild(n,!1)},i=i=>{for(const s of i.getControllers())t(s);this.addIconToControllerId=i.controllerAdded.connect(t)};this.appData.renderer.getXRViewport().then(t=>{i(t)})}deactivateTool(){super.deactivateTool(),this.appData.renderer.getXRViewport().then(t=>{t.controllerAdded.disconnectId(this.addIconToControllerId)})}onMouseDown(t){if(!this.activeHandle){const i=t.viewport.getGeomDataAtPos(t.mousePos);if(null==i)return;if(i.geomItem.getOwner()instanceof r)return this.activeHandle=i.geomItem.getOwner(),this.activeHandle.handleMouseDown(Object.assign(t,{intersectionData:i})),!0}}onMouseMove(t){if(this.activeHandle)return this.activeHandle.handleMouseMove(t),!0;{if(0==t.button&&1==t.buttons)return!1;const i=t.viewport.getGeomDataAtPos(t.mousePos);if(null!=i&&i.geomItem.getOwner()instanceof r){const t=i.geomItem.getOwner();return this.__highlightedHandle&&this.__highlightedHandle.unhighlight(),this.__highlightedHandle=t,this.__highlightedHandle.highlight(),!0}this.__highlightedHandle&&(this.__highlightedHandle.unhighlight(),this.__highlightedHandle=void 0)}}onMouseUp(t){if(this.activeHandle)return this.activeHandle.handleMouseUp(t),this.activeHandle=void 0,!0}onWheel(t){this.activeHandle&&this.activeHandle.onWheel(t)}onTouchStart(t){}onTouchMove(t){}onTouchEnd(t){}onTouchCancel(t){}__prepareVREvent(t){const i=t.controller.getId();t.setCapture=t=>{this.capturedItems[i]=t},t.getCapture=()=>this.capturedItems[i],t.releaseCapture=()=>{this.capturedItems[i]=null}}onVRControllerButtonDown(t){const i=t.controller.getId();if(this.capturedItems[i])this.__prepareVREvent(t),this.capturedItems[i].onMouseDown(t);else{const i=t.controller.getGeomItemAtTip();null!=i&&(t.intersectionData=i,t.geomItem=i.geomItem,this.__prepareVREvent(t),i.geomItem.onMouseDown(t))}}onVRPoseChanged(t){for(const i of t.controllers){const s=i.getId();if(this.capturedItems[s])this.capturedItems[s].onMouseMove(t);else{const e=i.getGeomItemAtTip();null!=e?(t.intersectionData=e,t.geomItem=e.geomItem,e.geomItem!=this.mouseOverItems[s]&&(this.mouseOverItems[s]&&this.mouseOverItems[s].onMouseLeave(t),this.mouseOverItems[s]=e.geomItem,this.mouseOverItems[s].onMouseEnter(t)),e.geomItem.onMouseMove(t)):this.mouseOverItems[s]&&(this.mouseOverItems[s].onMouseLeave(t),this.mouseOverItems[s]=null)}}}onVRControllerButtonUp(t){this.__prepareVREvent(t);const i=t.controller.getId();if(this.capturedItems[i])this.capturedItems[i].onMouseUp(t);else{const i=t.controller.getGeomItemAtTip();null!=i&&(t.intersectionData=i,t.geomItem=i.geomItem,i.geomItem.onMouseUp(t))}}},i.InspectorContainer=class{constructor(t){this.appData=t,this.pinned=!1}inspect(t){this.inspectedItem=t,this.domElement&&(this.inspector&&(this.inspector.destroy&&this.inspector.destroy(),this.domElement.innerHTML=""),this.inspectedItem&&(this.inspector=C.constructInspector(t,this.domElement,this.appData)))}mount(t){this.parentElement=t;const i=document.createElement("ul");i.className="list pa0 pr3";const s=document.createElement("li"),e=document.createElement("input");e.setAttribute("id","pinned"),e.setAttribute("type","checkbox"),e.setAttribute("tabindex",0),e.checked=this.pinned,e.style.margin="5px",e.addEventListener("input",()=>{this.pinned=e.checked});const n=document.createElement("label");n.setAttribute("for","pinned"),n.appendChild(document.createTextNode("Pinned")),s.appendChild(n),s.appendChild(e),i.appendChild(s);const l=document.createElement("li");this.domElement=document.createElement("div"),l.appendChild(this.domElement),i.appendChild(l),this.parentElement.appendChild(i),this.domElement.innerHTML="",this.inspectedItem&&this.inspect(this.inspectedItem),this._selChangedId=this.appData.selectionManager.leadSelectionChanged.connect(t=>{this.inspectedItem&&this.pinned||this.inspect(t)})}unMount(){this.appData.selectionManager.leadSelectionChanged.disconnectId(this._selChangedId),this.parentElement.innerHTML=""}},i.LinearMovementHandle=m,i.OpenVRUITool=class extends k{constructor(t,i){super(t),this.vrUITool=i,this.uiToolIndex=-1,this.__stayClosed=!1}uninstall(){super.uninstall(),this.uiToolIndex>0&&this.appData.toolManager.removeToolByHandle(this.vrUITool)}onVRControllerButtonDown(t){}onVRControllerButtonUp(t){}stayClosed(){this.__stayClosed=!0}onVRPoseChanged(t){if(this.vrUITool.installed())return;const i=t.viewXfo,s=(t,s)=>{if(!t)return!1;const e=t.getTreeItem().getGlobalXfo(),n=e.tr.subtract(i.tr);return n.normalizeInPlace(),n.angleTo(e.ori.getYaxis())<.25*Math.PI?(this.__stayClosed||(this.vrUITool.setUIControllers(this,t,s,i),this.uiToolIndex=this.appData.toolManager.pushTool(this.vrUITool)),!0):void 0};if(t.controllers.length>0){if(s(t.controllers[0],t.controllers[1]))return!0;if(s(t.controllers[1],t.controllers[0]))return!0}this.uiToolIndex=-1,this.__stayClosed=!1}},i.Panels=class{constructor(t,i){this.options=i||{},t&&this.mount(t)}mount(t){this.sidePanelsWrapper=document.createElement("div"),this.sidePanelsWrapper.className="PanelsWrapper flex overflow-hidden",t.appendChild(this.sidePanelsWrapper),1==this.options.leftPanel&&(this.leftPanel=new H(0),this.leftPanel.mount(this.sidePanelsWrapper)),this.centerDomElement=document.createElement("div"),this.centerDomElement.className="PanelsCenter flex-grow-1 overflow-hidden",this.centerDomElement.id="viewport",this.sidePanelsWrapper.appendChild(this.centerDomElement),1==this.options.rightPanel&&(this.rightPanel=new H(1),this.rightPanel.mount(this.sidePanelsWrapper)),1==this.options.bottomPanel&&(this.bottomPanel=new U,this.bottomPanel.mount(t))}unMount(t){}},i.ParameterContainer=T,i.ParameterValueChange=u,i.PlanarMovementHandle=b,i.PublishDialog=class{constructor(){this.__publishDialogHolder=document.createElement("div"),this.__publishDialogHolder.className="publish-dialog-bg",this.__publishDialogHolder.addEventListener("mousedown",t=>{t.target==this.__publishDialogHolder&&this.hide()});const t=document.createElement("div");t.className="publish-dialog";const i=new URLSearchParams(window.location.search),s=new URLSearchParams;i.forEach((function(t,i){i.startsWith("room-id")||s.set(i,t)})),s.set("published",!0);const e=`${window.location.origin}?${s.toString()}`,n=document.createElement("div");n.className="publicToggle",n.className="publish-dialog-toggle";const l=document.createElement("input");l.setAttribute("type","checkbox"),l.setAttribute("is","isPublicCheckbox"),l.value=e,l.addEventListener("change",()=>{a.disabled=!l.checked,o.disabled=!l.checked}),n.appendChild(l);const h=document.createElement("label");h.className="publish-dialog-label",h.setAttribute("type","checkbox"),h.setAttribute("for","isPublicCheckbox"),h.textContent="Is Published",n.appendChild(h),t.appendChild(n);const o=document.createElement("textarea");o.className="embedcode",o.className="publish-dialog-link",o.setAttribute("rows",2),o.setAttribute("cols",30),o.setAttribute("readonly","readonly"),o.value=e,o.disabled=!0,t.appendChild(o);const a=document.createElement("textarea");a.className="embedcode",a.className="publish-dialog-embedcode",a.setAttribute("rows",5),a.setAttribute("cols",30),a.setAttribute("readonly","readonly"),a.disabled=!0,a.value=`<iframe src="${e}" width="640" height="360" frameborder="0" allow="webvr;webxr;fullscreen" allowfullscreen></iframe>`,t.appendChild(a);const c=document.createElement("button");c.appendChild(document.createTextNode("Generate SCORM Package")),c.addEventListener("click",()=>{}),c.style.margin="2px",t.appendChild(c),this.__publishDialogHolder.appendChild(t),document.body.appendChild(this.__publishDialogHolder),this.visible=!1}show(){this.__publishDialogHolder.style.display="block",this.visible=!0}hide(){this.__publishDialogHolder.style.display="none",this.visible=!1}},i.SceneTreeView=Zt,i.ScreenSpaceMovementHandle=class extends r{constructor(t){super(t)}setTargetParam(t,i=!0){if(this.param=t,i){const i=()=>{this.setGlobalXfo(t.getValue())};i(),t.valueChanged.connect(i)}}getTargetParam(){return this.param?this.param:this.getParameter("GlobalXfo")}handleMouseDown(t){this.gizmoRay=new s.Ray,this.gizmoRay.dir=t.mouseRay.dir.negate();const i=this.getTargetParam().getValue();this.gizmoRay.pos=i.tr;const e=t.mouseRay.intersectRayPlane(this.gizmoRay);return t.grabPos=t.mouseRay.pointAtDist(e),this.onDragStart(t),!0}handleMouseMove(t){const i=t.mouseRay.intersectRayPlane(this.gizmoRay);return t.holdPos=t.mouseRay.pointAtDist(i),this.onDrag(t),!0}handleMouseUp(t){const i=t.mouseRay.intersectRayPlane(this.gizmoRay);return t.releasePos=t.mouseRay.pointAtDist(i),this.onDragEnd(t),!0}onDragStart(t){this.grabPos=t.grabPos;const i=this.getTargetParam();this.baseXfo=i.getValue(),t.undoRedoManager&&(this.change=new u(i),t.undoRedoManager.addChange(this.change))}onDrag(t){const i=t.holdPos.subtract(this.grabPos),s=this.baseXfo.clone();s.tr.addInPlace(i),this.change?this.change.update({value:s}):this.getTargetParam().setValue(s)}onDragEnd(t){this.change=null}},i.SelectionManager=W,i.SelectionTool=P,i.SessionSync=class{constructor(t,i,n,l){const h={};t.sub(e.Session.actions.USER_JOINED,t=>{t.id in h||(h[t.id]={undoRedoManager:new a,avatar:new S(i,t),selectionManager:new W(i,{...l,enableXfoHandles:!1,setItemsSelected:!1})})}),t.sub(e.Session.actions.USER_LEFT,t=>{h[t.id]?(h[t.id].avatar.destroy(),delete h[t.id]):console.warn("User id not in session:",t.id)}),t.sub(e.Session.actions.USER_VIDEO_STARTED,(i,s)=>{if(!h[s])return void console.warn("User id not in session:",s);const e=t.getVideoStream(s);e&&h[s].avatar.attachRTCStream(e)}),t.sub(e.Session.actions.USER_VIDEO_STOPPED,(i,s)=>{h[s]?(console.log("USER_VIDEO_STOPPED:",s," us:",n.id),h[s].avatar&&h[s].avatar.detachRTCStream(t.getVideoStream(s))):console.warn("User id not in session:",s)}),i.toolManager.movePointer.connect(i=>{const s=i.viewport.getGeomDataAtPos(i.mousePos,i.mouseRay);t.pub(e.Session.actions.POSE_CHANGED,L({interfaceType:"CameraAndPointer",movePointer:{start:i.mouseRay.start,dir:i.mouseRay.dir,length:s?s.dist:5}}))}),i.toolManager.hidePointer.connect(()=>{t.pub(e.Session.actions.POSE_CHANGED,{interfaceType:"CameraAndPointer",hidePointer:{}})}),i.toolManager.hilightPointer.connect(()=>{t.pub(e.Session.actions.POSE_CHANGED,{interfaceType:"CameraAndPointer",hilightPointer:{}})}),i.toolManager.unhilightPointer.connect(()=>{t.pub(e.Session.actions.POSE_CHANGED,L({interfaceType:"CameraAndPointer",unhilightPointer:{}}))});let o=0;i.renderer.viewChanged.connect(i=>{o++;const s="VR"==i.interfaceType;if(s&&o%2!=0)return;const n={interfaceType:i.interfaceType,viewXfo:i.viewXfo};if(i.focalDistance)n.focalDistance=i.focalDistance;else if(s){n.controllers=[];for(const t of i.controllers)n.controllers.push({xfo:t.getTreeItem().getGlobalXfo()})}t.pub(e.Session.actions.POSE_CHANGED,L(n))}),t.sub(e.Session.actions.POSE_CHANGED,(t,s)=>{if(!h[s])return void console.warn("User id not in session:",s);const e=x(t,i.scene);h[s].avatar.updatePose(e)}),t.pub(e.Session.actions.POSE_CHANGED,L({interfaceType:"CameraAndPointer",viewXfo:i.renderer.getViewport().getCamera().getGlobalXfo()}));const c=i.scene.getRoot();i.undoRedoManager.changeAdded.connect(s=>{const n={changeData:s.toJSON({appData:i,makeRelative:t=>t,resolvePath:(t,i)=>{if(!t)throw"Path not spcecified";const s=c.resolvePath(t);s?i(s):console.warn("Path unable to be resolved:"+t)}}),changeClass:a.getChangeClassName(s)};t.pub(e.Session.actions.COMMAND_ADDED,n)}),i.undoRedoManager.changeUpdated.connect(i=>{const s=L(i);t.pub(e.Session.actions.COMMAND_UPDATED,s)}),t.sub(e.Session.actions.COMMAND_ADDED,(t,s)=>{if(!h[s])return void console.warn("User id not in session:",s);const e=h[s].undoRedoManager,n=e.constructChange(t.changeClass);n.fromJSON(t.changeData,{appData:{selectionManager:h[s].selectionManager,scene:i.scene}}),e.addChange(n)}),t.sub(e.Session.actions.COMMAND_UPDATED,(t,s)=>{if(!h[s])return void console.warn("User id not in session:",s);const e=h[s].undoRedoManager,n=x(t,i.scene);e.getCurrentChange().update(n)}),i.undoRedoManager.changeUndone.connect(()=>{t.pub("UndoRedoManager_changeUndone",{})}),t.sub("UndoRedoManager_changeUndone",(t,i)=>{h[i].undoRedoManager.undo()}),i.undoRedoManager.changeRedone.connect(()=>{t.pub("UndoRedoManager_changeRedone",{})}),t.sub("UndoRedoManager_changeRedone",(t,i)=>{h[i].undoRedoManager.redo()}),s.sgFactory.registerCallback("StateMachine",i=>{i.stateChanged.connect(s=>{t.pub("StateMachine_stateChanged",{stateMachine:i.getPath(),stateName:s})})}),t.sub("StateMachine_stateChanged",t=>{i.scene.getRoot().resolvePath(t.stateMachine,1).activateState(t.stateName)})}},i.SliderHandle=ut,i.ToolAction=class extends class{constructor(t,i,s=!1){this.name=t,this.path=i,this.availableInVR=s,this.callback=this.callback.bind(this)}callback(){}}{constructor(t,i,e,n,l){super(t,i,e),this.toolManager=n,this.tool=l,this.state=!1,this.activatedChanged=new s.Signal,l.installChanged.connect(t=>{this.activatedChanged.emit(t)})}callback(){if(this.tool.installed())this.toolManager.removeToolByHandle(this.tool);else{const t=this.toolManager.currTool();"VRUITool"==t.getName()?this.toolManager.insertToolBefore(this.tool,t):t.isPrimaryTool()?this.toolManager.replaceCurrentTool(this.tool):this.toolManager.pushTool(this.tool)}}},i.ToolManager=class{constructor(t){this.__toolStack=[],this.appData=t,this.movePointer=new s.Signal,this.hilightPointer=new s.Signal,this.unhilightPointer=new s.Signal,this.hidePointer=new s.Signal,this.avatarPointerVisible=!1,this.avatarPointerHighlighted=!1}insertTool(t,i){this.__toolStack.splice(i,0,t),t.install(i)}insertToolBefore(t,i){const s=this.__toolStack.indexOf(i)+1;return this.__toolStack.splice(s-1,0,t),t.install(s),s}insertToolAfter(t,i){const s=this.__toolStack.indexOf(i)+1;return this.__toolStack.splice(s,0,t),t.install(s),s==this.__toolStack.length&&t.activateTool(),s}getToolIndex(t){return this.__toolStack.indexOf(t)}removeTool(t){const i=this.__toolStack[t];if(this.__toolStack.splice(t,1),i.uninstall(),t==this.__toolStack.length){i.deactivateTool();const t=this.currTool();t?t.activateTool():this.appData.renderer.getDiv().style.cursor="pointer"}}removeToolByHandle(t){this.removeTool(this.getToolIndex(t))}pushTool(t){const i=this.currTool();if(i){if(t==i)return void console.warn("Tool Already Pushed on the stack:",t.constructor.name);i.deactivateTool()}return this.__toolStack.push(t),t.install(this.__toolStack.length-1),t.activateTool(),console.log("ToolManager.pushTool:",t.constructor.name),this.__toolStack.length-1}__removeCurrTool(){if(this.__toolStack.length>0){const t=this.__toolStack.pop();t.deactivateTool(),t.uninstall()}}popTool(){this.__removeCurrTool();const t=this.currTool();t&&t.activateTool()}replaceCurrentTool(t){this.__removeCurrTool(),this.__toolStack.push(t),t.install(this.__toolStack.length-1),t.activateTool()}currTool(){return this.__toolStack[this.__toolStack.length-1]}currToolName(){return this.__toolStack[this.__toolStack.length-1].getName()}bind(t){const i=t.getViewport();this.mouseDownId=i.mouseDown.connect(this.onMouseDown.bind(this)),this.mouseMoveId=i.mouseMove.connect(this.onMouseMove.bind(this)),this.mouseUpId=i.mouseUp.connect(this.onMouseUp.bind(this)),this.mouseLeaveId=i.mouseLeave.connect(this.onMouseLeave.bind(this)),this.mouseDoubleClickedId=i.mouseDoubleClicked.connect(this.onDoubleClick.bind(this)),this.mouseWheelId=i.mouseWheel.connect(this.onWheel.bind(this)),this.keyDownId=i.keyDown.connect(this.onKeyDown.bind(this)),this.keyUpId=i.keyUp.connect(this.onKeyUp.bind(this)),this.keyPressedId=i.keyPressed.connect(this.onKeyPressed.bind(this)),this.touchStartId=i.touchStart.connect(this.onTouchStart.bind(this)),this.touchMoveId=i.touchMove.connect(this.onTouchMove.bind(this)),this.touchEndId=i.touchEnd.connect(this.onTouchEnd.bind(this)),this.touchCancelId=i.touchCancel.connect(this.onTouchCancel.bind(this)),this.doubleTappedId=i.doubleTapped.connect(this.onDoubleTap.bind(this)),this.appData.renderer.getXRViewport().then(t=>{this.controllerDownId=t.controllerButtonDown.connect(this.onVRControllerButtonDown.bind(this)),this.controllerUpId=t.controllerButtonUp.connect(this.onVRControllerButtonUp.bind(this)),this.controllerDoubleClickId=t.controllerDoubleClicked.connect(this.onVRControllerDoubleClicked.bind(this)),this.onVRPoseChangedId=t.viewChanged.connect(this.onVRPoseChanged.bind(this))})}onMouseDown(t){t.undoRedoManager=this.appData.undoRedoManager,t.showPointerOnAvatar=!0;let i=this.__toolStack.length;for(;i--;){const s=this.__toolStack[i];if(s&&1==s.onMouseDown(t))break}1==t.showPointerOnAvatar?(this.avatarPointerVisible||(this.movePointer.emit(t),this.avatarPointerVisible=!0),this.avatarPointerHighlighted||(this.hilightPointer.emit(t),this.avatarPointerHighlighted=!0)):this.avatarPointerVisible&&(this.avatarPointerVisible=!1,this.hidePointer.emit())}onMouseMove(t){t.undoRedoManager=this.appData.undoRedoManager,t.showPointerOnAvatar=!0;let i=this.__toolStack.length;for(;i--;){const s=this.__toolStack[i];if(s&&1==s.onMouseMove(t))break}1==t.showPointerOnAvatar?(this.movePointer.emit(t),this.avatarPointerVisible=!0):this.avatarPointerVisible&&(this.avatarPointerVisible=!1,this.hidePointer.emit())}onMouseUp(t){t.undoRedoManager=this.appData.undoRedoManager,t.showPointerOnAvatar=!0;let i=this.__toolStack.length;for(;i--;){const s=this.__toolStack[i];if(s&&1==s.onMouseUp(t))break}1==t.showPointerOnAvatar?this.avatarPointerHighlighted&&(this.unhilightPointer.emit(t),this.avatarPointerHighlighted=!1):this.avatarPointerVisible&&(this.avatarPointerVisible=!1,this.hidePointer.emit())}onMouseLeave(t){let i=this.__toolStack.length;for(;i--;){const s=this.__toolStack[i];if(s&&s.onMouseLeave&&1==s.onMouseLeave(t))break}this.avatarPointerVisible&&(this.avatarPointerVisible=!1,this.hidePointer.emit())}onDoubleClick(t){let i=this.__toolStack.length;for(;i--;){const s=this.__toolStack[i];if(s&&1==s.onDoubleClick(t))break}}onWheel(t){t.undoRedoManager=this.appData.undoRedoManager;let i=this.__toolStack.length;for(;i--;){const s=this.__toolStack[i];if(s&&1==s.onWheel(t))break}}onKeyPressed(t,i){i.undoRedoManager=this.appData.undoRedoManager;let s=this.__toolStack.length;for(;s--;){const t=this.__toolStack[s];if(t&&1==t.onKeyPressed(i,i,viewport))break}}onKeyDown(t,i){i.undoRedoManager=this.appData.undoRedoManager;let s=this.__toolStack.length;for(;s--;){const e=this.__toolStack[s];if(e&&1==e.onKeyDown(t,i))break}}onKeyUp(t,i){i.undoRedoManager=this.appData.undoRedoManager;let s=this.__toolStack.length;for(;s--;){const e=this.__toolStack[s];if(e&&1==e.onKeyUp(t,i))break}}onTouchStart(t){t.undoRedoManager=this.appData.undoRedoManager;let i=this.__toolStack.length;for(;i--;){const s=this.__toolStack[i];if(s&&1==s.onTouchStart(t))break}}onTouchMove(t){t.undoRedoManager=this.appData.undoRedoManager;let i=this.__toolStack.length;for(;i--;){const s=this.__toolStack[i];if(s&&1==s.onTouchMove(t))break}}onTouchEnd(t){t.undoRedoManager=this.appData.undoRedoManager;let i=this.__toolStack.length;for(;i--;){const s=this.__toolStack[i];if(s&&1==s.onTouchEnd(t))break}}onTouchCancel(t){t.undoRedoManager=this.appData.undoRedoManager;let i=this.__toolStack.length;for(;i--;){const s=this.__toolStack[i];if(s&&1==s.onTouchCancel(t))break}}onDoubleTap(t){t.undoRedoManager=this.appData.undoRedoManager;let i=this.__toolStack.length;for(;i--;){const s=this.__toolStack[i];if(s&&1==s.onDoubleTap(t))break}}__prepareEvent(t){t.undoRedoManager=this.appData.undoRedoManager,t.propagating=!0,t.stopPropagation=()=>{t.propagating=!1}}onVRControllerButtonDown(t){this.__prepareEvent(t);let i=this.__toolStack.length;for(;i--;){const s=this.__toolStack[i];if(s&&1==s.onVRControllerButtonDown(t))break;if(!t.propagating)break}}onVRControllerButtonUp(t){this.__prepareEvent(t);let i=this.__toolStack.length;for(;i--;){const s=this.__toolStack[i];if(s&&1==s.onVRControllerButtonUp(t))break;if(!t.propagating)break}}onVRControllerDoubleClicked(t){this.__prepareEvent(t);let i=this.__toolStack.length;for(;i--;){const s=this.__toolStack[i];if(s&&1==s.onVRControllerDoubleClicked(t))break;if(!t.propagating)break}}onVRPoseChanged(t){this.__prepareEvent(t);let i=this.__toolStack.length;for(;i--;){const s=this.__toolStack[i];if(s&&1==s.onVRPoseChanged(t))break;if(!t.propagating)break}}destroy(){const t=this.appData.renderer.getViewport();t.mouseDown.disconnectId(this.mouseDownId),t.mouseMove.disconnectId(this.mouseMoveId),t.mouseUp.disconnectId(this.mouseUpId),t.mouseLeave.disconnectId(this.mouseUpId),t.mouseWheel.disconnectId(this.mouseWheelId),t.keyDown.disconnectId(this.keyDownId),t.keyUp.disconnectId(this.keyUpId),t.keyPressed.disconnectId(this.keyPressedId),t.touchStart.disconnectId(this.touchStartId),t.touchMove.disconnectId(this.touchMoveId),t.touchEnd.disconnectId(this.touchEndId),t.touchCancel.disconnectId(this.touchCancelId),this.appData.renderer.getXRViewport().then(()=>{t.controllerDown.disconnectId(this.controllerDownId),t.controllerUp.disconnectId(this.controllerUpId),t.viewChanged.disconnectId(this.onVRPoseChangedId)})}},i.TopMenuBar=class{constructor(t,i,s){this.appData=i;const e=document.createElement("div");if(e.className="HeaderWrapper pa0 bb",t.appendChild(e),s||(this.logo=document.createElement("img"),this.logo.className="Header__logo pl2",this.logo.src="./img/logo.png",e.appendChild(this.logo)),this.topMenuItems=document.createElement("div"),this.topMenuItems.id="TopMenuWrapper",this.topMenuItems.className="pure-menu pure-menu-horizontal ml3",e.appendChild(this.topMenuItems),!s&&i.currentUser){const t=document.createElement("div");e.appendChild(t),this.currentUserChip=new z(t,this.appData.currentUser)}this.__existingItems={},this.__hotkeysToActions={},this._buildTopBar(),this._addKeyListener()}_buildTopBar(){this.topMenuItems.innerHTML="";const t=this._addUlTo(this.topMenuItems,"pure-menu-list");this.appData.actionRegistry.getActions().forEach(i=>{this._addMenuItem(t,i)}),this.appData.actionRegistry.actionAdded.connect(i=>{this._addMenuItem(t,i)})}_addMenuItem(t,i){let s=t;for(let t=0;t<i.path.length;t++){const e=i.path[t];if(!this.__existingItems[e]){const t=this._addLiTo(s,"pure-menu-item");t.classList.add("pure-menu-has-children","pure-menu-allow-hover"),this._addATo(t,"pure-menu-link",e);const i=this._addUlTo(t,"pure-menu-children shadow-3");this.__existingItems[e]=i}s=this.__existingItems[e]}const e=this._addATo(s,"pure-menu-link",null,i.callback);if(this._addSpanTo(e,"ActionTitle",i.name),this._addSpanTo(e,"ActionShortcut",this._keyComboAsText(i)),i.key||i.metaKeys){const t=i.metaKeys||{},s=(this._comboFragment(t.alt,"A")+this._comboFragment(t.control,"C")+this._comboFragment(t.shift,"S")+(i.key||"")).toLowerCase();this.__hotkeysToActions[s]=i}i.callback&&e.addEventListener("click",t=>{t.preventDefault(),i.callback.call(i)}),i.activatedChanged&&i.activatedChanged.connect(t=>{e.className=t?"pure-menu-link ActionedMenu":"pure-menu-link"})}_addKeyListener(){let t;document.addEventListener("keypress",()=>{}),document.addEventListener("keydown",i=>{if(t)return;if(i.target instanceof HTMLInputElement)return;const s=(this._comboFragment(i.altKey,"A")+this._comboFragment(i.metaKey||i.ctrlKey,"C")+this._comboFragment(i.shiftKey,"S")+("Alt"!=i.key&&"Ctrl"!=i.key?i.key:"")).toLowerCase();s in this.__hotkeysToActions&&(this.__hotkeysToActions[s].callback(event),t=s,event.preventDefault())}),document.addEventListener("keyup",()=>{if(t&&t in this.__hotkeysToActions){const i=this.__hotkeysToActions[t];i.hotkeyReleaseCallback&&(i.hotkeyReleaseCallback(event),event.preventDefault()),t=void 0}})}_addSpanTo(t,i,s){const e=document.createElement("span");return e.className=i,s&&(e.innerHTML=s),t.appendChild(e),e}_addATo(t,i,s){const e=document.createElement("a");return e.href="#",e.className=i,s&&(e.innerHTML=s),t.appendChild(e),e}_addUlTo(t,i,s){const e=document.createElement("ul");return e.className=i,s&&(e.innerHTML=s),t.appendChild(e),e}_addLiTo(t,i,s){const e=document.createElement("li");return e.className=i,s&&(e.innerHTML=s),t.appendChild(e),e}_comboFragment(t,i){return t?i+"+":""}_keyComboAsText(t){const{metaKeys:i,key:s}=t;return s||i?i?(i.shift?this._comboFragment(i.shift,"Shift"):"")+(i.alt?this._comboFragment(i.alt,"Alt"):"")+(i.control?this._comboFragment(i.control,"Ctrl"):"")+s:s:""}},i.TreeItemAddChange=v,i.TreeItemMoveChange=M,i.TreeItemView=bt,i.TreeItemsRemoveChange=Y,i.UndoRedoManager=a,i.UserChip=z,i.VIEW_TOOL_MODELS=B,i.VRHoldObjectsTool=class extends k{constructor(t){super(t),this.__pressedButtonCount=0,this.__freeIndices=[],this.__vrControllers=[],this.__heldObjectCount=0,this.__heldGeomItems=[],this.__heldGeomItemIds=[],this.__heldGeomItemRefs=[],this.__heldGeomItemOffsets=[]}activateTool(){super.activateTool(),console.log("activateTool.VRHoldObjectsTool"),this.appData.renderer.getDiv().style.cursor="crosshair";const t=t=>{if(!this.__activated)return;const i=new s.Cross(.03),e=new s.Material("Cross","FlatSurfaceShader");e.getParameter("BaseColor").setValue(new s.Color("#03E3AC")),e.visibleInGeomDataBuffer=!1;const n=new s.GeomItem("HandleToolTip",i,e);t.getTipItem().removeAllChildren(),t.getTipItem().addChild(n,!1)};this.appData.renderer.getXRViewport().then(i=>{for(const s of i.getControllers())t(s);this.addIconToControllerId=i.controllerAdded.connect(t)})}deactivateTool(){super.deactivateTool(),this.appData.renderer.getXRViewport().then(t=>{t.controllerAdded.disconnectId(this.addIconToControllerId)})}computeGrabXfo(t){let i;if(1==t.length)i=this.__vrControllers[t[0]].getTipXfo();else if(2==t.length){const e=this.__vrControllers[t[0]].getTipXfo(),n=this.__vrControllers[t[1]].getTipXfo();e.ori.alignWith(n.ori),i=new s.Xfo,i.tr=e.tr.lerp(n.tr,.5),i.ori=e.ori.lerp(n.ori,.5);let l=n.tr.subtract(e.tr);l.normalizeInPlace();const h=i.ori.getXaxis();l.dot(h)<0&&(l=l.negate());const o=l.angleTo(h);if(o>0){const t=h.cross(l);t.normalizeInPlace();const e=new s.Quat;e.setFromAxisAndAngle(t,o),i.ori=e.multiply(i.ori)}}return i}initAction(){for(let t=0;t<this.__heldGeomItems.length;t++){const i=this.__heldGeomItems[t];if(!i)continue;const s=this.computeGrabXfo(this.__heldGeomItemRefs[t]);this.__heldGeomItemOffsets[t]=s.inverse().multiply(i.getGlobalXfo())}}onVRControllerButtonDown(t){const i=t.controller.getId();this.__vrControllers[i]=t.controller;const s=t.controller.getGeomItemAtTip();if(s){if(s.geomItem.getOwner()instanceof r)return!1;if(t.intersectionData=s,s.geomItem.onMouseDown(t,s),!t.propagating)return!1;let e=this.__heldGeomItems.indexOf(s.geomItem);if(-1==e){e=this.__heldGeomItems.length,this.__heldObjectCount++,this.__heldGeomItems.push(s.geomItem),this.__heldGeomItemRefs[e]=[i],this.__heldGeomItemIds[i]=e;const t={newItem:s.geomItem,newItemId:e};this.change?this.change.update(t):(this.change=new it(t),this.appData.undoRedoManager.addChange(this.change))}else this.__heldGeomItemIds[i]=e,this.__heldGeomItemRefs[e].push(i);return this.initAction(),!0}}onVRControllerButtonUp(t){const i=t.controller.getId();if(this.__pressedButtonCount--,void 0!==this.__heldGeomItemIds[i]){const t=this.__heldGeomItemIds[i],s=this.__heldGeomItemRefs[t];return s.splice(s.indexOf(i),1),0==s.length&&(this.__heldObjectCount--,this.__heldGeomItems[t]=void 0,this.change=void 0),this.__heldGeomItemIds[i]=void 0,this.initAction(),!0}}onVRPoseChanged(t){if(!this.change)return!1;const i=[],s=[];for(let t=0;t<this.__heldGeomItems.length;t++){if(!this.__heldGeomItems[t])continue;const e=this.computeGrabXfo(this.__heldGeomItemRefs[t]);i.push(e.multiply(this.__heldGeomItemOffsets[t])),s.push(t)}return this.change.update({changeXfos:i,changeXfoIds:s}),!0}},i.VRUITool=class extends k{constructor(t){super(t),this.__vrUIDOMHolderElement=document.createElement("div"),this.__vrUIDOMHolderElement.className="vrUIHolder",this.__vrUIDOMElement=document.createElement("div"),this.__vrUIDOMElement.className="vrUI",document.body.appendChild(this.__vrUIDOMHolderElement),this.controllerUI=new tt(t,this.__vrUIDOMHolderElement,this.__vrUIDOMElement),this.controllerUI.addRef(this),t.renderer.addTreeItem(this.controllerUI),this.__uiLocalXfo=new s.Xfo,this.__uiLocalXfo.ori.setFromAxisAndAngle(new s.Vec3(1,0,0),-.6*Math.PI);const i=new s.Material("pointermat","LinesShader");i.visibleInGeomDataBuffer=!1,i.getParameter("Color").setValue(new s.Color(1.2,0,0));const e=new s.Lines;e.setNumVertices(2),e.setNumSegments(1),e.setSegment(0,0,1),e.getVertex(0).set(0,0,0),e.getVertex(1).set(0,0,-1),e.setBoundingBoxDirty(),this.__pointerLocalXfo=new s.Xfo,this.__pointerLocalXfo.sc.set(1,1,.1),this.__pointerLocalXfo.ori.setFromAxisAndAngle(new s.Vec3(1,0,0),-.2*Math.PI),this.__uiPointerItem=new s.GeomItem("VRControllerPointer",e,i),this.__uiPointerItem.addRef(this),this.__triggerHeld=!1}getName(){return"VRUITool"}setUIControllers(t,i,s,e){this.openUITool=t,this.uiController=i,this.pointerController=s;const n=this.uiController.getTreeItem().getGlobalXfo();if(this.pointerController){const t=this.pointerController.getTreeItem().getGlobalXfo(),i=n.tr.subtract(e.tr),s=t.tr.subtract(e.tr);i.cross(s).dot(e.ori.getYaxis())>0?this.__uiLocalXfo.tr.set(.05,-.05,.08):this.__uiLocalXfo.tr.set(-.05,-.05,.08)}else this.__uiLocalXfo.tr.set(0,-.05,.08);this.controllerUI.setLocalXfo(this.__uiLocalXfo)}activateTool(){super.activateTool(),this.controllerUI.activate(),this.uiController&&(this.uiController.getTipItem().addChild(this.controllerUI,!1),this.pointerController&&this.pointerController.getTipItem().addChild(this.__uiPointerItem,!1),this.appData.session.pub("pose-message",{interfaceType:"VR",showUIPanel:{controllerId:this.uiController.getId(),localXfo:this.__uiLocalXfo.toJSON(),size:this.controllerUI.getGeomOffsetXfo().sc.toJSON()}}))}deactivateTool(){super.deactivateTool(),this.controllerUI.deactivate(),this.uiController&&(this.uiController.getTipItem().removeChildByHandle(this.controllerUI),this.pointerController&&this.pointerController.getTipItem().removeChildByHandle(this.__uiPointerItem),this.appData.session.pub("pose-message",{interfaceType:"VR",hideUIPanel:{controllerId:this.uiController.getId()}}))}setPointerLength(t){this.__pointerLocalXfo.sc.set(1,1,t),this.__uiPointerItem.setLocalXfo(this.__pointerLocalXfo)}calcUIIntersection(){const t=this.__uiPointerItem.getGlobalXfo(),i=t.ori.getZaxis().negate(),e=new s.Ray(t.tr,i),n=this.controllerUI.getGlobalXfo(),l=this.controllerUI.getGeomOffsetXfo().sc,h=new s.Ray(n.tr,n.ori.getZaxis().negate()),o=e.intersectRayPlane(h);if(o<=0)return void this.setPointerLength(.5);const a=t.tr.add(i.scale(o)).subtract(h.start),c=a.dot(n.ori.getXaxis())/l.x,r=a.dot(n.ori.getYaxis())/l.y;if(Math.abs(c)>.5||Math.abs(r)>.5)return void this.setPointerLength(.5);this.setPointerLength(o);const d=this.__vrUIDOMElement.getBoundingClientRect();return{clientX:Math.round(c*d.width+d.width/2),clientY:Math.round(r*-d.height+d.height/2)}}sendEventToUI(t,i){const s=this.calcUIIntersection();if(s){s.offsetX=s.pageX=s.pageX=s.screenX=s.clientX,s.offsetY=s.pageY=s.pageY=s.screenY=s.clientY;const e=document.elementFromPoint(s.clientX,s.clientY);return e!=this._element&&(this._element&&this.controllerUI.sendMouseEvent("mouseleave",Object.assign(i,s),this._element),this._element=e,this.controllerUI.sendMouseEvent("mouseenter",Object.assign(i,s),this._element)),this.controllerUI.sendMouseEvent(t,Object.assign(i,s),this._element),this._element}this._element&&(this.controllerUI.sendMouseEvent("mouseleave",Object.assign(i,s),this._element),this._element=null)}onVRControllerButtonDown(t){if(t.controller==this.pointerController){this.__triggerHeld=!0;const i=this.sendEventToUI("mousedown",{button:t.button-1});this.__triggerDownElem=i||null}return!0}onVRControllerButtonUp(t){if(t.controller==this.pointerController){this.__triggerHeld=!1;const i=this.sendEventToUI("mouseup",{button:t.button-1});i&&this.__triggerDownElem==i&&this.sendEventToUI("click",{button:t.button-1}),this.__triggerDownElem=null}return!0}onVRPoseChanged(t){const i=t.viewXfo;return(()=>{const t=this.uiController.getTreeItem().getGlobalXfo(),s=t.tr.subtract(i.tr);return s.normalizeInPlace(),!(s.angleTo(t.ori.getYaxis())>.5*Math.PI&&(this.appData.toolManager.removeToolByHandle(this),1))})()&&this.sendEventToUI("mousemove",{}),!0}},i.ViewTool=class extends k{constructor(t,i=B.VIEWER){super(t),console.log("ViewTool:",i),this.__maipulationModel=i,this.__defaultMode="orbit",this.__mode=this.__defaultMode,this.__mouseDragDelta=new s.Vec2,this.__keyboardMovement=!1,this.__keysPressed=[],this.__maxVel=.002,this.__velocity=new s.Vec3,this.__ongoingTouches={},this.__orbitRateParam=this.addParameter(new s.NumberParameter("orbitRate",1)),this.__dollySpeedParam=this.addParameter(new s.NumberParameter("dollySpeed",.02)),this.__mouseWheelDollySpeedParam=this.addParameter(new s.NumberParameter("mouseWheelDollySpeed",.002)),this.__controllerTriggersHeld=[],this.movementFinished=new s.Signal}activateTool(){super.activateTool(),console.log("activateTool.ViewTool"),this.appData.renderer.getDiv().style.cursor="default",this.appData.renderer.getXRViewport().then(t=>{this.vrControllerToolTip||(this.vrControllerToolTip=new s.Sphere(.015),this.vrControllerToolTipMat=new s.Material("Cross","FlatSurfaceShader"),this.vrControllerToolTipMat.getParameter("BaseColor").setValue(new s.Color("#03E3AC")),this.vrControllerToolTipMat.visibleInGeomDataBuffer=!1);const i=t=>{const i=new s.GeomItem("HandleToolTip",this.vrControllerToolTip,this.vrControllerToolTipMat);t.getTipItem().removeAllChildren(),t.getTipItem().addChild(i,!1)};for(const s of t.getControllers())i(s);this.addIconToControllerId=t.controllerAdded.connect(i)})}deactivateTool(){super.deactivateTool(),this.appData.renderer.getXRViewport().then(t=>{t.controllerAdded.disconnectId(this.addIconToControllerId)})}setDefaultMode(t){this.__defaultMode=t}look(t,i){const e=i.getCamera().getFocalDistance(),n=this.__orbitRateParam.getValue()*s.SystemDesc.isMobileDevice?-1:1;if(this.__keyboardMovement){const t=i.getCamera().getGlobalXfo();this.__mouseDownCameraXfo=t.clone(),this.__mouseDownZaxis=t.ori.getZaxis();const s=this.__mouseDownZaxis.scale(-e);this.__mouseDownCameraTarget=t.tr.add(s)}const l=this.__mouseDownCameraXfo.clone(),h=new s.Quat;h.rotateZ(t.x/i.getWidth()*Math.PI*n),l.ori=h.multiply(l.ori);const o=new s.Quat;o.rotateX(t.y/i.getHeight()*Math.PI*n),l.ori.multiplyInPlace(o),i.getCamera().setGlobalXfo(l)}orbit(t,i){const e=i.getCamera().getFocalDistance(),n=this.__orbitRateParam.getValue()*s.SystemDesc.isMobileDevice?-1:1;if(this.__keyboardMovement){const t=i.getCamera().getGlobalXfo();this.__mouseDownCameraXfo=t.clone(),this.__mouseDownZaxis=t.ori.getZaxis();const s=this.__mouseDownZaxis.scale(-e);this.__mouseDownCameraTarget=t.tr.add(s)}const l=this.__mouseDownCameraXfo.clone(),h=new s.Quat;h.rotateZ(t.x/i.getWidth()*2*Math.PI*-n),l.ori=h.multiply(l.ori);const o=new s.Quat;o.rotateX(t.y/i.getHeight()*Math.PI*-n),l.ori.multiplyInPlace(o),l.tr=this.__mouseDownCameraTarget.add(l.ori.getZaxis().scale(e)),i.getCamera().setGlobalXfo(l)}pan(t,i){const e=i.getCamera().getFocalDistance(),n=i.getCamera().getFov(),l=new s.Vec3(1,0,0),h=new s.Vec3(0,1,0),o=2*e*Math.tan(.5*n),a=o*(i.getWidth()/i.getHeight()),c=new s.Xfo;c.tr=l.scale(-t.x/i.getWidth()*a),c.tr.addInPlace(h.scale(t.y/i.getHeight()*o)),i.getCamera().setGlobalXfo(this.__mouseDownCameraXfo.multiply(c))}dolly(t,i){const e=t.x*this.__dollySpeedParam.getValue(),n=new s.Xfo;n.tr.set(0,0,e),i.getCamera().setGlobalXfo(this.__mouseDownCameraXfo.multiply(n))}panAndZoom(t,i,e){const n=e.getCamera().getFocalDistance(),l=e.getCamera().getFov(),h=new s.Vec3(1,0,0),o=new s.Vec3(0,1,0),a=2*n*Math.tan(.5*l),c=a*(e.getWidth()/e.getHeight()),r=new s.Xfo;r.tr=h.scale(-t.x/e.getWidth()*c),r.tr.addInPlace(o.scale(t.y/e.getHeight()*a));const d=i*n;e.getCamera().setFocalDistance(this.__mouseDownFocalDist+d),r.tr.z+=d,e.getCamera().setGlobalXfo(this.__mouseDownCameraXfo.multiply(r))}initDrag(t){const i=t.getCamera().getFocalDistance();this.__mouseDragDelta.set(0,0),this.__mouseDownCameraXfo=t.getCamera().getGlobalXfo().clone(),this.__mouseDownZaxis=t.getCamera().getGlobalXfo().ori.getZaxis();const s=this.__mouseDownZaxis.scale(-i);this.__mouseDownCameraTarget=t.getCamera().getGlobalXfo().tr.add(s),this.__mouseDownFocalDist=i}aimFocus(t,i){this.__focusIntervalId&&clearInterval(this.__focusIntervalId);let e=0;const n=()=>{const l=t.getGlobalXfo(),h=t.getFocalDistance(),o=i.subtract(l.tr),a=o.normalizeInPlace(),c=new s.Quat,r=new s.Quat;{const t=l.ori.getZaxis().clone();t.z=0;const i=o.negate();i.z=0,c.setFrom2Vectors(t,i)}{const t=l.ori.getZaxis().clone(),i=o.negate();t.x=i.x,t.y=i.y,t.normalizeInPlace(),t.cross(i).dot(l.ori.getXaxis())>0?r.rotateX(t.angleTo(i)):r.rotateX(-t.angleTo(i))}const d=l.clone();d.ori=c.multiply(d.ori),d.ori.multiplyInPlace(r);const u=Math.pow(e/20,2),m=l.clone();m.ori=l.ori.lerp(d.ori,u),t.setFocalDistance(h+(a-h)*u),t.setGlobalXfo(m),e++,e<=20?this.__focusIntervalId=setTimeout(n,20):(this.__focusIntervalId=void 0,this.movementFinished.emit())};n(),this.__manipulationState="focussing"}onMouseMove(t){}onDragStart(t){this.__mouseDownPos=t.mousePos,this.initDrag(t.viewport),this.__mode=2==t.button?"pan":t.ctrlKey&&2==t.button?"dolly":t.shiftKey||2==t.button?"look":this.__defaultMode}onDrag(t){switch(this.__mouseDragDelta=this.__keyboardMovement?t.mousePos:t.mousePos.subtract(this.__mouseDownPos),this.__mode){case"orbit":this.orbit(this.__mouseDragDelta,t.viewport);break;case"look":this.look(this.__mouseDragDelta,t.viewport);break;case"pan":this.pan(this.__mouseDragDelta,t.viewport);break;case"dolly":this.dolly(this.__mouseDragDelta,t.viewport)}}onDragEnd(t){return this.movementFinished.emit(),!1}onMouseDown(t){return!(this.__maipulationModel==B.DCC&&!t.altKey||(this.dragging=!0,this.__mouseDownPos=t.mousePos,this.onDragStart(t),0))}onMouseUp(t){if(this.dragging)return this.onDragEnd(t),this.dragging=!1,!0}onMouseMove(t){if(this.dragging)return this.onDrag(t),t.showPointerOnAvatar=!1,!0}onDoubleClick(t){if(t.intersectionData){const i=t.viewport.getCamera(),s=i.getGlobalXfo().tr.add(t.intersectionData.mouseRay.dir.scale(t.intersectionData.dist));this.aimFocus(i,s)}}onWheel(t){if(this.__maipulationModel==B.DCC&&!t.altKey)return!1;const i=t.viewport,s=i.getCamera().getGlobalXfo(),e=s.ori.getZaxis();this.__mouseWheelZoomIntervalId&&clearInterval(this.__mouseWheelZoomIntervalId);let n=0;const l=()=>{const h=i.getCamera().getFocalDistance(),o=this.__mouseWheelDollySpeedParam.getValue(),a=t.deltaY*o*h*.2;s.tr.addInPlace(e.scale(a)),"orbit"==this.__defaultMode&&i.getCamera().setFocalDistance(h+a),i.getCamera().setGlobalXfo(s),n++,n<5?this.__mouseWheelZoomIntervalId=setTimeout(l,20):(this.__mouseWheelZoomIntervalId=void 0,this.movementFinished.emit(),t.viewport.renderGeomDataFbo())};l()}__integrateVelocityChange(t,i){const e=new s.Xfo;e.tr=this.__velocity.normalize().scale(this.__maxVel),i.getCamera().setGlobalXfo(i.getCamera().getGlobalXfo().multiply(e))}onKeyPressed(t,i){return!1}onKeyDown(t,i){}onKeyUp(t,i){return!0}__startTouch(t,i){this.__ongoingTouches[t.identifier]={identifier:t.identifier,pos:new s.Vec2(t.pageX,t.pageY)}}__endTouch(t,i){delete this.__ongoingTouches[t.identifier]}onTouchStart(t){t.preventDefault(),t.stopPropagation(),0==Object.keys(this.__ongoingTouches).length&&(this.__manipMode=void 0);const i=t.changedTouches;for(let t=0;t<i.length;t++)this.__startTouch(i[t]);return this.initDrag(t.viewport),!0}onTouchMove(t){t.preventDefault(),t.stopPropagation();const i=t.changedTouches;if(1==i.length&&"panAndZoom"!=this.__manipMode){const e=i[0],n=new s.Vec2(e.pageX,e.pageY),l=this.__ongoingTouches[e.identifier].pos.subtract(n);return"look"==this.__defaultMode?(l.scaleInPlace(6),this.look(l,t.viewport)):this.orbit(l,t.viewport),this.__manipMode="orbit",!0}if(2==i.length){const e=i[0],n=this.__ongoingTouches[e.identifier],l=i[1],h=this.__ongoingTouches[l.identifier],o=new s.Vec2(e.pageX,e.pageY),a=new s.Vec2(l.pageX,l.pageY),c=h.pos.subtract(n.pos).length()-a.subtract(o).length(),r=o.subtract(n.pos),d=a.subtract(h.pos),u=r.add(d);return u.scaleInPlace(.5),this.panAndZoom(u,.002*c,t.viewport),this.__manipMode="panAndZoom",!0}}onTouchEnd(t){t.preventDefault(),t.stopPropagation();const i=t.changedTouches;switch(this.__manipMode){case"orbit":case"panAndZoom":this.movementFinished.emit()}for(let t=0;t<i.length;t++)this.__endTouch(i[t]);return 0==Object.keys(this.__ongoingTouches).length&&(this.__manipMode=void 0),!0}onTouchCancel(t){console.log("touchcancel.");const i=t.changedTouches;for(let t=0;t<i.length;t++)this.__endTouch(i[t]);return!0}onDoubleTap(t){const i=t.changedTouches;for(let t=0;t<i.length;t++)this.__startTouch(i[t]);if(t.intersectionData){const i=t.viewport.getCamera(),s=i.getGlobalXfo().tr.add(t.intersectionData.mouseRay.dir.scale(t.intersectionData.dist));this.aimFocus(i,s)}}__initMoveStage(t){if(1==this.__controllerTriggersHeld.length)this.__grabPos=this.__controllerTriggersHeld[0].getControllerTipStageLocalXfo().tr.clone(),this.stageXfo__GrabStart=t.getXfo().clone(),this.__invOri=this.stageXfo__GrabStart.ori.inverse();else if(2==this.__controllerTriggersHeld.length){const i=this.__controllerTriggersHeld[0].getControllerTipStageLocalXfo().tr,s=this.__controllerTriggersHeld[1].getControllerTipStageLocalXfo().tr;this.__grabDir=s.subtract(i),this.__grabPos=i.lerp(s,.5),this.__grabDir.y=0,this.__grabDist=this.__grabDir.length(),this.__grabDir.scaleInPlace(1/this.__grabDist),this.stageXfo__GrabStart=t.getXfo().clone(),this.__grab_to_stage=this.__grabPos.subtract(this.stageXfo__GrabStart.tr)}}onVRControllerButtonDown(t){if(1==t.button)return this.__controllerTriggersHeld.push(t.controller),this.__initMoveStage(t.vrviewport),!0}onVRControllerButtonUp(t){if(1!=t.button)return;const i=this.__controllerTriggersHeld.indexOf(t.controller);return this.__controllerTriggersHeld.splice(i,1),this.__initMoveStage(t.vrviewport),!0}onVRControllerDoubleClicked(t){console.log("onVRControllerDoubleClicked:",this.__controllerTriggersHeld.length);const i=t.vrviewport.getXfo().clone();i.sc.set(1,1,1),t.vrviewport.setXfo(i)}onVRPoseChanged(t){if(1==this.__controllerTriggersHeld.length){const i=this.__controllerTriggersHeld[0].getControllerTipStageLocalXfo().tr,e=new s.Xfo;e.tr=this.__grabPos.subtract(i);const n=this.stageXfo__GrabStart.multiply(e);return t.vrviewport.setXfo(n),!0}if(2==this.__controllerTriggersHeld.length){const i=this.__controllerTriggersHeld[0].getControllerTipStageLocalXfo().tr,e=this.__controllerTriggersHeld[1].getControllerTipStageLocalXfo().tr,n=i.lerp(e,.5),l=e.subtract(i);l.y=0;const h=l.length();l.scaleInPlace(1/h);const o=new s.Xfo,a=Math.max(Math.min(this.__grabDist/h,10),.1);o.sc.set(a,a,a);let c=this.__grabDir.angleTo(l);this.__grabDir.cross(l).y>0&&(c=-c),o.ori.rotateY(c);const r=o.ori.rotateVec3(this.__grabPos);o.tr.addInPlace(this.__grabPos.subtract(r));const d=this.__grabPos.scale(1-a);o.tr.addInPlace(o.ori.rotateVec3(d));const u=this.__grabPos.subtract(n).scale(a);o.tr.addInPlace(o.ori.rotateVec3(u));const m=this.stageXfo__GrabStart.multiply(o);return t.vrviewport.setXfo(m),!0}}},i.uxFactory=C}));const Bi=class{constructor(i){t(this,i),this.label="Loading...",this.isRoot=!1,this.isTreeItem=!1,this.isSelected=!1,this.isVisible=!1,this.isHighlighted=!1,this.isExpanded=!1,this.childItems=[]}treeItemChanged(){this.treeItem&&this.initTreeItem()}componentWillLoad(){this.treeItem&&(this.initTreeItem(),this.updateSelected(),this.updateVisibility(),this.updateHighlight(),this.childItems.length?this.rootElement.classList.add("has-children"):this.rootElement.classList.remove("has-children"),this.treeItem.titleElement=this.rootElement)}initTreeItem(){this.label=this.treeItem.getName(),this.nameChangedId=this.treeItem.on("nameChanged",()=>{this.label=this.treeItem.getName()}),this.updateSelectedId=this.treeItem.on("selectedChanged",this.updateSelected.bind(this)),"function"==typeof this.treeItem.getChildren?(this.isTreeItem=!0,this.childItems=[...this.treeItem.getChildren()],this.childAddedId=this.treeItem.on("childAdded",()=>{this.childItems=[...this.treeItem.getChildren()]}),this.childRemovedId=this.treeItem.on("childRemoved",()=>{this.childItems=[...this.treeItem.getChildren()]}),this.updateVisibilityId=this.treeItem.on("visibilityChanged",this.updateVisibility.bind(this))):(this.isTreeItem=!1,this.isVisible=!0),this.updateHighlightId=this.treeItem.on("highlightChanged",this.updateHighlight.bind(this))}updateSelected(){this.treeItem&&"isSelected"in this.treeItem&&(this.isSelected=this.treeItem.isSelected())}updateVisibility(){this.treeItem&&"isVisible"in this.treeItem&&(this.isVisible=this.treeItem.isVisible())}updateHighlight(){var t,i;if(this.treeItem&&"isHighlighted"in this.treeItem&&(this.isHighlighted=this.treeItem.isHighlighted(),this.isHighlighted&&"getHighlight"in this.treeItem)){const s=this.treeItem.getHighlight(),e=s.lerp(new n.Color(.75,.75,.75,0),.5);console.log("this.itemContainer",this.itemContainer),null===(t=this.itemContainer)||void 0===t||t.style.setProperty("--treeview-highlight-bg-color",e.toHex()+"60"),null===(i=this.itemContainer)||void 0===i||i.style.setProperty("--treeview-highlight-color",s.toHex())}}toggleChildren(){this.isExpanded=!this.isExpanded}onVisibilityToggleClick(){const t=this.treeItem.getParameter("Visible");if(this.appData&&this.appData.undoRedoManager){const i=new ki.ParameterValueChange(t,!t.getValue());this.appData.undoRedoManager.addChange(i)}else t.setValue(!t.getValue())}onLabelClick(t){this.appData&&this.appData.selectionManager?this.appData.selectionManager.pickingModeActive()?this.appData.selectionManager.pick(this.treeItem):this.appData.selectionManager.toggleItemSelection(this.treeItem,!t.ctrlKey):this.treeItem.setSelected(!this.treeItem.getSelected())}render(){return i("div",{class:{wrap:!0,"has-children":this.childItems.length,selected:this.isSelected,visible:this.isVisible,highlighted:this.isHighlighted,"is-tree-item":this.isTreeItem},style:{display:"block"},ref:t=>this.itemContainer=t},i("div",{class:"header"},i("div",{class:"arrow",style:{display:this.childItems.length>0?"block":"none"},onClick:()=>this.toggleChildren()},i("span",null,i("zea-icon",this.isExpanded?{name:"caret-down",size:12}:{name:"caret-forward",size:12}))),this.isTreeItem&&i("div",{class:"toggle",onClick:this.onVisibilityToggleClick.bind(this)},i("zea-icon",{name:this.isVisible?"eye-outline":"eye-off-outline",ref:t=>this.visibilityIcon=t,size:16})),i("div",{class:"zea-tree-item-label",onClick:this.onLabelClick.bind(this)},this.label)),this.isTreeItem&&i("div",{class:"children",style:{display:this.isExpanded?"block":"none"}},this.isExpanded&&this.childItems.map(t=>i("zea-tree-item-element",{treeItem:t,appData:this.appData}))))}get rootElement(){return s(this)}static get watchers(){return{treeItem:["treeItemChanged"]}}};Bi.style=":host{display:block;font-size:14px}:host,input,button,select,textarea{font-family:'Roboto', sans-serif}.wrap{opacity:0.7;cursor:default;user-select:none}.wrap.visible{opacity:1}.header{display:flex;align-items:center;margin:4px 0;position:relative;left:-7px}.arrow{display:flex;justify-content:center;align-items:center;cursor:pointer;padding:2px}.label{white-space:nowrap}.toggle{display:flex;justify-content:center;align-items:center;font-size:1.2em;margin:0 1px 0 4px}.children{padding-left:19px;border-left:1px dotted gray}zea-tree-item-element{margin-left:16px}zea-tree-item-element.has-children{margin-left:0}.zea-tree-item-label{padding:3px 5px;border-radius:4px;border:1px solid transparent;margin-left:22px;white-space:nowrap}.is-tree-item .zea-tree-item-label{margin-left:0}.highlighted .zea-tree-item-label{background-color:var(\n    --treeview-highlight-bg-color,\n    var(--color-secondary-3)\n  );border:1px solid var(--treeview-highlight-color, var(--color-secondary-1))}.selected .zea-tree-item-label{background-color:var(--treeview-highlight-color, var(--color-secondary-1));border:1px solid var(--treeview-highlight-color, var(--color-secondary-1))}";export{Bi as zea_tree_item_element}